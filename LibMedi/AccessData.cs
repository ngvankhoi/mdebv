using System;
using System.Data;
using Microsoft.Win32;
using System.Collections;
using System.Xml;
using System.Data.OleDb;
using System.Data.SqlClient;
using System.Drawing;
using System.Diagnostics;
using System.Text;
using System.Security.Cryptography;
using dichso;
using Npgsql;
using NpgsqlTypes;
using System.Runtime.InteropServices;
using System.IO;
using SCreenReader;
using System.Collections.Generic;

namespace LibMedi
{
    public class AccessData
    {
        //linh 28/02/2013
        /// <summary>
        /// Chuỗi mã hóa để tạo license cho PC
        /// </summary>
        string sKey = "";

        /// <summary>
        /// License của PC
        /// </summary>
        string sValues = "";
        string sNgayGioHeThong = "";
        string sRegDateStart = "GGED-GHB88-6PO-GI57";
        //end linh28022013
        //linh 25092012
        /// <summary>
        /// Ngày giá viện phí áp dụng thông tư liên tịch
        /// </summary>
        string s_Ngayvienphithongtulientich = "";
        /// <summary>
        /// Ngày vào viện của bệnh nhân không áp dụng thông tư liện tịch 19/5/2012
        /// </summary>
        string s_Ngaybenhnhanthongtulientich = "";
        //thuy
        string dblink = "";
        public string s_ngonngu = "";
        public const int iChieuDaiID = 25;
        public const int Tiepdon = 0, Khambenh = 1, Ngoaitru = 2, Phongluu = 3, Nhanbenh = 4, Khoa = 5, Phauthuthuat = 6, Vienphi = 7, Duoc = 8, Xetnghiem = 9, Sieuam = 10, Noisoi = 11, Xquang = 12, Le = 13, Khucxa = 14, Cls = 15, Taikham = 16, Pttt = 17;
        public const int giamdoc = 1, phogiamdoc = 2, truongkhoa = 3, nhanvien = 8, nghiviec = 9, ybs_cls = 10;
        public const int i_maxlength_mabn = 10, i_maxlength_makp = 3;
        public const string Msg = "Medisoft THIS", Msg_di = "Dinh dưỡng", Msg_lg = "Quản lý lương";
        public const string cdnguyennhan = "BPH+BNG+BBO+BRA+BTA+BMA";
        public const string phainu = "BPH+BSA";
        public const string sosinh = "BSO+BMT+BNH";
        public const string phongluu = "99";
        public const string ngoaikhoa = "14+18+19+20+21+22+23+24+25+28";
        public const string yhdt = "16+26";
        public const string links_userid = "links", links_pass = "link7155019s20";
        [DllImport("winmm.dll")]
        private static extern bool PlaySound(string lpszName, int hModule, int dwFlags);
        string sConn = "Server=192.168.1.14;Port=5432;User Id=medisoft;Password=links1920;Database=medisoft2007;Encoding=UNICODE;Pooling=true;";

        NpgsqlDataAdapter dest;
        NpgsqlConnection con;
        NpgsqlCommand cmd;
        LibDuoc.AccessData d;
        LibVienphi.AccessData v;
        string sComputer = null;
        string m_hotenkdau, sql = "", schema = "", owner = "medisoft", password = "links1920", userid = "medibv", database = "medisoft", b_sobienlaitamung, b_tatca_sobienlaitamung = "", xxxxx = "Ð§Ì©Î«³²°Ô£";
        string sHost = "", sPort = "";//linh 02012013
        bool b_sovaovien, b_soluutru;
        private decimal _e = 0, _p = 0, _l = 0, _g = 0, d_dongia = 0, d_vattu = 0, tc_tamung = 0;
        public int iRownum = 1;
        DataSet ds = null;
        private SCreenReader.ConvertFont convert_font = new SCreenReader.ConvertFont();

        public AccessData()
        {
            //linh 02012013
            string s_Key = Maincode("Key");
            if (s_Key == "1")
            {
                if (Maincode("Ip") != "") sHost = DeCode(Maincode("Ip"), key);
                if (Maincode("Post") != "") sPort = DeCode(Maincode("Post"), key);
                if (Maincode("UserID") != "") owner = DeCode(Maincode("UserID"), key);
                if (Maincode("Password") != "") password = DeCode(Maincode("Password"), key);
                if (Maincode("Database") != "") database = DeCode(Maincode("Database"), key);
            }
            else
            {
                if (Maincode("Ip") != "") sHost = Maincode("Ip");
                if (Maincode("Post") != "") sPort = Maincode("Post");
                if (Maincode("UserID") != "") owner = Maincode("UserID");
                if (Maincode("Password") != "") password = Maincode("Password");
                if (Maincode("Database") != "") database = Maincode("Database");
            }
            if (Maincode("User") != "") userid = Maincode("User");
            if (Maincode("ngonngu") != "") s_ngonngu = DeCode(Maincode("ngonngu"), key);
            userid = userid + s_ngonngu;
            sComputer = System.Environment.MachineName.Trim().ToUpper();
            sConn = "Server=" + sHost + ";Port=" + sPort + ";User Id=" + owner + ";Password=" + password + ";Database=" + database + ";Encoding=UNICODE;Pooling=true;";
            b_sovaovien = bSovaovien;
            b_soluutru = bSoluutru;
            if (!upd_dmcomputer())
            {
                System.Windows.Forms.MessageBox.Show("Không kết nối được Server !", Msg);
                System.Windows.Forms.Application.Exit();
            }
            ds = get_data("select id,computer,key,value,to_char(now(),'dd/mm/yyyy hh24:mi') as ngay from " + userid + ".dmcomputer");
            if (ds == null)//linh 28022013
            {
                execute_data("alter table " + userid + ".dmcomputer add key varchar2(100)");
                execute_data("alter table " + userid + ".dmcomputer add value text");
                ds = get_data("select id,computer,key,value,to_char(now(),'dd/mm/yyyy hh24:mi') as ngay  from " + userid + ".dmcomputer");
                if (ds == null)
                {
                    System.Windows.Forms.MessageBox.Show("Không kết nối được Server !", Msg);
                    System.Windows.Forms.Application.Exit();
                }
            }
            DataRow r = getrowbyid(ds.Tables[0], "computer='" + sComputer + "'");
            if (r != null)
            {
                iRownum = int.Parse(r["id"].ToString().PadLeft(5, '0'));//linh 28052012
                sKey = r["key"].ToString();
                sValues = r["value"].ToString();
                sNgayGioHeThong = r["ngay"].ToString();
            }
            //end linh  28022013
        }
        #region get_chieudai_mabn_makp
        private int iChieudai_makp
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=-98");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 2; }
            }
        }
        private int iChieudai_mabn
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=-99");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 8; }
            }
        }
        #endregion get_chieudai_mabn_makp

        /// <summary>
        /// IP/ Host server, default: localhost
        /// </summary>
        public string IPServer
        {
            get
            {
                if (sHost == "") { sHost = "localhost"; }
                return sHost;
            }
        }

        /// <summary>
        /// Port của Server, default: 5432
        /// </summary>
        public string PortServer
        {
            get
            {
                if (sPort == "") { sPort = "5432"; }
                return sPort;
            }
        }

        /// <summary>
        /// database của bệnh viện. default: medisoft2007
        /// </summary>
        public string DatabaseServer
        {
            get {
                if (database == "") { sHost = "medisoft2007"; }
                return database; 
            }
        }

        public bool upd_dmcomputer()
        {            
            bool bnew = true;
            DataSet ads = get_data("select id, computer from " + user + ".dmcomputer where computer='" + System.Environment.MachineName + "'");
            if (ads != null && ads.Tables.Count > 0 && ads.Tables[0].Rows.Count > 0)
            {
                bnew = false;
            }
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            try
            {

                if (bnew == false)
                {
                    //sql = "update " + user + ".dmcomputer set computer=:m_computer where computer=:m_computer";
                    //con = new NpgsqlConnection(sConn);

                    //con.Open();
                    //cmd = new NpgsqlCommand(sql, con);
                    //cmd.CommandType = CommandType.Text;
                    //cmd.Parameters.Add("m_computer", NpgsqlDbType.Varchar).Value = System.Environment.MachineName;
                    //cmd.ExecuteNonQuery();
                    //cmd.Dispose();
                    //con.Close(); con.Dispose();
                }
                else
                {
                    sql = "insert into " + user + ".dmcomputer(id,computer) values (" + get_id_dmcomputer + ",'" + System.Environment.MachineName + "')";
                    execute_data(sql);
                }
            }
            catch (NpgsqlException ex)
            {
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public string user { get { return userid; } }

        //linh
        /// <summary>
        /// Tên User để connect database: medisoft 
        /// </summary>
        public string User_database
        {
            get 
            {
                if (owner == "") { owner = "medisoft"; }
                return owner; 
            }
        }
        public string Password_database
        {
            get { return password; }
        }
        //end linh
        public string MaincodeClient(string sql)
        {
            try
            {
                XmlDocument doc = new XmlDocument();
                doc.Load("..//..//..//xml//maincodeclient.xml");
                XmlNodeList nodeLst = doc.GetElementsByTagName(sql);
                return nodeLst.Item(0).InnerText;
            }
            catch
            {
                if (System.IO.File.Exists("..//..//..//xml//maincodeclient.xml") == false)
                {
                    System.IO.File.Copy("..//..//..//xml//maincode.xml", "..//..//..//xml//maincodeclient.xml", true);
                }
                ds = new DataSet();
                ds.ReadXml("..//..//..//xml//maincodeclient.xml");
                DataColumn dc = new DataColumn();
                dc.ColumnName = sql;
                dc.DataType = Type.GetType("System.String");
                ds.Tables[0].Columns.Add(dc);
                ds.Tables[0].Rows[0][sql] = "";
                ds.WriteXml("..//..//..//xml//maincodeclient.xml");
                return "";
            }
        }
        public string Maincode(string sql)
        {
            try
            {
                XmlDocument doc = new XmlDocument();
                doc.Load("..//..//..//xml//maincode.xml");
                XmlNodeList nodeLst = doc.GetElementsByTagName(sql);
                return nodeLst.Item(0).InnerText;
            }
            catch
            {
                ds = new DataSet();
                ds.ReadXml("..//..//..//xml//maincode.xml");
                DataColumn dc = new DataColumn();
                dc.ColumnName = sql;
                dc.DataType = Type.GetType("System.String");
                ds.Tables[0].Columns.Add(dc);
                ds.Tables[0].Rows[0][sql] = "";
                ds.WriteXml("..//..//..//xml//maincode.xml");
                return "";
            }
        }

        //public string ConStrclient
        //{
        //    get
        //    {
        //        return sConn_client;
        //    }
        //}

        public string ConStr
        {
            get
            {
                return sConn;
            }
        }

        //
        private int get_id_dmcomputer
        {
            get
            {
                if (bQuanly_Theo_Chinhanh)
                {
                    int i = 1;
                    int i_cn = i_Chinhanh_hientai;
                    ds = get_data("select max(id)-" + i_Chinhanh_hientai.ToString().PadRight(6,'0') + " as id from " + user + ".dmcomputer");
                    if (ds.Tables[0].Rows[0]["id"].ToString() == "") i = 1;//linh 31052012
                    else i = int.Parse(ds.Tables[0].Rows[0]["id"].ToString()) + 1;
                    return int.Parse(i_cn.ToString() + Math.Abs(i).ToString().PadLeft(5, '0'));
                }
                else
                {
                    int i = 1;
                    ds = get_data("select max(id) as id from " + user + ".dmcomputer");
                    if (ds.Tables[0].Rows[0]["id"].ToString() == "") i = 1;//linh 31052012
                    else i = int.Parse(ds.Tables[0].Rows[0]["id"].ToString()) + 1;
                    return i;
                }
            }
            //get
            //{
            //    DataSet lds = get_data("select id from " + user + ".dmcomputer");
            //    DataRow dr;
            //    int i_id = 1;
            //    for (int j = 1; j <= 1000; j++)
            //    {
            //        i_id = j;
            //        dr = getrowbyid(lds.Tables[0], "id=" + j);
            //        if (dr == null) break;
            //    }
            //    if (i_id >= 1000)
            //    {
            //        lds = get_data("select max(id) as id from " + user + ".dmcomputer");
            //        if (lds.Tables[0].Rows[0]["id"].ToString() == "") i_id = 1;
            //        else i_id = int.Parse(lds.Tables[0].Rows[0]["id"].ToString()) + 1;
            //    }
            //    if (bQuanly_Theo_Chinhanh)
            //    {
            //        int i_cn = i_Chinhanh_hientai;
            //        i_id = int.Parse(i_cn.ToString() + i_id.ToString().PadLeft(5, '0'));
            //    }
            //    return i_id;
        }
        //
        public void upd_dmcomputer(string m_computer)
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            sql = "update " + user + ".dmcomputer set computer=:m_computer where computer=:m_computer";
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_computer", NpgsqlDbType.Varchar, 20).Value = m_computer;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                con.Close(); con.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dmcomputer(id,computer) values (" + get_id_dmcomputer + ",'" + m_computer + "')";
                    execute_data(sql);
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dmcomputer");
            }
            finally
            {
                con.Close(); con.Dispose();
            }
        }

        private decimal get_capid_may(int m_ma, string m_computer)
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            sql = "update " + user + ".d_capid set id=id+1 where ma=:m_ma and computer=:m_computer";
            con = new NpgsqlConnection(sConn);
            con.Open();
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;
            cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
            cmd.Parameters.Add("m_computer", NpgsqlDbType.Varchar, 20).Value = m_computer;
            int irec = cmd.ExecuteNonQuery();
            cmd.Dispose();
            if (irec == 0)
            {
                sql = "insert into " + user + ".d_capid(ma,ten,id,computer) values (:m_ma,:m_ten,1,:m_computer)";
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Varchar, 20).Value = m_computer;
                cmd.Parameters.Add("m_computer", NpgsqlDbType.Varchar, 20).Value = m_computer;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            sql = "select id from " + user + ".d_capid where ma=" + m_ma + " and computer='" + m_computer + "'";
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;
            dest = new NpgsqlDataAdapter(cmd);
            ds = new DataSet();
            dest.Fill(ds);
            cmd.Dispose();
            con.Close(); con.Dispose();
            return decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
        }

        public string Madau
        {
            get
            {
                XmlDocument doc = new XmlDocument();
                doc.Load("..//..//..//xml//maincode.xml");
                XmlNodeList nodeLst = doc.GetElementsByTagName("Madau");
                return nodeLst.Item(0).InnerText;
            }
        }

        #region xxx
        /// <summary>
        /// Không còn sử dụng
        /// </summary>
        public string Host
        {
            get
            {
                return "203.162.56.241";
            }
        }
        /// <summary>
        /// 3 kí tự đầu của mã bv
        /// </summary>
        public string User
        {
            get
            {
                return Mabv.Substring(0, 3);
            }
        }

        /// <summary>
        /// không còn sử dụng
        /// </summary>
        public string Pass
        {
            get
            {
                return User + "09t039i3e7066n8" + User;
            }
        }

        /// <summary>
        /// không còn sử dụng
        /// </summary>
        public string Dir
        {
            get
            {
                return "";
            }
        }
        #endregion

        public string ngayhienhanh_server
        {
            get
            {
                return get_data("select to_char(now(),'dd/mm/yyyy hh24:mi')").Tables[0].Rows[0][0].ToString();
            }
        }

        public string ngayhienhanh_server_12
        {
            get
            {
                return get_data("select to_char(now(),'dd/mm/yyyy hh:mi')").Tables[0].Rows[0][0].ToString();
            }
        }

        public void writeXml(string tenfile, string cot, string s)
        {
            //linh
            tenfile = tenfile.Replace(".xml", "");
            ds = new DataSet();
            try
            {
                if (System.IO.File.Exists("..//..//..//xml//" + tenfile + ".xml"))
                {
                    ds.ReadXml("..//..//..//xml//" + tenfile + ".xml");
                    ds.Tables[0].Rows[0][cot] = s;
                }
                else
                {
                    DataTable dttmp = new DataTable();
                    dttmp.Columns.Add(cot, typeof(string));
                    DataRow nr = dttmp.NewRow();
                    nr[cot] = s;
                    ds.Tables.Add(dttmp.Copy());
                }
            }
            catch
            {
                DataColumn dc = new DataColumn();
                dc.ColumnName = cot;
                dc.DataType = Type.GetType("System.String");
                ds.Tables[0].Columns.Add(dc);
                ds.Tables[0].Rows[0][cot] = s;
            }
            ds.WriteXml("..//..//..//xml//" + tenfile + ".xml");
        }

        public string Hoten_khongdau(string s)
        {
            ds = new DataSet();
            ds.ReadXml("..//..//..//xml//khongdau.xml");
            string s1 = s.Trim().ToUpper(), s2 = "";
            DataRow r;
            for (int i = 0; i < s1.Length; i++)
            {
                if (s1[i].ToString().Trim() != "")
                {
                    r = getrowbyid(ds.Tables[0], "codau='" + s1[i].ToString() + "'");
                    if (r != null) s2 += r[1].ToString();
                    else s2 += s1[i];
                }
            }
            return s2;
        }

        public string khongdau(string s)
        {
            ds = new DataSet();
            ds.ReadXml("..//..//..//xml//khongdau.xml");
            string s1 = s.Trim().ToUpper(), s2 = "";
            DataRow r;
            for (int i = 0; i < s1.Length; i++)
            {
                if (s1[i].ToString().Trim() != "")
                {
                    r = getrowbyid(ds.Tables[0], "codau='" + s1[i].ToString() + "'");
                    if (r != null) s2 += r[1].ToString();
                    else s2 += s1[i];
                }
                else s2 += s1[i];
            }
            return s2;
        }

        public string holot_ten(string hoten)
        {
            string holot = "", ten = hoten;
            hoten = hoten.Trim();
            for (; ; )
            {
                if (hoten.IndexOf("  ") == -1) break;
                hoten = hoten.Replace("  ", " ");
            }
            int pos = hoten.LastIndexOf(" ");
            if (pos != -1)
            {
                ten = hoten.Substring(pos + 1);
                hoten = hoten.Substring(0, pos);
                holot = hoten;
                pos = hoten.LastIndexOf(" ");
                if (pos != -1) holot = hoten.Substring(pos + 1);
            }
            return holot + " " + ten;
        }

        public string Mabv
        {
            get
            {
                try
                {
                    DataTable tmp = get_data("select ten from " + user + ".thongso where id=2").Tables[0];
                    if (tmp.Rows[0]["ten"].ToString().Trim().Length == 8) return tmp.Rows[0]["ten"].ToString();
                    else
                    {
                        XmlDocument doc = new XmlDocument();
                        doc.Load("..//..//..//xml//maincode.xml");
                        XmlNodeList nodeLst = doc.GetElementsByTagName("Mabv");
                        return (nodeLst.Item(0).InnerText == "") ? "701.1.01" : nodeLst.Item(0).InnerText;
                    }
                }
                catch
                {
                    XmlDocument doc = new XmlDocument();
                    doc.Load("..//..//..//xml//maincode.xml");
                    XmlNodeList nodeLst = doc.GetElementsByTagName("Mabv");
                    return (nodeLst.Item(0).InnerText == "") ? "701.1.01" : nodeLst.Item(0).InnerText;
                }
            }
        }

        public string Mabvbhyt
        {
            get
            {
                try
                {

                    XmlDocument doc = new XmlDocument();
                    doc.Load("..//..//..//xml//maincode.xml");
                    XmlNodeList nodeLst = doc.GetElementsByTagName("Mabvbhyt");
                    return (nodeLst.Item(0).InnerText == "") ? "701.1.01" : nodeLst.Item(0).InnerText;
                }
                catch
                {
                    return "";
                }
            }
        }
        public string Mabv_xml
        {
            get
            {
                XmlDocument doc = new XmlDocument();
                doc.Load("..//..//..//xml//maincode.xml");
                XmlNodeList nodeLst = doc.GetElementsByTagName("Mabv");
                return (nodeLst.Item(0).InnerText == "") ? "701.1.01" : nodeLst.Item(0).InnerText;
            }
        }

        public int Mabv_so
        {
            get
            {
                try
                {
                    string s = "", mabv = (Mabv.Trim().Length == 8) ? Mabv : Mabv_xml;
                    for (int i = 0; i < mabv.Length; i++)
                        s += (mabv.Substring(i, 1) == ".") ? "" : mabv.Substring(i, 1);
                    return int.Parse(s);
                }
                catch { return 0; }
            }
        }

        public string Tenbv
        {
            get
            {
                try
                {
                    return get_data("select ten from " + user + ".thongso where id=3").Tables[0].Rows[0]["ten"].ToString();
                }
                catch
                {
                    XmlDocument doc = new XmlDocument();
                    doc.Load("..//..//..//xml//maincode.xml");
                    XmlNodeList nodeLst = doc.GetElementsByTagName("Tenbv");
                    return nodeLst.Item(0).InnerText;
                }
            }
        }

        public string Syte
        {
            get
            {
                try
                {
                    return get_data("select ten from " + user + ".thongso where id=4").Tables[0].Rows[0]["ten"].ToString();
                }
                catch
                {
                    XmlDocument doc = new XmlDocument();
                    doc.Load("..//..//..//xml//maincode.xml");
                    XmlNodeList nodeLst = doc.GetElementsByTagName("Syte");
                    return nodeLst.Item(0).InnerText;
                }
            }
        }

        public string Diachi
        {
            get
            {
                try
                {
                    return get_data("select ten from " + user + ".thongso where id=5").Tables[0].Rows[0]["ten"].ToString();
                }
                catch
                {
                    XmlDocument doc = new XmlDocument();
                    doc.Load("..//..//..//xml//maincode.xml");
                    XmlNodeList nodeLst = doc.GetElementsByTagName("Diachi");
                    return nodeLst.Item(0).InnerText;
                }
            }
        }

        public string Dienthoai
        {
            get
            {
                try
                {
                    return get_data("select ten from " + user + ".thongso where id=6").Tables[0].Rows[0]["ten"].ToString();
                }
                catch
                {
                    XmlDocument doc = new XmlDocument();
                    doc.Load("..//..//..//xml//maincode.xml");
                    XmlNodeList nodeLst = doc.GetElementsByTagName("Dienthoai");
                    return nodeLst.Item(0).InnerText;
                }
            }
        }

        public string Masothue
        {
            get
            {
                try
                {
                    return get_data("select ten from " + user + ".thongso where id=-6").Tables[0].Rows[0]["ten"].ToString();
                }
                catch
                {
                    XmlDocument doc = new XmlDocument();
                    doc.Load("..//..//..//xml//maincode.xml");
                    XmlNodeList nodeLst = doc.GetElementsByTagName("mst");
                    return nodeLst.Item(0).InnerText;
                }
            }
        }

        public string Thongso(string sql)
        
        {
            try
            {
                XmlDocument doc = new XmlDocument();
                doc.Load("..//..//..//xml//thongso.xml");
                XmlNodeList nodeLst = doc.GetElementsByTagName(sql);
                return nodeLst.Item(0).InnerText;
            }
            catch(Exception ex)
            {
                return "";
            }
        }

        public string Maicd_rpt(string s)
        {
            try
            {
                string s1 = "", s2 = ".+-*";
                s = s.Trim().ToUpper();
                for (int i = 0; i < s.Length; i++)
                    if (s2.IndexOf(s.Substring(i, 1)) == -1) s1 += s.Substring(i, 1);
                return s1;
            }
            catch { return ""; }
        }

        public bool bMaicd(string s)
        {
            if (s == "") return true;
            else return get_data("select cicd10 from " + user + ".icd10 where cicd10='" + s + "'").Tables[0].Rows.Count > 0;
        }

        public bool bMapt(string s)
        {
            if (s == "") return true;
            else return get_data("select mapt from " + user + ".dmpttt where mapt='" + s + "'").Tables[0].Rows.Count > 0;
        }

        public string Maicd(string s)
        {
            try
            {
                string s1 = "";
                s = s.ToUpper();
                for (int i = 0; i < s.Length; i++)
                {
                    if (s.Substring(i, 1) != "_")
                        s1 += s.Substring(i, 1);
                }
                return (s1.Length > 4) ? s1 : s1.Substring(0, 3);
            }
            catch { return ""; }
        }

        public string Mapttt(string s)
        {
            try
            {
                string s1 = "";
                s = s.ToUpper();
                for (int i = 0; i < s.Length; i++)
                {
                    if (s.Substring(i, 1) != "_")
                        s1 += s.Substring(i, 1);
                    else
                        break;
                }
                return (s1.Length > 5) ? s1 : s1.Substring(0, 4);
            }
            catch { return ""; }
        }

        public string f_ngay
        {
            get
            {
                ds = get_data("select ten from " + user + ".thongso where id=-2");
                if (ds.Tables[0].Rows.Count > 0) return ds.Tables[0].Rows[0]["ten"].ToString().Trim();
                else return "dd/mm/yyyy";
            }
        }
        public string f_ngaygio
        {
            get
            {
                ds = get_data("select ten from " + user + ".thongso where id=-3");
                if (ds.Tables[0].Rows.Count > 0) return ds.Tables[0].Rows[0]["ten"].ToString().Trim();
                else return "dd/mm/yyyy hh24:mi";
            }
        }

        public bool bHieuchinhICD10
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=54");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bICDNguyennhan
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=100");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bSoluutru_Mabn
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=102");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bMoi_cu
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=106");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bCongthucchenhlech
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=446");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool CongthucTraiTuyen160212
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1502");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }


        public bool bXutri_noitru_kb
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=108");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }

        public bool bXutri_ngoaitru_kb
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=109");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }

        public bool bXutri_noitru_ngtr
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=201");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }

        public bool bXutri_noitru_pl
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=202");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }

        public bool bXutri_ngoaitru_pl
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=203");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }

        public bool bsothe_mabn
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=204");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }

        public bool bHansd_thuoc
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=205");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }

        public bool bThanhtoan_ndot
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=110");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bThanhtoan_khoa
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=242");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bNhapthuoc_ten
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=112");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bChuyenkhoasan
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=117");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bPttt_phongmo
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=118");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bvodanh(string hoten)
        {
            return vodanh_hoten.IndexOf(Hoten_vodanh(hoten)) != -1;
        }

        public string vodanh
        {
            get
            {
                return "VÔ DANH " + get_capid(0).ToString().Trim();
            }
        }

        private string Hoten_vodanh(string s)
        {
            ds = new DataSet();
            ds.ReadXml("..//..//..//xml//khongdau.xml");
            string s1 = s.Trim().ToUpper(), s2 = "";
            DataRow r;
            for (int i = 0; i < s1.Length; i++)
            {
                if (s1[i].ToString().Trim() != "" && char.IsLetter(Convert.ToChar(s1[i].ToString().Trim())))
                {
                    r = getrowbyid(ds.Tables[0], "codau='" + s1[i].ToString() + "'");
                    if (r != null) s2 += r[1].ToString();
                    else s2 += s1[i];
                }
            }
            return s2;
        }

        public int vodanh_gioitinh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=119");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 1; }
            }
        }

        public int vodanh_tuoi
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=120");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 30; }
            }
        }

        public string vodanh_nghenghiep
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=121");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return "99"; }
            }
        }

        public string vodanh_dantoc
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=122");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return "25"; }
            }
        }

        public string vodanh_tinh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=123");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return Mabv.Substring(0, 3); }
            }
        }

        public string vodanh_hoten
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=124");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return "VODANH,VD"; }
            }
        }


        public bool bBosolieuduoc
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=128");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bInthanhtoanchitiet
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=129");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bInylenh_cachdung
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=130");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bSuadt_chitiet
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=132");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bVantay
        {
            get
            {
                try
                {
                    return int.Parse(Thongso("c140")) == 1;
                }
                catch { return false; }
            }
        }

        public bool bVantay_mabntudong
        {
            get
            {
                try
                {
                    return int.Parse(Thongso("c177")) == 1;
                }
                catch { return false; }
            }
        }

        public bool bDsSothe
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=178");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bChenhlech
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=179");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bGiaphuthu
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1088");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public int Doituong_gia_loaitg(int idloaitg)
        {
            try
            {
                DataSet ds = get_data("select madoituong from " + user + ".dmloaitg where id=" + idloaitg);
                return int.Parse(ds.Tables[0].Rows[0][0].ToString());
            }
            catch { return 0; }

        }
        public bool bSuadoituong
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=180");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bYlenh_nhathuoc
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=181");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bCapve_noitru
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=182");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bBHYTngtr_noitru
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=183");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public string s_matinh_bhyt
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".d_thongso where id=83");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return "00"; }
            }
        }
        public string s_vitri_matinh_bhyt
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".d_thongso where id=84");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return "00"; }
            }
        }

        public bool bSolan_donthuoc
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=184");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public string gio_treem
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=185");
                    return ds.Tables[0].Rows[0][0].ToString().Trim();
                }
                catch { return "00:00"; }
            }
        }

        public string kho_treem
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=186");
                    return ds.Tables[0].Rows[0][0].ToString().Trim();
                }
                catch { return ""; }
            }
        }

        public string gio_ngoai
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=187");
                    return ds.Tables[0].Rows[0][0].ToString().Trim();
                }
                catch { return "00:00"; }
            }
        }

        public bool bTress_bame
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=188");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public int soprocess
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=189");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 1; }
            }
        }

        public bool bGoi_dangky
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=255");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bGoi_khambenh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=256");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bChonhinh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=258");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bTrieuchung
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=259");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bMuangoai_tonkho
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=260");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bTongtien_donduyet
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=261");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bKhacbv_traituyen_pk2//gam 12/01/2012
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=62");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }


        public int sonhay
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=257");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 4; }
            }
        }

        public string gio_linh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=190");
                    return ds.Tables[0].Rows[0][0].ToString().Trim().Trim(',');
                }
                catch { return "00:00"; }
            }
        }

        public string kho_linh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=191");
                    return ds.Tables[0].Rows[0][0].ToString().Trim();
                }
                catch { return ""; }
            }
        }

        public string sGiotrua_tu
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=291");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return "00:00"; }
            }
        }

        public string sGiotrua_den
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=292");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return "00:00"; }
            }
        }

        public string sGiochunhat
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=293");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return "00:00"; }
            }
        }

        public bool bNgoaigio_ylenh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=294");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bDangky_homqua
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=295");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bDangky_bsbv
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=296");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        //Thuy 13.03.2013
        public bool bQuanlyNVsale
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1508");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        
        public bool bTuChoiNhapVienNeuChuaThanhToan
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1509");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bKhongChoDKNeuChuaHetNgayCapThuocBHYT
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1511");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bKhongChoSuaThuocXuatTuTruc_Goi
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1513");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }



        public bool bNgtru_dt_makp
        {
            get
            {
                try
                {
                    ds = get_data("select ten from " + user + ".thongso where id=297");
                    if (ds.Tables[0].Rows.Count == 0) return false;
                    return ds.Tables[0].Rows[0][0].ToString().Trim() == "1";
                }
                catch { return false; }
            }
        }

        public int kho_ngtru
        {
            get
            {
                try
                {
                    ds = get_data("select ten from " + user + ".thongso where id=298");
                    if (ds.Tables[0].Rows.Count == 0) return 0;
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString().Trim());
                }
                catch { return 0; }
            }
        }

        public int dt_ngtru
        {
            get
            {
                try
                {
                    ds = get_data("select ten from " + user + ".thongso where id=299");
                    if (ds.Tables[0].Rows.Count == 0) return 0;
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString().Trim());
                }
                catch { return 0; }
            }
        }

        public string makp_kho_dt
        {
            get
            {
                try
                {
                    ds = get_data("select ten from " + user + ".thongso where id=300");
                    if (ds.Tables[0].Rows.Count == 0) return "";
                    return ds.Tables[0].Rows[0][0].ToString().Trim();
                }
                catch { return ""; }
            }
        }

        public bool bSoluutru_xuatkhoa
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=301");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        //Thuy 31.12.2011
        public bool bSoluutru_captheokhoa
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=3011");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bSoluutru_captoanvien
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=3012");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        //end 31.12.2011
        public bool bChenhlech_doituong
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=302");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }

        public int iNhomvpthuoc
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=303");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 0; }
            }
        }

        public bool bBienlai_mien
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=304");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }

        public int iTaikham
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=305");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 0; }
            }
        }

        public bool bKhamsuckhoe
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=306");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public string ksk_phong
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=307");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return "00"; }
            }
        }

        public string ksk_noi
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=308");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return "00"; }
            }
        }

        public string ksk_ngoai
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=309");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return "00"; }
            }
        }

        public string ksk_mat
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=310");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return "00"; }
            }
        }

        public string ksk_rang
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=311");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return "00"; }
            }
        }

        public string ksk_tmh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=312");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return "00"; }
            }
        }

        public string ksk_sanphu
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=313");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return "00"; }
            }
        }
        public string ksk_xutri
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=314");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return "01"; }
            }
        }

        public bool bIn1lan
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=320");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bBhyt1kham
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=321");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bTaikham_hen
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=322");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }
        public bool bTaikham_in
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=323");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }

        public string madoituong_hen
        {
            get
            {
                try
                {
                    ds = get_data("select ten from " + user + ".thongso where id=324");
                    if (ds.Tables[0].Rows.Count == 0) return "";
                    return ds.Tables[0].Rows[0][0].ToString().Trim();
                }
                catch { return ""; }
            }
        }

        public int Taikham_songay
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=325");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 30; }
            }
        }

        public bool bChidinh_exp_txt
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=326");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bTiepdon_ngoaitru
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=327");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bBHYT_NhapCMND // Khuong 07/06/2011: bn doi tuong BHYT bat buoc nhap CMND
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1076");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bCD_BS_Chidinh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=328");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bNgayhienhanh_thuoc_chidinh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=329");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bKhambenh_ba
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=330");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bDongia_lietke
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=331");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }

        public string sSothe_jl
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=332");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return ""; }
            }
        }

        public int iSothe_jl_vitri
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=333");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 12; }
            }
        }

        public bool bDieutri_donthuoc
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=334");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public string sChenhlech
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=335");
                    return ds.Tables[0].Rows[0][0].ToString().Trim();
                }
                catch { return " BN thanh toán chênh lệch"; }
            }
        }

        public string makp_chuyenkhoa
        {
            get
            {
                try
                {
                    ds = get_data("select ten from " + user + ".thongso where id=315");
                    if (ds.Tables[0].Rows.Count == 0) return "";
                    return ds.Tables[0].Rows[0][0].ToString().Trim();
                }
                catch { return ""; }
            }
        }

        public bool bSuadoituong_khambenh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=192");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }

        public int iDoituong_ngoaigio
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=193");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 0; }
            }
        }

        public bool bLuu_Donthuoc_bacsy
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=194");
                    return ds.Tables[0].Rows[0][0].ToString() == "1";
                }
                catch { return true; }
            }
        }

        public bool bSoluutru_kotrung
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=197");
                    return ds.Tables[0].Rows[0][0].ToString() == "1";
                }
                catch { return true; }
            }
        }

        public bool bThuoc_nghi_letet
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=198");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public int check_process(string program)
        {
            int i = 0;
            try
            {
                Process[] processes = Process.GetProcesses();
                if (processes.Length > 1)
                    for (int n = 0; n <= processes.Length - 1; n++)
                        if (((Process)processes[n]).ProcessName.ToString().ToUpper() == program) i++;
                return i;
            }
            catch { return 1; }
        }

        public void check_process(int so, string program)
        {
            Process[] processes = Process.GetProcesses();
            int sopro = processes.Length;
            if (sopro > so)
            {
                for (int n = 0; n <= processes.Length - 1; n++)
                    if (((Process)processes[n]).ProcessName == program)
                    {
                        ((Process)processes[n]).Kill();
                        sopro--;
                        if (sopro == so) break;
                    }
            }
        }


        public bool bLydomien
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=141");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bDienthoai
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=142");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public int iNhompttt_bo
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=143");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 0; }
            }
        }

        public string iNhompttt
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=143");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return ""; }
            }
        }

        public bool bPttt_vienphi
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=144");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bEdit_pttt_vienphi
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=146");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bPttt_thuoc
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=145");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public int iTreem6tuoi
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=147");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 0; }
            }
        }
        public bool bBacsy_tiepdon
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=148");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public int iTunguyen
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=149");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 2; }
            }
        }

        public int iTunguyen_Tronggio_ngoaigio(string m_mabn, string m_mavaovien)
        {
            int i_tunguyen = 0;
            try
            {
                sql = "select b.madoituong from " + user + ".bndk_tg a, " + user + ".dmloaitg b where a.id_loaitg=b.id and  a.mabn='" + m_mabn + "' and a.mavaovien=" + m_mavaovien + " and a.mavaovien>0 order by a.mavaovien desc ";
                DataSet lds = get_data(sql);
                if (lds == null || lds.Tables.Count == 0)
                    i_tunguyen = iTunguyen;
                else i_tunguyen = int.Parse(lds.Tables[0].Rows[0]["madoituong"].ToString());
                if (i_tunguyen == 0)
                    return i_tunguyen;
            }
            catch { i_tunguyen = iTunguyen; }

            return i_tunguyen;
        }

        public bool bCapcuu_noitru
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=150");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        //Tu:22/07/2011 thêm option Thu phí(khi chọn G16 thì option thu phí sẽ hiện lên, nếu chọn vào thu phí thì 
        //đối với bệnh nhân thu phí trong trường hợp phòng lưu xử trí nhập viện chi phí phòng lưu sẽ được tự động 
        //chuyển xuống viện phí để thanh toán)
        public bool bCapcuu_noitru_thuphi
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1501");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bKyhieu_chung
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=151");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bKham_trong_ngoai_gio
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=153");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bDenngay_sothe
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=154");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bChieu_sang
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=155");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bDonthuoc_cachdung
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=156");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bChidinh_vienphi
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=157");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bHoisuc_dungcu
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=158");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bSophieu_pttt
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=159");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bChandoan_icd10
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=160");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bInphieuttravien_xuatkhoa
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=161");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bLoad_tiepdon
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=162");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bBHYT_tungay
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=163");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bInchidinh_donthuoc
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=164");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bSovaovien_ylenh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=167");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bThuoc_ngay
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=169");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bKetxuat_bangdien
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=170");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bNoigioithieu_tiepdon
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=172");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bMabn_tudong_cdh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=173");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bMabn_tudong_tiepdon
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=223");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bDocmavach
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=224");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bSovaovien_noitru
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=225");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bSovaovien_noitru_phongluu
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=241");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bSoluutru_sovaovien
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=227");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bDuyet_khambenh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=228");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public int iUserid_duyet
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=229");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 0; }
            }
        }

        public bool bKham_inchiphi
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=230");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bInchiphi_loaivp
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=231");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bKiemtra_taoschema
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=232");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bChuky
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=233");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public int iNhomphonggiuong
        {
            //option J01
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=234");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 0; }
            }
        }

        public bool bPhonggiuong
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=235");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }


        public bool bDichvu_vpkb
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=237");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bInchiphi_congkham
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=238");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool b1giuong
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=236");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bSoluutru_nam
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=226");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bSoluutru_xuatvien
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=239");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bClear_bskham
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=240");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public string Path_backup
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=174");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return "c://medisoft//backup"; }
            }
        }

        public bool bInchidinh_dien
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=199");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public string Path_bangdien
        {
            get
            {
                string ret = System.IO.Directory.GetCurrentDirectory().Substring(0, 3) + "//medisoft//bangdien";
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=171");
                    if (ds.Tables[0].Rows[0][0].ToString() != "") ret = ds.Tables[0].Rows[0][0].ToString();
                }
                catch { }
                if (!System.IO.Directory.Exists(ret)) System.IO.Directory.CreateDirectory(ret);
                return ret;
            }
        }

        public bool bKhongin_tienkham
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=133");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bDanhmucthuocbv
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=48");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bLuachon_tienkham
        {
            get
            {
                try
                {
                    return int.Parse(Thongso("c134")) == 1;
                }
                catch { return false; }
            }
        }

        public bool bDangky_chuongtrinh
        {
            get
            {
                try
                {
                    return int.Parse(Thongso("c206")) == 1;
                }
                catch { return false; }
            }
        }

        public bool bIdcls_tudong
        {
            get
            {
                try
                {
                    return int.Parse(Thongso("c207")) == 1;
                }
                catch { return false; }
            }
        }

        public bool bSend_ct2003
        {
            get
            {
                try
                {
                    return int.Parse(Thongso("c208")) == 1;
                }
                catch { return false; }
            }
        }

        public bool bMabn_ct_rieng
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=209");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }

        public bool bDanhsach_bsbvchidinh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=210");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }

        public bool bIdcls
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=211");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }

        public bool bLoad_Ketqua
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=212");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bPttt_Konhapkhoa
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=213");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }

        public bool bInsovaovien_ravien
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=214");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }

        public bool bPhongkham_chidinh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=215");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }

        public bool bSoluutru_icd10
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=216");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }

        public bool bInravien_ravien
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=217");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }

        public bool bThanhtoan_tronsoluong
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=218");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bTaikham_chidinh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=219");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public int iMavp_taikham
        {
            get
            {
                try
                {
                    ds = get_data("select ten from " + user + ".thongso where id=220");
                    if (ds.Tables[0].Rows.Count == 0) return 0;
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString().Trim());
                }
                catch { return 0; }
            }
        }

        public bool bNgoaitru_congkham
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=289");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public int iMavp_ngoaitru
        {
            get
            {
                try
                {
                    ds = get_data("select ten from " + user + ".thongso where id=290");
                    if (ds.Tables[0].Rows.Count == 0) return 0;
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString().Trim());
                }
                catch { return 0; }
            }
        }
        public bool bThutien_the
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=262");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bXetnghiem_cdha(string v_mavp)
        {
            try
            {
                DataSet ds = get_data("select idnhomvpmedisoft from " + user + ".v_giavp a inner join  " + user +
                    ".v_loaivp b on a.id_loai=b.id inner join " + user + ".v_nhomvp c on b.id_nhom=c.ma where a.id='" + v_mavp + "'");
                return (int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1 || int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 2);
            }
            catch { return false; }
        }

        public int iMavp_the
        {
            get
            {
                try
                {
                    ds = get_data("select ten from " + user + ".thongso where id=263");
                    if (ds.Tables[0].Rows.Count == 0) return 0;
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString().Trim());
                }
                catch { return 0; }
            }
        }

        public string pathImage
        {
            get
            {
                try
                {
                    ds = get_data("select ten from " + user + ".thongso where id=265");
                    if (ds.Tables[0].Rows.Count == 0) return "";
                    return ds.Tables[0].Rows[0][0].ToString().Trim();
                }
                catch { return ""; }
            }
        }

        public int delay1
        {
            get
            {
                try
                {
                    ds = get_data("select ten from " + user + ".thongso where id=266");
                    if (ds.Tables[0].Rows.Count == 0) return 1800;
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString().Trim());
                }
                catch { return 1800; }
            }
        }
        public int delay1_pk
        {
            get
            {
                try
                {
                    ds = get_data("select ten from " + user + ".thongso where id=1013");
                    if (ds.Tables[0].Rows.Count == 0) return 1800;
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString().Trim());
                }
                catch { return 1800; }
            }
        }

        public int delay2
        {
            get
            {
                try
                {
                    ds = get_data("select ten from " + user + ".thongso where id=267");
                    if (ds.Tables[0].Rows.Count == 0) return 600;
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString().Trim());
                }
                catch { return 600; }
            }
        }

        public int delay2_pk
        {
            get
            {
                try
                {
                    ds = get_data("select ten from " + user + ".thongso where id=1014");
                    if (ds.Tables[0].Rows.Count == 0) return 600;
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString().Trim());
                }
                catch { return 600; }
            }
        }
        public int delay3
        {
            get
            {
                try
                {
                    ds = get_data("select ten from " + user + ".thongso where id=268");
                    if (ds.Tables[0].Rows.Count == 0) return 300;
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString().Trim());
                }
                catch { return 300; }
            }
        }

        public int delay3_pk
        {
            get
            {
                try
                {
                    ds = get_data("select ten from " + user + ".thongso where id=1014");
                    if (ds.Tables[0].Rows.Count == 0) return 300;
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString().Trim());
                }
                catch { return 300; }
            }
        }

        public int delay4
        {
            get
            {
                try
                {
                    ds = get_data("select ten from " + user + ".thongso where id=269");
                    if (ds.Tables[0].Rows.Count == 0) return 600;
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString().Trim());
                }
                catch { return 600; }
            }
        }

        public int delay4_pk
        {
            get
            {
                try
                {
                    ds = get_data("select ten from " + user + ".thongso where id=1015");
                    if (ds.Tables[0].Rows.Count == 0) return 600;
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString().Trim());
                }
                catch { return 600; }
            }
        }
        public int delay5
        {
            get
            {
                try
                {
                    ds = get_data("select ten from " + user + ".thongso where id=270");
                    if (ds.Tables[0].Rows.Count == 0) return 600;
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString().Trim());
                }
                catch { return 600; }
            }
        }

        public int delay6
        {
            get
            {
                try
                {
                    ds = get_data("select ten from " + user + ".thongso where id=272");
                    if (ds.Tables[0].Rows.Count == 0) return 600;
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString().Trim());
                }
                catch { return 600; }
            }
        }

        public int delay6_pk
        {
            get
            {
                try
                {
                    ds = get_data("select ten from " + user + ".thongso where id=1018");
                    if (ds.Tables[0].Rows.Count == 0) return 600;
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString().Trim());
                }
                catch { return 600; }
            }
        }

        public int delay7
        {
            get
            {
                try
                {
                    ds = get_data("select ten from " + user + ".thongso where id=273");
                    if (ds.Tables[0].Rows.Count == 0) return 600;
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString().Trim());
                }
                catch { return 600; }
            }
        }

        public bool bDocchucngantram
        {
            get
            {
                try
                {
                    ds = get_data("select ten from " + user + ".thongso where id=271");
                    if (ds.Tables[0].Rows.Count == 0) return false;
                    return ds.Tables[0].Rows[0][0].ToString().Trim() == "1";
                }
                catch { return false; }
            }
        }

        public bool bGiokham
        {
            get
            {
                try
                {
                    ds = get_data("select ten from " + user + ".thongso where id=274");
                    if (ds.Tables[0].Rows.Count == 0) return false;
                    return ds.Tables[0].Rows[0][0].ToString().Trim() == "1";
                }
                catch { return false; }
            }
        }

        public bool bDonthuoc_stc
        {
            get
            {
                try
                {
                    ds = get_data("select ten from " + user + ".thongso where id=276");
                    if (ds.Tables[0].Rows.Count == 0) return false;
                    return ds.Tables[0].Rows[0][0].ToString().Trim() == "1";
                }
                catch { return false; }
            }
        }

        public bool bDelFileTemp
        {
            get
            {
                try
                {
                    ds = get_data("select ten from " + user + ".thongso where id=277");
                    if (ds.Tables[0].Rows.Count == 0) return false;
                    return ds.Tables[0].Rows[0][0].ToString().Trim() == "1";
                }
                catch { return false; }
            }
        }
        //linh 05102012
        /// <summary>
        /// Tính theo cách tính của BHYT. Lấy móc 12h khuya, nằm khoa nào sẽ tính tiền giường cho khoa đó.
        /// Nếu nằm trong ngày, thì sẽ tính 1 ngày cho khoa đầu tiên.
        /// </summary>
        public bool bNgayra_ngayvao_1
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=278");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bMadoituong_giuongdichvu
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=279");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }
        public int madoituong_giuongdichvu
        {
            get
            {
                try
                {
                    ds = get_data("select ten from " + user + ".thongso where id=280");
                    if (ds.Tables[0].Rows.Count == 0) return 0;
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString().Trim());
                }
                catch { return 0; }
            }
        }
        public bool bAdminInlaidonthuoc
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=281");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }
        public bool bAdminInlaiphieuchidinh
        {
            //H18
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1052");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }
        public int iSokytuthe_xet_chiphivanchuyen
        {
            //E24
            //Chon: lay 3 ky tu dau: vi du CC1, TE1, CN6...
            //khong chon lay 2 ky tu dau vi du CC, TE, CN
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1053");
                    return (ds.Tables[0].Rows[0][0].ToString() == "1") ? 3 : 2;
                }
                catch { return 2; }
            }
        }


        public bool bPhongkham_bangdien_kontum
        {
            //K08
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1054");
                    return ds.Tables[0].Rows[0][0].ToString() == "1";
                }
                catch { return false; }
            }
        }
        public bool bThuphi_khongloadthuoc_BHYT
        {
            //F34
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1055");
                    return ds.Tables[0].Rows[0][0].ToString() == "1";
                }
                catch { return false; }
            }
        }

        public bool bSophieu_TTRV_theonam
        {
            //D23
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1056");
                    return ds.Tables[0].Rows[0][0].ToString() == "1";
                }
                catch { return false; }
            }
        }
        public bool bSophieu_TTRV_theonam_tinhtu_taosolieu
        {
            //D24
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1064");
                    return ds.Tables[0].Rows[0][0].ToString() == "1";
                }
                catch { return false; }
            }
        }
        public bool bSophieu_TTRV_theothang_tinhtu_ngay01
        {
            //D25
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1065");
                    return ds.Tables[0].Rows[0][0].ToString() == "1";
                }
                catch { return false; }
            }
        }

        public bool bSophieu_TTRV_theothang_tinhtu_toasolieu
        {
            //D26
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1066");
                    return ds.Tables[0].Rows[0][0].ToString() == "1";
                }
                catch { return false; }
            }
        }
        public bool bCaptoa_loctheokho_khaibaokhoa_trongduoc
        {
            //F36
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1068");
                    return ds.Tables[0].Rows[0][0].ToString() == "1";
                }
                catch { return false; }
            }
        }
        public int iSotien_cancanhbao_khicaptoa
        {
            //F37
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1069");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 0; }
            }
        }
        /// <summary>
        /// Tính theo cách tính của khách sạn.
        /// </summary>
        public bool bNgaygiuong_tinhtheo_sangchieu
        {
            //J05.1
            //Vao sang - ra sang, hay vao chieu ra chieu: them 0.5 ngay
            //Vao sang - ra chieu: tinh them 1 ngay
            //Vao chieu - ra sang: 0 ngay
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1070");
                    return ds.Tables[0].Rows[0][0].ToString() == "1" && !bNgayra_ngayvao_1;
                }
                catch { return false; }
            }
        }

        public bool bTinhtiengiuong_lucdatgiuong
        {
            //J09
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1071");
                    return ds.Tables[0].Rows[0][0].ToString() == "1";
                }
                catch { return false; }
            }
        }

        public bool bDutru_taisan_tren_csdl_moi
        {
            //F38
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1072");
                    return ds.Tables[0].Rows[0][0].ToString() == "1";
                }
                catch { return false; }
            }
        }

        public bool bQuanly_theokhu
        {
            //A14.1
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1073");
                    return ds.Tables[0].Rows[0][0].ToString() == "1";
                }
                catch { return false; }
            }
        }

        public bool bMSBN_Tudong_Theomay
        {
            //D10.1
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1074");
                    return ds.Tables[0].Rows[0][0].ToString() == "1";
                }
                catch { return false; }
            }
        }
        public bool bBHYT_Phanbiet_NVBenhvien
        {
            //E25
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1075");
                    return ds.Tables[0].Rows[0][0].ToString() == "1";
                }
                catch { return false; }
            }
        }

        public bool bQuanly_Theo_Chinhanh
        {
            //A14.2
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=998");
                    return ds.Tables[0].Rows[0][0].ToString() == "1";
                }
                catch { return false; }
            }
        }

        public bool blamtron_thuphi
        {
            //G90
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=595");
                    return ds.Tables[0].Rows[0][0].ToString() == "1";
                }
                catch { return false; }
            }
        }

        public int i_Chinhanh_hientai
        {
            get
            {
                try
                {
                    string s_ip_local = Maincode("Ip");
                    string s_database_local = Maincode("Database");
                    DataSet dsChinhanh = get_data(" select id from " + userid + ".dmchinhanh where ip='" + s_ip_local + "' and lower(database_local)='" + s_database_local + "' and port='" + Maincode("Post") + "'");
                    if (dsChinhanh == null || dsChinhanh.Tables.Count <= 0 || dsChinhanh.Tables[0].Rows.Count == 0)
                    {
                        DataSet dstmp = get_data("select ten from " + userid + ".thongso where id=999");
                        return int.Parse(dstmp.Tables[0].Rows[0][0].ToString());
                    }
                    else
                    {
                        return int.Parse(dsChinhanh.Tables[0].Rows[0][0].ToString());
                    }
                }
                catch { return 0; }
            }
        }
        public bool bCaptoa_theodanhmuc_duocketoa
        {
            //F35
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1067");
                    return ds.Tables[0].Rows[0][0].ToString() == "1";
                }
                catch { return false; }
            }
        }
        public bool bChophep_BNKhoaA_namgiuong_khoaB
        {
            //j08
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1057");
                    return ds.Tables[0].Rows[0][0].ToString() == "1";
                }
                catch { return false; }
            }
        }
        public bool bXoaTrong_NoiDK_KCB_bandau
        {
            //B13
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1058");
                    return ds.Tables[0].Rows[0][0].ToString() == "1";
                }
                catch { return false; }
            }
        }
        public bool bBH_chitra_1congkham_conlaikhongtinh_G79_1
        {
            //G79.1
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1059");
                    return ds.Tables[0].Rows[0][0].ToString() == "1";
                }
                catch { return false; }
            }
        }
        public bool bMabn_tudong_tu_ServerInterNet_D24
        {
            //D24
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1060");
                    return ds.Tables[0].Rows[0][0].ToString() == "1";
                }
                catch { return false; }
            }
        }
        public bool bBieu02_Khong_Hienthi_khoa_C66
        {
            //C66
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1061");
                    return ds.Tables[0].Rows[0][0].ToString() == "1";
                }
                catch { return false; }
            }
        }
        public int iSolanin_toathuoc
        {
            //F35
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1062");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 0; }
            }
        }
        public int iSongaydieutri_congthem
        {
            //A29
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1063");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 1; }
            }
        }
        public int iSoquaytiendon
        {
            //A31
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1000");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 1; }
            }
        }
        public int iSoThangTuoiGioiHanTheHienThangTuoi
        {
            //A32
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1510");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 24; }
            }
        }
        public bool bDonthuoc_khambenh_1lan
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=282");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }
        public bool bChuyendoituong
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=283");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }
        public bool bKyhieu_may
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=287");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }
        public bool bHuyvp_phuchoi
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=288");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }
        public int iChuyendoituong1
        {
            get
            {
                try
                {
                    ds = get_data("select ten from " + user + ".thongso where id=284");
                    if (ds.Tables[0].Rows.Count == 0) return 0;
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString().Trim());
                }
                catch { return 0; }
            }
        }
        public int iChuyenmavp
        {
            get
            {
                try
                {
                    ds = get_data("select ten from " + user + ".thongso where id=285");
                    if (ds.Tables[0].Rows.Count == 0) return 0;
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString().Trim());
                }
                catch { return 0; }
            }
        }
        public int iChuyendoituong2
        {
            get
            {
                try
                {
                    ds = get_data("select ten from " + user + ".thongso where id=286");
                    if (ds.Tables[0].Rows.Count == 0) return 0;
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString().Trim());
                }
                catch { return 0; }
            }
        }
        public string FileType
        {
            get
            {
                try
                {
                    ds = get_data("select ten from " + user + ".thongso where id=275");
                    if (ds.Tables[0].Rows.Count == 0) return "BMP";
                    return ds.Tables[0].Rows[0][0].ToString().Trim();
                }
                catch { return "BMP"; }
            }
        }

        public string sGiocapcuu_tu
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=221");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return "00:00"; }
            }
        }

        public string sGiocapcuu_den
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=222");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return "00:00"; }
            }
        }

        public bool bDanhmuc_nhathuoc
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=135");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public string gio_nhathuoc
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=136");
                    return ds.Tables[0].Rows[0][0].ToString().Trim();
                }
                catch { return "00:00"; }
            }
        }

        public string gio_bhyt
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=175");
                    return ds.Tables[0].Rows[0][0].ToString().Trim();
                }
                catch { return "00:00"; }
            }
        }

        public string kho_bhyt
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=176");
                    return ds.Tables[0].Rows[0][0].ToString().Trim();
                }
                catch { return ""; }
            }
        }

        public string kho_nhathuoc
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=137");
                    return ds.Tables[0].Rows[0][0].ToString().Trim();
                }
                catch { return ""; }
            }
        }

        public string sGiobaocao
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=138");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return "00:00"; }
            }
        }

        public int songaydtngoaitru
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=139");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 30; }
            }
        }
        public bool bSuadt_thuoc_vp
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=131");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public int nhom_nhathuoc
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=165");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 1; }
            }
        }

        public int nhom_duoc
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=166");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 1; }
            }
        }

        public bool bCongdon
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=200");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bMabame
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=114");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public string Path_thongbao
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=115");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return "..//..//..//doc//thongbao.rtf"; }
            }
        }

        public bool bKhamthai
        {
            get
            {
                try
                {
                    return int.Parse(Thongso("c116")) == 1;
                }
                catch { return false; }
            }
        }

        public bool bHonnhan
        {
            get
            {
                try
                {
                    return int.Parse(Thongso("c125")) == 1;
                }
                catch { return false; }
            }
        }

        public bool bMach_nhietdo
        {
            get
            {
                try
                {
                    return int.Parse(Thongso("c126")) == 1;
                }
                catch { return false; }
            }
        }

        public bool bLydokham
        {
            get
            {
                try
                {
                    return int.Parse(Thongso("c127")) == 1;
                }
                catch { return false; }
            }
        }

        public bool bSoluutru_nhapvien
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=111");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        // Thuy 30.12.2011
        public bool bthongbaosovaovien
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1098");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bthongbaosoluutru
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1099");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        //end Thuy
        public bool bNuocngoai(string m_mabn)
        {
            ds = get_data("select madantoc from " + user + ".btdbn where mabn='" + m_mabn + "'");
            if (ds.Tables[0].Rows.Count > 0) return ds.Tables[0].Rows[0]["madantoc"].ToString() == "55";
            else return false;
        }

        public bool bKhoDongY(int nhomkho)
        {
            ds = get_data("select dongy from " + user + ".d_dmkho where id=" + nhomkho + " and dongy=1");
            if (ds.Tables[0].Rows.Count > 0) return ds.Tables[0].Rows[0]["dongy"].ToString() == "1";
            else return false;
        }

        public decimal dTygia
        {
            get
            {
                ds = get_data("select to_char(ngay,'yyyymmdd'),tygia from " + user + ".v_tygia order by ngay desc");
                if (ds.Tables[0].Rows.Count > 0) return decimal.Parse(ds.Tables[0].Rows[0]["tygia"].ToString());
                else return 1;
            }
        }

        public bool bHiendanhsach
        {
            get
            {
                try
                {
                    return int.Parse(Thongso("c105")) == 1;
                }
                catch { return false; }
            }
        }

        public bool bHienkyhieu
        {
            get
            {
                try
                {
                    return int.Parse(Thongso("c57")) == 1;
                }
                catch { return false; }
            }
        }

        public bool bSobienlai
        {
            get
            {
                try
                {
                    return int.Parse(Thongso("c58")) == 1;
                }
                catch { return false; }
            }
        }

        public bool bDiungthuoc
        {
            get
            {
                try
                {
                    return int.Parse(Thongso("c61")) == 1;
                }
                catch { return false; }
            }
        }

        public int iTuoi_khamnhi
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=104");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 15; }
            }
        }

        public int iTuoi_nguoibenh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=107");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 120; }
            }
        }

        public bool bTiepdonMoi
        {
            //A17.1: tiep don theo mau cua Hepa
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1135");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        private void xml_access()
        {
            execute_data("delete from " + user + ".dm_01");
            ds = new DataSet();
            ds.ReadXml("..//..//..//xml//dm_01.xml");
            foreach (DataRow r in ds.Tables[0].Rows)
                upd_dm01(int.Parse(r["ma"].ToString()), r["stt"].ToString(), r["ten"].ToString(), r["loai"].ToString(), int.Parse(r["kp"].ToString()), int.Parse(r["matk"].ToString()));
            foreach (DataRow r in get_data("select * from " + user + ".btdkp_bv order by loai").Tables[0].Rows)
                upd_dm01(int.Parse(r["makp"].ToString()) + 51, "-", r["tenkp"].ToString(), "C", (r["loai"].ToString() == "0") ? 2 : 1, int.Parse(r["makpbo"].ToString()) + 12);
            kh_dm_1451();
            xml_access("dmdiadiem");
            xml_access("dmngodoc");
            xml_access("dmnguyennhan");
            xml_access("dmbophan");
            xml_access("dmdienbien");
            xml_access("dmxutri");
        }

        private void kh_dm_1451()
        {
            execute_data("delete from " + user + ".kh_dm_1451");
            ds = new DataSet();
            ds.ReadXml("..//..//..//xml//kh_dm_1451.xml");
            foreach (DataRow r in ds.Tables[0].Rows)
                upd_danhmuc(int.Parse(r["ma"].ToString()), r["stt"].ToString(), r["ten"].ToString(), "kh_dm_1451");
        }

        private void xml_access(string tenfile)
        {
            execute_data("delete from " + user + "." + tenfile);
            ds = new DataSet();
            ds.ReadXml("..//..//..//xml//" + tenfile + ".xml");
            foreach (DataRow r in ds.Tables[0].Rows)
                upd_danhmuc(int.Parse(r["ma"].ToString()), int.Parse(r["stt"].ToString()), r["ten"].ToString(), tenfile);
        }

        private bool upd_danhmuc(int m_ma, int m_stt, string m_ten, string m_table)
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            sql = "update " + user + "." + m_table + " set stt=:m_stt,ten=:m_ten";
            sql += " where ma=:m_ma";
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + "." + m_table + " (ma,stt,ten) values (:m_ma,:m_stt,:m_ten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, m_table);
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool bAdmin(int userid)
        {
            try
            {
                ds = get_data("select manhom from " + user + ".dlogin where manhom in (0,1) and id=" + userid);
                return ds.Tables[0].Rows.Count != 0;
            }
            catch { return false; }
        }
        public bool bAdminHethong(int userid)
        {
            try
            {
                ds = get_data("select manhom from " + user + ".dlogin where manhom in (0) and id=" + userid);
                return ds.Tables[0].Rows.Count != 0;
            }
            catch { return false; }
        }
        public bool bThuvien
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=101");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch
                {
                    if (get_data("select * from " + user + ".thongso where id=101").Tables[0].Rows.Count == 0) execute_data("insert into thongso(id,ten) values (101," + "0" + ")");
                    return false;
                }
            }
        }

        public bool bHanhChinh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=0");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public void MaskDigit(System.Windows.Forms.KeyPressEventArgs e)
        {
            if (Char.IsDigit(e.KeyChar) || e.KeyChar == 8) e.Handled = false;
            else e.Handled = true;
        }
        public void MaskDigit_dautru(System.Windows.Forms.KeyPressEventArgs e)
        {
            if (Char.IsDigit(e.KeyChar) || e.KeyChar == 8 || e.KeyChar == '-') e.Handled = false;
            else e.Handled = true;
        }
        public void MaskDecimal(System.Windows.Forms.KeyPressEventArgs e)
        {
            if (Char.IsDigit(e.KeyChar) || e.KeyChar == '.' || e.KeyChar == 8) e.Handled = false;
            else e.Handled = true;
        }

        public string abc_uni(string s)
        {
            DataSet ds = new DataSet();
            ds.ReadXml("..//..//..//xml//doifont.xml");
            string s_abc = s.Trim(), s_uni = "", s1 = "óïñòô­øõö÷ùýúûüþãßáâä«èåæçé¬íêëìî1";
            DataRow r;
            for (int i = 0; i < s_abc.Length; i++)
            {
                if (s1.IndexOf(s_abc[i].ToString()) != -1)
                {
                    r = getrowbyid(ds.Tables[0], "abc1='" + s_abc[i].ToString() + "'");
                    if (r != null) s_uni += r[3].ToString();
                    else s_uni += s_abc[i];
                }
                else
                {
                    r = getrowbyid(ds.Tables[0], "abc='" + s_abc[i].ToString() + "'");
                    if (r != null) s_uni += r[1].ToString();
                    else s_uni += s_abc[i];
                }
            }
            return s_uni;
        }

        public string uni_vni(string s)
        {
            DataSet ds = new DataSet();
            ds.ReadXml("..//..//..//xml//doifont.xml");
            string s_uni = s.Trim(), s_vni = "", s1 = "ú+ù+ủ+ũ+ụ+ư+ứ+ừ+ử+ữ+ự+ý+ỳ+ỷ+ỹ+ỵ+ó+ò+ỏ+õ+ọ+ô+ố+ồ+ổ+ỗ+ộ+ơ+ớ+ờ+ở+ỡ+ợ+1";
            DataRow r;
            for (int i = 0; i < s_uni.Length; i++)
            {
                if (s1.IndexOf(s_uni[i].ToString()) != -1)
                {
                    r = getrowbyid(ds.Tables[0], "uni1='" + s_uni[i].ToString() + "'");
                    if (r != null) s_vni += r[3].ToString();
                    else s_vni += s_uni[i];
                }
                else
                {
                    r = getrowbyid(ds.Tables[0], "uni='" + s_uni[i].ToString() + "'");
                    if (r != null) s_vni += r[1].ToString();
                    else s_vni += s_uni[i];
                }
            }
            return s_vni;
        }

        public string vni_uni(string s)
        {
            DataSet ds = new DataSet();
            ds.ReadXml("..//..//..//xml//doifont.xml");
            string s_vni = s.Trim(), s_uni = "", s1 = "uù+uø+uû+uõ+uï+ö+öù+öø+öû+öõ+öï+yù+yø+yû+yõ+î+où+oø+oû+oõ+oï+oâ+oá+oà+oå+oã+oä+ô+ôù+ôø+ôû+ôõ+ôï";
            DataRow r;
            for (int i = 0; i < s_vni.Length; i++)
            {
                if (s1.IndexOf(s_vni[i].ToString()) != -1)
                {
                    r = getrowbyid(ds.Tables[0], "vni1='" + s_vni[i].ToString() + "'");
                    if (r != null) s_uni += r[3].ToString();
                    else s_uni += s_vni[i];
                }
                else
                {
                    r = getrowbyid(ds.Tables[0], "vni='" + s_vni[i].ToString() + "'");
                    if (r != null) s_uni += r[1].ToString();
                    else s_uni += s_vni[i];
                }
            }
            return s_uni;
        }

        public string getIndex(int i)
        {
            string[] map = {"A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P", "Q", "R", "S", "T", "U", "V", "W", "X", "Y", "Z",
							   "AA", "AB", "AC", "AD", "AE", "AF", "AG", "AH", "AI", "AJ", "AK", "AL", "AM", "AN", "AO", "AP", "AQ", "AR", "AS", "AT", "AU", "AV", "AW", "AX", "AY", "AZ",
							   "BA", "BB", "BC", "BD", "BE", "BF", "BG", "BH", "BI", "BJ", "BK", "BL", "BM", "BN", "BO", "BP", "BQ", "BR", "BS", "BT", "BU", "BV", "BW", "BX", "BY", "BZ",
							   "CA", "CB", "CC", "CD", "CE", "CF", "CG", "CH", "CI", "CJ", "CK", "CL", "CM", "CN", "CO", "CP", "CQ", "CR", "CS", "CT", "CU", "CV", "CW", "CX", "CY", "CZ",
							   "DA", "DB", "DC", "DD", "DE", "DF", "DG", "DH", "DI", "DJ", "DK", "DL", "DM", "DN", "DO", "DP", "DQ", "DR", "DS", "DT", "DU", "DV", "DW", "DX", "DY", "DZ",
							   "EA", "EB", "EC", "ED", "EE", "EF", "EG", "EH", "EI", "EJ", "EK", "EL", "EM", "EN", "EO", "EP", "EQ", "ER", "ES", "ET", "EU", "EV", "EW", "EX", "EY", "EZ",
							   "FA", "FB", "FC", "FD", "FE", "FF", "FG", "FH", "FI", "FJ", "FK", "FL", "FM", "FN", "FO", "FP", "FQ", "FR", "FS", "FT", "FU", "FV", "FW", "FX", "FY", "FZ",
							   "GA", "GB", "GC", "GD", "GE", "GF", "GG", "GH", "GI", "GJ", "GK", "GL", "GM", "GN", "GO", "GP", "GQ", "GR", "GS", "GT", "GU", "GV", "GW", "GX", "GY", "GZ",
							   "HA", "HB", "HC", "HD", "HE", "HF", "HG", "HH", "HI", "HJ", "HK", "HL", "HM", "HN", "HO", "HP", "HQ", "HR", "HS", "HT", "HU", "HV", "HW", "HX", "HY", "HZ",
							   "IA", "IB", "IC", "ID", "IE", "IF", "IG", "IH", "II", "IJ", "IK", "IL", "IM", "IN", "IO", "IP", "IQ", "IR", "IS", "IT", "IU", "IV", "IW", "IX", "IY", "IZ",
							   "JA", "JB", "JC", "JD", "JE", "JF", "JG", "JH", "JI", "JJ", "JK", "JL", "JM", "JN", "JO", "JP", "JQ", "JR", "JS", "JT", "JU", "JV", "JW", "JX", "JY", "JZ",
							   "KA", "KB", "KC", "KD", "KE", "KF", "KG", "KH", "KI", "KJ", "KK", "KL", "KM", "KN", "KO", "KP", "KQ", "KR", "KS", "KT", "KU", "KV", "KW", "KX", "KY", "KZ",
							   "LA", "LB", "LC", "LD", "LE", "LF", "LG", "LH", "LI", "LJ", "LK", "LL", "LM", "LN", "LO", "LP", "LQ", "LR", "LS", "LT", "LU", "LV", "LW", "LX", "LY", "LZ",
							   "MA", "MB", "MC", "MD", "ME", "MF", "MG", "MH", "MI", "MJ", "MK", "ML", "MM", "MN", "MO", "MP", "MQ", "MR", "MS", "MT", "MU", "MV", "MW", "MX", "MY", "MZ",
							   "NA", "NB", "NC", "ND", "NE", "NF", "NG", "NH", "NI", "NJ", "NK", "NL", "NM", "NN", "NO", "NP", "NQ", "NR", "NS", "NT", "NU", "NV", "NW", "NX", "NY", "NZ",
							   "OA", "OB", "OC", "OD", "OE", "OF", "OG", "OH", "OI", "OJ", "OK", "OL", "OM", "ON", "OO", "OP", "OQ", "OR", "OS", "OT", "OU", "OV", "OW", "OX", "OY", "OZ",
							   "PA", "PB", "PC", "PD", "PE", "PF", "PG", "PH", "PI", "PJ", "PK", "PL", "PM", "PN", "PO", "PP", "PQ", "PR", "PS", "PT", "PU", "PV", "PW", "PX", "PY", "PZ",
							   "QA", "QB", "QC", "QD", "QE", "QF", "QG", "QH", "QI", "QJ", "QK", "QL", "QM", "QN", "QO", "QP", "QQ", "QR", "QS", "QT", "QU", "QV", "QW", "QX", "QY", "QZ",
							   "RA", "RB", "RC", "RD", "RE", "RF", "RG", "RH", "RI", "RJ", "RK", "RL", "RM", "RN", "RO", "RP", "RQ", "RR", "RS", "RT", "RU", "RV", "RW", "RX", "RY", "RZ",
							   "SA", "SB", "SC", "SD", "SE", "SF", "SG", "SH", "SI", "SJ", "SK", "SL", "SM", "SN", "SO", "SP", "SQ", "SR", "SS", "ST", "SU", "SV", "SW", "SX", "SY", "SZ",
							   "TA", "TB", "TC", "TD", "TE", "TF", "TG", "TH", "TI", "TJ", "TK", "TL", "TM", "TN", "TO", "TP", "TQ", "TR", "TS", "TT", "TU", "TV", "TW", "TX", "TY", "TZ",
							   "UA", "UB", "UC", "UD", "UE", "UF", "UG", "UH", "UI", "UJ", "UK", "UL", "UM", "UN", "UO", "UP", "UQ", "UR", "US", "UT", "UU", "UV", "UW", "UX", "UY", "UZ",
							   "VA", "VB", "VC", "VD", "VE", "VF", "VG", "VH", "VI", "VJ", "VK", "VL", "VM", "VN", "VO", "VP", "VQ", "VR", "VS", "VT", "VU", "VV", "VW", "VX", "VY", "VZ",
							   "WA", "WB", "WC", "WD", "WE", "WF", "WG", "WH", "WI", "WJ", "WK", "WL", "WM", "WN", "WO", "WP", "WQ", "WR", "WS", "WT", "WU", "WV", "WW", "WX", "WY", "WZ",
							   "XA", "XB", "XC", "XD", "XE", "XF", "XG", "XH", "XI", "XJ", "XK", "XL", "XM", "XN", "XO", "XP", "XQ", "XR", "XS", "XT", "XU", "XV", "XW", "XX", "XY", "XZ",
							   "YA", "YB", "YC", "YD", "YE", "YF", "YG", "YH", "YI", "YJ", "YK", "YL", "YM", "YN", "YO", "YP", "YQ", "YR", "YS", "YT", "YU", "YV", "YW", "YX", "YY", "YZ",
							   "ZA", "ZB", "ZC", "ZD", "ZE", "ZF", "ZG", "ZH", "ZI", "ZJ", "ZK", "ZL", "ZM", "ZN", "ZO", "ZP", "ZQ", "ZR", "ZS", "ZT", "ZU", "ZV", "ZW", "ZX", "ZY", "ZZ"};

            return map[i];
        }

        public Color getColor(int i)
        {
            Color[] color = {Color.FromArgb(255,192,192),Color.FromArgb(192,192,255),Color.FromArgb(255,224,192),Color.FromArgb(192,255,192),Color.FromArgb(255,192,255),
								Color.Aqua,Color.Aquamarine,Color.BurlyWood,Color.CadetBlue,Color.Chartreuse,Color.Chocolate,Color.Coral,Color.CornflowerBlue,
								Color.Crimson,Color.Cyan,Color.DarkBlue,Color.DarkCyan,Color.DarkGoldenrod,Color.DarkGray,Color.DarkGreen,Color.DarkKhaki,Color.DarkMagenta,Color.DarkOliveGreen,
								Color.DarkOrange,Color.DarkOrchid,Color.DarkRed,Color.DarkSalmon,Color.DarkSeaGreen,Color.DarkSlateBlue,Color.DarkSlateGray,Color.DarkTurquoise,Color.DarkViolet,Color.DeepPink,
								Color.DeepSkyBlue,Color.DimGray,Color.DodgerBlue,Color.Firebrick,Color.FloralWhite,Color.ForestGreen,Color.Fuchsia,Color.Gainsboro,Color.Gold,Color.Goldenrod,
								Color.Gray,Color.Green,Color.GreenYellow,Color.Honeydew,Color.HotPink,Color.IndianRed,Color.Indigo,Color.Ivory,Color.Khaki,Color.Lavender,
								Color.LavenderBlush,Color.LawnGreen,Color.LemonChiffon,Color.LightBlue,Color.LightCoral,Color.LightCyan,Color.LightGoldenrodYellow,Color.LightGray,Color.LightGreen,Color.LightPink,
								Color.LightSalmon,Color.LightSeaGreen,Color.LightSkyBlue,Color.LightSlateGray,Color.LightSteelBlue,Color.LightYellow,Color.Lime,Color.LimeGreen,Color.Linen,Color.Magenta};
            return color[i];
        }

        public string Export_Excel(DataSet dset, string tenfile)
        {
            try
            {
                string dirPath = AppDomain.CurrentDomain.BaseDirectory + "Excel";
                string filePath = dirPath + "\\" + tenfile + ".xls";
                if (!System.IO.Directory.Exists(dirPath)) System.IO.Directory.CreateDirectory(dirPath);
                System.IO.StreamWriter sw = new System.IO.StreamWriter(filePath, false, System.Text.Encoding.Unicode);
                string astr = "";
                astr = "<Table>";//"<Table border=1>";
                astr = astr + "<tr>";
                for (int i = 0; i < dset.Tables[0].Columns.Count; i++)
                {
                    astr = astr + "<th>";
                    astr = astr + dset.Tables[0].Columns[i].ColumnName;
                    astr = astr + "</th>";
                }
                astr = astr + "</tr>";
                sw.Write(astr);
                for (int i = 0; i < dset.Tables[0].Rows.Count; i++)
                {
                    astr = "<tr>";
                    for (int j = 0; j < dset.Tables[0].Columns.Count; j++)
                    {
                        astr = astr + "<td>";
                        astr = astr + dset.Tables[0].Rows[i][j].ToString();
                        astr = astr + "</td>";
                    }
                    astr = astr + "</tr>";
                    sw.Write(astr);
                }
                astr = "</Table>";
                sw.Write(astr);
                sw.Close();
                return filePath;
            }
            catch (Exception ex)
            {
                upd_error(ex.Message, sComputer, tenfile);
                return "";
            }
        }

        private string onlyso(string s)
        {
            string ret = "", s1 = " 0123456789";
            for (int i = 0; i < s.Length; i++)
                if (s1.IndexOf(s.Substring(i, 1)) != -1) ret += s.Substring(i, 1);
            return ret;
        }

        public string Ktngaygio(string s, int len)
        {
            try
            {
                string s1 = onlyso(s);
                if (len == 10)
                    return s1.Substring(0, 2).Trim().PadLeft(2, '0') + "/" + s1.Substring(2, 2).Trim().PadLeft(2, '0') + "/" + s1.Substring(4).Trim().PadLeft(4, '0');
                else
                    return s1.Substring(0, 2).Trim().PadLeft(2, '0') + "/" + s1.Substring(2, 2).Trim().PadLeft(2, '0') + "/" + s1.Substring(4, 4).Trim().PadLeft(4, '0') + " " + s1.Substring(9, 2).Trim().PadLeft(2, '0') + ":" + s1.Substring(11, 2).Trim().PadLeft(2, '0');
            }
            catch { return s; }
        }

        public bool bNgay(string ngay)
        {
            try
            {
                if (ngay.IndexOf("_") != -1 || (ngay.IndexOf(" ") != -1 && ngay.Trim().Length == 10)) return false;
                int len = ngay.Length;
                if (len == 0) return false;
                string dd = ngay.Substring(0, 2), mm = ngay.Substring(3, 2), yyyy = ngay.Substring(6, 4);
                string s31 = "01+03+05+07+08+10+12+", s30 = "04+06+09+11+", s2829 = (int.Parse(yyyy) % 4 == 0) ? "29" : "28";
                if (int.Parse(yyyy.Substring(0, 1)) < 1) return false;
                if (int.Parse(mm) < 1 || int.Parse(mm) > 12) return false;
                if (s31.IndexOf(mm + "+") > -1)
                {
                    if (int.Parse(dd) < 1 || int.Parse(dd) > 31) return false;
                }
                else if (s30.IndexOf(mm + "+") > -1)
                {
                    if (int.Parse(dd) < 1 || int.Parse(dd) > 30) return false;
                }
                else if (int.Parse(dd) < 1 || int.Parse(dd) > int.Parse(s2829)) return false;
                if (len > 10)
                {
                    string hh = ngay.Substring(11, 2), MM = ngay.Substring(14, 2);
                    if (int.Parse(hh) > 23) return false;
                    if (int.Parse(MM) > 59) return false;
                }
                return true;
            }
            catch { return false; };
        }

        public bool bGio(string gio)
        {
            if (gio.IndexOf("::") != -1) return false;
            else
            {
                string hh = gio.Substring(0, 2), MM = gio.Substring(3, 2);
                if (int.Parse(hh) > 23) return false;
                if (int.Parse(MM) > 59) return false;
                return true;
            }
        }

        public string Caps(string s)
        {
            if (s.Length == 0) return null;
            System.Text.StringBuilder sb = new System.Text.StringBuilder(s);//.ToLower());
            sb[0] = Char.ToUpper(sb[0]);
            string ret = null;
            int num = 0; int ispace = 0;
            while (num < sb.Length)
            {
                if (Char.IsWhiteSpace(sb[num])) ispace++;
                if (!Char.IsWhiteSpace(sb[num]))
                {
                    if (ispace > 0 && num > 0)
                    {
                        sb[num] = Char.ToUpper(sb[num]);
                        ispace = 0;
                    }
                }
                num++;
            }
            num = 0;
            ispace = 0;
            while (num < sb.Length)
            {
                if (Char.IsWhiteSpace(sb[num]))
                {
                    if (ispace < 1 && num > 0) ret += sb[num];
                    ispace++;
                }
                else
                {
                    ret += sb[num];
                    ispace = 0;
                }
                num++;
            }
            return ret;
        }

        public bool bNgay(string ngayvao, string ngaysinh)
        {
            try
            {
                int d1 = DateTime.Now.Day;
                int m1 = DateTime.Now.Month;
                int y1 = DateTime.Now.Year;
                if (ngayvao != "")
                {
                    y1 = int.Parse(ngayvao.Substring(6, 4));
                    m1 = int.Parse(ngayvao.Substring(3, 2));
                    d1 = int.Parse(ngayvao.Substring(0, 2));
                }
                int d2 = int.Parse(ngaysinh.Substring(0, 2));
                int m2 = int.Parse(ngaysinh.Substring(3, 2));
                int y2 = int.Parse(ngaysinh.Substring(6, 4));
                if (y2 > y1) return false;
                else if (y2 < y1) return true;
                if (m2 > m1) return false;
                else if (m2 < m1) return true;
                if (d2 > d1) return false;
                return true;
            }
            catch { return true; }
        }

        public string Max(string ngay1, string ngay2)
        {
            int y1 = int.Parse(ngay1.Substring(6, 4));
            int m1 = int.Parse(ngay1.Substring(3, 2));
            int d1 = int.Parse(ngay1.Substring(0, 2));

            int d2 = int.Parse(ngay2.Substring(0, 2));
            int m2 = int.Parse(ngay2.Substring(3, 2));
            int y2 = int.Parse(ngay2.Substring(6, 4));

            if (y2 > y1) return ngay2;
            else if (y2 < y1) return ngay1;
            if (m2 > m1) return ngay2;
            else if (m2 < m1) return ngay1;
            if (d2 > d1) return ngay2;
            return ngay1;
        }

        public bool bNgaygio(string ngayrv, string ngayvv)
        {
            if (ngayrv.Trim() == "" || ngayvv.Trim() == "") return true;
            //int y1 = int.Parse(ngayrv.Substring(6, 4));
            //int m1 = int.Parse(ngayrv.Substring(3, 2));
            //int d1 = int.Parse(ngayrv.Substring(0, 2));
            //int h1 = (ngayrv.Length == 16) ? int.Parse(ngayrv.Substring(11, 2)) : -1;
            //int p1 = (ngayrv.Length == 16) ? int.Parse(ngayrv.Substring(14, 2)) : -1;

            //int d2 = int.Parse(ngayvv.Substring(0, 2));
            //int m2 = int.Parse(ngayvv.Substring(3, 2));
            //int y2 = int.Parse(ngayvv.Substring(6, 4));
            //int h2 = (ngayvv.Length == 16) ? int.Parse(ngayvv.Substring(11, 2)) : -1;
            //int p2 = (ngayvv.Length == 16) ? int.Parse(ngayvv.Substring(14, 2)) : -1;

            //if (y2 > y1) return false;
            //else if (y2 < y1) return true;
            //if (m2 > m1) return false;
            //else if (m2 < m1) return true;
            //if (d2 > d1) return false;
            //else if (d2 < d1) return true;
            //if (h2 > h1 && h2 > 0 && h1 > 0) return false;
            //else if (h2 < h1 && h2 > 0 && h1 > 0) return true;
            //if (p2 > p1 && p1 > 0 && p2 > 0) return false;
            if (ngayvv.Length == 10) ngayvv = ngayvv + " 00:00";
            if (ngayrv.Length == 10) ngayrv = ngayrv + " 00:00";
            DateTime dtNgayVao = StringToDateTime(ngayvv, "dd/MM/yyyy HH:mm");
            DateTime dtNgayRa = StringToDateTime(ngayrv, "dd/MM/yyyy HH:mm");
            return DateTime.Compare(dtNgayRa, dtNgayVao) >= 0;
        }

        public bool bGio(string t1, string t2)
        {
            int h1 = int.Parse(t1.Substring(0, 2));
            int p1 = int.Parse(t1.Substring(3, 2));

            int h2 = int.Parse(t2.Substring(0, 2));
            int p2 = int.Parse(t2.Substring(3, 2));

            if (h2 > h1) return false;
            else if (h2 < h1) return true;
            if (p2 > p1) return false;
            return true;
        }

        public string Tuoivao(string ngayvao, string ngaysinh)//Binh 27.11.2012
        {
            string tuoi = "";
            int namht = DateTime.Now.Year;
            int thanght = DateTime.Now.Month;
            int ngayht = DateTime.Now.Day;
            int gioht = DateTime.Now.Hour;
            //
            int i_ngaytuoi = 0;

            int nam = int.Parse(ngaysinh.Substring(6, 4));
            int thang = int.Parse(ngaysinh.Substring(3, 2));
            int ngay = int.Parse(ngaysinh.Substring(0, 2));
            int gio = (ngaysinh.Length > 10) ? int.Parse(ngaysinh.Substring(11, 2)) : 0;
            if (ngayvao != "")
            {
                namht = int.Parse(ngayvao.Substring(6, 4));
                thanght = int.Parse(ngayvao.Substring(3, 2));
                ngayht = int.Parse(ngayvao.Substring(0, 2));
                gioht = int.Parse(ngayvao.Substring(11, 2));
            }
            int i_thangtuoi = 0;
            if (thanght < thang)
            {
                i_thangtuoi = 12 * (namht - nam - 1) + thanght + (12 - thang);
            }
            else
            {
                i_thangtuoi = 12 * (namht - nam) + thanght - thang;
            }
            if (nam == namht)
            {
                if (thang == thanght)
                {
                    if (ngay == ngayht) tuoi = "3/" + (gioht - gio);
                    else tuoi = "2/" + (ngayht - ngay);
                }
                else if (thanght - thang < 3)
                {
                    for (int i = thang; i < thanght; i++)
                    {
                        i_ngaytuoi += (i == 1 || i == 3 || i == 5 || i == 7 || i == 8 || i == 10 || i == 12) ? 31 : (i == 4 || i == 6 || i == 9 || i == 11) ? 30 : (nam % 4) == 0 ? 29 : 28;
                    }
                    i_ngaytuoi = i_ngaytuoi + ngayht - ngay;
                    tuoi = "2/" + i_ngaytuoi;
                }
                else tuoi = "1/" + (thanght - thang);
            }
            else if (i_thangtuoi < iSoThangTuoiGioiHanTheHienThangTuoi)
            {
                if (i_thangtuoi < 2)
                {
                    int tu = 0, den = 0;
                    for (int j = nam; j <= namht; j++)
                    {
                        if (j == nam) { tu = thang; den = 12; }//den=12
                        else if (j == namht) { tu = 1; den = thanght; }
                        else { tu = 1; den = 12; }
                        for (int i = tu; i <= den; i++)
                        {
                            i_ngaytuoi += (i == 1 || i == 3 || i == 5 || i == 7 || i == 8 || i == 10 || i == 12) ? 31 : (i == 4 || i == 6 || i == 9 || i == 11) ? 30 : (nam % 4) == 0 ? 29 : 28;
                        }
                    }
                    i_ngaytuoi = i_ngaytuoi + ngayht - ngay + ((nam != namht) ? -31 : 0);
                    if (i_ngaytuoi >= 31)
                    {
                        tuoi = "1/" + i_thangtuoi;
                    }
                    else
                    {
                        tuoi = "2/" + i_ngaytuoi;
                    }
                }
                else
                {
                    tuoi = "1/" + i_thangtuoi;
                }
            }
            //#region Duoi 2 tuoi doi sang thang, duoi 2 thang doi sang ngay
            //else if (namht - nam < 2)
            //{
            //    int i_thangtuoi = 0;
            //    if (thanght < thang)
            //    {
            //        i_thangtuoi = 12 * (namht - nam - 1) + thanght + (12 - thang);
            //    }
            //    else
            //    {
            //        i_thangtuoi = 12 * (namht - nam) + thanght - thang;
            //    }
            //    if (i_thangtuoi < 3)
            //    {
            //        //                    
            //        int tu = 0, den = 0;
            //        for (int j = nam; j <= namht; j++)
            //        {
            //            if (j == nam) { tu = thang; den = 12; }
            //            else if (j == namht) { tu = 1; den = thanght; }
            //            else { tu = 1; den = 12; }
            //            for (int i = tu; i <= den; i++)
            //            {
            //                i_ngaytuoi += (i == 1 || i == 3 || i == 5 || i == 7 || i == 8 || i == 10 || i == 12) ? 31 : (i == 4 || i == 6 || i == 9 || i == 11) ? 30 : (nam % 4) == 0 ? 29 : 28;
            //            }
            //        }
            //        i_ngaytuoi = i_ngaytuoi + ngayht - ngay;
            //        tuoi = "2/" + i_ngaytuoi;
            //    }
            //    else
            //    {
            //        tuoi = "1/" + i_thangtuoi;
            //    }
            //}
            //#endregion
            else tuoi = "0/" + (namht - nam);
            return tuoi;
        }

        public string Tuoivao_old(string ngayvao, string ngaysinh)
        {
            string tuoi = "";
            int namht = DateTime.Now.Year;
            int thanght = DateTime.Now.Month;
            int ngayht = DateTime.Now.Day;
            int gioht = DateTime.Now.Hour;

            int nam = int.Parse(ngaysinh.Substring(6, 4));
            int thang = int.Parse(ngaysinh.Substring(3, 2));
            int ngay = int.Parse(ngaysinh.Substring(0, 2));
            int gio = (ngaysinh.Length > 10) ? int.Parse(ngaysinh.Substring(11, 2)) : 0;
            if (ngayvao != "")
            {
                namht = int.Parse(ngayvao.Substring(6, 4));
                thanght = int.Parse(ngayvao.Substring(3, 2));
                ngayht = int.Parse(ngayvao.Substring(0, 2));
                gioht = int.Parse(ngayvao.Substring(11, 2));
            }
            if (nam == namht)
            {
                if (thang == thanght)
                {
                    if (ngay == ngayht) tuoi = "3/" + (gioht - gio);
                    else tuoi = "2/" + (ngayht - ngay);
                }
                else tuoi = "1/" + (thanght - thang);
            }
            else tuoi = "0/" + (namht - nam);
            return tuoi;
        }
        public string Tuoivao_thang(string ngayvao, string ngaysinh, string namsinh)
        {
            string tuoi = "";
            int namht = DateTime.Now.Year;
            int thanght = DateTime.Now.Month;
            int ngayht = DateTime.Now.Day;
            int gioht = DateTime.Now.Hour;

            if (ngayvao != "")
            {
                namht = int.Parse(ngayvao.Substring(6, 4));
                thanght = int.Parse(ngayvao.Substring(3, 2));
                ngayht = int.Parse(ngayvao.Substring(0, 2));
                gioht = (ngayvao.Length > 10) ? int.Parse(ngayvao.Substring(11, 2)) : DateTime.Now.Hour;
            }
            if (ngaysinh.Trim() == "")
            {
                int inam = int.Parse(namsinh);
                if (namht - inam <= 6) tuoi = "1/" + ((namht - inam) * 12);
                else tuoi = "0/" + (namht - inam);
                return tuoi;
            }
            int nam = int.Parse(ngaysinh.Substring(6, 4));
            int thang = int.Parse(ngaysinh.Substring(3, 2));
            int ngay = int.Parse(ngaysinh.Substring(0, 2));
            int gio = (ngaysinh.Length > 10) ? int.Parse(ngaysinh.Substring(11, 2)) : 0;

            int sothang = 0;
            if (nam >= namht - 6)
            {
                sothang = (namht - nam) * 12;
                if (thang == thanght && sothang == 0)
                {
                    if (ngay == ngayht) tuoi = "3/" + (gioht - gio);
                    else tuoi = "2/" + (ngayht - ngay);
                }
                else if (thang <= thanght && sothang > 0)
                {
                    tuoi = "1/" + (sothang + thanght - thang);
                }
                else if (thang < thanght && sothang > 0)
                {
                    tuoi = "1/" + (sothang - 12 + thang);
                }
            }
            else tuoi = "0/" + (namht - nam);
            return tuoi;
        }

        public int Namsinh(string ngaysinh)
        {
            return int.Parse(ngaysinh.Substring(6, 4));
        }

        public int Namsinh(string ngayvao, int ituoi, int iloai)
        {
            int namht = (ngayvao != "") ? int.Parse(ngayvao.Substring(6, 4)) : DateTime.Now.Year;
            int iNamsinh = 0;
            if (iloai == 1 && ituoi <= 12)
            {
                if (bNgay(DateTime.Now.Day.ToString().PadLeft(2, '0') + "/" + ituoi.ToString().PadLeft(2, '0') + "/" + namht.ToString().PadLeft(4, '0'), DateTime.Now.Day.ToString().PadLeft(2, '0') + "/" + DateTime.Now.Month.ToString().PadLeft(2, '0') + "/" + namht.ToString().PadLeft(4, '0')))
                    iNamsinh = namht - 1;
                else iNamsinh = namht;
            }
            else if (iloai == 1 && ituoi <= 72)
            {
                int tmp_tuoi = ituoi / 12;
                int tmp_thang = ituoi - (tmp_tuoi * 12);
                if (bNgay(DateTime.Now.Day.ToString().PadLeft(2, '0') + "/" + tmp_thang.ToString().PadLeft(2, '0') + "/" + namht.ToString().PadLeft(4, '0'), DateTime.Now.Day.ToString().PadLeft(2, '0') + "/" + DateTime.Now.Month.ToString().PadLeft(2, '0') + "/" + namht.ToString().PadLeft(4, '0')))
                    iNamsinh = namht - tmp_tuoi - 1;
                else iNamsinh = namht - tmp_tuoi;
            }
            else
            {
                switch (iloai)
                {
                    case 0: iNamsinh = namht - ituoi;
                        break;
                    case 1: iNamsinh = namht - ituoi / 12;
                        break;
                    case 2: iNamsinh = namht - ituoi / 365;
                        break;
                    default: iNamsinh = namht;
                        break;
                }
            }
            return iNamsinh;
        }

        public string Ngaylocal(string s)
        {
            try
            {
                string s1 = s.Substring(0, 10), s2 = "";
                if (s.Length > 16) s = s.Substring(0, 16);
                if (s.Length == 16) s2 = s.Substring(10, 6);
                return StringToDate(s1).ToLocalTime().ToShortDateString() + s2;
            }
            catch { return ""; };
        }

        public Int64 songay(DateTime d1, DateTime d2, int congthem)
        {
            try
            {
                return Convert.ToInt64(d1.ToOADate() - d2.ToOADate() + congthem);
            }
            catch { return 0; }
        }
        public decimal songaygiuong(DateTime d1, DateTime d2, int congthem, int idgiuong)
        {
            double ret = 0;
            string usr = user;
            //vao sang - ra chieu:  --> tinh la 1 ngay (sang la truoc cho den 12h)
            //vao sang ra sang: -> tinh 0.5 ngay
            //vao chieu - ra chieu : 0.5 ngay
            //vao chieu - ra sang : 0 ngay 
            int d_giovao = d2.Hour, d_ngayvao = d2.Day, d_thangvao = d2.Month;
            int d_giora = d1.Hour, d_ngayra = d1.Day, d_thangra = d1.Month;
            int p = 0;
            try
            {
                double so = d1.ToOADate() - d2.ToOADate();

                if (bNgaygiuong_tinhtheo_sangchieu && congthem != 0)
                {
                    sql = "select a.* from " + usr + ".dmgiuong a," + usr + ".dmphong b where a.idphong=b.id and b.dichvu=1 and a.id=" + idgiuong;
                    if (get_data(sql).Tables[0].Rows.Count > 0)
                    {
                        string s = so.ToString();
                        TimeSpan day = d1 - d2;
                        ret = day.Days + (day.Hours > 9 ? (day.Hours * 0.01) : (day.Hours * 0.1));
                        //if ((d1.Year == d2.Year) && (d1.Month == d2.Month))
                        //{
                        //    ret = d_ngayra - d_ngayvao;
                        //}
                        //else
                        //{
                        //    ret = int.Parse(Math.Floor(decimal.Parse(so.ToString())).ToString());
                        //}
                        //ret += d_ngayra - d_ngayvao;// s.IndexOf(".");
                        p = s.IndexOf(".");
                        if (p != -1)
                        {
                            //ret = double.Parse(s.Substring(0, p));//so ngay
                            //string c = "0." + s.Substring(p + 1);
                            if (d_ngayra - d_ngayvao >= 1 && day.Hours > 12 && d_thangvao == d_thangra)//gam 07/02/2012
                            {
                                ret = (ret - (ret % 1)) + 1;
                            }
                            if (ret <= 1 && so < 0.5) ret = 0.5;
                            else if (day.Hours > 12 && d_ngayra - d_ngayvao < 1)
                            {
                                ret = (ret - (ret % 1)) + 1;
                            }
                            else if (d_giovao <= 12 && d_giora > 12) ret = (ret - (ret % 1)) + 1;
                            else if (d_giovao <= 12 && d_giora <= 12) ret = (ret - (ret % 1)) + 0.5;
                            else if (d_giovao > 12 && d_giora > 12) ret = (ret - (ret % 1)) + 0.5;
                            else if (ret == 0) ret = 0.5;
                            else ret = (ret - (ret % 1));// ((double.Parse(c) < 0.5) ? 0.5 : 1.0);
                        }

                    }
                }
                else if (bNgaygiuong_tinhtheo_sangchieu && congthem == 0)
                {
                    sql = "select a.* from " + usr + ".dmgiuong a," + usr + ".dmphong b where a.idphong=b.id and b.dichvu=1 and a.id=" + idgiuong;
                    if (get_data(sql).Tables[0].Rows.Count > 0)
                    {
                        string s = so.ToString();
                        ret = d_ngayra - d_ngayvao;//int p = s.IndexOf(".");  
                        p = s.IndexOf(".");
                        if (p != -1)
                        {
                            //ret = double.Parse(s.Substring(0, p));//so ngay
                            //string c = "0." + s.Substring(p + 1);
                            if (d_giovao <= 12 && d_giora > 12) ret += 0.5;
                            else ret += 0;// ((double.Parse(c) < 0.5) ? 0.5 : 1.0);
                        }
                        else ret += 0.5;
                    }
                }
                else if (congthem != 0)
                {
                    sql = "select a.* from " + usr + ".dmgiuong a," + usr + ".dmphong b where a.idphong=b.id and b.dichvu=1 and a.id=" + idgiuong;
                    if (get_data(sql).Tables[0].Rows.Count > 0)
                    {
                        string s = so.ToString();
                        p = s.IndexOf(".");
                        if (p != -1)
                        {
                            ret = double.Parse(s.Substring(0, p));
                            string c = "0." + s.Substring(p + 1);
                            ret += ((double.Parse(c) < 0.5) ? 0.5 : 1.0);
                        }
                        else if (decimal.Parse(s) > 0) ret = so;
                        else ret = 0.5;
                    }
                    else
                    {
                        so = StringToDate(DateToString("dd/MM/yyyy", d1)).ToOADate() - StringToDate(DateToString("dd/MM/yyyy", d2)).ToOADate();
                        ret = Math.Max(1, Math.Floor(so));//+congthem;
                    }
                }
                else
                {
                    so = StringToDate(DateToString("dd/MM/yyyy", d1)).ToOADate() - StringToDate(DateToString("dd/MM/yyyy", d2)).ToOADate();
                    ret = Math.Floor(so) + congthem;
                }
            }
            catch { ret = 0; }
            return Convert.ToDecimal(ret);
        }



        public System.DateTime StringToDate(string s)
        {
            s = (s == "" || s == null) ? ngayhienhanh_server.Substring(0, 10) : s;
            string[] format ={ "dd/MM/yyyy" };
            return System.DateTime.ParseExact(s.Substring(0, 10), format, System.Globalization.DateTimeFormatInfo.CurrentInfo, System.Globalization.DateTimeStyles.None);
        }

        public string StringToMMDDYYYY(string s)
        {
            return s.Substring(3, 2) + "/" + s.Substring(0, 2) + "/" + s.Substring(6, 4);
        }

        public string StringToDDMMYYYY(string s)
        {
            return s.Substring(0, 2) + s.Substring(3, 2) + s.Substring(6, 4);
        }

        public System.DateTime StringToDateTime(string s)
        {
            if (s.Length >= 16) s = s.Substring(0, 16);
            else if (s.Length > 10) s = s.Substring(0, 10);
            string[] format1 ={ "dd/MM/yyyy" }, format2 ={ "dd/MM/yyyy HH:mm" };
            return System.DateTime.ParseExact(s.ToString(), (s.Length == 10) ? format1 : format2, System.Globalization.DateTimeFormatInfo.CurrentInfo, System.Globalization.DateTimeStyles.None);
        }

        public System.DateTime StringToDateTime(string s, string f)
        {
            string[] format ={ f };
            return System.DateTime.ParseExact(s.ToString(), format, System.Globalization.DateTimeFormatInfo.CurrentInfo, System.Globalization.DateTimeStyles.None);
        }

        public string DateToString(string format, System.DateTime date)
        {
            if (date.Equals(null)) return "";
            else return date.ToString(format, System.Globalization.DateTimeFormatInfo.CurrentInfo);
        }

        public bool ngay(DateTime d1, DateTime d2, int so)
        {
            return (Math.Abs(songay(d1, StringToDate(d2.Day.ToString().PadLeft(2, '0') + "/" + d2.Month.ToString().PadLeft(2, '0') + "/" + d2.Year.ToString()), 0)) <= so);
        }

        public string Ngaysanhdudoan(string ngaykinhcc)
        {
            string yyyy = ngaykinhcc.Substring(6, 4), mmyy = ngaykinhcc.Substring(3, 2) + ngaykinhcc.Substring(8, 2);
            int dd = int.Parse(ngaykinhcc.Substring(0, 2));
            for (int i = 0; i < 3; i++) mmyy = Mmyy_truoc(mmyy);
            string s30 = "04+06+09+11+";
            if (mmyy.Substring(0, 2) == "02" && dd > 28)
            {
                if (int.Parse(yyyy) % 4 == 0) dd = Math.Min(dd, 29);
                else dd = Math.Min(dd, 28);
            }
            else if (s30.IndexOf(mmyy.Substring(0, 2) + "+") != -1) dd = Math.Min(dd, 30);
            return DateToString("dd/MM/yyyy", StringToDate(dd.ToString().PadLeft(2, '0') + "/" + mmyy.Substring(0, 2) + "/" + Convert.ToString(int.Parse("20" + mmyy.Substring(2, 2)) + 1).PadLeft(4, '0')).AddDays(7));
        }

        public string Mmyy_truoc(string d_mmyy)
        {
            int t_mm, t_yy;
            string mm = d_mmyy.Substring(0, 2), yy = d_mmyy.Substring(2, 2);
            if (mm == "01")
            {
                t_mm = 12; t_yy = int.Parse(yy) - 1;
            }
            else
            {
                t_mm = int.Parse(mm) - 1; t_yy = int.Parse(yy);
            }
            return t_mm.ToString().PadLeft(2, '0') + t_yy.ToString().PadLeft(2, '0');
        }

        public string Mmyy_sau(string d_mmyy)
        {
            int t_mm, t_yy;
            string mm = d_mmyy.Substring(0, 2), yy = d_mmyy.Substring(2, 2);
            if (mm == "12")
            {
                t_mm = 01; t_yy = int.Parse(yy) + 1;
            }
            else
            {
                t_mm = int.Parse(mm) + 1; t_yy = int.Parse(yy);
            }
            return t_mm.ToString().PadLeft(2, '0') + t_yy.ToString().PadLeft(2, '0');
        }

        public string getBackup
        {
            get
            {
                XmlDocument doc = new XmlDocument();
                string strpath = "..//..//..//xml//maincode.xml";
                doc.Load(strpath);
                XmlNodeList nodeLst = doc.GetElementsByTagName("BK");
                return nodeLst.Item(0).InnerText;
            }
        }

        public int Ngaylv_Ngayht
        {
            get
            {
                return int.Parse(Thongso("c14"));
            }
        }

        public string get_s_mmyy(DateTime tu, DateTime den)
        {
            int y1 = tu.Year, m1 = tu.Month;
            int y2 = den.Year, m2 = den.Month;
            string ss_mmyy = m1.ToString().PadLeft(2, '0') + y1.ToString().Substring(2, 2);
            int mt = m1, yt = y1;
            while (int.Parse(yt.ToString().Substring(2, 2) + mt.ToString().PadLeft(2, '0')) < int.Parse(y2.ToString().Substring(2, 2) + m2.ToString().PadLeft(2, '0')))
            {
                tu = tu.AddMonths(1);
                yt = tu.Year;
                mt = tu.Month;
                ss_mmyy += "," + mt.ToString().PadLeft(2, '0') + yt.ToString().Substring(2, 2);
            }
            return ss_mmyy;
        }

        public int iTreem6
        {
            get
            {
                try
                {
                    return int.Parse(get_data("select ten from " + user + ".thongso where id=42").Tables[0].Rows[0][0].ToString());
                }
                catch { return 6; }
            }
        }

        public int iTreem15
        {
            get
            {
                try
                {
                    return int.Parse(get_data("select ten from " + user + ".thongso where id=43").Tables[0].Rows[0][0].ToString());
                }
                catch { return 15; }
            }
        }

        public bool bSovaovien
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=15");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bSovaovien_pl
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=243");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bCachdung
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=244");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bChuyenkham_chandoan
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=245");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bHaophi_thanhtoan
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=246");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bGiuong
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=247");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bHinh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=248");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bChupHinhCT
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1077");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bChenhlech_laygiaphuthu
        {
            //G27.1
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1088");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bH19_CLS_Phanbiettronggio_ngoaigio
        {
            //H19
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1078");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bH20_CLS_kiemtraxungdot
        {
            //H20
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1079");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bE27_Quanly_bnTrungcao
        {
            //E27
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1080");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bH21_Chidinh_kem_hoichan
        {
            //H21
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1081");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bH22_Chidinh_kem_Camdoan
        {
            //H22
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1082");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bH23_Chidinh_xamlan_kem_hsba_ngoaitru
        {
            //H23
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1083");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bH24_Chidinh_keodai_kem_hsba_ngoaitru
        {
            //H24
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1084");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bThuphi_kham
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=249");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bChuyenkham_dscho
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=250");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bChuyenkham_tinhcongkham
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=434");//g60.1
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bTraituyen_bhtra
        {
            get
            {
                try
                {
                    return get_data("select ten from " + user + ".thongso where id=438").Tables[0].Rows[0]["ten"].ToString() == "1";
                }
                catch
                {
                    return false;
                }
            }
        }

        public bool bSophieu_chidinh
        {
            get
            {
                try
                {
                    return get_data("select ten from " + user + ".thongso where id=439").Tables[0].Rows[0]["ten"].ToString() == "1";
                }
                catch
                {
                    return false;
                }
            }
        }
        public bool bPhongluu_chidinh_chonngay
        {
            get
            {
                try
                {
                    return get_data("select ten from " + user + ".thongso where id=440").Tables[0].Rows[0]["ten"].ToString() == "1";
                }
                catch
                {
                    return false;
                }
            }
        }
        public bool bPhongkham_bangdien_hanoi
        {
            get
            {
                try
                {
                    return get_data("select ten from " + user + ".thongso where id=441").Tables[0].Rows[0]["ten"].ToString() == "1";
                }
                catch
                {
                    return false;
                }
            }
        }

        public string mathecu_95
        {
            get
            {
                try
                {
                    ds = get_data("select ten from " + user + ".thongso where id=442");
                    if (ds.Tables[0].Rows.Count == 0) return "GL+JL+HN+HL";
                    else return ds.Tables[0].Rows[0]["ten"].ToString();
                }
                catch
                {
                    return "GL+JL+HN+HL";
                }
            }
        }

        public bool bTinnhan_chidinh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=251");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bTinnhan_chidinh_sound
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=336");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bChidinh_ngtru_vienphi
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=337");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bChidinh_noitru_vienphi
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=338");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public int delay_tinnhan
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=339");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 1000; }
            }
        }

        public bool bAutoupdate
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=340");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public string Path_medisoft
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=341");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return ""; }
            }
        }

        public bool bNgoaitonkho
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=342");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bSmartcard
        {
            get
            {
                try
                {
                    return Thongso("smartcard") == "1";
                }
                catch { return false; }
            }
        }

        public bool bTiensu
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=344");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }

        public bool bSothe_dmbhyt
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=345");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bXutri_khambenh_pl
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=346");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }


        public decimal muc_bhquidinh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=348");
                    return decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 7000000; }
            }
        }

        public string huong_100
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=349");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return ""; }
            }
        }

        public string huong_100_khongqua
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=350");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return ""; }
            }
        }

        public decimal muc_khongqua
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=351");
                    return decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 20000000; }
            }
        }

        public bool bGia_bh_quydinh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=347");
                    return ds.Tables[0].Rows[0][0].ToString() == "1";
                }
                catch { return false; }
            }
        }

        public int phantram_bhyt
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=352");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 60; }
            }
        }

        public bool bSothe_ngay_huong
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=353");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bBacsi_khambenh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=354");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bPhieulinh_chanle
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=355");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public string Kho_ngaychan
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=356");
                    return ds.Tables[0].Rows[0][0].ToString().Trim();
                }
                catch { return ""; }
            }
        }

        public string Kho_ngayle
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=358");
                    return ds.Tables[0].Rows[0][0].ToString().Trim();
                }
                catch { return ""; }
            }
        }

        public bool bChenhlech_thuoc
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=359");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }

        public bool bGia_bh_quydinh_giamua
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=360");
                    return ds.Tables[0].Rows[0][0].ToString() == "1";
                }
                catch { return false; }
            }
        }

        public bool bTiepdon_nkp_inchungchiphi
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=361");
                    return ds.Tables[0].Rows[0][0].ToString() == "1";
                }
                catch { return false; }
            }
        }

        public bool bSothe_dkkcb
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=362");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bDuyet_donve
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=363");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public int iUserid_donve
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=364");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 0; }
            }
        }

        public decimal Bhyt_7cn
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=365");
                    return decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 0; }
            }
        }

        public int mien_chenhlech
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=366");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 0; }
            }
        }

        public string mien_chenhlech_cholam
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=367");
                    return ds.Tables[0].Rows[0][0].ToString().Trim();
                }
                catch { return ""; }
            }
        }

        public int mien_chenhlech_doituong
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=368");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 0; }
            }
        }

        public bool bTiepdon_n_makp_chung_chiphi
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=369");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bBhyt_mien_trasau_ck_chidinh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=370");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bHaophi_thanhtoan_doituongvao
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=371");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public string sHaophi_thanhtoan
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=372");
                    return " " + ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return " trong phẫu thuật - thủ thuật"; }
            }
        }

        public bool bTtptttkhoa
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=373");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bPhatthuoc_kho_khoa
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=374");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public int iPhatthuoc_kho_khoa
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=375");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 0; }
            }
        }

        public string sPhatthuoc_kho_khoa
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=376");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return ""; }
            }
        }

        public bool bGiuong_khoa
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=377");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bMien_congkham_cholam
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=378");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public int iPhatthuoc_kho_khoa2
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=379");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 0; }
            }
        }

        public bool bChenhlech_doituongvao
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=380");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bChidinh_thutienlien
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=381");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bChiphikp_noingoai
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=382");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bPttt_tsoduoc
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=383");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }

        public bool bChenhlech_thuoc_dannhmuc
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=384");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }


        public bool bLocdichvu_doituong
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=385");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }

        public bool bLocThuocCaptoa_doituong
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1020");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }

        public bool bLocThuocDutru_doituong
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1021");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }
        public bool bTonghopbienlaitamung_chuahoan
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1022");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bSuadt_auto_dichvu
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1023");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        //
        public bool bChiphikp_noingoai_khongbhyt
        {
            //0: Chuyen chi phi phong chua dong tien vao noi tru
            //1: Chi chuyen chi phi cua bn doi tuong bhyt, mien, cac doit tuong bn chi tra khong chuyen vao
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1024");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bChidinh_dain_khongchohuy
        {
            //0: Chuyen chi phi phong chua dong tien vao noi tru
            //1: Chi chuyen chi phi cua bn doi tuong bhyt, mien, cac doit tuong bn chi tra khong chuyen vao
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1025");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bPhongkham_khongduocxutri_chuyenvien
        {
            //true: khong cho chuyen
            //false: Cho phep xu tri chuyen vien
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1026");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bSovaovien_ngoaitru_tang_chungNoitru
        {
            //true: Tang tu dong chung voi so vao vien noi tru
            //false: khong tang tu dong, tu go
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1027");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bSovaovien_ngoaitru_tang_rieng
        {
            //true: Tang tu dong chung voi so vao vien noi tru
            //false: khong tang tu dong, tu go
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1028");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bSochuyenvien_tudong
        {
            //D22
            //true: Tang tu dong 
            //false: khong tang tu dong, tu go
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1029");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }
        public bool bPhongluu_nhapchuyenvien_truockhiin
        {
            //D22
            //true: Tang tu dong 
            //false: khong tang tu dong, tu go
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1031");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bNhapPTTT_chidinh_vpkhoa_miengiam
        {
            //I08
            //true: cho nhap mien giam 
            //false: khong cho nhap mien giam, nhap nhu cu
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1032");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bNhapPTTT_chenhlech_miengiamtheo_I08
        {
            //I09
            //true: phan chenh mien giam theo
            //false: khong cho nhap mien giam, nhap nhu cu
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1033");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        //Thuy 11.06.2012
        public bool bNhapPTTTNgoaiTru_I10
        {
            //I10
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1504");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        //Thuy 17.12.2012
        public bool bKhongsuachandoantrongingiaychuyenvien_I11
        {
            //I11
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1506");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bChuyenkham_tinh_congkham_dtthuphi
        {
            //G78
            //true: Khi bn thuoc doituong BHYT, mien khi chuyen kham tinh cong kham, cong kham nay BN tra hoan toan, khong tinh chenh lech BHYT
            //false: khong cho nhap mien giam, nhap nhu cu
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1034");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bRaphongluu_khongchochidinh
        {
            //H15
            //true: BN khi nhap ngay ra phong luu se khong duoc phep chi dinh them
            //false: Trong ngay thi cho phep chi them cls
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1035");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bBH_chitra_1congkham
        {
            //G79
            //true: BHYT chi tra 1 cong kham, cac cong kham can lai BN tu tra
            //false: BHYT tra tat
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1036");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bThuphi_dichvubhytduoi_100
        {
            //G80
            //true: dich vu, vat tu, thuoc: bhyt chi tra duoi 100%, thi phan con lai tinh vao doi tuong thu phi
            //false: Thi tinh vao doi tuong tu nguyen
            //vi du: Mau: BHYT chi tra 200.000 cho 1 don vi mau, gia hoa don vao la 250.000 nen phan con lai phai thu cua BN la 50.000: tich vao doi tuong thu phi, neu tinh vao doi tuong dich vu thi bv phai dong thue

            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1037");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bKhactinh_macdinh_la_traituyen
        {
            //E20(BV Binh an)            

            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1038");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bChuyenkham_pkthu2_giataikham
        {
            //E20(BV Binh an)            

            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1039");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bChidinh_lietke_kemgia
        {
            //H16(BV Binh an)            

            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1040");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }

        public bool bInmau38_daydu
        {
            //G82       

            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1041");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bChuathanhtoan_khongcho_dangkykham
        {
            //G83   

            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1042");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bChuathanhtoan_khongcho_nhanbenh
        {
            //G84   

            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1043");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bChuathanhtoan_khongcho_ingiayravien
        {
            //G85   

            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1044");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bLaygiamua_khi_giabh_0_giabh_nho_giamua
        {
            //E22
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1045");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }

        public bool bVantay_batbuot
        {
            //D07.1
            //true : bat buot phai lay van tay
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1047");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bBHYT_Traituyen_tinh_Tyle_khac
        {
            //E23
            //true lay trong v_giavp.bhyt_tt
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1046");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bBNraphongluu_Khongxuattutruc
        {
            //F33
            //true : bat buot phai lay van tay
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1048");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bDainmau38_khongcho_chidinh_cls
        {
            //H16
            //true : bat buot phai lay van tay
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1049");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bPhatQuaKhiXuatKhoa// gam 11042012
        {
            //C71
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1104");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        //Thuy 11.10.2012
        public bool bChiPhiVuotTamUngKoChoChiDinh
        {
            //C72
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1105");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bChenhlechPK_chitinh_vaongaynghi
        {
            //G86
            //true :
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1050");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bLoadQuanhe_lantruoc
        {
            //C65
            //true :
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1051");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public int iKhoangcachngaycaptoa_voingaykham
        {
            //F32
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1030");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 0; }
            }
        }
        public bool bBogo
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=386");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bTrongoi_doituong
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=387");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bDuyetcls
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=388");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public int iPhatthuoc_k_tua
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=389");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 0; }
            }
        }

        public string sPhatthuoc_k_tua
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=390");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return ""; }
            }
        }

        public bool bChidinh_loaivp
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=391");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bPhongluu_chuyenkham_kcong
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=392");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bNgoaitru_k_khambenh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=393");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bKhoasau_hoantra_F28
        {
            //F28
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=394");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bChenhlech_tructiep
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=395");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public decimal mavp_kem_chidinh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=396");
                    return decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 0; }
            }
        }

        public string makp_kem_chidinh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=397");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return ""; }
            }
        }

        public bool bPhongluu_bhyt_khambenh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=398");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }

        public bool bNgoaitru_bhyt_khambenh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=399");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }

        public bool bNoitru_bhyt_khambenh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=443");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bKhoa_duyet
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=400");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public string makho_auto_duyet
        {
            get
            {
                try
                {
                    ds = get_data("select ten from " + user + ".thongso where id=401");
                    if (ds.Tables[0].Rows.Count == 0) return "";
                    return ds.Tables[0].Rows[0][0].ToString().Trim();
                }
                catch { return ""; }
            }
        }

        public int iUserid_duyet_dutru
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=402");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 0; }
            }
        }

        public bool bChuyenkham_thuphi
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=403");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bXutri_hen_koin
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=404");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bBamhuyet
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=405");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bNgoaitru_bacsy
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=406");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bTtravien_giagoc
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=407");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public string sTrieuchung
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=408");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return "Triệu chứng lâm sàng :"; }
            }
        }

        public bool bKhoa_suadoituong
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=409");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bNhapvien_kocongkham
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=410");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }


        public string sNhapvien_kocongkham_madoituong
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=411");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return ""; }
            }
        }

        public bool bTaikham_v_chidinh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=412");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bDutru_n_thuoc
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=413");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bKhoan_vtth
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=414");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public string sKhoan_madoituong
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=415");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return ""; }
            }
        }

        public string sKhoan_nhomvp
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=416");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return ""; }
            }
        }

        public int iKhoan_mavp
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=417");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 0; }
            }
        }

        public int iKhoan_mavp_pttt
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=418");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 0; }
            }
        }

        public bool bTaikham_chiphi_inrieng
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=419");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bDonngoaitru_auto
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=420");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        //Thuy 24.02.2012
        public bool bDonngoaitru_auto_chiapdungBNBHYT
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1503");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bThanhtoan_ngia
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=421");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bHiendanhsach_vuotngoaitru
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=422");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public int iBhyt_songay
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=423");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 0; }
            }
        }

        public int iBenhanngtr_taikham
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=424");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 0; }
            }
        }

        public bool bPhongkham_chandoan
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=425");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bTraituyen
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=426");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        /// <summary>
        /// Option E34 chỉ cho phép BNBHYT khám bệnh BHYT 1 lần trong ngày 
        /// </summary>
        public bool bnKhamBHYTmotlantrongngay
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=50034");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }


        public decimal lTraituyen_phongkham
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=427");
                    return decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 30000; }
            }
        }

        public decimal lTraituyen_noitru
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=428");
                    return decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 550000; }
            }
        }

        public decimal Tamung_min
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=429");
                    return decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 0; }
            }
        }

        public bool bPhongkham_hanhchanh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=430");//426
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public int iTraituyen_bhyt
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=431");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 0; }
            }
        }

        public bool bKhamchuyen_chidinh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=432");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bSoluutru_ngtru_nam
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=433");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public int iMavp_congkham(int d_nhom)
        {
            ds = get_data("select ten from " + user + ".d_thongso where id=127 and nhom=" + d_nhom);
            if (ds.Tables[0].Rows.Count == 0) return 0;
            return (ds.Tables[0].Rows[0][0].ToString().Trim() == "") ? 0 : int.Parse(ds.Tables[0].Rows[0][0].ToString().Trim());
        }

        public bool bDausinhton_khambenh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=252");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bThuthuat_chidinh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=253");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public string iNhomvp_thuthuat
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=254");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return ""; }
            }
        }

        public bool bAcc_Ora
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=37");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bSoluutru
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=16");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        //linh
        public bool bBangdienPhongkham
        {
            get
            {
                try
                {
                    return get_data("select ten from " + user + ".thongso where id=435").Tables[0].Rows[0]["ten"].ToString() == "1";
                }
                catch
                {
                    return false;
                }
            }
        }
        //end lin h
        public bool bChandoan
        {
            get
            {
                return int.Parse(Thongso("c17")) == 1;
            }
        }

        public bool bPttt
        {
            get
            {
                return int.Parse(Thongso("c18")) == 1;
            }
        }

        public bool bNetwork
        {
            get
            {
                DataSet ds = get_data("select ten from " + user + ".thongso where id=19");
                return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
            }
        }

        public string Ngaygio_hienhanh
        {
            get { return ngayhienhanh_server; }//DateTime.Now.Day.ToString().PadLeft(2,'0')+"/"+DateTime.Now.Month.ToString().PadLeft(2,'0')+"/"+DateTime.Now.Year.ToString()+" "+DateTime.Now.Hour.ToString().PadLeft(2,'0')+":"+DateTime.Now.Minute.ToString().PadLeft(2,'0');}
        }

        public string Ngaygio
        {
            get
            {
                if (int.Parse(Thongso("c21")) == 0) return "";
                else return ngayhienhanh_server;// DateTime.Now.Day.ToString().PadLeft(2, '0') + "/" + DateTime.Now.Month.ToString().PadLeft(2, '0') + "/" + DateTime.Now.Year.ToString() + " " + DateTime.Now.Hour.ToString().PadLeft(2, '0') + ":" + DateTime.Now.Minute.ToString().PadLeft(2, '0');
            }
        }

        public bool bSolieu
        {
            get
            {
                return int.Parse(Thongso("c22")) == 1;
            }
        }

        public bool bKhambenh
        {
            get
            {
                return int.Parse(Thongso("c23")) == 1;
            }
        }

        public bool bNoichuyen
        {
            get
            {
                return int.Parse(Thongso("c25")) == 1;
            }
        }

        public bool bsKhambenh
        {
            get
            {
                return int.Parse(Thongso("c26")) == 1;
            }
        }

        public bool bsNgoaitru
        {
            get
            {
                return int.Parse(Thongso("c27")) == 1;
            }
        }

        public bool bsNhanbenh
        {
            get
            {
                return int.Parse(Thongso("c28")) == 1;
            }
        }

        public bool bsNhapkhoa
        {
            get
            {
                return int.Parse(Thongso("c29")) == 1;
            }
        }

        public bool bsXuatkhoa
        {
            get
            {
                return int.Parse(Thongso("c30")) == 1;
            }
        }

        public bool bsXuatvien
        {
            get
            {
                return int.Parse(Thongso("c31")) == 1;
            }
        }

        public bool bsPttt
        {
            get
            {
                return int.Parse(Thongso("c32")) == 1;
            }
        }

        public bool bSaoluu
        {
            get
            {
                try
                {
                    return int.Parse(Thongso("c33")) == 1;
                }
                catch { return false; }
            }
        }

        public bool bListicd
        {
            get
            {
                try
                {
                    return int.Parse(Thongso("c34")) == 1;
                }
                catch { return false; }
            }
        }

        public bool bListpttt
        {
            get
            {
                try
                {
                    return int.Parse(Thongso("c35")) == 1;
                }
                catch { return false; }
            }
        }

        public bool bThongtinnhapvien
        {
            get
            {
                try
                {
                    return int.Parse(Thongso("c36")) == 1;
                }
                catch { return false; }
            }
        }

        public bool bBenhkhac
        {
            get
            {
                try
                {
                    return int.Parse(Thongso("c38")) == 1;
                }
                catch { return false; }
            }
        }

        public string Giamdoc
        {
            get { return Thongso("c39"); }
        }

        public string TpKHTH
        {
            get { return Thongso("c40"); }
        }

        public string Thongke
        {
            get { return Thongso("c41"); }
        }

        public bool bHoten_gioitinh
        {
            get
            {
                try
                {
                    return int.Parse(Thongso("c44")) == 1;
                }
                catch { return false; }
            }
        }

        public bool bPreview { get { try { return int.Parse(Thongso("c45")) == 1; } catch { return false; } } }
        public bool bDongy { get { try { return int.Parse(Thongso("dongy")) == 1; } catch { return false; } } }//gam 04/11/2011
        public bool bIn_khambenh { get { try { return int.Parse(Thongso("c46")) == 1; } catch { return false; } } }
        public bool bDanhsach_cho
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=47");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch
                {
                    return false;
                }
            }
        }
        public bool bMavach { get { try { return int.Parse(Thongso("c51")) == 1; } catch { return false; } } }
        public bool bPhieudieutri { get { try { return int.Parse(Thongso("c52")) == 1; } catch { return false; } } }
        public bool bSuagiakham { get { try { return int.Parse(Thongso("c53")) == 1; } catch { return false; } } }
        public bool bDausinhton { get { try { return int.Parse(Thongso("c55")) == 1; } catch { return false; } } }
        public int iSudungthuoc { get { try { return int.Parse(Thongso("c56")); } catch { return 3; } } }
        public int iSokham { get { try { return int.Parse(Thongso("c59")); } catch { return 3; } } }
        public int iChidinh { get { try { return int.Parse(Thongso("c60")); } catch { return 3; } } }
        public int iVienphi { get { try { return int.Parse(get_data("select ten from " + user + ".thongso where id=113").Tables[0].Rows[0]["ten"].ToString()); } catch { return 3; } } }
        public bool bDangky_mau1 { get { try { return int.Parse(Thongso("c195")) == 1; } catch { return false; } } }
        public int iUservp { get { try { return int.Parse(Thongso("c196")); } catch { return 0; } } }
        public bool blSovaovien(int m_loaiba, string m_sovaovien, decimal m_maql)
        {
            return get_data("select sovaovien from " + user + ".benhandt where maql<>" + m_maql + " and loaiba=" + m_loaiba + " and sovaovien='" + m_sovaovien + "'").Tables[0].Rows.Count > 0;
        }

        public bool blSoluutru(string m_soluutru)
        {
            return get_data("select soluutru from " + user + ".xuatvien where soluutru='" + m_soluutru + "'").Tables[0].Rows.Count != 0;
        }

        public bool blSoluutru(string m_soluutru, decimal m_maql, string table)
        {
            if (!bSoluutru_kotrung) return false;
            else return get_data("select soluutru from " + user + "." + table + " where maql<>" + m_maql + " and soluutru='" + m_soluutru + "'").Tables[0].Rows.Count > 0;
        }

        public bool bRavien(decimal maql)
        {
            return get_data("select maql from " + user + ".xuatvien where maql=" + maql).Tables[0].Rows.Count > 0;
        }

        public string Matuyen(string mabv)
        {
            try
            {
                return get_data("select matuyen from " + user + ".tenvien where mabv='" + mabv + "'").Tables[0].Rows[0][0].ToString();
            }
            catch { return ""; };
        }

        public string bHiendien(decimal m_maql)
        {
            try
            {
                return get_data("select trim(b.tenkp)||' '||to_char(a.ngay,'dd/mm/yyyy hh24:mi') as ngay from " + user + ".hiendien a," + user + ".btdkp_bv b where a.makp=b.makp and a.nhapkhoa=1 and a.xuatkhoa=0 and a.maql=" + m_maql).Tables[0].Rows[0][0].ToString();
            }
            catch { return ""; }
        }

        public string bHiendien(string m_mabn, int m_loaiba)
        {
            try
            {
                string file1 = (m_loaiba == 2) ? "hiendienngtr" : "hiendien", file2 = (m_loaiba == 2) ? "benhanngtr" : "benhandt";
                if (m_loaiba == 2)
                {
                    sql = "select trim(b.tenkp)||' '||to_char(a.ngay,'dd/mm/yyyy hh24:mi') as ngay from " + user + "." + file2 + " a," + user + ".btdkp_bv b ";
                    sql += " where a.makp=b.makp and a.ngayrv is null and a.mabn='" + m_mabn + "'";
                }
                else
                {
                    sql = "select trim(b.tenkp)||' '||to_char(a.ngay,'dd/mm/yyyy hh24:mi') as ngay from " + user + "." + file1 + " a," + user + ".btdkp_bv b," + user + "." + file2 + " c ";
                    sql += " where a.makp=b.makp and a.maql=c.maql ";
                    sql += " and a.nhapkhoa=1 and a.xuatkhoa=0 ";
                    sql += " and a.mabn='" + m_mabn + "'";
                    if (m_loaiba == 1) sql += " and c.loaiba=" + m_loaiba;
                }
                return get_data(sql).Tables[0].Rows[0][0].ToString();
            }
            catch { return ""; }
        }

        public string bNhapvien(string m_mabn, int loaiba)
        {
            try
            {
                string tenfile = "benhandt";
                return get_data("select trim(b.tenkp)||' '||to_char(a.ngay,'dd/mm/yyyy hh24:mi') as ngay from " + user + "." + tenfile + " a," + user + ".btdkp_bv b where a.makp=b.makp and tuchoi=0 and a.maql not in (select maql from " + user + ".xuatvien) and a.mabn='" + m_mabn + "'" + " and a.loaiba=" + loaiba).Tables[0].Rows[0][0].ToString();
            }
            catch { return ""; }
        }

        public string bHiendien_benhanngtr(string m_mabn)
        {
            try
            {
                return get_data("select trim(b.tenkp)||' '||to_char(a.ngay,'dd/mm/yyyy hh24:mi') as ngay from " + user + ".benhanngtr a," + user + ".btdkp_bv b where a.makp=b.makp and a.ngayrv is null and a.mabn='" + m_mabn + "'").Tables[0].Rows[0][0].ToString();
            }
            catch { return ""; }
        }

        public string bHiendien_benhancc(string m_ngay, string m_mabn)
        {
            try
            {
                sql = "select trim(b.tenkp)||' '||to_char(a.ngay,'dd/mm/yyyy hh24:mi') as ngay from xxx.benhancc a," + user + ".btdkp_bv b where a.makp=b.makp and a.ngayrv is null and a.mabn='" + m_mabn + "'";
                return get_data_mmyy(sql, DateToString("dd/MM/yyyy", StringToDate(m_ngay.Substring(0, 10)).AddYears(-1)), m_ngay.Substring(0, 10), false).Tables[0].Rows[0][0].ToString();
            }
            catch { return ""; }
        }

        public bool bKhaibaobandau
        {
            get
            {
                try
                {
                    return get_data("select * from " + user + ".dmcomputer").Tables[0].Rows.Count != 0;
                }
                catch { return false; }
            }
        }

        public string Maqu
        {
            get
            {
                DataSet ds = get_data("select ten from " + user + ".thongso where id=24");
                try
                {
                    return ds.Tables[0].Rows[0][0].ToString().Trim();
                }
                catch { return ""; }
            }
        }

        public DataSet Tqx(string s)
        {
            return get_data("select a.tentt||' - '||b.tenquan||' - '||c.tenpxa as TEN,c.MAPHUONGXA,c.VIETTAT from " + user + ".btdtt a," + user + ".btdquan b," + user + ".btdpxa c where a.matt=b.matt and b.maqu=c.maqu and upper(c.viettat) like '" + s.Trim().ToUpper() + "%' order by c.maphuongxa");
        }

        public string get_vviet(string maicd)
        {
            if (maicd == "") return "";
            try
            {
                return get_data("select vviet from " + user + ".icd10 where trim(cicd10)='" + maicd.Trim() + "'").Tables[0].Rows[0][0].ToString();
            }
            catch { return ""; }
        }

        public string get_tenpt(string mapt)
        {
            if (mapt == "") return "";
            try
            {
                DataTable dt = get_data("select loaipt,noi_dung from " + user + ".dmpttt where trim(mapt)='" + mapt.Trim() + "'").Tables[0];
                return dt.Rows[0][0].ToString().Trim() + dt.Rows[0][1].ToString();
            }
            catch { return ""; }
        }

        public void import_xml_to_postgresql(string filexml)
        {
            try
            {
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                con.Open();
                DataSet lds = new DataSet();
                string strpath = "..//..//..//temp//" + filexml + ".xml";
                lds.ReadXml(strpath);
                string strfields = "", strpara = "";
                foreach (DataColumn icol in lds.Tables[0].Columns)
                {
                    strfields = ((strfields == "") ? "" : strfields + ",") + icol.ColumnName;
                    strpara = ((strpara == "") ? ":" : strpara + ",:") + icol.ColumnName;
                }
                foreach (DataRow r in lds.Tables[0].Rows)
                {
                    string strsql = "Insert Into " + filexml + " (" + strfields + ")" + " values (" + strpara + ")";
                    cmd = new NpgsqlCommand(strsql, con);
                    cmd.CommandType = CommandType.Text;
                    int i = 0;
                    foreach (DataColumn icol in lds.Tables[0].Columns)
                    {
                        if (icol.DataType == typeof(string))
                            cmd.Parameters.Add(icol.ColumnName, NpgsqlDbType.Text);
                        else
                            cmd.Parameters.Add(icol.ColumnName, NpgsqlDbType.Numeric);
                        cmd.Parameters[icol.ColumnName].Value = (r[i].ToString() == "") ? " " : r[i].ToString().Trim();
                        i += 1;
                    }
                    cmd.ExecuteNonQuery();
                    cmd.Cancel();
                    cmd.Dispose();
                }
                con.Close(); con.Dispose();
            }
            catch (Exception ex)
            {
                upd_error(ex.Message.ToString().Trim(), sComputer, filexml);
            }
        }

        public void upd_data(string m_tblname, int m_code, string m_loai)
        {
            try
            {
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                string sql = "Update " + user + "." + m_tblname + " set loai=:loai where code=:code";
                con = new NpgsqlConnection(sConn);
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                int irow = cmd.ExecuteNonQuery();
                cmd.Cancel();
                cmd.Dispose();
                if (irow > 0)
                {
                    sql = "Insert Into " + user + "." + m_tblname + " (code, loai) values(:code, :loai)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("code", m_code);
                    cmd.Parameters.Add("loai", m_loai);

                    cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
                con.Close(); con.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message.ToString().Trim(), sComputer, m_tblname);
            }
        }


        public void upd_data(string m_tblname, string m_code, string m_loai)
        {
            try
            {
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                string sql = "Update " + user + "." + m_tblname + " set loai=:loai where code=:code";
                con = new NpgsqlConnection(sConn);
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                int irow = cmd.ExecuteNonQuery();
                cmd.Cancel();
                cmd.Dispose();
                if (irow > 0)
                {
                    sql = "Insert Into " + user + "." + m_tblname + " (code, loai) values(:code, :loai)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("code", m_code);
                    cmd.Parameters.Add("loai", m_loai);

                    cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
                con.Close(); con.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message.ToString().Trim(), sComputer, m_tblname);
            }
        }

        public DataSet get_data(string sql)
        {
            //linh
            DataSet dstmp = new DataSet();
            try
            {
                //if (dstmp != null)
                //{
                //    dstmp.Dispose();
                //    dstmp = null;
                //}//end linh
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                dest = new NpgsqlDataAdapter(cmd);
                dest.Fill(dstmp);
                cmd.Dispose();
                con.Close();
                con.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_error(sql + "-" + ex.Message.ToString().Trim(), sComputer, "?");
                return null;
            }//linh
            if (dstmp.Tables.Count == 0)
            {
                dstmp = null;
            }
            //end linh
            return dstmp;
        }

        public DataSet get_data(string sql, bool bLuuerror)
        {
            try
            {
                if (ds != null)
                {
                    ds.Dispose();
                    ds = null;
                }
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                ds = new DataSet();
                con = new NpgsqlConnection(sConn);
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                dest = new NpgsqlDataAdapter(cmd);
                dest.Fill(ds);
                cmd.Dispose();
                con.Close();
                con.Dispose();
            }
            catch (NpgsqlException ex)
            {
                if (bLuuerror) upd_error(sql + "-" + ex.Message.ToString().Trim(), sComputer, "?");
            }
            return ds;
        }


        public string get_sql_mmyy(string str, string tu, string den, bool bKhoangcach)
        {
            DataSet tmp = new DataSet();
            DateTime dt1 = (bKhoangcach) ? StringToDate(tu).AddDays(-iNgaykiemke) : StringToDate(tu);
            DateTime dt2 = (bKhoangcach) ? StringToDate(den).AddDays(iNgaykiemke) : StringToDate(den);
            int y1 = dt1.Year, m1 = dt1.Month;
            int y2 = dt2.Year, m2 = dt2.Month;
            int itu, iden;
            string mmyy = "";
            string asql = "", asql1 = "";
            bool be = true;
            for (int i = y1; i <= y2; i++)
            {
                itu = (i == y1) ? m1 : 1;
                iden = (i == y2) ? m2 : 12;
                for (int j = itu; j <= iden; j++)
                {
                    mmyy = j.ToString().PadLeft(2, '0') + i.ToString().Substring(2, 2);
                    if (bMmyy(mmyy))
                    {
                        asql = str.Replace("xxx", user + mmyy);
                        asql = asql.Replace("medibvmmyy.", user + mmyy + ".");
                        asql = asql.Replace("medibv.", user + ".");
                        if (!be)
                        {
                            asql1 += " UNION ";// all ";
                            asql1 += asql;
                        }
                        else
                        {
                            be = false;
                            asql1 = asql;
                        }

                    }
                }
            }
            return asql1;
        }

        public string get_sql_mmyy(string str, string tu, string den, int iNgaykiemke)
        {
            DataSet tmp = new DataSet();
            DateTime dt1 = (iNgaykiemke != 0) ? StringToDate(tu).AddDays(-iNgaykiemke) : StringToDate(tu);
            DateTime dt2 = (iNgaykiemke != 0) ? StringToDate(den).AddDays(iNgaykiemke) : StringToDate(den);
            int y1 = dt1.Year, m1 = dt1.Month;
            int y2 = dt2.Year, m2 = dt2.Month;
            int itu, iden;
            string mmyy = "";
            string asql = "", asql1 = "";
            bool be = true;
            for (int i = y1; i <= y2; i++)
            {
                itu = (i == y1) ? m1 : 1;
                iden = (i == y2) ? m2 : 12;
                for (int j = itu; j <= iden; j++)
                {
                    mmyy = j.ToString().PadLeft(2, '0') + i.ToString().Substring(2, 2);
                    if (bMmyy(mmyy))
                    {
                        asql = str.Replace("xxx", user + mmyy);
                        asql = asql.Replace("medibvmmyy.", user + mmyy + ".");
                        asql = asql.Replace("medibv.", user + ".");
                        if (!be)
                        {
                            asql1 += " UNION ";// all ";
                            asql1 += asql;
                        }
                        else
                        {
                            be = false;
                            asql1 = asql;
                        }

                    }
                }
            }
            return asql1;
        }

        public bool execute_data(string sql)
        {
            
            sql = sql.Replace("medibv.", user + ".");
            try
            {
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
                con.Close(); con.Dispose();
                return true;
            }
            catch (NpgsqlException ex)
            {
                upd_error(sql + "; " + ex.Message.ToString().Trim(), sComputer, "?");
                return false;
            }
        }

        ///// <summary> Dong
        //public bool execute_data_client(string sql)
        //{
        //    try
        //    {
        //        if (con != null)
        //        {
        //            con.Close(); con.Dispose();
        //        }
        //        con = new NpgsqlConnection(sConn);
        //        con.Open();
        //        cmd = new NpgsqlCommand(sql, con);
        //        cmd.CommandType = CommandType.Text;
        //        cmd.ExecuteNonQuery();
        //        cmd.Dispose();
        //        con.Close(); con.Dispose();
        //        return true;
        //    }
        //    catch (NpgsqlException ex)
        //    {
        //        upd_error(sql + "; " + ex.Message.ToString().Trim(), sComputer, "?");
        //        return false;
        //    }
        //}
        /// </summary>
        /// <param name="sql"></param>
        /// <param name="bLuu_error"></param>
        /// <returns></returns> End Dong

        public bool execute_data(string sql, bool bLuu_error)
        {
            try
            {
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
                con.Close(); con.Dispose();
                return true;
            }
            catch (NpgsqlException ex)
            {
                if (bLuu_error) upd_error(ex.Message.ToString().Trim(), sComputer, "?");
                return false;
            }
        }


        public bool execute_data_noerror(string sql)
        {
            try
            {
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
                con.Close(); con.Dispose();
                return true;
            }
            catch
            {
                return false;
            }
        }

        public bool execute_data(string upd, string ins)
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(upd, con);
                cmd.CommandType = CommandType.Text;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    cmd = new NpgsqlCommand(ins, con);
                    cmd.CommandType = CommandType.Text;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "?");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public void delrec(DataTable dt, string exp)
        {
            try
            {
                DataRow[] r = dt.Select(exp);
                for (int i = 0; i < r.Length; i++) r[i].Delete();
            }
            catch { }
        }

        public DataRow getrowbyid(DataTable dt, string exp)
        {
            try
            {
                DataRow[] r = dt.Select(exp);
                return r[0];
            }
            catch (Exception ex) { return null; }
        }

        public void upd_error(string m_ngay, string m_message, string m_computer, string m_table)
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            if (!bMmyy(mmyy(m_ngay))) return;
            sql = "insert into " + user + mmyy(m_ngay) + ".error(message,computer,tables) values (:m_message,:m_computer,:m_table)";
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_message", NpgsqlDbType.Text).Value = m_message;
                cmd.Parameters.Add("m_computer", NpgsqlDbType.Varchar, 20).Value = m_computer;
                cmd.Parameters.Add("m_table", NpgsqlDbType.Varchar, 20).Value = m_table;
                cmd.ExecuteNonQuery();
            }
            catch { }
            finally
            {
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
        }

        public void upd_error(string m_message, string m_computer, string m_table)
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            string sql1 = "insert into " + user + ".error(message,computer,tables) values (:m_message,:m_computer,:m_table)";
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql1, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_message", NpgsqlDbType.Text).Value = m_message;
                cmd.Parameters.Add("m_computer", NpgsqlDbType.Varchar, 20).Value = m_computer;
                cmd.Parameters.Add("m_table", NpgsqlDbType.Varchar, 20).Value = m_table;
                cmd.ExecuteNonQuery();
            }
            catch { }
            finally
            {
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
        }
        public bool bCapSTT_Chidinh_Loaivp_H20
        {//H20
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1101");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bchuyenclsvathongtinbnsangcnkhac
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1505");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        //public void f_get_stt_cls_loaivp(string m_ngay, string m_mabn, string m_maql)
        //{
        //    //dtchidinh phai co 2 filed: id, mavp
        //    string s_user = user;
        //    string xxx = s_user + mmyy(m_ngay);
        //    string asql = "";
        //    int m_stt = 1;
        //    DataSet lds;

        //    asql = "select distinct case when c.id_nhom=1 then -1 else b.id_loai end as id_loai, max(a.stt) as sttcho from " + xxx + ".v_chidinh a inner join " + s_user + ".v_giavp b on a.mavp=b.id inner join " + s_user + ".v_loaivp c on b.id_loai=c.id inner join " + s_user + ".v_nhomvp d on c.id_nhom=d.ma ";
        //    asql += " where to_char(a.ngay,'dd/mm/yyyy')='" + m_ngay.Substring(0, 10) + "'";
        //    asql += " group by case when c.id_nhom =1 then -1 else b.id_loai end";
        //    lds = get_data(asql);
        //    if (lds.Tables.Count > 0 && lds.Tables[0].Rows.Count <= 0)
        //    {
        //        m_stt = 1;
        //        asql = "update " + xxx + ".v_chidinh set sttcho=" + m_stt + " where mabn='" + m_mabn + "' and maql=" + m_maql;
        //        execute_data(asql);
        //    }
        //    else
        //    {
        //        foreach (DataRow r in lds.Tables[0].Rows)
        //        {
        //            m_stt = int.Parse(r["sttcho"].ToString()) + 1;
        //            //Thuy 30.03.2012
        //            if (r["id_loai"].ToString() != "-1")
        //            {
        //                asql = "update " + xxx + ".v_chidinh set stt=" + m_stt + " where mabn='" + m_mabn + "' and maql=" + m_maql;
        //                asql += " and done=0 and stt=0 and mavp in(select id from " + s_user + ".v_giavp where id_loai=" + r["id_loai"].ToString() + ")";
        //                execute_data(asql);
        //            }
        //            else if (r["id_loai"].ToString() == "-1")
        //            {
        //                asql = "update " + xxx + ".v_chidinh set stt=" + m_stt + " where mabn='" + m_mabn + "' and maql=" + m_maql;
        //                asql += " and done=0 and stt=0 and mavp in(select id from " + s_user + ".v_giavp where id_loai in(select id from medibv.v_loaivp where id_nhom=1))";
        //                execute_data(asql);
        //            }
        //        }
        //    }
        //}

        public void f_get_stt_toathuoc(string m_ngay, string m_mabn, string m_maql)
        {
            string s_user = user;
            string xxx = s_user + mmyy(m_ngay);
            string asql = "";
            int m_stt = 1;
            DataSet lds;

            asql = "select b.id_loai, max(a.stt) as sttcho from " + xxx + ".v_chidinh a inner join " + s_user + ".v_giavp b on a.mavp=b.id inner join " + s_user + ".v_loaivp c on b.id_loai=c.id inner join " + s_user + ".v_nhomvp d on c.id_nhom=d.ma ";
            asql += " where to_char(a.ngay,'dd/mm/yyyy')='" + m_ngay.Substring(0, 10) + "'";
            asql += " group by b.id_loai";
            lds = get_data(asql);
            if (lds.Tables.Count > 0 && lds.Tables[0].Rows.Count <= 0)
            {
                m_stt = 1;
                asql = "update " + xxx + ".v_chidinh set sttcho=" + m_stt + " where mabn='" + m_mabn + "' and maql=" + m_maql;
                execute_data(asql);
            }
            else
            {
                foreach (DataRow r in lds.Tables[0].Rows)
                {
                    m_stt = int.Parse(r["sttcho"].ToString()) + 1;
                    asql = "update " + xxx + ".v_chidinh set stt=" + m_stt + " where mabn='" + m_mabn + "' and maql=" + m_maql;
                    asql += " and done=0 and stt=0 and mavp in(select id from " + s_user + ".v_giavp where id_loai=" + r["id_loai"].ToString() + ")";
                    execute_data(asql);
                }
            }
        }
        public void upd_thongso(int m_id, string m_fie, string m_ten)
        {
            sql = "update " + user + ".thongso set " + m_fie + "=:m_ten ";
            if (m_fie == "tencur") sql += ",ngayud=now()";
            sql += " where id=" + m_id;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".thongso(id," + m_fie + ") values (:m_id,:m_ten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message.ToString().Trim(), sComputer, "Thongso");
            }
            finally
            {
                con.Close(); con.Dispose();
            }
        }

        public void upd_thongso(int id, string ten, string tendef, string tencur)
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            sql = "update " + user + ".thongso set ten=:ten,tendef=:tendef,tencur=:tencur where id=:id";
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                cmd.Parameters.Add("tendef", NpgsqlDbType.Text).Value = tendef;
                cmd.Parameters.Add("tencur", NpgsqlDbType.Text).Value = tencur;
                cmd.Parameters.Add("id", NpgsqlDbType.Numeric).Value = id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".thongso(id,ten,tendef,tencur) values (:id,:ten,:tendef,:tencur)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("id", NpgsqlDbType.Numeric).Value = id;
                    cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                    cmd.Parameters.Add("tendef", NpgsqlDbType.Text).Value = tendef;
                    cmd.Parameters.Add("tencur", NpgsqlDbType.Text).Value = tencur;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message.ToString().Trim(), sComputer, "Thongso");
            }
            finally
            {
                con.Close(); con.Dispose();
            }
        }
        public void upd_thongso(int id, string ten, string tendef, string tencur, string loai)
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            sql = "update " + user + ".thongso set ten=:ten,tendef=:tendef,tencur=:tencur, loai=:loai where id=:id";
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                cmd.Parameters.Add("tendef", NpgsqlDbType.Text).Value = tendef;
                cmd.Parameters.Add("tencur", NpgsqlDbType.Text).Value = tencur;
                cmd.Parameters.Add("loai", NpgsqlDbType.Text).Value = loai;
                cmd.Parameters.Add("id", NpgsqlDbType.Numeric).Value = id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".thongso(id,ten,tendef,tencur,loai) values (:id,:ten,:tendef,:tencur,:loai)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("id", NpgsqlDbType.Numeric).Value = id;
                    cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                    cmd.Parameters.Add("tendef", NpgsqlDbType.Text).Value = tendef;
                    cmd.Parameters.Add("tencur", NpgsqlDbType.Text).Value = tencur;
                    cmd.Parameters.Add("loai", NpgsqlDbType.Text).Value = loai;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message.ToString().Trim(), sComputer, "Thongso");
            }
            finally
            {
                con.Close(); con.Dispose();
            }
        }

        public void upd_capmabn(int m_yy, int m_loai, int m_userid, int m_stt)
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            sql = "update " + user + ".capmabn set stt=:m_stt where yy=:m_yy and loai=:m_loai and userid=:m_userid";
            con = new NpgsqlConnection(sConn);
            con.Open();
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;
            cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
            cmd.Parameters.Add("m_yy", NpgsqlDbType.Numeric).Value = m_yy;
            cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
            cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
            int irec = cmd.ExecuteNonQuery();
            cmd.Dispose();
            if (irec == 0)
            {
                sql = "insert into " + user + ".capmabn(yy,stt,loai,userid) values (:m_yy,:m_stt,:m_loai,:m_userid)";
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_yy", NpgsqlDbType.Numeric).Value = m_yy;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            con.Close(); con.Dispose();
        }

        public decimal get_mabn(int yy, int loai, int userid, bool update)
        {
            int ma = 0;
            ds = get_data("select stt from " + user + ".capmabn where yy=" + yy + " and loai=" + loai + " and userid=" + userid);
            if (ds.Tables[0].Rows.Count > 0) ma = int.Parse(ds.Tables[0].Rows[0]["stt"].ToString());
            ma += 1;
            if (update) upd_capmabn(yy, loai, userid, ma);
            return ma;
        }

        public decimal get_capid(int m_ma, string m_yy)
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            sql = "update " + user + ".capid set id=id+1 where ma=:m_ma and yy=:m_yy";
            con = new NpgsqlConnection(sConn);
            con.Open();
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;
            cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
            cmd.Parameters.Add("m_yy", NpgsqlDbType.Varchar).Value = m_yy;
            int irec = cmd.ExecuteNonQuery();
            cmd.Dispose();
            if (irec == 0)
            {
                sql = "insert into " + user + ".capid(ma,yy,loai,id) values (:m_ma,:m_yy,'?',1)";
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                cmd.Parameters.Add("m_yy", NpgsqlDbType.Varchar).Value = m_yy;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            con.Close(); con.Dispose();
            return decimal.Parse(get_data("select id from " + user + ".capid where yy='" + m_yy + "'" + " and ma=" + m_ma).Tables[0].Rows[0][0].ToString());
        }

        public decimal get_capid_theokhoa(int m_ma, string m_makp, string m_yy)
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            sql = "update " + user + ".capid set id=id+1 where ma=:m_ma and loai=:m_makp and yy=:m_yy";
            con = new NpgsqlConnection(sConn);
            con.Open();
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;
            cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
            cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar).Value = m_makp;
            cmd.Parameters.Add("m_yy", NpgsqlDbType.Varchar).Value = m_yy;
            int irec = cmd.ExecuteNonQuery();
            cmd.Dispose();
            if (irec == 0)
            {
                sql = "insert into " + user + ".capid(ma,yy,loai,id) values (:m_ma,:m_yy,:m_makp,1)";
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar).Value = m_makp;
                cmd.Parameters.Add("m_yy", NpgsqlDbType.Varchar).Value = m_yy;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            con.Close(); con.Dispose();
            return decimal.Parse(get_data("select id from " + user + ".capid where yy='" + m_yy + "'" + " and loai= '" + m_makp + "' and ma=" + m_ma).Tables[0].Rows[0][0].ToString());
        }
        // N.D.ThNG
        public decimal get_capsotoa_ngay(int m_ma, string m_makp, string m_ngayud)
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            sql = "update " + user + ".capid set id=id+1 where ma=:m_ma and loai=:m_makp and to_char(ngayud,'dd/mm/yyyy')='"+m_ngayud.Substring(0,10)+"'";
            con = new NpgsqlConnection(sConn);
            con.Open();
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;
            cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
            cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar).Value = m_makp;            
            int irec = cmd.ExecuteNonQuery();
            cmd.Dispose();
            if (irec == 0)
            {
                sql = "insert into " + user + ".capid(ma,yy,loai,id,ngayud) values (:m_ma,'" + mmyy(m_ngayud) + "',:m_makp,1,to_timestamp('" + m_ngayud + "','dd/mm/yyyy hh24:mi'))";
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar).Value = m_makp;
               
                cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            con.Close(); con.Dispose();
            return decimal.Parse(get_data("select id from " + user + ".capid where to_char(ngayud,'dd/mm/yyyy')='" + m_ngayud.Substring(0,10) + "' and loai= '" + m_makp + "' and ma=" + m_ma).Tables[0].Rows[0][0].ToString());
        }
        //
        public decimal get_capid(int m_ma)
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            sql = "update " + user + ".capid set id=id+1 where ma=:m_ma";
            con = new NpgsqlConnection(sConn);
            con.Open();
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;
            cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
            int irec = cmd.ExecuteNonQuery();
            cmd.Dispose();
            if (irec == 0)
            {
                sql = "insert into " + user + ".capid(ma,yy,loai,id) values (:m_ma,'??',:m_loai,1)";
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                cmd.Parameters.Add("m_loai", NpgsqlDbType.Varchar, 20).Value = sComputer;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            sql = "select id from " + user + ".capid where ma=" + m_ma;
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;
            dest = new NpgsqlDataAdapter(cmd);
            ds = new DataSet();
            dest.Fill(ds);
            cmd.Dispose();
            con.Close(); con.Dispose();
            return decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
        }

        public int get_dmcomputer()
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            int i_id = 0;
            DataSet DS1=  get_data("select id from " + user + ".dmcomputer where computer='" + sComputer + "'");
            if (DS1 == null || DS1.Tables.Count <= 0 || DS1.Tables[0].Rows.Count<=0)
            {
                sql = "update " + user + ".dmcomputer set computer=:m_computer where computer=:m_computer";
                con = new NpgsqlConnection(sConn);
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_computer", NpgsqlDbType.Varchar, 20).Value = sComputer;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                con.Close(); con.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dmcomputer(id,computer) values (" + get_id_dmcomputer + ",'" + sComputer + "')";
                    execute_data(sql);
                }
                 i_id=int.Parse(get_data("select id from " + user + ".dmcomputer where computer='" + sComputer + "'").Tables[0].Rows[0][0].ToString());
            }
            else
            {
                i_id = int.Parse(DS1.Tables[0].Rows[0]["id"].ToString());
                
            }
            return i_id;
            }

        public int get_dmcomputer(string m_computer)
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            sql = "update " + user + ".dmcomputer set computer=:m_computer where computer=:m_computer";
            con = new NpgsqlConnection(sConn);
            con.Open();
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;
            cmd.Parameters.Add("m_computer", NpgsqlDbType.Varchar, 20).Value = m_computer;
            int irec = cmd.ExecuteNonQuery();
            cmd.Dispose();
            con.Close(); con.Dispose();
            if (irec == 0)
            {
                sql = "insert into " + user + ".dmcomputer(id,computer) values (" + get_id_dmcomputer + ",'" + m_computer + "')";
                execute_data(sql);
            }
            return int.Parse(get_data("select id from " + user + ".dmcomputer where computer='" + m_computer + "'").Tables[0].Rows[0][0].ToString());
        }
        //linh
        public bool upd_btdbn(string m_mabn, string m_hoten, string m_ngaysinh, string m_namsinh,
            int m_phai, string m_mann, string m_madantoc, string m_sonha, string m_thon,
            string m_cholam, string m_matt, string m_maqu, string m_maphuongxa, int m_userid)
        {
            dblink = dblink.Trim('@');
            dblink = dblink == "" ? "" : "@" + dblink;
            m_hotenkdau = Hoten_khongdau(m_hoten);
            string s_sql = "update " + userid + ".btdbn" + dblink + " set hoten=:m_hoten,ngaysinh=to_date(:m_ngaysinh,'dd/mm/yyyy'),namsinh='" + m_namsinh + "',phai=" + m_phai.ToString() + "," +
                "mann='" + m_mann + "',madantoc='" + m_madantoc + "',sonha=:m_sonha,thon=:m_thon,cholam=:m_cholam,matt='" + m_matt + "',maqu='" + m_maqu + "',maphuongxa='" + m_maphuongxa + "'," +
                "userid=" + m_userid.ToString() + ",hotenkdau='" + m_hotenkdau + "' where mabn='" + m_mabn + "'";

            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(s_sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_hoten", NpgsqlDbType.Text).Value = m_hoten;
                cmd.Parameters.Add("m_ngaysinh", NpgsqlDbType.Varchar, 10).Value = m_ngaysinh == "" ? null : m_ngaysinh; ;
                cmd.Parameters.Add("m_sonha", NpgsqlDbType.Text).Value = m_sonha;
                cmd.Parameters.Add("m_thon", NpgsqlDbType.Text).Value = m_thon;
                cmd.Parameters.Add("m_cholam", NpgsqlDbType.Text).Value = m_cholam;
                int i = cmd.ExecuteNonQuery();
                if (i == 0)
                {
                    s_sql = "insert into " + userid + ".btdbn" + dblink + "(mabn,hoten,ngaysinh,namsinh,phai,mann,madantoc,sonha,thon,cholam,matt,maqu,maphuongxa,userid,hotenkdau) " +
                        "values ('" + m_mabn + "',:m_hoten,to_date(:m_ngaysinh,'dd/mm/yyyy'),'" + m_namsinh + "'," + m_phai.ToString() + ",'" + m_mann + "','" + m_madantoc + "',:m_sonha,:m_thon," +
                        ":m_cholam,'" + m_matt + "','" + m_maqu + "','" + m_maphuongxa + "'," + m_userid.ToString() + ",'" + m_hotenkdau + "')";
                    cmd = new NpgsqlCommand(s_sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_hoten", NpgsqlDbType.Text).Value = m_hoten;
                    cmd.Parameters.Add("m_ngaysinh", NpgsqlDbType.Varchar, 10).Value = (m_ngaysinh == "" ? null : m_ngaysinh);
                    cmd.Parameters.Add("m_sonha", NpgsqlDbType.Text).Value = m_sonha;
                    cmd.Parameters.Add("m_thon", NpgsqlDbType.Text).Value = m_thon;
                    cmd.Parameters.Add("m_cholam", NpgsqlDbType.Text).Value = m_cholam;
                    i = cmd.ExecuteNonQuery();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "btdbn");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
            return true;

        }
        //end linh
        public bool upd_btdbn_image(string m_mabn, byte[] m_image)
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            sql = "update " + user + ".btdbn set image=:m_image where mabn=:m_mabn";
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_image", NpgsqlDbType.Bytea, m_image.Length).Value = m_image;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "Btdbn " + m_mabn);
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_btdbn_barcode(string m_mabn, byte[] m_barcode)
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            sql = "update " + user + ".btdbn set barcode=:m_barcode where mabn=:m_mabn";
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_barcode", NpgsqlDbType.Bytea, m_barcode.Length).Value = m_barcode;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "Btdbn " + m_mabn);
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_dienthoai(string m_mabn, string m_nha, string m_coquan, string m_didong, string m_email)
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            sql = "update " + user + ".dienthoai set nha=:m_nha,";
            sql += "coquan=:m_coquan,didong=:m_didong,email=:m_email ";
            sql += "where mabn=:m_mabn";
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_nha", NpgsqlDbType.Varchar, 20).Value = m_nha;
                cmd.Parameters.Add("m_coquan", NpgsqlDbType.Varchar, 20).Value = m_coquan;
                cmd.Parameters.Add("m_didong", NpgsqlDbType.Varchar, 15).Value = m_didong;
                cmd.Parameters.Add("m_email", NpgsqlDbType.Text).Value = m_email;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dienthoai (mabn,nha,coquan,didong,email)";
                    sql += " values (:m_mabn,:m_nha,:m_coquan,:m_didong,:m_email)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_nha", NpgsqlDbType.Varchar, 20).Value = m_nha;
                    cmd.Parameters.Add("m_coquan", NpgsqlDbType.Varchar, 20).Value = m_coquan;
                    cmd.Parameters.Add("m_didong", NpgsqlDbType.Varchar, 15).Value = m_didong;
                    cmd.Parameters.Add("m_email", NpgsqlDbType.Text).Value = m_email;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dienthoai " + m_mabn);
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_dausinhton(string m_ngay, decimal m_maql, decimal m_mach, decimal m_nhietdo, string m_huyetap, decimal m_cannang, decimal m_chieucao, decimal m_nhiptho)
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            sql = "update " + user + mmyy(m_ngay) + ".dausinhton set mach=:m_mach,nhietdo=:m_nhietdo,huyetap=:m_huyetap,cannang=:m_cannang,chieucao=:m_chieucao,nhiptho=:m_nhiptho";
            sql += " where maql=:m_maql";
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mach", NpgsqlDbType.Numeric).Value = m_mach;
                cmd.Parameters.Add("m_nhietdo", NpgsqlDbType.Numeric).Value = m_nhietdo;
                cmd.Parameters.Add("m_huyetap", NpgsqlDbType.Varchar, 7).Value = m_huyetap;
                cmd.Parameters.Add("m_cannang", NpgsqlDbType.Numeric).Value = m_cannang;
                cmd.Parameters.Add("m_chieucao", NpgsqlDbType.Numeric).Value = m_chieucao;
                cmd.Parameters.Add("m_nhiptho", NpgsqlDbType.Numeric).Value = m_nhiptho;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + mmyy(m_ngay) + ".dausinhton (maql,mach,nhietdo,huyetap,cannang,chieucao,nhiptho)";
                    sql += " values (:m_maql,:m_mach,:m_nhietdo,:m_huyetap,:m_cannang,:m_chieucao,:m_nhiptho)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_mach", NpgsqlDbType.Numeric).Value = m_mach;
                    cmd.Parameters.Add("m_nhietdo", NpgsqlDbType.Numeric).Value = m_nhietdo;
                    cmd.Parameters.Add("m_huyetap", NpgsqlDbType.Varchar, 7).Value = m_huyetap;
                    cmd.Parameters.Add("m_cannang", NpgsqlDbType.Numeric).Value = m_cannang;
                    cmd.Parameters.Add("m_chieucao", NpgsqlDbType.Numeric).Value = m_chieucao;
                    cmd.Parameters.Add("m_nhiptho", NpgsqlDbType.Numeric).Value = m_nhiptho;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message, sComputer, "dausinhton");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_dausinhton(decimal m_maql, decimal m_mach, decimal m_nhietdo, string m_huyetap, decimal m_cannang, decimal m_chieucao,decimal m_nhiptho)
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            sql = "update " + user + ".dausinhton set mach=:m_mach,nhietdo=:m_nhietdo,huyetap=:m_huyetap,cannang=:m_cannang,chieucao=:m_chieucao,nhiptho=:m_nhiptho";
            sql += " where maql=:m_maql";
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mach", NpgsqlDbType.Numeric).Value = m_mach;
                cmd.Parameters.Add("m_nhietdo", NpgsqlDbType.Numeric).Value = m_nhietdo;
                cmd.Parameters.Add("m_huyetap", NpgsqlDbType.Varchar, 7).Value = m_huyetap;
                cmd.Parameters.Add("m_cannang", NpgsqlDbType.Numeric).Value = m_cannang;
                cmd.Parameters.Add("m_chieucao", NpgsqlDbType.Numeric).Value = m_chieucao;
                cmd.Parameters.Add("m_nhiptho", NpgsqlDbType.Numeric).Value = m_nhiptho;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dausinhton (maql,mach,nhietdo,huyetap,cannang,chieucao,nhiptho)";
                    sql += " values (:m_maql,:m_mach,:m_nhietdo,:m_huyetap,:m_cannang,:m_chieucao,:m_nhiptho)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_mach", NpgsqlDbType.Numeric).Value = m_mach;
                    cmd.Parameters.Add("m_nhietdo", NpgsqlDbType.Numeric).Value = m_nhietdo;
                    cmd.Parameters.Add("m_huyetap", NpgsqlDbType.Varchar, 7).Value = m_huyetap;
                    cmd.Parameters.Add("m_cannang", NpgsqlDbType.Numeric).Value = m_cannang;
                    cmd.Parameters.Add("m_chieucao", NpgsqlDbType.Numeric).Value = m_chieucao;
                    cmd.Parameters.Add("m_nhiptho", NpgsqlDbType.Numeric).Value = m_nhiptho;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dausinhton");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_lienhe(decimal m_maql, string m_sonha, string m_thon,
            string m_cholam, string m_matt, string m_maqu, string m_maphuongxa, string m_tuoivao, int m_loai, int m_bnmoi)
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            sql = "update " + user + ".lienhe set sonha=:m_sonha,thon=:m_thon,cholam=:m_cholam,matt=:m_matt,maqu=:m_maqu,";
            sql += "maphuongxa=:m_maphuongxa,tuoivao=:m_tuoivao,loai=:m_loai,bnmoi=:m_bnmoi where maql=:m_maql";
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_sonha", NpgsqlDbType.Text, 10).Value = m_sonha;
                cmd.Parameters.Add("m_thon", NpgsqlDbType.Text).Value = m_thon;
                cmd.Parameters.Add("m_cholam", NpgsqlDbType.Text).Value = m_cholam;
                cmd.Parameters.Add("m_matt", NpgsqlDbType.Varchar, 3).Value = m_matt;
                cmd.Parameters.Add("m_maqu", NpgsqlDbType.Varchar, 5).Value = m_maqu;
                cmd.Parameters.Add("m_maphuongxa", NpgsqlDbType.Varchar, 7).Value = m_maphuongxa;
                cmd.Parameters.Add("m_tuoivao", NpgsqlDbType.Varchar, 4).Value = m_tuoivao;
                cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                cmd.Parameters.Add("m_bnmoi", NpgsqlDbType.Numeric).Value = m_bnmoi;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".lienhe (maql,sonha,thon,cholam,matt,maqu,maphuongxa,tuoivao,loai,bnmoi)";
                    sql += " values (:m_maql,:m_sonha,:m_thon,:m_cholam,:m_matt,:m_maqu,:m_maphuongxa,:m_tuoivao,:m_loai,:m_bnmoi)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_sonha", NpgsqlDbType.Text, 10).Value = m_sonha;
                    cmd.Parameters.Add("m_thon", NpgsqlDbType.Text).Value = m_thon;
                    cmd.Parameters.Add("m_cholam", NpgsqlDbType.Text).Value = m_cholam;
                    cmd.Parameters.Add("m_matt", NpgsqlDbType.Varchar, 3).Value = m_matt;
                    cmd.Parameters.Add("m_maqu", NpgsqlDbType.Varchar, 5).Value = m_maqu;
                    cmd.Parameters.Add("m_maphuongxa", NpgsqlDbType.Varchar, 7).Value = m_maphuongxa;
                    cmd.Parameters.Add("m_tuoivao", NpgsqlDbType.Varchar, 4).Value = m_tuoivao;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                    cmd.Parameters.Add("m_bnmoi", NpgsqlDbType.Numeric).Value = m_bnmoi;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "Lienhe");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public void upd_soluutru(decimal m_maql, string m_soluutru)
        {
            execute_data("update " + user + ".lienhe set soluutru='" + m_soluutru + "'" + " where maql=" + m_maql);
        }

        public string get_soluutru(decimal m_maql)
        {
            ds = get_data("select soluutru from " + user + ".lienhe where maql=" + m_maql);
            if (ds.Tables[0].Rows.Count == 0) return "";
            else return ds.Tables[0].Rows[0]["soluutru"].ToString();
        }

        public bool upd_bhyt(string m_mabn, decimal m_maql, string m_sothe, string m_denngay, string m_mabv, int m_maphu,
            string m_tungay, string m_ngay1, string m_ngay2, string m_ngay3, int traituyen)
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            if (m_ngay1 == null) m_ngay1 = "";
            if (m_ngay2 == null) m_ngay2 = "";
            if (m_ngay3 == null) m_ngay3 = "";
            if (m_tungay == null) m_tungay = "";
            if (m_denngay == null) m_denngay = "";
            sql = "update " + user + ".bhyt set ";
            if (m_denngay.Trim().Length == 10) sql += "denngay=:m_denngay,";
            if (m_tungay.Trim().Length == 10) sql += "tungay=:m_tungay,";
            sql += "mabv=:m_mabv,maphu=:m_maphu";
            if (m_ngay1.Trim().Length == 10) sql += ",ngay1=:m_ngay1";
            if (m_ngay2.Trim().Length == 10) sql += ",ngay2=:m_ngay2";
            if (m_ngay3.Trim().Length == 10) sql += ",ngay3=:m_ngay3";
            sql += ",traituyen=" + traituyen;
            sql += " where maql=:m_maql and sothe=:m_sothe";
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                if (m_denngay.Trim().Length == 10) cmd.Parameters.Add("m_denngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_denngay);
                if (m_tungay.Trim().Length == 10) cmd.Parameters.Add("m_tungay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_tungay);
                cmd.Parameters.Add("m_mabv", NpgsqlDbType.Varchar, 10).Value = m_mabv;
                cmd.Parameters.Add("m_maphu", NpgsqlDbType.Numeric).Value = m_maphu;
                if (m_ngay1.Trim().Length == 10) cmd.Parameters.Add("m_ngay1", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay1);
                if (m_ngay2.Trim().Length == 10) cmd.Parameters.Add("m_ngay2", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay2);
                if (m_ngay3.Trim().Length == 10) cmd.Parameters.Add("m_ngay3", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay3);
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                cmd.Parameters.Add("m_sothe", NpgsqlDbType.Varchar, 20).Value = m_sothe;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".bhyt(mabn,maql,sothe";
                    if (m_denngay.Trim().Length == 10) sql += ",denngay";
                    sql += ",mabv,maphu";
                    if (m_tungay.Trim().Length == 10) sql += ",tungay";
                    if (m_ngay1.Trim().Length == 10) sql += ",ngay1";
                    if (m_ngay2.Trim().Length == 10) sql += ",ngay2";
                    if (m_ngay3.Trim().Length == 10) sql += ",ngay3";
                    sql += ",traituyen) values (:m_mabn,:m_maql,:m_sothe";
                    if (m_denngay.Trim().Length == 10) sql += ",:m_denngay";
                    sql += ",:m_mabv,:m_maphu";
                    if (m_tungay.Trim().Length == 10) sql += ",:m_tungay";
                    if (m_ngay1.Trim().Length == 10) sql += ",:m_ngay1";
                    if (m_ngay2.Trim().Length == 10) sql += ",:m_ngay2";
                    if (m_ngay3.Trim().Length == 10) sql += ",:m_ngay3";
                    sql += "," + traituyen + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_sothe", NpgsqlDbType.Varchar, 20).Value = m_sothe;
                    if (m_denngay.Trim().Length == 10) cmd.Parameters.Add("m_denngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_denngay);
                    cmd.Parameters.Add("m_mabv", NpgsqlDbType.Varchar, 10).Value = m_mabv;
                    cmd.Parameters.Add("m_maphu", NpgsqlDbType.Numeric).Value = m_maphu;
                    if (m_tungay.Trim().Length == 10) cmd.Parameters.Add("m_tungay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_tungay);
                    if (m_ngay1.Trim().Length == 10) cmd.Parameters.Add("m_ngay1", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay1);
                    if (m_ngay2.Trim().Length == 10) cmd.Parameters.Add("m_ngay2", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay2);
                    if (m_ngay3.Trim().Length == 10) cmd.Parameters.Add("m_ngay3", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay3);
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "Bhyt " + m_mabn);
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_bhyt(string m_mabn, decimal m_maql, string m_sothe, string m_denngay, string m_mabv, int m_maphu,
            string m_tungay, string m_ngay1, string m_ngay2, string m_ngay3, string m_ngaytrinh, string m_ngayduyet,
            string m_ngaygiahan, int traituyen)
        {
            if (m_ngay1 == null) m_ngay1 = "";
            if (m_ngay2 == null) m_ngay2 = "";
            if (m_ngay3 == null) m_ngay3 = "";
            if (m_tungay == null) m_tungay = "";
            if (m_denngay == null) m_denngay = "";
            if (m_ngaytrinh == null) m_ngaytrinh = "";
            if (m_ngayduyet == null) m_ngayduyet = "";
            if (m_ngaygiahan == null) m_ngaygiahan = "";

            sql = "update " + user + ".bhyt set ";
            if (m_denngay.Trim().Length == 10) sql += "denngay=:m_denngay,";
            if (m_tungay.Trim().Length == 10) sql += "tungay=:m_tungay,";
            sql += "mabv=:m_mabv,maphu=:m_maphu";
            if (m_ngay1.Trim().Length == 10) sql += ",ngay1=:m_ngay1";
            if (m_ngay2.Trim().Length == 10) sql += ",ngay2=:m_ngay2";
            if (m_ngay3.Trim().Length == 10) sql += ",ngay3=:m_ngay3";
            if (m_ngaytrinh.Trim().Length >= 10) sql += ",ngaytrinh=:m_ngaytrinh";
            if (m_ngayduyet.Trim().Length >= 10) sql += ",ngayduyet=:m_ngayduyet";
            if (m_ngaygiahan.Trim().Length == 10) sql += ",ngaygiahan=:m_ngaygiahan";
            sql += ",traituyen=" + traituyen;
            sql += " where maql=:m_maql and sothe=:m_sothe";
            if (m_denngay.Trim().Length == 10) sql += " and denngay=:m_denngay ";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                if (m_denngay.Trim().Length == 10) cmd.Parameters.Add("m_denngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_denngay);
                if (m_tungay.Trim().Length == 10) cmd.Parameters.Add("m_tungay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_tungay);
                cmd.Parameters.Add("m_mabv", NpgsqlDbType.Varchar, 10).Value = m_mabv;
                cmd.Parameters.Add("m_maphu", NpgsqlDbType.Numeric).Value = m_maphu;
                if (m_ngay1.Trim().Length == 10) cmd.Parameters.Add("m_ngay1", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay1);
                if (m_ngay2.Trim().Length == 10) cmd.Parameters.Add("m_ngay2", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay2);
                if (m_ngay3.Trim().Length == 10) cmd.Parameters.Add("m_ngay3", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay3);
                if (m_ngaytrinh.Trim().Length >= 10) cmd.Parameters.Add("m_ngaytrinh", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngaytrinh.Substring(0, 10));
                if (m_ngayduyet.Trim().Length >= 10) cmd.Parameters.Add("m_ngayduyet", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngayduyet.Substring(0, 10));
                if (m_ngaygiahan.Trim().Length == 10) cmd.Parameters.Add("m_ngaygiahan", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngaygiahan);
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                cmd.Parameters.Add("m_sothe", NpgsqlDbType.Varchar, 20).Value = m_sothe;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".bhyt(mabn,maql,sothe";
                    if (m_denngay.Trim().Length == 10) sql += ",denngay";
                    sql += ",mabv,maphu";
                    if (m_tungay.Trim().Length == 10) sql += ",tungay";
                    if (m_ngay1.Trim().Length == 10) sql += ",ngay1";
                    if (m_ngay2.Trim().Length == 10) sql += ",ngay2";
                    if (m_ngay3.Trim().Length == 10) sql += ",ngay3";
                    if (m_ngaytrinh.Trim().Length >= 10) sql += ",ngaytrinh";
                    if (m_ngayduyet.Trim().Length >= 10) sql += ",ngayduyet";
                    if (m_ngaygiahan.Trim().Length == 10) sql += ",ngaygiahan";
                    sql += ",traituyen) values (:m_mabn,:m_maql,:m_sothe";
                    if (m_denngay.Trim().Length == 10) sql += ",:m_denngay";
                    sql += ",:m_mabv,:m_maphu";
                    if (m_tungay.Trim().Length == 10) sql += ",:m_tungay";
                    if (m_ngay1.Trim().Length == 10) sql += ",:m_ngay1";
                    if (m_ngay2.Trim().Length == 10) sql += ",:m_ngay2";
                    if (m_ngay3.Trim().Length == 10) sql += ",:m_ngay3";
                    if (m_ngaytrinh.Trim().Length >= 10) sql += ",:m_ngaytrinh";
                    if (m_ngayduyet.Trim().Length >= 10) sql += ",:m_ngayduyet";
                    if (m_ngaygiahan.Trim().Length == 10) sql += ",:m_ngaygiahan";
                    sql += "," + traituyen + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_sothe", NpgsqlDbType.Varchar, 20).Value = m_sothe;
                    if (m_denngay.Trim().Length == 10) cmd.Parameters.Add("m_denngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_denngay);
                    cmd.Parameters.Add("m_mabv", NpgsqlDbType.Varchar, 10).Value = m_mabv;
                    cmd.Parameters.Add("m_maphu", NpgsqlDbType.Numeric).Value = m_maphu;
                    if (m_tungay.Trim().Length == 10) cmd.Parameters.Add("m_tungay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_tungay);
                    if (m_ngay1.Trim().Length == 10) cmd.Parameters.Add("m_ngay1", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay1);
                    if (m_ngay2.Trim().Length == 10) cmd.Parameters.Add("m_ngay2", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay2);
                    if (m_ngay3.Trim().Length == 10) cmd.Parameters.Add("m_ngay3", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay3);
                    if (m_ngaytrinh.Trim().Length >= 10) cmd.Parameters.Add("m_ngaytrinh", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngaytrinh.Substring(0, 10));
                    if (m_ngayduyet.Trim().Length >= 10) cmd.Parameters.Add("m_ngayduyet", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngayduyet.Substring(0, 10));
                    if (m_ngaygiahan.Trim().Length == 10) cmd.Parameters.Add("m_ngaygiahan", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngaygiahan);
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "Bhyt " + m_mabn);
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        //linh
        public bool upd_bhyt(string m_ngay, string m_mabn, decimal m_maql, string m_sothe, string m_denngay, string m_mabv,
            int m_maphu, string m_tungay, string m_ngay1, string m_ngay2, string m_ngay3, int traituyen)
        {
            string _mmyy = mmyy(m_ngay);
            if (!bMmyy(_mmyy)) return false;
            dblink = dblink.Trim('@');
            dblink = dblink == "" ? "" : "@" + dblink;
            string s_sql = "update " + user + _mmyy + ".bhyt" + dblink + " set mabn='" + m_mabn + "',sothe='" + m_sothe + "'";
            s_sql += ",denngay=to_date(:m_denngay,'dd/mm/yyyy')";
            s_sql += ",tungay=to_date(:m_tungay,'dd/mm/yyyy')";
            s_sql += ",ngay1=to_date(:m_ngay1,'dd/mm/yyyy')";
            s_sql += ",ngay2=to_date(:m_ngay2,'dd/mm/yyyy')";
            s_sql += ",ngay3=to_date(:m_ngay3,'dd/mm/yyyy')";
            s_sql += ",mabv='" + m_mabv + "',maphu=" + m_maphu.ToString();
            s_sql += ",traituyen=" + traituyen;
            s_sql += " where maql=" + m_maql.ToString();
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(s_sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_denngay", NpgsqlDbType.Varchar, 10).Value = (m_denngay == "" ? null : m_denngay);
                cmd.Parameters.Add("m_tungay", NpgsqlDbType.Varchar, 10).Value = (m_tungay == "" ? null : m_tungay);
                cmd.Parameters.Add("m_ngay1", NpgsqlDbType.Varchar, 10).Value = (m_ngay1 == "" ? null : m_ngay1);
                cmd.Parameters.Add("m_ngay2", NpgsqlDbType.Varchar, 10).Value = (m_ngay2 == "" ? null : m_ngay2);
                cmd.Parameters.Add("m_ngay3", NpgsqlDbType.Varchar, 10).Value = (m_ngay3 == "" ? null : m_ngay3);
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    s_sql = "insert into " + user + mmyy(m_ngay) + ".bhyt" + dblink + "(mabn,maql,sothe,denngay,mabv,maphu,tungay,ngay1,ngay2,ngay3,traituyen) " +
                        "values ('" + m_mabn + "'," + m_maql.ToString() + ",'" + m_sothe + "'";
                    s_sql += ",to_date(:m_denngay,'dd/mm/yyyy')";
                    s_sql += ",'" + m_mabv + "'," + m_maphu.ToString() + "";
                    s_sql += ",to_date(:m_tungay,'dd/mm/yyyy')";
                    s_sql += ",to_date(:m_ngay1,'dd/mm/yyyy')";
                    s_sql += ",to_date(:m_ngay2,'dd/mm/yyyy')";
                    s_sql += ",to_date(:m_ngay3,'dd/mm/yyyy')";
                    s_sql += "," + traituyen.ToString() + ")";
                    cmd = new NpgsqlCommand(s_sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_denngay", NpgsqlDbType.Varchar, 10).Value = (m_denngay == "" ? null : m_denngay);
                    cmd.Parameters.Add("m_tungay", NpgsqlDbType.Varchar, 10).Value = (m_tungay == "" ? null : m_tungay);
                    cmd.Parameters.Add("m_ngay1", NpgsqlDbType.Varchar, 10).Value = (m_ngay1 == "" ? null : m_ngay1);
                    cmd.Parameters.Add("m_ngay2", NpgsqlDbType.Varchar, 10).Value = (m_ngay2 == "" ? null : m_ngay2);
                    cmd.Parameters.Add("m_ngay3", NpgsqlDbType.Varchar, 10).Value = (m_ngay3 == "" ? null : m_ngay3);
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message, sComputer, "Bhyt " + m_mabn);
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        //end linh
        public bool upd_dmbhyt(string m_mabn, string m_ma, string m_sothe, string m_tungay, string m_denngay, string m_mabv, int m_maphu)
        {
            sql = "update " + user + ".dmbhyt set ";
            if (m_ma != "") sql += " ma=:m_ma,";
            if (m_tungay != "") sql += "tungay=:m_tungay,";
            if (m_denngay != "") sql += "denngay=:m_denngay,";
            sql += "mabv=:m_mabv,maphu=:m_maphu";
            sql += " where sothe=:m_sothe";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                if (m_ma != "") cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 10).Value = m_ma;
                if (m_tungay != "") cmd.Parameters.Add("m_tungay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_tungay);
                if (m_denngay != "") cmd.Parameters.Add("m_denngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_denngay);
                cmd.Parameters.Add("m_mabv", NpgsqlDbType.Varchar, 10).Value = m_mabv;
                cmd.Parameters.Add("m_maphu", NpgsqlDbType.Numeric).Value = m_maphu;
                cmd.Parameters.Add("m_sothe", NpgsqlDbType.Varchar, 20).Value = m_sothe;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dmbhyt(mabn,ma,sothe";
                    if (m_tungay != "") sql += ",tungay";
                    if (m_denngay != "") sql += ",denngay";
                    sql += ",mabv,maphu";
                    sql += ") values (:m_mabn,:m_ma,:m_sothe";
                    if (m_tungay != "") sql += ",:m_tungay";
                    if (m_denngay != "") sql += ",:m_denngay";
                    sql += ",:m_mabv,:m_maphu";
                    sql += ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 10).Value = m_ma;
                    cmd.Parameters.Add("m_sothe", NpgsqlDbType.Varchar, 20).Value = m_sothe;
                    if (m_tungay != "") cmd.Parameters.Add("m_tungay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_tungay);
                    if (m_denngay != "") cmd.Parameters.Add("m_denngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_denngay);
                    cmd.Parameters.Add("m_mabv", NpgsqlDbType.Varchar, 8).Value = m_mabv;
                    cmd.Parameters.Add("m_maphu", NpgsqlDbType.Numeric).Value = m_maphu;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dmbhyt");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_benhandt(string m_mabn, decimal m_mavaovien, decimal m_maql, string m_makp, string m_ngay,
            int m_dentu, int m_nhantu, int m_lanthu, int m_madoituong, string m_chandoan,
            string m_maicd, string m_mabs, string m_sovaovien, int m_loaiba, int m_userid, bool m_update)
        {
            bool Sovaovien = bSovaovien;
            sql = "update " + user + ".benhandt set ";
            if (m_update) sql += "makp=:m_makp,";
            sql += "ngay=:m_ngay,dentu=:m_dentu,nhantu=:m_nhantu,";
            sql += "lanthu=:m_lanthu,madoituong=:m_madoituong,chandoan=:m_chandoan,maicd=:m_maicd,mabs=:m_mabs,";
            if (!Sovaovien) sql += "sovaovien=:m_sovaovien,";
            sql += "loaiba=:m_loaiba where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                if (m_update) cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_dentu", NpgsqlDbType.Numeric).Value = m_dentu;
                cmd.Parameters.Add("m_nhantu", NpgsqlDbType.Numeric).Value = m_nhantu;
                cmd.Parameters.Add("m_lanthu", NpgsqlDbType.Numeric).Value = m_lanthu;
                cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                if (!Sovaovien) cmd.Parameters.Add("m_sovaovien", NpgsqlDbType.Varchar, 10).Value = m_sovaovien;
                cmd.Parameters.Add("m_loaiba", NpgsqlDbType.Numeric).Value = m_loaiba;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".benhandt(mabn,mavaovien,maql,makp,ngay,dentu,nhantu,lanthu,madoituong,chandoan,maicd,mabs,sovaovien,loaiba,userid,ngayud)";
                    sql += " values (:m_mabn,:m_mavaovien,:m_maql,:m_makp,:m_ngay,:m_dentu,:m_nhantu,:m_lanthu,:m_madoituong,:m_chandoan,:m_maicd,:m_mabs,:m_sovaovien,:m_loaiba,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_dentu", NpgsqlDbType.Numeric).Value = m_dentu;
                    cmd.Parameters.Add("m_nhantu", NpgsqlDbType.Numeric).Value = m_nhantu;
                    cmd.Parameters.Add("m_lanthu", NpgsqlDbType.Numeric).Value = m_lanthu;
                    cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                    cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                    cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    cmd.Parameters.Add("m_sovaovien", NpgsqlDbType.Varchar, 10).Value = m_sovaovien;
                    cmd.Parameters.Add("m_loaiba", NpgsqlDbType.Numeric).Value = m_loaiba;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                    con.Close(); con.Dispose();
                    if (m_sovaovien == "" && Sovaovien)
                    {
                        if (bSovaovien_noitru)
                        {
                            if (m_loaiba == 1) upd_sovaovien(m_maql, get_capid(5, m_ngay.Substring(8, 2)).ToString().PadLeft(7, '0') + "/" + m_ngay.Substring(8, 2));
                        }
                        else if (m_loaiba != 3) upd_sovaovien(m_maql, get_capid(5, m_ngay.Substring(8, 2)).ToString().PadLeft(7, '0') + "/" + m_ngay.Substring(8, 2));
                    }
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "Benhandt");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_nhapkhoa(decimal m_id, string m_mabn, decimal m_mavaovien, decimal m_maql, string m_makp, int m_maba, string m_ngayvv, string m_ngay, string m_tuoivao, string m_giuong, string m_khoachuyen, string m_chandoan, string m_maicd, string m_mabs, int m_lan, int m_userid)
        {
            sql = "update " + user + ".nhapkhoa set makp=:m_makp,maba=:m_maba,ngay=:m_ngay,";
            sql += "tuoivao=:m_tuoivao,giuong=:m_giuong,khoachuyen=:m_khoachuyen,";
            sql += "chandoan=:m_chandoan,maicd=:m_maicd,mabs=:m_mabs,lan=:m_lan";
            sql += " where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                cmd.Parameters.Add("m_maba", NpgsqlDbType.Numeric).Value = m_maba;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_tuoivao", NpgsqlDbType.Varchar, 4).Value = m_tuoivao;
                cmd.Parameters.Add("m_giuong", NpgsqlDbType.Varchar, 20).Value = m_giuong;
                cmd.Parameters.Add("m_khoachuyen", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_khoachuyen;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_lan", NpgsqlDbType.Numeric).Value = m_lan;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".nhapkhoa(id,mabn,maql,makp,maba,ngay,tuoivao,giuong,khoachuyen,chandoan,maicd,mabs,lan,userid,ngayud)";
                    sql += " values (:m_id,:m_mabn,:m_maql,:m_makp,:m_maba,:m_ngay,:m_tuoivao,:m_giuong,:m_khoachuyen,:m_chandoan,:m_maicd,:m_mabs,:m_lan,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_maba", NpgsqlDbType.Numeric).Value = m_maba;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_tuoivao", NpgsqlDbType.Varchar, 4).Value = m_tuoivao;
                    cmd.Parameters.Add("m_giuong", NpgsqlDbType.Varchar, 20).Value = m_giuong;
                    cmd.Parameters.Add("m_khoachuyen", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_khoachuyen;
                    cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                    cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    cmd.Parameters.Add("m_lan", NpgsqlDbType.Numeric).Value = m_lan;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                    con.Close(); con.Dispose();
                    execute_data("delete from " + user + ".hiendien where nhapkhoa=0 and xuatkhoa=0 and mabn='" + m_mabn + "' and maql=" + m_maql + " and makp='" + m_makp + "'");
                    upd_hiendien(m_id, m_mabn, m_mavaovien, m_maql, m_makp, m_ngayvv, m_ngay, m_giuong, m_mabs, m_maicd, m_khoachuyen);
                    upd_hiendien(m_id, 0);
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "Nhapkhoa");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close(); con.Dispose();
                //upd_hiendien(m_id,m_mabn,m_mavaovien,m_maql,m_makp,m_ngayvv,m_ngay,m_giuong,m_mabs,m_maicd,m_khoachuyen);
                //upd_hiendien(m_id,0);
            }
            return true;
        }

        public bool upd_xuattam(decimal m_id, string m_mabn, decimal m_maql, decimal m_idkhoa, string m_ngayvv, string m_makp, string m_ngayvk, string m_chandoan, int m_lydo, string m_ghichu, string m_tinhtrangra, string m_mabs, string m_ngayra, int m_userid)
        {
            sql = "update " + user + ".xuattam set mabn=:m_mabn,maql=:m_maql,idkhoa=:m_idkhoa,ngayvv=to_timestamp(:m_ngayvv,'dd/mm/yyyy hh24:mi'),";
            sql += "makp=:m_makp,ngayvk=to_timestamp(:m_ngayvk,'dd/mm/yyyy hh24:mi'),chandoan=:m_chandoan,lydo=:m_lydo,";
            sql += "ghichu=:m_ghichu,tinhtrangra=:m_tinhtrangra,mabs=:m_mabs,ngayra=to_timestamp(:m_ngayra,'dd/mm/yyyy hh24:mi')";
            sql += " where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                cmd.Parameters.Add("m_idkhoa", NpgsqlDbType.Numeric).Value = m_idkhoa;
                cmd.Parameters.Add("m_ngayvv", NpgsqlDbType.Varchar, 16).Value = m_ngayvv;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                cmd.Parameters.Add("m_ngayvk", NpgsqlDbType.Varchar, 16).Value = m_ngayvk;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_lydo", NpgsqlDbType.Numeric).Value = m_lydo;
                cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text).Value = m_ghichu;
                cmd.Parameters.Add("m_tinhtrangra", NpgsqlDbType.Text).Value = m_tinhtrangra;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_ngayra", NpgsqlDbType.Varchar, 16).Value = m_ngayra;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".xuattam(id,mabn,maql,idkhoa,ngayvv,makp,ngayvk,chandoan,lydo,ghichu,tinhtrangra,mabs,ngayra,userid)";
                    sql += "values (:m_id,:m_mabn,:m_maql,:m_idkhoa,to_timestamp(:m_ngayvv,'dd/mm/yyyy hh24:mi'),:m_makp,to_timestamp(:m_ngayvk,'dd/mm/yyyy hh24:mi'),:m_chandoan,:m_lydo,:m_ghichu,:m_tinhtrangra,:m_mabs,to_timestamp(:m_ngayra,'dd/mm/yyyy hh24:mi'),:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_idkhoa", NpgsqlDbType.Numeric).Value = m_idkhoa;
                    cmd.Parameters.Add("m_ngayvv", NpgsqlDbType.Varchar, 16).Value = m_ngayvv;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_ngayvk", NpgsqlDbType.Varchar, 16).Value = m_ngayvk;
                    cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                    cmd.Parameters.Add("m_lydo", NpgsqlDbType.Numeric).Value = m_lydo;
                    cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text).Value = m_ghichu;
                    cmd.Parameters.Add("m_tinhtrangra", NpgsqlDbType.Text).Value = m_tinhtrangra;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    cmd.Parameters.Add("m_ngayra", NpgsqlDbType.Varchar, 16).Value = m_ngayra;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "Xuattam");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_xuattam(decimal m_id, string m_ngayvao, string m_tinhtrangvao, string m_giuong, int m_idgiuong)
        {
            sql = "update " + user + ".xuattam set ngayvao=to_timestamp(:m_ngayvao,'dd/mm/yyyy hh24:mi'),";
            sql += "tinhtrangvao=:m_tinhtrangvao,giuong=:m_giuong,idgiuong=:m_idgiuong ";
            sql += "where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngayvao", NpgsqlDbType.Varchar, 16).Value = m_ngayvao;
                cmd.Parameters.Add("m_tinhtrangvao", NpgsqlDbType.Text).Value = m_tinhtrangvao;
                cmd.Parameters.Add("m_giuong", NpgsqlDbType.Varchar, 20).Value = m_giuong;
                cmd.Parameters.Add("m_idgiuong", NpgsqlDbType.Numeric).Value = m_idgiuong;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.ExecuteNonQuery();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "Xuattam");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_xuatkhoa(decimal m_id, string m_ngay, int m_ketqua, int m_ttlucrk, string m_chandoan, string m_maicd, string m_mabs, int m_bienchung, int m_taibien, int m_giaiphau, int m_userid)
        {
            sql = "update " + user + ".xuatkhoa set ngay=:m_ngay,ketqua=:m_ketqua,ttlucrk=:m_ttlucrk,";
            sql += "chandoan=:m_chandoan,maicd=:m_maicd,mabs=:m_mabs,bienchung=:m_bienchung,";
            sql += "taibien=:m_taibien,giaiphau=:m_giaiphau where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_ketqua", NpgsqlDbType.Numeric).Value = m_ketqua;
                cmd.Parameters.Add("m_ttlucrk", NpgsqlDbType.Numeric).Value = m_ttlucrk;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_bienchung", NpgsqlDbType.Numeric).Value = m_bienchung;
                cmd.Parameters.Add("m_taibien", NpgsqlDbType.Numeric).Value = m_taibien;
                cmd.Parameters.Add("m_giaiphau", NpgsqlDbType.Numeric).Value = m_giaiphau;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".xuatkhoa(id,ngay,ketqua,ttlucrk,chandoan,maicd,mabs,bienchung,taibien,giaiphau,userid,ngayud)";
                    sql += "values (:m_id,:m_ngay,:m_ketqua,:m_ttlucrk,:m_chandoan,:m_maicd,:m_mabs,:m_bienchung,:m_taibien,:m_giaiphau,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_ketqua", NpgsqlDbType.Numeric).Value = m_ketqua;
                    cmd.Parameters.Add("m_ttlucrk", NpgsqlDbType.Numeric).Value = m_ttlucrk;
                    cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                    cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    cmd.Parameters.Add("m_bienchung", NpgsqlDbType.Numeric).Value = m_bienchung;
                    cmd.Parameters.Add("m_taibien", NpgsqlDbType.Numeric).Value = m_taibien;
                    cmd.Parameters.Add("m_giaiphau", NpgsqlDbType.Numeric).Value = m_giaiphau;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "Xuatkhoa");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
                upd_hiendien(m_id, 1);
            }
            return true;
        }

        public bool upd_xuatvien(string m_mabn, decimal m_maql, string m_makp, string m_ngay, int m_ketqua, int m_ttlucrv,
            string m_chandoan, string m_maicd, string m_mabs, string m_soluutru, int m_bienchung, int m_taibien, int m_giaiphau, int m_userid)
        {
            string sql = "update " + user + ".xuatvien set makp=:m_makp,ngay=:m_ngay,";
            sql += "ketqua=:m_ketqua,ttlucrv=:m_ttlucrv,chandoan=:m_chandoan,";
            sql += "maicd=:m_maicd,mabs=:m_mabs,soluutru=:m_soluutru,bienchung=:m_bienchung,";
            sql += "taibien=:m_taibien,giaiphau=:m_giaiphau";
            sql += " where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_ketqua", NpgsqlDbType.Numeric).Value = m_ketqua;
                cmd.Parameters.Add("m_ttlucrv", NpgsqlDbType.Numeric).Value = m_ttlucrv;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_soluutru", NpgsqlDbType.Varchar, 10).Value = m_soluutru;
                cmd.Parameters.Add("m_bienchung", NpgsqlDbType.Numeric).Value = m_bienchung;
                cmd.Parameters.Add("m_taibien", NpgsqlDbType.Numeric).Value = m_taibien;
                cmd.Parameters.Add("m_giaiphau", NpgsqlDbType.Numeric).Value = m_giaiphau;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".xuatvien (mabn,maql,makp,ngay,ketqua,ttlucrv,chandoan,maicd,mabs,soluutru,bienchung,taibien,giaiphau,userid,ngayud)";
                    sql += " values (:m_mabn,:m_maql,:m_makp,:m_ngay,:m_ketqua,:m_ttlucrv,:m_chandoan,:m_maicd,:m_mabs,:m_soluutru,:m_bienchung,:m_taibien,:m_giaiphau,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_ketqua", NpgsqlDbType.Numeric).Value = m_ketqua;
                    cmd.Parameters.Add("m_ttlucrv", NpgsqlDbType.Numeric).Value = m_ttlucrv;
                    cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                    cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    cmd.Parameters.Add("m_soluutru", NpgsqlDbType.Varchar, 10).Value = m_soluutru;
                    cmd.Parameters.Add("m_bienchung", NpgsqlDbType.Numeric).Value = m_bienchung;
                    cmd.Parameters.Add("m_taibien", NpgsqlDbType.Numeric).Value = m_taibien;
                    cmd.Parameters.Add("m_giaiphau", NpgsqlDbType.Numeric).Value = m_giaiphau;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
                con.Close(); con.Dispose();
                upd_hiendien(m_maql);
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "Xuatvien");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public string get_khoaden(decimal m_id)
        {
            try
            {
                return get_data("select khoaden from " + user + ".chuyenkhoa where id=" + m_id).Tables[0].Rows[0][0].ToString();
            }
            catch { return ""; }
        }

        public string get_ngaykb(string m_ngay, decimal m_maql)
        {
            try
            {
                return get_data("select to_char(ngay,'dd/mm/yyyy hh24:mi') as ngay from " + user + mmyy(m_ngay) + ".ngaykb where maql=" + m_maql).Tables[0].Rows[0][0].ToString();
            }
            catch { return ""; }
        }

        public string get_makp(decimal m_maql)
        {
            ds = get_data("select makp from " + user + ".benhandt where maql=" + m_maql);
            return (ds.Tables[0].Rows.Count == 0) ? "" : ds.Tables[0].Rows[0][0].ToString();
        }

        public bool get_nhapkhoa(decimal m_maql)
        {
            ds = get_data("select makp from " + user + ".nhapkhoa where maql=" + m_maql);
            return ds.Tables[0].Rows.Count != 0;
        }

        public string get_tuoivao(decimal m_maql)
        {
            ds = get_data("select tuoivao from " + user + ".lienhe where maql=" + m_maql);
            return (ds.Tables[0].Rows.Count == 0) ? "" : ds.Tables[0].Rows[0][0].ToString();
        }

        public string get_tuoivao(string ngay, decimal m_maql)
        {
            ds = get_data("select tuoivao from " + user + mmyy(ngay) + ".lienhe where maql=" + m_maql);
            return (ds.Tables[0].Rows.Count == 0) ? "" : ds.Tables[0].Rows[0][0].ToString();
        }

        public int get_tyle_bhyt_chinhsach(string s_sothe)
        {
            // tính tỷ lệ chi trả cho thẻ bhyt được hưởng thêm nguồn khác chi trả 
            // vd: thẻ HN sau khi tính % chi trả dựa vào tỉ lệ thẻ thì phần bệnh nhân trả được nguồn khác chi trả với tỉ lệ khác tỷ lệ thẻ
            // tỷ lệ chi trả của nguồn khác chia ra trong tỉnh và ngoài tỉnh có thể có mức trả khác nhau
            LibDuoc.AccessData d1 = new LibDuoc.AccessData();
            try
            {
                if (s_sothe == "")
                    return 0;
                ds = get_data("select ma,tu,den,trongtinh,ngoaitinh,chieudai from " + user + ".dmloaibhyt_chinhsach where hide=0");
                int i_tu = 0, i_den = 0, i_tyle = 0;
                string s_thetrongtinh = d1.thetrongtinh(d1.get_nhomkho);
                int i_vitri_the_tu = int.Parse(d1.thetrongtinh_vitri(1).Substring(0, 1));
                int i_vitri_the_den = int.Parse(d1.thetrongtinh_vitri(1).Substring(2, 1));
                bool btrongtinh = s_thetrongtinh.IndexOf(s_sothe.Substring(i_vitri_the_tu, i_vitri_the_den)) >= 0;
                if (ds.Tables[0].Rows.Count > 0)
                {
                    foreach (DataRow r_ct in ds.Tables[0].Rows)
                    {
                        i_tu = int.Parse(r_ct["tu"].ToString());
                        i_den = int.Parse(r_ct["den"].ToString());

                        if (s_sothe.Length >= i_den && r_ct["ma"].ToString().IndexOf(s_sothe.Substring(i_tu - 1, i_den + 1 - i_tu)) >= 0 && btrongtinh)
                        {
                            i_tyle = int.Parse(r_ct["trongtinh"].ToString());
                            break;
                        }
                        else if (s_sothe.Length >= i_den && r_ct["ma"].ToString().IndexOf(s_sothe.Substring(i_tu - 1, i_den + 1 - i_tu)) >= 0 && !btrongtinh)
                        {
                            i_tyle = int.Parse(r_ct["ngoaitinh"].ToString());
                            break;
                        }
                    }
                }
                return i_tyle;
            }
            catch { return 0; }
        }



        public bool get_maql_ravien(decimal m_maql)
        {
            ds = get_data("select maql from " + user + ".xuatvien where maql=" + m_maql);
            return ds.Tables[0].Rows.Count > 0;
        }

        public decimal get_maql(string m_mabn, string m_ngay)
        {
            if (!bMmyy(mmyy(m_ngay))) return 0;
            ds = get_data("select maql from " + user + mmyy(m_ngay) + ".ngaykb where mabn='" + m_mabn + "' and to_char(ngay,'dd/mm/yyyy hh24:mi')='" + m_ngay + "'");
            decimal l_maql = (ds.Tables[0].Rows.Count == 0) ? 0 : decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            return l_maql;
        }

        public string Ngayhienhanh
        {
            get { return DateTime.Now.Day.ToString().PadLeft(2, '0') + "/" + DateTime.Now.Month.ToString().PadLeft(2, '0') + "/" + DateTime.Now.Year.ToString(); }
        }

        public string get_ngaytiepdon(string m_mabn, string m_ngay)
        {
            try
            {
                if (!bMmyy(mmyy(m_ngay))) return "";
                else return get_data("select to_char(ngay,'dd/mm/yyyy hh24:mi') from " + user + mmyy(m_ngay) + ".tiepdon where mabn='" + m_mabn + "' and to_char(ngay,'dd/mm/yyyy')='" + m_ngay.Substring(0, 10) + "' order by ngay desc").Tables[0].Rows[0][0].ToString();
            }
            catch { return ""; }
        }
        //Thuy
        public decimal get_maql_tiepdon_ngay(string m_mabn, string m_ngay)
        {
            if (!bMmyy(mmyy(m_ngay))) return 0;
            ds = get_data("select maql from " + user + mmyy(m_ngay) + ".tiepdon where mabn='" + m_mabn + "' and to_char(ngay,'dd/mm/yyyy')='" + m_ngay.Substring(0, 10) + "' and noitiepdon in (0,1,5)");
            decimal l_maql = (ds.Tables[0].Rows.Count == 0) ? 0 : decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            return l_maql;
        }

        public decimal get_maql_tiepdon(string m_mabn, string m_makp, string m_ngay)
        {
            if (!bMmyy(mmyy(m_ngay))) return 0;
            ds = get_data("select maql from " + user + mmyy(m_ngay) + ".tiepdon where mabn='" + m_mabn + "' and makp='" + m_makp + "' and to_char(ngay,'dd/mm/yyyy hh24:mi')='" + m_ngay + "'");
            decimal l_maql = (ds.Tables[0].Rows.Count == 0) ? 0 : decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            return l_maql;
        }

        public decimal get_maql(string m_mabn, string m_makp, string m_ngay)
        {
            if (!bMmyy(mmyy(m_ngay))) return 0;
            sql = "select maql from " + user + mmyy(m_ngay) + ".tiepdon where mabn='" + m_mabn + "'" + " and to_char(ngay,'dd/mm/yyyy hh24:mi')='" + m_ngay + "'";
            if (m_makp != "??") sql += " and makp='" + m_makp + "'";
            ds = get_data(sql);
            decimal l_maql = (ds.Tables[0].Rows.Count == 0) ? 0 : decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            if (l_maql == 0 && m_makp != "??") l_maql = getidyymmddhhmiss_stt_computer;//get_capid(1);
            return l_maql;
        }

        public decimal get_maql_tiepdon(string m_mabn, string m_ngay)
        {
            if (!bMmyy(mmyy(m_ngay))) return 0;
            sql = "select maql from " + user + mmyy(m_ngay) + ".tiepdon where mabn='" + m_mabn + "' and to_char(ngay,'dd/mm/yyyy hh24:mi')='" + m_ngay + "'";
            ds = get_data(sql);
            decimal l_maql = (ds.Tables[0].Rows.Count == 0) ? 0 : decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            if (l_maql == 0) l_maql = getidyymmddhhmiss_stt_computer;// get_capid(1);
            return l_maql;
        }

        public decimal get_maql_tiepdon(string m_mabn, string m_ngay, int ikhudt)
        {
            if (!bMmyy(mmyy(m_ngay))) return 0;
            sql = "select maql from " + user + mmyy(m_ngay) + ".tiepdon where mabn='" + m_mabn + "' and to_char(ngay,'dd/mm/yyyy hh24:mi')='" + m_ngay + "'";
            ds = get_data(sql);
            decimal l_maql = (ds.Tables[0].Rows.Count == 0) ? 0 : decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            if (l_maql == 0 && ikhudt == 0) l_maql = getidyymmddhhmiss_stt_computer;// get_capid(1);
            else if (l_maql == 0 && ikhudt > 0)
            {
                string tmp = getidyymmddhhmiss_stt_computer.ToString() + ikhudt.ToString().PadLeft(2, '0');
                l_maql = decimal.Parse(tmp);//getidyymmddhhmiss_stt_computer;// get_capid(1);
            }
            return l_maql;
        }

        public decimal get_maql_tiepdon_hen(string m_mabn, string m_ngay)
        {
            sql = "select maql from " + user + ".tiepdon where mabn='" + m_mabn + "' and to_char(ngay,'dd/mm/yyyy hh24:mi')='" + m_ngay + "'";
            ds = get_data(sql);
            decimal l_maql = (ds.Tables[0].Rows.Count == 0) ? 0 : decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            if (l_maql == 0) l_maql = getidyymmddhhmiss_stt_computer;// get_capid(1);
            return l_maql;
        }

        public decimal get_maql(string m_mabn, string m_makp, string m_ngay, bool save)
        {
            ds = get_data("select maql from " + user + ".benhandt where mabn='" + m_mabn + "'" + " and to_char(ngay,'dd/mm/yyyy hh24:mi')='" + m_ngay + "'");
            decimal l_maql = (ds.Tables[0].Rows.Count == 0) ? 0 : decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            if (l_maql == 0 && save) l_maql = getidyymmddhhmiss_stt_computer;// get_capid(1);
            return l_maql;
        }

        public decimal get_maql(int m_loaiba, string m_mabn, string m_makp, string m_ngay, bool save)
        {
            ds = get_data("select maql from " + user + ".benhandt where loaiba=" + m_loaiba + " and mabn='" + m_mabn + "' and to_char(ngay,'dd/mm/yyyy hh24:mi')='" + m_ngay + "'");
            decimal l_maql = (ds.Tables[0].Rows.Count == 0) ? 0 : decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            if (l_maql == 0 && save) l_maql = getidyymmddhhmiss_stt_computer;// get_capid(1);
            return l_maql;
        }

        public decimal get_maql_benhanngtr(string m_mabn, string m_ngay, bool save)
        {
            ds = get_data("select maql from " + user + ".benhanngtr where mabn='" + m_mabn + "' and to_char(ngay,'dd/mm/yyyy hh24:mi')='" + m_ngay + "'");
            decimal l_maql = (ds.Tables[0].Rows.Count == 0) ? 0 : decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            if (l_maql == 0 && save) l_maql = getidyymmddhhmiss_stt_computer;// get_capid(1);
            return l_maql;
        }

        public decimal get_maql_benhanpk(string m_mabn, string m_ngay, string m_makp, bool save)
        {
            if (!bMmyy(mmyy(m_ngay))) return 0;
            ds = get_data("select maql from " + user + mmyy(m_ngay) + ".benhanpk where mabn='" + m_mabn + "' and to_char(ngay,'dd/mm/yyyy hh24:mi')='" + m_ngay + "' and makp='" + m_makp + "'");
            decimal l_maql = (ds.Tables[0].Rows.Count == 0) ? 0 : decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            if (l_maql == 0 && save) l_maql = getidyymmddhhmiss_stt_computer;// get_capid(1);
            return l_maql;
        }

        public decimal get_maql_benhanpk(string m_mabn, string m_ngay)
        {
            if (!bMmyy(mmyy(m_ngay))) return 0;
            ds = get_data("select maql from " + user + mmyy(m_ngay) + ".benhanpk where mabn='" + m_mabn + "' and to_char(ngay,'dd/mm/yyyy hh24:mi')='" + m_ngay + "'");
            decimal l_maql = (ds.Tables[0].Rows.Count == 0) ? 0 : decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            return l_maql;
        }

        public decimal get_maql_benhanpk(string m_mabn, string m_makp, string m_ngay)
        {
            if (!bMmyy(mmyy(m_ngay))) return 0;
            ds = get_data("select maql from " + user + mmyy(m_ngay) + ".benhanpk where mabn='" + m_mabn + "' and to_char(ngay,'dd/mm/yyyy hh24:mi')='" + m_ngay + "' and makp='" + m_makp + "'");
            decimal l_maql = (ds.Tables[0].Rows.Count == 0) ? 0 : decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            return l_maql;
        }

        public decimal get_maql_benhancc(string m_mabn, string m_ngay, bool save)
        {
            ds = get_data("select maql from " + user + mmyy(m_ngay) + ".benhancc where mabn='" + m_mabn + "' and to_char(ngay,'dd/mm/yyyy hh24:mi')='" + m_ngay + "'");
            decimal l_maql = (ds.Tables[0].Rows.Count == 0) ? 0 : decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            if (l_maql == 0 && save) l_maql = getidyymmddhhmiss_stt_computer;// get_capid(1);
            return l_maql;
        }

        public decimal get_maql_ngay(int m_loaiba, string m_mabn, string m_makp, string m_ngay)
        {
            sql = "select maql from " + user + ".benhandt where loaiba=" + m_loaiba + " and mabn='" + m_mabn + "' and to_char(ngay,'dd/mm/yyyy')='" + m_ngay.Substring(0, 10) + "'";
            if (m_makp != "??") sql += " and makp='" + m_makp + "'";
            ds = get_data(sql);
            decimal l_maql = (ds.Tables[0].Rows.Count == 0) ? 0 : decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            return l_maql;
        }

        public decimal get_maql_ngay(string m_mabn, string m_makp, string m_ngay)
        {
            if (!bMmyy(mmyy(m_ngay))) return 0;
            sql = "select maql from " + user + mmyy(m_ngay) + ".benhanpk where mabn='" + m_mabn + "' and to_char(ngay,'dd/mm/yyyy')='" + m_ngay.Substring(0, 10) + "'";
            if (m_makp != "??") sql += " and makp='" + m_makp + "'";
            ds = get_data(sql);
            decimal l_maql = (ds.Tables[0].Rows.Count == 0) ? 0 : decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            return l_maql;
        }

        public decimal get_maql_ngay_makp(string m_mabn, string m_makp, string m_ngay)
        {
            if (!bMmyy(mmyy(m_ngay))) return 0;
            sql = "select maql from " + user + mmyy(m_ngay) + ".benhanpk where mabn='" + m_mabn + "' and to_char(ngay,'dd/mm/yyyy')='" + m_ngay.Substring(0, 10) + "'";
            sql += " and makp='" + m_makp + "' and to_char(ngay,'dd/mm/yyyy hh24:mi')<>'" + m_ngay + "'";
            ds = get_data(sql);
            return (ds.Tables[0].Rows.Count == 0) ? 0 : decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
        }

        public decimal get_maql(int m_loaiba, string m_mabn, string m_ngaygio, bool save)
        {
            ds = get_data("select maql from " + user + ".benhandt where loaiba=" + m_loaiba + " and mabn='" + m_mabn + "'" + " and to_char(ngay,'dd/mm/yyyy hh24:mi')='" + m_ngaygio + "'");
            decimal l_maql = (ds.Tables[0].Rows.Count == 0) ? 0 : decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            if (l_maql == 0 && save) l_maql = getidyymmddhhmiss_stt_computer;// get_capid(1);
            return l_maql;
        }

        public decimal get_maql_chuyen(decimal maql)
        {
            ds = get_data("select maqlcu,maqlmoi from " + user + ".capmaql where maqlcu=" + maql);
            if (ds.Tables[0].Rows.Count > 0) return decimal.Parse(ds.Tables[0].Rows[0]["maqlmoi"].ToString());
            else
            {
                decimal maqlmoi = getidyymmddhhmiss_stt_computer;// get_capid(1);
                sql = "insert into " + user + ".capmaql(maqlcu,maqlmoi) values (" + maql + "," + maqlmoi + ")";
                execute_data(sql);
                return maqlmoi;
            }
        }

        public decimal get_id_pttt(string m_mabn, string m_ngaygio)
        {
            if (!bMmyy(mmyy(m_ngaygio))) return 0;
            ds = get_data("select id from " + user + mmyy(m_ngaygio) + ".pttt where mabn='" + m_mabn + "'" + " and to_char(ngay,'dd/mm/yyyy hh24:mi')='" + m_ngaygio + "'");
            decimal l_id = (ds.Tables[0].Rows.Count == 0) ? 0 : decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            if (l_id == 0) l_id = getidyymmddhhmiss_stt_computer;// get_capid(6);
            return l_id;
        }

        //public decimal get_id(string m_ngay,string m_table,int i)
        //{
        //    DataSet ds=get_data("select id from	"+m_table+" where to_char(ngay,'dd/mm/yyyy')='"+m_ngay+"'");
        //    if (ds.Tables[0].Rows.Count>0) return decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
        //    else return get_capid(i);
        //}

        public decimal get_id(decimal m_maql, string m_makp, string m_ngaygio, bool save)
        {
            ds = get_data("select id from " + user + ".nhapkhoa where maql=" + m_maql + " and makp='" + m_makp + "'" + " and to_char(ngay,'dd/mm/yyyy hh24:mi')='" + m_ngaygio + "'");
            decimal l_id = (ds.Tables[0].Rows.Count == 0) ? 0 : decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            if (l_id == 0 && save) l_id = getidyymmddhhmiss_stt_computer;// get_capid(2);
            return l_id;
        }

        public decimal get_id(decimal m_maql, string m_makp, string m_ngaygio)
        {
            ds = get_data("select id from " + user + ".nhapkhoa where maql=" + m_maql + " and makp='" + m_makp + "'" + " and to_char(ngay,'dd/mm/yyyy hh24:mi')='" + m_ngaygio + "'");
            decimal l_id = (ds.Tables[0].Rows.Count == 0) ? 0 : decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            if (l_id == 0) l_id = getidyymmddhhmiss_stt_computer;// get_capid(2);
            return l_id;
        }

        public decimal get_id_cls(string m_mabn, string m_ngaygio, int i_loai, bool gio)
        {
            if (!bMmyy(mmyy(m_ngaygio))) return 0;
            sql = "select id from " + user + mmyy(m_ngaygio) + ".cls_thuchien where mabn='" + m_mabn + "' and loai=" + i_loai;
            if (gio) sql += " and to_char(ngay,'dd/mm/yyyy hh24:mi')='" + m_ngaygio + "'";
            else sql += " and to_char(ngay,'dd/mm/yyyy')='" + m_ngaygio.Substring(0, 10) + "'";
            ds = get_data(sql);
            decimal l_id = (ds.Tables[0].Rows.Count == 0) ? 0 : decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            return l_id;
        }

        public decimal get_id_cls(string m_mabn, string m_makp, string m_ngaygio, int m_loai)
        {
            if (!bMmyy(mmyy(m_ngaygio))) return 0;
            ds = get_data("select id from " + user + mmyy(m_ngaygio) + ".cls_thuchien where mabn='" + m_mabn + "' and makp='" + m_makp + "'" + " and to_char(ngay,'dd/mm/yyyy hh24:mi')='" + m_ngaygio + "' and loai=" + m_loai);
            decimal l_id = (ds.Tables[0].Rows.Count == 0) ? 0 : decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            if (l_id == 0) l_id = getidyymmddhhmiss_stt_computer;// get_capid(-3);
            return l_id;
        }

        public string get_stt_cls_ketqua_max(string m_ngay, int i_loai)
        {
            if (!bMmyy(mmyy(m_ngay))) return "001";
            int ret = 1;
            sql = "select max(to_number(substr(idcls,7,3),'999')) as so from " + user + mmyy(m_ngay) + ".cls_ketqua where loai=" + i_loai;
            sql += " and to_char(ngay,'dd/mm/yyyy')='" + m_ngay.Substring(0, 10) + "'";
            ds = get_data(sql);
            if (ds.Tables[0].Rows[0]["so"].ToString() != "") ret = int.Parse(ds.Tables[0].Rows[0]["so"].ToString()) + 1;
            return ret.ToString().PadLeft(3, '0');
        }

        public string get_stt_cls_ketqua(string m_ngay, int i_loai)
        {
            if (!bMmyy(mmyy(m_ngay))) return "001";
            int i = 1;
            sql = "select to_number(substr(idcls,7,3),'999') as so from " + user + mmyy(m_ngay) + ".cls_ketqua where loai=" + i_loai;
            sql += " and to_char(ngay,'dd/mm/yyyy')='" + m_ngay.Substring(0, 10) + "'";
            ds = get_data(sql);
            DataRow r;
            for (i = 1; i < 1000; i++)
            {
                r = getrowbyid(ds.Tables[0], "so=" + i);
                if (r == null) break;
            }
            return i.ToString().PadLeft(3, '0');
        }

        public decimal get_id_cls_ketqua(string m_mabn, string m_ngaygio, int i_loai, bool gio)
        {
            if (!bMmyy(mmyy(m_ngaygio))) return 0;
            sql = "select id from " + user + mmyy(m_ngaygio) + ".cls_ketqua where mabn='" + m_mabn + "' and loai=" + i_loai;
            if (gio) sql += " and to_char(ngay,'dd/mm/yyyy hh24:mi')='" + m_ngaygio + "'";
            else sql += " and to_char(ngay,'dd/mm/yyyy')='" + m_ngaygio.Substring(0, 10) + "'";
            ds = get_data(sql);
            decimal l_id = (ds.Tables[0].Rows.Count == 0) ? 0 : decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            return l_id;
        }

        public decimal get_id_cls_ketqua(string m_mabn, string m_ngaygio, int m_loai)
        {
            if (!bMmyy(mmyy(m_ngaygio))) return 0;
            ds = get_data("select id from " + user + mmyy(m_ngaygio) + ".cls_ketqua where mabn='" + m_mabn + "' and to_char(ngay,'dd/mm/yyyy hh24:mi')='" + m_ngaygio + "' and loai=" + m_loai);
            decimal l_id = (ds.Tables[0].Rows.Count == 0) ? 0 : decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            if (l_id == 0) l_id = getidyymmddhhmiss_stt_computer;// get_capid(-3);
            return l_id;
        }

        public decimal get_id_cls_ketqua(string m_mmyy, int m_loai, string m_idcls)
        {
            if (!bMmyy(m_mmyy)) return 0;
            ds = get_data("select id from " + user + m_mmyy + ".cls_ketqua where idcls='" + m_idcls + "' and loai=" + m_loai);
            return (ds.Tables[0].Rows.Count == 0) ? 0 : decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
        }

        public bool upd_noigioithieu(string m_ngay, decimal m_maql, string m_mabv, string m_chandoan, string m_maicd)
        {
            sql = "update " + user + mmyy(m_ngay) + ".noigioithieu set mabv=:m_mabv,chandoan=:m_chandoan,maicd=:m_maicd where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabv", NpgsqlDbType.Varchar, 10).Value = m_mabv;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + mmyy(m_ngay) + ".noigioithieu(maql,mabv,chandoan,maicd) values (:m_maql,:m_mabv,:m_chandoan,:m_maicd)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_mabv", NpgsqlDbType.Varchar, 8).Value = m_mabv;
                    cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                    cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message, sComputer, "Noigioithieu");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }


        public bool upd_noigioithieu(decimal m_maql, string m_mabv, string m_chandoan, string m_maicd)
        {
            sql = "update " + user + ".noigioithieu set mabv=:m_mabv,chandoan=:m_chandoan,maicd=:m_maicd where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabv", NpgsqlDbType.Varchar, 10).Value = m_mabv;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".noigioithieu(maql,mabv,chandoan,maicd) values (:m_maql,:m_mabv,:m_chandoan,:m_maicd)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_mabv", NpgsqlDbType.Varchar, 10).Value = m_mabv;
                    cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                    cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "Noigioithieu");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_cdkemtheo(decimal m_id, decimal m_maql, int m_loai, string m_chandoan, string m_maicd, int m_stt)
        {
            sql = "update " + user + ".cdkemtheo set chandoan=:m_chandoan,maicd=:m_maicd,maql=:m_maql where id=:m_id and loai=:m_loai and stt=:m_stt";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".cdkemtheo(id,maql,loai,chandoan,maicd,stt) values (:m_id,:m_maql,:m_loai,:m_chandoan,:m_maicd,:m_stt)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                    cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                    cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "Cdkemtheo");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_cdkemtheo(string m_ngay, decimal m_id, decimal m_maql, int m_loai, string m_chandoan, string m_maicd, int m_stt)
        {
            sql = "update " + user + mmyy(m_ngay) + ".cdkemtheo set chandoan=:m_chandoan,maicd=:m_maicd,maql=:m_maql where id=:m_id and loai=:m_loai and stt=:m_stt";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + mmyy(m_ngay) + ".cdkemtheo(id,maql,loai,chandoan,maicd,stt) values (:m_id,:m_maql,:m_loai,:m_chandoan,:m_maicd,:m_stt)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                    cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                    cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message, sComputer, "Cdkemtheo");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_cdnguyennhan(decimal m_id, decimal m_maql, string m_chandoan, string m_maicd)
        {
            sql = "update " + user + ".cdnguyennhan set chandoan=:m_chandoan,maicd=:m_maicd where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".cdnguyennhan(id,maql,chandoan,maicd) values (:m_id,:m_maql,:m_chandoan,:m_maicd)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                    cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "Cdnguyennhan");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_cdnguyennhan(string m_ngay, decimal m_id, decimal m_maql, string m_chandoan, string m_maicd)
        {
            sql = "update " + user + mmyy(m_ngay) + ".cdnguyennhan set chandoan=:m_chandoan,maicd=:m_maicd where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + mmyy(m_ngay) + ".cdnguyennhan(id,maql,chandoan,maicd) values (:m_id,:m_maql,:m_chandoan,:m_maicd)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                    cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message, sComputer, "Cdnguyennhan");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_chuyenvien(decimal m_maql, string m_lamsang, string m_xn, string m_chandoan, string m_thuoc,
            string m_tinhtrang, string m_lydo, string m_ngay, string m_vanchuyen, string m_nguoidua, int m_userid, int m_yeucau)
        {
            sql = "update " + user + ".chuyenvien set lamsang=:m_lamsang,xn=:m_xn,chandoan=:m_chandoan,thuoc=:m_thuoc,";
            sql += "tinhtrang=:m_tinhtrang,lydo=:m_lydo,ngay=to_timestamp(:m_ngay,'dd/mm/yyyy hh24:mi'),";
            sql += "vanchuyen=:m_vanchuyen,nguoidua=:m_nguoidua,userid=:m_userid, yeucau=:m_yeucau";
            sql += " where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("m_lamsang", NpgsqlDbType.Text).Value = m_lamsang;
                cmd.Parameters.Add("m_xn", NpgsqlDbType.Text).Value = m_xn;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_thuoc", NpgsqlDbType.Text).Value = m_thuoc;
                cmd.Parameters.Add("m_tinhtrang", NpgsqlDbType.Text).Value = m_tinhtrang;
                cmd.Parameters.Add("m_lydo", NpgsqlDbType.Text).Value = m_lydo;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                cmd.Parameters.Add("m_vanchuyen", NpgsqlDbType.Text).Value = m_vanchuyen;
                cmd.Parameters.Add("m_nguoidua", NpgsqlDbType.Text).Value = m_nguoidua;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_yeucau", NpgsqlDbType.Numeric).Value = m_yeucau;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "chuyenvien");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_chuyenvien(decimal m_maql, string m_mabv, int m_loaibv)
        {
            sql = "update " + user + ".chuyenvien set mabv=:m_mabv,loaibv=:m_loaibv where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabv", NpgsqlDbType.Varchar, 10).Value = m_mabv;
                cmd.Parameters.Add("m_loaibv", NpgsqlDbType.Numeric).Value = m_loaibv;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".chuyenvien(maql,mabv,loaibv) values (:m_maql,:m_mabv,:m_loaibv)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_mabv", NpgsqlDbType.Varchar, 8).Value = m_mabv;
                    cmd.Parameters.Add("m_loaibv", NpgsqlDbType.Numeric).Value = m_loaibv;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "chuyenvien");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        //Tu:30/06/2011 update ly do chuyen vien neu duyet chuyen vien co sua
        public bool upd_chuyenvien(decimal m_maql, string m_lydo)
        {
            sql = "update " + user + ".chuyenvien set lydo=:m_lydo where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_lydo", NpgsqlDbType.Text).Value = m_lydo;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "chuyenvien");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        //end Tu

        public bool upd_giayxacnhan(string m_mabn, decimal m_maql, string m_lydo, string m_phuongphap, string m_thuoc,
            decimal m_sotien, int m_userid)
        {
            sql = "update " + user + ".giayxacnhan set mabn=:m_mabn,lydo=:m_lydo,phuongphap=:m_phuongphap,thuoc=:m_thuoc,";
            sql += "sotien=:m_sotien,userid=:m_userid";
            sql += " where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Text).Value = m_mabn;
                cmd.Parameters.Add("m_lydo", NpgsqlDbType.Text).Value = m_lydo;
                cmd.Parameters.Add("m_phuongphap", NpgsqlDbType.Text).Value = m_phuongphap;
                cmd.Parameters.Add("m_thuoc", NpgsqlDbType.Text).Value = m_thuoc;
                cmd.Parameters.Add("m_sotien", NpgsqlDbType.Numeric).Value = m_sotien;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".giayxacnhan(mabn,maql,lydo,phuongphap,thuoc,sotien,userid) values (:m_mabn,:m_maql,:m_lydo,:m_phuongphap,:m_thuoc,:m_sotien,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Text).Value = m_mabn;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_lydo", NpgsqlDbType.Text).Value = m_lydo;
                    cmd.Parameters.Add("m_phuongphap", NpgsqlDbType.Text).Value = m_phuongphap;
                    cmd.Parameters.Add("m_thuoc", NpgsqlDbType.Text).Value = m_thuoc;
                    cmd.Parameters.Add("m_sotien", NpgsqlDbType.Numeric).Value = m_sotien;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "giayxacnhan");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_nuocngoai(string m_mabn, string m_id_nuoc)
        {
            sql = "update " + user + ".nuocngoai set id_nuoc=:m_id_nuoc where mabn=:m_mabn";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_id_nuoc", NpgsqlDbType.Varchar, 2).Value = m_id_nuoc;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".nuocngoai(mabn,id_nuoc) values (:m_mabn,:m_id_nuoc)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_id_nuoc", NpgsqlDbType.Varchar, 2).Value = m_id_nuoc;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "nuocngoai");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_quanhe(decimal m_maql, string m_quanhe, string m_hoten, string m_diachi, string m_dienthoai)
        {
            sql = "update " + user + ".quanhe set quanhe=:m_quanhe,hoten=:m_hoten,diachi=:m_diachi,dienthoai=:m_dienthoai";
            sql += " where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_quanhe", NpgsqlDbType.Text, 20).Value = m_quanhe;
                cmd.Parameters.Add("m_hoten", NpgsqlDbType.Text).Value = m_hoten;
                cmd.Parameters.Add("m_diachi", NpgsqlDbType.Text).Value = m_diachi;
                cmd.Parameters.Add("m_dienthoai", NpgsqlDbType.Varchar, 20).Value = m_dienthoai;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".quanhe (maql,quanhe,hoten,diachi,dienthoai) values (:m_maql,:m_quanhe,:m_hoten,:m_diachi,:m_dienthoai)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_quanhe", NpgsqlDbType.Text, 20).Value = m_quanhe;
                    cmd.Parameters.Add("m_hoten", NpgsqlDbType.Text).Value = m_hoten;
                    cmd.Parameters.Add("m_diachi", NpgsqlDbType.Text).Value = m_diachi;
                    cmd.Parameters.Add("m_dienthoai", NpgsqlDbType.Varchar, 20).Value = m_dienthoai;
                    cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "quanhe");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_hiendien(decimal m_id, string m_mabn, decimal m_mavaovien, decimal m_maql, string m_makp, string m_ngayvv, string m_ngay, string m_giuong, string m_mabs, string m_maicd, string m_noichuyen)
        {
            sql = "update " + user + ".hiendien set makp=:m_makp,ngay=:m_ngay,giuong=:m_giuong,mabs=:m_mabs,maicd=:m_maicd,noichuyen=:m_noichuyen where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_giuong", NpgsqlDbType.Varchar, 20).Value = m_giuong;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                cmd.Parameters.Add("m_noichuyen", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_noichuyen;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".hiendien(id,mabn,mavaovien,maql,makp,ngayvv,ngay,giuong,mabs,maicd,noichuyen,nhapkhoa,xuatkhoa) values (:m_id,:m_mabn,:m_mavaovien,:m_maql,:m_makp,:m_ngayvv,:m_ngay,:m_giuong,:m_mabs,:m_maicd,:m_noichuyen,0,0)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_ngayvv", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngayvv);
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_giuong", NpgsqlDbType.Varchar, 20).Value = m_giuong;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                    cmd.Parameters.Add("m_noichuyen", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_noichuyen;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "hiendien");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_hiendien(decimal m_id, string m_mabn, decimal m_mavaovien, decimal m_maql, string m_makp, string m_ngayvv, string m_ngay, string m_giuong, string m_mabs, string m_maicd, string m_noichuyen, int m_nhapkhoa, int m_xuatkhoa)
        {
            sql = "update " + user + ".hiendien set makp=:m_makp,ngay=:m_ngay,giuong=:m_giuong,mabs=:m_mabs,maicd=:m_maicd,noichuyen=:m_noichuyen,";
            sql += "nhapkhoa=:m_nhapkhoa,xuatkhoa=:m_xuatkhoa where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_giuong", NpgsqlDbType.Varchar, 20).Value = m_giuong;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                cmd.Parameters.Add("m_noichuyen", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_noichuyen;
                cmd.Parameters.Add("m_nhapkhoa", NpgsqlDbType.Numeric).Value = m_nhapkhoa;
                cmd.Parameters.Add("m_xuatkhoa", NpgsqlDbType.Numeric).Value = m_xuatkhoa;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".hiendien(id,mabn,mavaovien,maql,makp,ngayvv,ngay,giuong,mabs,maicd,noichuyen,nhapkhoa,xuatkhoa) values (:m_id,:m_mabn,:m_mavaovien,:m_maql,:m_makp,:m_ngayvv,:m_ngay,:m_giuong,:m_mabs,:m_maicd,:m_noichuyen,:m_nhapkhoa,:m_xuatkhoa)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_ngayvv", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngayvv);
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_giuong", NpgsqlDbType.Varchar, 20).Value = m_giuong;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                    cmd.Parameters.Add("m_noichuyen", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_noichuyen;
                    cmd.Parameters.Add("m_nhapkhoa", NpgsqlDbType.Numeric).Value = m_nhapkhoa;
                    cmd.Parameters.Add("m_xuatkhoa", NpgsqlDbType.Numeric).Value = m_xuatkhoa;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "hiendien");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public void upd_hiendien(decimal m_id, int m_nhapxuat)
        {
            if (m_nhapxuat == 0) sql = "update " + user + ".hiendien set nhapkhoa=1 where id=" + m_id;
            else sql = "delete from " + user + ".hiendien where id=" + m_id;
            execute_data(sql);
        }

        public void upd_hiendien(decimal m_maql)
        {
            execute_data("delete from " + user + ".hiendien where maql=" + m_maql);
        }

        public bool upd_sovaovien(decimal m_maql, string m_sovaovien)
        {
            sql = "update " + user + ".benhandt set sovaovien=:m_sovaovien where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_sovaovien", NpgsqlDbType.Varchar).Value = m_sovaovien;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "sovaovien");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_sovaovien_ngtru(decimal m_maql, string m_sovaovien)
        {
            sql = "update " + user + ".benhanngtr set sovaovien=:m_sovaovien where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_sovaovien", NpgsqlDbType.Varchar).Value = m_sovaovien;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "sovaovien");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_chuyenkhoa(decimal m_id, string m_mabn, decimal m_maql, string m_makp,
            string m_ngaychuyen, string m_khoaden, string m_chandoan, string m_maicd, int m_userid)
        {
            sql = "update " + user + ".chuyenkhoa set mabn=:m_mabn,maql=:m_maql,makp=:m_makp,ngaychuyen=:m_ngaychuyen,khoaden=:m_khoaden,";
            sql += "chandoan=:m_chandoan,maicd=:m_maicd,userid=:m_userid where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                cmd.Parameters.Add("m_ngaychuyen", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngaychuyen);
                cmd.Parameters.Add("m_khoaden", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_khoaden;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".chuyenkhoa(id,mabn,maql,makp,ngaychuyen,khoaden,chandoan,maicd,userid,ngayud)";
                    sql += " values (:m_id,:m_mabn,:m_maql,:m_makp,:m_ngaychuyen,:m_khoaden,:m_chandoan,:m_maicd,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_ngaychuyen", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngaychuyen);
                    cmd.Parameters.Add("m_khoaden", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_khoaden;
                    cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                    cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "chuyenkhoa");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_tuvong(decimal m_maql, string m_ngaynhan, string m_ngaymo, string m_chandoan,
            string m_maicd, int m_nguyennhan, string m_ghichu, int m_benhly, int m_khamtuthi, int m_userid)
        {
            if (m_ngaynhan != "")
                sql = "update " + user + ".tuvong set ngaynhan=:m_ngaynhan,ngaymo=:m_ngaymo,chandoan=:m_chandoan,";
            else
                sql = "update " + user + ".tuvong set chandoan=:m_chandoan,";
            sql += "maicd=:m_maicd,nguyennhan=:m_nguyennhan,ghichu=:m_ghichu,benhly=:m_benhly,khamtuthi=:m_khamtuthi,userid=:m_userid where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                if (m_ngaynhan != "")
                {
                    cmd.Parameters.Add("m_ngaynhan", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngaynhan);
                    cmd.Parameters.Add("m_ngaymo", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngaymo);
                }
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                cmd.Parameters.Add("m_nguyennhan", NpgsqlDbType.Numeric).Value = m_nguyennhan;
                cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text).Value = m_ghichu;
                cmd.Parameters.Add("m_benhly", NpgsqlDbType.Numeric).Value = m_benhly;
                cmd.Parameters.Add("m_khamtuthi", NpgsqlDbType.Numeric).Value = m_khamtuthi;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    if (m_ngaynhan != "")
                    {
                        sql = "insert into " + user + ".tuvong(maql,ngaynhan,ngaymo,chandoan,maicd,nguyennhan,ghichu,benhly,khamtuthi,userid,ngayud)";
                        sql += " values (:m_maql,:m_ngaynhan,:m_ngaymo,:m_chandoan,:m_maicd,:m_nguyennhan,:m_ghichu,:m_benhly,:m_khamtuthi,:m_userid,now())";
                    }
                    else
                    {
                        sql = "insert into " + user + ".tuvong(maql,chandoan,maicd,nguyennhan,ghichu,benhly,khamtuthi,userid,ngayud)";
                        sql += " values (:m_maql,:m_chandoan,:m_maicd,:m_nguyennhan,:m_ghichu,:m_benhly,:m_khamtuthi,:m_userid,now())";
                    }
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    if (m_ngaynhan != "")
                    {
                        cmd.Parameters.Add("m_ngaynhan", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngaynhan);
                        cmd.Parameters.Add("m_ngaymo", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngaymo);
                    }
                    cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                    cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                    cmd.Parameters.Add("m_nguyennhan", NpgsqlDbType.Numeric).Value = m_nguyennhan;
                    cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text).Value = m_ghichu;
                    cmd.Parameters.Add("m_benhly", NpgsqlDbType.Numeric).Value = m_benhly;
                    cmd.Parameters.Add("m_khamtuthi", NpgsqlDbType.Numeric).Value = m_khamtuthi;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "tuvong " + m_maql.ToString());
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_pttt(decimal m_id, string m_mabn, decimal m_mavaovien, decimal m_maql, string m_makp, decimal m_sophieu,
            string m_ngay, string m_chandoant, string m_maicdt, string m_chandoans,
            string m_maicds, string m_mapt, string m_tenpt, string m_phuongphap,
            int m_tinhhinh, string m_ptv, int m_taibien, int m_tuvong, int m_userid)
        {
            sql = "update " + user + mmyy(m_ngay) + ".pttt set makp=:m_makp,sophieu=:m_sophieu,ngay=:m_ngay,chandoant=:m_chandoant,";
            sql += "maicdt=:m_maicdt,chandoans=:m_chandoans,maicds=:m_maicds,mapt=:m_mapt,";
            sql += "tenpt=:m_tenpt,phuongphap=:m_phuongphap,tinhhinh=:m_tinhhinh,ptv=:m_ptv,";
            sql += "taibien=:m_taibien,tuvong=:m_tuvong,userid=:m_userid where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                cmd.Parameters.Add("m_sophieu", NpgsqlDbType.Numeric).Value = m_sophieu;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_chandoant", NpgsqlDbType.Text).Value = m_chandoant;
                cmd.Parameters.Add("m_maicdt", NpgsqlDbType.Varchar, 9).Value = m_maicdt;
                cmd.Parameters.Add("m_chandoans", NpgsqlDbType.Text).Value = m_chandoans;
                cmd.Parameters.Add("m_maicds", NpgsqlDbType.Varchar, 9).Value = m_maicds;
                cmd.Parameters.Add("m_mapt", NpgsqlDbType.Varchar, 6).Value = m_mapt;
                cmd.Parameters.Add("m_tenpt", NpgsqlDbType.Text).Value = m_tenpt;
                cmd.Parameters.Add("m_phuongphap", NpgsqlDbType.Varchar, 2).Value = m_phuongphap;
                cmd.Parameters.Add("m_tinhhinh", NpgsqlDbType.Numeric).Value = m_tinhhinh;
                cmd.Parameters.Add("m_ptv", NpgsqlDbType.Varchar, 4).Value = m_ptv;
                cmd.Parameters.Add("m_taibien", NpgsqlDbType.Numeric).Value = m_taibien;
                cmd.Parameters.Add("m_tuvong", NpgsqlDbType.Numeric).Value = m_tuvong;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + mmyy(m_ngay) + ".pttt(id,mabn,mavaovien,maql,makp,sophieu,ngay,chandoant,maicdt,chandoans,maicds,mapt,tenpt,phuongphap,tinhhinh,ptv,taibien,tuvong,userid,ngayud)";
                    sql += " values (:m_id,:m_mabn,:m_mavaovien,:m_maql,:m_makp,:m_sophieu,:m_ngay,:m_chandoant,:m_maicdt,:m_chandoans,:m_maicds,:m_mapt,:m_tenpt,:m_phuongphap,:m_tinhhinh,:m_ptv,:m_taibien,:m_tuvong,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_sophieu", NpgsqlDbType.Numeric).Value = m_sophieu;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_chandoant", NpgsqlDbType.Text).Value = m_chandoant;
                    cmd.Parameters.Add("m_maicdt", NpgsqlDbType.Varchar, 9).Value = m_maicdt;
                    cmd.Parameters.Add("m_chandoans", NpgsqlDbType.Text).Value = m_chandoans;
                    cmd.Parameters.Add("m_maicds", NpgsqlDbType.Varchar, 9).Value = m_maicds;
                    cmd.Parameters.Add("m_mapt", NpgsqlDbType.Varchar, 6).Value = m_mapt;
                    cmd.Parameters.Add("m_tenpt", NpgsqlDbType.Text).Value = m_tenpt;
                    cmd.Parameters.Add("m_phuongphap", NpgsqlDbType.Varchar, 2).Value = m_phuongphap;
                    cmd.Parameters.Add("m_tinhhinh", NpgsqlDbType.Numeric).Value = m_tinhhinh;
                    cmd.Parameters.Add("m_ptv", NpgsqlDbType.Varchar, 4).Value = m_ptv;
                    cmd.Parameters.Add("m_taibien", NpgsqlDbType.Numeric).Value = m_taibien;
                    cmd.Parameters.Add("m_tuvong", NpgsqlDbType.Numeric).Value = m_tuvong;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message, sComputer, "pttt " + m_id.ToString());
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_pttt(decimal m_id, string m_mabn, decimal m_mavaovien, decimal m_maql, string m_makp, decimal m_sophieu,
            string m_ngay, string m_chandoant, string m_maicdt, string m_chandoans,
            string m_maicds, string m_mapt, string m_tenpt, string m_phuongphap,
            int m_tinhhinh, string m_ptv, int m_taibien, int m_tuvong, int m_userid,
            string m_mamau, string m_ngaykt, decimal m_mach, decimal m_nhietdo, string m_huyetap,
            string m_phu1, string m_phu2, string m_bsgayme, string m_ktvgayme,
            string m_hoisuc, string m_dungcu, string m_noidung, int m_loaibn, string m_mapmo,
            int m_somat, int m_molaimien, decimal m_idvpkhoa, decimal m_idduoc, decimal m_idkhoa, int m_mavp, int m_madoituong, int m_loai, int m_noisoi)
        {
            sql = "update " + user + mmyy(m_ngay) + ".pttt set makp=:m_makp,sophieu=:m_sophieu,ngay=:m_ngay,chandoant=:m_chandoant,";
            sql += "maicdt=:m_maicdt,chandoans=:m_chandoans,maicds=:m_maicds,mapt=:m_mapt,";
            sql += "tenpt=:m_tenpt,phuongphap=:m_phuongphap,tinhhinh=:m_tinhhinh,ptv=:m_ptv,";
            sql += "taibien=:m_taibien,tuvong=:m_tuvong,userid=:m_userid,";
            sql += "mamau=:m_mamau,ngaykt=:m_ngaykt,mach=:m_mach,nhietdo=:m_nhietdo,";
            sql += "huyetap=:m_huyetap,phu1=:m_phu1,phu2=:m_phu2,bsgayme=:m_bsgayme,";
            sql += "ktvgayme=:m_ktvgayme,hoisuc=:m_hoisuc,dungcu=:m_dungcu,noidung=:m_noidung,";
            sql += "loaibn=:m_loaibn,mapmo=:m_mapmo,somat=:m_somat,molaimien=:m_molaimien,";
            sql += "idvpkhoa=:m_idvpkhoa,idduoc=:m_idduoc,idkhoa=:m_idkhoa,mavp=:m_mavp,madoituong=:m_madoituong,loai=:m_loai,noisoi=:m_noisoi where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                cmd.Parameters.Add("m_sophieu", NpgsqlDbType.Numeric).Value = m_sophieu;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_chandoant", NpgsqlDbType.Text).Value = m_chandoant;
                cmd.Parameters.Add("m_maicdt", NpgsqlDbType.Varchar, 9).Value = m_maicdt;
                cmd.Parameters.Add("m_chandoans", NpgsqlDbType.Text).Value = m_chandoans;
                cmd.Parameters.Add("m_maicds", NpgsqlDbType.Varchar, 9).Value = m_maicds;
                cmd.Parameters.Add("m_mapt", NpgsqlDbType.Varchar, 6).Value = m_mapt;
                cmd.Parameters.Add("m_tenpt", NpgsqlDbType.Text).Value = m_tenpt;
                cmd.Parameters.Add("m_phuongphap", NpgsqlDbType.Varchar, 2).Value = m_phuongphap;
                cmd.Parameters.Add("m_tinhhinh", NpgsqlDbType.Numeric).Value = m_tinhhinh;
                cmd.Parameters.Add("m_ptv", NpgsqlDbType.Varchar, 4).Value = m_ptv;
                cmd.Parameters.Add("m_taibien", NpgsqlDbType.Numeric).Value = m_taibien;
                cmd.Parameters.Add("m_tuvong", NpgsqlDbType.Numeric).Value = m_tuvong;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_mamau", NpgsqlDbType.Varchar, 10).Value = m_mamau;
                cmd.Parameters.Add("m_ngaykt", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngaykt);
                cmd.Parameters.Add("m_mach", NpgsqlDbType.Numeric).Value = m_mach;
                cmd.Parameters.Add("m_nhietdo", NpgsqlDbType.Numeric).Value = m_nhietdo;
                cmd.Parameters.Add("m_huyetap", NpgsqlDbType.Varchar, 7).Value = m_huyetap;
                cmd.Parameters.Add("m_phu1", NpgsqlDbType.Varchar, 4).Value = m_phu1;
                cmd.Parameters.Add("m_phu2", NpgsqlDbType.Varchar, 4).Value = m_phu2;
                cmd.Parameters.Add("m_bsgayme", NpgsqlDbType.Varchar, 4).Value = m_bsgayme;
                cmd.Parameters.Add("m_ktvgayme", NpgsqlDbType.Varchar, 4).Value = m_ktvgayme;
                cmd.Parameters.Add("m_hoisuc", NpgsqlDbType.Varchar, 4).Value = m_hoisuc;
                cmd.Parameters.Add("m_dungcu", NpgsqlDbType.Varchar, 4).Value = m_dungcu;
                cmd.Parameters.Add("m_noidung", NpgsqlDbType.Text).Value = m_noidung;
                cmd.Parameters.Add("m_loaibn", NpgsqlDbType.Numeric).Value = m_loaibn;
                cmd.Parameters.Add("m_mapmo", NpgsqlDbType.Varchar, 2).Value = m_mapmo;
                cmd.Parameters.Add("m_somat", NpgsqlDbType.Numeric).Value = m_somat;
                cmd.Parameters.Add("m_molaimien", NpgsqlDbType.Numeric).Value = m_molaimien;
                cmd.Parameters.Add("m_idvpkhoa", NpgsqlDbType.Numeric).Value = m_idvpkhoa;
                cmd.Parameters.Add("m_idduoc", NpgsqlDbType.Numeric).Value = m_idduoc;
                cmd.Parameters.Add("m_idkhoa", NpgsqlDbType.Numeric).Value = m_idkhoa;
                cmd.Parameters.Add("m_mavp", NpgsqlDbType.Numeric).Value = m_mavp;
                cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                cmd.Parameters.Add("m_noisoi", NpgsqlDbType.Numeric).Value = m_noisoi;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + mmyy(m_ngay) + ".pttt(id,mabn,mavaovien,maql,makp,sophieu,ngay,chandoant,maicdt,chandoans,maicds,mapt,tenpt,phuongphap,tinhhinh,ptv,taibien,tuvong,userid,ngayud,mamau,ngaykt,mach,nhietdo,huyetap,phu1,phu2,bsgayme,ktvgayme,hoisuc,dungcu,noidung,loaibn,mapmo,somat,molaimien,idvpkhoa,idduoc,idkhoa,mavp,madoituong,loai,noisoi)";
                    sql += " values (:m_id,:m_mabn,:m_mavaovien,:m_maql,:m_makp,:m_sophieu,:m_ngay,:m_chandoant,:m_maicdt,:m_chandoans,:m_maicds,:m_mapt,:m_tenpt,:m_phuongphap,:m_tinhhinh,:m_ptv,:m_taibien,:m_tuvong,:m_userid,now(),:m_mamau,:m_ngaykt,:m_mach,:m_nhietdo,:m_huyetap,:m_phu1,:m_phu2,:m_bsgayme,:m_ktvgayme,:m_hoisuc,:m_dungcu,:m_noidung,:m_loaibn,:m_mapmo,:m_somat,:m_molaimien,:m_idvpkhoa,:m_idduoc,:m_idkhoa,:m_mavp,:m_madoituong,:m_loai,:m_noisoi)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_sophieu", NpgsqlDbType.Numeric).Value = m_sophieu;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_chandoant", NpgsqlDbType.Text).Value = m_chandoant;
                    cmd.Parameters.Add("m_maicdt", NpgsqlDbType.Varchar, 9).Value = m_maicdt;
                    cmd.Parameters.Add("m_chandoans", NpgsqlDbType.Text).Value = m_chandoans;
                    cmd.Parameters.Add("m_maicds", NpgsqlDbType.Varchar, 9).Value = m_maicds;
                    cmd.Parameters.Add("m_mapt", NpgsqlDbType.Varchar, 6).Value = m_mapt;
                    cmd.Parameters.Add("m_tenpt", NpgsqlDbType.Text).Value = m_tenpt;
                    cmd.Parameters.Add("m_phuongphap", NpgsqlDbType.Varchar, 2).Value = m_phuongphap;
                    cmd.Parameters.Add("m_tinhhinh", NpgsqlDbType.Numeric).Value = m_tinhhinh;
                    cmd.Parameters.Add("m_ptv", NpgsqlDbType.Varchar, 4).Value = m_ptv;
                    cmd.Parameters.Add("m_taibien", NpgsqlDbType.Numeric).Value = m_taibien;
                    cmd.Parameters.Add("m_tuvong", NpgsqlDbType.Numeric).Value = m_tuvong;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    cmd.Parameters.Add("m_mamau", NpgsqlDbType.Varchar, 10).Value = m_mamau;
                    cmd.Parameters.Add("m_ngaykt", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngaykt);
                    cmd.Parameters.Add("m_mach", NpgsqlDbType.Numeric).Value = m_mach;
                    cmd.Parameters.Add("m_nhietdo", NpgsqlDbType.Numeric).Value = m_nhietdo;
                    cmd.Parameters.Add("m_huyetap", NpgsqlDbType.Varchar, 7).Value = m_huyetap;
                    cmd.Parameters.Add("m_phu1", NpgsqlDbType.Varchar, 4).Value = m_phu1;
                    cmd.Parameters.Add("m_phu2", NpgsqlDbType.Varchar, 4).Value = m_phu2;
                    cmd.Parameters.Add("m_bsgayme", NpgsqlDbType.Varchar, 4).Value = m_bsgayme;
                    cmd.Parameters.Add("m_ktvgayme", NpgsqlDbType.Varchar, 4).Value = m_ktvgayme;
                    cmd.Parameters.Add("m_hoisuc", NpgsqlDbType.Varchar, 4).Value = m_hoisuc;
                    cmd.Parameters.Add("m_dungcu", NpgsqlDbType.Varchar, 4).Value = m_dungcu;
                    cmd.Parameters.Add("m_noidung", NpgsqlDbType.Text).Value = m_noidung;
                    cmd.Parameters.Add("m_loaibn", NpgsqlDbType.Numeric).Value = m_loaibn;
                    cmd.Parameters.Add("m_mapmo", NpgsqlDbType.Varchar, 2).Value = m_mapmo;
                    cmd.Parameters.Add("m_somat", NpgsqlDbType.Numeric).Value = m_somat;
                    cmd.Parameters.Add("m_molaimien", NpgsqlDbType.Numeric).Value = m_molaimien;
                    cmd.Parameters.Add("m_idvpkhoa", NpgsqlDbType.Numeric).Value = m_idvpkhoa;
                    cmd.Parameters.Add("m_idduoc", NpgsqlDbType.Numeric).Value = m_idduoc;
                    cmd.Parameters.Add("m_idkhoa", NpgsqlDbType.Numeric).Value = m_idkhoa;
                    cmd.Parameters.Add("m_mavp", NpgsqlDbType.Numeric).Value = m_mavp;
                    cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                    cmd.Parameters.Add("m_noisoi", NpgsqlDbType.Numeric).Value = m_noisoi;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message, sComputer, "pttt " + m_id.ToString());
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_pttt_hinh(string ngay, decimal id, byte[] image1, byte[] image2)
        {
            string xxx = user + mmyy(ngay);
            sql = "update " + xxx + ".pttt_hinh set image1=:image1,image2=:image2 where id=" + id;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("image1", NpgsqlDbType.Bytea, image1.Length).Value = image1;
                cmd.Parameters.Add("image2", NpgsqlDbType.Bytea, image2.Length).Value = image2;
                int irec = cmd.ExecuteNonQuery();

                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".pttt_hinh(id,image1,image2)";
                    sql += " values (" + id + ",:image1,:image2)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("image1", NpgsqlDbType.Bytea, image1.Length).Value = image1;
                    cmd.Parameters.Add("image2", NpgsqlDbType.Bytea, image2.Length).Value = image2;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ngay, ex.Message, sComputer, "pttt_hinh");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_pttt_mau(string m_ma, string m_mapt, string m_ten, string m_mabs, string m_makp, string m_noidung, int m_userid,
            decimal m_mavp, decimal m_ptv, decimal m_phu1, decimal m_phu2, decimal m_bsgayme, decimal m_ktvgayme, decimal m_hoisuc, decimal m_dungcu, string m_mapm)
        {
            sql = "update " + user + ".pttt_mau set mapt=:m_mapt,ten=:m_ten,mabs=:m_mabs,makp=:m_makp,noidung=:m_noidung,";
            sql += "userid=:m_userid,mavp=:m_mavp,";
            sql += "ptv=:m_ptv,phu1=:m_phu1,phu2=:m_phu2,bsgayme=:m_bsgayme,";
            sql += "ktvgayme=:m_ktvgayme,hoisuc=:m_hoisuc,dungcu=:m_dungcu,mapm=:m_mapm ";
            sql += " where ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mapt", NpgsqlDbType.Varchar, 6).Value = m_mapt;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                cmd.Parameters.Add("m_noidung", NpgsqlDbType.Text).Value = m_noidung;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_mavp", NpgsqlDbType.Numeric).Value = m_mavp;
                cmd.Parameters.Add("m_ptv", NpgsqlDbType.Numeric).Value = m_ptv;
                cmd.Parameters.Add("m_phu1", NpgsqlDbType.Numeric).Value = m_phu1;
                cmd.Parameters.Add("m_phu2", NpgsqlDbType.Numeric).Value = m_phu2;
                cmd.Parameters.Add("m_bsgayme", NpgsqlDbType.Numeric).Value = m_bsgayme;
                cmd.Parameters.Add("m_ktvgayme", NpgsqlDbType.Numeric).Value = m_ktvgayme;
                cmd.Parameters.Add("m_hoisuc", NpgsqlDbType.Numeric).Value = m_hoisuc;
                cmd.Parameters.Add("m_dungcu", NpgsqlDbType.Numeric).Value = m_dungcu;
                cmd.Parameters.Add("m_mapm", NpgsqlDbType.Varchar, 2).Value = m_mapm;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 10).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".pttt_mau(ma,mapt,ten,mabs,makp,noidung,userid,mavp,ptv,phu1,phu2,bsgayme,ktvgayme,hoisuc,dungcu,mapm)";
                    sql += " values (:m_ma,:m_mapt,:m_ten,:m_mabs,:m_makp,:m_noidung,:m_userid,:m_mavp,:m_ptv,:m_phu1,:m_phu2,:m_bsgayme,:m_ktvgayme,:m_hoisuc,:m_dungcu,:m_mapm)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 10).Value = m_ma;
                    cmd.Parameters.Add("m_mapt", NpgsqlDbType.Varchar, 6).Value = m_mapt;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_noidung", NpgsqlDbType.Text).Value = m_noidung;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    cmd.Parameters.Add("m_mavp", NpgsqlDbType.Numeric).Value = m_mavp;
                    cmd.Parameters.Add("m_ptv", NpgsqlDbType.Numeric).Value = m_ptv;
                    cmd.Parameters.Add("m_phu1", NpgsqlDbType.Numeric).Value = m_phu1;
                    cmd.Parameters.Add("m_phu2", NpgsqlDbType.Numeric).Value = m_phu2;
                    cmd.Parameters.Add("m_bsgayme", NpgsqlDbType.Numeric).Value = m_bsgayme;
                    cmd.Parameters.Add("m_ktvgayme", NpgsqlDbType.Numeric).Value = m_ktvgayme;
                    cmd.Parameters.Add("m_hoisuc", NpgsqlDbType.Numeric).Value = m_hoisuc;
                    cmd.Parameters.Add("m_dungcu", NpgsqlDbType.Numeric).Value = m_dungcu;
                    cmd.Parameters.Add("m_mapm", NpgsqlDbType.Varchar, 2).Value = m_mapm;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "pttt_mau " + m_ma.ToString());
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_pttt_thuoc(string m_ma, int m_mabd, decimal m_soluong, int m_manguon, int m_madoituong)
        {
            sql = "update " + user + ".pttt_thuoc set soluong=:m_soluong,manguon=:m_manguon,madoituong=:m_madoituong";
            sql += " where ma=:m_ma and mabd=:m_mabd";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_soluong", NpgsqlDbType.Numeric).Value = m_soluong;
                cmd.Parameters.Add("m_manguon", NpgsqlDbType.Numeric).Value = m_manguon;
                cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 10).Value = m_ma;
                cmd.Parameters.Add("m_mabd", NpgsqlDbType.Numeric).Value = m_mabd;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".pttt_thuoc(ma,mabd,soluong,manguon,madoituong)";
                    sql += " values (:m_ma,:m_mabd,:m_soluong,:m_manguon,:m_madoituong)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 10).Value = m_ma;
                    cmd.Parameters.Add("m_mabd", NpgsqlDbType.Numeric).Value = m_mabd;
                    cmd.Parameters.Add("m_soluong", NpgsqlDbType.Numeric).Value = m_soluong;
                    cmd.Parameters.Add("m_manguon", NpgsqlDbType.Numeric).Value = m_manguon;
                    cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "pttt_thuoc " + m_ma.ToString());
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_pttt_lichmo(decimal m_id, string m_mabn, decimal m_maql, decimal m_idkhoa, string m_makp,
            string m_ngay, int m_stt, string m_maicd, string m_mamau, string m_phuongphap,
            string m_ptv, string m_gayme, string m_phu, int m_userid)
        {
            sql = "update " + user + mmyy(m_ngay) + ".pttt_lichmo set makp=:m_makp,ngay=:m_ngay,stt=:m_stt,";
            sql += "maicd=:m_maicd,mamau=:m_mamau,phuongphap=:m_phuongphap,ptv=:m_ptv,";
            sql += "gayme=:m_gayme,phu=:m_phu,userid=:m_userid where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                cmd.Parameters.Add("m_mamau", NpgsqlDbType.Varchar, 10).Value = m_mamau;
                cmd.Parameters.Add("m_phuongphap", NpgsqlDbType.Varchar, 2).Value = m_phuongphap;
                cmd.Parameters.Add("m_ptv", NpgsqlDbType.Varchar, 4).Value = m_ptv;
                cmd.Parameters.Add("m_gayme", NpgsqlDbType.Varchar, 4).Value = m_gayme;
                cmd.Parameters.Add("m_phu", NpgsqlDbType.Varchar, 4).Value = m_phu;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + mmyy(m_ngay) + ".pttt_lichmo(id,mabn,maql,idkhoa,makp,ngay,stt,maicd,mamau,phuongphap,ptv,gayme,phu,userid)";
                    sql += " values (:m_id,:m_mabn,:m_maql,:m_idkhoa,:m_makp,:m_ngay,:m_stt,:m_maicd,:m_mamau,:m_phuongphap,:m_ptv,:m_gayme,:m_phu,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_idkhoa", NpgsqlDbType.Numeric).Value = m_idkhoa;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                    cmd.Parameters.Add("m_mamau", NpgsqlDbType.Varchar, 10).Value = m_mamau;
                    cmd.Parameters.Add("m_phuongphap", NpgsqlDbType.Varchar, 2).Value = m_phuongphap;
                    cmd.Parameters.Add("m_ptv", NpgsqlDbType.Varchar, 4).Value = m_ptv;
                    cmd.Parameters.Add("m_gayme", NpgsqlDbType.Varchar, 4).Value = m_gayme;
                    cmd.Parameters.Add("m_phu", NpgsqlDbType.Varchar, 4).Value = m_phu;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "pttt_lichmo");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_dmbs(string m_ma, string m_hoten, string m_makp, string m_mapk, int m_nhom, string m_viettat, int m_chinhanh)
        {
            sql = "update " + user + ".dmbs set hoten=:m_hoten,makp=:m_makp,mapk=:m_mapk,nhom=:m_nhom,viettat=:m_viettat, chinhanh=:m_chinhanh where ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_hoten", NpgsqlDbType.Text).Value = m_hoten;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                cmd.Parameters.Add("m_mapk", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_mapk;
                cmd.Parameters.Add("m_nhom", NpgsqlDbType.Numeric).Value = m_nhom;
                cmd.Parameters.Add("m_viettat", NpgsqlDbType.Varchar, 10).Value = m_viettat;
                cmd.Parameters.Add("m_chinhanh", NpgsqlDbType.Numeric).Value = m_chinhanh;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 4).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dmbs(ma,hoten,makp,mapk,nhom,viettat,chinhanh)";
                    sql += " values (:m_ma,:m_hoten,:m_makp,:m_mapk,:m_nhom,:m_viettat,:m_chinhanh)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 4).Value = m_ma;
                    cmd.Parameters.Add("m_hoten", NpgsqlDbType.Text).Value = m_hoten;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_mapk", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_mapk;
                    cmd.Parameters.Add("m_nhom", NpgsqlDbType.Numeric).Value = m_nhom;
                    cmd.Parameters.Add("m_viettat", NpgsqlDbType.Varchar, 10).Value = m_viettat;
                    cmd.Parameters.Add("m_chinhanh", NpgsqlDbType.Numeric).Value = m_chinhanh;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dmbs");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }


        public bool upd_dmbs(string m_ma, string m_hoten, string m_makp, string m_mapk, int m_nhom, string m_viettat, int m_chinhanh, int m_chucdanh)
        {
            sql = "update " + user + ".dmbs set hoten=:m_hoten,makp=:m_makp,mapk=:m_mapk,nhom=:m_nhom,viettat=:m_viettat, chinhanh=:m_chinhanh,chucdanh=:m_chucdanh where ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_hoten", NpgsqlDbType.Text).Value = m_hoten;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                cmd.Parameters.Add("m_mapk", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_mapk;
                cmd.Parameters.Add("m_nhom", NpgsqlDbType.Numeric).Value = m_nhom;
                cmd.Parameters.Add("m_viettat", NpgsqlDbType.Varchar, 10).Value = m_viettat;
                cmd.Parameters.Add("m_chinhanh", NpgsqlDbType.Numeric).Value = m_chinhanh;
                cmd.Parameters.Add("m_chucdanh", NpgsqlDbType.Numeric).Value = m_chucdanh;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 4).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dmbs(ma,hoten,makp,mapk,nhom,viettat,chinhanh,chucdanh)";
                    sql += " values (:m_ma,:m_hoten,:m_makp,:m_mapk,:m_nhom,:m_viettat,:m_chinhanh,:m_chucdanh)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 4).Value = m_ma;
                    cmd.Parameters.Add("m_hoten", NpgsqlDbType.Text).Value = m_hoten;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_mapk", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_mapk;
                    cmd.Parameters.Add("m_nhom", NpgsqlDbType.Numeric).Value = m_nhom;
                    cmd.Parameters.Add("m_viettat", NpgsqlDbType.Varchar, 10).Value = m_viettat;
                    cmd.Parameters.Add("m_chinhanh", NpgsqlDbType.Numeric).Value = m_chinhanh;
                    cmd.Parameters.Add("m_chucdanh", NpgsqlDbType.Numeric).Value = m_chucdanh;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dmbs");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_dmmete(string m_ma, string m_ten)
        {
            sql = "update " + user + ".dmmete set ten=:m_ten where ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 2).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dmmete(ma,ten)";
                    sql += " values (:m_ma,:m_ten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 2).Value = m_ma;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dmmete");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_btdkp_bv(string m_table, string m_makp, string m_tenkp, int m_kehoach, int m_thucke, string m_makpbo, string m_maba, int m_loai, int m_mavp, string m_loaivp, string m_mucvp, string m_viettat, string m_loaicd, string m_muccd, string m_kho)
        {
            sql = "update " + user + "." + m_table + " set tenkp=:m_tenkp,kehoach=:m_kehoach,thucke=:m_thucke,makpbo=:m_makpbo,maba=:m_maba,loai=:m_loai,mavp=:m_mavp,loaivp=:m_loaivp,mucvp=:m_mucvp,viettat=:m_viettat,loaicd=:m_loaicd,muccd=:m_muccd,kho=:m_kho where makp=:m_makp";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_tenkp", NpgsqlDbType.Text).Value = m_tenkp;
                cmd.Parameters.Add("m_kehoach", NpgsqlDbType.Numeric).Value = m_kehoach;
                cmd.Parameters.Add("m_thucke", NpgsqlDbType.Numeric).Value = m_thucke;
                cmd.Parameters.Add("m_makpbo", NpgsqlDbType.Varchar, 2).Value = m_makpbo;
                cmd.Parameters.Add("m_maba", NpgsqlDbType.Text).Value = m_maba;
                cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                cmd.Parameters.Add("m_mavp", NpgsqlDbType.Numeric).Value = m_mavp;
                cmd.Parameters.Add("m_loaivp", NpgsqlDbType.Text).Value = m_loaivp;
                cmd.Parameters.Add("m_mucvp", NpgsqlDbType.Text).Value = m_mucvp;
                cmd.Parameters.Add("m_viettat", NpgsqlDbType.Varchar, 8).Value = m_viettat;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                cmd.Parameters.Add("m_loaicd", NpgsqlDbType.Text).Value = m_loaicd;
                cmd.Parameters.Add("m_muccd", NpgsqlDbType.Text).Value = m_muccd;
                cmd.Parameters.Add("m_kho", NpgsqlDbType.Text).Value = m_kho;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + "." + m_table + " (makp,tenkp,kehoach,thucke,makpbo,maba,loai,mavp,loaivp,mucvp,viettat,loaicd,muccd,kho) values (:m_makp,:m_tenkp,:m_kehoach,:m_thucke,:m_makpbo,:m_maba,:m_loai,:m_mavp,:m_loaivp,:m_mucvp,:m_viettat,:m_loaicd,:m_muccd,:m_kho)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_tenkp", NpgsqlDbType.Text).Value = m_tenkp;
                    cmd.Parameters.Add("m_kehoach", NpgsqlDbType.Numeric).Value = m_kehoach;
                    cmd.Parameters.Add("m_thucke", NpgsqlDbType.Numeric).Value = m_thucke;
                    cmd.Parameters.Add("m_makpbo", NpgsqlDbType.Varchar, 2).Value = m_makpbo;
                    cmd.Parameters.Add("m_maba", NpgsqlDbType.Text).Value = m_maba;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                    cmd.Parameters.Add("m_mavp", NpgsqlDbType.Numeric).Value = m_mavp;
                    cmd.Parameters.Add("m_loaivp", NpgsqlDbType.Text).Value = m_loaivp;
                    cmd.Parameters.Add("m_mucvp", NpgsqlDbType.Text).Value = m_mucvp;
                    cmd.Parameters.Add("m_viettat", NpgsqlDbType.Varchar, 8).Value = m_viettat;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_loaicd", NpgsqlDbType.Text).Value = m_loaicd;
                    cmd.Parameters.Add("m_muccd", NpgsqlDbType.Text).Value = m_muccd;
                    cmd.Parameters.Add("m_kho", NpgsqlDbType.Text).Value = m_kho;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, m_table);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_btdkp_bv(string m_table, string m_makp, string m_tenkp, int m_kehoach, int m_thucke, string m_makpbo, string m_maba, int m_loai, int m_mavp, string m_loaivp, string m_mucvp, string m_viettat, string m_loaicd, string m_muccd, int m_khudt, int m_chinhanh, int m_tiemchung, string m_kho,int m_dichvu)
        {
            sql = "update " + user + "." + m_table + " set tenkp=:m_tenkp,kehoach=:m_kehoach,thucke=:m_thucke,makpbo=:m_makpbo,maba=:m_maba,loai=:m_loai,mavp=:m_mavp,loaivp=:m_loaivp,mucvp=:m_mucvp,viettat=:m_viettat,loaicd=:m_loaicd,muccd=:m_muccd, khu=:m_khudt, chinhanh=:m_chinhanh,tiemchung=:m_tiemchung,kho=:m_kho,phongdv=:m_dichvu where makp=:m_makp";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_tenkp", NpgsqlDbType.Text).Value = m_tenkp;
                cmd.Parameters.Add("m_kehoach", NpgsqlDbType.Numeric).Value = m_kehoach;
                cmd.Parameters.Add("m_thucke", NpgsqlDbType.Numeric).Value = m_thucke;
                cmd.Parameters.Add("m_makpbo", NpgsqlDbType.Varchar, 2).Value = m_makpbo;
                cmd.Parameters.Add("m_maba", NpgsqlDbType.Text).Value = m_maba;
                cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                cmd.Parameters.Add("m_mavp", NpgsqlDbType.Numeric).Value = m_mavp;
                cmd.Parameters.Add("m_loaivp", NpgsqlDbType.Text).Value = m_loaivp;
                cmd.Parameters.Add("m_mucvp", NpgsqlDbType.Text).Value = m_mucvp;
                cmd.Parameters.Add("m_viettat", NpgsqlDbType.Varchar, 8).Value = m_viettat;

                cmd.Parameters.Add("m_loaicd", NpgsqlDbType.Text).Value = m_loaicd;
                cmd.Parameters.Add("m_muccd", NpgsqlDbType.Text).Value = m_muccd;
                cmd.Parameters.Add("m_khudt", NpgsqlDbType.Numeric).Value = m_khudt;
                cmd.Parameters.Add("m_chinhanh", NpgsqlDbType.Numeric).Value = m_chinhanh;
                cmd.Parameters.Add("m_tiemchung", NpgsqlDbType.Numeric).Value = m_tiemchung;
                cmd.Parameters.Add("m_kho", NpgsqlDbType.Text).Value = m_kho;
                cmd.Parameters.Add("m_dichvu", NpgsqlDbType.Numeric).Value = m_dichvu;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + "." + m_table + " (makp,tenkp,kehoach,thucke,makpbo,maba,loai,mavp,loaivp,mucvp,viettat,loaicd,muccd, khu, chinhanh,tiemchung,kho,phongdv) values (:m_makp,:m_tenkp,:m_kehoach,:m_thucke,:m_makpbo,:m_maba,:m_loai,:m_mavp,:m_loaivp,:m_mucvp,:m_viettat,:m_loaicd,:m_muccd,:m_khudt,:m_chinhanh,:m_tiemchung,:m_kho,:m_dichvu)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_tenkp", NpgsqlDbType.Text).Value = m_tenkp;
                    cmd.Parameters.Add("m_kehoach", NpgsqlDbType.Numeric).Value = m_kehoach;
                    cmd.Parameters.Add("m_thucke", NpgsqlDbType.Numeric).Value = m_thucke;
                    cmd.Parameters.Add("m_makpbo", NpgsqlDbType.Varchar, 2).Value = m_makpbo;
                    cmd.Parameters.Add("m_maba", NpgsqlDbType.Text).Value = m_maba;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                    cmd.Parameters.Add("m_mavp", NpgsqlDbType.Numeric).Value = m_mavp;
                    cmd.Parameters.Add("m_loaivp", NpgsqlDbType.Text).Value = m_loaivp;
                    cmd.Parameters.Add("m_mucvp", NpgsqlDbType.Text).Value = m_mucvp;
                    cmd.Parameters.Add("m_viettat", NpgsqlDbType.Varchar, 8).Value = m_viettat;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_loaicd", NpgsqlDbType.Text).Value = m_loaicd;
                    cmd.Parameters.Add("m_muccd", NpgsqlDbType.Text).Value = m_muccd;
                    cmd.Parameters.Add("m_khudt", NpgsqlDbType.Numeric).Value = m_khudt;
                    cmd.Parameters.Add("m_chinhanh", NpgsqlDbType.Numeric).Value = m_chinhanh;
                    cmd.Parameters.Add("m_tiemchung", NpgsqlDbType.Numeric).Value = m_tiemchung;
                    cmd.Parameters.Add("m_kho", NpgsqlDbType.Text).Value = m_kho;
                    cmd.Parameters.Add("m_dichvu", NpgsqlDbType.Numeric).Value = m_dichvu;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, m_table);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_btdkp_bv(string m_table, string m_makp, string m_tenkp, int m_kehoach, int m_thucke, string m_makpbo, string m_maba, int m_loai, int m_mavp, string m_loaivp, string m_mucvp, string m_viettat, string m_loaicd, string m_muccd, int m_khudt, int m_chinhanh)
        {
            sql = "update " + user + "." + m_table + " set tenkp=:m_tenkp,kehoach=:m_kehoach,thucke=:m_thucke,makpbo=:m_makpbo,maba=:m_maba,loai=:m_loai,mavp=:m_mavp,loaivp=:m_loaivp,mucvp=:m_mucvp,viettat=:m_viettat,loaicd=:m_loaicd,muccd=:m_muccd, khu=:m_khudt, chinhanh=:m_chinhanh where makp=:m_makp";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_tenkp", NpgsqlDbType.Text).Value = m_tenkp;
                cmd.Parameters.Add("m_kehoach", NpgsqlDbType.Numeric).Value = m_kehoach;
                cmd.Parameters.Add("m_thucke", NpgsqlDbType.Numeric).Value = m_thucke;
                cmd.Parameters.Add("m_makpbo", NpgsqlDbType.Varchar, 2).Value = m_makpbo;
                cmd.Parameters.Add("m_maba", NpgsqlDbType.Text).Value = m_maba;
                cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                cmd.Parameters.Add("m_mavp", NpgsqlDbType.Numeric).Value = m_mavp;
                cmd.Parameters.Add("m_loaivp", NpgsqlDbType.Text).Value = m_loaivp;
                cmd.Parameters.Add("m_mucvp", NpgsqlDbType.Text).Value = m_mucvp;
                cmd.Parameters.Add("m_viettat", NpgsqlDbType.Varchar, 8).Value = m_viettat;

                cmd.Parameters.Add("m_loaicd", NpgsqlDbType.Text).Value = m_loaicd;
                cmd.Parameters.Add("m_muccd", NpgsqlDbType.Text).Value = m_muccd;
                cmd.Parameters.Add("m_khudt", NpgsqlDbType.Numeric).Value = m_khudt;
                cmd.Parameters.Add("m_chinhanh", NpgsqlDbType.Numeric).Value = m_chinhanh;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + "." + m_table + " (makp,tenkp,kehoach,thucke,makpbo,maba,loai,mavp,loaivp,mucvp,viettat,loaicd,muccd, khu, chinhanh) values (:m_makp,:m_tenkp,:m_kehoach,:m_thucke,:m_makpbo,:m_maba,:m_loai,:m_mavp,:m_loaivp,:m_mucvp,:m_viettat,:m_loaicd,:m_muccd,:m_khudt,:m_chinhanh)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_tenkp", NpgsqlDbType.Text).Value = m_tenkp;
                    cmd.Parameters.Add("m_kehoach", NpgsqlDbType.Numeric).Value = m_kehoach;
                    cmd.Parameters.Add("m_thucke", NpgsqlDbType.Numeric).Value = m_thucke;
                    cmd.Parameters.Add("m_makpbo", NpgsqlDbType.Varchar, 2).Value = m_makpbo;
                    cmd.Parameters.Add("m_maba", NpgsqlDbType.Text).Value = m_maba;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                    cmd.Parameters.Add("m_mavp", NpgsqlDbType.Numeric).Value = m_mavp;
                    cmd.Parameters.Add("m_loaivp", NpgsqlDbType.Text).Value = m_loaivp;
                    cmd.Parameters.Add("m_mucvp", NpgsqlDbType.Text).Value = m_mucvp;
                    cmd.Parameters.Add("m_viettat", NpgsqlDbType.Varchar, 8).Value = m_viettat;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_loaicd", NpgsqlDbType.Text).Value = m_loaicd;
                    cmd.Parameters.Add("m_muccd", NpgsqlDbType.Text).Value = m_muccd;
                    cmd.Parameters.Add("m_khudt", NpgsqlDbType.Numeric).Value = m_khudt;
                    cmd.Parameters.Add("m_chinhanh", NpgsqlDbType.Numeric).Value = m_chinhanh;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, m_table);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_btdnn_bv(string m_table, string m_mann, string m_tennn, string m_mannbo)
        {
            sql = "update " + user + "." + m_table + " set tennn=:m_tennn,mannbo=:m_mannbo where mann=:m_mann";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_tennn", NpgsqlDbType.Text).Value = m_tennn;
                cmd.Parameters.Add("m_mannbo", NpgsqlDbType.Varchar, 2).Value = m_mannbo;
                cmd.Parameters.Add("m_mann", NpgsqlDbType.Varchar, 2).Value = m_mann;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + "." + m_table + " (mann,tennn,mannbo)";
                    sql += " values (:m_mann,:m_tennn,:m_mannbo)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mann", NpgsqlDbType.Varchar, 2).Value = m_mann;
                    cmd.Parameters.Add("m_tennn", NpgsqlDbType.Text).Value = m_tennn;
                    cmd.Parameters.Add("m_mannbo", NpgsqlDbType.Varchar, 2).Value = m_mannbo;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, m_table);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        //Thuy 15.05.2012
        public bool upd_btdnn_bv(string m_table, string m_mann, string m_tennn, string m_mannbo, string m_viettat)
        {
            sql = "update " + user + "." + m_table + " set tennn=:m_tennn,mannbo=:m_mannbo,viettat=:m_viettat where mann=:m_mann";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_tennn", NpgsqlDbType.Text).Value = m_tennn;
                cmd.Parameters.Add("m_mannbo", NpgsqlDbType.Varchar, 2).Value = m_mannbo;
                cmd.Parameters.Add("m_viettat", NpgsqlDbType.Varchar, 5).Value = m_viettat;
                cmd.Parameters.Add("m_mann", NpgsqlDbType.Varchar, 2).Value = m_mann;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + "." + m_table + " (mann,tennn,mannbo,viettat)";
                    sql += " values (:m_mann,:m_tennn,:m_mannbo,:m_viettat)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mann", NpgsqlDbType.Varchar, 2).Value = m_mann;
                    cmd.Parameters.Add("m_tennn", NpgsqlDbType.Text).Value = m_tennn;
                    cmd.Parameters.Add("m_mannbo", NpgsqlDbType.Varchar, 2).Value = m_mannbo;
                    cmd.Parameters.Add("m_viettat", NpgsqlDbType.Varchar, 5).Value = m_viettat;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, m_table);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        //Thuy 16.05.2012
        public bool upd_dmdiadiem(string m_table, string m_ma, string m_ten, string m_stt, string m_viettat)
        {
            sql = "update " + user + "." + m_table + " set ten=:m_ten,stt=:m_stt,viettat=:m_viettat where ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric, 3).Value = m_stt;
                cmd.Parameters.Add("m_viettat", NpgsqlDbType.Varchar, 5).Value = m_viettat;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric, 3).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + "." + m_table + " (ma,ten,stt,viettat)";
                    sql += " values (:m_ma,:m_ten,:m_stt,:m_viettat)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric, 3).Value = m_ma;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric, 3).Value = m_stt;
                    cmd.Parameters.Add("m_viettat", NpgsqlDbType.Varchar, 5).Value = m_viettat;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, m_table);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        //Thuy 30.05.2012
        public bool upd_dmnguyennhan(string m_table, string m_ma, string m_ten, string m_stt, string m_viettat, int m_tainangt)
        {
            sql = "update " + user + "." + m_table + " set ten=:m_ten,stt=:m_stt,viettat=:m_viettat,tainangt=:m_tainangt where ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric, 3).Value = m_stt;
                cmd.Parameters.Add("m_viettat", NpgsqlDbType.Varchar, 5).Value = m_viettat;
                cmd.Parameters.Add("m_tainangt", NpgsqlDbType.Numeric, 1).Value = m_tainangt;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric, 3).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + "." + m_table + " (ma,ten,stt,viettat,tainangt)";
                    sql += " values (:m_ma,:m_ten,:m_stt,:m_viettat,:m_tainangt)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric, 3).Value = m_ma;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric, 3).Value = m_stt;
                    cmd.Parameters.Add("m_viettat", NpgsqlDbType.Varchar, 5).Value = m_viettat;
                    cmd.Parameters.Add("m_tainangt", NpgsqlDbType.Numeric, 1).Value = m_tainangt;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, m_table);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool get_dasuamadt(decimal maql, decimal idkhoa)
        {
            sql = "select maql,idkhoa from " + user + ".dasuamadt where maql=" + maql;
            if (idkhoa != 0) sql += " and idkhoa=" + idkhoa;
            ds = get_data(sql);
            return ds.Tables[0].Rows.Count > 0;
        }

        public bool upd_dasuamadt(decimal m_maql, decimal m_idkhoa)
        {
            sql = "update " + user + ".dasuamadt set maql=:m_maql,idkhoa=:m_idkhoa where maql=:m_maql and idkhoa=:m_idkhoa";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                cmd.Parameters.Add("m_idkhoa", NpgsqlDbType.Numeric).Value = m_idkhoa;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dasuamadt (maql,idkhoa) values (:m_maql,:m_idkhoa)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_idkhoa", NpgsqlDbType.Numeric).Value = m_idkhoa;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dasuamadt");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_dmbenhan_bv(int m_maba, string m_mavt, int m_loaiba, string m_ten, string m_tenvt, string m_tenfile)
        {
            sql = "update " + user + ".dmbenhan_bv set mavt=:m_mavt,loaiba=:m_loaiba,ten=:m_ten,tenvt=:m_tenvt,tenfile=:m_tenfile where maba=:m_maba";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mavt", NpgsqlDbType.Varchar, 3).Value = m_mavt;
                cmd.Parameters.Add("m_loaiba", NpgsqlDbType.Numeric).Value = m_loaiba;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_tenvt", NpgsqlDbType.Text).Value = m_tenvt;
                cmd.Parameters.Add("m_tenfile", NpgsqlDbType.Varchar, 20).Value = m_tenfile;
                cmd.Parameters.Add("m_maba", NpgsqlDbType.Numeric).Value = m_maba;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dmbenhan_bv(maba,mavt,loaiba,ten,tenvt,tenfile)";
                    sql += " values (:m_maba,:m_mavt,:m_loaiba,:m_ten,:m_tenvt,:m_tenfile)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_maba", NpgsqlDbType.Numeric).Value = m_maba;
                    cmd.Parameters.Add("m_mavt", NpgsqlDbType.Varchar, 3).Value = m_mavt;
                    cmd.Parameters.Add("m_loaiba", NpgsqlDbType.Numeric).Value = m_loaiba;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    cmd.Parameters.Add("m_tenvt", NpgsqlDbType.Text).Value = m_tenvt;
                    cmd.Parameters.Add("m_tenfile", NpgsqlDbType.Varchar, 20).Value = m_tenfile;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dmbenhan_bv");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }


        public bool upd_btdvt(string m_matat, string m_daydu)
        {
            sql = "update " + user + ".btdvt set daydu=:m_daydu where lower(trim(matat))=:m_matat";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_daydu", NpgsqlDbType.Text).Value = m_daydu;
                cmd.Parameters.Add("m_matat", NpgsqlDbType.Text, 30).Value = m_matat.Trim().ToLower();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".btdvt(matat,daydu) values (:m_matat,:m_daydu)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_matat", NpgsqlDbType.Text, 30).Value = m_matat.Trim().ToLower();
                    cmd.Parameters.Add("m_daydu", NpgsqlDbType.Text).Value = m_daydu;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "btdvt");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_tttamthan(decimal m_maql, string m_vanhoa)
        {
            sql = "update " + user + ".tttamthan set vanhoa=:m_vanhoa where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_vanhoa", NpgsqlDbType.Text, 30).Value = m_vanhoa;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".tttamthan(maql,vanhoa) values (:m_maql,:m_vanhoa)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_vanhoa", NpgsqlDbType.Text, 30).Value = m_vanhoa;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "tttamthan");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_ttbong(decimal m_maql, string m_ngay)
        {
            sql = "update " + user + ".ttbong set ngay=:m_ngay where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".ttbong(maql,ngay) values (:m_maql,:m_ngay)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ttbong");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_cdsankhoa(decimal m_maql, string m_ngay, int m_kiemsoat, string m_mataibien)
        {
            sql = "update " + user + ".cdsankhoa set ngay=:m_ngay,kiemsoat=:m_kiemsoat,mataibien=:m_mataibien where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_kiemsoat", NpgsqlDbType.Numeric).Value = m_kiemsoat;
                cmd.Parameters.Add("m_mataibien", NpgsqlDbType.Varchar, 10).Value = m_mataibien;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".cdsankhoa(maql,ngay,kiemsoat,mataibien) values (:m_maql,:m_ngay,:m_kiemsoat,:m_mataibien)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_kiemsoat", NpgsqlDbType.Numeric).Value = m_kiemsoat;
                    cmd.Parameters.Add("m_mataibien", NpgsqlDbType.Varchar, 10).Value = m_mataibien;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "cdsankhoa");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_cdungbuou(decimal m_id, decimal m_maql, string m_t, string m_n, string m_m, string m_giaidoan, int m_nhapxuat)
        {
            if (m_nhapxuat == 0)
                sql = "update " + user + ".cdungbuou set t_v=:m_t,n_v=:m_n,m_v=:m_m,giaidoan_v=:m_giaidoan where id=:m_id";
            else
                sql = "update " + user + ".cdungbuou set t_r=:m_t,n_r=:m_n,m_r=:m_m,giaidoan_r=:m_giaidoan where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_t", NpgsqlDbType.Text).Value = m_t;
                cmd.Parameters.Add("m_n", NpgsqlDbType.Text).Value = m_n;
                cmd.Parameters.Add("m_m", NpgsqlDbType.Text).Value = m_m;
                cmd.Parameters.Add("m_giaidoan", NpgsqlDbType.Text).Value = m_giaidoan;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    if (m_nhapxuat == 0)
                        sql = "insert into " + user + ".cdungbuou(id,maql,t_v,n_v,m_v,giaidoan_v) values (:m_id,:m_maql,:m_t,:m_n,:m_m,:m_giaidoan)";
                    else
                        sql = "insert into " + user + ".cdungbuou(id,maql,t_r,n_r,m_r,giaidoan_r) values (:m_id,:m_maql,:m_t,:m_n,:m_m,:m_giaidoan)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_t", NpgsqlDbType.Text).Value = m_t;
                    cmd.Parameters.Add("m_n", NpgsqlDbType.Text).Value = m_n;
                    cmd.Parameters.Add("m_m", NpgsqlDbType.Text).Value = m_m;
                    cmd.Parameters.Add("m_giaidoan", NpgsqlDbType.Text).Value = m_giaidoan;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "cdungbuou");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_cdungbuou(decimal m_id, decimal m_maql, string m_t_v, string m_n_v, string m_m_v, string m_giaidoan_v, string m_t_r, string m_n_r, string m_m_r, string m_giaidoan_r)
        {
            sql = "update " + user + ".cdungbuou set t_v=:m_t_v,n_v=:m_n_v,m_v=:m_m_v,giaidoan_v=:m_giaidoan_v,";
            sql += "t_r=:m_t_r,n_r=:m_n_r,m_r=:m_m_r,giaidoan_r=:m_giaidoan_r where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_t_v", NpgsqlDbType.Text).Value = m_t_v;
                cmd.Parameters.Add("m_n_v", NpgsqlDbType.Text).Value = m_n_v;
                cmd.Parameters.Add("m_m_v", NpgsqlDbType.Text).Value = m_m_v;
                cmd.Parameters.Add("m_giaidoan_v", NpgsqlDbType.Text).Value = m_giaidoan_v;
                cmd.Parameters.Add("m_t_r", NpgsqlDbType.Text).Value = m_t_r;
                cmd.Parameters.Add("m_n_r", NpgsqlDbType.Text).Value = m_n_r;
                cmd.Parameters.Add("m_m_r", NpgsqlDbType.Text).Value = m_m_r;
                cmd.Parameters.Add("m_giaidoan_r", NpgsqlDbType.Text).Value = m_giaidoan_r;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".cdungbuou(id,maql,t_v,n_v,m_v,giaidoan_v,t_r,n_r,m_r,giaidoan_r) values ";
                    sql += "(:m_id,:m_maql,:m_t_v,:m_n_v,:m_m_v,:m_giaidoan_v,:m_t_r,:m_n_r,:m_m_r,:m_giaidoan_r)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_t_v", NpgsqlDbType.Text).Value = m_t_v;
                    cmd.Parameters.Add("m_n_v", NpgsqlDbType.Text).Value = m_n_v;
                    cmd.Parameters.Add("m_m_v", NpgsqlDbType.Text).Value = m_m_v;
                    cmd.Parameters.Add("m_giaidoan_v", NpgsqlDbType.Text).Value = m_giaidoan_v;
                    cmd.Parameters.Add("m_t_r", NpgsqlDbType.Text).Value = m_t_r;
                    cmd.Parameters.Add("m_n_r", NpgsqlDbType.Text).Value = m_n_r;
                    cmd.Parameters.Add("m_m_r", NpgsqlDbType.Text).Value = m_m_r;
                    cmd.Parameters.Add("m_giaidoan_r", NpgsqlDbType.Text).Value = m_giaidoan_r;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "cdungbuou");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_hcnhi(string m_mabn, string m_hoten_bo, string m_vanhoa_bo, string m_mann_bo,
            string m_hoten_me, string m_vanhoa_me, string m_mann_me)
        {
            sql = "update " + user + ".hcnhi set hoten_bo=:m_hoten_bo,vanhoa_bo=:m_vanhoa_bo,mann_bo=:m_mann_bo,";
            sql += "hoten_me=:m_hoten_me,vanhoa_me=:m_vanhoa_me,mann_me=:m_mann_me where mabn=:m_mabn";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_hoten_bo", NpgsqlDbType.Text).Value = m_hoten_bo;
                cmd.Parameters.Add("m_vanhoa_bo", NpgsqlDbType.Text, 30).Value = m_vanhoa_bo;
                cmd.Parameters.Add("m_mann_bo", NpgsqlDbType.Text, 2).Value = m_mann_bo;
                cmd.Parameters.Add("m_hoten_me", NpgsqlDbType.Text).Value = m_hoten_me;
                cmd.Parameters.Add("m_vanhoa_me", NpgsqlDbType.Text, 30).Value = m_vanhoa_me;
                cmd.Parameters.Add("m_mann_me", NpgsqlDbType.Text, 2).Value = m_mann_me;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".hcnhi(mabn,hoten_bo,vanhoa_bo,mann_bo,hoten_me,vanhoa_me,mann_me) values ";
                    sql += "(:m_mabn,:m_hoten_bo,:m_vanhoa_bo,:m_mann_bo,:m_hoten_me,:m_vanhoa_me,:m_mann_me)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_hoten_bo", NpgsqlDbType.Text).Value = m_hoten_bo;
                    cmd.Parameters.Add("m_vanhoa_bo", NpgsqlDbType.Text, 30).Value = m_vanhoa_bo;
                    cmd.Parameters.Add("m_mann_bo", NpgsqlDbType.Text, 2).Value = m_mann_bo;
                    cmd.Parameters.Add("m_hoten_me", NpgsqlDbType.Text).Value = m_hoten_me;
                    cmd.Parameters.Add("m_vanhoa_me", NpgsqlDbType.Text, 30).Value = m_vanhoa_me;
                    cmd.Parameters.Add("m_mann_me", NpgsqlDbType.Text, 2).Value = m_mann_me;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "hcnhi");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_hcsosinh(string m_mabn, string m_hoten_me, string m_ns_me, string m_mann_me,
            int m_delan, string m_hoten_bo, string m_ns_bo, string m_mann_bo, int m_nhommau, string m_para, string m_mame)
        {
            sql = "update " + user + ".hcsosinh set hoten_me=:m_hoten_me,mann_me=:m_mann_me,delan=:m_delan,";
            sql += "ns_me=:m_ns_me,ns_bo=:m_ns_bo,";
            sql += "hoten_bo=:m_hoten_bo,mann_bo=:m_mann_bo,nhommau=:m_nhommau,para=:m_para";
            if (m_mame != "") sql += ",mame=:m_mame ";
            sql += " where mabn=:m_mabn";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_hoten_me", NpgsqlDbType.Text).Value = m_hoten_me;
                cmd.Parameters.Add("m_mann_me", NpgsqlDbType.Text, 2).Value = m_mann_me;
                cmd.Parameters.Add("m_delan", NpgsqlDbType.Numeric).Value = m_delan;
                cmd.Parameters.Add("m_ns_me", NpgsqlDbType.Varchar, 4).Value = m_ns_me;
                cmd.Parameters.Add("m_ns_bo", NpgsqlDbType.Varchar, 4).Value = m_ns_bo;
                cmd.Parameters.Add("m_hoten_bo", NpgsqlDbType.Text).Value = m_hoten_bo;
                cmd.Parameters.Add("m_mann_bo", NpgsqlDbType.Text, 2).Value = m_mann_bo;
                cmd.Parameters.Add("m_nhommau", NpgsqlDbType.Numeric).Value = m_nhommau;
                cmd.Parameters.Add("m_para", NpgsqlDbType.Text, 8).Value = m_para;
                if (m_mame != "") cmd.Parameters.Add("m_mame", NpgsqlDbType.Varchar).Value = m_mame;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    if (m_mame != "")
                    {
                        sql = "insert into " + user + ".hcsosinh(mabn,hoten_me,mann_me,delan,ns_me,ns_bo,";
                        sql += "hoten_bo,mann_bo,nhommau,para,mame) values ";
                        sql += "(:m_mabn,:m_hoten_me,:m_mann_me,:m_delan,:m_ns_me,:m_ns_bo,";
                        sql += ":m_hoten_bo,:m_mann_bo,:m_nhommau,:m_para,:m_mame)";
                    }
                    else
                    {
                        sql = "insert into " + user + ".hcsosinh(mabn,hoten_me,mann_me,delan,ns_me,ns_bo,";
                        sql += "hoten_bo,mann_bo,nhommau,para) values ";
                        sql += "(:m_mabn,:m_hoten_me,:m_mann_me,:m_delan,:m_ns_me,:m_ns_bo,";
                        sql += ":m_hoten_bo,:m_mann_bo,:m_nhommau,:m_para)";
                    }
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_hoten_me", NpgsqlDbType.Text).Value = m_hoten_me;
                    cmd.Parameters.Add("m_mann_me", NpgsqlDbType.Text, 2).Value = m_mann_me;
                    cmd.Parameters.Add("m_delan", NpgsqlDbType.Numeric).Value = m_delan;
                    cmd.Parameters.Add("m_ns_me", NpgsqlDbType.Varchar, 4).Value = m_ns_me;
                    cmd.Parameters.Add("m_ns_bo", NpgsqlDbType.Varchar, 4).Value = m_ns_bo;
                    cmd.Parameters.Add("m_hoten_bo", NpgsqlDbType.Text).Value = m_hoten_bo;
                    cmd.Parameters.Add("m_mann_bo", NpgsqlDbType.Text, 2).Value = m_mann_bo;
                    cmd.Parameters.Add("m_nhommau", NpgsqlDbType.Numeric).Value = m_nhommau;
                    cmd.Parameters.Add("m_para", NpgsqlDbType.Text, 8).Value = m_para;
                    if (m_mame != "") cmd.Parameters.Add("m_mame", NpgsqlDbType.Varchar).Value = m_mame;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "hcsosinh");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }


        public bool upd_tresosinh(decimal m_id_ss, decimal m_maql, string m_ngay, string m_ngoithai,
            int m_phai, int m_tinhtrang, int m_ditat, int m_cannang, int m_userid)
        {
            sql = "update " + user + ".tresosinh set ngay=:m_ngay,ngoithai=:m_ngoithai,phai=:m_phai,";
            sql += "tinhtrang=:m_tinhtrang,ditat=:m_ditat,cannang=:m_cannang,userid=:m_userid where id_ss=:m_id_ss";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_ngoithai", NpgsqlDbType.Text).Value = m_ngoithai;
                cmd.Parameters.Add("m_phai", NpgsqlDbType.Numeric).Value = m_phai;
                cmd.Parameters.Add("m_tinhtrang", NpgsqlDbType.Numeric).Value = m_tinhtrang;
                cmd.Parameters.Add("m_ditat", NpgsqlDbType.Numeric).Value = m_ditat;
                cmd.Parameters.Add("m_cannang", NpgsqlDbType.Numeric).Value = m_cannang;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id_ss", NpgsqlDbType.Numeric).Value = m_id_ss;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".tresosinh(id_ss,maql,ngay,ngoithai,phai,tinhtrang,ditat,cannang,userid,ngayud) values ";
                    sql += "(:m_id_ss,:m_maql,:m_ngay,:m_ngoithai,:m_phai,:m_tinhtrang,:m_ditat,:m_cannang,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id_ss", NpgsqlDbType.Numeric).Value = m_id_ss;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_ngoithai", NpgsqlDbType.Text).Value = m_ngoithai;
                    cmd.Parameters.Add("m_phai", NpgsqlDbType.Numeric).Value = m_phai;
                    cmd.Parameters.Add("m_tinhtrang", NpgsqlDbType.Numeric).Value = m_tinhtrang;
                    cmd.Parameters.Add("m_ditat", NpgsqlDbType.Numeric).Value = m_ditat;
                    cmd.Parameters.Add("m_cannang", NpgsqlDbType.Numeric).Value = m_cannang;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "tresosinh");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_ngaykb(decimal m_maql, string m_mabn, string m_ngay)
        {
            sql = "update " + user + mmyy(m_ngay) + ".ngaykb set mabn=:m_mabn,ngay=:m_ngay where maql=:m_maql";
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + mmyy(m_ngay) + ".ngaykb(maql,mabn,ngay) values (:m_maql,:m_mabn,:m_ngay)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message, sComputer, "ngaykb");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        public void updrec_11(DataTable dt, string stt, string c01, string c02, string c03, string c04, string c05, string c06, string c07, string c08, string c09, string c10, string c11, string c12)
        {
            string exp = "stt='" + stt + "'";
            DataRow[] dr = dt.Select(exp);
            if (dr.Length != 0)
            {
                dr[0]["c01"] = c01;
                dr[0]["c02"] = c02;
                dr[0]["c03"] = c03;
                dr[0]["c04"] = c04;
                dr[0]["c05"] = c05;
                dr[0]["c06"] = c06;
                dr[0]["c07"] = c07;
                dr[0]["c08"] = c08;
                dr[0]["c09"] = c09;
                dr[0]["c10"] = c10;
                dr[0]["c11"] = c11;
                dr[0]["c12"] = c12;
            }
        }

        public void updrec_11_18(DataTable dt, string stt, string c01, string c02, string c03, string c04, string c05, string c06, string c07, string c08, string c09, string c10, string c11, string c12, string c041, string c051, string c15, string c16, string c17, string c18)
        {
            string exp = "stt='" + stt + "'";
            DataRow[] dr = dt.Select(exp);
            if (dr.Length != 0)
            {
                dr[0]["c01"] = c01;
                dr[0]["c02"] = c02;
                dr[0]["c03"] = c03;
                dr[0]["c04"] = c04;
                dr[0]["c05"] = c05;
                dr[0]["c06"] = c06;
                dr[0]["c07"] = c07;
                dr[0]["c08"] = c08;
                dr[0]["c09"] = c09;
                dr[0]["c10"] = c10;
                dr[0]["c11"] = c11;
                dr[0]["c12"] = c12;
                dr[0]["c041"] = c041;
                dr[0]["c051"] = c051;
                dr[0]["c15"] = c15;
                dr[0]["c16"] = c16;
                dr[0]["c17"] = c17;
                dr[0]["c18"] = c18;
            }
        }
        public void updrec_01(DataTable dt, string stt, int col, decimal so)
        {
            decimal l = 0;
            DataRow[] dr = dt.Select("stt='" + stt + "'");
            if (dr.Length != 0) dr[0][col] = so;
            dr = dt.Select("stt='B'");
            if (dr.Length != 0) l += decimal.Parse(dr[0][col].ToString());
            dr = dt.Select("stt='C'");
            if (dr.Length != 0) l += decimal.Parse(dr[0][col].ToString());
            dr = dt.Select("stt='D'");
            if (dr.Length != 0) l += decimal.Parse(dr[0][col].ToString());
            dr = dt.Select("stt='A'");
            if (dr.Length != 0) dr[0][col] = l;
        }

        public void updrec_05(DataTable dt, string stt, int col, decimal so)
        {
            Decimal l = 0;
            DataRow[] dr = dt.Select("stt='" + stt + "'");
            if (dr.Length != 0) dr[0][col] = so;
            dr = dt.Select("stt='B'");
            if (dr.Length != 0) l += Decimal.Parse(dr[0][col].ToString());
            dr = dt.Select("stt='C'");
            if (dr.Length != 0) l += Decimal.Parse(dr[0][col].ToString());
            dr = dt.Select("stt='A'");
            if (dr.Length != 0) dr[0][col] = l;
        }

        public void updrec_06(DataTable dt, string stt, int col, decimal so)
        {
            Decimal l = 0;
            DataRow[] dr = dt.Select("stt='" + stt + "'");
            if (dr.Length != 0) dr[0][col] = so;
            dr = dt.Select("stt='B'");
            if (dr.Length != 0) l += Decimal.Parse(dr[0][col].ToString());
            dr = dt.Select("stt='C'");
            if (dr.Length != 0) l += Decimal.Parse(dr[0][col].ToString());
            dr = dt.Select("stt='E'");
            if (dr.Length != 0) l += Decimal.Parse(dr[0][col].ToString());
            dr = dt.Select("stt='F'");
            if (dr.Length != 0) l += Decimal.Parse(dr[0][col].ToString());
            dr = dt.Select("stt='A'");
            if (dr.Length != 0) dr[0][col] = l;
        }

        #region vudieutri
        /// <summary>
        /// 
        /// </summary>
        /// 
        public int get_stt(DataTable dt)
        {
            try
            {
                if (dt.Rows.Count == 0) return 1;
                else return int.Parse(dt.Rows[dt.Rows.Count - 1]["stt"].ToString()) + 1;
            }
            catch { return 1; }
        }

        public void updrec_bieu(DataTable dt, decimal ma, string ten, decimal so)
        {
            string exp = "ma=" + ma;
            DataRow r = getrowbyid(dt, exp);
            if (r == null)
            {
                DataRow nrow = dt.NewRow();
                nrow["ma"] = ma;
                nrow["stt"] = get_stt(dt);
                nrow["ten"] = ten;
                for (int i = 1; i <= so; i++) nrow["c" + i.ToString().PadLeft(2, '0')] = 0;
                dt.Rows.Add(nrow);
            }
        }

        public bool upd_dm01(int m_ma, string m_stt, string m_ten, string m_loai, int m_kp, int m_matk)
        {
            sql = "update " + user + ".dm_01 set stt=:m_stt,ten=:m_ten,loai=:m_loai,kp=:m_kp,matk=:m_matk where ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Varchar, 2).Value = m_stt;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_loai", NpgsqlDbType.Varchar, 1).Value = m_loai;
                cmd.Parameters.Add("m_kp", NpgsqlDbType.Numeric).Value = m_kp;
                cmd.Parameters.Add("m_matk", NpgsqlDbType.Numeric).Value = m_matk;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dm_01(ma,stt,ten,loai,kp,matk,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,c13,c14,c15,c16,c17,c18,c19,c20,c21,c22,c23) values ";
                    sql += "(:m_ma,:m_stt,:m_ten,:m_loai,:m_kp,:m_matk,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Varchar, 2).Value = m_stt;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Varchar, 1).Value = m_loai;
                    cmd.Parameters.Add("m_kp", NpgsqlDbType.Numeric).Value = m_kp;
                    cmd.Parameters.Add("m_matk", NpgsqlDbType.Numeric).Value = m_matk;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dm_01");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_bieu01(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02, int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09, int m_c10, int m_c11, int m_c12, int m_c13, int m_c14, int m_c15, int m_c16, int m_c17, int m_c18, int m_c19, int m_c20, int m_c21, int m_c22, int m_c23, int m_userid)
        {
            sql = "update " + user + ".bieu_01 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,";
            sql += "c11=:m_c11,c12=:m_c12,c13=:m_c13,c14=:m_c14,c15=:m_c15,";
            sql += "c16=:m_c16,c17=:m_c17,c18=:m_c18,c19=:m_c19,c20=:m_c20,c21=:m_c21,";
            sql += "c22=:m_c22,c23=:m_c23,userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                cmd.Parameters.Add("m_c20", NpgsqlDbType.Numeric).Value = m_c20;
                cmd.Parameters.Add("m_c21", NpgsqlDbType.Numeric).Value = m_c21;
                cmd.Parameters.Add("m_c22", NpgsqlDbType.Numeric).Value = m_c22;
                cmd.Parameters.Add("m_c23", NpgsqlDbType.Numeric).Value = m_c23;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".bieu_01(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,c13,c14,c15,c16,c17,c18,c19,c20,c21,c22,c23,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_c11,:m_c12,:m_c13,:m_c14,:m_c15,:m_c16,:m_c17,:m_c18,:m_c19,:m_c20,:m_c21,:m_c22,:m_c23,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                    cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                    cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                    cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                    cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                    cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                    cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                    cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                    cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                    cmd.Parameters.Add("m_c20", NpgsqlDbType.Numeric).Value = m_c20;
                    cmd.Parameters.Add("m_c21", NpgsqlDbType.Numeric).Value = m_c21;
                    cmd.Parameters.Add("m_c22", NpgsqlDbType.Numeric).Value = m_c22;
                    cmd.Parameters.Add("m_c23", NpgsqlDbType.Numeric).Value = m_c23;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "bieu_01");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public void updrec_145(DataTable dt, int stt, int col, Decimal so)
        {
            try
            {
                DataRow[] dr = dt.Select("ma=" + stt);
                if (dr.Length > 0)
                {
                    dr[0][col] = so;
                }
            }
            catch { }
        }

        public void updrec_02(DataTable dt, string stt, int col, Decimal so)
        {
            try
            {
                DataRow[] dr = dt.Select("stt='" + stt + "'");
                if (dr.Length > 0)
                {
                    dr[0][col] = so;
                }
            }
            catch { }
        }

        public void updrec_07(DataTable dt, int ma, int col, decimal so)
        {
            DataRow[] dr = dt.Select("ma=" + ma);
            dr[0][col] = so;
        }

        public bool upd_bieu02(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09, int m_userid)
        {
            sql = "update " + user + ".bieu_02 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,";
            sql += "userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".bieu_02(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "bieu_02");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_bieu031(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09,
            int m_c10, int m_c11, int m_userid)
        {
            sql = "update " + user + ".bieu_031 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,c11=:m_c11,";
            sql += "userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".bieu_031(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_c11,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "bieu_031");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_bieu04(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09,
            int m_c10, int m_userid)
        {
            sql = "update " + user + ".bieu_04 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,";
            sql += "userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".bieu_04(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "bieu_04");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_bieu05(decimal m_id, int m_ma, string m_ngay, int m_soluong, int m_userid)
        {
            sql = "update " + user + ".bieu_05 set ngay=:m_ngay,soluong=:m_soluong,";
            sql += "userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_soluong", NpgsqlDbType.Numeric).Value = m_soluong;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".bieu_05(id,ma,ngay,soluong,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_soluong,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_soluong", NpgsqlDbType.Numeric).Value = m_soluong;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "bieu_05");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_bieu06(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02, int m_userid)
        {
            sql = "update " + user + ".bieu_06 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,";
            sql += "userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".bieu_06(id,ma,ngay,c01,c02,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "bieu_06");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }


        public bool upd_bieu07(decimal m_id, int m_ma, string m_ngay, Decimal m_soluong, int m_userid)
        {
            sql = "update " + user + ".bieu_07 set ngay=:m_ngay,soluong=:m_soluong,";
            sql += "userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_soluong", NpgsqlDbType.Numeric).Value = m_soluong;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".bieu_07(id,ma,ngay,soluong,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_soluong,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_soluong", NpgsqlDbType.Numeric).Value = m_soluong;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "bieu_07");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_bieu08(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_userid)
        {
            sql = "update " + user + ".bieu_08 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,";
            sql += "userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".bieu_08(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "bieu_08");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_bieu091(decimal m_id, int m_ma, string m_ngay, int m_tongso, int m_userid)
        {
            sql = "update " + user + ".bieu_091 set ngay=:m_ngay,tongso=:m_tongso,";
            sql += "userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_tongso", NpgsqlDbType.Numeric).Value = m_tongso;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".bieu_091(id,ma,ngay,tongso,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_tongso,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_tongso", NpgsqlDbType.Numeric).Value = m_tongso;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "bieu_091");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_bieu092(decimal m_id, int m_ma, string m_ngay, string m_ten, Decimal m_c01, int m_c02,
            int m_c03, int m_c04, int m_userid)
        {
            sql = "update " + user + ".bieu_092 set ngay=:m_ngay,ten=:m_ten,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".bieu_092(id,ma,ngay,ten,c01,c02,c03,c04,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_ten,:m_c01,:m_c02,:m_c03,:m_c04,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "bieu_092");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_bieu11(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09,
            int m_c10, int m_c11, int m_c12, int m_userid)
        {
            sql = "update " + user + ".bieu_11 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,c11=:m_c11,";
            sql += "c12=:m_c12,userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".bieu_11(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_c11,:m_c12,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                    cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "bieu_11");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_bieu11_1(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
           int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09,
           int m_c10, int m_c11, int m_c12, int m_userid)
        {
            sql = "update " + user + ".bieu_11_1 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,c11=:m_c11,";
            sql += "c12=:m_c12,userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".bieu_11_1(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_c11,:m_c12,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                    cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "bieu_11_1");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_bieu11_18(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09,
            int m_c10, int m_c11, int m_c12, int m_userid, int m_c041, int m_c051, int m_c15, int m_c16, int m_c17, int m_c18)
        {
            sql = "update " + user + ".bieu_11 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,c11=:m_c11,";
            sql += "c12=:m_c12,c041=:m_c041,c051=:m_c051,c15=:m_c15,c16=:m_c16,c17=:m_c17,c18=:m_c18,userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                cmd.Parameters.Add("m_c041", NpgsqlDbType.Numeric).Value = m_c041;
                cmd.Parameters.Add("m_c051", NpgsqlDbType.Numeric).Value = m_c051;
                cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".bieu_11(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,c041,c051,c15,c16,c17,c18,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_c11,:m_c12,:m_c041,:m_c051,:m_c15,:m_c16,:m_c17,:m_c18,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                    cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                    cmd.Parameters.Add("m_c041", NpgsqlDbType.Numeric).Value = m_c041;
                    cmd.Parameters.Add("m_c051", NpgsqlDbType.Numeric).Value = m_c051;
                    cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                    cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                    cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                    cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "bieu_11_18");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_bieu11_18_2010(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09,
            int m_c10, int m_c11, int m_c12, int m_userid, int m_c041, int m_c051, int m_c15, int m_c16, int m_c17, int m_c18)
        {
            sql = "update " + user + ".bieu_11_1 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,c11=:m_c11,";
            sql += "c12=:m_c12,c041=:m_c041,c051=:m_c051,c15=:m_c15,c16=:m_c16,c17=:m_c17,c18=:m_c18,userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                cmd.Parameters.Add("m_c041", NpgsqlDbType.Numeric).Value = m_c041;
                cmd.Parameters.Add("m_c051", NpgsqlDbType.Numeric).Value = m_c051;
                cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".bieu_11_1(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,c041,c051,c15,c16,c17,c18,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_c11,:m_c12,:m_c041,:m_c051,:m_c15,:m_c16,:m_c17,:m_c18,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                    cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                    cmd.Parameters.Add("m_c041", NpgsqlDbType.Numeric).Value = m_c041;
                    cmd.Parameters.Add("m_c051", NpgsqlDbType.Numeric).Value = m_c051;
                    cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                    cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                    cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                    cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "bieu_11_18_2010");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_bieu101(decimal m_id, int m_ma, string m_ngay, Decimal m_sotien, int m_userid)
        {
            sql = "update " + user + ".bieu_101 set ngay=:m_ngay,sotien=:m_sotien,";
            sql += "userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_sotien", NpgsqlDbType.Numeric).Value = m_sotien;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".bieu_101(id,ma,ngay,sotien,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_sotien,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_sotien", NpgsqlDbType.Numeric).Value = m_sotien;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "bieu_101");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }


        public bool upd_bieu1021(decimal m_id, int m_ma, string m_ngay, Decimal m_vienphi, Decimal m_bhyt, int m_userid)
        {
            sql = "update " + user + ".bieu_1021 set ngay=:m_ngay,vienphi=:m_vienphi,";
            sql += "bhyt=:m_bhyt,userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_vienphi", NpgsqlDbType.Numeric).Value = m_vienphi;
                cmd.Parameters.Add("m_bhyt", NpgsqlDbType.Numeric).Value = m_bhyt;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".bieu_1021(id,ma,ngay,vienphi,bhyt,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_vienphi,:m_bhyt,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_vienphi", NpgsqlDbType.Numeric).Value = m_vienphi;
                    cmd.Parameters.Add("m_bhyt", NpgsqlDbType.Numeric).Value = m_bhyt;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "bieu_1021");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_bieu1022(decimal m_id, int m_ma, string m_ngay, Decimal m_sotien, int m_userid)
        {
            sql = "update " + user + ".bieu_1022 set ngay=:m_ngay,sotien=:m_sotien,";
            sql += "userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_sotien", NpgsqlDbType.Numeric).Value = m_sotien;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".bieu_1022(id,ma,ngay,sotien,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_sotien,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_sotien", NpgsqlDbType.Numeric).Value = m_sotien;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "bieu_1022");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_bieu103(decimal m_id, int m_ma, string m_ngay, Decimal m_c01, Decimal m_c02,
            Decimal m_c03, Decimal m_c04, Decimal m_c05, Decimal m_c06, int m_userid)
        {
            sql = "update " + user + ".bieu_103 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,";
            sql += "userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".bieu_103(id,ma,ngay,c01,c02,c03,c04,c05,c06,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "bieu_103");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        #endregion

        public bool upd_dlogin(int m_id, string m_hoten, string m_userid, string m_password, int m_manhom, string m_makp, string m_right, string m_madoituong, string m_nhomkho, string m_cls, string m_mabs, string m_may)
        {
            sql = "update " + user + ".dlogin set hoten=:m_hoten,userid=:m_userid,password_=:m_password,manhom=:m_manhom";
            sql += ",makp=:m_makp,right_=:m_right,madoituong=:m_madoituong,nhomkho=:m_nhomkho,cls=:m_cls,mabs=:m_mabs,may=:m_may";
            sql += " where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_hoten", NpgsqlDbType.Text).Value = m_hoten;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Varchar, 10).Value = m_userid;
                cmd.Parameters.Add("m_password", NpgsqlDbType.Varchar, 10).Value = m_password;
                cmd.Parameters.Add("m_manhom", NpgsqlDbType.Numeric).Value = m_manhom;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Text).Value = m_makp;
                cmd.Parameters.Add("m_right", NpgsqlDbType.Text).Value = m_right;
                cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Text).Value = m_madoituong;
                cmd.Parameters.Add("m_nhomkho", NpgsqlDbType.Text).Value = m_nhomkho;
                cmd.Parameters.Add("m_cls", NpgsqlDbType.Text).Value = m_cls;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_may", NpgsqlDbType.Text).Value = m_may;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dlogin(id,hoten,userid,password_,manhom";
                    sql += ",makp,right_,madoituong,nhomkho,cls,mabs,may";
                    sql += ") values ";
                    sql += "(:m_id,:m_hoten,:m_userid,:m_password,:m_manhom";
                    sql += ",:m_makp,:m_right,:m_madoituong,:m_nhomkho,:m_cls,:m_mabs,:m_may";
                    sql += ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_hoten", NpgsqlDbType.Text).Value = m_hoten;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Varchar, 10).Value = m_userid;
                    cmd.Parameters.Add("m_password", NpgsqlDbType.Varchar, 10).Value = m_password;
                    cmd.Parameters.Add("m_manhom", NpgsqlDbType.Numeric).Value = m_manhom;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Text).Value = m_makp;
                    cmd.Parameters.Add("m_right", NpgsqlDbType.Text).Value = m_right;
                    cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Text).Value = m_madoituong;
                    cmd.Parameters.Add("m_nhomkho", NpgsqlDbType.Text).Value = m_nhomkho;
                    cmd.Parameters.Add("m_cls", NpgsqlDbType.Text).Value = m_cls;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    cmd.Parameters.Add("m_may", NpgsqlDbType.Text).Value = m_may;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dlogin");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_dlogin(int m_id, string m_hoten, string m_userid, string m_password, int m_manhom, string m_makp, string m_right, string m_madoituong, string m_nhomkho, string m_cls, string m_mabs, string m_may, string m_khudt)
        {
            sql = "update " + user + ".dlogin set hoten=:m_hoten,userid=:m_userid,password_=:m_password,manhom=:m_manhom";
            sql += ",makp=:m_makp,right_=:m_right,madoituong=:m_madoituong,nhomkho=:m_nhomkho,cls=:m_cls,mabs=:m_mabs,may=:m_may, khu=:m_khudt";
            sql += " where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_hoten", NpgsqlDbType.Text).Value = m_hoten;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Varchar, 10).Value = m_userid;
                cmd.Parameters.Add("m_password", NpgsqlDbType.Varchar, 10).Value = m_password;
                cmd.Parameters.Add("m_manhom", NpgsqlDbType.Numeric).Value = m_manhom;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Text).Value = m_makp;
                cmd.Parameters.Add("m_right", NpgsqlDbType.Text).Value = m_right;
                cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Text).Value = m_madoituong;
                cmd.Parameters.Add("m_nhomkho", NpgsqlDbType.Text).Value = m_nhomkho;
                cmd.Parameters.Add("m_cls", NpgsqlDbType.Text).Value = m_cls;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_may", NpgsqlDbType.Text).Value = m_may;
                cmd.Parameters.Add("m_khudt", NpgsqlDbType.Varchar, 100).Value = m_khudt;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dlogin(id,hoten,userid,password_,manhom";
                    sql += ",makp,right_,madoituong,nhomkho,cls,mabs,may, khu";
                    sql += ") values ";
                    sql += "(:m_id,:m_hoten,:m_userid,:m_password,:m_manhom";
                    sql += ",:m_makp,:m_right,:m_madoituong,:m_nhomkho,:m_cls,:m_mabs,:m_may,:m_khudt";
                    sql += ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_hoten", NpgsqlDbType.Text).Value = m_hoten;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Varchar, 10).Value = m_userid;
                    cmd.Parameters.Add("m_password", NpgsqlDbType.Varchar, 10).Value = m_password;
                    cmd.Parameters.Add("m_manhom", NpgsqlDbType.Numeric).Value = m_manhom;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Text).Value = m_makp;
                    cmd.Parameters.Add("m_right", NpgsqlDbType.Text).Value = m_right;
                    cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Text).Value = m_madoituong;
                    cmd.Parameters.Add("m_nhomkho", NpgsqlDbType.Text).Value = m_nhomkho;
                    cmd.Parameters.Add("m_cls", NpgsqlDbType.Text).Value = m_cls;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    cmd.Parameters.Add("m_may", NpgsqlDbType.Text).Value = m_may;
                    cmd.Parameters.Add("m_khudt", NpgsqlDbType.Varchar, 100).Value = m_khudt;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dlogin");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        //Tu:20/05/2011 them chi nhanh
        public bool upd_dlogin(int m_id, string m_hoten, string m_userid, string m_password, int m_manhom, string m_makp, string m_right, string m_madoituong, string m_nhomkho, string m_cls, string m_mabs, string m_may, string m_khudt, int m_chinhanh)
        {
            sql = "update " + user + ".dlogin set hoten=:m_hoten,userid=:m_userid,password_=:m_password,manhom=:m_manhom";
            sql += ",makp=:m_makp,right_=:m_right,madoituong=:m_madoituong,nhomkho=:m_nhomkho,cls=:m_cls,mabs=:m_mabs,may=:m_may, khu=:m_khudt,chinhanh=:m_chinhanh";
            sql += " where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_hoten", NpgsqlDbType.Text).Value = m_hoten;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Varchar, 10).Value = m_userid;
                cmd.Parameters.Add("m_password", NpgsqlDbType.Varchar, 10).Value = m_password;
                cmd.Parameters.Add("m_manhom", NpgsqlDbType.Numeric).Value = m_manhom;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Text).Value = m_makp;
                cmd.Parameters.Add("m_right", NpgsqlDbType.Text).Value = m_right;
                cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Text).Value = m_madoituong;
                cmd.Parameters.Add("m_nhomkho", NpgsqlDbType.Text).Value = m_nhomkho;
                cmd.Parameters.Add("m_cls", NpgsqlDbType.Text).Value = m_cls;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_may", NpgsqlDbType.Text).Value = m_may;
                cmd.Parameters.Add("m_khudt", NpgsqlDbType.Varchar, 100).Value = m_khudt;
                cmd.Parameters.Add("m_chinhanh", NpgsqlDbType.Numeric).Value = m_chinhanh;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dlogin(id,hoten,userid,password_,manhom";
                    sql += ",makp,right_,madoituong,nhomkho,cls,mabs,may, khu,chinhanh";
                    sql += ") values ";
                    sql += "(:m_id,:m_hoten,:m_userid,:m_password,:m_manhom";
                    sql += ",:m_makp,:m_right,:m_madoituong,:m_nhomkho,:m_cls,:m_mabs,:m_may,:m_khudt,:m_chinhanh";
                    sql += ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_hoten", NpgsqlDbType.Text).Value = m_hoten;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Varchar, 10).Value = m_userid;
                    cmd.Parameters.Add("m_password", NpgsqlDbType.Varchar, 10).Value = m_password;
                    cmd.Parameters.Add("m_manhom", NpgsqlDbType.Numeric).Value = m_manhom;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Text).Value = m_makp;
                    cmd.Parameters.Add("m_right", NpgsqlDbType.Text).Value = m_right;
                    cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Text).Value = m_madoituong;
                    cmd.Parameters.Add("m_nhomkho", NpgsqlDbType.Text).Value = m_nhomkho;
                    cmd.Parameters.Add("m_cls", NpgsqlDbType.Text).Value = m_cls;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    cmd.Parameters.Add("m_may", NpgsqlDbType.Text).Value = m_may;
                    cmd.Parameters.Add("m_khudt", NpgsqlDbType.Varchar, 100).Value = m_khudt;
                    cmd.Parameters.Add("m_chinhanh", NpgsqlDbType.Numeric).Value = m_chinhanh;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dlogin");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        //end Tu
        public bool upd_dlogin(int m_id, string m_right)
        {
            sql = "update " + user + ".dlogin set right_=:m_right where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_right", NpgsqlDbType.Text).Value = m_right;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dlogin");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public void updrec(DataTable dt, string maicd, bool matt, int p, decimal so)
        {
            string exp = "maicd='" + maicd.ToString() + "'";
            DataRow r = getrowbyid(dt, exp);
            if (r == null)
            {
                DataRow nrow = dt.NewRow();
                nrow[0] = maicd;
                if (p != 2 && !matt) nrow[3] = so;
                nrow[p] = so;
                dt.Rows.Add(nrow);
            }
            else
            {
                DataRow[] dr = dt.Select(exp);
                dr[0][p] = (dr[0][p].ToString() == "") ? so : decimal.Parse(dr[0][p].ToString()) + so;
                if (p != 2 && !matt) dr[0][3] = (dr[0][3].ToString() == "") ? so : decimal.Parse(dr[0][3].ToString()) + so;
            }
        }

        public void updrec(DataTable dt, int ma)
        {
            string exp = "ma=" + ma;
            DataRow r = getrowbyid(dt, exp);
            if (r == null)
            {
                DataRow nrow = dt.NewRow();
                nrow[0] = ma;
                nrow[1] = "-";
                nrow[2] = "-";
                dt.Rows.Add(nrow);
            }
        }

        public void updrec(DataTable dt, int id, string userid, string password, string right)
        {
            string exp = "id=" + id;
            DataRow r = getrowbyid(dt, exp);
            if (r == null)
            {
                DataRow nrow = dt.NewRow();
                nrow["id"] = id;
                nrow["userid"] = userid;
                nrow["password_"] = password;
                nrow["right_"] = right;
                dt.Rows.Add(nrow);
            }
            else
            {
                DataRow[] dr = dt.Select(exp);
                dr[0]["right_"] = right;
            }
        }

        public void u_bieudo(DataTable dt, string ma, string ten, decimal so)
        {
            string exp = "ma='" + ma + "'";
            DataRow r = getrowbyid(dt, exp);
            if (r == null)
            {
                DataRow nrow = dt.NewRow();
                nrow[0] = ma;
                nrow[1] = ten;
                nrow[2] = so;
                dt.Rows.Add(nrow);
            }
            else
            {
                DataRow[] dr = dt.Select(exp);
                decimal l = decimal.Parse(dr[0][2].ToString()) + so;
                dr[0][2] = l;
            }
        }
        //Thuy 15.05.2012
        public bool upd_btdtt(string m_table, string m_mavung, string m_matt, string m_tentt, string m_viettat)
        {
            sql = "update " + user + "." + m_table + " set tentt=:m_tentt,viettat=:m_viettat where matt=:m_matt";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_tentt", NpgsqlDbType.Text).Value = m_tentt;
                cmd.Parameters.Add("m_viettat", NpgsqlDbType.Varchar, 2).Value = m_viettat;
                cmd.Parameters.Add("m_matt", NpgsqlDbType.Varchar, 3).Value = m_matt;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + "." + m_table + " (matt,tentt,mavung,viettat) values (:m_matt,:m_tentt,:m_mavung,:m_viettat)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_matt", NpgsqlDbType.Varchar, 3).Value = m_matt;
                    cmd.Parameters.Add("m_tentt", NpgsqlDbType.Text).Value = m_tentt;
                    cmd.Parameters.Add("m_mavung", NpgsqlDbType.Varchar, 1).Value = m_mavung;
                    cmd.Parameters.Add("m_viettat", NpgsqlDbType.Varchar, 2).Value = m_viettat;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }

            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, m_table);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_btdtt(string m_table, string m_mavung, string m_matt, string m_tentt)
        {
            sql = "update " + user + "." + m_table + " set tentt=:m_tentt where matt=:m_matt";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_tentt", NpgsqlDbType.Text).Value = m_tentt;
                cmd.Parameters.Add("m_matt", NpgsqlDbType.Varchar, 3).Value = m_matt;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + "." + m_table + " (matt,tentt,mavung) values (:m_matt,:m_tentt,:m_mavung)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_matt", NpgsqlDbType.Varchar, 3).Value = m_matt;
                    cmd.Parameters.Add("m_tentt", NpgsqlDbType.Text).Value = m_tentt;
                    cmd.Parameters.Add("m_mavung", NpgsqlDbType.Varchar, 1).Value = m_mavung;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }

            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, m_table);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_btdquan(string m_table, string m_matt, string m_maqu, string m_tenquan)
        {
            sql = "update " + user + "." + m_table + " set tenquan=:m_tenquan,matt=:m_matt where maqu=:m_maqu";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_tenquan", NpgsqlDbType.Text).Value = m_tenquan;
                cmd.Parameters.Add("m_matt", NpgsqlDbType.Varchar, 3).Value = m_matt;
                cmd.Parameters.Add("m_maqu", NpgsqlDbType.Varchar, 5).Value = m_maqu;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + "." + m_table + " (matt,maqu,tenquan) values (:m_matt,:m_maqu,:m_tenquan)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_matt", NpgsqlDbType.Varchar, 3).Value = m_matt;
                    cmd.Parameters.Add("m_maqu", NpgsqlDbType.Varchar, 5).Value = m_maqu;
                    cmd.Parameters.Add("m_tenquan", NpgsqlDbType.Text).Value = m_tenquan;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }

            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, m_table);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_btdquan(string m_table, string m_matt, string m_maqu, string m_tenquan, string m_viettat)
        {
            sql = "update " + user + "." + m_table + " set tenquan=:m_tenquan,matt=:m_matt,viettat=:m_viettat where maqu=:m_maqu";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_tenquan", NpgsqlDbType.Text).Value = m_tenquan;
                cmd.Parameters.Add("m_matt", NpgsqlDbType.Varchar, 3).Value = m_matt;
                cmd.Parameters.Add("m_viettat", NpgsqlDbType.Varchar, 7).Value = m_viettat;
                cmd.Parameters.Add("m_maqu", NpgsqlDbType.Varchar, 5).Value = m_maqu;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + "." + m_table + " (matt,maqu,tenquan,viettat) values (:m_matt,:m_maqu,:m_tenquan,:m_viettat)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_matt", NpgsqlDbType.Varchar, 3).Value = m_matt;
                    cmd.Parameters.Add("m_maqu", NpgsqlDbType.Varchar, 5).Value = m_maqu;
                    cmd.Parameters.Add("m_tenquan", NpgsqlDbType.Text).Value = m_tenquan;
                    cmd.Parameters.Add("m_viettat", NpgsqlDbType.Varchar, 7).Value = m_viettat;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }

            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, m_table);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_btdpxa(string m_table, string m_maqu, string m_maphuongxa, string m_tenpxa, string m_viettat, int m_thanhthi)
        {
            sql = "update " + user + "." + m_table + " set tenpxa=:m_tenpxa,maqu=:m_maqu,viettat=:m_viettat,thanhthi=:m_thanhthi where maphuongxa=:m_maphuongxa";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_tenpxa", NpgsqlDbType.Text).Value = m_tenpxa;
                cmd.Parameters.Add("m_maqu", NpgsqlDbType.Varchar, 5).Value = m_maqu;
                cmd.Parameters.Add("m_viettat", NpgsqlDbType.Varchar, 10).Value = m_viettat;
                cmd.Parameters.Add("m_maphuongxa", NpgsqlDbType.Varchar, 7).Value = m_maphuongxa;
                cmd.Parameters.Add("m_thanhthi", NpgsqlDbType.Numeric, 1).Value = m_thanhthi;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + "." + m_table + " (maqu,maphuongxa,tenpxa,viettat,thanhthi) values (:m_maqu,:m_maphuongxa,:m_tenpxa,:m_viettat,:m_thanhthi)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_maqu", NpgsqlDbType.Varchar, 5).Value = m_maqu;
                    cmd.Parameters.Add("m_maphuongxa", NpgsqlDbType.Varchar, 7).Value = m_maphuongxa;
                    cmd.Parameters.Add("m_tenpxa", NpgsqlDbType.Text).Value = m_tenpxa;
                    cmd.Parameters.Add("m_viettat", NpgsqlDbType.Varchar, 10).Value = m_viettat;
                    cmd.Parameters.Add("m_thanhthi", NpgsqlDbType.Numeric, 1).Value = m_thanhthi;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }

            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, m_table);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_btdpxa(string m_table, string m_maqu, string m_maphuongxa, string m_tenpxa, string m_viettat)
        {
            sql = "update " + user + "." + m_table + " set tenpxa=:m_tenpxa,maqu=:m_maqu,viettat=:m_viettat where maphuongxa=:m_maphuongxa";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_tenpxa", NpgsqlDbType.Text).Value = m_tenpxa;
                cmd.Parameters.Add("m_maqu", NpgsqlDbType.Varchar, 5).Value = m_maqu;
                cmd.Parameters.Add("m_viettat", NpgsqlDbType.Varchar, 10).Value = m_viettat;
                cmd.Parameters.Add("m_maphuongxa", NpgsqlDbType.Varchar, 7).Value = m_maphuongxa;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + "." + m_table + " (maqu,maphuongxa,tenpxa,viettat) values (:m_maqu,:m_maphuongxa,:m_tenpxa,:m_viettat)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_maqu", NpgsqlDbType.Varchar, 5).Value = m_maqu;
                    cmd.Parameters.Add("m_maphuongxa", NpgsqlDbType.Varchar, 7).Value = m_maphuongxa;
                    cmd.Parameters.Add("m_tenpxa", NpgsqlDbType.Text).Value = m_tenpxa;
                    cmd.Parameters.Add("m_viettat", NpgsqlDbType.Varchar, 10).Value = m_viettat;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }

            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, m_table);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_btdpxa(string m_table, string m_maqu, string m_maphuongxa, string m_tenpxa)
        {
            sql = "update " + user + "." + m_table + " set tenpxa=:m_tenpxa,maqu=:m_maqu where maphuongxa=:m_maphuongxa";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_tenpxa", NpgsqlDbType.Text).Value = m_tenpxa;
                cmd.Parameters.Add("m_maqu", NpgsqlDbType.Varchar, 5).Value = m_maqu;
                cmd.Parameters.Add("m_maphuongxa", NpgsqlDbType.Varchar, 7).Value = m_maphuongxa;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + "." + m_table + " (maqu,maphuongxa,tenpxa,viettat) values (:m_maqu,:m_maphuongxa,:m_tenpxa,'')";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_maqu", NpgsqlDbType.Varchar, 5).Value = m_maqu;
                    cmd.Parameters.Add("m_maphuongxa", NpgsqlDbType.Varchar, 7).Value = m_maphuongxa;
                    cmd.Parameters.Add("m_tenpxa", NpgsqlDbType.Text).Value = m_tenpxa;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }

            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, m_table);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_tenvien(string m_table, string m_mabv, string m_tenbv, string m_diachi, string m_sodt,
            string m_matuyen, string m_maloai, string m_mahang, string m_mavung, string m_matinh)
        {
            sql = "update " + user + "." + m_table + " set tenbv=:m_tenbv,diachi=:m_diachi,sodt=:m_sodt,";
            sql += "matuyen=:m_matuyen,maloai=:m_maloai,mahang=:m_mahang,";
            sql += "mavung=:m_mavung,matinh=:m_matinh where mabv=:m_mabv";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_tenbv", NpgsqlDbType.Text).Value = m_tenbv;
                cmd.Parameters.Add("m_diachi", NpgsqlDbType.Text).Value = m_diachi;
                cmd.Parameters.Add("m_sodt", NpgsqlDbType.Varchar, 20).Value = m_sodt;
                cmd.Parameters.Add("m_matuyen", NpgsqlDbType.Varchar, 1).Value = m_matuyen;
                cmd.Parameters.Add("m_maloai", NpgsqlDbType.Varchar, 5).Value = m_maloai;
                cmd.Parameters.Add("m_mahang", NpgsqlDbType.Varchar, 1).Value = m_mahang;
                cmd.Parameters.Add("m_mavung", NpgsqlDbType.Varchar, 1).Value = m_mavung;
                cmd.Parameters.Add("m_matinh", NpgsqlDbType.Varchar, 3).Value = m_matinh;
                cmd.Parameters.Add("m_mabv", NpgsqlDbType.Varchar, 10).Value = m_mabv;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + "." + m_table + " (mabv,tenbv,diachi,sodt,matuyen,maloai,mahang,mavung,matinh) values (:m_mabv,:m_tenbv,:m_diachi,:m_sodt,:m_matuyen,:m_maloai,:m_mahang,:m_mavung,:m_matinh)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabv", NpgsqlDbType.Varchar, 8).Value = m_mabv;
                    cmd.Parameters.Add("m_tenbv", NpgsqlDbType.Text).Value = m_tenbv;
                    cmd.Parameters.Add("m_diachi", NpgsqlDbType.Text).Value = m_diachi;
                    cmd.Parameters.Add("m_sodt", NpgsqlDbType.Varchar, 20).Value = m_sodt;
                    cmd.Parameters.Add("m_matuyen", NpgsqlDbType.Varchar, 1).Value = m_matuyen;
                    cmd.Parameters.Add("m_maloai", NpgsqlDbType.Varchar, 5).Value = m_maloai;
                    cmd.Parameters.Add("m_mahang", NpgsqlDbType.Varchar, 1).Value = m_mahang;
                    cmd.Parameters.Add("m_mavung", NpgsqlDbType.Varchar, 1).Value = m_mavung;
                    cmd.Parameters.Add("m_matinh", NpgsqlDbType.Varchar, 3).Value = m_matinh;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }

            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, m_table);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_tenvien(string m_table, string m_mabv, string m_tenbv, string m_diachi, string m_sodt,
            string m_matuyen, string m_maloai, string m_mahang, string m_mavung, string m_matinh, decimal m_id)
        {
            sql = "update " + user + "." + m_table + " set tenbv=:m_tenbv,diachi=:m_diachi,sodt=:m_sodt,";
            sql += "matuyen=:m_matuyen,maloai=:m_maloai,mahang=:m_mahang,";
            sql += "mavung=:m_mavung,matinh=:m_matinh where mabv=:m_mabv";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_tenbv", NpgsqlDbType.Text).Value = m_tenbv;
                cmd.Parameters.Add("m_diachi", NpgsqlDbType.Text).Value = m_diachi;
                cmd.Parameters.Add("m_sodt", NpgsqlDbType.Varchar, 20).Value = m_sodt;
                cmd.Parameters.Add("m_matuyen", NpgsqlDbType.Varchar, 1).Value = m_matuyen;
                cmd.Parameters.Add("m_maloai", NpgsqlDbType.Varchar, 5).Value = m_maloai;
                cmd.Parameters.Add("m_mahang", NpgsqlDbType.Varchar, 1).Value = m_mahang;
                cmd.Parameters.Add("m_mavung", NpgsqlDbType.Varchar, 1).Value = m_mavung;
                cmd.Parameters.Add("m_matinh", NpgsqlDbType.Varchar, 3).Value = m_matinh;
                cmd.Parameters.Add("m_mabv", NpgsqlDbType.Varchar, 10).Value = m_mabv;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + "." + m_table + " (mabv,tenbv,diachi,sodt,matuyen,maloai,mahang,mavung,matinh,id) values (:m_mabv,:m_tenbv,:m_diachi,:m_sodt,:m_matuyen,:m_maloai,:m_mahang,:m_mavung,:m_matinh, :m_id)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabv", NpgsqlDbType.Varchar, 10).Value = m_mabv;
                    cmd.Parameters.Add("m_tenbv", NpgsqlDbType.Text).Value = m_tenbv;
                    cmd.Parameters.Add("m_diachi", NpgsqlDbType.Text).Value = m_diachi;
                    cmd.Parameters.Add("m_sodt", NpgsqlDbType.Varchar, 20).Value = m_sodt;
                    cmd.Parameters.Add("m_matuyen", NpgsqlDbType.Varchar, 1).Value = m_matuyen;
                    cmd.Parameters.Add("m_maloai", NpgsqlDbType.Varchar, 5).Value = m_maloai;
                    cmd.Parameters.Add("m_mahang", NpgsqlDbType.Varchar, 1).Value = m_mahang;
                    cmd.Parameters.Add("m_mavung", NpgsqlDbType.Varchar, 1).Value = m_mavung;
                    cmd.Parameters.Add("m_matinh", NpgsqlDbType.Varchar, 3).Value = m_matinh;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }

            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, m_table);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_dmnhommau(int m_ma, string m_ten)
        {
            sql = "update " + user + ".dmnhommau set ten=:m_ten where ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text, 20).Value = m_ten;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dmnhommau(ma,ten) values (:m_ma,:m_ten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text, 20).Value = m_ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }

            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dmnhommau");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_icd10(string m_cicd10, string m_vviet)
        {
            sql = "update " + user + ".icd10 set vviet=:m_vviet where cicd10=:m_cicd10";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_vviet", NpgsqlDbType.Text).Value = Caps(m_vviet);
                cmd.Parameters.Add("m_cicd10", NpgsqlDbType.Varchar, 9).Value = m_cicd10;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "icd10");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_icd10(string m_table, string m_cicd10, int m_id_chapter, string m_vviet,
            string m_vanh, int m_id_nhom, int m_loai, string m_manh, string m_stt)
        {
            sql = "update " + user + "." + m_table + " set id_chapter=:m_id_chapter,vviet=:m_vviet,";
            sql += "vanh=:m_vanh,id_nhom=:m_id_nhom,loai=:m_loai,manh=:m_manh,";
            sql += "stt=:m_stt where cicd10=:m_cicd10";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_id_chapter", NpgsqlDbType.Numeric).Value = m_id_chapter;
                cmd.Parameters.Add("m_vviet", NpgsqlDbType.Text).Value = m_vviet;
                cmd.Parameters.Add("m_vanh", NpgsqlDbType.Varchar, 160).Value = m_vanh;
                cmd.Parameters.Add("m_id_nhom", NpgsqlDbType.Numeric).Value = m_id_nhom;
                cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                cmd.Parameters.Add("m_manh", NpgsqlDbType.Varchar, 7).Value = m_manh;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Varchar, 3).Value = m_stt;
                cmd.Parameters.Add("m_cicd10", NpgsqlDbType.Varchar, 9).Value = m_cicd10;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + "." + m_table + "(cicd10,id_chapter,vviet,vanh,id_nhom,loai,manh,stt,readonly) values (:m_cicd10,:m_id_chapter,:m_vviet,:m_vanh,:m_id_nhom,:m_loai,:m_manh,:m_stt,0)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_cicd10", NpgsqlDbType.Varchar, 9).Value = m_cicd10;
                    cmd.Parameters.Add("m_id_chapter", NpgsqlDbType.Numeric).Value = m_id_chapter;
                    cmd.Parameters.Add("m_vviet", NpgsqlDbType.Text).Value = m_vviet;
                    cmd.Parameters.Add("m_vanh", NpgsqlDbType.Varchar, 160).Value = m_vanh;
                    cmd.Parameters.Add("m_id_nhom", NpgsqlDbType.Numeric).Value = m_id_nhom;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                    cmd.Parameters.Add("m_manh", NpgsqlDbType.Varchar, 7).Value = m_manh;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Varchar, 3).Value = m_stt;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }

            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, m_table + "->" + m_cicd10.Trim());
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_icd10(string m_table, string m_cicd10, int m_id_chapter, string m_vviet,
            string m_vanh, int m_id_nhom, int m_loai, string m_manh, string m_stt, decimal m_id)
        {
            sql = "update " + user + "." + m_table + " set id_chapter=:m_id_chapter,vviet=:m_vviet,";
            sql += "vanh=:m_vanh,id_nhom=:m_id_nhom,loai=:m_loai,manh=:m_manh,";
            sql += "stt=:m_stt where cicd10=:m_cicd10";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_id_chapter", NpgsqlDbType.Numeric).Value = m_id_chapter;
                cmd.Parameters.Add("m_vviet", NpgsqlDbType.Text).Value = m_vviet;
                cmd.Parameters.Add("m_vanh", NpgsqlDbType.Varchar, 160).Value = m_vanh;
                cmd.Parameters.Add("m_id_nhom", NpgsqlDbType.Numeric).Value = m_id_nhom;
                cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                cmd.Parameters.Add("m_manh", NpgsqlDbType.Varchar, 7).Value = m_manh;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Varchar, 3).Value = m_stt;
                cmd.Parameters.Add("m_cicd10", NpgsqlDbType.Varchar, 9).Value = m_cicd10;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + "." + m_table + "(id,cicd10,id_chapter,vviet,vanh,id_nhom,loai,manh,stt,readonly) values (:m_id,:m_cicd10,:m_id_chapter,:m_vviet,:m_vanh,:m_id_nhom,:m_loai,:m_manh,:m_stt,0)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_cicd10", NpgsqlDbType.Varchar, 9).Value = m_cicd10;
                    cmd.Parameters.Add("m_id_chapter", NpgsqlDbType.Numeric).Value = m_id_chapter;
                    cmd.Parameters.Add("m_vviet", NpgsqlDbType.Text).Value = m_vviet;
                    cmd.Parameters.Add("m_vanh", NpgsqlDbType.Varchar, 160).Value = m_vanh;
                    cmd.Parameters.Add("m_id_nhom", NpgsqlDbType.Numeric).Value = m_id_nhom;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                    cmd.Parameters.Add("m_manh", NpgsqlDbType.Varchar, 7).Value = m_manh;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Varchar, 3).Value = m_stt;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }

            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, m_table + "->" + m_cicd10.Trim());
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_dmthon(string m_thon)
        {
            sql = "update " + user + ".dmthon set thon=:m_thon where thon=:m_thon";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_thon", NpgsqlDbType.Text).Value = m_thon;
                cmd.Parameters.Add("m_thon", NpgsqlDbType.Text).Value = m_thon;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dmthon (thon) values (:m_thon)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_thon", NpgsqlDbType.Text).Value = m_thon;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dmthon");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_tainantt(string m_mabn, decimal m_maql, string m_ngay, int m_diadiem, int m_bophan,
            int m_nguyennhan, int m_ngodoc, int m_dienbien, int m_xutri, string m_thon, string m_matt, string m_maqu,
            string m_maphuongxa, string m_lydo, string m_chandoan, string m_dieutri, string m_lucvao, string m_lucra)
        {
            sql = "update " + user + mmyy(m_ngay) + ".tainantt set ngay=:m_ngay,diadiem=:m_diadiem,bophan=:m_bophan,";
            sql += "nguyennhan=:m_nguyennhan,ngodoc=:m_ngodoc,dienbien=:m_dienbien,xutri=:m_xutri,thon=:m_thon,";
            sql += "matt=:m_matt,maqu=:m_maqu,maphuongxa=:m_maphuongxa,";
            sql += "lydo=:m_lydo,chandoan=:m_chandoan,dieutri=:m_dieutri,lucvao=:m_lucvao,lucra=:m_lucra";
            sql += " where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_diadiem", NpgsqlDbType.Numeric).Value = m_diadiem;
                cmd.Parameters.Add("m_bophan", NpgsqlDbType.Numeric).Value = m_bophan;
                cmd.Parameters.Add("m_nguyennhan", NpgsqlDbType.Numeric).Value = m_nguyennhan;
                cmd.Parameters.Add("m_ngodoc", NpgsqlDbType.Numeric).Value = m_ngodoc;
                cmd.Parameters.Add("m_dienbien", NpgsqlDbType.Numeric).Value = m_dienbien;
                cmd.Parameters.Add("m_xutri", NpgsqlDbType.Numeric).Value = m_xutri;
                cmd.Parameters.Add("m_thon", NpgsqlDbType.Text).Value = m_thon;
                cmd.Parameters.Add("m_matt", NpgsqlDbType.Varchar, 3).Value = m_matt;
                cmd.Parameters.Add("m_maqu", NpgsqlDbType.Varchar, 5).Value = m_maqu;
                cmd.Parameters.Add("m_maphuongxa", NpgsqlDbType.Varchar, 7).Value = m_maphuongxa;
                cmd.Parameters.Add("m_lydo", NpgsqlDbType.Text).Value = m_lydo;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_dieutri", NpgsqlDbType.Text).Value = m_dieutri;
                cmd.Parameters.Add("m_lucvao", NpgsqlDbType.Text).Value = m_lucvao;
                cmd.Parameters.Add("m_lucra", NpgsqlDbType.Text).Value = m_lucra;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + mmyy(m_ngay) + ".tainantt(mabn,maql,ngay,diadiem,bophan,nguyennhan,ngodoc,dienbien,xutri,thon,matt,maqu,maphuongxa,lydo,chandoan,dieutri,lucvao,lucra) values (:m_mabn,:m_maql,:m_ngay,:m_diadiem,:m_bophan,:m_nguyennhan,:m_ngodoc,:m_dienbien,:m_xutri,:m_thon,:m_matt,:m_maqu,:m_maphuongxa,:m_lydo,:m_chandoan,:m_dieutri,:m_lucvao,:m_lucra)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_diadiem", NpgsqlDbType.Numeric).Value = m_diadiem;
                    cmd.Parameters.Add("m_bophan", NpgsqlDbType.Numeric).Value = m_bophan;
                    cmd.Parameters.Add("m_nguyennhan", NpgsqlDbType.Numeric).Value = m_nguyennhan;
                    cmd.Parameters.Add("m_ngodoc", NpgsqlDbType.Numeric).Value = m_ngodoc;
                    cmd.Parameters.Add("m_dienbien", NpgsqlDbType.Numeric).Value = m_dienbien;
                    cmd.Parameters.Add("m_xutri", NpgsqlDbType.Numeric).Value = m_xutri;
                    cmd.Parameters.Add("m_thon", NpgsqlDbType.Text).Value = m_thon;
                    cmd.Parameters.Add("m_matt", NpgsqlDbType.Varchar, 3).Value = m_matt;
                    cmd.Parameters.Add("m_maqu", NpgsqlDbType.Varchar, 5).Value = m_maqu;
                    cmd.Parameters.Add("m_maphuongxa", NpgsqlDbType.Varchar, 7).Value = m_maphuongxa;
                    cmd.Parameters.Add("m_lydo", NpgsqlDbType.Text).Value = m_lydo;
                    cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                    cmd.Parameters.Add("m_dieutri", NpgsqlDbType.Text).Value = m_dieutri;
                    cmd.Parameters.Add("m_lucvao", NpgsqlDbType.Text).Value = m_lucvao;
                    cmd.Parameters.Add("m_lucra", NpgsqlDbType.Text).Value = m_lucra;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }

            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message, sComputer, "tainantt");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_tainangt(string ngaytt, decimal maql, string sophieu, string ngay, int socap, string ptvv, string pttn, int ptgaytn,
            string ptgaykhac, int mubaohiem, int gaiquai, int bivo, string loaimu, int ruoubia, int camquan, int mau, int hoitho,
            int sonao, int glassgow, int cotsongco, int thuongkhac, int nhapvien, int mocapcuu, int tuvong, int xinve, string mabv,
            string manv, int nguyennhantv)
        {

            sql = "update " + user + mmyy(ngaytt) + ".tainangt set sophieu=:sophieu,ngay=to_timestamp(:ngay,'dd/mm/yyyy hh24:mi'),socap=" + socap;
            sql += ",ptvv=:ptvv,pttn=:pttn,ptgaytn=" + ptgaytn + ",ptgaykhac=:ptgaykhac,mubaohiem=" + mubaohiem;
            sql += ",gaiquai=" + gaiquai + ",bivo=" + bivo + ",loaimu=:loaimu,ruoubia=" + ruoubia + ",camquan=" + camquan + ",mau=" + mau;
            sql += ",hoitho=" + hoitho + ",sonao=" + sonao + ",glassgow=" + glassgow + ",cotsongco=" + cotsongco + ",thuongkhac=" + thuongkhac;
            sql += ",nhapvien=" + nhapvien + ",mocapcuu=" + mocapcuu + ",tuvong=" + tuvong + ",xinve=" + xinve + ",mabv=:mabv,manv=:manv,nguyennhantuvong=" + nguyennhantv.ToString();
            sql += " where maql=" + maql;// Khuong 25/11/2011 them nguyen nhan tu vong
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("sophieu", NpgsqlDbType.Varchar, 10).Value = sophieu;
                cmd.Parameters.Add("ngay", NpgsqlDbType.Varchar, 16).Value = ngay;
                cmd.Parameters.Add("ptvv", NpgsqlDbType.Text).Value = ptvv;
                cmd.Parameters.Add("pttn", NpgsqlDbType.Text).Value = pttn;
                cmd.Parameters.Add("ptgaykhac", NpgsqlDbType.Text).Value = ptgaykhac;
                cmd.Parameters.Add("loaimu", NpgsqlDbType.Text).Value = loaimu;
                cmd.Parameters.Add("mabv", NpgsqlDbType.Varchar, 10).Value = mabv;
                cmd.Parameters.Add("manv", NpgsqlDbType.Varchar, 4).Value = manv;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + mmyy(ngaytt) + ".tainangt(maql,sophieu,ngay,socap,ptvv,pttn,ptgaytn,ptgaykhac,mubaohiem,gaiquai,bivo,loaimu,";
                    sql += "ruoubia,camquan,mau,hoitho,sonao,glassgow,cotsongco,thuongkhac,nhapvien,mocapcuu,tuvong,xinve,mabv,manv,nguyennhantuvong)";
                    sql += " values ";
                    sql += "(" + maql + ",:sophieu,to_timestamp(:ngay,'dd/mm/yyyy hh24:mi')," + socap + ",:ptvv,:pttn," + ptgaytn + ",:ptgaykhac," + mubaohiem + "," + gaiquai + "," + bivo + ",:loaimu,";
                    sql += ruoubia + "," + camquan + "," + mau + "," + hoitho + "," + sonao + "," + glassgow + "," + cotsongco + "," + thuongkhac + "," + nhapvien + "," + mocapcuu + "," + tuvong + "," + xinve + ",:mabv,:manv," + nguyennhantv.ToString() + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("sophieu", NpgsqlDbType.Varchar, 10).Value = sophieu;
                    cmd.Parameters.Add("ngay", NpgsqlDbType.Varchar, 16).Value = ngay;
                    cmd.Parameters.Add("ptvv", NpgsqlDbType.Text).Value = ptvv;
                    cmd.Parameters.Add("pttn", NpgsqlDbType.Text).Value = pttn;
                    cmd.Parameters.Add("ptgaykhac", NpgsqlDbType.Text).Value = ptgaykhac;
                    cmd.Parameters.Add("loaimu", NpgsqlDbType.Text).Value = loaimu;
                    cmd.Parameters.Add("mabv", NpgsqlDbType.Varchar, 10).Value = mabv;
                    cmd.Parameters.Add("manv", NpgsqlDbType.Varchar, 4).Value = manv;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ngaytt, ex.Message, sComputer, "tainangt");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_dmcoso(int m_ma, string m_ten, int m_tuyen)
        {
            sql = "update " + user + ".dmcoso set ten=:m_ten,tuyen=:m_tuyen";
            sql += " where ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_tuyen", NpgsqlDbType.Numeric).Value = m_tuyen;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dmcoso(ma,ten,tuyen) values (:m_ma,:m_ten,:m_tuyen)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    cmd.Parameters.Add("m_tuyen", NpgsqlDbType.Numeric).Value = m_tuyen;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dmcoso");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_danhmuc(int m_ma, string m_stt, string m_ten, string m_table)
        {
            sql = "update " + user + "." + m_table + " set stt=:m_stt,ten=:m_ten";
            sql += " where ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Varchar).Value = m_stt;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + "." + m_table + " (ma,stt,ten) values (:m_ma,:m_stt,:m_ten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Varchar).Value = m_stt;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, m_table);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_danhmuc(int m_ma, string m_stt, string m_table)
        {
            sql = "update " + user + "." + m_table + " set stt=:m_stt";
            sql += " where ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Varchar, 2).Value = m_stt;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, m_table);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public void sort_stt()
        {
            int i = 1;
            foreach (DataRow r in get_data("select * from " + user + ".kh_dm_01 where stt<>'A' order by ma").Tables[0].Rows)
            {
                upd_danhmuc(int.Parse(r["ma"].ToString()), i.ToString(), "kh_dm_01");
                i++;
            }
            i = 1;
            foreach (DataRow r in get_data("select * from " + user + ".kh_dm_02 where stt<>'A' order by ma").Tables[0].Rows)
            {
                upd_danhmuc(int.Parse(r["ma"].ToString()), i.ToString(), "kh_dm_02");
                i++;
            }
            i = 1;
            foreach (DataRow r in get_data("select * from " + user + ".kh_dm_04 where stt<>'A' order by ma").Tables[0].Rows)
            {
                upd_danhmuc(int.Parse(r["ma"].ToString()), i.ToString(), "kh_dm_04");
                i++;
            }
        }

        public void sort_danhmuc(string table)
        {
            int i = 1;
            foreach (DataRow r in get_data("select * from " + user + "." + table + " where stt<>'A' order by ma").Tables[0].Rows)
            {
                upd_danhmuc(int.Parse(r["ma"].ToString()), i.ToString(), table);
                i++;
            }
        }

        public void sort_stt(string table)
        {
            int i = 1, j = 0;
            execute_data("delete from " + user + "." + table + " where stt in ('B','C')");
            foreach (DataRow r in get_data("select * from " + user + "." + table + " where stt<>'A' order by ma").Tables[0].Rows)
            {
                j = int.Parse(r["ma"].ToString());
                upd_danhmuc((j < 50) ? 0 : 50, (j < 50) ? "B" : "C", (j < 50) ? "I. Tuyến huyện" : "II. Tuyến xã", table);
            }
            foreach (DataRow r in get_data("select * from " + user + "." + table + " where ma between 1 and 49 order by ma").Tables[0].Rows)
            {
                upd_danhmuc(int.Parse(r["ma"].ToString()), i.ToString(), table);
                i++;
            }
            i = 1;
            foreach (DataRow r in get_data("select * from " + user + "." + table + " where ma between 51 and 99 order by ma").Tables[0].Rows)
            {
                upd_danhmuc(int.Parse(r["ma"].ToString()), i.ToString(), table);
                i++;
            }
        }

        public bool upd_dmcssxkd(int m_ma, string m_ten)
        {
            sql = "update " + user + ".dmcssxkd set ten=:m_ten";
            sql += " where ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dmcssxkd(ma,ten) values (:m_ma,:m_ten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dmcssxkd");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_danhmuc(string m_table, int m_ma, string m_ten)
        {
            sql = "update " + user + "." + m_table + " set ten=:m_ten";
            sql += " where id=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + "." + m_table + " (id,ten) values (:m_ma,:m_ten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, m_table);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_xutrikb(int m_ma, string m_ten)
        {
            sql = "update " + user + ".xutrikb set ten=:m_ten";
            sql += " where ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".xutrikb(ma,ten) values (:m_ma,:m_ten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "xutrikb");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public string get_xutri(string ngay, decimal m_maql, int i)
        {
            DataTable dt = get_data("select xutri,makp from " + user + mmyy(ngay) + ".xutrikbct where maql=" + m_maql).Tables[0];
            if (dt.Rows.Count == 0) return "";
            else return dt.Rows[0][i].ToString();
        }

        #region vukehoach
        /// <summary>
        /// 
        /// </summary>
        public bool upd_kh01(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02, int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09, int m_c10, int m_c11, int m_userid)
        {
            sql = "update " + user + ".kh_bieu_01 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,c11=:m_c11,";
            sql += "userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".kh_bieu_01(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_c11,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "kh_bieu_01");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_kh02(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09,
            int m_c10, int m_c11, int m_c12, int m_c13, int m_c14, int m_c15, int m_c16, int m_c17, int m_userid)
        {
            sql = "update " + user + ".kh_bieu_02 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,";
            sql += "c11=:m_c11,c12=:m_c12,c13=:m_c13,c14=:m_c14,c15=:m_c15,c16=:m_c16,c17=:m_c17,";
            sql += "userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".kh_bieu_02(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,c13,c14,c15,c16,c17,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_c11,:m_c12,:m_c13,:m_c14,:m_c15,:m_c16,:m_c17,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                    cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                    cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                    cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                    cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                    cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                    cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "kh_bieu_02");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_kh03(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09,
            int m_c10, int m_c11, int m_c12, int m_c13, int m_c14, int m_c15, int m_c16,
            int m_c17, int m_c18, int m_c19, int m_c20, int m_userid)
        {
            sql = "update " + user + ".kh_bieu_03 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,";
            sql += "c11=:m_c11,c12=:m_c12,c13=:m_c13,c14=:m_c14,c15=:m_c15,c16=:m_c16,c17=:m_c17,c18=:m_c18,";
            sql += "c19=:m_c19,c20=:m_c20,userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                cmd.Parameters.Add("m_c20", NpgsqlDbType.Numeric).Value = m_c20;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".kh_bieu_03(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,c13,c14,c15,c16,c17,c18,c19,c20,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_c11,:m_c12,:m_c13,:m_c14,:m_c15,:m_c16,:m_c17,:m_c18,:m_c19,:m_c20,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                    cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                    cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                    cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                    cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                    cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                    cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                    cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                    cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                    cmd.Parameters.Add("m_c20", NpgsqlDbType.Numeric).Value = m_c20;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "kh_bieu_03");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_kh04(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09,
            int m_c10, int m_c11, int m_c12, int m_c13, int m_c14, int m_c15, int m_c16, int m_c17, string m_c18, int m_userid)
        {
            sql = "update " + user + ".kh_bieu_04 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,";
            sql += "c11=:m_c11,c12=:m_c12,c13=:m_c13,c14=:m_c14,c15=:m_c15,c16=:m_c16,c17=:m_c17,c18=:m_c18,";
            sql += "userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                cmd.Parameters.Add("m_c18", NpgsqlDbType.Text).Value = m_c18;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".kh_bieu_04(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,c13,c14,c15,c16,c17,c18,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_c11,:m_c12,:m_c13,:m_c14,:m_c15,:m_c16,:m_c17,:m_c18,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                    cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                    cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                    cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                    cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                    cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                    cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                    cmd.Parameters.Add("m_c18", NpgsqlDbType.Text).Value = m_c18;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "kh_bieu_04");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_kh05(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09,
            int m_c10, int m_c11, int m_c12, int m_c13, int m_c14, int m_userid, int m_c15)
        {
            sql = "update " + user + ".kh_bieu_05 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,";
            sql += "c11=:m_c11,c12=:m_c12,c13=:m_c13,c14=:m_c14,";
            sql += "userid=:m_userid,c15=:m_c15 where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".kh_bieu_05(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,c13,c14,userid,ngayud,c15) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_c11,:m_c12,:m_c13,:m_c14,:m_userid,now(),:m_c15)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                    cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                    cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                    cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "kh_bieu_05");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_kh06(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09,
            int m_c10, int m_c11, int m_c12, int m_c13, int m_c14, int m_c15, int m_c16,
            int m_c17, int m_c18, int m_c19, int m_c20, int m_c21, int m_c22, int m_c23,
            int m_c24, int m_c25, int m_c26, int m_c27, int m_c28, int m_c29, int m_c30,
            int m_c31, int m_userid, int m_c32, int m_c33, int m_c34, int m_c35, int m_c36, int m_c37,
            int m_c38)
        {
            sql = "update " + user + ".kh_bieu_06 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,";
            sql += "c11=:m_c11,c12=:m_c12,c13=:m_c13,c14=:m_c14,c15=:m_c15,c16=:m_c16,c17=:m_c17,";
            sql += "c18=:m_c18,c19=:m_c19,c20=:m_c20,c21=:m_c21,c22=:m_c22,c23=:m_c23,c24=:m_c24,";
            sql += "c25=:m_c25,c26=:m_c26,c27=:m_c27,c28=:m_c28,c29=:m_c29,c30=:m_c30,c31=:m_c31,";
            sql += "userid=:m_userid,c32=:m_c32,c33=:m_c33,c34=:m_c34,c35=:m_c35,c36=:m_c36,c37=:m_c37,c38=:m_c38 where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                cmd.Parameters.Add("m_c20", NpgsqlDbType.Numeric).Value = m_c20;
                cmd.Parameters.Add("m_c21", NpgsqlDbType.Numeric).Value = m_c21;
                cmd.Parameters.Add("m_c22", NpgsqlDbType.Numeric).Value = m_c22;
                cmd.Parameters.Add("m_c23", NpgsqlDbType.Numeric).Value = m_c23;
                cmd.Parameters.Add("m_c24", NpgsqlDbType.Numeric).Value = m_c24;
                cmd.Parameters.Add("m_c25", NpgsqlDbType.Numeric).Value = m_c25;
                cmd.Parameters.Add("m_c26", NpgsqlDbType.Numeric).Value = m_c26;
                cmd.Parameters.Add("m_c27", NpgsqlDbType.Numeric).Value = m_c27;
                cmd.Parameters.Add("m_c28", NpgsqlDbType.Numeric).Value = m_c28;
                cmd.Parameters.Add("m_c29", NpgsqlDbType.Numeric).Value = m_c29;
                cmd.Parameters.Add("m_c30", NpgsqlDbType.Numeric).Value = m_c30;
                cmd.Parameters.Add("m_c31", NpgsqlDbType.Numeric).Value = m_c31;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_c32", NpgsqlDbType.Numeric).Value = m_c32;
                cmd.Parameters.Add("m_c33", NpgsqlDbType.Numeric).Value = m_c33;
                cmd.Parameters.Add("m_c34", NpgsqlDbType.Numeric).Value = m_c34;
                cmd.Parameters.Add("m_c35", NpgsqlDbType.Numeric).Value = m_c35;
                cmd.Parameters.Add("m_c36", NpgsqlDbType.Numeric).Value = m_c36;
                cmd.Parameters.Add("m_c37", NpgsqlDbType.Numeric).Value = m_c37;
                cmd.Parameters.Add("m_c38", NpgsqlDbType.Numeric).Value = m_c37;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".kh_bieu_06(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,c13,c14,c15,c16,c17,c18,c19,c20,c21,c22,c23,c24,c25,c26,c27,c28,c29,c30,c31,userid,ngayud,c32,c33,c34,c35,c36,c37,c38) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_c11,:m_c12,:m_c13,:m_c14,:m_c15,:m_c16,:m_c17,:m_c18,:m_c19,:m_c20,:m_c21,:m_c22,:m_c23,:m_c24,:m_c25,:m_c26,:m_c27,:m_c28,:m_c29,:m_c30,:m_c31,:m_userid,now(),:m_c32,:m_c33,:m_c34,:m_c35,:m_c36,:m_c37,:m_c38)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                    cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                    cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                    cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                    cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                    cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                    cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                    cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                    cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                    cmd.Parameters.Add("m_c20", NpgsqlDbType.Numeric).Value = m_c20;
                    cmd.Parameters.Add("m_c21", NpgsqlDbType.Numeric).Value = m_c21;
                    cmd.Parameters.Add("m_c22", NpgsqlDbType.Numeric).Value = m_c22;
                    cmd.Parameters.Add("m_c23", NpgsqlDbType.Numeric).Value = m_c23;
                    cmd.Parameters.Add("m_c24", NpgsqlDbType.Numeric).Value = m_c24;
                    cmd.Parameters.Add("m_c25", NpgsqlDbType.Numeric).Value = m_c25;
                    cmd.Parameters.Add("m_c26", NpgsqlDbType.Numeric).Value = m_c26;
                    cmd.Parameters.Add("m_c27", NpgsqlDbType.Numeric).Value = m_c27;
                    cmd.Parameters.Add("m_c28", NpgsqlDbType.Numeric).Value = m_c28;
                    cmd.Parameters.Add("m_c29", NpgsqlDbType.Numeric).Value = m_c29;
                    cmd.Parameters.Add("m_c30", NpgsqlDbType.Numeric).Value = m_c30;
                    cmd.Parameters.Add("m_c31", NpgsqlDbType.Numeric).Value = m_c31;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    cmd.Parameters.Add("m_c32", NpgsqlDbType.Numeric).Value = m_c32;
                    cmd.Parameters.Add("m_c33", NpgsqlDbType.Numeric).Value = m_c33;
                    cmd.Parameters.Add("m_c34", NpgsqlDbType.Numeric).Value = m_c34;
                    cmd.Parameters.Add("m_c35", NpgsqlDbType.Numeric).Value = m_c35;
                    cmd.Parameters.Add("m_c36", NpgsqlDbType.Numeric).Value = m_c36;
                    cmd.Parameters.Add("m_c37", NpgsqlDbType.Numeric).Value = m_c37;
                    cmd.Parameters.Add("m_c38", NpgsqlDbType.Numeric).Value = m_c37;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "kh_bieu_06");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_kh07(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09, int m_userid, string m_c10)
        {
            sql = "update " + user + ".kh_bieu_07 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,";
            sql += "userid=:m_userid,c10=:m_c10 where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Varchar, 200).Value = m_c10;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".kh_bieu_07(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,userid,ngayud,c10) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_userid,now(),:m_c10)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Varchar, 200).Value = m_c10;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "kh_bieu_07");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_kh15(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_userid)
        {
            sql = "update " + user + ".kh_bieu_15 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,";
            sql += "userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".kh_bieu_15(id,ma,ngay,c01,c02,c03,c04,c05,c06,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "kh_bieu_15");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_kh09(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09,
            int m_c10, int m_c11, int m_c12, int m_c13, int m_c14, int m_c15, int m_c16,
            int m_c17, int m_c18, int m_c19, int m_c20, int m_c21, int m_c22, int m_c23,
            int m_c24, int m_c25, int m_c26, int m_c27, int m_c28, int m_c29, int m_c30, int m_userid)
        {
            sql = "update " + user + ".kh_bieu_09 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,";
            sql += "c11=:m_c11,c12=:m_c12,c13=:m_c13,c14=:m_c14,c15=:m_c15,c16=:m_c16,c17=:m_c17,";
            sql += "c18=:m_c18,c19=:m_c19,c20=:m_c20,c21=:m_c21,c22=:m_c22,c23=:m_c23,c24=:m_c24,";
            sql += "c25=:m_c25,c26=:m_c26,c27=:m_c27,c28=:m_c28,c29=:m_c29,c30=:m_c30,";
            sql += "userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                cmd.Parameters.Add("m_c20", NpgsqlDbType.Numeric).Value = m_c20;
                cmd.Parameters.Add("m_c21", NpgsqlDbType.Numeric).Value = m_c21;
                cmd.Parameters.Add("m_c22", NpgsqlDbType.Numeric).Value = m_c22;
                cmd.Parameters.Add("m_c23", NpgsqlDbType.Numeric).Value = m_c23;
                cmd.Parameters.Add("m_c24", NpgsqlDbType.Numeric).Value = m_c24;
                cmd.Parameters.Add("m_c25", NpgsqlDbType.Numeric).Value = m_c25;
                cmd.Parameters.Add("m_c26", NpgsqlDbType.Numeric).Value = m_c26;
                cmd.Parameters.Add("m_c27", NpgsqlDbType.Numeric).Value = m_c27;
                cmd.Parameters.Add("m_c28", NpgsqlDbType.Numeric).Value = m_c28;
                cmd.Parameters.Add("m_c29", NpgsqlDbType.Numeric).Value = m_c29;
                cmd.Parameters.Add("m_c30", NpgsqlDbType.Numeric).Value = m_c30;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".kh_bieu_09(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,c13,c14,c15,c16,c17,c18,c19,c20,c21,c22,c23,c24,c25,c26,c27,c28,c29,c30,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_c11,:m_c12,:m_c13,:m_c14,:m_c15,:m_c16,:m_c17,:m_c18,:m_c19,:m_c20,:m_c21,:m_c22,:m_c23,:m_c24,:m_c25,:m_c26,:m_c27,:m_c28,:m_c29,:m_c30,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                    cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                    cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                    cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                    cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                    cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                    cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                    cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                    cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                    cmd.Parameters.Add("m_c20", NpgsqlDbType.Numeric).Value = m_c20;
                    cmd.Parameters.Add("m_c21", NpgsqlDbType.Numeric).Value = m_c21;
                    cmd.Parameters.Add("m_c22", NpgsqlDbType.Numeric).Value = m_c22;
                    cmd.Parameters.Add("m_c23", NpgsqlDbType.Numeric).Value = m_c23;
                    cmd.Parameters.Add("m_c24", NpgsqlDbType.Numeric).Value = m_c24;
                    cmd.Parameters.Add("m_c25", NpgsqlDbType.Numeric).Value = m_c25;
                    cmd.Parameters.Add("m_c26", NpgsqlDbType.Numeric).Value = m_c26;
                    cmd.Parameters.Add("m_c27", NpgsqlDbType.Numeric).Value = m_c27;
                    cmd.Parameters.Add("m_c28", NpgsqlDbType.Numeric).Value = m_c28;
                    cmd.Parameters.Add("m_c29", NpgsqlDbType.Numeric).Value = m_c29;
                    cmd.Parameters.Add("m_c30", NpgsqlDbType.Numeric).Value = m_c30;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "kh_bieu_09");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_kh10(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09,
            int m_c10, int m_c11, int m_c12, int m_c13, int m_c14, int m_c15, int m_c16,
            int m_c17, int m_c18, int m_c19, int m_c20, int m_c21, int m_c22, int m_c23,
            int m_c24, int m_c25, int m_c26, int m_c27, int m_c28, int m_c29, int m_c30, int m_userid)
        {
            sql = "update " + user + ".kh_bieu_10 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,";
            sql += "c11=:m_c11,c12=:m_c12,c13=:m_c13,c14=:m_c14,c15=:m_c15,c16=:m_c16,c17=:m_c17,";
            sql += "c18=:m_c18,c19=:m_c19,c20=:m_c20,c21=:m_c21,c22=:m_c22,c23=:m_c23,c24=:m_c24,";
            sql += "c25=:m_c25,c26=:m_c26,c27=:m_c27,c28=:m_c28,c29=:m_c29,c30=:m_c30,";
            sql += "userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                cmd.Parameters.Add("m_c20", NpgsqlDbType.Numeric).Value = m_c20;
                cmd.Parameters.Add("m_c21", NpgsqlDbType.Numeric).Value = m_c21;
                cmd.Parameters.Add("m_c22", NpgsqlDbType.Numeric).Value = m_c22;
                cmd.Parameters.Add("m_c23", NpgsqlDbType.Numeric).Value = m_c23;
                cmd.Parameters.Add("m_c24", NpgsqlDbType.Numeric).Value = m_c24;
                cmd.Parameters.Add("m_c25", NpgsqlDbType.Numeric).Value = m_c25;
                cmd.Parameters.Add("m_c26", NpgsqlDbType.Numeric).Value = m_c26;
                cmd.Parameters.Add("m_c27", NpgsqlDbType.Numeric).Value = m_c27;
                cmd.Parameters.Add("m_c28", NpgsqlDbType.Numeric).Value = m_c28;
                cmd.Parameters.Add("m_c29", NpgsqlDbType.Numeric).Value = m_c29;
                cmd.Parameters.Add("m_c30", NpgsqlDbType.Numeric).Value = m_c30;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".kh_bieu_10(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,c13,c14,c15,c16,c17,c18,c19,c20,c21,c22,c23,c24,c25,c26,c27,c28,c29,c30,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_c11,:m_c12,:m_c13,:m_c14,:m_c15,:m_c16,:m_c17,:m_c18,:m_c19,:m_c20,:m_c21,:m_c22,:m_c23,:m_c24,:m_c25,:m_c26,:m_c27,:m_c28,:m_c29,:m_c30,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                    cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                    cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                    cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                    cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                    cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                    cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                    cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                    cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                    cmd.Parameters.Add("m_c20", NpgsqlDbType.Numeric).Value = m_c20;
                    cmd.Parameters.Add("m_c21", NpgsqlDbType.Numeric).Value = m_c21;
                    cmd.Parameters.Add("m_c22", NpgsqlDbType.Numeric).Value = m_c22;
                    cmd.Parameters.Add("m_c23", NpgsqlDbType.Numeric).Value = m_c23;
                    cmd.Parameters.Add("m_c24", NpgsqlDbType.Numeric).Value = m_c24;
                    cmd.Parameters.Add("m_c25", NpgsqlDbType.Numeric).Value = m_c25;
                    cmd.Parameters.Add("m_c26", NpgsqlDbType.Numeric).Value = m_c26;
                    cmd.Parameters.Add("m_c27", NpgsqlDbType.Numeric).Value = m_c27;
                    cmd.Parameters.Add("m_c28", NpgsqlDbType.Numeric).Value = m_c28;
                    cmd.Parameters.Add("m_c29", NpgsqlDbType.Numeric).Value = m_c29;
                    cmd.Parameters.Add("m_c30", NpgsqlDbType.Numeric).Value = m_c30;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "kh_bieu_10");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        //ThanhCuong 25/02/2012
        public bool upd_kh08(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, string m_c06, int m_userid)
        {
            sql = "update " + user + ".kh_bieu_08 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,";
            sql += "userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Varchar, 200).Value = m_c06;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".kh_bieu_08(id,ma,ngay,c01,c02,c03,c04,c05,c06,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Varchar, 200).Value = m_c06;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "kh_bieu_08");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_kh11(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09,
            int m_c10, int m_c11, int m_c12, int m_c13, int m_c14, int m_c15, int m_c16,
            int m_c17, int m_c18, int m_c19, int m_c20, int m_userid)
        {
            sql = "update " + user + ".kh_bieu_11 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,";
            sql += "c11=:m_c11,c12=:m_c12,c13=:m_c13,c14=:m_c14,c15=:m_c15,c16=:m_c16,c17=:m_c17,";
            sql += "c18=:m_c18,c19=:m_c19,c20=:m_c20,";
            sql += "userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                cmd.Parameters.Add("m_c20", NpgsqlDbType.Numeric).Value = m_c20;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".kh_bieu_11(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,c13,c14,c15,c16,c17,c18,c19,c20,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_c11,:m_c12,:m_c13,:m_c14,:m_c15,:m_c16,:m_c17,:m_c18,:m_c19,:m_c20,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                    cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                    cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                    cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                    cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                    cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                    cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                    cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                    cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                    cmd.Parameters.Add("m_c20", NpgsqlDbType.Numeric).Value = m_c20;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "kh_bieu_11");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_kh121(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09,
            int m_c10, int m_c11, int m_c12, int m_c13, int m_c14, int m_c15, int m_c16,
            int m_c17, int m_userid)
        {
            sql = "update " + user + ".kh_bieu_121 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,";
            sql += "c11=:m_c11,c12=:m_c12,c13=:m_c13,c14=:m_c14,c15=:m_c15,c16=:m_c16,c17=:m_c17,";
            sql += "userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".kh_bieu_121(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,c13,c14,c15,c16,c17,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_c11,:m_c12,:m_c13,:m_c14,:m_c15,:m_c16,:m_c17,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                    cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                    cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                    cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                    cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                    cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                    cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "kh_bieu_121");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_kh122(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09,
            int m_c10, int m_c11, int m_c12, int m_c13, int m_c14, int m_c15, int m_c16,
            int m_c17, int m_c18, int m_c19, int m_userid)
        {
            sql = "update " + user + ".kh_bieu_122 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,";
            sql += "c11=:m_c11,c12=:m_c12,c13=:m_c13,c14=:m_c14,c15=:m_c15,c16=:m_c16,c17=:m_c17,";
            sql += "c18=:m_c18,c19=:m_c19,userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".kh_bieu_122(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,c13,c14,c15,c16,c17,c18,c19,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_c11,:m_c12,:m_c13,:m_c14,:m_c15,:m_c16,:m_c17,:m_c18,:m_c19,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                    cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                    cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                    cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                    cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                    cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                    cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                    cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                    cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "kh_bieu_122");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_kh123(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09,
            int m_c10, int m_c11, int m_c12, int m_c13, int m_c14, int m_c15, int m_c16,
            int m_c17, int m_c18, int m_c19, string m_c20, int m_userid)
        {
            sql = "update " + user + ".kh_bieu_123 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,";
            sql += "c11=:m_c11,c12=:m_c12,c13=:m_c13,c14=:m_c14,c15=:m_c15,c16=:m_c16,c17=:m_c17,";
            sql += "c18=:m_c18,c19=:m_c19,c20=:m_c20,userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                cmd.Parameters.Add("m_c20", NpgsqlDbType.Varchar, 200).Value = m_c20;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".kh_bieu_123(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,c13,c14,c15,c16,c17,c18,c19,c20,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_c11,:m_c12,:m_c13,:m_c14,:m_c15,:m_c16,:m_c17,:m_c18,:m_c19,:m_c20,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                    cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                    cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                    cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                    cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                    cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                    cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                    cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                    cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                    cmd.Parameters.Add("m_c20", NpgsqlDbType.Varchar, 200).Value = m_c20;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "kh_bieu_123");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_kh124(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09,
            int m_c10, int m_c11, int m_c12, int m_c13, int m_c14, int m_c15, int m_c16,
            int m_c17, int m_c18, int m_c19, int m_c20, int m_c21, int m_c22, int m_c23, int m_c24, int m_userid)
        {
            sql = "update " + user + ".kh_bieu_124 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,";
            sql += "c11=:m_c11,c12=:m_c12,c13=:m_c13,c14=:m_c14,c15=:m_c15,c16=:m_c16,c17=:m_c17,";
            sql += "c18=:m_c18,c19=:m_c19,c20=:m_c20,c21=:m_c21,c22=:m_c22,c23=:m_c23,c24=:m_c24,userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                cmd.Parameters.Add("m_c20", NpgsqlDbType.Numeric).Value = m_c20;
                cmd.Parameters.Add("m_c21", NpgsqlDbType.Numeric).Value = m_c21;
                cmd.Parameters.Add("m_c22", NpgsqlDbType.Numeric).Value = m_c22;
                cmd.Parameters.Add("m_c23", NpgsqlDbType.Numeric).Value = m_c23;
                cmd.Parameters.Add("m_c24", NpgsqlDbType.Numeric).Value = m_c24;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".kh_bieu_124(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,c13,c14,c15,c16,c17,c18,c19,c20,c21,c22,c23,c24,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_c11,:m_c12,:m_c13,:m_c14,:m_c15,:m_c16,:m_c17,:m_c18,:m_c19,:m_c20,:m_c21,:m_c22,:m_c23,:m_c24,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                    cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                    cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                    cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                    cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                    cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                    cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                    cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                    cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                    cmd.Parameters.Add("m_c20", NpgsqlDbType.Numeric).Value = m_c20;
                    cmd.Parameters.Add("m_c21", NpgsqlDbType.Numeric).Value = m_c21;
                    cmd.Parameters.Add("m_c22", NpgsqlDbType.Numeric).Value = m_c22;
                    cmd.Parameters.Add("m_c23", NpgsqlDbType.Numeric).Value = m_c23;
                    cmd.Parameters.Add("m_c24", NpgsqlDbType.Numeric).Value = m_c24;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "kh_bieu_124");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_kh131(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09,
            int m_c10, int m_c11, int m_c12, int m_c13, int m_c14, int m_c15, int m_c16,
            int m_c17, int m_c18, int m_c19, int m_c20, int m_c21, int m_c22, int m_c23, int m_userid, string m_c24)
        {
            sql = "update " + user + ".kh_bieu_131 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,";
            sql += "c11=:m_c11,c12=:m_c12,c13=:m_c13,c14=:m_c14,c15=:m_c15,c16=:m_c16,c17=:m_c17,";
            sql += "c18=:m_c18,c19=:m_c19,c20=:m_c20,c21=:m_c21,c22=:m_c22,c23=:m_c23,userid=:m_userid,c24=:m_c24 where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                cmd.Parameters.Add("m_c20", NpgsqlDbType.Numeric).Value = m_c20;
                cmd.Parameters.Add("m_c21", NpgsqlDbType.Numeric).Value = m_c21;
                cmd.Parameters.Add("m_c22", NpgsqlDbType.Numeric).Value = m_c22;
                cmd.Parameters.Add("m_c23", NpgsqlDbType.Numeric).Value = m_c23;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_c24", NpgsqlDbType.Numeric).Value = m_c24;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".kh_bieu_131(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,c13,c14,c15,c16,c17,c18,c19,c20,c21,c22,c23,userid,ngayud,c24) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_c11,:m_c12,:m_c13,:m_c14,:m_c15,:m_c16,:m_c17,:m_c18,:m_c19,:m_c20,:m_c21,:m_c22,:m_c23,:m_userid,now(),:m_c24)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                    cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                    cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                    cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                    cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                    cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                    cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                    cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                    cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                    cmd.Parameters.Add("m_c20", NpgsqlDbType.Numeric).Value = m_c20;
                    cmd.Parameters.Add("m_c21", NpgsqlDbType.Numeric).Value = m_c21;
                    cmd.Parameters.Add("m_c22", NpgsqlDbType.Numeric).Value = m_c22;
                    cmd.Parameters.Add("m_c23", NpgsqlDbType.Numeric).Value = m_c23;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    cmd.Parameters.Add("m_c24", NpgsqlDbType.Numeric).Value = m_c24;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "kh_bieu_131");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_kh132(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09,
            int m_c10, int m_c11, int m_c12, int m_c13, int m_c14, int m_c15, int m_c16,
            int m_c17, int m_c18, int m_c19, int m_c20, int m_c21, int m_c22, int m_c23,
            int m_c24, int m_c25, int m_c26, int m_c27, int m_userid)
        {
            sql = "update " + user + ".kh_bieu_132 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,";
            sql += "c11=:m_c11,c12=:m_c12,c13=:m_c13,c14=:m_c14,c15=:m_c15,c16=:m_c16,c17=:m_c17,";
            sql += "c18=:m_c18,c19=:m_c19,c20=:m_c20,c21=:m_c21,c22=:m_c22,c23=:m_c23,";
            sql += "c24=:m_c24,c25=:m_c25,c26=:m_c26,c27=:m_c27,userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                cmd.Parameters.Add("m_c20", NpgsqlDbType.Numeric).Value = m_c20;
                cmd.Parameters.Add("m_c21", NpgsqlDbType.Numeric).Value = m_c21;
                cmd.Parameters.Add("m_c22", NpgsqlDbType.Numeric).Value = m_c22;
                cmd.Parameters.Add("m_c23", NpgsqlDbType.Numeric).Value = m_c23;
                cmd.Parameters.Add("m_c24", NpgsqlDbType.Numeric).Value = m_c24;
                cmd.Parameters.Add("m_c25", NpgsqlDbType.Numeric).Value = m_c25;
                cmd.Parameters.Add("m_c26", NpgsqlDbType.Numeric).Value = m_c26;
                cmd.Parameters.Add("m_c27", NpgsqlDbType.Numeric).Value = m_c27;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".kh_bieu_132(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,c13,c14,c15,c16,c17,c18,c19,c20,c21,c22,c23,c24,c25,c26,c27,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_c11,:m_c12,:m_c13,:m_c14,:m_c15,:m_c16,:m_c17,:m_c18,:m_c19,:m_c20,:m_c21,:m_c22,:m_c23,:m_c24,:m_c25,:m_c26,:m_c27,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                    cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                    cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                    cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                    cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                    cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                    cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                    cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                    cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                    cmd.Parameters.Add("m_c20", NpgsqlDbType.Numeric).Value = m_c20;
                    cmd.Parameters.Add("m_c21", NpgsqlDbType.Numeric).Value = m_c21;
                    cmd.Parameters.Add("m_c22", NpgsqlDbType.Numeric).Value = m_c22;
                    cmd.Parameters.Add("m_c23", NpgsqlDbType.Numeric).Value = m_c23;
                    cmd.Parameters.Add("m_c24", NpgsqlDbType.Numeric).Value = m_c24;
                    cmd.Parameters.Add("m_c25", NpgsqlDbType.Numeric).Value = m_c25;
                    cmd.Parameters.Add("m_c26", NpgsqlDbType.Numeric).Value = m_c26;
                    cmd.Parameters.Add("m_c27", NpgsqlDbType.Numeric).Value = m_c27;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "kh_bieu_132");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_kh133(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09,
            int m_c10, int m_c11, int m_c12, int m_c13, int m_c14, int m_c15, int m_c16,
            int m_c17, int m_c18, int m_c19, int m_c20, int m_c21, int m_c22, int m_c23,
            int m_c24, int m_c25, int m_c26, int m_c27, int m_c28, int m_c29, int m_c30, int m_userid)
        {
            sql = "update " + user + ".kh_bieu_133 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,";
            sql += "c11=:m_c11,c12=:m_c12,c13=:m_c13,c14=:m_c14,c15=:m_c15,c16=:m_c16,c17=:m_c17,";
            sql += "c18=:m_c18,c19=:m_c19,c20=:m_c20,c21=:m_c21,c22=:m_c22,c23=:m_c23,";
            sql += "c24=:m_c24,c25=:m_c25,c26=:m_c26,c27=:m_c27,c28=:m_c28,c29=:m_c29,c30=:m_c30,userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                cmd.Parameters.Add("m_c20", NpgsqlDbType.Numeric).Value = m_c20;
                cmd.Parameters.Add("m_c21", NpgsqlDbType.Numeric).Value = m_c21;
                cmd.Parameters.Add("m_c22", NpgsqlDbType.Numeric).Value = m_c22;
                cmd.Parameters.Add("m_c23", NpgsqlDbType.Numeric).Value = m_c23;
                cmd.Parameters.Add("m_c24", NpgsqlDbType.Numeric).Value = m_c24;
                cmd.Parameters.Add("m_c25", NpgsqlDbType.Numeric).Value = m_c25;
                cmd.Parameters.Add("m_c26", NpgsqlDbType.Numeric).Value = m_c26;
                cmd.Parameters.Add("m_c27", NpgsqlDbType.Numeric).Value = m_c27;
                cmd.Parameters.Add("m_c28", NpgsqlDbType.Numeric).Value = m_c28;
                cmd.Parameters.Add("m_c29", NpgsqlDbType.Numeric).Value = m_c29;
                cmd.Parameters.Add("m_c30", NpgsqlDbType.Numeric).Value = m_c30;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".kh_bieu_133(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,c13,c14,c15,c16,c17,c18,c19,c20,c21,c22,c23,c24,c25,c26,c27,c28,c29,c30,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_c11,:m_c12,:m_c13,:m_c14,:m_c15,:m_c16,:m_c17,:m_c18,:m_c19,:m_c20,:m_c21,:m_c22,:m_c23,:m_c24,:m_c25,:m_c26,:m_c27,:m_c28,:m_c29,:m_c30,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                    cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                    cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                    cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                    cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                    cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                    cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                    cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                    cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                    cmd.Parameters.Add("m_c20", NpgsqlDbType.Numeric).Value = m_c20;
                    cmd.Parameters.Add("m_c21", NpgsqlDbType.Numeric).Value = m_c21;
                    cmd.Parameters.Add("m_c22", NpgsqlDbType.Numeric).Value = m_c22;
                    cmd.Parameters.Add("m_c23", NpgsqlDbType.Numeric).Value = m_c23;
                    cmd.Parameters.Add("m_c24", NpgsqlDbType.Numeric).Value = m_c24;
                    cmd.Parameters.Add("m_c25", NpgsqlDbType.Numeric).Value = m_c25;
                    cmd.Parameters.Add("m_c26", NpgsqlDbType.Numeric).Value = m_c26;
                    cmd.Parameters.Add("m_c27", NpgsqlDbType.Numeric).Value = m_c27;
                    cmd.Parameters.Add("m_c28", NpgsqlDbType.Numeric).Value = m_c28;
                    cmd.Parameters.Add("m_c29", NpgsqlDbType.Numeric).Value = m_c29;
                    cmd.Parameters.Add("m_c30", NpgsqlDbType.Numeric).Value = m_c30;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "kh_bieu_133");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_kh141(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09,
            int m_c10, int m_c11, int m_c12, int m_c13, int m_c14, int m_c15, int m_c16,
            int m_c17, int m_c18, int m_c19, int m_c20, int m_c21, int m_c22, int m_c23,
            int m_c24, int m_c25, int m_c26, int m_c27, int m_c28, int m_userid, int m_c29, int m_c30,
            int m_c31, int m_c32, int m_c33, int m_c34, int m_c35, int m_c36, int m_c37,
            int m_c38, int m_c39, int m_c40, int m_c41, int m_c42, int m_c43, int m_c44,
            int m_c45, int m_c46, int m_c47, int m_c48, int m_c49, int m_c50, int m_c51,
            int m_c52, int m_c53, int m_c54, int m_c55, int m_c56)
        {
            sql = "update " + user + ".kh_bieu_141 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,";
            sql += "c11=:m_c11,c12=:m_c12,c13=:m_c13,c14=:m_c14,c15=:m_c15,c16=:m_c16,c17=:m_c17,";
            sql += "c18=:m_c18,c19=:m_c19,c20=:m_c20,c21=:m_c21,c22=:m_c22,c23=:m_c23,";
            sql += "c24=:m_c24,c25=:m_c25,c26=:m_c26,c27=:m_c27,c28=:m_c28,userid=:m_userid,c29=:m_c29,c30=:m_c30,c31=:m_c31,c32=:m_c32,";
            sql += "c33=:m_c33,c34=:m_c34,c35=:m_c35,c36=:m_c36,c37=:m_c37,c38=:m_c38,";
            sql += "c39=:m_c39,c40=:m_c40,c41=:m_c41,c42=:m_c42,c43=:m_c43,c44=:m_c44,c45=:m_c45,";
            sql += "c46=:m_c46,c47=:m_c47,c48=:m_c48,c49=:m_c49,c50=:m_c50,c51=:m_c51,";
            sql += "c52=:m_c52,c53=:m_c53,c54=:m_c54,c55=:m_c55,c56=:m_c56 where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                cmd.Parameters.Add("m_c20", NpgsqlDbType.Numeric).Value = m_c20;
                cmd.Parameters.Add("m_c21", NpgsqlDbType.Numeric).Value = m_c21;
                cmd.Parameters.Add("m_c22", NpgsqlDbType.Numeric).Value = m_c22;
                cmd.Parameters.Add("m_c23", NpgsqlDbType.Numeric).Value = m_c23;
                cmd.Parameters.Add("m_c24", NpgsqlDbType.Numeric).Value = m_c24;
                cmd.Parameters.Add("m_c25", NpgsqlDbType.Numeric).Value = m_c25;
                cmd.Parameters.Add("m_c26", NpgsqlDbType.Numeric).Value = m_c26;
                cmd.Parameters.Add("m_c27", NpgsqlDbType.Numeric).Value = m_c27;
                cmd.Parameters.Add("m_c28", NpgsqlDbType.Numeric).Value = m_c28;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_c29", NpgsqlDbType.Numeric).Value = m_c29;
                cmd.Parameters.Add("m_c30", NpgsqlDbType.Numeric).Value = m_c30;
                cmd.Parameters.Add("m_c31", NpgsqlDbType.Numeric).Value = m_c31;
                cmd.Parameters.Add("m_c32", NpgsqlDbType.Numeric).Value = m_c32;
                cmd.Parameters.Add("m_c33", NpgsqlDbType.Numeric).Value = m_c33;
                cmd.Parameters.Add("m_c34", NpgsqlDbType.Numeric).Value = m_c34;
                cmd.Parameters.Add("m_c35", NpgsqlDbType.Numeric).Value = m_c35;
                cmd.Parameters.Add("m_c36", NpgsqlDbType.Numeric).Value = m_c36;
                cmd.Parameters.Add("m_c37", NpgsqlDbType.Numeric).Value = m_c37;
                cmd.Parameters.Add("m_c38", NpgsqlDbType.Numeric).Value = m_c38;
                cmd.Parameters.Add("m_c39", NpgsqlDbType.Numeric).Value = m_c39;
                cmd.Parameters.Add("m_c40", NpgsqlDbType.Numeric).Value = m_c40;
                cmd.Parameters.Add("m_c41", NpgsqlDbType.Numeric).Value = m_c41;
                cmd.Parameters.Add("m_c42", NpgsqlDbType.Numeric).Value = m_c42;
                cmd.Parameters.Add("m_c43", NpgsqlDbType.Numeric).Value = m_c43;
                cmd.Parameters.Add("m_c44", NpgsqlDbType.Numeric).Value = m_c44;
                cmd.Parameters.Add("m_c45", NpgsqlDbType.Numeric).Value = m_c45;
                cmd.Parameters.Add("m_c46", NpgsqlDbType.Numeric).Value = m_c46;
                cmd.Parameters.Add("m_c47", NpgsqlDbType.Numeric).Value = m_c47;
                cmd.Parameters.Add("m_c48", NpgsqlDbType.Numeric).Value = m_c48;
                cmd.Parameters.Add("m_c49", NpgsqlDbType.Numeric).Value = m_c49;
                cmd.Parameters.Add("m_c50", NpgsqlDbType.Numeric).Value = m_c50;
                cmd.Parameters.Add("m_c51", NpgsqlDbType.Numeric).Value = m_c51;
                cmd.Parameters.Add("m_c52", NpgsqlDbType.Numeric).Value = m_c52;
                cmd.Parameters.Add("m_c53", NpgsqlDbType.Numeric).Value = m_c53;
                cmd.Parameters.Add("m_c54", NpgsqlDbType.Numeric).Value = m_c54;
                cmd.Parameters.Add("m_c55", NpgsqlDbType.Numeric).Value = m_c55;
                cmd.Parameters.Add("m_c56", NpgsqlDbType.Numeric).Value = m_c56;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".kh_bieu_141(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,c13,c14,c15,c16,c17,c18,c19,c20,c21,c22,c23,c24,c25,c26,c27,c28,userid,ngayud";
                    sql += ",c29,c30,c31,c32,c33,c34,c35,c36,c37,c38,c39,c40,c41,c42,c43,c44,c45,c46,c47,c48,c49,c50,c51,c52,c53,c54,c55,c56) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_c11,:m_c12,:m_c13,:m_c14,:m_c15,:m_c16,:m_c17,:m_c18,:m_c19,:m_c20,:m_c21,:m_c22,:m_c23,:m_c24,:m_c25,:m_c26,:m_c27,:m_c28,:m_userid,now()";
                    sql += ",:m_c29,:m_c30,:m_c31,:m_c32,:m_c33,:m_c34,:m_c35,:m_c36,:m_c37,:m_c38,:m_c39,:m_c40,:m_c41,:m_c42,:m_c43,:m_c44,:m_c45,:m_c46,:m_c47,:m_c48,:m_c49,:m_c50,:m_c51,:m_c52,:m_c53,:m_c54,:m_c55,:m_c56)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                    cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                    cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                    cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                    cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                    cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                    cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                    cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                    cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                    cmd.Parameters.Add("m_c20", NpgsqlDbType.Numeric).Value = m_c20;
                    cmd.Parameters.Add("m_c21", NpgsqlDbType.Numeric).Value = m_c21;
                    cmd.Parameters.Add("m_c22", NpgsqlDbType.Numeric).Value = m_c22;
                    cmd.Parameters.Add("m_c23", NpgsqlDbType.Numeric).Value = m_c23;
                    cmd.Parameters.Add("m_c24", NpgsqlDbType.Numeric).Value = m_c24;
                    cmd.Parameters.Add("m_c25", NpgsqlDbType.Numeric).Value = m_c25;
                    cmd.Parameters.Add("m_c26", NpgsqlDbType.Numeric).Value = m_c26;
                    cmd.Parameters.Add("m_c27", NpgsqlDbType.Numeric).Value = m_c27;
                    cmd.Parameters.Add("m_c28", NpgsqlDbType.Numeric).Value = m_c28;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    cmd.Parameters.Add("m_c29", NpgsqlDbType.Numeric).Value = m_c29;
                    cmd.Parameters.Add("m_c30", NpgsqlDbType.Numeric).Value = m_c30;
                    cmd.Parameters.Add("m_c31", NpgsqlDbType.Numeric).Value = m_c31;
                    cmd.Parameters.Add("m_c32", NpgsqlDbType.Numeric).Value = m_c32;
                    cmd.Parameters.Add("m_c33", NpgsqlDbType.Numeric).Value = m_c33;
                    cmd.Parameters.Add("m_c34", NpgsqlDbType.Numeric).Value = m_c34;
                    cmd.Parameters.Add("m_c35", NpgsqlDbType.Numeric).Value = m_c35;
                    cmd.Parameters.Add("m_c36", NpgsqlDbType.Numeric).Value = m_c36;
                    cmd.Parameters.Add("m_c37", NpgsqlDbType.Numeric).Value = m_c37;
                    cmd.Parameters.Add("m_c38", NpgsqlDbType.Numeric).Value = m_c38;
                    cmd.Parameters.Add("m_c39", NpgsqlDbType.Numeric).Value = m_c39;
                    cmd.Parameters.Add("m_c40", NpgsqlDbType.Numeric).Value = m_c40;
                    cmd.Parameters.Add("m_c41", NpgsqlDbType.Numeric).Value = m_c41;
                    cmd.Parameters.Add("m_c42", NpgsqlDbType.Numeric).Value = m_c42;
                    cmd.Parameters.Add("m_c43", NpgsqlDbType.Numeric).Value = m_c43;
                    cmd.Parameters.Add("m_c44", NpgsqlDbType.Numeric).Value = m_c44;
                    cmd.Parameters.Add("m_c45", NpgsqlDbType.Numeric).Value = m_c45;
                    cmd.Parameters.Add("m_c46", NpgsqlDbType.Numeric).Value = m_c46;
                    cmd.Parameters.Add("m_c47", NpgsqlDbType.Numeric).Value = m_c47;
                    cmd.Parameters.Add("m_c48", NpgsqlDbType.Numeric).Value = m_c48;
                    cmd.Parameters.Add("m_c49", NpgsqlDbType.Numeric).Value = m_c49;
                    cmd.Parameters.Add("m_c50", NpgsqlDbType.Numeric).Value = m_c50;
                    cmd.Parameters.Add("m_c51", NpgsqlDbType.Numeric).Value = m_c51;
                    cmd.Parameters.Add("m_c52", NpgsqlDbType.Numeric).Value = m_c52;
                    cmd.Parameters.Add("m_c53", NpgsqlDbType.Numeric).Value = m_c53;
                    cmd.Parameters.Add("m_c54", NpgsqlDbType.Numeric).Value = m_c54;
                    cmd.Parameters.Add("m_c55", NpgsqlDbType.Numeric).Value = m_c55;
                    cmd.Parameters.Add("m_c56", NpgsqlDbType.Numeric).Value = m_c56;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "kh_bieu_141");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_kh142(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09,
            int m_c10, int m_c11, int m_c12, int m_c13, int m_c14, int m_c15, int m_c16,
            int m_c17, int m_c18, int m_c19, int m_c20, int m_c21, int m_c22, int m_userid)
        {
            sql = "update " + user + ".kh_bieu_142 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,";
            sql += "c11=:m_c11,c12=:m_c12,c13=:m_c13,c14=:m_c14,c15=:m_c15,c16=:m_c16,c17=:m_c17,";
            sql += "c18=:m_c18,c19=:m_c19,c20=:m_c20,c21=:m_c21,c22=:m_c22,";
            sql += "userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                cmd.Parameters.Add("m_c20", NpgsqlDbType.Numeric).Value = m_c20;
                cmd.Parameters.Add("m_c21", NpgsqlDbType.Numeric).Value = m_c21;
                cmd.Parameters.Add("m_c22", NpgsqlDbType.Numeric).Value = m_c22;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".kh_bieu_142(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,c13,c14,c15,c16,c17,c18,c19,c20,c21,c22,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_c11,:m_c12,:m_c13,:m_c14,:m_c15,:m_c16,:m_c17,:m_c18,:m_c19,:m_c20,:m_c21,:m_c22,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                    cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                    cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                    cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                    cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                    cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                    cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                    cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                    cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                    cmd.Parameters.Add("m_c20", NpgsqlDbType.Numeric).Value = m_c20;
                    cmd.Parameters.Add("m_c21", NpgsqlDbType.Numeric).Value = m_c21;
                    cmd.Parameters.Add("m_c22", NpgsqlDbType.Numeric).Value = m_c22;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "kh_bieu_142");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_kh143(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09,
            int m_c10, int m_c11, int m_c12, int m_c13, int m_c14, int m_c15, int m_c16,
            int m_c17, int m_c18, int m_c19, int m_c20, int m_c21, int m_c22, int m_userid)
        {
            sql = "update " + user + ".kh_bieu_143 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,";
            sql += "c11=:m_c11,c12=:m_c12,c13=:m_c13,c14=:m_c14,c15=:m_c15,c16=:m_c16,c17=:m_c17,";
            sql += "c18=:m_c18,c19=:m_c19,c20=:m_c20,c21=:m_c21,c22=:m_c22,";
            sql += "userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                cmd.Parameters.Add("m_c20", NpgsqlDbType.Numeric).Value = m_c20;
                cmd.Parameters.Add("m_c21", NpgsqlDbType.Numeric).Value = m_c21;
                cmd.Parameters.Add("m_c22", NpgsqlDbType.Numeric).Value = m_c22;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".kh_bieu_143(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,c13,c14,c15,c16,c17,c18,c19,c20,c21,c22,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_c11,:m_c12,:m_c13,:m_c14,:m_c15,:m_c16,:m_c17,:m_c18,:m_c19,:m_c20,:m_c21,:m_c22,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                    cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                    cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                    cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                    cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                    cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                    cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                    cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                    cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                    cmd.Parameters.Add("m_c20", NpgsqlDbType.Numeric).Value = m_c20;
                    cmd.Parameters.Add("m_c21", NpgsqlDbType.Numeric).Value = m_c21;
                    cmd.Parameters.Add("m_c22", NpgsqlDbType.Numeric).Value = m_c22;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "kh_bieu_143");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_kh144(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09,
            int m_c10, int m_c11, int m_c12, int m_c13, int m_c14, int m_c15, int m_c16,
            int m_c17, int m_c18, int m_c19, int m_c20, int m_c21, int m_c22, int m_c23,
            int m_c24, int m_c25, int m_c26, int m_c27, int m_c28, int m_userid)
        {
            sql = "update " + user + ".kh_bieu_144 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,";
            sql += "c11=:m_c11,c12=:m_c12,c13=:m_c13,c14=:m_c14,c15=:m_c15,c16=:m_c16,c17=:m_c17,";
            sql += "c18=:m_c18,c19=:m_c19,c20=:m_c20,c21=:m_c21,c22=:m_c22,c23=:m_c23,";
            sql += "c24=:m_c24,c25=:m_c25,c26=:m_c26,c27=:m_c27,c28=:m_c28,userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                cmd.Parameters.Add("m_c20", NpgsqlDbType.Numeric).Value = m_c20;
                cmd.Parameters.Add("m_c21", NpgsqlDbType.Numeric).Value = m_c21;
                cmd.Parameters.Add("m_c22", NpgsqlDbType.Numeric).Value = m_c22;
                cmd.Parameters.Add("m_c23", NpgsqlDbType.Numeric).Value = m_c23;
                cmd.Parameters.Add("m_c24", NpgsqlDbType.Numeric).Value = m_c24;
                cmd.Parameters.Add("m_c25", NpgsqlDbType.Numeric).Value = m_c25;
                cmd.Parameters.Add("m_c26", NpgsqlDbType.Numeric).Value = m_c26;
                cmd.Parameters.Add("m_c27", NpgsqlDbType.Numeric).Value = m_c27;
                cmd.Parameters.Add("m_c28", NpgsqlDbType.Numeric).Value = m_c28;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".kh_bieu_144(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,c13,c14,c15,c16,c17,c18,c19,c20,c21,c22,c23,c24,c25,c26,c27,c28,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_c11,:m_c12,:m_c13,:m_c14,:m_c15,:m_c16,:m_c17,:m_c18,:m_c19,:m_c20,:m_c21,:m_c22,:m_c23,:m_c24,:m_c25,:m_c26,:m_c27,:m_c28,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                    cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                    cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                    cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                    cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                    cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                    cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                    cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                    cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                    cmd.Parameters.Add("m_c20", NpgsqlDbType.Numeric).Value = m_c20;
                    cmd.Parameters.Add("m_c21", NpgsqlDbType.Numeric).Value = m_c21;
                    cmd.Parameters.Add("m_c22", NpgsqlDbType.Numeric).Value = m_c22;
                    cmd.Parameters.Add("m_c23", NpgsqlDbType.Numeric).Value = m_c23;
                    cmd.Parameters.Add("m_c24", NpgsqlDbType.Numeric).Value = m_c24;
                    cmd.Parameters.Add("m_c25", NpgsqlDbType.Numeric).Value = m_c25;
                    cmd.Parameters.Add("m_c26", NpgsqlDbType.Numeric).Value = m_c26;
                    cmd.Parameters.Add("m_c27", NpgsqlDbType.Numeric).Value = m_c27;
                    cmd.Parameters.Add("m_c28", NpgsqlDbType.Numeric).Value = m_c28;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "kh_bieu_144");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_kh1451(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09,
            int m_c10, int m_c11, int m_c12, int m_c13, int m_c14, int m_c15, int m_c16,
            int m_c17, int m_c18, int m_c19, int m_c20, int m_userid)
        {
            sql = "update " + user + ".kh_bieu_1451 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,";
            sql += "c11=:m_c11,c12=:m_c12,c13=:m_c13,c14=:m_c14,c15=:m_c15,c16=:m_c16,c17=:m_c17,";
            sql += "c18=:m_c18,c19=:m_c19,c20=:m_c20,userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                cmd.Parameters.Add("m_c20", NpgsqlDbType.Numeric).Value = m_c20;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".kh_bieu_1451(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,c13,c14,c15,c16,c17,c18,c19,c20,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_c11,:m_c12,:m_c13,:m_c14,:m_c15,:m_c16,:m_c17,:m_c18,:m_c19,:m_c20,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                    cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                    cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                    cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                    cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                    cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                    cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                    cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                    cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                    cmd.Parameters.Add("m_c20", NpgsqlDbType.Numeric).Value = m_c20;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "kh_bieu_1451");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_kh1452(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_userid)
        {
            sql = "update " + user + ".kh_bieu_1452 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,";
            sql += "userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".kh_bieu_1452(id,ma,ngay,c01,c02,c03,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "kh_bieu_1452");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        #endregion

        #region import
        /// <summary>
        /// 
        /// </summary>
        public bool imp_benhandt(string m_mabn, decimal m_maql, string m_makp, string m_ngay, int m_dentu, int m_nhantu, int m_lanthu, int m_madoituong, string m_chandoan, string m_maicd, string m_mabs, string m_sovaovien, int m_loaiba, int m_userid)
        {
            sql = "update " + user + ".benhandt set ";
            sql += "makp=:m_makp,";
            sql += "ngay=:m_ngay,dentu=:m_dentu,nhantu=:m_nhantu,";
            sql += "lanthu=:m_lanthu,madoituong=:m_madoituong,chandoan=:m_chandoan,maicd=:m_maicd,mabs=:m_mabs,";
            sql += "sovaovien=:m_sovaovien,";
            sql += "loaiba=:m_loaiba,userid=:m_userid where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_dentu", NpgsqlDbType.Numeric).Value = m_dentu;
                cmd.Parameters.Add("m_nhantu", NpgsqlDbType.Numeric).Value = m_nhantu;
                cmd.Parameters.Add("m_lanthu", NpgsqlDbType.Numeric).Value = m_lanthu;
                cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_sovaovien", NpgsqlDbType.Varchar, 10).Value = m_sovaovien;
                cmd.Parameters.Add("m_loaiba", NpgsqlDbType.Numeric).Value = m_loaiba;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".benhandt(mabn,maql,makp,ngay,dentu,nhantu,lanthu,madoituong,chandoan,maicd,mabs,sovaovien,loaiba,userid,ngayud)";
                    sql += " values (:m_mabn,:m_maql,:m_makp,:m_ngay,:m_dentu,:m_nhantu,:m_lanthu,:m_madoituong,:m_chandoan,:m_maicd,:m_mabs,:m_sovaovien,:m_loaiba,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_dentu", NpgsqlDbType.Numeric).Value = m_dentu;
                    cmd.Parameters.Add("m_nhantu", NpgsqlDbType.Numeric).Value = m_nhantu;
                    cmd.Parameters.Add("m_lanthu", NpgsqlDbType.Numeric).Value = m_lanthu;
                    cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                    cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                    cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    cmd.Parameters.Add("m_sovaovien", NpgsqlDbType.Varchar, 10).Value = m_sovaovien;
                    cmd.Parameters.Add("m_loaiba", NpgsqlDbType.Numeric).Value = m_loaiba;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "i_benhan " + m_maql.ToString());
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool imp_nhapkhoa(decimal m_id, string m_mabn, decimal m_maql, string m_makp,
            int m_maba, string m_ngay, string m_tuoivao, string m_giuong, string m_khoachuyen,
            string m_chandoan, string m_maicd, string m_mabs, int m_lan, int m_userid)
        {
            sql = "update " + user + ".nhapkhoa set makp=:m_makp,maba=:m_maba,ngay=:m_ngay,";
            sql += "tuoivao=:m_tuoivao,giuong=:m_giuong,khoachuyen=:m_khoachuyen,";
            sql += "chandoan=:m_chandoan,maicd=:m_maicd,mabs=:m_mabs,lan=:m_lan,";
            sql += "userid=:m_userid where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                cmd.Parameters.Add("m_maba", NpgsqlDbType.Numeric).Value = m_maba;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_tuoivao", NpgsqlDbType.Varchar, 4).Value = m_tuoivao;
                cmd.Parameters.Add("m_giuong", NpgsqlDbType.Varchar, 10).Value = m_giuong;
                cmd.Parameters.Add("m_khoachuyen", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_khoachuyen;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_lan", NpgsqlDbType.Numeric).Value = m_lan;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".nhapkhoa(id,mabn,maql,makp,maba,ngay,tuoivao,giuong,khoachuyen,chandoan,maicd,mabs,lan,userid,ngayud)";
                    sql += " values (:m_id,:m_mabn,:m_maql,:m_makp,:m_maba,:m_ngay,:m_tuoivao,:m_giuong,:m_khoachuyen,:m_chandoan,:m_maicd,:m_mabs,:m_lan,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_maba", NpgsqlDbType.Numeric).Value = m_maba;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_tuoivao", NpgsqlDbType.Varchar, 4).Value = m_tuoivao;
                    cmd.Parameters.Add("m_giuong", NpgsqlDbType.Varchar, 10).Value = m_giuong;
                    cmd.Parameters.Add("m_khoachuyen", NpgsqlDbType.Varchar, 2).Value = m_khoachuyen;
                    cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                    cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    cmd.Parameters.Add("m_lan", NpgsqlDbType.Numeric).Value = m_lan;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "i_nkhoa " + m_id.ToString());
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool imp_xuatkhoa(decimal m_id, string m_ngay, int m_ketqua, int m_ttlucrk,
            string m_chandoan, string m_maicd, string m_mabs, int m_bienchung, int m_taibien, int m_giaiphau, int m_userid)
        {
            sql = "update " + user + ".xuatkhoa set ngay=:m_ngay,ketqua=:m_ketqua,ttlucrk=:m_ttlucrk,";
            sql += "chandoan=:m_chandoan,maicd=:m_maicd,mabs=:m_mabs,bienchung=:m_bienchung,";
            sql += "taibien=:m_taibien,giaiphau=:m_giaiphau,userid=:m_userid where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_ketqua", NpgsqlDbType.Numeric).Value = m_ketqua;
                cmd.Parameters.Add("m_ttlucrk", NpgsqlDbType.Numeric).Value = m_ttlucrk;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_bienchung", NpgsqlDbType.Numeric).Value = m_bienchung;
                cmd.Parameters.Add("m_taibien", NpgsqlDbType.Numeric).Value = m_taibien;
                cmd.Parameters.Add("m_giaiphau", NpgsqlDbType.Numeric).Value = m_giaiphau;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".xuatkhoa(id,ngay,ketqua,ttlucrk,chandoan,maicd,mabs,bienchung,taibien,giaiphau,userid,ngayud)";
                    sql += "values (:m_id,:m_ngay,:m_ketqua,:m_ttlucrk,:m_chandoan,:m_maicd,:m_mabs,:m_bienchung,:m_taibien,:m_giaiphau,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_ketqua", NpgsqlDbType.Numeric).Value = m_ketqua;
                    cmd.Parameters.Add("m_ttlucrk", NpgsqlDbType.Numeric).Value = m_ttlucrk;
                    cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                    cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    cmd.Parameters.Add("m_bienchung", NpgsqlDbType.Numeric).Value = m_bienchung;
                    cmd.Parameters.Add("m_taibien", NpgsqlDbType.Numeric).Value = m_taibien;
                    cmd.Parameters.Add("m_giaiphau", NpgsqlDbType.Numeric).Value = m_giaiphau;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "i_xkhoa " + m_id.ToString());
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool imp_xuatvien(string m_mabn, decimal m_maql, string m_makp, string m_ngay, int m_ketqua, int m_ttlucrv,
            string m_chandoan, string m_maicd, string m_mabs, string m_soluutru, int m_bienchung, int m_taibien, int m_giaiphau, int m_userid)
        {
            string sql = "update " + user + ".xuatvien set makp=:m_makp,ngay=:m_ngay,";
            sql += "ketqua=:m_ketqua,ttlucrv=:m_ttlucrv,chandoan=:m_chandoan,";
            sql += "maicd=:m_maicd,mabs=:m_mabs,soluutru=:m_soluutru,bienchung=:m_bienchung,";
            sql += "taibien=:m_taibien,giaiphau=:m_giaiphau,userid=:m_userid";
            sql += " where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_ketqua", NpgsqlDbType.Numeric).Value = m_ketqua;
                cmd.Parameters.Add("m_ttlucrv", NpgsqlDbType.Numeric).Value = m_ttlucrv;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_soluutru", NpgsqlDbType.Varchar, 10).Value = m_soluutru;
                cmd.Parameters.Add("m_bienchung", NpgsqlDbType.Numeric).Value = m_bienchung;
                cmd.Parameters.Add("m_taibien", NpgsqlDbType.Numeric).Value = m_taibien;
                cmd.Parameters.Add("m_giaiphau", NpgsqlDbType.Numeric).Value = m_giaiphau;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".xuatvien (mabn,maql,makp,ngay,ketqua,ttlucrv,chandoan,maicd,mabs,soluutru,bienchung,taibien,giaiphau,userid,ngayud)";
                    sql += " values (:m_mabn,:m_maql,:m_makp,:m_ngay,:m_ketqua,:m_ttlucrv,:m_chandoan,:m_maicd,:m_mabs,:m_soluutru,:m_bienchung,:m_taibien,:m_giaiphau,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_ketqua", NpgsqlDbType.Numeric).Value = m_ketqua;
                    cmd.Parameters.Add("m_ttlucrv", NpgsqlDbType.Numeric).Value = m_ttlucrv;
                    cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                    cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    cmd.Parameters.Add("m_soluutru", NpgsqlDbType.Varchar, 10).Value = m_soluutru;
                    cmd.Parameters.Add("m_bienchung", NpgsqlDbType.Numeric).Value = m_bienchung;
                    cmd.Parameters.Add("m_taibien", NpgsqlDbType.Numeric).Value = m_taibien;
                    cmd.Parameters.Add("m_giaiphau", NpgsqlDbType.Numeric).Value = m_giaiphau;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
                con.Close(); con.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "i_xvien " + m_maql.ToString());
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        #endregion

        public bool upd_baocao(string m_table, string m_ma, string m_ten)
        {
            sql = "update " + user + "." + m_table + " set ten=:m_ten where ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + "." + m_table + " (ma,ten) values (:m_ma,:m_ten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar).Value = m_ma;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, m_table);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_doituong(int m_madoituong, string m_doituong, int m_sothe, int m_ngay, int m_mabv, int m_mien, string m_field_gia, int m_trasau, int m_cholam,int m_bodoi)
        {
            sql = "update " + user + ".doituong set doituong=:m_doituong,sothe=:m_sothe,ngay=:m_ngay,mabv=:m_mabv,mien=:m_mien,field_gia=:m_field_gia,trasau=:m_trasau,cholam=:m_cholam,bodoi=:m_bodoi where madoituong=:m_madoituong";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_doituong", NpgsqlDbType.Text, 30).Value = m_doituong;
                cmd.Parameters.Add("m_sothe", NpgsqlDbType.Numeric).Value = m_sothe;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Numeric).Value = m_ngay;
                cmd.Parameters.Add("m_mabv", NpgsqlDbType.Numeric).Value = m_mabv;
                cmd.Parameters.Add("m_mien", NpgsqlDbType.Numeric).Value = m_mien;
                cmd.Parameters.Add("m_field_gia", NpgsqlDbType.Varchar, 10).Value = m_field_gia;
                cmd.Parameters.Add("m_trasau", NpgsqlDbType.Numeric).Value = m_trasau;
                cmd.Parameters.Add("m_cholam", NpgsqlDbType.Numeric).Value = m_cholam;
                cmd.Parameters.Add("m_bodoi", NpgsqlDbType.Numeric).Value = m_bodoi;
                cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".doituong (madoituong,doituong,sothe,ngay,mabv,mien,field_gia,trasau,cholam,bodoi) values (:m_madoituong,:m_doituong,:m_sothe,:m_ngay,:m_mabv,:m_mien,:m_field_gia,:m_trasau,:m_cholam,:m_bodoi)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                    cmd.Parameters.Add("m_doituong", NpgsqlDbType.Text, 30).Value = m_doituong;
                    cmd.Parameters.Add("m_sothe", NpgsqlDbType.Numeric).Value = m_sothe;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Numeric).Value = m_ngay;
                    cmd.Parameters.Add("m_mabv", NpgsqlDbType.Numeric).Value = m_mabv;
                    cmd.Parameters.Add("m_mien", NpgsqlDbType.Numeric).Value = m_mien;
                    cmd.Parameters.Add("m_field_gia", NpgsqlDbType.Varchar, 10).Value = m_field_gia;
                    cmd.Parameters.Add("m_trasau", NpgsqlDbType.Numeric).Value = m_trasau;
                    cmd.Parameters.Add("m_cholam", NpgsqlDbType.Numeric).Value = m_cholam;
                    cmd.Parameters.Add("m_bodoi", NpgsqlDbType.Numeric).Value = m_bodoi;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "doituong");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_dmicd10(string m_ma)
        {
            sql = "update " + user + ".dmicd10 set ma=:m_ma where ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dmicd10 (ma) values (:m_ma)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar).Value = m_ma;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dmicd10");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_dmtuoi(int m_ma, string m_ten, int m_tu, int m_den)
        {
            sql = "update " + user + ".dmtuoi set ten=:m_ten,tu=:m_tu,den=:m_den where ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Varchar).Value = m_ten;
                cmd.Parameters.Add("m_tu", NpgsqlDbType.Numeric).Value = m_tu;
                cmd.Parameters.Add("m_den", NpgsqlDbType.Numeric).Value = m_den;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dmtuoi (ma,ten,tu,den) values (:m_ma,:m_ten,:m_tu,:m_den)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Varchar).Value = m_ten;
                    cmd.Parameters.Add("m_tu", NpgsqlDbType.Numeric).Value = m_tu;
                    cmd.Parameters.Add("m_den", NpgsqlDbType.Numeric).Value = m_den;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dmtuoi");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_dmpttt(string m_mapt, string m_mapttt, string m_noi_dung,
            string m_dacbiet, string m_loai1, string m_loai2, string m_loai3,
            int m_loaipt, int m_id_pttt, int m_id_muc, int m_mavp)
        {
            sql = "update " + user + ".dmpttt set noi_dung=:m_noi_dung,dacbiet=:m_dacbiet,loai1=:m_loai1,";
            sql += "loai2=:m_loai2,loai3=:m_loai3,loaipt=:m_loaipt,id_pttt=:m_id_pttt,id_muc=:m_id_muc,mavp=" + m_mavp;
            sql += " where mapt=:m_mapt";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_noi_dung", NpgsqlDbType.Text).Value = m_noi_dung;
                cmd.Parameters.Add("m_dacbiet", NpgsqlDbType.Varchar, 1).Value = m_dacbiet;
                cmd.Parameters.Add("m_loai1", NpgsqlDbType.Varchar, 1).Value = m_loai1;
                cmd.Parameters.Add("m_loai2", NpgsqlDbType.Varchar, 1).Value = m_loai2;
                cmd.Parameters.Add("m_loai3", NpgsqlDbType.Varchar, 1).Value = m_loai3;
                cmd.Parameters.Add("m_loaipt", NpgsqlDbType.Numeric).Value = m_loaipt;
                cmd.Parameters.Add("m_id_pttt", NpgsqlDbType.Numeric).Value = m_id_pttt;
                cmd.Parameters.Add("m_id_muc", NpgsqlDbType.Numeric).Value = m_id_muc;
                cmd.Parameters.Add("m_mapt", NpgsqlDbType.Varchar, 6).Value = m_mapt;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dmpttt (mapt,mapttt,noi_dung,dacbiet,loai1,loai2,loai3,loaipt,id_pttt,id_muc,mavp) values (:m_mapt,:m_mapttt,:m_noi_dung,:m_dacbiet,:m_loai1,:m_loai2,:m_loai3,:m_loaipt,:m_id_pttt,:m_id_muc," + m_mavp + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mapt", NpgsqlDbType.Varchar, 6).Value = m_mapt;
                    cmd.Parameters.Add("m_mapttt", NpgsqlDbType.Varchar, 9).Value = m_mapttt;
                    cmd.Parameters.Add("m_noi_dung", NpgsqlDbType.Text).Value = m_noi_dung;
                    cmd.Parameters.Add("m_dacbiet", NpgsqlDbType.Varchar, 1).Value = m_dacbiet;
                    cmd.Parameters.Add("m_loai1", NpgsqlDbType.Varchar, 1).Value = m_loai1;
                    cmd.Parameters.Add("m_loai2", NpgsqlDbType.Varchar, 1).Value = m_loai2;
                    cmd.Parameters.Add("m_loai3", NpgsqlDbType.Varchar, 1).Value = m_loai3;
                    cmd.Parameters.Add("m_loaipt", NpgsqlDbType.Numeric).Value = m_loaipt;
                    cmd.Parameters.Add("m_id_pttt", NpgsqlDbType.Numeric).Value = m_id_pttt;
                    cmd.Parameters.Add("m_id_muc", NpgsqlDbType.Numeric).Value = m_id_muc;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dmpttt");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public DataSet get_data(string thumuc, string sql)
        {
            string Connectstring = "Provider=vfpoledb.1;Data Source=" + thumuc + "//;Collating Sequence=general";
            DataSet ds = new DataSet();
            try
            {
                OleDbConnection cn = new OleDbConnection(Connectstring);
                cn.Open();
                OleDbCommand dcmd = new OleDbCommand(sql, cn);
                dcmd.CommandType = CommandType.Text;
                OleDbDataAdapter da = new OleDbDataAdapter(dcmd);
                da.Fill(ds);
                dcmd.Dispose();
                cn.Dispose();
            }
            catch (Exception ex)
            {
                upd_error(ex.Message.ToString().Trim(), sComputer, "?");
            }
            return ds;
        }

        public void execute_data_fox(string thumuc, string sql)
        {
            try
            {
                string Connectstring = "Provider=vfpoledb.1;Data Source=" + thumuc + "//;Collating Sequence=general";
                OleDbConnection cn = new OleDbConnection(Connectstring);
                cn.Open();
                OleDbCommand dcmd = new OleDbCommand(sql, cn);
                dcmd.CommandType = CommandType.Text;
                dcmd.ExecuteNonQuery();
                dcmd.Dispose();
                cn.Close(); cn.Dispose();
            }
            catch (Exception ex)
            {
                upd_error(ex.Message.ToString().Trim(), sComputer, "?");
            }
        }

        public string SqlStr(string sql)
        {
            XmlDocument doc = new XmlDocument();
            doc.Load("..//..//..//xml//maincode.xml");
            XmlNodeList nodeLst = doc.GetElementsByTagName(sql);
            return nodeLst.Item(0).InnerText;
        }

        public void execute_data_sql(string sql, string server, string database)
        {
            try
            {
                SqlConnection scon = new SqlConnection("Server=" + server + ";Database=" + database + ";Integrated Security=SSPI");
                scon.Open();
                SqlCommand scmd = new SqlCommand(sql, scon);
                scmd.CommandType = CommandType.Text;
                scmd.ExecuteNonQuery();
                scmd.Dispose();
                scon.Close(); con.Dispose();
            }
            catch (SqlException ex)
            {
                upd_error(ex.Message.ToString().Trim(), sComputer, "?");
            }
        }

        public DataSet get_data_sql(string sql, string server, string database)
        {
            DataSet sds = new DataSet();
            try
            {
                SqlConnection scon = new SqlConnection("Server=" + server + ";Database=" + database + ";Integrated Security=SSPI");
                scon.Open();
                SqlCommand scmd = new SqlCommand(sql, scon);
                scmd.CommandType = CommandType.Text;
                SqlDataAdapter sdest = new SqlDataAdapter(scmd);
                sdest.Fill(sds);
                scmd.Dispose();
                scon.Close(); con.Dispose();
            }
            catch (SqlException ex)
            {
                upd_error(ex.Message.ToString().Trim() + "-SQL: " + sql, sComputer, "?");
            }
            return sds;
        }
        public DataSet get_data_acc(string sql, string thumuc)
        {
            try
            {
                if (ds != null)
                {
                    ds.Dispose();
                    ds = null;
                }
                ds = new DataSet();
                string s = "Provider=Microsoft.Jet.OLEDB.4.0;User Id=;Password=;Jet OLEDB:Database Password=;Data Source=" + thumuc;
                OleDbConnection acon = new OleDbConnection(s);
                acon.Open();
                OleDbCommand acmd = new OleDbCommand(sql, acon);
                acmd.CommandType = CommandType.Text;
                OleDbDataAdapter adest = new OleDbDataAdapter(acmd);
                adest.Fill(ds);
                acmd.Dispose();
                acon.Close(); acon.Dispose();
            }
            catch (OleDbException ex)
            {
                upd_error(ex.Message.ToString().Trim(), sComputer, "?");
            }
            return ds;
        }

        public void execute_data_acc(string sql, string thumuc)
        {
            try
            {
                string s = "Provider=Microsoft.Jet.OLEDB.4.0;User Id=;Password=;Jet OLEDB:Database Password=;Data Source=" + thumuc;
                OleDbConnection acon = new OleDbConnection(s);
                acon.Open();
                OleDbCommand acmd = new OleDbCommand(sql, acon);
                acmd.CommandType = CommandType.Text;
                acmd.ExecuteNonQuery();
                acmd.Dispose();
                acon.Close(); acon.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message.ToString().Trim(), sComputer, "?");
            }
        }

        #region timkiem
        public string Viettat(string matat)
        {
            try
            {
                sql = "select daydu from " + user + ".btdvt where trim(matat)=:matat";
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("matat", NpgsqlDbType.Text).Value = matat.Trim().ToLower();
                dest = new NpgsqlDataAdapter(cmd);
                ds = new DataSet();
                dest.Fill(ds);
                cmd.Dispose();
                con.Close(); con.Dispose();
                return ds.Tables[0].Rows[0][0].ToString();
            }
            catch { return ""; }
        }

        public string get_cicd10(string tenbenh)
        {
            if (tenbenh == "") return "";
            try
            {
                sql = "select cicd10 from " + user + ".icd10 where trim(vviet)=:tenbenh";
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("tenbenh", NpgsqlDbType.Text).Value = Caps(tenbenh.Trim());
                dest = new NpgsqlDataAdapter(cmd);
                ds = new DataSet();
                dest.Fill(ds);
                cmd.Dispose();
                con.Close(); con.Dispose();
                return ds.Tables[0].Rows[0][0].ToString();
            }
            catch { return ""; };
        }

        public string get_mapt(string tenpt)
        {
            if (tenpt == "") return "";
            try
            {
                sql = "select loaipt,mapt from " + user + ".dmpttt where trim(noi_dung)=:tenpt";
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("tenpt", NpgsqlDbType.Text).Value = tenpt.Trim();
                dest = new NpgsqlDataAdapter(cmd);
                ds = new DataSet();
                dest.Fill(ds);
                cmd.Dispose();
                con.Close(); con.Dispose();
                return ds.Tables[0].Rows[0][0].ToString().Trim() + ds.Tables[0].Rows[0][1].ToString();
            }
            catch { return ""; };
        }

        public string get_madstt(string tendstt)
        {
            if (tendstt == "") return "";
            try
            {
                sql = "select mabv from " + user + ".dstt where trim(tenbv)=:tendstt";
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("tendstt", NpgsqlDbType.Text).Value = tendstt.Trim();
                dest = new NpgsqlDataAdapter(cmd);
                ds = new DataSet();
                dest.Fill(ds);
                cmd.Dispose();
                con.Close(); con.Dispose();
                return ds.Tables[0].Rows[0][0].ToString().Trim();
            }
            catch { return ""; };
        }

        public DataSet get_Timmabn(string m_hoten, string m_ngaysinh, string m_namsinh, string m_mabn)
        {
            m_hoten = Hoten_khongdau(m_hoten);
            sql = "select a.mabn,a.hoten,a.namsinh,case when a.phai=0 then 'Nam' else 'Nữ' end as phai,a.sonha,a.thon,b.tentt,c.tenquan,d.tenpxa,";
            sql += "a.nam,case when e.sothe is null then '' else e.sothe end as sothe";
            sql += " from " + user + ".btdbn a inner join " + user + ".btdtt b on a.matt=b.matt ";
            sql += " inner join " + user + ".btdquan c on a.maqu=c.maqu ";
            sql += " inner join " + user + ".btdpxa d on a.maphuongxa=d.maphuongxa";
            sql += " left join " + user + ".bhyt e on a.mabn=e.mabn";
            sql += " where a.mabn<>'" + m_mabn + "'";
            if (m_hoten != "") sql += " and a.hotenkdau='" + m_hoten.Replace("'", "''") + "'";
            if (m_ngaysinh != "" && !bBHYT_QRCode_Dangky) sql += " and to_char(a.ngaysinh,'dd/mm/yyyy')='" + m_ngaysinh + "'";
            if (m_namsinh != "") sql += " and a.namsinh='" + m_namsinh + "'";
            //if (m_mabn!="") sql+=" and a.mabn<>'"+m_mabn+"'";
            DataSet ds1 = new DataSet();
            ds1 = get_data(sql);
            if (ds1 != null && ds1.Tables.Count > 0 && ds1.Tables[0].Rows.Count > 0)
            {
                foreach (DataRow r in ds1.Tables[0].Select("sothe=''"))
                {
                    if (r["nam"].ToString().Trim() != "" && r["nam"].ToString().Trim().Length >= 5)
                    {
                        foreach (DataRow r1 in get_data_nam_dec(r["nam"].ToString(), "select sothe from xxx.bhyt where mabn='" + r["mabn"].ToString() + "'").Tables[0].Rows)
                            r["sothe"] = r1["sothe"].ToString();
                    }
                }
            }
            return ds1;
        }

        public DataSet get_Timkiem(string mabn, string hoten, string ngaysinh, string namsinh, int phai, string sonha, string thon, string mann, string madantoc, string matt, string maqu,
            string maphuongxa, string dotuoi, string dt_nha, string dt_coquan, string dt_didong, string email)
        {
            string m_dotuoi = "", usr = user;
            hoten = Hoten_khongdau(hoten);
            sql = "SELECT a.MABN, a.HOTEN, a.NAMSINH,a.SONHA,";
            sql += "a.THON, b.TENPXA, c.TENQUAN, d.TENTT, g.TENNN,";
            sql += "k.nha,k.coquan,k.didong,k.email,a.nam ";
            sql += "FROM " + usr + ".btdbn a inner join " + usr + ".btdpxa b on a.maphuongxa=b.maphuongxa ";
            sql += "inner join " + usr + ".btdquan c on a.maqu=c.maqu ";
            sql += "inner join " + usr + ".btdtt d on a.matt=d.matt ";
            sql += "inner join " + usr + ".btdnn_bv g on a.mann=g.mann ";
            sql += "left join " + usr + ".dienthoai k on a.mabn=k.mabn ";
            sql += " where a.mabn<>''";
            if (dotuoi != "")
            {
                if (dotuoi.IndexOf(">") != -1)
                {
                    m_dotuoi = dotuoi.Substring(1);
                    sql += " and to_number(to_char(now(),'yyyy'))-to_number(a.namsinh)>" + m_dotuoi;
                }
                else
                {
                    int i1 = int.Parse(dotuoi.Substring(0, dotuoi.IndexOf("-")));
                    int i2 = int.Parse(dotuoi.Substring(dotuoi.IndexOf("-") + 1));
                    sql += " and to_number(to_char(now(),'yyyy'),'0000')-to_number(a.namsinh,'0000') between " + i1 + " and " + i2;
                }
            }
            if (mabn != "") sql += " and a.mabn='" + mabn + "'";
            if (hoten != "") sql += " and a.hotenkdau like '%" + hoten + "%'";
            if (ngaysinh.Trim().Length == 10) sql += " and to_char(a.ngaysinh,'dd/mm/yyyy')='" + ngaysinh + "'";
            if (namsinh != "") sql += " and a.namsinh='" + namsinh + "'";
            if (phai != -1) sql += " and a.phai=" + phai;
            if (sonha != "") sql += " and lower(trim(a.sonha))='" + sonha.Trim().ToLower() + "'";
            if (thon != "") sql += " and lower(trim(a.thon))='" + thon.Trim().ToLower() + "'";
            if (mann != "") sql += " and a.mann='" + mann + "'";
            if (madantoc != "") sql += " and a.madantoc='" + madantoc + "'";
            if (matt != "") sql += " and a.matt='" + matt + "'";
            if (maqu != "") sql += " and a.maqu='" + maqu + "'";
            if (maphuongxa != "") sql += " and a.maphuongxa='" + maphuongxa + "'";
            if (dt_nha != "") sql += " and k.nha='" + dt_nha + "'";
            if (dt_coquan != "") sql += " and k.coquan='" + dt_coquan + "'";
            if (dt_didong != "") sql += " and k.didong='" + dt_didong + "'";
            if (email != "") sql += " and k.email='" + email + "'";
            sql += " order by a.mabn";
            return get_data(sql);
        }

        public DataSet get_Timkiem(string tungay,string denngay,string mabn, string hoten, string ngaysinh, string namsinh, int phai, string sonha, string thon, string mann, string madantoc, string matt, string maqu,
            string maphuongxa, string dotuoi, string dt_nha, string dt_coquan, string dt_didong, string email)
        {
            string m_dotuoi = "", usr = user;
            hoten = Hoten_khongdau(hoten);
            sql = "SELECT a.MABN, a.HOTEN, a.NAMSINH,a.SONHA,";
            sql += "a.THON, b.TENPXA, c.TENQUAN, d.TENTT, g.TENNN,";
            sql += "k.nha,k.coquan,k.didong,k.email,a.nam ";
            sql += "FROM " + usr + ".btdbn a inner join " + usr + ".btdpxa b on a.maphuongxa=b.maphuongxa ";
            sql += "inner join " + usr + ".btdquan c on a.maqu=c.maqu ";
            sql += "inner join " + usr + ".btdtt d on a.matt=d.matt ";
            sql += "inner join " + usr + ".btdnn_bv g on a.mann=g.mann ";
            sql += "left join " + usr + ".dienthoai k on a.mabn=k.mabn ";
            sql += " where a.mabn<>''";
            if (dotuoi != "")
            {
                if (dotuoi.IndexOf(">") != -1)
                {
                    m_dotuoi = dotuoi.Substring(1);
                    sql += " and to_number(to_char(now(),'yyyy'))-to_number(a.namsinh)>" + m_dotuoi;
                }
                else
                {
                    int i1 = int.Parse(dotuoi.Substring(0, dotuoi.IndexOf("-")));
                    int i2 = int.Parse(dotuoi.Substring(dotuoi.IndexOf("-") + 1));
                    sql += " and to_number(to_char(now(),'yyyy'),'0000')-to_number(a.namsinh,'0000') between " + i1 + " and " + i2;
                }
            }
            if (mabn != "") sql += " and a.mabn='" + mabn + "'";
            if (hoten != "") sql += " and a.hotenkdau like '%" + hoten + "%'";
            if (ngaysinh.Trim().Length == 10) sql += " and to_char(a.ngaysinh,'dd/mm/yyyy')='" + ngaysinh + "'";
            if (namsinh != "") sql += " and a.namsinh='" + namsinh + "'";
            if (phai != -1) sql += " and a.phai=" + phai;
            if (sonha != "") sql += " and lower(trim(a.sonha))='" + sonha.Trim().ToLower() + "'";
            if (thon != "") sql += " and lower(trim(a.thon))='" + thon.Trim().ToLower() + "'";
            if (mann != "") sql += " and a.mann='" + mann + "'";
            if (madantoc != "") sql += " and a.madantoc='" + madantoc + "'";
            if (matt != "") sql += " and a.matt='" + matt + "'";
            if (maqu != "") sql += " and a.maqu='" + maqu + "'";
            if (maphuongxa != "") sql += " and a.maphuongxa='" + maphuongxa + "'";
            if (dt_nha != "") sql += " and k.nha='" + dt_nha + "'";
            if (dt_coquan != "") sql += " and k.coquan='" + dt_coquan + "'";
            if (dt_didong != "") sql += " and k.didong='" + dt_didong + "'";
            if (email != "") sql += " and k.email='" + email + "'";
            sql += " order by a.mabn";
            return get_data(sql);
        }

        public DataSet get_Timkiem(string mabn, string hoten, string ngaysinh, string namsinh, int phai, string sonha, string thon, string mann, string madantoc, string matt, string maqu,
            string maphuongxa, string dotuoi, string dt_nha, string dt_coquan, string dt_didong, string email, string s_tu, string s_den)
        {
            string m_dotuoi = "", usr = user;
            hoten = Hoten_khongdau(hoten);
            sql = "SELECT distinct a.MABN, a.HOTEN, a.NAMSINH,a.SONHA,";
            sql += "a.THON, b.TENPXA, c.TENQUAN, d.TENTT, g.TENNN,";
            sql += " k.nha,k.coquan,k.didong,k.email,a.nam ";
            sql += "FROM " + usr + ".btdbn a inner join " + usr + ".btdpxa b on a.maphuongxa=b.maphuongxa ";
            sql += "inner join " + usr + ".btdquan c on a.maqu=c.maqu ";
            sql += "inner join " + usr + ".btdtt d on a.matt=d.matt ";
            sql += "inner join " + usr + ".btdnn_bv g on a.mann=g.mann ";
            sql += "left join " + usr + ".dienthoai k on a.mabn=k.mabn ";
            //sql += " left join xxx.tiepdon l on a.mabn=l.mabn ";
            sql += " where a.mabn<>''";
            if (dotuoi != "")
            {
                if (dotuoi.IndexOf(">") != -1)
                {
                    m_dotuoi = dotuoi.Substring(1);
                    sql += " and to_number(to_char(now(),'yyyy'))-to_number(a.namsinh)>" + m_dotuoi;
                }
                else
                {
                    int i1 = int.Parse(dotuoi.Substring(0, dotuoi.IndexOf("-")));
                    int i2 = int.Parse(dotuoi.Substring(dotuoi.IndexOf("-") + 1));
                    sql += " and to_number(to_char(now(),'yyyy'),'0000')-to_number(a.namsinh,'0000') between " + i1 + " and " + i2;
                }
            }
            //if (s_tu.Trim().Length >= 10 && s_den.Trim().Length >= 10)
            //{
            //    sql += " and to_date(to_char(l.ngay,'dd/mm/yyyy'),'dd/mm/yyyy') between to_date('" + s_tu + "','dd/mm/yyyy') and to_date('" + s_den + "','dd/mm/yyyy')";
            //}
            if (mabn != "") sql += " and a.mabn='" + mabn + "'";
            if (hoten != "") sql += " and a.hotenkdau like '%" + hoten + "%'";
            if (ngaysinh.Trim().Length == 10) sql += " and to_char(a.ngaysinh,'dd/mm/yyyy')='" + ngaysinh + "'";
            if (namsinh != "") sql += " and a.namsinh='" + namsinh + "'";
            if (phai != -1) sql += " and a.phai=" + phai;
            if (sonha != "") sql += " and lower(trim(a.sonha))='" + sonha.Trim().ToLower() + "'";
            if (thon != "") sql += " and lower(trim(a.thon))='" + thon.Trim().ToLower() + "'";
            if (mann != "") sql += " and a.mann='" + mann + "'";
            if (madantoc != "") sql += " and a.madantoc='" + madantoc + "'";
            if (matt != "") sql += " and a.matt='" + matt + "'";
            if (maqu != "") sql += " and a.maqu='" + maqu + "'";
            if (maphuongxa != "") sql += " and a.maphuongxa='" + maphuongxa + "'";
            if (dt_nha != "") sql += " and k.nha='" + dt_nha + "'";
            if (dt_coquan != "") sql += " and k.coquan='" + dt_coquan + "'";
            if (dt_didong != "") sql += " and k.didong='" + dt_didong + "'";
            if (email != "") sql += " and k.email='" + email + "'";
            sql += " order by a.mabn";
            DataSet lds = new DataSet();
            return get_data(sql);
            //if (s_tu.Trim().Length >= 10 && s_den.Trim().Length >= 10) lds = get_data_mmyy(sql, s_tu, s_den, true);//return get_data(sql);
            //else lds = get_data_mmyy(sql, ngayhienhanh_server.Substring(0, 10), ngayhienhanh_server.Substring(0, 10), true);
            return lds;
        }
        public DataSet get_chitiet(DataSet ds, string mabn, string nam, string tu, string den)
        {
            ds.Clear();
            DataSet ret = ds.Copy();
            DataRow r1, r2;
            string s_tu = ngayhienhanh_server.Substring(0, 10), s_den = s_tu, usr = user;
            DataTable dt, dttt = get_data("select * from " + usr + ".ttxk").Tables[0];

            string stime = "'" + f_ngay + "'";

            sql = "select to_char(a.ngay,'dd/mm/yyyy hh24:mi') as ngay,b.tenkp,' ' as giuong,' ' as tenbs,to_char(a.ngay,'yyyymmddhh24mi') as yymmdd ";
            sql += " from xxx.tiepdon a," + usr + ".btdkp_bv b where a.makp=b.makp and a.mabn='" + mabn + "'";
            if (tu != "" && den != "") sql += " and " + for_ngay("a.ngay", stime) + " between to_date('" + tu + "'," + stime + ") and to_date('" + den + "'," + stime + ")";
            if (tu != "" && den != "") dt = get_data_mmyy(sql, tu, den, false).Tables[0];
            else dt = get_data_nam_dec(nam, sql).Tables[0];
            foreach (DataRow r in dt.Select("true", "yymmdd"))
            {
                s_tu = r["ngay"].ToString().Substring(0, 10);
                r1 = ds.Tables[0].NewRow();
                r1["ngay"] = r["ngay"].ToString();
                r1["tenkp"] = r["tenkp"].ToString();
                r1["giuong"] = "";
                r1["tenbs"] = "";
                r1["tinhtrang"] = "Đăng ký khám bệnh";
                r1["chandoan"] = "";
                r1["yymmdd"] = r["yymmdd"].ToString();
                ds.Tables[0].Rows.Add(r1);
                break;
            }
            if (tu == "" || den == "")
            {
                tu = s_tu; den = s_den;
            }

            sql = "select to_char(a.ngay,'dd/mm/yyyy hh24:mi') as ngay,b.tenkp,' ' as giuong,c.hoten as tenbs,to_char(a.ngay,'yyyymmddhh24mi') as yymmdd,a.chandoan ";
            sql += " from xxx.benhanpk a inner join " + usr + ".btdkp_bv b on a.makp=b.makp ";
            sql += "left join " + usr + ".dmbs c on a.mabs=c.ma ";
            sql += " where a.mabn='" + mabn + "'";
            if (tu != "" && den != "") sql += " and " + for_ngay("a.ngay", stime) + " between to_date('" + tu + "'," + stime + ") and to_date('" + den + "'," + stime + ")";
            if (tu != "" && den != "") dt = get_data_mmyy(sql, tu, den, false).Tables[0];
            else dt = get_data_nam_dec(nam, sql).Tables[0];
            foreach (DataRow r in dt.Select("true", "yymmdd"))
            {
                r1 = ds.Tables[0].NewRow();
                r1["ngay"] = r["ngay"].ToString();
                r1["tenkp"] = r["tenkp"].ToString();
                r1["giuong"] = "";
                r1["tenbs"] = r["tenbs"].ToString();
                r1["tinhtrang"] = "Khám bệnh";
                r1["chandoan"] = r["chandoan"].ToString();
                r1["yymmdd"] = r["yymmdd"].ToString();
                r1["stt"] = 0;
                ds.Tables[0].Rows.Add(r1);
            }

            sql = "select to_char(a.ngay,'dd/mm/yyyy hh24:mi') as ngay,b.tenkp,a.giuong,c.hoten as tenbs,to_char(a.ngay,'yyyymmddhh24mi') as yymmdd,a.chandoan ";
            sql += " from xxx.benhancc a inner join " + usr + ".btdkp_bv b on a.makp=b.makp ";
            sql += "left join " + usr + ".dmbs c on a.mabs=c.ma ";
            sql += " where a.mabn='" + mabn + "'";
            if (tu != "" && den != "") sql += " and " + for_ngay("a.ngay", stime) + " between to_date('" + tu + "'," + stime + ") and to_date('" + den + "'," + stime + ")";
            if (tu != "" && den != "") dt = get_data_mmyy(sql, tu, den, false).Tables[0];
            else dt = get_data_nam_dec(nam, sql).Tables[0];
            foreach (DataRow r in dt.Select("true", "yymmdd"))
            {
                r1 = ds.Tables[0].NewRow();
                r1["ngay"] = r["ngay"].ToString();
                r1["tenkp"] = r["tenkp"].ToString();
                r1["giuong"] = r["giuong"].ToString();
                r1["tenbs"] = r["tenbs"].ToString();
                r1["tinhtrang"] = "Phòng lưu";
                r1["chandoan"] = r["chandoan"].ToString();
                r1["yymmdd"] = r["yymmdd"].ToString();
                r1["stt"] = 0;
                ds.Tables[0].Rows.Add(r1);
            }

            sql = "select to_char(a.ngay,'dd/mm/yyyy hh24:mi') as ngay,b.tenkp,'' as giuong,c.hoten as tenbs,to_char(a.ngay,'yyyymmddhh24mi') as yymmdd,a.chandoan ";
            sql += " from " + usr + ".benhanngtr a inner join " + usr + ".btdkp_bv b on a.makp=b.makp ";
            sql += "left join " + usr + ".dmbs c on a.mabs=c.ma ";
            sql += " where a.mabn='" + mabn + "'";
            if (tu != "" && den != "") sql += " and " + for_ngay("a.ngay", stime) + " between to_date('" + tu + "'," + stime + ") and to_date('" + den + "'," + stime + ")";
            dt = get_data(sql).Tables[0];
            foreach (DataRow r in dt.Select("true", "yymmdd"))
            {
                r1 = ds.Tables[0].NewRow();
                r1["ngay"] = r["ngay"].ToString();
                r1["tenkp"] = r["tenkp"].ToString();
                r1["giuong"] = r["giuong"].ToString();
                r1["tenbs"] = r["tenbs"].ToString();
                r1["tinhtrang"] = "Điều trị ngoại trú";
                r1["chandoan"] = r["chandoan"].ToString();
                r1["yymmdd"] = r["yymmdd"].ToString();
                r1["stt"] = 0;
                ds.Tables[0].Rows.Add(r1);
            }

            sql = "select to_char(a.ngay,'dd/mm/yyyy hh24:mi') as ngay,d.tenkp,a.giuong,e.hoten as tenbs,to_char(a.ngay,'yyyymmddhh24mi') as yymmdd,a.chandoan,";
            sql += "to_char(b.ngay,'dd/mm/yyyy hh24:mi') as ngayrk,case when b.ttlucrk is null then 0 else b.ttlucrk end as ttlucrk,f.hoten as tenbsrk,to_char(b.ngay,'yyyymmddhh24mi') as yymmddrk,b.chandoan as chandoanrk";
            sql += " from " + usr + ".nhapkhoa a left join " + usr + ".xuatkhoa b on a.id=b.id ";
            sql += " inner join " + usr + ".benhandt c  on a.maql=c.maql ";
            sql += " inner join " + usr + ".btdkp_bv d  on a.makp=d.makp ";
            sql += " inner join " + usr + ".dmbs e  on a.mabs=e.ma ";
            sql += " left join " + usr + ".dmbs f  on b.mabs=f.ma ";
            sql += " where a.mabn='" + mabn + "'";
            if (tu != "" && den != "") sql += " and " + for_ngay("a.ngay", stime) + " between to_date('" + tu + "'," + stime + ") and to_date('" + den + "'," + stime + ")";
            dt = get_data(sql).Tables[0];
            foreach (DataRow r in dt.Select("true", "yymmdd"))
            {
                r1 = ds.Tables[0].NewRow();
                r1["ngay"] = r["ngay"].ToString();
                r1["tenkp"] = r["tenkp"].ToString();
                r1["giuong"] = r["giuong"].ToString();
                r1["tenbs"] = r["tenbs"].ToString();
                r1["tinhtrang"] = "Điều trị tại khoa";
                r1["chandoan"] = r["chandoan"].ToString();
                r1["yymmdd"] = r["yymmdd"].ToString();
                r1["stt"] = 2;
                ds.Tables[0].Rows.Add(r1);
                if (r["ttlucrk"].ToString() != "0")
                {
                    r2 = getrowbyid(dttt, "ma=" + int.Parse(r["ttlucrk"].ToString()));
                    if (r2 != null)
                    {
                        r1 = ds.Tables[0].NewRow();
                        r1["ngay"] = r["ngayrk"].ToString();
                        r1["tenkp"] = r["tenkp"].ToString();
                        r1["giuong"] = r["giuong"].ToString();
                        r1["tenbs"] = r["tenbsrk"].ToString();
                        r1["tinhtrang"] = r2["ten"].ToString();
                        r1["chandoan"] = r["chandoanrk"].ToString();
                        r1["yymmdd"] = r["yymmddrk"].ToString();
                        r1["stt"] = 1;
                        ds.Tables[0].Rows.Add(r1);
                    }
                }
            }
            ret.Merge(ds.Tables[0].Select("true", "yymmdd desc,stt desc"));
            return ret;
        }

         public DataSet get_Tiepdon(string tu, string den, string mabn, string hoten, string namsinh,
            int phai, string sonha, string thon, string mann, string madantoc, string matt, string maqu,
            string maphuongxa, string makp, string madoituong, string dotuoi, string sothe, int userid,
            bool time, string dt_nha, string dt_coquan, string dt_didong, string email, string mabs, int loai, 
            int bnmoi, int traituyen, int m_chinhanh,bool ktratrungthe,int sort)
        {
            string stime = (time) ? "'" + f_ngaygio + "'" : "'" + f_ngay + "'";
            if (time)
            {
                tu = tu + " " + sGiobaocao;
                den = den + " " + sGiobaocao;
            }
            hoten = Hoten_khongdau(hoten);
            if (sort == 1)
            {
                sql = "SELECT a.MABN, a.HOTEN,substr(f.tuoivao,1,3)||case when substr(f.tuoivao,4,1)=0 then 'TU' else case when substr(f.tuoivao,4,1)=1 then 'TH' else case when substr(f.tuoivao,4,1)=2 then 'NG' else 'GI' end end end as tuoi, a.NAMSINH,a.SONHA,";
                sql += " a.THON, b.TENPXA, c.TENQUAN, d.TENTT, g.TENNN, to_char(f.ngay,'dd/mm/yyyy hh24:mi') AS ngay,e.TENKP,h.DOITUONG,f.SOVAOVIEN,i.sothe,coalesce(to_char(j.ngaysanh,'dd/mm/yyyy'),'') as ngaysanh,";
                sql += " coalesce(k.nha,'') as nha,coalesce(k.coquan,'') as coquan,coalesce(k.didong,'') as didong,coalesce(k.email,'') as email,coalesce(y.hoten,' ') as tenbs,coalesce(u.hoten,'') as tenuser, case when i.traituyen is null then 0 else i.traituyen end traituyen, f.done, f.maql ";
            }
            else
            {
                sql = "SELECT distinct a.MABN, a.HOTEN,substr(f.tuoivao,1,3)||case when substr(f.tuoivao,4,1)=0 then 'TU' else case when substr(f.tuoivao,4,1)=1 then 'TH' else case when substr(f.tuoivao,4,1)=2 then 'NG' else 'GI' end end end as tuoi, a.NAMSINH,a.SONHA,";
                sql += " a.THON, b.TENPXA, c.TENQUAN, d.TENTT, g.TENNN, '' AS ngay,'' as TENKP,'' as DOITUONG,'' as SOVAOVIEN,'' as sothe,coalesce(to_char(j.ngaysanh,'dd/mm/yyyy'),'') as ngaysanh,";
                sql += " coalesce(k.nha,'') as nha,coalesce(k.coquan,'') as coquan,coalesce(k.didong,'') as didong,coalesce(k.email,'') as email,coalesce(y.hoten,' ') as tenbs,coalesce(u.hoten,'') as tenuser, '' as traituyen,'' as done, '' as maql ";
            }
            sql += " FROM " + user + ".btdbn a inner join xxx.tiepdon f on a.mabn=f.mabn inner join " + user + ".btdpxa b on a.maphuongxa=b.maphuongxa";
            sql += " inner join " + user + ".btdquan c on a.maqu=c.maqu inner join " + user + ".btdtt d on a.matt=d.matt inner join " + user + ".btdnn_bv g on a.mann=g.mann";
            sql += " inner join " + user + ".doituong h on f.madoituong=h.madoituong inner join " + user + ".btdkp_bv e on f.makp=e.makp";
            sql += " left join xxx.bhyt i on f.maql=i.maql left join xxx.ttkhamthai j on f.maql=j.maql";
            sql += " left join " + user + ".dienthoai k on f.mabn=k.mabn left join xxx.lienhe x on f.maql=x.maql";
            sql += " left join " + user + ".dmbs y on x.mabs=y.ma left join " + user + ".dlogin u on f.userid=u.id";
            //sql += " left join xxx.tttiepdon tttd on f.maql=tttd.maql ";
            sql += " where f.noitiepdon=0";
            if (makp != "") sql += " and f.makp in " + makp;
            if (tu != "")
                sql += " and " + for_ngay("f.ngay", stime) + " between to_date('" + tu + "'," + stime + ") and to_date('" + den + "'," + stime + ")";
            if (mabn != "") sql += " and a.mabn='" + mabn + "'";
            if (hoten != "") sql += " and a.hotenkdau like '%" + hoten + "%'";
            if (namsinh != "") sql += " and a.namsinh='" + namsinh + "'";
            if (phai != -1) sql += " and a.phai=" + phai;
            if (sonha != "") sql += " and lower(trim(a.sonha))='" + sonha.Trim().ToLower() + "'";
            if (thon != "") sql += " and lower(trim(a.thon))='" + thon.Trim().ToLower() + "'";
            if (mann != "") sql += " and a.mann='" + mann + "'";
            if (madantoc != "") sql += " and a.madantoc='" + madantoc + "'";
            if (matt != "") sql += " and a.matt='" + matt + "'";
            if (maqu != "") sql += " and a.maqu='" + maqu + "'";
            if (maphuongxa != "") sql += " and a.maphuongxa='" + maphuongxa + "'";
            if (madoituong != "") sql += " and f.madoituong=" + madoituong;
            if (sothe != "") sql += " and i.sothe like '%" + sothe + "%'";
            if (dt_nha != "") sql += " and k.nha='" + dt_nha + "'";
            if (dt_coquan != "") sql += " and k.coquan='" + dt_coquan + "'";
            if (dt_didong != "") sql += " and k.didong='" + dt_didong + "'";
            if (email != "") sql += " and k.email='" + email + "'";
            if (mabs != "") sql += " and x.mabs='" + mabs + "'";
            if (userid != -1) sql += " and f.userid=" + userid;
            if (loai != -1) sql += " and x.loai=" + loai;
            if (bnmoi != -1) sql += " and x.bnmoi=" + bnmoi;
            if (traituyen > -1) sql += " and i.traituyen" + ((traituyen == 0) ? "=0" : "<>0");
            if (m_chinhanh > 0) sql += " and e.chinhanh in(" + m_chinhanh + ")";
            if (dotuoi != "")
            {
                if (dotuoi.IndexOf(">") != -1)//binh
                {
                    //sql += " and to_number(to_char(now(),'yyyy'),'0000')-to_number(a.namsinh,'0000')>" + int.Parse(dotuoi.Substring(1));
                    sql += " and to_number(to_char(f.ngay,'yyyy'),'0000')-to_number(a.namsinh,'0000')>" + int.Parse(dotuoi.Substring(1));
                }
                else
                {
                    int i1 = int.Parse(dotuoi.Substring(0, dotuoi.IndexOf("-")));
                    int i2 = int.Parse(dotuoi.Substring(dotuoi.IndexOf("-") + 1));
                    sql += " and to_number(to_char(f.ngay,'yyyy'),'0000')-to_number(a.namsinh,'0000') between " + i1 + " and " + i2; //sql += " and to_number(to_char(now(),'yyyy'),'0000')-to_number(a.namsinh,'0000') between " + i1 + " and " + i2;
                }
            }
            if (ktratrungthe)
            {
                sql += " and i.sothe in (select sothe from (select distinct mabn,sothe from xxx.bhyt) group by sothe having count(mabn)>1)";
            }
            if (sort == 2)
            {
                sql += " group by a.mabn,a.hoten,f.tuoivao,a.namsinh,a.SONHA, a.THON, b.TENPXA, c.TENQUAN, d.TENTT, g.TENNN,j.ngaysanh,k.nha,k.coquan" +
                           " ,k.didong,k.email,y.hoten,u.hoten order by a.mabn";
            }
            else
            {
                sql += " order by f.ngay";
            }
            return get_data_mmyy(sql, tu.Substring(0, 10), den.Substring(0, 10), false);
        }


        public DataSet get_Tiepdon(string tu, string den, string mabn, string hoten, string namsinh,
            int phai, string sonha, string thon, string mann, string madantoc, string matt, string maqu,
            string maphuongxa, string makp, string madoituong, string dotuoi, string sothe, int userid,
            bool time, string dt_nha, string dt_coquan, string dt_didong, string email, string mabs, int loai, int bnmoi, int traituyen, int m_chinhanh)
        {
            string stime = (time) ? "'" + f_ngaygio + "'" : "'" + f_ngay + "'";
            if (time)
            {
                tu = tu + " " + sGiobaocao;
                den = den + " " + sGiobaocao;
            }
            hoten = Hoten_khongdau(hoten);
            sql = "SELECT a.MABN, a.HOTEN,substr(f.tuoivao,1,3)||case when substr(f.tuoivao,4,1)=0 then 'TU' else case when substr(f.tuoivao,4,1)=1 then 'TH' else case when substr(f.tuoivao,4,1)=2 then 'NG' else 'GI' end end end as tuoi, a.NAMSINH,a.SONHA,";
            sql += " a.THON, b.TENPXA, c.TENQUAN, d.TENTT, g.TENNN, to_char(f.ngay,'dd/mm/yyyy hh24:mi') AS ngay,e.TENKP,h.DOITUONG,f.SOVAOVIEN,i.sothe,coalesce(to_char(j.ngaysanh,'dd/mm/yyyy'),'') as ngaysanh,";
            sql += " coalesce(k.nha,'') as nha,coalesce(k.coquan,'') as coquan,coalesce(k.didong,'') as didong,coalesce(k.email,'') as email,coalesce(y.hoten,' ') as tenbs,coalesce(u.hoten,'') as tenuser, case when i.traituyen is null then 0 else i.traituyen end traituyen, f.done, f.maql ";
            sql += " FROM " + user + ".btdbn a inner join xxx.tiepdon f on a.mabn=f.mabn inner join " + user + ".btdpxa b on a.maphuongxa=b.maphuongxa";
            sql += " inner join " + user + ".btdquan c on a.maqu=c.maqu inner join " + user + ".btdtt d on a.matt=d.matt inner join " + user + ".btdnn_bv g on a.mann=g.mann";
            sql += " inner join " + user + ".doituong h on f.madoituong=h.madoituong inner join " + user + ".btdkp_bv e on f.makp=e.makp";
            sql += " left join xxx.bhyt i on f.maql=i.maql left join xxx.ttkhamthai j on f.maql=j.maql";
            sql += " left join " + user + ".dienthoai k on f.mabn=k.mabn left join xxx.lienhe x on f.maql=x.maql";
            sql += " left join " + user + ".dmbs y on x.mabs=y.ma left join " + user + ".dlogin u on f.userid=u.id";
            sql += " where f.noitiepdon=0";
            if (makp != "") sql += " and f.makp in " + makp;
            if (tu != "")
                sql += " and " + for_ngay("f.ngay", stime) + " between to_date('" + tu + "'," + stime + ") and to_date('" + den + "'," + stime + ")";
            if (mabn != "") sql += " and a.mabn='" + mabn + "'";
            if (hoten != "") sql += " and a.hotenkdau like '%" + hoten + "%'";
            if (namsinh != "") sql += " and a.namsinh='" + namsinh + "'";
            if (phai != -1) sql += " and a.phai=" + phai;
            if (sonha != "") sql += " and lower(trim(a.sonha))='" + sonha.Trim().ToLower() + "'";
            if (thon != "") sql += " and lower(trim(a.thon))='" + thon.Trim().ToLower() + "'";
            if (mann != "") sql += " and a.mann='" + mann + "'";
            if (madantoc != "") sql += " and a.madantoc='" + madantoc + "'";
            if (matt != "") sql += " and a.matt='" + matt + "'";
            if (maqu != "") sql += " and a.maqu='" + maqu + "'";
            if (maphuongxa != "") sql += " and a.maphuongxa='" + maphuongxa + "'";
            if (madoituong != "") sql += " and f.madoituong=" + madoituong;
            if (sothe != "") sql += " and i.sothe like '%" + sothe + "%'";
            if (dt_nha != "") sql += " and k.nha='" + dt_nha + "'";
            if (dt_coquan != "") sql += " and k.coquan='" + dt_coquan + "'";
            if (dt_didong != "") sql += " and k.didong='" + dt_didong + "'";
            if (email != "") sql += " and k.email='" + email + "'";
            if (mabs != "") sql += " and x.mabs='" + mabs + "'";
            if (userid != -1) sql += " and f.userid=" + userid;
            if (loai != -1) sql += " and x.loai=" + loai;
            if (bnmoi != -1) sql += " and x.bnmoi=" + bnmoi;
            if (traituyen > -1) sql += " and i.traituyen" + ((traituyen == 0) ? "=0" : "<>0");
            if (m_chinhanh > 0) sql += " and e.chinhanh in(" + m_chinhanh + ")";
            if (dotuoi != "")
            {
                if (dotuoi.IndexOf(">") != -1)//binh
                {
                    //sql += " and to_number(to_char(now(),'yyyy'),'0000')-to_number(a.namsinh,'0000')>" + int.Parse(dotuoi.Substring(1));
                    sql += " and to_number(to_char(f.ngay,'yyyy'),'0000')-to_number(a.namsinh,'0000')>" + int.Parse(dotuoi.Substring(1));
                }
                else
                {
                    int i1 = int.Parse(dotuoi.Substring(0, dotuoi.IndexOf("-")));
                    int i2 = int.Parse(dotuoi.Substring(dotuoi.IndexOf("-") + 1));
                    sql += " and to_number(to_char(f.ngay,'yyyy'),'0000')-to_number(a.namsinh,'0000') between " + i1 + " and " + i2; //sql += " and to_number(to_char(now(),'yyyy'),'0000')-to_number(a.namsinh,'0000') between " + i1 + " and " + i2;
                }
            }
            sql += " order by f.ngay";
            return get_data_mmyy(sql, tu.Substring(0, 10), den.Substring(0, 10), false);
        }

        public DataSet get_Khambenh(string tu, string den, string mabn, string hoten, string ngaysinh,
            int phai, string sonha, string thon, string mann, string madantoc, string matt, string maqu,
            string maphuongxa, string makp, string sovaovien, string maicd, string madoituong, string dentu,
            string nhantu, string xutri, string dotuoi, bool icd, string soluutru, int userid, bool time,
            string mabs, int loai, int bnmoi, string loaidt, string sothe, bool bngoaitru, int traituyen, bool nvienbv, int m_chinhanh)
        {
            d = new LibDuoc.AccessData();
            int v1 = 5, v2 = 2, i_nhom = nhom_duoc;
            string s_tunguyen = "", s_thetunguyen = d.thetunguyen(i_nhom);
            if (s_thetunguyen != "") s_tunguyen = s_thetunguyen.Replace(",", "','");
            string vitri = d.thetunguyen_vitri_ora(i_nhom);
            if (vitri.Length == 3)
            {
                v1 = int.Parse(vitri.Substring(0, 1)); v2 = int.Parse(vitri.Substring(2, 1));
            }
            string stime = (time) ? "'" + f_ngaygio + "'" : "'" + f_ngay + "'";
            if (time)
            {
                tu = tu + " " + sGiobaocao;
                den = den + " " + sGiobaocao;
            }
            hoten = Hoten_khongdau(hoten);
            sql = "SELECT a.MABN,f.maql,a.HOTEN,to_char(a.ngaysinh,'dd/mm/yyyy') ngaysinh, substr(k.tuoivao,1,3)||case when substr(k.tuoivao,4,1)=0 then 'TU' else case when substr(k.tuoivao,4,1)=1 then 'TH' else case when substr(k.tuoivao,4,1)=2 then 'NG' else 'GI' end end end as tuoi, a.NAMSINH, coalesce(a.SONHA,'') as sonha,";
            sql += "coalesce(a.THON,' ') as thon, b.TENPXA, c.TENQUAN, d.TENTT, g.TENNN, to_char(f.ngay,'dd/mm/yyyy hh24:mi') AS ngay,";
            sql += "e.TENKP, h.DOITUONG, f.CHANDOAN, f.MAICD, f.SOVAOVIEN, i.TEN AS nhantu,j.TEN AS dentu, n.TEN AS xutri,k.soluutru,coalesce(y.tenkp,' ') as khoanhap,coalesce(to_char(z.ngaysanh,'dd/mm/yyyy'),' ') as ngaysanh,coalesce(p.hoten,' ') as tenbs,coalesce(u.hoten,' ') as tenuser,coalesce(l.sothe,' ') as sothe,v.tenbv ";
            sql += ", l.traituyen ";
            sql += " FROM " + user + ".btdbn a inner join xxx.benhanpk f on a.mabn=f.mabn";
            sql += " inner join " + user + ".btdpxa b on a.maphuongxa=b.maphuongxa ";
            sql += " inner join " + user + ".btdquan c on a.maqu=c.maqu ";
            sql += " inner join " + user + ".btdtt d on a.matt=d.matt ";
            sql += " inner join " + user + ".btdnn_bv g on a.mann=g.mann ";
            sql += " inner join " + user + ".doituong h on f.madoituong=h.madoituong ";
            sql += " inner join " + user + ".nhantu i on f.nhantu=i.ma ";
            sql += " inner join " + user + ".dentu j on f.dentu=j.ma ";
            sql += " left join " + user + ".xutrikb n on f.ttlucrv=n.ma ";
            sql += " inner join " + user + ".btdkp_bv e on f.makp=e.makp ";
            sql += " inner join xxx.lienhe k on f.maql=k.maql ";
            sql += " left join xxx.xutrikbct x on f.maql=x.maql ";
            sql += " left join " + user + ".btdkp_bv y on x.makp=y.makp ";
            sql += " left join xxx.ttkhamthai z on f.maql=z.maql ";
            sql += " left join " + user + ".dmbs p on f.mabs=p.ma ";
            sql += " left join " + user + ".dlogin u on f.userid=u.id ";
            sql += " left join xxx.bhyt l on f.maql=l.maql ";
            sql += " left join " + user + ".chuyenvien t on f.maql=t.maql ";
            sql += " left join " + user + ".tenvien v on t.mabv=v.mabv ";
            sql += " where f.maql>0";
            if (makp != "") sql += " and f.makp in " + makp;
            if (m_chinhanh > 0) sql += " and e.chinhanh in(" + m_chinhanh + ")";
            if (!bngoaitru) sql += " and f.mangtr<=0";
            if (loaidt != "")
            {
                if (loaidt == "B") sql += " and substr(l.sothe," + v1 + "," + v2 + ") not in ('" + s_tunguyen.Substring(0, s_tunguyen.Length) + "')";
                else sql += " and substr(l.sothe," + v1 + "," + v2 + ") in ('" + s_tunguyen.Substring(0, s_tunguyen.Length) + "')";
            }
            if (icd) sql += " and f.maicd in (select ma from " + user + ".bctheoicd)";
            if (tu != "")
                sql += " and " + for_ngay("f.ngay", stime) + " between to_date('" + tu + "'," + stime + ") and to_date('" + den + "'," + stime + ")";
            //{
            //    if (time) sql += " and f.ngay between to_timestamp('" + tu + "'," + stime + ") and to_timestamp('" + den + "'," + stime + ")";
            //    else sql += " and substr(f.ngay,1,10) between to_date('" + tu + "'," + stime + ") and to_date('" + den + "'," + stime + ")";
            //} 
            if (mabn != "") sql += " and a.mabn='" + mabn + "'";
            if (hoten != "") sql += " and a.hotenkdau like '%" + hoten + "%'";
            if (ngaysinh.Trim().Length == 10) sql += " and to_char(a.ngaysinh,'dd/mm/yyyy')='" + ngaysinh + "'";
            if (phai != -1) sql += " and a.phai=" + phai;
            if (sonha != "") sql += " and lower(trim(a.sonha))='" + sonha + "'";
            if (thon != "") sql += " and lower(trim(a.thon))='" + thon + "'";
            if (mann != "") sql += " and a.mann='" + mann + "'";
            if (madantoc != "") sql += " and a.madantoc='" + madantoc + "'";
            if (matt != "") sql += " and a.matt='" + matt + "'";
            if (maqu != "") sql += " and a.maqu='" + maqu + "'";
            if (maphuongxa != "") sql += " and a.maphuongxa='" + maphuongxa + "'";
            if (userid != -1) sql += " and f.userid=" + userid;
            if (sovaovien != "") sql += " and f.sovaovien='" + sovaovien + "'";
            if (maicd != "") sql += " and f.maicd='" + maicd + "'";
            if (madoituong != "") sql += " and f.madoituong=" + madoituong;
            if (dentu != "") sql += " and f.dentu=" + dentu;
            if (sothe != "") sql += " and l.sothe like '%" + sothe + "%'";
            if (nhantu != "") sql += " and f.nhantu=" + nhantu;
            if (xutri != "") sql += " and x.xutri like '%" + xutri + ",%'";
            if (soluutru == "*") sql += " and m.soluutru is not null";
            else if (soluutru != "") sql += " and m.soluutru='" + soluutru + "'";
            if (userid != -1) sql += " and f.userid=" + userid;
            if (mabs != "") sql += " and f.mabs='" + mabs + "'";
            if (loai != -1) sql += " and k.loai=" + loai;
            if (nvienbv) sql += " and f.mavaovien in (select a.mavaovien from xxx.tiepdon a,xxx.lienhe b where a.maql=b.maql and b.nvienbv=1)";
            if (bnmoi != -1) sql += " and k.bnmoi=" + bnmoi;
            if (traituyen >= 0) sql += " and l.traituyen=" + (traituyen > 1 ? 1 : traituyen);
            if (dotuoi != "")
            {
                if (dotuoi.Trim() == "<1TH")
                {
                    sql += " and a.ngaysinh is not null and extract(day from(to_date(to_char(f.ngay,'dd/mm/yyyy'),'dd/mm/yyyy')-to_date(to_char(a.ngaysinh,'dd/mm/yyyy'),'dd/mm/yyyy'))) < 31 ";//DUOI 1 THANG
                }
                else if (dotuoi.Trim() == "<1T")
                {
                    sql += " and a.ngaysinh is not null and extract(day from(to_date(to_char(f.ngay,'dd/mm/yyyy'),'dd/mm/yyyy')-to_date(to_char(a.ngaysinh,'dd/mm/yyyy'),'dd/mm/yyyy'))) between 31 and 365 ";//DUOI 1 TUOI
                }
                else if (dotuoi.IndexOf(">") != -1)
                {
                    sql += " and to_number(to_char(f.ngay,'yyyy'),'0000')-to_number(a.namsinh,'0000')>" + int.Parse(dotuoi.Substring(1));
                    //sql += " and to_number(to_char(now(),'yyyy'),'0000')-to_number(a.namsinh,'0000')>" + int.Parse(dotuoi.Substring(1));
                }
                else
                {
                    int i1 = int.Parse(dotuoi.Substring(0, dotuoi.IndexOf("-")));
                    int i2 = int.Parse(dotuoi.Substring(dotuoi.IndexOf("-") + 1));
                    sql += " and to_number(to_char(f.ngay,'yyyy'),'0000')-to_number(a.namsinh,'0000') between " + i1 + " and " + i2; //sql += " and to_number(to_char(now(),'yyyy'),'0000')-to_number(a.namsinh,'0000') between " + i1 + " and " + i2;
                }
            }
            sql += " order by f.ngay";
            return get_data_mmyy(sql, tu.Substring(0, 10), den.Substring(0, 10), false);
        }

        public DataSet get_Vaongoaitru(string tu, string den, string mabn, string hoten, string ngaysinh,
            int phai, string sonha, string thon, string mann, string madantoc, string matt, string maqu,
            string maphuongxa, string makp, string sovaovien, string maicd, string madoituong, string dentu,
            string nhantu, string dotuoi, bool icd, int userid, bool time)
        {
            try
            {
                string stime = (time) ? "'" + f_ngaygio + "'" : "'" + f_ngay + "'";
                if (time)
                {
                    tu = tu + " " + sGiobaocao;
                    den = den + " " + sGiobaocao;
                }
                hoten = Hoten_khongdau(hoten);
                sql = "select a.mabn,a.hoten,substr(k.tuoivao,1,3)||case when substr(k.tuoivao,4,1)=0 then 'TU' else case when substr(k.tuoivao,4,1)=1 then 'TH' else case when substr(k.tuoivao,4,1)=2 then 'NG' else 'GI' end end end as tuoi,";
                sql += "a.namsinh,coalesce(a.sonha,' ') as sonha,coalesce(a.thon,' ') as thon,b.tenpxa,c.tenquan,d.tentt,";
                sql += "g.tennn,to_char(f.ngay,'dd/mm/yyyy hh24:mi') as ngay,e.tenkp,h.doituong,";
                sql += "f.chandoan,f.maicd,f.sovaovien,i.ten as nhantu,j.ten as dentu,coalesce(u.hoten,' ') as tenuser, bh.sothe, case when bh.traituyen is null then 0 else bh.traituyen end as traituyen ";
                sql += " from " + user + ".btdbn a inner join " + user + ".btdpxa b on a.maphuongxa=b.maphuongxa";
                sql += " inner join " + user + ".btdquan c on a.maqu=c.maqu";
                sql += " inner join " + user + ".btdtt d on a.matt=d.matt";
                sql += " inner join " + user + ".benhanngtr f on a.mabn=f.mabn";
                sql += " inner join " + user + ".btdkp_bv e on f.makp=e.makp";
                sql += " inner join " + user + ".btdnn_bv g on a.mann=g.mann";
                sql += " inner join " + user + ".doituong h on f.madoituong=h.madoituong";
                sql += " inner join " + user + ".nhantu i on f.nhantu=i.ma";
                sql += " inner join " + user + ".dentu j on f.dentu=j.ma";
                sql += " inner join " + user + ".lienhe k on f.maql=k.maql";
                sql += " left join " + user + ".dlogin u on f.userid=u.id";
                sql += " left join " + user + ".bhyt bh on f.maql=bh.maql and (bh.sudung=1 or bh.sudung is null)";
                sql += " where f.makp<>'01' and f.maql>0";
                if (tu != "")
                    sql += " and " + for_ngay("f.ngay", stime) + " between to_date('" + tu + "'," + stime + ") and to_date('" + den + "'," + stime + ")";
                if (makp != "") sql += " and f.makp='" + makp + "'";
                if (icd) sql += " and f.maicd in (select ma from " + user + ".dmicd10)";
                if (mabn != "") sql += " and a.mabn='" + mabn + "'";
                if (hoten != "") sql += " and a.hotenkdau='" + hoten + "'";
                if (ngaysinh.Trim().Length == 10) sql += " and to_char(a.ngaysinh,'dd/MM/yyyy')='" + ngaysinh + "'";
                if (phai != -1) sql += " and a.phai=" + phai;
                if (sonha != "") sql += " and lower(trim(a.sonha))='" + sonha.Trim().ToLower() + "'";
                if (thon != "") sql += " and lower(trim(a.thon))='" + thon.Trim().ToLower() + "'";
                if (mann != "") sql += " and a.mann='" + mann + "'";
                if (madantoc != "") sql += " and a.madantoc='" + madantoc + "'";
                if (matt != "") sql += " and a.matt='" + matt + "'";
                if (maqu != "") sql += " and a.maqu='" + maqu + "'";
                if (maphuongxa != "") sql += " and a.maphuongxa='" + maphuongxa + "'";
                if (madoituong != "") sql += " and f.madoituong=" + madoituong;
                if (sovaovien != "") sql += " and f.sovaovien='" + sovaovien + "'";
                if (maicd != "") sql += " and f.maicd='" + maicd + "'";
                if (madoituong != "") sql += " and f.madoituong=" + madoituong;
                if (dentu != "") sql += " and f.dentu=" + dentu;
                if (nhantu != "") sql += " and f.nhantu=" + nhantu;
                if (userid != -1) sql += " and f.userid=" + userid;
                if (dotuoi != "")
                {
                    if (dotuoi.IndexOf(">") != -1)
                    {
                        sql += " and to_number(to_char(f,ngay,'yyyy'),'0000')-to_number(a.namsinh,'0000')>" + int.Parse(dotuoi.Substring(1)); //sql += " and to_number(to_char(now(),'yyyy'),'0000')-to_number(a.namsinh,'0000')>" + int.Parse(dotuoi.Substring(1));
                    }
                    else
                    {
                        int i1 = int.Parse(dotuoi.Substring(0, dotuoi.IndexOf("-")));
                        int i2 = int.Parse(dotuoi.Substring(dotuoi.IndexOf("-") + 1));
                        sql += " and to_number(to_char(f.ngay,'yyyy'),'0000')-to_number(a.namsinh,'0000') between " + i1 + " and " + i2; //sql += " and to_number(to_char(now(),'yyyy'),'0000')-to_number(a.namsinh,'0000') between " + i1 + " and " + i2;
                    }
                }
                sql += " order by f.ngay";
                ds = get_data(sql);
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message.ToString().Trim(), sComputer, "Vaongtru");
            }
            return ds;
        }

        public DataSet get_Rangoaitru(string tu, string den, string mabn, string hoten, string ngaysinh,
            int phai, string sonha, string thon, string mann, string madantoc, string matt, string maqu,
            string maphuongxa, string makp, string soluutru, string maicd, string madoituong, string ketqua,
            string ttlucrk, string dotuoi, bool icd, int userid, bool time)
        {
            try
            {
                string stime = (time) ? "'" + f_ngaygio + "'" : "'" + f_ngay + "'";
                if (time)
                {
                    tu = tu + " " + sGiobaocao;
                    den = den + " " + sGiobaocao;
                }
                hoten = Hoten_khongdau(hoten);
                sql = "select a.mabn,a.hoten,substr(m.tuoivao,1,3)||case when substr(m.tuoivao,4,1)=0 then 'TU' else case when substr(m.tuoivao,4,1)=1 then 'TH' else case when substr(m.tuoivao,4,1)=2 then 'NG' else 'GI' end end end as tuoi,";
                sql += "a.namsinh,coalesce(a.sonha,' ') as sonha,coalesce(a.thon,' ') as thon,b.tenpxa,c.tenquan,d.tentt,";
                sql += "g.tennn,to_char(k.ngay,'dd/mm/yyyy hh24:mi') as ngayvk,e.tenkp,h.doituong,";
                sql += "k.chandoanrv as chandoan,k.maicdrv as maicd,k.sovaovien,i.ten as ketqua,coalesce(j.ten,'Nhap vien') as ttlucrk,";
                sql += "to_char(k.ngayrv,'dd/mm/yyyy hh24:mi') as ngayrk,k.soluutru,";
                //sql += "date_part('day',age(k.ngayrv,k.ngay)) as ngaydt,";
                sql += "date(to_char(k.ngayrv,'yyyymmdd'))-date(to_char(k.ngay,'yyyymmdd'))+1 as ngaydt, ";
                sql += " coalesce(u.hoten,' ') as tenuser, bh.sothe, case when bh.traituyen is null then 0 else bh.traituyen end as traituyen ";
                sql += " from " + user + ".btdbn a inner join " + user + ".btdpxa b on a.maphuongxa=b.maphuongxa";
                sql += " inner join " + user + ".btdquan c on a.maqu=c.maqu";
                sql += " inner join " + user + ".btdtt d on a.matt=d.matt";
                sql += " inner join " + user + ".btdnn_bv g on a.mann=g.mann";
                sql += " inner join " + user + ".benhanngtr k on a.mabn=k.mabn";
                sql += " inner join " + user + ".btdkp_bv e on k.makp=e.makp";
                sql += " inner join " + user + ".doituong h on k.madoituong=h.madoituong";
                sql += " inner join " + user + ".ketqua i on k.ketqua=i.ma";
                sql += " left join " + user + ".ttxk j on k.ttlucrv=j.ma";
                sql += " inner join " + user + ".lienhe m on k.maql=m.maql";
                sql += " left join " + user + ".dlogin u on k.userid=u.id";
                sql += " left join " + user + ".bhyt bh on k.maql=bh.maql and (bh.sudung=1 or bh.sudung is null)";
                sql += " where k.ngayrv is not null";
                if (icd) sql += " and k.maicdrv in (select ma from " + user + ".dmicd10)";
                if (tu != "")
                    sql += " and " + for_ngay("k.ngayrv", stime) + " between to_date('" + tu + "'," + stime + ") and to_date('" + den + "'," + stime + ")";
                if (mabn != "") sql += " and a.mabn='" + mabn + "'";
                if (hoten != "") sql += " and a.hotenkdau='" + hoten + "'";
                if (ngaysinh.Trim().Length == 10) sql += " and to_char(a.ngaysinh,'dd/mm/yyyy')='" + ngaysinh + "'";
                if (phai != -1) sql += " and a.phai=" + phai;
                if (sonha != "") sql += " and lower(trim(a.sonha))='" + sonha + "'";
                if (thon != "") sql += " and lower(trim(a.thon))='" + thon + "'";
                if (mann != "") sql += " and a.mann='" + mann + "'";
                if (madantoc != "") sql += " and a.madantoc='" + madantoc + "'";
                if (matt != "") sql += " and a.matt='" + matt + "'";
                if (maqu != "") sql += " and a.maqu='" + maqu + "'";
                if (maphuongxa != "") sql += " and a.maphuongxa='" + maphuongxa + "'";
                if (makp != "") sql += " and k.makp='" + makp + "'";
                if (soluutru != "") sql += " and trim(k.soluutru)='" + soluutru + "'";
                if (maicd != "") sql += " and k.maicdrv='" + maicd + "'";
                if (madoituong != "") sql += " and k.madoituong=" + madoituong;
                if (ketqua != "") sql += " and k.ketqua=" + ketqua;
                if (ttlucrk != "") sql += " and k.ttlucrv=" + ttlucrk;
                if (userid != -1) sql += " and k.userid=" + userid;
                if (dotuoi != "")
                {
                    if (dotuoi.IndexOf(">") != -1)
                    {
                        sql += " and to_number(to_char(k.ngayrv,'yyyy'),'0000')-to_number(a.namsinh,'0000')>" + int.Parse(dotuoi.Substring(1));
                        //sql += " and to_number(to_char(now(),'yyyy'),'0000')-to_number(a.namsinh,'0000')>" + int.Parse(dotuoi.Substring(1));
                    }
                    else
                    {
                        int i1 = int.Parse(dotuoi.Substring(0, dotuoi.IndexOf("-")));
                        int i2 = int.Parse(dotuoi.Substring(dotuoi.IndexOf("-") + 1));
                        sql += " and to_number(to_char(k.ngayrv,'yyyy'),'0000')-to_number(a.namsinh,'0000') between " + i1 + " and " + i2; // sql += " and to_number(to_char(now(),'yyyy'),'0000')-to_number(a.namsinh,'0000') between " + i1 + " and " + i2;
                    }
                }
                sql += " order by k.ngayrv";

                ds = get_data(sql);
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message.ToString().Trim(), sComputer, "Rangtru");
            }
            return ds;
        }

        public DataSet get_Vaophongluu(string tu, string den, string mabn, string hoten, string ngaysinh,
            int phai, string sonha, string thon, string mann, string madantoc, string matt, string maqu,
            string maphuongxa, string sovaovien, string maicd, string madoituong, string dentu,
            string nhantu, string dotuoi, bool icd, int userid, bool time)
        {
            try
            {
                string stime = (time || tu.Trim().Length == 16) ? "'" + f_ngaygio + "'" : "'" + f_ngay + "'";
                if (time && tu != "")
                {
                    tu = tu.Substring(0, 10) + " " + sGiobaocao;
                    den = den.Substring(0, 10) + " " + sGiobaocao;
                }
                hoten = Hoten_khongdau(hoten);
                sql = "select a.mabn,f.maql,a.hoten,substr(k.tuoivao,1,3)||case when substr(k.tuoivao,4,1)=0 then 'TU' else case when substr(k.tuoivao,4,1)=1 then 'TH' else case when substr(k.tuoivao,4,1)=2 then 'NG' else 'GI' end end end as tuoi,";
                sql += "a.namsinh,coalesce(a.sonha,' ') sonha,coalesce(a.thon,' ') thon,b.tenpxa,c.tenquan,d.tentt,";
                sql += "g.tennn,to_char(f.ngay,'dd/mm/yyyy hh24:mi') as ngay,e.tenkp,h.doituong,";
                sql += "f.chandoan,f.maicd,f.sovaovien,i.ten as nhantu,j.ten as dentu,coalesce(u.hoten,' ') as tenuser ";
                sql += " from " + user + ".btdbn a inner join " + user + ".btdpxa b on a.maphuongxa=b.maphuongxa";
                sql += " inner join " + user + ".btdquan c on a.maqu=c.maqu";
                sql += " inner join " + user + ".btdtt d on a.matt=d.matt";
                sql += " inner join xxx.benhancc f on a.mabn=f.mabn";
                sql += " inner join " + user + ".btdkp_bv e on f.makp=e.makp";
                sql += " inner join " + user + ".btdnn_bv g on a.mann=g.mann";
                sql += " inner join " + user + ".doituong h on f.madoituong=h.madoituong";
                sql += " inner join " + user + ".nhantu i on f.nhantu=i.ma";
                sql += " inner join " + user + ".dentu j on f.dentu=j.ma";
                sql += " inner join xxx.lienhe k on f.maql=k.maql";
                sql += " left join " + user + ".dlogin u on f.userid=u.id";
                sql += " where f.maql>0";
                if (icd) sql += " and f.maicd in (select ma from " + user + ".dmicd10)";
                if (tu != "")
                {
                    sql += " and " + for_ngay("f.ngay", stime) + " between to_date('" + tu + "'," + stime + ") and to_date('" + den + "'," + stime + ")";
                }
                if (mabn != "") sql += " and a.mabn='" + mabn + "'";
                if (hoten != "") sql += " and a.hotenkdau='" + hoten + "'";
                if (ngaysinh.Trim().Length == 10) sql += " and to_char(a.ngaysinh,'dd/mm/yyyy')='" + ngaysinh + "'";
                if (phai != -1) sql += " and a.phai=" + phai;
                if (sonha != "") sql += " and lower(trim(a.sonha))='" + sonha + "'";
                if (thon != "") sql += " and lower(trim(a.thon))='" + thon + "'";
                if (mann != "") sql += " and a.mann='" + mann + "'";
                if (madantoc != "") sql += " and a.madantoc='" + madantoc + "'";
                if (matt != "") sql += " and a.matt='" + matt + "'";
                if (maqu != "") sql += " and a.maqu='" + maqu + "'";
                if (maphuongxa != "") sql += " and a.maphuongxa='" + maphuongxa + "'";
                if (sovaovien != "") sql += " and f.sovaovien='" + sovaovien + "'";
                if (maicd != "") sql += " and f.maicd='" + maicd + "'";
                if (madoituong != "") sql += " and f.madoituong=" + madoituong;
                if (dentu != "") sql += " and f.dentu=" + dentu;
                if (nhantu != "") sql += " and f.nhantu=" + nhantu;
                if (userid != -1) sql += " and f.userid=" + userid;
                if (dotuoi != "")
                {
                    if (dotuoi.IndexOf(">") != -1)
                    {
                        sql += " and to_number(to_char(f.ngay,'yyyy'),'0000')-to_number(a.namsinh,'0000')>" + int.Parse(dotuoi.Substring(1)); //sql += " and to_number(to_char(now(),'yyyy'),'0000')-to_number(a.namsinh,'0000')>" + int.Parse(dotuoi.Substring(1));
                    }
                    else
                    {
                        int i1 = int.Parse(dotuoi.Substring(0, dotuoi.IndexOf("-")));
                        int i2 = int.Parse(dotuoi.Substring(dotuoi.IndexOf("-") + 1));
                        sql += " and to_number(to_char(f.ngay,'yyyy'),'0000')-to_number(a.namsinh,'0000') between " + i1 + " and " + i2; //sql += " and to_number(to_char(now(),'yyyy'),'0000')-to_number(a.namsinh,'0000') between " + i1 + " and " + i2;
                    }
                }
                sql += " order by f.ngay";
                ds = get_data_mmyy(sql, tu.Substring(0, 10), den.Substring(0, 10), false);
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message.ToString().Trim(), sComputer, "Vaophongluu");
            }
            return ds;
        }

        public DataSet get_Raphongluu(string tu, string den, string mabn, string hoten, string ngaysinh,
            int phai, string sonha, string thon, string mann, string madantoc, string matt, string maqu,
            string maphuongxa, string soluutru, string maicd, string madoituong, string ketqua,
            string ttlucrk, string dotuoi, bool icd, int userid, bool time, string nhantu)
        {
            try
            {
                string stime = (time || tu.Trim().Length == 16) ? "'" + f_ngaygio + "'" : "'" + f_ngay + "'";
                if (time && tu != "")
                {
                    tu = tu.Substring(0, 10) + " " + sGiobaocao;
                    den = den.Substring(0, 10) + " " + sGiobaocao;
                }
                hoten = Hoten_khongdau(hoten);
                sql = "select a.mabn,k.maql,a.hoten,to_char(a.ngaysinh,'dd/mm/yyyy') ngaysinh,substr(m.tuoivao,1,3)||case when substr(m.tuoivao,4,1)=0 then 'TU' else case when substr(m.tuoivao,4,1)=1 then 'TH' else case when substr(m.tuoivao,4,1)=2 then 'NG' else 'GI' end end end as tuoi,";
                sql += "a.namsinh,coalesce(a.sonha,' ') sonha,coalesce(a.thon,' ') thon,b.tenpxa,c.tenquan,d.tentt,";
                sql += "g.tennn,to_char(k.ngay,'dd/mm/yyyy hh24:mi') as ngayvk,e.tenkp,h.doituong,";
                sql += "k.chandoanrv as chandoan,k.maicdrv as maicd,k.sovaovien,i.ten as ketqua,j.ten as ttlucrk,";
                sql += "to_char(k.ngayrv,'dd/mm/yyyy hh24:mi') as ngayrk,k.soluutru, ";
                sql += "date(to_char(k.ngayrv,'yyyymmdd'))-date(to_char(k.ngay,'yyyymmdd'))+1 as ngaydt, ";
                sql += "coalesce(y.tenkp,' ') khoanhap,coalesce(u.hoten,' ') as tenuser ";
                sql += " from " + user + ".btdbn a inner join " + user + ".btdpxa b on a.maphuongxa=b.maphuongxa";
                sql += " inner join " + user + ".btdquan c on a.maqu=c.maqu";
                sql += " inner join " + user + ".btdtt d on a.matt=d.matt";
                sql += " inner join xxx.benhancc k on a.mabn=k.mabn";
                sql += " inner join " + user + ".btdkp_bv e on k.makp=e.makp";//benhandt k,xuatvien l,
                sql += " inner join " + user + ".btdnn_bv g on a.mann=g.mann";
                sql += " inner join " + user + ".doituong h on k.madoituong=h.madoituong";
                sql += " inner join " + user + ".ketqua i on k.ketqua=i.ma";
                sql += " left join " + user + ".xutrikb j on k.ttlucrv=j.ma";
                sql += " inner join xxx.lienhe m on k.maql=m.maql";
                sql += " left join xxx.xutrikbct x on k.maql=x.maql";
                sql += " left join " + user + ".btdkp_bv y on x.makp=y.makp";
                sql += " left join " + user + ".dlogin u on k.userid=u.id";
                sql += " where k.maql>0";
                if (icd) sql += " and k.maicdrv in (select ma from " + user + ".dmicd10)";
                if (tu != "")
                {
                    sql += " and " + for_ngay("k.ngayrv", stime) + " between to_date('" + tu + "'," + stime + ") and to_date('" + den + "'," + stime + ")";
                }
                if (mabn != "") sql += " and a.mabn='" + mabn + "'";
                if (hoten != "") sql += " and a.hotenkdau='" + hoten + "'";
                if (ngaysinh.Trim().Length == 10) sql += " and to_char(a.ngaysinh,'dd/mm/yyyy')='" + ngaysinh + "'";
                if (phai != -1) sql += " and a.phai=" + phai;
                if (sonha != "") sql += " and lower(trim(a.sonha))='" + sonha + "'";
                if (thon != "") sql += " and lower(trim(a.thon))='" + thon + "'";
                if (mann != "") sql += " and a.mann='" + mann + "'";
                if (madantoc != "") sql += " and a.madantoc='" + madantoc + "'";
                if (matt != "") sql += " and a.matt='" + matt + "'";
                if (maqu != "") sql += " and a.maqu='" + maqu + "'";
                if (maphuongxa != "") sql += " and a.maphuongxa='" + maphuongxa + "'";
                if (soluutru != "") sql += " and k.soluutru='" + soluutru + "'";
                if (maicd != "") sql += " and k.maicdrv='" + maicd + "'";
                if (madoituong != "") sql += " and k.madoituong=" + madoituong;
                if (ketqua != "") sql += " and k.ketqua=" + ketqua;
                if (ttlucrk != "") sql += " and x.xutri like '%" + ttlucrk + "%'";
                if (userid != -1) sql += " and k.userid=" + userid;
                if (nhantu != "") sql += " and k.nhantu=" + nhantu;
                if (dotuoi != "")
                {
                    if (dotuoi.Trim() == "<1TH")
                    {
                        sql += " and a.ngaysinh is not null and extract(day from(to_date(to_char(k.ngayrv,'dd/mm/yyyy'),'dd/mm/yyyy')-to_date(to_char(a.ngaysinh,'dd/mm/yyyy'),'dd/mm/yyyy'))) < 31 ";//DUOI 1 THANG
                    }
                    else if (dotuoi.Trim() == "<1T")
                    {
                        sql += " and a.ngaysinh is not null and extract(day from(to_date(to_char(k.ngayrv,'dd/mm/yyyy'),'dd/mm/yyyy')-to_date(to_char(a.ngaysinh,'dd/mm/yyyy'),'dd/mm/yyyy'))) between 31 and 365 ";//DUOI 1 TUOI
                    }
                    else if (dotuoi.IndexOf(">") != -1)
                        sql += " and to_number(to_char(k.ngayrv,'yyyy'),'0000')-to_number(a.namsinh,'0000')>" + int.Parse(dotuoi.Substring(1));
                    else
                    {
                        int i1 = int.Parse(dotuoi.Substring(0, dotuoi.IndexOf("-")));
                        int i2 = int.Parse(dotuoi.Substring(dotuoi.IndexOf("-") + 1));
                        sql += " and to_number(to_char(k.ngayrv,'yyyy'),'0000')-to_number(a.namsinh,'0000') between " + i1 + " and " + i2; //sql += " and to_number(to_char(now(),'yyyy'),'0000')-to_number(a.namsinh,'0000') between " + i1 + " and " + i2;
                    }
                }
                sql += " order by k.ngayrv";
                ds = get_data_mmyy(sql, tu.Substring(0, 10), den.Substring(0, 10), false);
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message.ToString().Trim(), sComputer, "Raphongluu");
            }
            return ds;
        }

        public DataSet get_Vaovien(string tu, string den, string mabn, string hoten, string ngaysinh,
            int phai, string sonha, string thon, string mann, string madantoc, string matt, string maqu,
            string maphuongxa, string makp, string sovaovien, string maicd, string madoituong, string dentu,
            string nhantu, string dotuoi, bool icd, string soluutru, int userid, bool time,string sothe)
        {
            string stime = (time) ? "'dd/mm/yyyy hh24:mi'" : "'dd/mm/yyyy'";
            if (time)
            {
                tu = tu + " " + sGiobaocao;
                den = den + " " + sGiobaocao;
            }
            hoten = Hoten_khongdau(hoten);
            sql = "select distinct a.mabn,a.hoten,to_char(a.ngaysinh,'dd/mm/yyyy') ngaysinh,substr(k.tuoivao,1,3)||case when substr(k.tuoivao,4,1)=0 then 'TU' else case when substr(k.tuoivao,4,1)=1 then 'TH' else case when substr(k.tuoivao,4,1)=2 then 'NG' else 'GI' end end end as tuoi,";
            sql += "a.namsinh,a.sonha,a.thon,b.tenpxa,c.tenquan,d.tentt,";
            sql += "g.tennn,to_char(f.ngay,'dd/mm/yyyy hh24:mi') as ngay,e.tenkp,h.doituong,bh.sothe,";
            sql += "f.chandoan,f.maicd,f.sovaovien,i.ten as nhantu,j.ten as dentu, k.soluutru,u.hoten as tenuser, f.tuchoi,f.maql,nk.khoachuyen ";
            sql += "from " + user + ".btdbn a inner join " + user + ".btdpxa b on a.maphuongxa=b.maphuongxa"+
                " inner join " + user + ".btdquan c on a.maqu=c.maqu inner join " + user + ".btdtt d on "+
                "a.matt=d.matt inner join " + user + ".benhandt f on a.mabn=f.mabn inner join " + user + ".btdkp_bv"+
                " e on f.makp=e.makp ";
            sql += "inner join " + user + ".btdnn_bv g on a.mann=g.mann inner join " + user + ".doituong h on "+
                "f.madoituong=h.madoituong inner join " + user + ".nhantu i on f.nhantu=i.ma inner join " + user + 
                ".dentu j on f.dentu=j.ma inner join " + user + ".lienhe k on f.maql=k.maql left join " + user + 
                ".dlogin u on f.userid=u.id left join "+user+".bhyt bh on f.maql=bh.maql ";
            sql += " left join "+user+".nhapkhoa nk on f.maql=nk.maql and nk.khoachuyen='01' ";
            sql += "where  ";
            sql += " f.loaiba=1 ";
            if (icd) sql += " and f.maicd in (select ma from " + user + ".dmicd10)";
            if (tu != "")
                sql += " and " + for_ngay("f.ngay", stime) + " between to_date('" + tu + "'," + stime + ") and to_date('" + den + "'," + stime + ")";
            if (mabn != "") sql += " and a.mabn='" + mabn + "'";
            if (hoten != "") sql += " and a.hotenkdau like '%" + hoten + "%'";
            if (ngaysinh.Trim().Length == 10) sql += " and to_char(a.ngaysinh,'dd/mm/yyyy')='" + ngaysinh + "'";
            if (phai != -1) sql += " and a.phai=" + phai;
            if (sonha != "") sql += " and lower(trim(a.sonha))='" + sonha + "'";
            if (thon != "") sql += " and lower(trim(a.thon))='" + thon + "'";
            if (mann != "") sql += " and a.mann='" + mann + "'";
            if (madantoc != "") sql += " and a.madantoc='" + madantoc + "'";
            if (matt != "") sql += " and a.matt='" + matt + "'";
            if (maqu != "") sql += " and a.maqu='" + maqu + "'";
            if (maphuongxa != "") sql += " and a.maphuongxa='" + maphuongxa + "'";
            if (makp != "") sql += " and f.makp='" + makp + "'";
            if (sovaovien != "") sql += " and f.sovaovien='" + sovaovien + "'";
            if (maicd != "") sql += " and f.maicd='" + maicd + "'";
            if (madoituong != "") sql += " and f.madoituong=" + madoituong;
            if (dentu != "") sql += " and f.dentu=" + dentu;
            if (nhantu != "") sql += " and f.nhantu=" + nhantu;
            if (soluutru == "*") sql += " and k.soluutru is not null";
            else if (soluutru != "") sql += " and k.soluutru='" + soluutru + "'";
            if (userid != -1) sql += " and f.userid=" + userid;
            if (sothe != "") sql += " and bh.sothe='"+sothe+"' ";
            if (dotuoi != "")
            {
                if (dotuoi.Trim() == "<1TH")
                {
                    sql += " and a.ngaysinh is not null and extract(day from(to_date(to_char(f.ngay,'dd/mm/yyyy'),'dd/mm/yyyy')-to_date(to_char(a.ngaysinh,'dd/mm/yyyy'),'dd/mm/yyyy'))) < 31 ";//DUOI 1 THANG
                }
                else if (dotuoi.Trim() == "<1T")
                {
                    sql += " and a.ngaysinh is not null and extract(day from(to_date(to_char(f.ngay,'dd/mm/yyyy'),'dd/mm/yyyy')-to_date(to_char(a.ngaysinh,'dd/mm/yyyy'),'dd/mm/yyyy'))) between 31 and 365 ";//DUOI 1 TUOI
                }
                else if (dotuoi.IndexOf(">") != -1)
                {
                    sql += " and to_number(to_char(f.ngay,'yyyy'),'0000')-to_number(a.namsinh,'0000')>" + int.Parse(dotuoi.Substring(1)); //sql += " and to_number(to_char(now(),'yyyy'),'0000')-to_number(a.namsinh,'0000')>" + int.Parse(dotuoi.Substring(1));
                }
                else
                {
                    int i1 = int.Parse(dotuoi.Substring(0, dotuoi.IndexOf("-")));
                    int i2 = int.Parse(dotuoi.Substring(dotuoi.IndexOf("-") + 1));
                    sql += " and to_number(to_char(f.ngay,'yyyy'),'0000')-to_number(a.namsinh,'0000') between " + i1 + " and " + i2; //sql += " and to_number(to_char(now(),'yyyy'),'0000')-to_number(a.namsinh,'0000') between " + i1 + " and " + i2;
                }
            }
            //sql += " order by f.ngay";
            return get_data(sql);
        }

        public DataSet get_Vaokhoa(string tu, string den, string mabn, string hoten, string ngaysinh,
            int phai, string sonha, string thon, string mann, string madantoc, string matt, string maqu,
            string maphuongxa, string makp, string noichuyen, string sovaovien, string maicd, string madoituong, string dentu,
            string nhantu, string dotuoi, bool icd, int userid, bool time,string sothe)
        {
            try
            {
                string m_dotuoi = "", stime = (time) ? "'dd/mm/yyyy hh24:mi'" : "'dd/mm/yyyy'";
                if (time)
                {
                    tu = tu + " " + sGiobaocao;
                    den = den + " " + sGiobaocao;
                }
                hoten = Hoten_khongdau(hoten);
                sql = "select f.id,a.mabn,a.hoten, to_char(a.ngaysinh,'dd/mm/yyyy') ngaysinh,substr(f.tuoivao,1,3)||case when substr(f.tuoivao,4,1)=0 then 'TU' else case when substr(f.tuoivao,4,1)=1 then 'TH' else case when substr(f.tuoivao,4,1)=2 then 'NG' else 'GI' end end end as tuoi,";
                sql += "a.namsinh,a.sonha,a.thon,b.tenpxa,c.tenquan,d.tentt,";
                sql += "g.tennn,to_char(f.ngay,'dd/mm/yyyy hh24:mi') as ngay,e.tenkp,h.doituong,";
                sql += "f.chandoan,f.maicd,k.sovaovien,i.ten as nhantu,j.ten as dentu,f.giuong,l.tenkp as noichuyen,u.hoten as tenuser,bh.sothe ";
                sql += "from " + user + ".btdbn a inner join " + user + ".btdpxa b on a.maphuongxa=b.maphuongxa inner join " + user + 
                    ".btdquan c on a.maqu=c.maqu inner join " + user + ".btdtt d on a.matt=d.matt inner join " + user + 
                    ".nhapkhoa f on a.mabn=f.mabn inner join " + user + ".btdkp_bv e on f.makp=e.makp ";
                sql += "inner join " + user + ".benhandt k on f.maql=k.maql inner join " + user + 
                    ".btdnn_bv g on a.mann=g.mann inner join " + user + 
                    ".doituong h on k.madoituong=h.madoituong inner join " + user + 
                    ".nhantu i on k.nhantu=i.ma inner join " + user + ".dentu j on k.dentu=j.ma inner join " + user +
                    ".btdkp_bv l on f.khoachuyen=l.makp left join " + user + ".dlogin u on f.userid=u.id left join "+user+".bhyt bh on k.maql=bh.maql ";
                sql += "where ";
                sql += "k.loaiba=1";
                if (icd) sql += " and f.maicd in (select ma from " + user + ".dmicd10)";
                if (tu != "")
                {
                    if (time)
                        sql += " and f.ngay between to_date(:tu," + stime + ") and to_date(:den," + stime + ")";
                    else
                        sql += " and " + for_ngay("f.ngay", stime) + " between to_date(:tu," + stime + ") and to_date(:den," + stime + ")";
                }
                if (mabn != "") sql += " and a.mabn=:mabn";
                if (hoten != "") sql += " and a.hotenkdau=:hoten";
                if (ngaysinh.Trim().Length == 10) sql += " and to_char(a.ngaysinh,'dd/mm/yyyy')=:ngaysinh";
                if (phai != -1) sql += " and a.phai=:phai";
                if (sonha != "") sql += " and lower(trim(a.sonha))=:sonha";
                if (thon != "") sql += " and lower(trim(a.thon))=:thon";
                if (mann != "") sql += " and a.mann=:mann";
                if (madantoc != "") sql += " and a.madantoc=:madantoc";
                if (matt != "") sql += " and a.matt=:matt";
                if (maqu != "") sql += " and a.maqu=:maqu";
                if (maphuongxa != "") sql += " and a.maphuongxa=:maphuongxa";
                if (makp != "") sql += " and f.makp=:makp";
                if (noichuyen != "") sql += " and f.khoachuyen=:noichuyen";
                if (sovaovien != "") sql += " and k.sovaovien=:sovaovien";
                if (maicd != "") sql += " and f.maicd=:maicd";
                if (madoituong != "") sql += " and k.madoituong=:madoituong";
                if (dentu != "") sql += " and k.dentu=:dentu";
                if (nhantu != "") sql += " and k.nhantu=:nhantu";
                if (userid != -1) sql += " and f.userid=:userid";
                if (sothe != "") sql += " and bh.sothe=:sothe";
                if (dotuoi != "") 
                {

                    if (dotuoi.Trim() == "<1TH")
                    {
                        sql += " and a.ngaysinh is not null and extract(day from(to_date(to_char(f.ngay,'dd/mm/yyyy'),'dd/mm/yyyy')-to_date(to_char(a.ngaysinh,'dd/mm/yyyy'),'dd/mm/yyyy'))) < 31 ";//DUOI 1 THANG
                    }
                    else if (dotuoi.Trim() == "<1T")
                    {
                        sql += " and a.ngaysinh is not null and extract(day from(to_date(to_char(f.ngay,'dd/mm/yyyy'),'dd/mm/yyyy')-to_date(to_char(a.ngaysinh,'dd/mm/yyyy'),'dd/mm/yyyy'))) between 31 and 365 ";//DUOI 1 TUOI
                    }
                    else if (dotuoi.IndexOf(">") != -1)
                    {
                        m_dotuoi = dotuoi.Substring(1);
                        sql += " and to_number(to_char(f.ngay,'yyyy'))-to_number(a.namsinh)>" + m_dotuoi;
                    }
                    else if (dotuoi.IndexOf("<") != -1)
                    {

                    }
                    else
                    {
                        int i1 = int.Parse(dotuoi.Substring(0, dotuoi.IndexOf("-")));
                        int i2 = int.Parse(dotuoi.Substring(dotuoi.IndexOf("-") + 1));
                        sql += " and to_number(to_char(f.ngay,'yyyy'),'0000')-to_number(a.namsinh,'0000') between " + i1 + " and " + i2;
                    }
                }
                sql += " order by f.ngay";
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                if (tu != "")
                {
                    cmd.Parameters.Add("tu", NpgsqlDbType.Varchar).Value = tu;
                    cmd.Parameters.Add("den", NpgsqlDbType.Varchar).Value = den;
                }
                if (mabn != "") cmd.Parameters.Add("mabn", NpgsqlDbType.Varchar).Value = mabn;
                if (hoten != "") cmd.Parameters.Add("hoten", NpgsqlDbType.Text).Value = hoten;
                if (ngaysinh.Trim().Length == 10) cmd.Parameters.Add("ngaysinh", NpgsqlDbType.Varchar).Value = ngaysinh;
                if (phai != -1) cmd.Parameters.Add("phai", NpgsqlDbType.Numeric).Value = phai;
                if (sonha != "") cmd.Parameters.Add("sonha", NpgsqlDbType.Text).Value = sonha.Trim().ToLower();
                if (thon != "") cmd.Parameters.Add("thon", NpgsqlDbType.Text).Value = thon.Trim().ToLower();
                if (mann != "") cmd.Parameters.Add("mann", NpgsqlDbType.Varchar).Value = mann;
                if (madantoc != "") cmd.Parameters.Add("madantoc", NpgsqlDbType.Varchar).Value = madantoc;
                if (matt != "") cmd.Parameters.Add("matt", NpgsqlDbType.Varchar).Value = matt;
                if (maqu != "") cmd.Parameters.Add("maqu", NpgsqlDbType.Varchar).Value = maqu;
                if (maphuongxa != "") cmd.Parameters.Add("maphuongxa", NpgsqlDbType.Varchar).Value = maphuongxa;
                if (makp != "") cmd.Parameters.Add("makp", NpgsqlDbType.Varchar).Value = makp;
                if (noichuyen != "") cmd.Parameters.Add("noichuyen", NpgsqlDbType.Varchar).Value = noichuyen;
                if (sovaovien != "") cmd.Parameters.Add("sovaovien", NpgsqlDbType.Varchar).Value = sovaovien;
                if (maicd != "") cmd.Parameters.Add("maicd", NpgsqlDbType.Varchar).Value = maicd;
                if (madoituong != "") cmd.Parameters.Add("madoituong", NpgsqlDbType.Varchar).Value = madoituong;
                if (dentu != "") cmd.Parameters.Add("dentu", NpgsqlDbType.Varchar).Value = dentu;
                if (nhantu != "") cmd.Parameters.Add("nhantu", NpgsqlDbType.Varchar).Value = nhantu;
                if (userid != -1) cmd.Parameters.Add("userid", NpgsqlDbType.Varchar).Value = userid;
                if (sothe != "") cmd.Parameters.Add("sothe", NpgsqlDbType.Varchar).Value = sothe;
                dest = new NpgsqlDataAdapter(cmd);
                ds = new DataSet();
                dest.Fill(ds);
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message.ToString().Trim(), sComputer, "Vaokhoa");
            }
            return ds;
        }

        public DataSet get_Rakhoa(string tu, string den, string mabn, string hoten, string ngaysinh,
            int phai, string sonha, string thon, string mann, string madantoc, string matt, string maqu,
            string maphuongxa, string makp, string sovaovien, string maicd, string madoituong, string ketqua,
            string ttlucrk, string dotuoi, bool icd, string maicdnn, bool icdnn, string mapttt,
            bool pttt, int userid, bool time, bool bPhatQua, string tungayphatqua, string denngayphatqua,string sothe)
        {
            try
            {
                string m_dotuoi = "", stime = (time) ? "'dd/mm/yyyy hh24:mi'" : "'dd/mm/yyyy'";
                int i_songaydtcongthem = iSongaydieutri_congthem;
                if (time)
                {
                    tu = tu + " " + sGiobaocao;
                    den = den + " " + sGiobaocao;
                }
                execute_data("delete from " + user + ".t_pttt");
                execute_data("delete from " + user + ".t_cdnguyennhan");
                if (pttt || mapttt != "")
                {
                    execute_data("delete from " + user + ".t_pttt");
                    sql = "insert into " + user + ".t_pttt select distinct c.maql,c.mapt,c.tenpt from " + user + ".nhapkhoa a," + user + ".xuatkhoa b,xxx.pttt c where a.id=b.id and a.maql=c.maql";
                    if (tu != "")
                    {
                        if (time) sql += " and b.ngay between to_date('" + tu + "'," + stime + ") and to_date('" + den + "'," + stime + ")";
                        else sql += " and " + for_ngay("b.ngay", stime) + " between to_date('" + tu + "'," + stime + ") and to_date('" + den + "'," + stime + ")";
                    }
                    if (mapttt != "") sql += " and c.mapt='" + mapttt + "'";
                    if (pttt) sql += " and c.mapt in (select ma from " + user + ".bctheopttt)";
                    execute_data_mmyy(sql, tu, den, false);
                }
                if (icdnn || maicdnn != "")
                {
                    execute_data("delete from " + user + ".t_cdnguyennhan");
                    sql = "insert into " + user + ".t_cdnguyennhan select distinct c.maql,c.maicd,c.chandoan from " + user + ".benhandt a," + user + ".xuatvien b," + user + ".cdnguyennhan c where a.maql=b.maql and a.maql=c.maql";
                    if (tu != "")
                    {
                        if (time) sql += " and b.ngay between to_date('" + tu + "'," + stime + ") and to_date('" + den + "'," + stime + ")";
                        else sql += " and " + for_ngay("b.ngay", stime) + " between to_date('" + tu + "'," + stime + ") and to_date('" + den + "'," + stime + ")";
                    }
                    if (maicdnn != "") sql += " and c.maicd='" + maicdnn + "'";
                    if (icdnn) sql += " and c.maicd in (select ma from " + user + ".bctheoicd)";
                    execute_data(sql);
                }
                hoten = Hoten_khongdau(hoten);
                sql = "select a.mabn,a.hoten,to_char(a.ngaysinh,'dd/mm/yyyy') ngaysinh,substr(f.tuoivao,1,3)||case when substr(f.tuoivao,4,1)=0 then 'TU' else case when substr(f.tuoivao,4,1)=1 then 'TH' else case when substr(f.tuoivao,4,1)=2 then 'NG' else 'GI' end end end as tuoi,";
                sql += "a.namsinh,a.sonha,a.thon,b.tenpxa,c.tenquan,d.tentt,";
                sql += "g.tennn,to_char(f.ngay,'dd/mm/yyyy hh24:mi') as ngayvk,e.tenkp,h.doituong,";
                sql += "l.chandoan,l.maicd,k.sovaovien,i.ten as ketqua,j.ten as ttlucrk,f.giuong,";
                sql += "to_char(l.ngay,'dd/mm/yyyy hh24:mi') as ngayrk,m.sothe,";
                sql += "date(to_char(l.ngay,'yyyymmdd'))-date(to_char(f.ngay,'yyyymmdd'))+to_number(case when f.khoachuyen='01' then " + i_songaydtcongthem + " else 0 end) as ngaydt, ";
                sql += "x.tenpt,y.chandoan as chandoannn,u.hoten as tenuser,k.sovaovien, ";
                sql += "xv.ngaythoinoi ";
                sql += "from " + user + ".btdbn a inner join " + user + ".btdpxa b on a.maphuongxa=b.maphuongxa inner join " + user + ".btdquan c on a.maqu=c.maqu inner join " + user + ".btdtt d on a.matt=d.matt inner join " + user + ".nhapkhoa f on a.mabn=f.mabn inner join " + user + ".xuatkhoa l on f.id=l.id inner join " + user + ".btdkp_bv e on f.makp=e.makp ";
                sql += "inner join " + user + ".btdnn_bv g on a.mann=g.mann ";
                sql += "inner join " + user + ".benhandt k on f.maql=k.maql ";
                sql += "inner join " + user + ".doituong h on k.madoituong=h.madoituong ";
                sql += "inner join " + user + ".ketqua i on l.ketqua=i.ma ";
                sql += "inner join " + user + ".ttxk j on l.ttlucrk=j.ma ";
                sql += "left join " + user + ".bhyt m on f.maql=m.maql ";
                sql += "left join " + user + ".t_pttt x on k.maql=x.maql ";
                sql += "left join " + user + ".t_cdnguyennhan y on k.maql=y.maql ";
                sql += "left join " + user + ".dlogin u on l.userid=u.id ";
                sql += "left join " + user + ".xuatvien xv on k.maql=xv.maql ";
                sql += "where k.loaiba=1 ";
                sql += " and (m.sudung is null or m.sudung=1)";
                if (icd) sql += " and l.maicd in (select ma from " + user + ".dmicd10)";
                if (pttt) sql += " and x.mapt in (select ma from " + user + ".bctheopttt)";
                if (icdnn) sql += " and y.maicd in (select ma from " + user + ".bctheoicd)";
                if (tu != "")
                {
                    if (time)
                        sql += " and l.ngay between to_date(:tu," + stime + ") and to_date(:den," + stime + ")";
                    else
                        sql += " and " + for_ngay("l.ngay", stime) + " between to_date(:tu," + stime + ") and to_date(:den," + stime + ")";
                }
                if (tungayphatqua != "")
                {
                    sql += " and xv.ngaythoinoi between to_date('" + tungayphatqua + "','dd/MM/yyyy') and to_date('" + denngayphatqua + "','dd/MM/yyyy')";
                }
                if (mabn != "") sql += " and a.mabn=:mabn";
                if (hoten != "") sql += " and a.hotenkdau=:hoten";
                if (ngaysinh.Trim().Length == 10) sql += " and to_char(a.ngaysinh,'dd/mm/yyyy')=:ngaysinh";
                if (phai != -1) sql += " and a.phai=:phai";
                if (sonha != "") sql += " and lower(trim(a.sonha))=:sonha";
                if (thon != "") sql += " and lower(trim(a.thon))=:thon";
                if (mann != "") sql += " and a.mann=:mann";
                if (madantoc != "") sql += " and a.madantoc=:madantoc";
                if (matt != "") sql += " and a.matt=:matt";
                if (maqu != "") sql += " and a.maqu=:maqu";
                if (maphuongxa != "") sql += " and a.maphuongxa=:maphuongxa";
                if (makp != "") sql += " and f.makp=:makp";
                if (sovaovien != "") sql += " and k.sovaovien=:sovaovien";
                if (maicd != "") sql += " and l.maicd=:maicd";
                if (madoituong != "") sql += " and k.madoituong=:madoituong";
                if (ketqua != "") sql += " and l.ketqua=:ketqua";
                if (ttlucrk != "") sql += " and l.ttlucrk=:ttlucrk";
                if (mapttt != "") sql += " and x.mapt=:mapttt";
                if (maicdnn != "") sql += " and y.maicd=:maicdnn";
                if (userid != -1) sql += " and l.userid=:userid";
                if (bPhatQua) sql += " and l.phatqua=1";//gam 11042012
                if (sothe != "") sql += " and m.sothe=:sothe";

                if (dotuoi != "")
                {
                    if (dotuoi.Trim() == "<1TH")
                    {
                        sql += " and a.ngaysinh is not null and extract(day from(to_date(to_char(f.ngay,'dd/mm/yyyy'),'dd/mm/yyyy')-to_date(to_char(a.ngaysinh,'dd/mm/yyyy'),'dd/mm/yyyy'))) < 31 ";//DUOI 1 THANG
                    }
                    else if (dotuoi.Trim() == "<1T")
                    {
                        sql += " and a.ngaysinh is not null and extract(day from(to_date(to_char(f.ngay,'dd/mm/yyyy'),'dd/mm/yyyy')-to_date(to_char(a.ngaysinh,'dd/mm/yyyy'),'dd/mm/yyyy'))) between 31 and 365 ";//DUOI 1 TUOI
                    }
                    else if (dotuoi.IndexOf(">") != -1)
                    {
                        m_dotuoi = dotuoi.Substring(1);
                        sql += " and to_number(to_char(f.ngay,'yyyy'))-to_number(a.namsinh)>" + m_dotuoi;//sql += " and to_number(to_char(now(),'yyyy'))-to_number(a.namsinh)>" + m_dotuoi;
                    }
                    else
                    {
                        int i1 = int.Parse(dotuoi.Substring(0, dotuoi.IndexOf("-")));
                        int i2 = int.Parse(dotuoi.Substring(dotuoi.IndexOf("-") + 1));
                        sql += " and to_number(to_char(f.ngay,'yyyy'),'0000')-to_number(a.namsinh,'0000') between " + i1 + " and " + i2; //sql += " and to_number(to_char(now(),'yyyy'),'0000')-to_number(a.namsinh,'0000') between " + i1 + " and " + i2;
                    }
                }

                sql += " order by l.ngay";
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                if (tu != "")
                {
                    cmd.Parameters.Add("tu", NpgsqlDbType.Varchar).Value = tu;
                    cmd.Parameters.Add("den", NpgsqlDbType.Varchar).Value = den;
                }
                if (mabn != "") cmd.Parameters.Add("mabn", NpgsqlDbType.Varchar).Value = mabn;
                if (hoten != "") cmd.Parameters.Add("hoten", NpgsqlDbType.Text).Value = hoten;
                if (ngaysinh.Trim().Length == 10) cmd.Parameters.Add("ngaysinh", NpgsqlDbType.Varchar).Value = ngaysinh;
                if (phai != -1) cmd.Parameters.Add("phai", NpgsqlDbType.Numeric).Value = phai;
                if (sonha != "") cmd.Parameters.Add("sonha", NpgsqlDbType.Text).Value = sonha.Trim().ToLower();
                if (thon != "") cmd.Parameters.Add("thon", NpgsqlDbType.Text).Value = thon.Trim().ToLower();
                if (mann != "") cmd.Parameters.Add("mann", NpgsqlDbType.Varchar).Value = mann;
                if (madantoc != "") cmd.Parameters.Add("madantoc", NpgsqlDbType.Varchar).Value = madantoc;
                if (matt != "") cmd.Parameters.Add("matt", NpgsqlDbType.Varchar).Value = matt;
                if (maqu != "") cmd.Parameters.Add("maqu", NpgsqlDbType.Varchar).Value = maqu;
                if (maphuongxa != "") cmd.Parameters.Add("maphuongxa", NpgsqlDbType.Varchar).Value = maphuongxa;
                if (makp != "") cmd.Parameters.Add("makp", NpgsqlDbType.Varchar).Value = makp;
                if (sovaovien != "") cmd.Parameters.Add("sovaovien", NpgsqlDbType.Varchar).Value = sovaovien;
                if (maicd != "") cmd.Parameters.Add("maicd", NpgsqlDbType.Varchar).Value = maicd;
                if (madoituong != "") cmd.Parameters.Add("madoituong", NpgsqlDbType.Varchar).Value = madoituong;
                if (ketqua != "") cmd.Parameters.Add("ketqua", NpgsqlDbType.Varchar).Value = ketqua;
                if (ttlucrk != "") cmd.Parameters.Add("ttlucrk", NpgsqlDbType.Varchar).Value = ttlucrk;
                if (mapttt != "") cmd.Parameters.Add("mapttt", NpgsqlDbType.Varchar).Value = mapttt;
                if (maicdnn != "") cmd.Parameters.Add("maicdnn", NpgsqlDbType.Varchar).Value = maicdnn;
                if (userid != -1) cmd.Parameters.Add("userid", NpgsqlDbType.Varchar).Value = userid;
                if (sothe != "") cmd.Parameters.Add("sothe", NpgsqlDbType.Varchar).Value = sothe;
                dest = new NpgsqlDataAdapter(cmd);
                ds = new DataSet();
                dest.Fill(ds);
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message.ToString().Trim(), sComputer, "Rakhoa");
            }
            return ds;
        }

        public DataSet get_Ravien(string tu, string den, string mabn, string hoten, string ngaysinh,
            int phai, string sonha, string thon, string mann, string madantoc, string matt, string maqu,
            string maphuongxa, string makp, string soluutru, string maicd, string madoituong, string ketqua,
            string ttlucrk, string dotuoi, bool icd, string maicdnn, bool icdnn, string mapttt,
            bool pttt, int userid, bool time, int sort, bool bPhatqua, string tungayphatqua,
            string denngayphatqua, int daduyet, string noigioithieu, string mabvgioithieu, string sothe, int m_cophim, int m_dathanhtoan)
        {
            try
            {
                string m_dotuoi = "", stime = (time) ? "'dd/mm/yyyy hh24:mi'" : "'dd/mm/yyyy'";
                int i_songaydtcongthem = iSongaydieutri_congthem;
                
                if (time)
                {
                    tu = tu + " " + sGiobaocao;
                    den = den + " " + sGiobaocao;
                }
                execute_data("delete from " + user + ".t_pttt");
                execute_data("delete from " + user + ".t_cdnguyennhan");
                if (pttt || mapttt != "")
                {
                    execute_data("delete from " + user + ".t_pttt");
                    sql = "insert into " + user + ".t_pttt select distinct c.maql,c.mapt,c.tenpt from " + user + ".nhapkhoa a," + user + ".xuatkhoa b,xxx.pttt c where a.id=b.id and a.maql=c.maql";
                    if (tu != "")
                    {
                        if (time) sql += " and b.ngay between to_date('" + tu + "'," + stime + ") and to_date('" + den + "'," + stime + ")";
                        else sql += " and " + for_ngay("b.ngay", stime) + " between to_date('" + tu + "'," + stime + ") and to_date('" + den + "'," + stime + ")";
                    }
                    if (mapttt != "") sql += " and c.mapt='" + mapttt + "'";
                    if (pttt) sql += " and c.mapt in (select ma from " + user + ".bctheopttt)";
                    execute_data_mmyy(sql, tu, den, false);
                }
                if (icdnn || maicdnn != "")
                {
                    execute_data("delete from " + user + ".t_cdnguyennhan");
                    sql = "insert into " + user + ".t_cdnguyennhan select distinct c.maql,c.maicd,c.chandoan from " + user + ".benhandt a," + user + ".xuatvien b," + user + ".cdnguyennhan c where a.maql=b.maql and a.maql=c.maql";
                    if (tu != "")
                    {
                        if (time) sql += " and b.ngay between to_date('" + tu + "'," + stime + ") and to_date('" + den + "'," + stime + ")";
                        else sql += " and " + for_ngay("b.ngay", stime) + " between to_date('" + tu + "'," + stime + ") and to_date('" + den + "'," + stime + ")";
                    }
                    if (maicdnn != "") sql += " and c.maicd='" + maicdnn + "'";
                    if (icdnn) sql += " and c.maicd in (select ma from " + user + ".bctheoicd)";
                    execute_data(sql);
                }
                hoten = Hoten_khongdau(hoten);
                sql = "select a.mabn,a.hoten, to_char(a.ngaysinh,'dd/mm/yyyy') ngaysinh,substr(m.tuoivao,1,3)||case when substr(m.tuoivao,4,1)=0 then 'TU' else case when substr(m.tuoivao,4,1)=1 then 'TH' else case when substr(m.tuoivao,4,1)=2 then 'NG' else 'GI' end end end as tuoi,";
                sql += "a.namsinh,a.sonha,a.thon,b.tenpxa,c.tenquan,d.tentt,";
                sql += "g.tennn,to_char(k.ngay,'dd/mm/yyyy hh24:mi') as ngayvk,e.tenkp,h.doituong,";
                sql += "l.chandoan as chandoanra,l.maicd as maicdra,k.chandoan as chandoanvao,k.maicd as maicdvao,k.sovaovien,i.ten as ketqua,j.ten as ttlucrk,";//Thuy 02.04.2012
                sql += "to_char(l.ngay,'dd/mm/yyyy hh24:mi') as ngayrk,l.soluutru, ";
                sql += " n.sothe,date(to_char(l.ngay,'yyyymmdd'))-date(to_char(k.ngay,'yyyymmdd'))+" + iSongaydieutri_congthem + " as ngaydt, ";
                sql += " x.tenpt,y.chandoan as chandoannn,u.hoten as tenuser, icd.stt,l.ngaythoinoi,l.done,f.ten as dentu,q.tenbv as coquanytegioithieu ";
                sql += " from " + user + ".btdbn a inner join " + user + ".benhandt k on a.mabn=k.mabn ";
                sql += " inner join " + user + ".xuatvien l on k.maql=l.maql ";
                sql += " inner join " + user + ".btdpxa b on a.maphuongxa=b.maphuongxa ";
                sql += " inner join " + user + ".btdquan c on a.maqu=c.maqu ";
                sql += " inner join " + user + ".btdtt d on a.matt=d.matt ";
                sql += " inner join " + user + ".btdkp_bv e on l.makp=e.makp ";
                sql += "inner join " + user + ".btdnn_bv g on a.mann=g.mann ";
                sql += " inner join " + user + ".doituong h on k.madoituong=h.madoituong ";
                sql += " inner join " + user + ".ketqua i on l.ketqua=i.ma ";
                sql += " inner join " + user + ".ttxk j on l.ttlucrv=j.ma ";
                sql += " inner join " + user + ".lienhe m on l.maql=m.maql ";
                sql += " left join " + user + ".bhyt n on l.maql=n.maql ";
                sql += " left join " + user + ".t_pttt x on k.maql=x.maql ";
                sql += " left join " + user + ".t_cdnguyennhan y on k.maql=y.maql ";
                sql += " left join " + user + ".dlogin u on l.userid=u.id ";
                sql += " left join " + user + ".icd10 icd on l.maicd=icd.cicd10 ";
                sql += " left join " + user + ".dentu f on k.dentu=f.ma ";
                sql += " left join " + user + ".noigioithieu p on p.maql=l.maql ";
                sql += " left join " + user + ".dstt q on q.mabv=p.mabv ";
                sql += "where ";
                sql += "k.loaiba=1 ";
                if (icd) sql += " and l.maicd in (select ma from " + user + ".dmicd10)";
                if (pttt) sql += " and x.mapt in (select ma from " + user + ".bctheopttt)";
                if (icdnn) sql += " and y.maicd in (select ma from " + user + ".bctheoicd)";
                if (tu != "")
                {
                    if (time)
                        sql += " and l.ngay between to_date(:tu," + stime + ") and to_date(:den," + stime + ")";
                    else
                        sql += " and " + for_ngay("l.ngay", stime) + " between to_date(:tu," + stime + ") and to_date(:den," + stime + ")";
                }
                if (tungayphatqua != "")
                {
                    sql += " and l.ngaythoinoi between to_date('" + tungayphatqua + "','dd/MM/yyyy') and to_date('" + denngayphatqua + "','dd/MM/yyyy')";
                }
                if (mabn != "") sql += " and a.mabn=:mabn";
                if (hoten != "") sql += " and a.hotenkdau like '%" + hoten + "%'";
                if (ngaysinh.Trim().Length == 10) sql += " and to_char(a.ngaysinh,'dd/mm/yyyy')=:ngaysinh";
                if (phai != -1) sql += " and a.phai=:phai";
                if (sonha != "") sql += " and lower(trim(a.sonha))=:sonha";
                if (thon != "") sql += " and lower(trim(a.thon))=:thon";
                if (mann != "") sql += " and a.mann=:mann";
                if (madantoc != "") sql += " and a.madantoc=:madantoc";
                if (matt != "") sql += " and a.matt=:matt";
                if (maqu != "") sql += " and a.maqu=:maqu";
                if (maphuongxa != "") sql += " and a.maphuongxa=:maphuongxa";
                if (makp != "") sql += " and l.makp=:makp";
                if (soluutru != "") sql += " and l.soluutru=:soluutru";
                if (maicd != "") sql += " and l.maicd=:maicd";
                if (madoituong != "") sql += " and k.madoituong=:madoituong";
                if (ketqua != "") sql += " and l.ketqua=:ketqua";
                if (ttlucrk != "") sql += " and l.ttlucrv=:ttlucrk";
                if (mapttt != "") sql += " and x.mapt=:mapttt";
                if (maicdnn != "") sql += " and y.maicd=:maicdnn";
                if (userid != -1) sql += " and l.userid=:userid";
                if (bPhatqua) sql += " and l.phatqua=1";
                //Lọc theo thủ tục xuát viện có lưu hồ sơ bệnh án
                if (daduyet ==1) sql += " and l.done=1";
                if (daduyet == 0) sql += " and l.done=0";
                if (noigioithieu != "") sql += " and k.dentu=:noigioithieu";
                if (mabvgioithieu != "") sql += " and q.mabv=:mabvgioithieu";
                if (sothe != "") sql += " and n.sothe=:sothe";
                if (dotuoi != "")
                {
                    if (dotuoi.Trim() == "<1TH")
                    {
                        sql += " and a.ngaysinh is not null and extract(day from(to_date(to_char(l.ngay,'dd/mm/yyyy'),'dd/mm/yyyy')-to_date(to_char(a.ngaysinh,'dd/mm/yyyy'),'dd/mm/yyyy'))) < 31 ";//DUOI 1 THANG
                    }
                    else if (dotuoi.Trim() == "<1T")
                    {
                        sql += " and a.ngaysinh is not null and extract(day from(to_date(to_char(l.ngay,'dd/mm/yyyy'),'dd/mm/yyyy')-to_date(to_char(a.ngaysinh,'dd/mm/yyyy'),'dd/mm/yyyy'))) between 31 and 365 ";//DUOI 1 TUOI
                    }
                    else if (dotuoi.IndexOf(">") != -1)
                    {
                        m_dotuoi = dotuoi.Substring(1);

                        sql += " and to_number(to_char(l.ngay,'yyyy'))-to_number(a.namsinh)>" + m_dotuoi; //sql += " and to_number(to_char(now(),'yyyy'))-to_number(a.namsinh)>" + m_dotuoi;

                    }
                    else
                    {
                        int i1 = int.Parse(dotuoi.Substring(0, dotuoi.IndexOf("-")));
                        int i2 = int.Parse(dotuoi.Substring(dotuoi.IndexOf("-") + 1));
                        sql += " and to_number(to_char(l.ngay,'yyyy'),'0000')-to_number(a.namsinh,'0000') between " + i1 + " and " + i2; //sql += " and to_number(to_char(now(),'yyyy'),'0000')-to_number(a.namsinh,'0000') between " + i1 + " and " + i2;
                    }
                } 
                if (m_cophim != 2) sql += " and l.cophim=" + m_cophim;
                if (m_dathanhtoan != 2) sql += " and l.paid=" + m_dathanhtoan;
                sql += " order by ";
                if (sort == 1) sql += " l.soluutru ";
                else if (sort == 2) sql += " k.sovaovien ";
                else sql += " a.mabn ";
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                if (tu != "")
                {
                    cmd.Parameters.Add("tu", NpgsqlDbType.Varchar).Value = tu;
                    cmd.Parameters.Add("den", NpgsqlDbType.Varchar).Value = den;
                }
                if (mabn != "") cmd.Parameters.Add("mabn", NpgsqlDbType.Varchar).Value = mabn;
                if (hoten != "") cmd.Parameters.Add("hoten", NpgsqlDbType.Text).Value = hoten;
                if (ngaysinh.Trim().Length == 10) cmd.Parameters.Add("ngaysinh", NpgsqlDbType.Varchar).Value = ngaysinh;
                if (phai != -1) cmd.Parameters.Add("phai", NpgsqlDbType.Numeric).Value = phai;
                if (sonha != "") cmd.Parameters.Add("sonha", NpgsqlDbType.Text).Value = sonha.Trim().ToLower();
                if (thon != "") cmd.Parameters.Add("thon", NpgsqlDbType.Text).Value = thon.Trim().ToLower();
                if (mann != "") cmd.Parameters.Add("mann", NpgsqlDbType.Varchar).Value = mann;
                if (madantoc != "") cmd.Parameters.Add("madantoc", NpgsqlDbType.Varchar).Value = madantoc;
                if (matt != "") cmd.Parameters.Add("matt", NpgsqlDbType.Varchar).Value = matt;
                if (maqu != "") cmd.Parameters.Add("maqu", NpgsqlDbType.Varchar).Value = maqu;
                if (maphuongxa != "") cmd.Parameters.Add("maphuongxa", NpgsqlDbType.Varchar).Value = maphuongxa;
                if (makp != "") cmd.Parameters.Add("makp", NpgsqlDbType.Varchar).Value = makp;
                if (soluutru != "") cmd.Parameters.Add("soluutru", NpgsqlDbType.Varchar).Value = soluutru;
                if (maicd != "") cmd.Parameters.Add("maicd", NpgsqlDbType.Varchar).Value = maicd;
                if (madoituong != "") cmd.Parameters.Add("madoituong", NpgsqlDbType.Varchar).Value = madoituong;
                if (ketqua != "") cmd.Parameters.Add("ketqua", NpgsqlDbType.Varchar).Value = ketqua;
                if (ttlucrk != "") cmd.Parameters.Add("ttlucrk", NpgsqlDbType.Varchar).Value = ttlucrk;
                if (mapttt != "") cmd.Parameters.Add("mapttt", NpgsqlDbType.Varchar).Value = mapttt;
                if (maicdnn != "") cmd.Parameters.Add("maicdnn", NpgsqlDbType.Varchar).Value = maicdnn;
                if (userid != -1) cmd.Parameters.Add("userid", NpgsqlDbType.Varchar).Value = userid;
                if (noigioithieu != "") cmd.Parameters.Add("noigioithieu", NpgsqlDbType.Varchar).Value = noigioithieu;
                if (noigioithieu != "") cmd.Parameters.Add("mabvgioithieu", NpgsqlDbType.Varchar).Value = mabvgioithieu;
                if (sothe != "") cmd.Parameters.Add("sothe", NpgsqlDbType.Varchar).Value = sothe;
                dest = new NpgsqlDataAdapter(cmd);
                ds = new DataSet();
                dest.Fill(ds);
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message.ToString().Trim(), sComputer, "Ravien");
            }
            return ds;
        }

        public DataSet get_pttt(string table, string tu, string den, string mabn, string hoten, string ngaysinh,
            int phai, string sonha, string thon, string mann, string madantoc, string matt, string maqu,
            string maphuongxa, string makp, string sovaovien, string madoituong, string mapt,
            string tenbs, string tenphuongphap, string tinhhinh, string loaipt, string taibien, string tuvong, string dotuoi, int userid, bool time, int m_noisoi, int m_molaimien)
        {
            string m_dotuoi = "", stime = (time) ? "'dd/mm/yyyy hh24:mi'" : "'dd/mm/yyyy'";
            if (time)
            {
                tu = tu + " " + sGiobaocao;
                den = den + " " + sGiobaocao;
            }
            hoten = Hoten_khongdau(hoten);
            sql = "select a.mabn,a.hoten,substr(q.tuoivao,1,3)||case when substr(q.tuoivao,4,1)=0 then 'TU' else case when substr(q.tuoivao,4,1)=1 then 'TH' else case when substr(q.tuoivao,4,1)=2 then 'NG' else 'GI' end end end as tuoi,";
            sql += "a.namsinh,a.sonha,a.thon,b.tenpxa,c.tenquan,d.tentt,";
            sql += "g.tennn,to_char(f.ngay,'dd/mm/yyyy hh24:mi') as ngay,e.tenkp,h.doituong,";
            sql += "f.tenpt,f.mapt,j.ten as loaipt,p.hoten as tenbs,k.ten as phuongphap,";
            sql += "m.ten as tinhhinh,n.ten as taibien,l.ten as tuvong,o.sovaovien,u.hoten as tenuser,y.tenkp as noichuyen ";
            sql += ", f.chandoant, f.maicdt, f.chandoans, f.maicds ";
            sql += ", f.phu1, f.phu2, f.bsgayme, f.ktvgayme, f.hoisuc, f.dungcu, p1.hoten as tenphu1, p2.hoten as tenphu2, p3.hoten as tenbsgayme, p4.hoten as tenktvgayme, p5.hoten as tenhoisuc, p1.hoten as tendungcu ";
            sql += " from " + user + ".btdbn a left join " + user + ".btdpxa b on a.maphuongxa=b.maphuongxa ";
            sql += " left join " + user + ".btdquan c on a.maqu=c.maqu ";
            sql += " left join " + user + ".btdtt d on a.matt=d.matt ";
            sql += " inner join " + user + "." + table + " o on a.mabn=o.mabn ";
            sql += " inner join xxx.pttt f on f.maql=o.maql ";
            sql += " left join " + user + ".btdkp_bv e on f.makp=e.makp ";
            sql += " left join " + user + ".btdnn_bv g on a.mann=g.mann ";
            sql += " left join " + user + ".doituong h on o.madoituong=h.madoituong ";
            sql += " left join " + user + ".dmpttt i on f.mapt=i.mapt ";
            sql += " left join " + user + ".loaipttt j on i.loaipt=j.ma  ";
            sql += " left join " + user + ".dmmete k on f.phuongphap=k.ma ";
            sql += " left join " + user + ".tuvongpt l on f.tuvong=l.ma ";
            sql += " left join " + user + ".tinhhinhpt m on f.tinhhinh=m.ma left join " + user + ".taibienpt n on f.taibien=n.ma ";
            sql += " left join " + user + ".dmbs p on f.ptv=p.ma ";
            //theo yeu cau cua dc Thai
            sql += " left join " + user + ".dmbs p1 on f.phu1=p1.ma ";
            sql += " left join " + user + ".dmbs p2 on f.phu2=p2.ma ";
            sql += " left join " + user + ".dmbs p3 on f.bsgayme=p3.ma ";
            sql += " left join " + user + ".dmbs p4 on f.ktvgayme=p4.ma ";
            sql += " left join " + user + ".dmbs p5 on f.hoisuc=p5.ma ";
            sql += " left join " + user + ".dmbs p6 on f.dungcu=p6.ma ";
            //
            sql += " left join " + user + ".lienhe q on f.maql=q.maql ";
            sql += " left join " + user + ".dlogin u on f.userid=u.id ";
            sql += " left join " + user + ".nhapkhoa x on f.idkhoa=x.id ";
            sql += " left join " + user + ".btdkp_bv y on x.khoachuyen=y.makp ";
            sql += " where f.loaibn in (0,1) ";
            if (tu != "")
            {
                if (time)
                    sql += " and f.ngay between to_date('" + tu + "'," + stime + ") and to_date('" + den + "'," + stime + ")";
                else
                    sql += " and " + for_ngay("f.ngay", stime) + " between to_date('" + tu + "'," + stime + ") and to_date('" + den + "'," + stime + ")";
            }
            if (mabn != "") sql += " and a.mabn='" + mabn + "'";
            if (hoten != "") sql += " and a.hotenkdau='" + hoten + "'";
            if (ngaysinh.Trim().Length == 10) sql += " and to_char(a.ngaysinh,'dd/mm/yyyy')='" + ngaysinh + "'";
            if (phai != -1) sql += " and a.phai=" + phai;
            if (sonha != "") sql += " and lower(trim(a.sonha))='" + sonha + "'";
            if (thon != "") sql += " and lower(trim(a.thon))='" + thon + "'";
            if (mann != "") sql += " and a.mann='" + mann + "'";
            if (madantoc != "") sql += " and a.madantoc='" + madantoc + "'";
            if (matt != "") sql += " and a.matt='" + matt + "'";
            if (maqu != "") sql += " and a.maqu='" + maqu + "'";
            if (maphuongxa != "") sql += " and a.maphuongxa='" + maphuongxa + "'";
            if (makp != "") sql += " and f.makp='" + makp + "'";
            if (sovaovien != "") sql += " and o.sovaovien='" + sovaovien + "'";
            if (madoituong != "") sql += " and o.madoituong='" + madoituong + "'";
            if (mapt != "") sql += " and f.mapt='" + mapt + "'";
            if (tenbs != "") sql += " and f.ptv='" + tenbs + "'";
            if (tenphuongphap != "") sql += " and f.phuongphap='" + tenphuongphap + "'";
            if (tinhhinh != "") sql += " and f.tinhhinh='" + tinhhinh + "'";
            if (loaipt != "") sql += " and i.loaipt='" + loaipt + "'";
            if (taibien != "") sql += " and f.taibien='" + taibien + "'";
            if (tuvong != "") sql += " and f.tuvong='" + tuvong + "'";
            if (userid != -1) sql += " and f.userid='" + userid + "'";
            if (m_noisoi != 0) sql += " and f.noisoi=" + m_noisoi;
            if (m_molaimien != 0) sql += " and f.molaimien=" + m_molaimien;

            if (dotuoi != "")
            {
                if (dotuoi.Trim() == "<1TH")
                {
                    sql += " and a.ngaysinh is not null and extract(day from(to_date(to_char(f.ngay,'dd/mm/yyyy'),'dd/mm/yyyy')-to_date(to_char(a.ngaysinh,'dd/mm/yyyy'),'dd/mm/yyyy'))) < 31 ";//DUOI 1 THANG
                }
                else if (dotuoi.Trim() == "<1T")
                {
                    sql += " and a.ngaysinh is not null and extract(day from(to_date(to_char(f.ngay,'dd/mm/yyyy'),'dd/mm/yyyy')-to_date(to_char(a.ngaysinh,'dd/mm/yyyy'),'dd/mm/yyyy'))) between 31 and 365 ";//DUOI 1 TUOI
                }
                else if (dotuoi.IndexOf(">") != -1)
                {
                    m_dotuoi = dotuoi.Substring(1);
                    sql += " and to_number(to_char(f.ngay,'yyyy'))-to_number(a.namsinh)>" + m_dotuoi;
                    //sql += " and to_number(to_char(now(),'yyyy'))-to_number(a.namsinh)>" + m_dotuoi;
                }
                else
                {
                    int i1 = int.Parse(dotuoi.Substring(0, dotuoi.IndexOf("-")));
                    int i2 = int.Parse(dotuoi.Substring(dotuoi.IndexOf("-") + 1));
                    sql += " and to_number(to_char(f.ngay,'yyyy'),'0000')-to_number(a.namsinh,'0000') between " + i1 + " and " + i2; //sql += " and to_number(to_char(now(),'yyyy'),'0000')-to_number(a.namsinh,'0000') between " + i1 + " and " + i2;
                }
            }
            sql += " order by f.ngay";
            return get_data_mmyy(sql, tu, den, false);
        }

        public DataSet get_pttt_mmyy(string table, string tu, string den, string mabn, string hoten, string ngaysinh,
            int phai, string sonha, string thon, string mann, string madantoc, string matt, string maqu,
            string maphuongxa, string makp, string sovaovien, string madoituong, string mapt,
            string tenbs, string tenphuongphap, string tinhhinh, string loaipt, string taibien, string tuvong,
            string dotuoi, int userid, bool time, int loaibn, int m_noisoi, int m_molaimien)
        {
            string m_dotuoi = "", stime = (time) ? "'dd/mm/yyyy hh24:mi'" : "'dd/mm/yyyy'";
            if (time)
            {
                tu = tu + " " + sGiobaocao;
                den = den + " " + sGiobaocao;
            }
            hoten = Hoten_khongdau(hoten);
            sql = "select a.mabn,a.hoten,substr(q.tuoivao,1,3)||case when substr(q.tuoivao,4,1)=0 then 'TU' else case when substr(q.tuoivao,4,1)=1 then 'TH' else case when substr(q.tuoivao,4,1)=2 then 'NG' else 'GI' end end end as tuoi,";
            sql += " a.namsinh,a.sonha,a.thon,b.tenpxa,c.tenquan,d.tentt,";
            sql += " g.tennn,to_char(f.ngay,'dd/mm/yyyy hh24:mi') as ngay,e.tenkp,h.doituong,";
            sql += " f.tenpt,f.mapt,j.ten as loaipt,p.hoten as tenbs,k.ten as phuongphap,";
            sql += " m.ten as tinhhinh,n.ten as taibien,l.ten as tuvong,o.sovaovien,u.hoten as tenuser,x.tenkp as noichuyen ";
            sql += ", f.chandoant, f.maicdt, f.chandoans, f.maicds ";
            sql += " from " + user + ".btdbn a left join " + user + ".btdpxa b on a.maphuongxa=b.maphuongxa ";
            sql += " left join " + user + ".btdquan c on a.maqu=c.maqu ";
            sql += " left join  " + user + ".btdtt d on a.matt=d.matt  ";
            sql += " inner join xxx.pttt f on a.mabn=f.mabn ";
            sql += " left join xxx." + table + " o on f.maql=o.maql ";
            sql += " left join " + user + ".btdkp_bv e on f.makp=e.makp ";
            sql += " left join " + user + ".btdnn_bv g on a.mann=g.mann ";
            sql += " left join " + user + ".doituong h on f.madoituong=h.madoituong  ";
            sql += " left join " + user + ".dmpttt i on f.mapt=i.mapt ";
            sql += " left join " + user + ".loaipttt j on i.loaipt=j.ma ";
            sql += " left join " + user + ".dmmete k on f.phuongphap=k.ma ";
            sql += " left join " + user + ".tuvongpt l on f.tuvong=l.ma ";
            sql += " left join " + user + ".tinhhinhpt m on f.tinhhinh=m.ma ";
            sql += " left join " + user + ".taibienpt n on f.taibien=n.ma ";
            sql += " left join " + user + ".dmbs p on f.ptv=p.ma ";
            sql += " left join " + user + ".dlogin u on f.userid=u.id ";
            sql += " left join xxx.lienhe q on o.maql=q.maql ";
            sql += " left join " + user + ".btdkp_bv x on o.makp=x.makp ";
            sql += " where f.loaibn=" + loaibn;
            if (tu != "")
            {
                if (time)
                    sql += " and f.ngay between to_date('" + tu + "'," + stime + ") and to_date('" + den + "'," + stime + ")";
                else
                    sql += " and " + for_ngay("f.ngay", stime) + " between to_date('" + tu + "'," + stime + ") and to_date('" + den + "'," + stime + ")";
            }
            if (mabn != "") sql += " and a.mabn='" + mabn + "'";
            if (hoten != "") sql += " and a.hotenkdau='" + hoten + "'";
            if (ngaysinh.Trim().Length == 10) sql += " and to_char(a.ngaysinh,'dd/mm/yyyy')='" + ngaysinh + "'";
            if (phai != -1) sql += " and a.phai=" + phai;
            if (sonha != "") sql += " and lower(trim(a.sonha))='" + sonha + "'";
            if (thon != "") sql += " and lower(trim(a.thon))='" + thon + "'";
            if (mann != "") sql += " and a.mann='" + mann + "'";
            if (madantoc != "") sql += " and a.madantoc='" + madantoc + "'";
            if (matt != "") sql += " and a.matt='" + matt + "'";
            if (maqu != "") sql += " and a.maqu='" + maqu + "'";
            if (maphuongxa != "") sql += " and a.maphuongxa='" + maphuongxa + "'";
            if (makp != "") sql += " and f.makp='" + makp + "'";
            if (sovaovien != "") sql += " and o.sovaovien='" + sovaovien + "'";
            if (madoituong != "") sql += " and o.madoituong='" + madoituong + "'";
            if (mapt != "") sql += " and f.mapt='" + mapt + "'";
            if (tenbs != "") sql += " and f.ptv='" + tenbs + "'";
            if (tenphuongphap != "") sql += " and f.phuongphap='" + tenphuongphap + "'";
            if (tinhhinh != "") sql += " and f.tinhhinh='" + tinhhinh + "'";
            if (loaipt != "") sql += " and i.loaipt='" + loaipt + "'";
            if (taibien != "") sql += " and f.taibien='" + taibien + "'";
            if (tuvong != "") sql += " and f.tuvong='" + tuvong + "'";
            if (userid != -1) sql += " and f.userid='" + userid + "'";
            if (m_noisoi != 0) sql += " and f.noisoi=" + m_noisoi;
            if (m_molaimien != 0) sql += " and f.molaimien=" + m_molaimien;
            if (dotuoi != "")
            {
                if (dotuoi.Trim() == "<1TH")
                {
                    sql += " and a.ngaysinh is not null and extract(day from(to_date(to_char(f.ngay,'dd/mm/yyyy'),'dd/mm/yyyy')-to_date(to_char(a.ngaysinh,'dd/mm/yyyy'),'dd/mm/yyyy'))) < 31 ";//DUOI 1 THANG
                }
                else if (dotuoi.Trim() == "<1T")
                {
                    sql += " and a.ngaysinh is not null and extract(day from(to_date(to_char(f.ngay,'dd/mm/yyyy'),'dd/mm/yyyy')-to_date(to_char(a.ngaysinh,'dd/mm/yyyy'),'dd/mm/yyyy'))) between 31 and 365 ";//DUOI 1 TUOI
                }
                else if (dotuoi.IndexOf(">") != -1)
                {
                    m_dotuoi = dotuoi.Substring(1);
                    sql += " and to_number(to_char(f.ngay,'yyyy'))-to_number(a.namsinh)>" + m_dotuoi; //sql += " and to_number(to_char(now(),'yyyy'))-to_number(a.namsinh)>" + m_dotuoi;
                }
                else
                {
                    int i1 = int.Parse(dotuoi.Substring(0, dotuoi.IndexOf("-")));
                    int i2 = int.Parse(dotuoi.Substring(dotuoi.IndexOf("-") + 1));
                    sql += " and to_number(to_char(f.ngay,'yyyy'),'0000')-to_number(a.namsinh,'0000') between " + i1 + " and " + i2; //sql += " and to_number(to_char(now(),'yyyy'),'0000')-to_number(a.namsinh,'0000') between " + i1 + " and " + i2;
                }
            }

            sql += " order by f.ngay";
            return get_data_mmyy(sql, tu, den, false);
        }
        
        #endregion

        public bool Kiemtra_maicd(DataTable dt, string ma)
        {
            if (ma == "") return true;
            DataRow r = getrowbyid(dt, "cicd10='" + ma + "'");
            return r != null;
        }

        public bool Kiemtra_tenbenh(DataTable dt, string ten)
        {
            if (ten == "" || !bChandoan_icd10) return true;
            DataRow r = getrowbyid(dt, "vviet='" + ten + "'");
            return r != null;
        }

        public bool Kiemtra_mapt(DataTable dt, string ma)
        {
            if (ma == "") return true;
            DataRow r = getrowbyid(dt, "mapt='" + ma + "'");
            return r != null;
        }

        public bool Kiemtra_tenpt(DataTable dt, string ten)
        {
            if (ten == "") return true;
            DataRow r = getrowbyid(dt, "noi_dung='" + ten + "'");
            return r != null;
        }

        public bool Kiemtra_mann(string ma, int tuoi, int treem6, int treem15)
        {
            if (tuoi < treem6) sql = "select * from " + user + ".btdnn_bv where mannbo='01'";
            else if (tuoi < treem15) sql = "select * from " + user + ".btdnn_bv where mannbo in ('01','02')";
            else sql = "select * from " + user + ".btdnn_bv where mannbo<>'01'";
            sql += " and mann='" + ma + "'";
            ds = get_data(sql);
            return ds.Tables[0].Rows.Count != 0;
        }

        public bool Kiemtra_loaiba(int loaiba)
        {
            ds = get_data("select * from " + user + ".dmbenhan_bv where loaiba=" + loaiba);
            return ds.Tables[0].Rows.Count != 0;
        }

        public decimal l_maql(string ngay, string mabn)
        {
            ds = get_data("select maql from " + user + ".benhandt where mabn='" + mabn + "' order by maql desc");
            if (ds.Tables[0].Rows.Count == 0 && bMmyy(mmyy(ngay)))
            {
                ds = get_data("select maql from " + user + mmyy(ngay) + ".tiepdon where mabn='" + mabn + "' order by maql desc");
                if (ds.Tables[0].Rows.Count == 0) return 0;
                else return decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            }
            else return decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
        }

        public bool kiemtra_khamnhi(string ma)
        {
            ds = get_data("select makpbo from " + user + ".btdkp_bv where makp='" + ma + "'");
            if (ds.Tables[0].Rows.Count == 0) return false;
            else return ds.Tables[0].Rows[0][0].ToString() == "17";
        }

        public decimal tienkham(bool m_nuocngoai, int m_mavp, int m_madoituong, string fie)
        {
            DataSet ds1 = get_data("select gia_th,gia_bh,gia_dv,gia_nn,gia_cs,vattu_th,vattu_bh,vattu_dv,vattu_nn,vattu_cs,gia_ksk,vattu_ksk from " + user + ".v_giavp where id=" + m_mavp);
            if (ds1.Tables[0].Rows.Count > 0)
            {
                decimal tygia = (fie.IndexOf("_nn") != -1) ? dTygia : 1;
                return decimal.Parse(ds1.Tables[0].Rows[0][fie].ToString()) * tygia;
            }
            return 0;
        }

        public decimal get_id_chidinh(string m_ngay, decimal m_maql, int m_mavp, int m_loai)
        {
            if (!bMmyy(mmyy(m_ngay))) return 0;
            sql = "select id from " + user + mmyy(m_ngay) + ".v_chidinh where maql=" + m_maql;
            if (m_mavp != 0) sql += " and mavp=" + m_mavp;
            else sql += " and to_char(ngay,'dd/mm/yyyy hh24:mi')='" + m_ngay + "'";
            sql += " and loai=" + m_loai;
            ds = get_data(sql);
            if (ds.Tables[0].Rows.Count > 0) return decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            else return 0;
        }

        public decimal get_id_vienphi(string m_ngay, decimal m_maql, int m_mavp, int m_loaibn)
        {
            if (!bMmyy(mmyy(m_ngay))) return 0;
            ds = get_data("select a.id from " + user + mmyy(m_ngay) + ".v_vienphill a," + user + mmyy(m_ngay) + ".v_vienphict b where a.id=b.id and a.maql=" + m_maql + " and b.mavp=" + m_mavp + " and a.loaibn=" + m_loaibn);
            if (ds.Tables[0].Rows.Count > 0) return decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            else return 0;
        }

        public decimal get_id_vienphi(decimal m_maql, string m_ngay, int m_loaibn)
        {
            if (!bMmyy(mmyy(m_ngay))) return 0;
            ds = get_data("select a.id from " + user + mmyy(m_ngay) + ".v_vienphill a," + user + mmyy(m_ngay) + ".v_vienphict b where a.id=b.id and a.maql=" + m_maql + " and to_char(a.ngay,'dd/mm/yyyy')='" + m_ngay.Substring(0, 10) + "' and a.loaibn=" + m_loaibn);
            if (ds.Tables[0].Rows.Count > 0) return decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            else return 0;
        }

        public int get_sobienlai(decimal m_id, int m_cong)
        {
            ds = get_data("select soghi from " + user + ".v_quyenso where id=" + m_id);
            if (ds.Tables[0].Rows.Count == 0) return 0;
            else return int.Parse(ds.Tables[0].Rows[0][0].ToString()) + m_cong;
        }

        public void upd_sobienlai(decimal m_id, int m_sobienlai)
        {
            execute_data("update " + user + ".v_quyenso set soghi=" + m_sobienlai + " where id=" + m_id);
        }

        public bool kiemtra_bienlai(decimal m_id, int m_sobienlai)
        {
            ds = get_data("select * from " + user + ".v_quyenso where id=" + m_id + " and " + m_sobienlai + " between tu and den");
            return ds.Tables[0].Rows.Count > 0;
        }

        public void updrec(DataTable dt, decimal id, string sobienlai)
        {
            string exp = "id=" + id;
            DataRow[] dr = dt.Select(exp);
            if (dr.Length > 0) dr[0]["soghi"] = sobienlai;
        }

        public string get_tenvp(int m_id)
        {
            ds = get_data("select ten from " + user + ".v_giavp where id=" + m_id);
            if (ds.Tables[0].Rows.Count > 0) return ds.Tables[0].Rows[0][0].ToString().Trim();
            else return "";
        }
        /// <summary>
        /// Lay tu sequence, reset theo ngay moi
        /// </summary>
        /// <param name="m_makp"></param>
        /// <returns></returns>
        public long get_sokham(string m_makp)
        {
            try
            {
                Random ran = new Random();
                System.Threading.Thread.Sleep(ran.Next(1000));
                string s_sql = "select nextval('medibv.seq_pk_" + m_makp + "') as stt";
                ds = get_data(s_sql);
                if (ds.Tables[0].Rows.Count == 0) return 1;
                else
                {
                    try
                    {
                        return long.Parse(ds.Tables[0].Rows[0][0].ToString());
                    }
                    catch { return 1; }
                }
            }
            catch { return 1; }
        }

        public decimal get_sokham(string m_ngay, string m_makp, int m_sokham)
        {
            try
            {
                if (!bMmyy(mmyy(m_ngay))) return 0;
                sql = "select max(to_number(sovaovien)) from " + user + mmyy(m_ngay) + ".tiepdon where to_char(ngay,'dd/mm/yyyy')='" + m_ngay.Substring(0, 10) + "'";
                if (m_sokham == 2) sql += " and makp='" + m_makp + "'";
                sql += " and noitiepdon in (0,1,5,16) and sovaovien<>''";
                ds = get_data(sql);
                if (ds.Tables[0].Rows.Count == 0) return 1;
                else
                {
                    try
                    {
                        return decimal.Parse(ds.Tables[0].Rows[0][0].ToString()) + 1;
                    }
                    catch { return 1; }
                }
            }
            catch { return 1; }
        }

        public decimal get_sokham_hen(string m_ngay, string m_makp, int m_sokham)
        {
            try
            {
                sql = "select max(to_number(sovaovien)) from " + user + ".tiepdon where to_char(ngay,'dd/mm/yyyy')='" + m_ngay.Substring(0, 10) + "'";
                if (m_sokham == 2) sql += " and makp='" + m_makp + "'";
                sql += " and noitiepdon in (0,1,5,16) and sovaovien<>''";
                ds = get_data(sql);
                if (ds.Tables[0].Rows.Count == 0) return 1;
                else
                {
                    try
                    {
                        return decimal.Parse(ds.Tables[0].Rows[0][0].ToString()) + 1;
                    }
                    catch { return 1; }
                }
            }
            catch { return 1; }
        }

        public void updrec_chidinh(DataTable dt, decimal id, string ngay, string makp, string tenkp, int madoituong, string doituong,
            int mavp, string ten, string dvt, decimal soluong, decimal dongia, decimal vattu, int paid, int done, int tinhtrang,
            int thuchien, string ma)
        {
            string exp = "id=" + id;
            DataRow r = getrowbyid(dt, exp);
            if (r == null)
            {
                DataRow nrow = dt.NewRow();
                nrow["id"] = id;
                nrow["ngay"] = ngay;
                nrow["makp"] = makp;
                nrow["tenkp"] = tenkp;
                nrow["madoituong"] = madoituong;
                nrow["doituong"] = doituong;
                nrow["mavp"] = mavp;
                nrow["ten"] = ten;
                nrow["dvt"] = dvt;
                nrow["soluong"] = soluong;
                nrow["dongia"] = dongia;
                nrow["vattu"] = vattu;
                nrow["paid"] = paid;
                nrow["done"] = done;
                nrow["tinhtrang"] = tinhtrang;
                nrow["thuchien"] = thuchien;
                nrow["ma"] = ma;
                dt.Rows.Add(nrow);
            }
            else
            {
                DataRow[] dr = dt.Select(exp);
                dr[0]["ngay"] = ngay;
                dr[0]["makp"] = makp;
                dr[0]["tenkp"] = tenkp;
                dr[0]["madoituong"] = madoituong;
                dr[0]["doituong"] = doituong;
                dr[0]["mavp"] = mavp;
                dr[0]["ten"] = ten;
                dr[0]["dvt"] = dvt;
                dr[0]["soluong"] = soluong;
                dr[0]["dongia"] = dongia;
                dr[0]["vattu"] = vattu;
                dr[0]["paid"] = paid;
                dr[0]["done"] = done;
                dr[0]["tinhtrang"] = tinhtrang;
                dr[0]["thuchien"] = thuchien;
                dr[0]["ma"] = ma;
            }
        }
        public void updrec_chidinh(DataTable dt, decimal id, string ngay, string makp, string tenkp, int madoituong, string doituong,
            int mavp, string ten, string dvt, decimal soluong, decimal dongia, decimal vattu, int paid, int done, int tinhtrang,
            int thuchien, string ma, decimal tylegiam, decimal stgiam, string lydogiam)
        {
            string exp = "id=" + id;
            DataRow r = getrowbyid(dt, exp);
            if (r == null)
            {
                DataRow nrow = dt.NewRow();
                nrow["id"] = id;
                nrow["ngay"] = ngay;
                nrow["makp"] = makp;
                nrow["tenkp"] = tenkp;
                nrow["madoituong"] = madoituong;
                nrow["doituong"] = doituong;
                nrow["mavp"] = mavp;
                nrow["ten"] = ten;
                nrow["dvt"] = dvt;
                nrow["soluong"] = soluong;
                nrow["dongia"] = dongia;
                nrow["vattu"] = vattu;
                nrow["paid"] = paid;
                nrow["done"] = done;
                nrow["tinhtrang"] = tinhtrang;
                nrow["thuchien"] = thuchien;
                nrow["ma"] = ma;
                nrow["tylegiam"] = tylegiam;
                nrow["stgiam"] = stgiam;
                nrow["lydogiam"] = lydogiam;
                dt.Rows.Add(nrow);
            }
            else
            {
                DataRow[] dr = dt.Select(exp);
                dr[0]["ngay"] = ngay;
                dr[0]["makp"] = makp;
                dr[0]["tenkp"] = tenkp;
                dr[0]["madoituong"] = madoituong;
                dr[0]["doituong"] = doituong;
                dr[0]["mavp"] = mavp;
                dr[0]["ten"] = ten;
                dr[0]["dvt"] = dvt;
                dr[0]["soluong"] = soluong;
                dr[0]["dongia"] = dongia;
                dr[0]["vattu"] = vattu;
                dr[0]["paid"] = paid;
                dr[0]["done"] = done;
                dr[0]["tinhtrang"] = tinhtrang;
                dr[0]["thuchien"] = thuchien;
                dr[0]["ma"] = ma;
                dr[0]["tylegiam"] = tylegiam;
                dr[0]["stgiam"] = stgiam;
                dr[0]["lydogiam"] = lydogiam;
            }
        }
        public void updrec_chidinh(DataTable dt, decimal id, string ngay, string makp, string tenkp, int madoituong,
            string doituong, int mavp, string ten, string dvt, decimal soluong, decimal dongia, decimal vattu, int paid,
            int done, int tinhtrang, int thuchien, string ma, string maicd, string chandoan, string mabs, int loaiba, string ghichu, decimal tylegiam, decimal stgiam, string lydogiam)
        {
            string exp = "id=" + id;
            DataRow r = getrowbyid(dt, exp);
            if (r == null)
            {
                DataRow nrow = dt.NewRow();
                nrow["id"] = id;
                nrow["ngay"] = ngay;
                nrow["makp"] = makp;
                nrow["tenkp"] = tenkp;
                nrow["madoituong"] = madoituong;
                nrow["doituong"] = doituong;
                nrow["mavp"] = mavp;
                nrow["ten"] = ten;
                nrow["dvt"] = dvt;
                nrow["soluong"] = soluong;
                nrow["dongia"] = dongia;
                nrow["vattu"] = vattu;
                nrow["paid"] = paid;
                nrow["done"] = done;
                nrow["tinhtrang"] = tinhtrang;
                nrow["thuchien"] = thuchien;
                nrow["ma"] = ma;
                nrow["maicd"] = maicd;
                nrow["chandoan"] = chandoan;
                nrow["mabs"] = mabs;
                nrow["loaiba"] = loaiba;
                nrow["ghichu"] = ghichu;
                nrow["tylegiam"] = tylegiam;
                nrow["stgiam"] = stgiam;
                nrow["lydogiam"] = lydogiam;
                dt.Rows.Add(nrow);
            }
            else
            {
                DataRow[] dr = dt.Select(exp);
                dr[0]["ngay"] = ngay;
                dr[0]["makp"] = makp;
                dr[0]["tenkp"] = tenkp;
                dr[0]["madoituong"] = madoituong;
                dr[0]["doituong"] = doituong;
                dr[0]["mavp"] = mavp;
                dr[0]["ten"] = ten;
                dr[0]["dvt"] = dvt;
                dr[0]["soluong"] = soluong;
                dr[0]["dongia"] = dongia;
                dr[0]["vattu"] = vattu;
                dr[0]["paid"] = paid;
                dr[0]["done"] = done;
                dr[0]["tinhtrang"] = tinhtrang;
                dr[0]["thuchien"] = thuchien;
                dr[0]["ma"] = ma;
                dr[0]["maicd"] = maicd;
                dr[0]["chandoan"] = chandoan;
                dr[0]["mabs"] = mabs;
                dr[0]["loaiba"] = loaiba;
                dr[0]["ghichu"] = ghichu;
                dr[0]["tylegiam"] = tylegiam;
                dr[0]["stgiam"] = stgiam;
                dr[0]["lydogiam"] = lydogiam;
            }
        }

        public void reprec(DataTable dt, string exp, int mavp, string ten, string dvt, decimal dongia, decimal vattu, decimal soluong)
        {
            DataRow row = getrowbyid(dt, exp);
            if (row == null)
            {
                DataRow nrow = dt.NewRow();
                nrow["mavp"] = mavp;
                nrow["ten"] = ten;
                nrow["dvt"] = dvt;
                nrow["dongia"] = dongia;
                nrow["vattu"] = vattu;
                nrow["soluong"] = soluong;
                dt.Rows.Add(nrow);
            }
            else
            {
                delrec(dt, exp);
            }
        }
        public void reprec(DataTable dt, string exp, int mavp, string ten, string dvt, decimal dongia, decimal vattu, decimal soluong, decimal hoichan, decimal giaycamdoan, decimal ctscannercq)
        {
            DataRow row = getrowbyid(dt, exp);
            if (row == null)
            {
                DataRow nrow = dt.NewRow();
                nrow["mavp"] = mavp;
                nrow["ten"] = ten;
                nrow["dvt"] = dvt;
                nrow["dongia"] = dongia;
                nrow["vattu"] = vattu;
                nrow["soluong"] = soluong;
                nrow["hoichan"] = hoichan;
                nrow["giaycamdoan"] = giaycamdoan;
                nrow["ctscannercq"] = ctscannercq;
                dt.Rows.Add(nrow);
            }
            else
            {
                delrec(dt, exp);
            }
        }
        public void updrec_diung(DataTable dt, string mahc, string ten, int mucdo, string tenmucdo)
        {
            string exp = "mahc='" + mahc + "'";
            DataRow r = getrowbyid(dt, exp);
            if (r == null)
            {
                DataRow nrow = dt.NewRow();
                nrow["mahc"] = mahc;
                nrow["ten"] = ten;
                nrow["mucdo"] = mucdo;
                nrow["tenmucdo"] = tenmucdo;
                dt.Rows.Add(nrow);
            }
            else
            {
                DataRow[] dr = dt.Select(exp);
                dr[0]["ten"] = ten;
                dr[0]["mucdo"] = mucdo;
                dr[0]["tenmucdo"] = tenmucdo;
            }
        }

        public void updrec_toathuocll(DataTable dt, decimal id, string ngay, string makp, string mabs, string chandoan, string maicd, string ghichu, decimal songay)
        {
            string exp = "id=" + id;
            DataRow r = getrowbyid(dt, exp);
            if (r == null)
            {
                DataRow nrow = dt.NewRow();
                nrow["id"] = id;
                nrow["ngay"] = ngay;
                nrow["makp"] = makp;
                nrow["mabs"] = mabs;
                nrow["chandoan"] = chandoan;
                nrow["maicd"] = maicd;
                nrow["ghichu"] = ghichu;
                nrow["songay"] = songay;
                dt.Rows.Add(nrow);
            }
            else
            {
                DataRow[] dr = dt.Select(exp);
                dr[0]["ngay"] = ngay;
                dr[0]["makp"] = makp;
                dr[0]["mabs"] = mabs;
                dr[0]["chandoan"] = chandoan;
                dr[0]["maicd"] = maicd;
                dr[0]["ghichu"] = ghichu;
                dr[0]["songay"] = songay;
            }
        }

        public void updrec_toathuocct(DataTable dt, decimal stt, decimal mabd, string ten, string dang, string tenhc, decimal soluong, string cachdung, decimal solan, decimal lan)
        {
            string exp = "stt=" + stt;
            DataRow r = getrowbyid(dt, exp);
            if (r == null)
            {
                DataRow nrow = dt.NewRow();
                nrow["stt"] = stt;
                nrow["mabd"] = mabd;
                nrow["ten"] = ten;
                nrow["dang"] = dang;
                nrow["tenhc"] = tenhc;
                nrow["soluong"] = soluong;
                nrow["cachdung"] = cachdung;
                nrow["solan"] = solan;
                nrow["lan"] = lan;
                dt.Rows.Add(nrow);
            }
            else
            {
                DataRow[] dr = dt.Select(exp);
                dr[0]["mabd"] = mabd;
                dr[0]["ten"] = ten;
                dr[0]["dang"] = dang;
                dr[0]["tenhc"] = tenhc;
                dr[0]["soluong"] = soluong;
                dr[0]["cachdung"] = cachdung;
                dr[0]["solan"] = solan;
                dr[0]["lan"] = lan;
            }
        }

        public void updrec_vpkhoa(DataTable dt, string mabn, string hoten, decimal mavaovien, decimal maql, decimal idkhoa,int no)
        {
            string exp = "idkhoa=" + idkhoa;
            DataRow r = getrowbyid(dt, exp);
            if (r == null)
            {
                DataRow nrow = dt.NewRow();
                nrow["mabn"] = mabn;
                nrow["hoten"] = hoten;
                nrow["mavaovien"] = mavaovien;
                nrow["maql"] = maql;
                nrow["idkhoa"] = idkhoa;
                nrow["no"] = no;
                dt.Rows.Add(nrow);
            }
            else
            {
                DataRow[] dr = dt.Select(exp);
                dr[0]["mabn"] = mabn;
                dr[0]["hoten"] = hoten;
                dr[0]["mavaovien"] = mavaovien;
                dr[0]["maql"] = maql;
                dr[0]["idkhoa"] = idkhoa;
                dr[0]["no"] = no;
            }
        }

        public void updrec_vpkhoa(DataTable dt, string mabn, string hoten, decimal mavaovien, decimal maql, decimal idkhoa)
        {
            string exp = "idkhoa=" + idkhoa;
            DataRow r = getrowbyid(dt, exp);
            if (r == null)
            {
                DataRow nrow = dt.NewRow();
                nrow["mabn"] = mabn;
                nrow["hoten"] = hoten;
                nrow["mavaovien"] = mavaovien;
                nrow["maql"] = maql;
                nrow["idkhoa"] = idkhoa;
                dt.Rows.Add(nrow);
            }
            else
            {
                DataRow[] dr = dt.Select(exp);
                dr[0]["mabn"] = mabn;
                dr[0]["hoten"] = hoten;
                dr[0]["mavaovien"] = mavaovien;
                dr[0]["maql"] = maql;
                dr[0]["idkhoa"] = idkhoa;
            }
        }

        public string get_sothe(decimal m_maql)
        {
            ds = get_data("select sothe from " + user + ".bhyt where maql=" + m_maql);
            if (ds.Tables[0].Rows.Count > 0) return ds.Tables[0].Rows[0]["sothe"].ToString();
            else return "";
        }
        public string get_sothe_thanhtoan(decimal m_maql)
        {
            string s = "";
            ds = get_data("select sothe from " + user + ".bhyt where maql=" + m_maql);
            foreach (DataRow r in ds.Tables[0].Rows)
                s += r["sothe"].ToString() + ";";
            return s;
        }
        public string get_sothe_sudung(decimal m_maql)
        {
            ds = get_data("select sothe from " + user + ".bhyt where maql=" + m_maql + " and (sudung is null or sudung=1)");
            if (ds.Tables[0].Rows.Count > 0) return ds.Tables[0].Rows[0]["sothe"].ToString();
            else return "";
        }
        public string get_denngay(decimal m_maql)
        {
            ds = get_data("select to_char(denngay,'dd/mm/yyyy') as denngay from " + user + ".bhyt where maql=" + m_maql);
            if (ds.Tables[0].Rows.Count > 0) return ds.Tables[0].Rows[0]["denngay"].ToString();
            else return "";
        }

        public bool upd_kyravien(int m_id, int m_stt, string m_chucvu, string m_hoten)
        {
            sql = "update " + user + ".kyravien set stt=:m_stt,chucvu=:m_chucvu,hoten=:m_hoten where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                cmd.Parameters.Add("m_chucvu", NpgsqlDbType.Text).Value = m_chucvu;
                cmd.Parameters.Add("m_hoten", NpgsqlDbType.Text).Value = m_hoten;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".kyravien (id,stt,chucvu,hoten) values (:m_id,:m_stt,:m_chucvu,:m_hoten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_chucvu", NpgsqlDbType.Text).Value = m_chucvu;
                    cmd.Parameters.Add("m_hoten", NpgsqlDbType.Text).Value = m_hoten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "kyravien");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_giayravien(decimal m_maql, string m_dieutri, string m_loidan, int m_kyravien, int m_userid)
        {
            sql = "update " + user + ".giayravien set lanin=lanin+1,dieutri=:m_dieutri,loidan=:m_loidan,kyravien=:m_kyravien,userid=:m_userid where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_dieutri", NpgsqlDbType.Text).Value = m_dieutri;
                cmd.Parameters.Add("m_loidan", NpgsqlDbType.Text).Value = m_loidan;
                cmd.Parameters.Add("m_kyravien", NpgsqlDbType.Numeric).Value = m_kyravien;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".giayravien (maql,dieutri,loidan,kyravien,lanin,userid) values (:m_maql,:m_dieutri,:m_loidan,:m_kyravien,1,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_dieutri", NpgsqlDbType.Text).Value = m_dieutri;
                    cmd.Parameters.Add("m_loidan", NpgsqlDbType.Text).Value = m_loidan;
                    cmd.Parameters.Add("m_kyravien", NpgsqlDbType.Numeric).Value = m_kyravien;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "giayravien");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_giayravien(decimal m_maql, string m_dieutri, string m_loidan, int m_kyravien, int m_userid,
            string m_benhly, int m_nhommau, string m_rh, string m_ngaytk, string m_taikham, string m_bskham,
            string m_chandoan, string m_kyrakhoa, string m_ttnguoibenhlucrv)
        {
            sql = "update " + user + ".giayravien set lanin=lanin+1,dieutri=:m_dieutri,loidan=:m_loidan,kyravien=:m_kyravien,";
            sql += "userid=:m_userid,benhly=:m_benhly,nhommau=:m_nhommau,rh=:m_rh,";
            if (m_ngaytk != "") sql += "ngaytk=to_date(:m_ngaytk,'dd/mm/yyyy'),";
            sql += "taikham=:m_taikham,bskham=:m_bskham,chandoan=:m_chandoan,kyrakhoa=:m_kyrakhoa ";
            sql += ", ttnguoibenhlucrv=:m_ttnguoibenhlucrv";
            sql += " where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("m_dieutri", NpgsqlDbType.Text).Value = m_dieutri;
                cmd.Parameters.Add("m_loidan", NpgsqlDbType.Text).Value = m_loidan;
                cmd.Parameters.Add("m_kyravien", NpgsqlDbType.Numeric).Value = m_kyravien;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_benhly", NpgsqlDbType.Text).Value = m_benhly;
                cmd.Parameters.Add("m_nhommau", NpgsqlDbType.Numeric).Value = m_nhommau;
                cmd.Parameters.Add("m_rh", NpgsqlDbType.Text, 50).Value = m_rh;
                if (m_ngaytk != "") cmd.Parameters.Add("m_ngaytk", NpgsqlDbType.Varchar, 10).Value = m_ngaytk;
                cmd.Parameters.Add("m_taikham", NpgsqlDbType.Text, 254).Value = m_taikham;
                cmd.Parameters.Add("m_bskham", NpgsqlDbType.Varchar, 4).Value = m_bskham;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_kyrakhoa", NpgsqlDbType.Varchar, 4).Value = m_kyrakhoa;
                cmd.Parameters.Add("m_ttnguoibenhlucrv", NpgsqlDbType.Text).Value = m_ttnguoibenhlucrv;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".giayravien (maql,dieutri,loidan,kyravien,lanin,userid,benhly,";
                    sql += "nhommau,rh,";
                    if (m_ngaytk != "") sql += "ngaytk,";
                    sql += "taikham,bskham,chandoan,kyrakhoa, ttnguoibenhlucrv) ";
                    sql += "values (" + m_maql + ",'" + m_dieutri + "','" + m_loidan + "'," + m_kyravien + ",1," + m_userid + ",'" + m_benhly + "',";
                    sql += m_nhommau + ",'" + m_rh + "',";
                    if (m_ngaytk != "") sql += "to_date('" + m_ngaytk + "','dd/mm/yyyy'),";
                    sql += "'" + m_taikham + "','" + m_bskham + "','" + m_chandoan + "','" + m_kyrakhoa + "','" + m_ttnguoibenhlucrv + "')";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "giayravien");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public void updrec_pttt_mau(DataTable dt, string ma, string mapt, string ten, string mabs, string makp, string noidung, int mavp, decimal ptv, decimal phu1, decimal phu2, decimal bsgayme, decimal ktvgayme, decimal hoisuc, decimal dungcu, string mapm)
        {
            string exp = "ma='" + ma + "'";
            DataRow r = getrowbyid(dt, exp);
            if (r == null)
            {
                DataRow nrow = dt.NewRow();
                nrow["ma"] = ma;
                nrow["mapt"] = mapt;
                nrow["ten"] = ten;
                nrow["mabs"] = mabs;
                nrow["makp"] = makp;
                nrow["mapm"] = mapm;
                nrow["noidung"] = noidung;
                nrow["mavp"] = mavp;
                nrow["ptv"] = ptv;
                nrow["phu1"] = phu1;
                nrow["phu2"] = phu2;
                nrow["bsgayme"] = bsgayme;
                nrow["ktvgayme"] = ktvgayme;
                nrow["hoisuc"] = hoisuc;
                nrow["dungcu"] = dungcu;
                dt.Rows.Add(nrow);
            }
            else
            {
                DataRow[] dr = dt.Select(exp);
                dr[0]["ma"] = ma;
                dr[0]["mapt"] = mapt;
                dr[0]["ten"] = ten;
                dr[0]["mabs"] = mabs;
                dr[0]["makp"] = makp;
                dr[0]["mapm"] = mapm;
                dr[0]["noidung"] = noidung;
                dr[0]["mavp"] = mavp;
                dr[0]["ptv"] = ptv;
                dr[0]["phu1"] = phu1;
                dr[0]["phu2"] = phu2;
                dr[0]["bsgayme"] = bsgayme;
                dr[0]["ktvgayme"] = ktvgayme;
                dr[0]["hoisuc"] = hoisuc;
                dr[0]["dungcu"] = dungcu;
            }
        }



        public void updrec_ravien(DataSet ds, string matt, string mabn, decimal maql, decimal idkhoa, string hoten, string namsinh, string phai, string diachi, int madoituong, string doituong, string sothe, decimal maphu,
            string denngay, string noigioithieu, string noicap, string giuong, string makp, string tenkp, string ngayvao, string ngayra, string chandoan, string maicd, int sttnhom, string nhom,
            int sttloai, string loai, int ma, string ten, string dvt, decimal soluong, decimal sotien, decimal bhyt, decimal tamung, decimal bhytt0107, string nguoinha, int hinhthuc, int phuongphap, int ketqua,
            string soluutru, decimal dongia, bool bChitiet, int done, string mabs, string tenbs, string makprv, string cholam, int madoituongvao, decimal gianovat, decimal idttrv, decimal sotientra, int traituyen, int kythuat, int sttbhyt, int idnhombhyt, string tennhombhyt)
        {
            string exp = "matt='" + matt + "' and mabn='" + mabn + "' and madoituong=" + madoituong + " and ma=" + ma + " and dongia=" + Math.Round(dongia, 2);
            if (bChitiet) exp += " and makp='" + makp + "'";
            exp += " and sothe='" + sothe + "'";
            if (bInmau38_daydu && sttbhyt == 0) exp += " and sttnhom=" + sttnhom;
            else if (bInmau38_daydu && sttbhyt > 0) exp += " and sttbhyt=" + sttbhyt;
            DataRow r = getrowbyid(ds.Tables[0], exp);
            if (r == null)
            {
                DataRow r1 = ds.Tables[0].NewRow();
                r1["matt"] = matt;
                r1["mabn"] = mabn;
                r1["maql"] = maql;
                r1["idkhoa"] = idkhoa;
                r1["hoten"] = hoten;
                r1["namsinh"] = namsinh;
                r1["phai"] = phai;
                r1["diachi"] = diachi;
                r1["madoituong"] = madoituong;
                r1["doituong"] = doituong;
                r1["sothe"] = sothe;
                r1["maphu"] = maphu;
                r1["denngay"] = denngay;
                r1["noigioithieu"] = noigioithieu;
                r1["noicap"] = noicap;
                r1["giuong"] = giuong;
                r1["makp"] = makp;
                r1["tenkp"] = tenkp;
                r1["ngayvao"] = ngayvao;
                r1["ngayra"] = ngayra;
                r1["chandoan"] = chandoan;
                r1["maicd"] = maicd;
                r1["sttnhom"] = sttnhom;
                r1["nhom"] = nhom;
                r1["sttloai"] = sttloai;
                r1["loai"] = loai;
                r1["ma"] = ma;
                r1["ten"] = ten;
                r1["dvt"] = dvt;
                r1["soluong"] = soluong;
                //r1["dongia"] = Math.Round(dongia, 2);//dongia;//gam comment 19/03/2012 -> in mẫu 38
                //r1["sotien"] = Math.Round(sotien, 2);
                //r1["bhyt"] = Math.Round(bhyt, 2);
                r1["dongia"] = dongia;
                r1["sotien"] = sotien;
                r1["bhyt"] = bhyt;
                r1["bhytt0107"] = bhytt0107;
                r1["tamung"] = tamung;
                r1["tcsotien"] = 0;
                r1["dichso"] = "";
                r1["bhyttra"] = 0;
                r1["mien"] = 0;
                r1["bntra"] = 0;
                r1["dichsotra"] = "";
                r1["nguoinha"] = nguoinha;
                r1["hinhthuc"] = hinhthuc;
                r1["phuongphap"] = phuongphap;
                r1["ketqua"] = ketqua;
                r1["soluutru"] = soluutru;
                r1["done"] = done;
                r1["mabs"] = mabs;
                r1["tenbs"] = tenbs;
                r1["makprv"] = makprv;
                r1["cholam"] = cholam;
                r1["madoituongvao"] = madoituongvao;
                r1["gianovat"] = gianovat;
                r1["idttrv"] = idttrv;
                r1["sotientra"] = sotientra;
                r1["traituyen"] = traituyen;
                r1["kythuat"] = kythuat;
                r1["loaikythuat"] = (kythuat == 0) ? "Kỹ thuật cao" : (kythuat == 1) ? "Chăm sóc thai sản" : (kythuat == 2) ? "Thuốc điều trị K" : "";
                //binh 070711
                r1["sttbhyt"] = sttbhyt;
                r1["idnhombhyt"] = idnhombhyt;
                r1["tennhombhyt"] = tennhombhyt;
                //
                ds.Tables[0].Rows.Add(r1);
            }
            else
            {
                DataRow[] dr = ds.Tables[0].Select(exp);
                if (dr.Length > 0)
                {
                    dr[0]["soluong"] = decimal.Parse(dr[0]["soluong"].ToString()) + soluong;
                    //dr[0]["sotien"] = decimal.Parse(dr[0]["sotien"].ToString()) + Math.Round(sotien, 2);
                    //dr[0]["sotientra"] = decimal.Parse(dr[0]["sotientra"].ToString()) + Math.Round(sotientra, 2);
                    //dr[0]["bhyt"] = decimal.Parse(dr[0]["bhyt"].ToString()) + Math.Round(bhyt, 2);
                    dr[0]["sotien"] = decimal.Parse(dr[0]["sotien"].ToString()) + sotien;
                    dr[0]["sotientra"] = decimal.Parse(dr[0]["sotientra"].ToString()) + sotientra;
                    dr[0]["bhyt"] = decimal.Parse(dr[0]["bhyt"].ToString()) + bhyt;
                    dr[0]["bhytt0107"] = decimal.Parse(dr[0]["bhytt0107"].ToString()) + bhytt0107;
                }
            }
        }

        public void updrec_ravien(DataSet ds, string matt, string mabn, decimal maql, decimal idkhoa, string hoten, string namsinh, string phai, string diachi, int madoituong, string doituong, string sothe, decimal maphu,
           string denngay, string noigioithieu, string noicap, string giuong, string makp, string tenkp, string ngayvao, string ngayra, string chandoan, string maicd, int sttnhom, string nhom,
           int sttloai, string loai, int ma, string ten, string dvt, decimal soluong, decimal sotien, decimal bhyt, decimal tamung, decimal bhytt0107, string nguoinha, int hinhthuc, int phuongphap, int ketqua,
           string soluutru, decimal dongia, bool bChitiet, int done, string mabs, string tenbs, string makprv, string cholam, int madoituongvao, decimal gianovat, decimal idttrv, decimal sotientra, int traituyen, int kythuat, string mabsct)
        {
            string exp = "matt='" + matt + "' and mabn='" + mabn + "' and madoituong=" + madoituong + " and ma=" + ma + " and dongia=" + Math.Round(dongia, 2);
            if (bChitiet) exp += " and makp='" + makp + "'";
            exp += " and sothe='" + sothe + "'";
            if (bInmau38_daydu) exp += " and sttnhom=" + sttnhom;
            DataRow r = getrowbyid(ds.Tables[0], exp);
            if (r == null)
            {
                DataRow r1 = ds.Tables[0].NewRow();
                r1["matt"] = matt;
                r1["mabn"] = mabn;
                r1["maql"] = maql;
                r1["idkhoa"] = idkhoa;
                r1["hoten"] = hoten;
                r1["namsinh"] = namsinh;
                r1["phai"] = phai;
                r1["diachi"] = diachi;
                r1["madoituong"] = madoituong;
                r1["doituong"] = doituong;
                r1["sothe"] = sothe;
                r1["maphu"] = maphu;
                r1["denngay"] = denngay;
                r1["noigioithieu"] = noigioithieu;
                r1["noicap"] = noicap;
                r1["giuong"] = giuong;
                r1["makp"] = makp;
                r1["tenkp"] = tenkp;
                r1["ngayvao"] = ngayvao;
                r1["ngayra"] = ngayra;
                r1["chandoan"] = chandoan;
                r1["maicd"] = maicd;
                r1["sttnhom"] = sttnhom;
                r1["nhom"] = nhom;
                r1["sttloai"] = sttloai;
                r1["loai"] = loai;
                r1["ma"] = ma;
                r1["ten"] = ten;
                r1["dvt"] = dvt;
                r1["soluong"] = soluong;
                r1["dongia"] = Math.Round(dongia, 2);//dongia;
                r1["sotien"] = Math.Round(sotien, 2);
                r1["bhyt"] = Math.Round(bhyt, 2);
                r1["bhytt0107"] = bhytt0107;
                r1["tamung"] = tamung;
                r1["tcsotien"] = 0;
                r1["dichso"] = "";
                r1["bhyttra"] = 0;
                r1["mien"] = 0;
                r1["bntra"] = 0;
                r1["dichsotra"] = "";
                r1["nguoinha"] = nguoinha;
                r1["hinhthuc"] = hinhthuc;
                r1["phuongphap"] = phuongphap;
                r1["ketqua"] = ketqua;
                r1["soluutru"] = soluutru;
                r1["done"] = done;
                r1["mabs"] = mabs;
                r1["tenbs"] = tenbs;
                r1["makprv"] = makprv;
                r1["cholam"] = cholam;
                r1["madoituongvao"] = madoituongvao;
                r1["gianovat"] = gianovat;
                r1["idttrv"] = idttrv;
                r1["sotientra"] = sotientra;
                r1["traituyen"] = traituyen;
                r1["kythuat"] = kythuat;
                r1["loaikythuat"] = (kythuat == 0) ? "Kỹ thuật cao" : (kythuat == 1) ? "Chăm sóc thai sản" : (kythuat == 2) ? "Thuốc điều trị K" : "";
                r1["mabs"] = mabsct;//Thuy 09.03.2012

                ds.Tables[0].Rows.Add(r1);
            }
            else
            {
                DataRow[] dr = ds.Tables[0].Select(exp);
                if (dr.Length > 0)
                {
                    dr[0]["soluong"] = decimal.Parse(dr[0]["soluong"].ToString()) + soluong;
                    dr[0]["sotien"] = decimal.Parse(dr[0]["sotien"].ToString()) + Math.Round(sotien, 2);
                    dr[0]["sotientra"] = decimal.Parse(dr[0]["sotientra"].ToString()) + Math.Round(sotientra, 2);
                    dr[0]["bhyt"] = decimal.Parse(dr[0]["bhyt"].ToString()) + Math.Round(bhyt, 2);
                    dr[0]["bhytt0107"] = decimal.Parse(dr[0]["bhytt0107"].ToString()) + bhytt0107;
                }
            }
        }
        public void updrec_ravien(DataSet ds, string matt, string mabn, decimal maql, decimal idkhoa, string hoten, string namsinh, string phai, string diachi, int madoituong, string doituong, string sothe, decimal maphu,
          string denngay, string noigioithieu, string noicap, string giuong, string makp, string tenkp, string ngayvao, string ngayra, string chandoan, string maicd, int sttnhom, string nhom,
          int sttloai, string loai, int ma, string ten, string dvt, decimal soluong, decimal sotien, decimal bhyt, decimal tamung, decimal bhytt0107, string nguoinha, int hinhthuc, int phuongphap, int ketqua,
          string soluutru, decimal dongia, bool bChitiet, int done, string mabs, string tenbs, string makprv, string cholam, int madoituongvao, decimal gianovat, decimal idttrv, decimal sotientra, int traituyen, int kythuat, string mabsct, decimal id_ktcao, decimal vuottran, decimal dinhmucKTcao, decimal id_vpkhoa, decimal tLchitraktcao)
        {
            string exp = "matt='" + matt + "' and mabn='" + mabn + "' and madoituong=" + madoituong + " and ma=" + ma + " and dongia=" + Math.Round(dongia, 2);
            if (bChitiet) exp += " and makp='" + makp + "'";
            exp += " and sothe='" + sothe + "' and id_ktcao="+id_ktcao;
            if (bInmau38_daydu) exp += " and sttnhom=" + sttnhom;
            DataRow r = getrowbyid(ds.Tables[0], exp);
            if (r == null)
            {
                DataRow r1 = ds.Tables[0].NewRow();
                r1["matt"] = matt;
                r1["mabn"] = mabn;
                r1["maql"] = maql;
                r1["idkhoa"] = idkhoa;
                r1["hoten"] = hoten;
                r1["namsinh"] = namsinh;
                r1["phai"] = phai;
                r1["diachi"] = diachi;
                r1["madoituong"] = madoituong;
                r1["doituong"] = doituong;
                r1["sothe"] = sothe;
                r1["maphu"] = maphu;
                r1["denngay"] = denngay;
                r1["noigioithieu"] = noigioithieu;
                r1["noicap"] = noicap;
                r1["giuong"] = giuong;
                r1["makp"] = makp;
                r1["tenkp"] = tenkp;
                r1["ngayvao"] = ngayvao;
                r1["ngayra"] = ngayra;
                r1["chandoan"] = chandoan;
                r1["maicd"] = maicd;
                r1["sttnhom"] = sttnhom;
                r1["nhom"] = nhom;
                r1["sttloai"] = sttloai;
                r1["loai"] = loai;
                r1["ma"] = ma;
                r1["ten"] = ten;
                r1["dvt"] = dvt;
                r1["soluong"] = soluong;
                r1["dongia"] = Math.Round(dongia, 2);//dongia;
                r1["sotien"] = Math.Round(sotien, 2);
                r1["bhyt"] = Math.Round(bhyt, 2);
                r1["bhytt0107"] = bhytt0107;
                r1["tamung"] = tamung;
                r1["tcsotien"] = 0;
                r1["dichso"] = "";
                r1["bhyttra"] = 0;
                r1["mien"] = 0;
                r1["bntra"] = 0;
                r1["dichsotra"] = "";
                r1["nguoinha"] = nguoinha;
                r1["hinhthuc"] = hinhthuc;
                r1["phuongphap"] = phuongphap;
                r1["ketqua"] = ketqua;
                r1["soluutru"] = soluutru;
                r1["done"] = done;
                r1["mabs"] = mabs;
                r1["tenbs"] = tenbs;
                r1["makprv"] = makprv;
                r1["cholam"] = cholam;
                r1["madoituongvao"] = madoituongvao;
                r1["gianovat"] = gianovat;
                r1["idttrv"] = idttrv;
                r1["sotientra"] = sotientra;
                r1["traituyen"] = traituyen;
                r1["kythuat"] = kythuat;
                r1["loaikythuat"] = (kythuat == 0) ? "Kỹ thuật cao" : (kythuat == 1) ? "Chăm sóc thai sản" : (kythuat == 2) ? "Thuốc điều trị K" : "";
                r1["mabs"] = mabsct;//Thuy 09.03.2012
                try
                {
                    r1["id_ktcao"] = id_ktcao;
                }
                catch { }
                try
                {
                    r1["vuottran"] = vuottran;
                }
                catch { }
                try
                {
                    r1["dinhmucKTcao"] = dinhmucKTcao;
                }
                catch { }
                try
                {
                    r1["id_vpkhoa"] = id_vpkhoa;
                }
                catch { }
                try
                {
                    r1["tLchitraktcao"] = tLchitraktcao;
                }
                catch { }

                ds.Tables[0].Rows.Add(r1);
            }
            else
            {
                DataRow[] dr = ds.Tables[0].Select(exp);
                if (dr.Length > 0)
                {
                    dr[0]["soluong"] = decimal.Parse(dr[0]["soluong"].ToString()) + soluong;
                    dr[0]["sotien"] = decimal.Parse(dr[0]["sotien"].ToString()) + Math.Round(sotien, 2);
                    dr[0]["sotientra"] = decimal.Parse(dr[0]["sotientra"].ToString()) + Math.Round(sotientra, 2);
                    dr[0]["bhyt"] = decimal.Parse(dr[0]["bhyt"].ToString()) + Math.Round(bhyt, 2);
                    dr[0]["bhytt0107"] = decimal.Parse(dr[0]["bhytt0107"].ToString()) + bhytt0107;
                }
            }
        }

        public void updrec_ravien(DataSet ds, string mabn, decimal mavaovien, decimal maql, decimal idkhoa, string hoten, string namsinh,
            string phai, string diachi, int madoituong, string doituong, string sothe, string denngay, string noigioithieu,
            string noicap, string giuong, string makp, string tenkp, string ngayvao, string ngayra, string chandoan, string maicd,
            string nguoinha, int hinhthuc, int phuongphap, int ketqua, string soluutru, string tenbs, string mabs, string cholam,
            int traituyen)
        {
            DataRow r1 = ds.Tables[0].NewRow();
            r1["mabn"] = mabn;
            r1["mavaovien"] = mavaovien;
            r1["maql"] = maql;
            r1["idkhoa"] = idkhoa;
            r1["hoten"] = hoten;
            r1["namsinh"] = namsinh;
            r1["phai"] = phai;
            r1["diachi"] = diachi;
            r1["madoituong"] = madoituong;
            r1["doituong"] = doituong;
            r1["sothe"] = sothe;
            r1["denngay"] = denngay;
            r1["noigioithieu"] = noigioithieu;
            r1["noicap"] = noicap;
            r1["giuong"] = giuong;
            r1["makp"] = makp;
            r1["tenkp"] = tenkp;
            r1["ngayvao"] = ngayvao;
            r1["ngayra"] = ngayra;
            r1["chandoan"] = chandoan;
            r1["maicd"] = maicd;
            r1["nguoinha"] = nguoinha;
            r1["hinhthuc"] = hinhthuc;
            r1["phuongphap"] = phuongphap;
            r1["ketqua"] = ketqua;
            r1["soluutru"] = soluutru;
            r1["tenbs"] = tenbs;
            r1["mabs"] = mabs;
            try
            {
                r1["cholam"] = cholam;
                r1["traituyen"] = traituyen;
            }
            catch { }
            ds.Tables[0].Rows.Add(r1);
        }

        public string get_noicap(decimal maql)
        {
            ds = get_data("select b.tenbv from " + user + ".bhyt a," + user + ".dmnoicapbhyt b where a.mabv=b.mabv and a.maql=" + maql);
            if (ds.Tables[0].Rows.Count > 0) return ds.Tables[0].Rows[0]["tenbv"].ToString();
            else return "";
        }

        public string get_noigioithieu(decimal maql)
        {
            ds = get_data("select b.tenbv from " + user + ".noigioithieu a," + user + ".dstt b where a.mabv=b.mabv and a.maql=" + maql);
            if (ds.Tables[0].Rows.Count > 0) return ds.Tables[0].Rows[0]["tenbv"].ToString();
            else return "";
        }

        public string get_noigioithieu(string ngay, decimal maql)
        {
            ds = get_data("select b.tenbv from " + user + mmyy(ngay) + ".noigioithieu a," + user + ".dstt b where a.mabv=b.mabv and a.maql=" + maql);
            if (ds.Tables[0].Rows.Count > 0) return ds.Tables[0].Rows[0]["tenbv"].ToString();
            else return "";
        }

        public string get_manoicap(string ngay, decimal maql)
        {
            string xxx = user + ((ngay != "") ? mmyy(ngay) : "");
            ds = get_data("select mabv from " + xxx + ".bhyt where maql=" + maql);
            if (ds.Tables[0].Rows.Count > 0) return ds.Tables[0].Rows[0]["mabv"].ToString();
            else return "";
        }

        public string get_manoicap(string ngay, decimal maql, string m_sothe)
        {
            string xxx = user + ((ngay != "") ? mmyy(ngay) : "");
            ds = get_data("select mabv from " + xxx + ".bhyt where maql=" + maql + " and sothe='" + m_sothe + "'");
            if (ds.Tables[0].Rows.Count > 0) return ds.Tables[0].Rows[0]["mabv"].ToString();
            else return "";
        }
        public string get_manoigioithieu(decimal maql)
        {
            ds = get_data("select mabv from " + user + ".noigioithieu where maql=" + maql);
            if (ds.Tables[0].Rows.Count > 0) return ds.Tables[0].Rows[0]["mabv"].ToString();
            else return "";
        }

        public string get_doituong(string mabn, decimal maql, decimal idkhoa, string tu, string den, string makp, DataTable dtkp, int done, bool bVienphi_phongluu, int loaiba, decimal mavaovien)
        {
            d = new LibDuoc.AccessData();
            string ret = "", xxx, usr = user, _ngay = f_ngay;
            int i_makp = 0, be = 0;
            DataRow r1;
            DateTime dt1 = d.StringToDate(tu).AddDays(-d.iNgaykiemke);
            DateTime dt2 = d.StringToDate(den).AddDays(d.iNgaykiemke);
            int y1 = dt1.Year, m1 = dt1.Month;
            int y2 = dt2.Year, m2 = dt2.Month;
            int itu, iden;
            string mmyy = "";
            bool bndot = bThanhtoan_ndot || loaiba == 2;
            bool bCapve = bCapve_noitru, bNgtr = bBHYTngtr_noitru, bdieutri_donthuoc = bDieutri_donthuoc;
            DataSet dsdt = new DataSet();
            decimal maql_phongluu = (bVienphi_phongluu) ? get_maql_phongluu(tu, maql) : 0;
            decimal maql_phongkham = (bChidinh_vienphi)? get_maql_benhanpk(mabn,tu) : 0;
            for (int i = y1; i <= y2; i++)
            {
                itu = (i == y1) ? m1 : 1;
                iden = (i == y2) ? m2 : 12;
                for (int j = itu; j <= iden; j++)
                {
                    mmyy = j.ToString().PadLeft(2, '0') + i.ToString().Substring(2, 2);
                    if (bMmyy(mmyy))
                    {
                        xxx = usr + mmyy;
                        if (makp != "")
                        {
                            r1 = getrowbyid(dtkp, "makp='" + makp + "'");
                            if (r1 != null) i_makp = int.Parse(r1["id"].ToString());
                        }
                        sql = "select distinct madoituong from " + xxx + ".d_tienthuoc ";
                        sql += " where mabn='" + mabn + "'";
                        if (maql != 0 && loaiba != 2) sql += " and maql=" + maql;
                        if (bndot) sql += " and ngay between to_date('" + tu.Substring(0, 10) + "','" + _ngay + "') and to_date('" + den.Substring(0, 10) + "','" + _ngay + "')";
                        if (i_makp != 0) sql += " and makp=" + i_makp;
                        if (done == 0 || done == 2) sql += " and done=0";
                        else if (done == 1) sql += " and done=" + done;
                        if (be == 0) dsdt = get_data(sql);
                        else dsdt.Merge(get_data(sql));
                        be++;
                        if (maql_phongluu != 0)
                        {
                            sql = "select distinct madoituong from " + xxx + ".d_tienthuoc ";
                            sql += " where mabn='" + mabn + "'";
                            sql += " and maql=" + maql_phongluu;
                            if (done == 0 || done == 2) sql += " and done=0";
                            else if (done == 1) sql += " and done=" + done;
                            dsdt.Merge(get_data(sql));
                        }
                        if (bCapve || loaiba == 2)
                        {
                            sql = "select distinct maphu as madoituong from " + xxx + ".bhytkb ";
                            sql += " where mabn='" + mabn + "'";
                            if (maql != 0 && loaiba != 2) sql += " and maql=" + maql;
                            //sql += " and ngay between to_date('" + tu.Substring(0, 10) + "','" + _ngay + "') and to_date('" + den.Substring(0, 10) + "','" + _ngay + "')";
                            sql += " and to_date(to_char(ngay,'" + _ngay + "'),'" + _ngay + "') between to_date('" + tu.Substring(0, 10) + "','" + _ngay + "') and to_date('" + den.Substring(0, 10) + "','" + _ngay + "')";
                            dsdt.Merge(get_data(sql));
                        }
                        if (bNgtr && loaiba != 2)
                        {
                            sql = "select distinct maphu as madoituong from " + xxx + ".bhytkb ";
                            sql += " where mabn='" + mabn + "'";
                            sql += " and maphu=1";
                            sql += " and ngay between to_date('" + tu.Substring(0, 10) + "','" + _ngay + "') and to_date('" + den.Substring(0, 10) + "','" + _ngay + "')";
                            dsdt.Merge(get_data(sql));
                        }

                        if (bdieutri_donthuoc)
                        {
                            sql = "select distinct a.madoituong";
                            sql += " from " + xxx + ".d_ngtrull k," + xxx + ".d_ngtruct a";
                            sql += " where k.id=a.id and k.mabn='" + mabn + "'";
                            sql += " and k.ngay between to_date('" + tu.Substring(0, 10) + "','" + _ngay + "') and to_date('" + den.Substring(0, 10) + "','" + _ngay + "')";
                            sql += " and k.maql=" + maql;
                            if (done == 0 || done == 2) sql += " and a.paid=0";
                            else if (done == 1) sql += " and a.paid=" + done;
                            dsdt.Merge(get_data(sql));
                        }

                        sql = "select distinct madoituong from " + xxx + ".v_vpkhoa ";
                        sql += " where mabn='" + mabn + "'";
                        if (maql != 0 && loaiba != 2) sql += " and maql=" + maql;
                        if (bndot) sql += " and " + for_ngay("ngay", "'" + _ngay + "'") + " between to_date('" + tu.Substring(0, 10) + "','" + _ngay + "') and to_date('" + den.Substring(0, 10) + "','" + _ngay + "')";
                        if (makp != "") sql += " and makp='" + makp + "'";
                        if (done != 2) sql += " and done=" + done;
                        dsdt.Merge(get_data(sql));
                        if (bChidinh_vienphi)
                        {
                            sql = "select distinct madoituong from " + xxx + ".v_chidinh ";
                            sql += " where mabn='" + mabn + "'";
                            if (done == 0 || done == 2) sql += " and paid=0";
                            else if (done == 1) sql += " and paid=" + done;
                            if (maql != 0 && loaiba != 2 && maql_phongkham != 0) sql += " and maql in(" + maql + "," + maql_phongkham + ")";
                            else if (maql != 0 && loaiba != 2 && maql_phongkham == 0) sql += " and maql=" + maql;
                            if (bndot) sql += " and " + for_ngay("ngay", "'" + _ngay + "'") + " between to_date('" + tu.Substring(0, 10) + "','" + _ngay + "') and to_date('" + den.Substring(0, 10) + "','" + _ngay + "')";
                            if (makp != "") sql += " and makp='" + makp + "'";
                            dsdt.Merge(get_data(sql));
                        }
                        if (maql_phongluu != 0)
                        {
                            sql = "select distinct madoituong from " + xxx + ".v_vpkhoa ";
                            sql += " where mabn='" + mabn + "'";
                            sql += " and maql=" + maql_phongluu;
                            if (done == 0 || done == 2) sql += " and done=0";
                            else if (done == 1) sql += " and done=" + done;
                            dsdt.Merge(get_data(sql));
                            if (bChidinh_vienphi)
                            {
                                sql = "select distinct madoituong from " + xxx + ".v_chidinh ";
                                sql += " where mabn='" + mabn + "'";
                                if (done == 0 || done == 2) sql += " and paid=0";
                                else if (done == 1) sql += " and paid=" + done;
                                sql += " and maql=" + maql_phongluu;
                                dsdt.Merge(get_data(sql));
                            }
                        }
                        if (mavaovien != 0)
                        {
                            sql = "select distinct madoituong from " + xxx + ".v_chidinh ";
                            sql += " where mabn='" + mabn + "'";
                            if (done == 0 || done == 2) sql += " and paid=0";
                            else if (done == 1) sql += " and paid=" + done;
                            sql += " and mavaovien=" + mavaovien + " and maql not in (" + maql + "," + maql_phongluu + ")";
                            sql += " union all ";
                            sql += "select distinct maphu as madoituong from " + xxx + ".bhytkb ";
                            sql += " where mabn='" + mabn + "'";
                            sql += " and mavaovien=" + mavaovien + " and maql not in (" + maql + "," + maql_phongluu + ")";
                            dsdt.Merge(get_data(sql));
                        }
                    }
                }
            }
            if (dsdt.Tables[0].Rows.Count > 0)
            {
                foreach (DataRow r in dsdt.Tables[0].Rows) if (r["madoituong"].ToString().Trim() != "") ret += r["madoituong"].ToString().Trim() + ",";
                if (bChenhlech && ret.IndexOf(iTunguyen.ToString() + ",") == -1) ret += iTunguyen.ToString() + ",";
            }
            if (bThuphi_dichvubhytduoi_100 && ret.IndexOf("2,") == -1) ret += "2,";
            return (bHaophi_thanhtoan) ? ret : ret.Replace(d.iHaophi.ToString() + ",", "");
        }


        public bool upd_ttkhamthai(string m_ngay, string m_mabn, decimal m_maql, string m_para, string m_kinhcc, string m_ngaysanh, string m_dacdiem)
        {
            sql = "update " + user + mmyy(m_ngay) + ".ttkhamthai set para=:m_para";
            if (m_kinhcc != "") sql += ",kinhcc=:m_kinhcc,ngaysanh=:m_ngaysanh";
            sql += ",dacdiem=:m_dacdiem where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_para", NpgsqlDbType.Varchar, 8).Value = m_para;
                if (m_kinhcc != "")
                {
                    cmd.Parameters.Add("m_kinhcc", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_kinhcc);
                    cmd.Parameters.Add("m_ngaysanh", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngaysanh);
                }
                cmd.Parameters.Add("m_dacdiem", NpgsqlDbType.Text).Value = m_dacdiem;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    if (m_kinhcc != "")
                    {
                        sql = "insert into " + user + mmyy(m_ngay) + ".ttkhamthai(mabn,maql,para,kinhcc,ngaysanh,dacdiem)";
                        sql += " values (:m_mabn,:m_maql,:m_para,:m_kinhcc,:m_ngaysanh,:m_dacdiem)";
                    }
                    else
                    {
                        sql = "insert into " + user + mmyy(m_ngay) + ".ttkhamthai(mabn,maql,para,dacdiem)";
                        sql += " values (:m_mabn,:m_maql,:m_para,:m_dacdiem)";
                    }
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_para", NpgsqlDbType.Varchar, 8).Value = m_para;
                    if (m_kinhcc != "")
                    {
                        cmd.Parameters.Add("m_kinhcc", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_kinhcc);
                        cmd.Parameters.Add("m_ngaysanh", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngaysanh);
                    }
                    cmd.Parameters.Add("m_dacdiem", NpgsqlDbType.Text).Value = m_dacdiem;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message, sComputer, "ttkhamthai " + m_maql.ToString());
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_ttkhamthai(string m_mabn, decimal m_maql, string m_para, string m_kinhcc, string m_ngaysanh, string m_dacdiem)
        {
            sql = "update " + user + ".ttkhamthai set para=:m_para";
            if (m_kinhcc != "") sql += ",kinhcc=:m_kinhcc,ngaysanh=:m_ngaysanh";
            sql += ",dacdiem=:m_dacdiem where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_para", NpgsqlDbType.Varchar, 8).Value = m_para;
                if (m_kinhcc != "")
                {
                    cmd.Parameters.Add("m_kinhcc", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_kinhcc);
                    cmd.Parameters.Add("m_ngaysanh", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngaysanh);
                }
                cmd.Parameters.Add("m_dacdiem", NpgsqlDbType.Text).Value = m_dacdiem;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    if (m_kinhcc != "")
                    {
                        sql = "insert into " + user + ".ttkhamthai(mabn,maql,para,kinhcc,ngaysanh,dacdiem)";
                        sql += " values (:m_mabn,:m_maql,:m_para,:m_kinhcc,:m_ngaysanh,:m_dacdiem)";
                    }
                    else
                    {
                        sql = "insert into " + user + ".ttkhamthai(mabn,maql,para,dacdiem)";
                        sql += " values (:m_mabn,:m_maql,:m_para,:m_dacdiem)";
                    }
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_para", NpgsqlDbType.Varchar, 8).Value = m_para;
                    if (m_kinhcc != "")
                    {
                        cmd.Parameters.Add("m_kinhcc", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_kinhcc);
                        cmd.Parameters.Add("m_ngaysanh", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngaysanh);
                    }
                    cmd.Parameters.Add("m_dacdiem", NpgsqlDbType.Text).Value = m_dacdiem;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ttkhamthai " + m_maql.ToString());
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_ddsosinh(string m_mabn, decimal m_maql, int m_apgar1, int m_apgar5, int m_apgar10, int m_cannang, int m_cao, int m_vongdau, string m_manv1, string m_manv2, int m_conthu, string m_hoten, int m_duthang, int m_thang, int m_tuan, string m_ditatbs, string m_mass, int m_cachthucde)
        {
            sql = "update " + user + ".ddsosinh set mabn=:m_mabn,apgar1=:m_apgar1,apgar5=:m_apgar5,";
            sql += "apgar10=:m_apgar10,cannang=:m_cannang,";
            sql += "cao=:m_cao,vongdau=:m_vongdau,manv1=:m_manv1,manv2=:m_manv2,";
            sql += "conthu=:m_conthu,hoten=:m_hoten,duthang=:m_duthang,thang=:m_thang,";
            sql += "tuan=:m_tuan,ditatbs=:m_ditatbs,mass=:m_mass,cachthucde=:m_cachthucde where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_apgar1", NpgsqlDbType.Numeric).Value = m_apgar1;
                cmd.Parameters.Add("m_apgar5", NpgsqlDbType.Numeric).Value = m_apgar5;
                cmd.Parameters.Add("m_apgar10", NpgsqlDbType.Numeric).Value = m_apgar10;
                cmd.Parameters.Add("m_cannang", NpgsqlDbType.Numeric).Value = m_cannang;
                cmd.Parameters.Add("m_cao", NpgsqlDbType.Numeric).Value = m_cao;
                cmd.Parameters.Add("m_vongdau", NpgsqlDbType.Numeric).Value = m_vongdau;
                cmd.Parameters.Add("m_manv1", NpgsqlDbType.Varchar, 4).Value = m_manv1;
                cmd.Parameters.Add("m_manv2", NpgsqlDbType.Varchar, 4).Value = m_manv2;
                cmd.Parameters.Add("m_conthu", NpgsqlDbType.Numeric).Value = m_conthu;
                cmd.Parameters.Add("m_hoten", NpgsqlDbType.Text).Value = m_hoten;
                cmd.Parameters.Add("m_duthang", NpgsqlDbType.Numeric).Value = m_duthang;
                cmd.Parameters.Add("m_thang", NpgsqlDbType.Numeric).Value = m_thang;
                cmd.Parameters.Add("m_tuan", NpgsqlDbType.Numeric).Value = m_tuan;
                cmd.Parameters.Add("m_ditatbs", NpgsqlDbType.Varchar, 10).Value = m_ditatbs;
                cmd.Parameters.Add("m_mass", NpgsqlDbType.Varchar).Value = m_mass;
                cmd.Parameters.Add("m_cachthucde", NpgsqlDbType.Numeric).Value = m_cachthucde;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".ddsosinh(mabn,maql,apgar1,apgar5,apgar10,cannang,cao,vongdau,manv1,manv2,conthu,hoten,duthang,thang,tuan,ditatbs,mass,cachthucde) values ";
                    sql += "(:m_mabn,:m_maql,:m_apgar1,:m_apgar5,:m_apgar10,:m_cannang,:m_cao,:m_vongdau,:m_manv1,:m_manv2,:m_conthu,:m_hoten,:m_duthang,:m_thang,:m_tuan,:m_ditatbs,:m_mass,:m_cachthucde)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_apgar1", NpgsqlDbType.Numeric).Value = m_apgar1;
                    cmd.Parameters.Add("m_apgar5", NpgsqlDbType.Numeric).Value = m_apgar5;
                    cmd.Parameters.Add("m_apgar10", NpgsqlDbType.Numeric).Value = m_apgar10;
                    cmd.Parameters.Add("m_cannang", NpgsqlDbType.Numeric).Value = m_cannang;
                    cmd.Parameters.Add("m_cao", NpgsqlDbType.Numeric).Value = m_cao;
                    cmd.Parameters.Add("m_vongdau", NpgsqlDbType.Numeric).Value = m_vongdau;
                    cmd.Parameters.Add("m_manv1", NpgsqlDbType.Varchar, 4).Value = m_manv1;
                    cmd.Parameters.Add("m_manv2", NpgsqlDbType.Varchar, 4).Value = m_manv2;
                    cmd.Parameters.Add("m_conthu", NpgsqlDbType.Numeric).Value = m_conthu;
                    cmd.Parameters.Add("m_hoten", NpgsqlDbType.Text).Value = m_hoten;
                    cmd.Parameters.Add("m_duthang", NpgsqlDbType.Numeric).Value = m_duthang;
                    cmd.Parameters.Add("m_thang", NpgsqlDbType.Numeric).Value = m_thang;
                    cmd.Parameters.Add("m_tuan", NpgsqlDbType.Numeric).Value = m_tuan;
                    cmd.Parameters.Add("m_ditatbs", NpgsqlDbType.Varchar, 10).Value = m_ditatbs;
                    cmd.Parameters.Add("m_mass", NpgsqlDbType.Varchar).Value = m_mass;
                    cmd.Parameters.Add("m_cachthucde", NpgsqlDbType.Numeric).Value = m_cachthucde;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ddsosinh");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_ddsosinh(string m_mabn, decimal m_maql, int m_apgar1, int m_apgar5, int m_apgar10, int m_cannang, int m_cao, int m_vongdau,
          string m_manv1, string m_manv2, int m_conthu, string m_hoten, int m_duthang, int m_thang, int m_tuan, string m_ditatbs, 
          string m_mass, int m_cachthucde,int m_sochungsinh,string m_quyensochungsinh,int m_lansinh,int m_soconsong,string m_suckhoe,int m_socon)
        {
            sql = "update " + user + ".ddsosinh set mabn=:m_mabn,apgar1=:m_apgar1,apgar5=:m_apgar5,";
            sql += "apgar10=:m_apgar10,cannang=:m_cannang,";
            sql += "cao=:m_cao,vongdau=:m_vongdau,manv1=:m_manv1,manv2=:m_manv2,";
            sql += "conthu=:m_conthu,hoten=:m_hoten,duthang=:m_duthang,thang=:m_thang,";
            sql += "tuan=:m_tuan,ditatbs=:m_ditatbs,mass=:m_mass,cachthucde=:m_cachthucde,"+
                " sochungsinh=:m_sochungsinh,quyensochungsinh=:m_quyensochungsinh,lansinh=:m_lansinh,soconsong=:m_soconsong,suckhoe=:m_suckhoe,socon=:m_socon where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_apgar1", NpgsqlDbType.Numeric).Value = m_apgar1;
                cmd.Parameters.Add("m_apgar5", NpgsqlDbType.Numeric).Value = m_apgar5;
                cmd.Parameters.Add("m_apgar10", NpgsqlDbType.Numeric).Value = m_apgar10;
                cmd.Parameters.Add("m_cannang", NpgsqlDbType.Numeric).Value = m_cannang;
                cmd.Parameters.Add("m_cao", NpgsqlDbType.Numeric).Value = m_cao;
                cmd.Parameters.Add("m_vongdau", NpgsqlDbType.Numeric).Value = m_vongdau;
                cmd.Parameters.Add("m_manv1", NpgsqlDbType.Varchar, 4).Value = m_manv1;
                cmd.Parameters.Add("m_manv2", NpgsqlDbType.Varchar, 4).Value = m_manv2;
                cmd.Parameters.Add("m_conthu", NpgsqlDbType.Numeric).Value = m_conthu;
                cmd.Parameters.Add("m_hoten", NpgsqlDbType.Text).Value = m_hoten;
                cmd.Parameters.Add("m_duthang", NpgsqlDbType.Numeric).Value = m_duthang;
                cmd.Parameters.Add("m_thang", NpgsqlDbType.Numeric).Value = m_thang;
                cmd.Parameters.Add("m_tuan", NpgsqlDbType.Numeric).Value = m_tuan;
                cmd.Parameters.Add("m_ditatbs", NpgsqlDbType.Varchar, 10).Value = m_ditatbs;
                cmd.Parameters.Add("m_mass", NpgsqlDbType.Varchar).Value = m_mass;
                cmd.Parameters.Add("m_cachthucde", NpgsqlDbType.Numeric).Value = m_cachthucde;
                cmd.Parameters.Add("m_sochungsinh", NpgsqlDbType.Numeric).Value = m_sochungsinh;
                cmd.Parameters.Add("m_quyensochungsinh", NpgsqlDbType.Text, 254).Value = m_quyensochungsinh;
                cmd.Parameters.Add("m_lansinh", NpgsqlDbType.Numeric).Value = m_lansinh;
                cmd.Parameters.Add("m_soconsong", NpgsqlDbType.Numeric).Value = m_soconsong;
                cmd.Parameters.Add("m_suckhoe", NpgsqlDbType.Text, 254).Value = m_suckhoe;
                cmd.Parameters.Add("m_socon", NpgsqlDbType.Numeric).Value = m_socon;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".ddsosinh(mabn,maql,apgar1,apgar5,apgar10,cannang,cao,vongdau,manv1,manv2,conthu,hoten,duthang,thang,tuan,ditatbs,mass,cachthucde,sochungsinh,quyensochungsinh,lansinh,soconsong,suckhoe,socon) values ";
                    sql += "(:m_mabn,:m_maql,:m_apgar1,:m_apgar5,:m_apgar10,:m_cannang,:m_cao,:m_vongdau,:m_manv1,:m_manv2,:m_conthu,:m_hoten,:m_duthang,:m_thang,:m_tuan,:m_ditatbs,:m_mass,:m_cachthucde,:m_sochungsinh,:m_quyensochungsinh,:m_lansinh,:m_soconsong,:m_suckhoe,:m_socon)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_apgar1", NpgsqlDbType.Numeric).Value = m_apgar1;
                    cmd.Parameters.Add("m_apgar5", NpgsqlDbType.Numeric).Value = m_apgar5;
                    cmd.Parameters.Add("m_apgar10", NpgsqlDbType.Numeric).Value = m_apgar10;
                    cmd.Parameters.Add("m_cannang", NpgsqlDbType.Numeric).Value = m_cannang;
                    cmd.Parameters.Add("m_cao", NpgsqlDbType.Numeric).Value = m_cao;
                    cmd.Parameters.Add("m_vongdau", NpgsqlDbType.Numeric).Value = m_vongdau;
                    cmd.Parameters.Add("m_manv1", NpgsqlDbType.Varchar, 4).Value = m_manv1;
                    cmd.Parameters.Add("m_manv2", NpgsqlDbType.Varchar, 4).Value = m_manv2;
                    cmd.Parameters.Add("m_conthu", NpgsqlDbType.Numeric).Value = m_conthu;
                    cmd.Parameters.Add("m_hoten", NpgsqlDbType.Text).Value = m_hoten;
                    cmd.Parameters.Add("m_duthang", NpgsqlDbType.Numeric).Value = m_duthang;
                    cmd.Parameters.Add("m_thang", NpgsqlDbType.Numeric).Value = m_thang;
                    cmd.Parameters.Add("m_tuan", NpgsqlDbType.Numeric).Value = m_tuan;
                    cmd.Parameters.Add("m_ditatbs", NpgsqlDbType.Varchar, 10).Value = m_ditatbs;
                    cmd.Parameters.Add("m_mass", NpgsqlDbType.Varchar).Value = m_mass;
                    cmd.Parameters.Add("m_cachthucde", NpgsqlDbType.Numeric).Value = m_cachthucde;
                    cmd.Parameters.Add("m_sochungsinh", NpgsqlDbType.Numeric).Value = m_sochungsinh;
                    cmd.Parameters.Add("m_quyensochungsinh", NpgsqlDbType.Text, 254).Value = m_quyensochungsinh;
                    cmd.Parameters.Add("m_lansinh", NpgsqlDbType.Numeric).Value = m_lansinh;
                    cmd.Parameters.Add("m_soconsong", NpgsqlDbType.Numeric).Value = m_soconsong;
                    cmd.Parameters.Add("m_suckhoe", NpgsqlDbType.Text, 254).Value = m_suckhoe;
                    cmd.Parameters.Add("m_socon", NpgsqlDbType.Numeric).Value = m_socon;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ddsosinh");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_dmnoitiepdon(int m_id, string m_ten, int m_chophep)
        {
            sql = "update " + user + ".dmnoitiepdon set ten=:m_ten,chophep=:m_chophep where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_chophep", NpgsqlDbType.Numeric).Value = m_chophep;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dmnoitiepdon(id,ten,chophep) values ";
                    sql += "(:m_id,:m_ten,:m_chophep)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    cmd.Parameters.Add("m_chophep", NpgsqlDbType.Numeric).Value = m_chophep;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dmnoitiepdon");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool bTiepdon(int id)
        {
            return get_data("select * from " + user + ".dmnoitiepdon where id=" + id + " and chophep=1").Tables[0].Rows.Count > 0;
        }

        public bool upd_btdpmo(string m_ma, string m_ten, string m_makp)
        {
            sql = "update " + user + ".btdpmo set ten=:m_ten,makp=:m_makp where ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, 255).Value = m_makp;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 2).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".btdpmo (ma,ten,makp) values (:m_ma,:m_ten,:m_makp)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 2).Value = m_ma;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, 255).Value = m_makp;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "btdpmo");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public string sothe(int madoituong)
        {
            ds = get_data("select sothe,ngay,mabv,mien from " + user + ".doituong where madoituong=" + madoituong);
            if (ds.Tables[0].Rows.Count > 0) return ds.Tables[0].Rows[0]["sothe"].ToString().Trim().PadLeft(2, '0') + ds.Tables[0].Rows[0]["ngay"].ToString().Trim() + ds.Tables[0].Rows[0]["mabv"].ToString().Trim() + ds.Tables[0].Rows[0]["mien"].ToString().Trim();
            else return "00000";
        }

        public bool sothe(int madoituong, string sothe)
        {
            int i = 0; bool ret = false;
            string s1 = "", s2 = "", s3 = "'", dau = ",+;.", so = "0123456789";
            ds = get_data("select dai from " + user + ".doituong where madoituong=" + madoituong);
            if (ds.Tables[0].Rows.Count > 0) s1 = ds.Tables[0].Rows[0]["dai"].ToString().Trim();
            if (s1 != "")
            {
                while (i < s1.Length)
                {
                    if (dau.IndexOf(s1.Substring(i, 1)) != -1)
                    {
                        if (s2 != "") s3 += s2.PadLeft(2, '0') + "','";
                        s2 = "";
                    }
                    else if (so.IndexOf(s1.Substring(i, 1)) != -1) s2 += s1.Substring(i, 1);
                    i++;
                }
                if (s2 != "") s3 += s2.PadLeft(2, '0') + "','";
                s3 = (s3.Length > 1) ? s3.Substring(0, s3.Length - 2) : "";
                ret = s3.IndexOf("'" + sothe.Length.ToString().PadLeft(2, '0') + "'") != -1;
            }
            return ret;
        }

        public decimal get_tiepdon(string mabn, string ngay)
        {
            if (!bMmyy(mmyy(ngay))) return 0;
            ds = get_data("select maql from " + user + mmyy(ngay) + ".tiepdon where mabn='" + mabn + "' and to_char(ngay,'dd/mm/yyyy')='" + ngay.Substring(0, 10) + "' order by noitiepdon desc");
            if (ds.Tables[0].Rows.Count > 0) return decimal.Parse(ds.Tables[0].Rows[0]["maql"].ToString());
            else return 0;
        }

        public decimal get_mavaovien_tiepdon(string mabn, string ngay)
        {
            if (!bMmyy(mmyy(ngay))) return 0;
            ds = get_data("select mavaovien from " + user + mmyy(ngay) + ".tiepdon where mabn='" + mabn + "' and to_char(ngay,'dd/mm/yyyy')='" + ngay.Substring(0, 10) + "' order by noitiepdon desc");
            if (ds.Tables[0].Rows.Count > 0) return decimal.Parse(ds.Tables[0].Rows[0]["mavaovien"].ToString());
            else return 0;
        }

        public decimal get_tiepdon_ngaygio(string mabn, string ngaygio)
        {
            if (!bMmyy(mmyy(ngaygio))) return 0;
            ds = get_data("select maql from " + user + mmyy(ngaygio) + ".tiepdon where mabn='" + mabn + "' and to_char(ngay,'dd/mm/yyyy hh24:mi')='" + ngaygio + "' order by noitiepdon desc");
            if (ds.Tables[0].Rows.Count > 0) return decimal.Parse(ds.Tables[0].Rows[0]["maql"].ToString());
            else return 0;
        }

        public decimal get_tiepdon_phongluu(string mabn, string ngay)
        {
            if (!bMmyy(mmyy(ngay))) return 0;
            sql = "select maql from " + user + mmyy(ngay) + ".tiepdon where mabn='" + mabn + "' ";
            sql += " and to_char(ngay,'dd/mm/yyyy')='" + ngay.Substring(0, 10) + "'";
            sql += " and (done is null or done='?') and noitiepdon in (0,1,5) ";
            sql += " order by noitiepdon desc";
            ds = get_data(sql);
            if (ds.Tables[0].Rows.Count > 0) return decimal.Parse(ds.Tables[0].Rows[0]["maql"].ToString());
            else return 0;
        }

        public bool upd_lydokham(string ngay, decimal m_maql, string m_lydo, string m_phanbiet)
        {
            sql = "update " + user + mmyy(ngay) + ".lydokham set lydo=:m_lydo,phanbiet=:m_phanbiet where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_lydo", NpgsqlDbType.Text).Value = m_lydo;
                cmd.Parameters.Add("m_phanbiet", NpgsqlDbType.Text).Value = m_phanbiet;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + mmyy(ngay) + ".lydokham(maql,lydo,phanbiet) values ";
                    sql += "(:m_maql,:m_lydo,:m_phanbiet)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_lydo", NpgsqlDbType.Text).Value = m_lydo;
                    cmd.Parameters.Add("m_phanbiet", NpgsqlDbType.Text).Value = m_phanbiet;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ngay, ex.Message, sComputer, "lydokham");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_lydokham(string ngay, decimal m_maql, string m_lydo)
        {
            sql = "update " + user + mmyy(ngay) + ".lydokham set lydo=:m_lydo where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_lydo", NpgsqlDbType.Text).Value = m_lydo;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + mmyy(ngay) + ".lydokham(maql,lydo) values ";
                    sql += "(:m_maql,:m_lydo)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_lydo", NpgsqlDbType.Text).Value = m_lydo;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ngay, ex.Message, sComputer, "lydokham");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public string get_lydokham(string ngay, decimal maql)
        {
            ds = get_data("select lydo from " + user + mmyy(ngay) + ".lydokham where maql=" + maql);
            if (ds.Tables[0].Rows.Count > 0) return ds.Tables[0].Rows[0]["lydo"].ToString();
            else return "";
        }

        public bool upd_phanbiet(string ngay, decimal m_maql, string m_phanbiet)
        {
            sql = "update " + user + mmyy(ngay) + ".lydokham set phanbiet=:m_phanbiet where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_phanbiet", NpgsqlDbType.Text).Value = m_phanbiet;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + mmyy(ngay) + ".lydokham(maql,phanbiet) values ";
                    sql += "(:m_maql,:m_phanbiet)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_phanbiet", NpgsqlDbType.Text).Value = m_phanbiet;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ngay, ex.Message, sComputer, "phanbiet");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public string get_phanbiet(string ngay, decimal maql)
        {
            ds = get_data("select phanbiet from " + user + mmyy(ngay) + ".lydokham where maql=" + maql);
            if (ds.Tables[0].Rows.Count > 0) return ds.Tables[0].Rows[0]["phanbiet"].ToString();
            else return "";
        }
        public bool upd_trieuchung(string ngay, decimal m_maql, string m_ten)
        {
            sql = "update " + user + mmyy(ngay) + ".trieuchung set ten=:m_ten where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + mmyy(ngay) + ".trieuchung(maql,ten) values ";
                    sql += "(:m_maql,:m_ten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ngay, ex.Message, sComputer, "trieuchung");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public string get_trieuchung(string ngay, decimal maql)
        {
            ds = get_data("select ten from " + user + mmyy(ngay) + ".trieuchung where maql=" + maql);
            if (ds.Tables[0].Rows.Count > 0) return ds.Tables[0].Rows[0]["ten"].ToString();
            else return "";
        }

        public int get_honnhan(string ngay, decimal maql)
        {
            ds = get_data("select honnhan from " + user + mmyy(ngay) + ".lienhe where maql=" + maql);
            if (ds.Tables[0].Rows.Count > 0) return int.Parse(ds.Tables[0].Rows[0]["honnhan"].ToString());
            else return 0;
        }

        public DataSet get_ttravien_ct(DataSet ds, DataRow[] dr, DataRow[] drss, DataTable dtkp, DataTable dtbd, DataTable dtvp, string makp, bool bVienphi_phongluu, int loaiba, bool bKhoa, string tenuser, int usrid, bool bThanhtoan_N_Dot)
        {
            try { ds.Tables[0].Columns.Add("VUOTTRAN", typeof(decimal)).DefaultValue = 0; }
            catch { }
            try { ds.Tables[0].Columns.Add("dinhmucKTcao", typeof(decimal)).DefaultValue = 0; }
            catch { }
            try { ds.Tables[0].Columns.Add("tLchitraktcao", typeof(decimal)).DefaultValue = 0; }
            catch { }
            ds.Clear();
            DataRow r1, r2, r4; DataRow[] r3;
            DataTable tmp;
            bool bLayGiabhyt_giamua = bLaygiamua_khi_giabh_0_giabh_nho_giamua;
            bool ngia = bThanhtoan_ngia, bMau38_Full = bInmau38_daydu;
            bool bKythuatcao_chitratoiday = bKTCao_chitratoida;
            bool bdichvubhytduoi_100_thuphi = bThuphi_dichvubhytduoi_100;
            decimal dKythuatcao_chitratoiday = ck2_ca3_26;//dKTCao_chitratoida;
            string usr = user, s_nhomhaophi = sHaophi_thanhtoan;
            string _maql = "", s_chenhlech = "", schenhlech = sChenhlech, s_idthuoc = "", s_noidk = "";
            string s_doituongtp = f_get_tendoituong("2");
            int i_tyle_chinhsach = 0;//gam 01/12/2011
            bool bktCao_ttDV = bktCao_tinhtungDV;//ThanhCuong - 06/08/2012 - Kỹ thuật cao

            sql = "select 0 as loai,id,bhyt,to_char(ngayud,'yyyymmddhh24mi') as ngaygio,to_char(ngayud,'yyyymmdd') as ngay,gia_bh from " + user + ".d_dmbd_luu";
            sql += " union all ";
            sql += "select 1 as loai,id,bhyt,to_char(ngayud,'yyyymmddhh24mi') as ngaygio,to_char(ngayud,'yyyymmdd') as ngay,gia_bh from " + user + ".d_dmbd";
            DataTable dtbdfull = get_data(sql).Tables[0];
            for (int i = 0; i < dr.Length; i++)
                if ((dr[i]["madoituong"].ToString() == "1" || dr[i]["madoituongvao"].ToString() == "1") && _maql.ToString().IndexOf(dr[i]["maql"].ToString() + ",") == -1) _maql += dr[i]["maql"].ToString() + ",";
            DataTable dtbhyt = new DataTable();
            bool bBhyt = false, bdieutri_donthuoc = bDieutri_donthuoc, bHaophi = bHaophi_thanhtoan, bHaophi_doituongvao = bHaophi_thanhtoan_doituongvao, bRavien_giagoc = bTtravien_giagoc;
            bool bsothe_ngay_huong = bSothe_ngay_huong, bthutienlien = bChidinh_thutienlien;
            if (_maql != "" && loaiba != 4)
            {
                sql = "select a.maql,a.sothe,to_char(a.tungay,'dd/mm/yyyy') as tungay,to_char(a.denngay,'dd/mm/yyyy') as denngay,";
                sql += "to_char(a.tungay,'yyyymmdd') as tu,to_char(a.denngay,'yyyymmdd') as den";
                if (bsothe_ngay_huong) sql += ",to_char(a.ngay1,'dd/mm/yyyy') as ngay1,to_char(a.ngay2,'dd/mm/yyyy') as ngay2,to_char(a.ngay3,'dd/mm/yyyy') as ngay3";
                if (loaiba == 1 || loaiba == 2) sql += ",to_char(a.ngayduyet,'dd/mm/yyyy') as ngayduyet";
                else sql += ",'' as ngayduyet";
                sql += ",b.tenbv||'^'||a.mabv as tenbv";
                sql += " from " + usr + ".bhyt a," + usr + ".dmnoicapbhyt b where a.mabv=b.mabv and a.maql in (" + _maql.Substring(0, _maql.Length - 1) + ")";
                sql += " order by a.tungay,a.denngay";
                dtbhyt = get_data(sql).Tables[0];
                bBhyt = true;
            }
            DataTable dtkpd = get_data("select * from " + user + ".d_duockp").Tables[0];
            DataTable dtkpm = get_data("select * from " + user + ".btdkp_bv").Tables[0];
            bool bChitiet = bInthanhtoanchitiet;
            DataTable dtdt = get_data("select * from " + usr + ".doituong").Tables[0];
            foreach (DataRow r in dtdt.Select("chenhlech=1")) s_chenhlech += r["madoituong"].ToString().Trim() + ",";
            int iHaophi = 5;// d.iHaophi;
            if (bHaophi)
            {
                r1 = getrowbyid(dtdt, "madoituong=" + iHaophi);
                if (r1 == null)
                {
                    r2 = dtdt.NewRow();
                    r2["madoituong"] = d.iHaophi;
                    r2["doituong"] = "Hao phí";
                    r2["sothe"] = 0;
                    r2["ngay"] = 0;
                    r2["mabv"] = 0;
                    r2["mien"] = 1;
                    r2["field_gia"] = "gia_th";
                    r2["trasau"] = 0;
                    r2["dai"] = "";
                    r2["cholam"] = 0;
                    dtdt.Rows.Add(r2);
                }
            }
            v = new LibVienphi.AccessData();
            d = new LibDuoc.AccessData();
            string s_doituong = "Thu phí", s_mabn = "", s_idvienphi;
            string s_madt, s_dtuong, s_ten, s_tenkp = "", s_ngay = ngayhienhanh_server.Substring(0, 10), s_tungay = "", s_denngay = "", s_sothe = "", ngay1 = "", ngay2 = "", ngay3 = "", ngayduyet = "";
            decimal dg1, dg2, dongia, tamung, sotien, bhyt, mien, tongstktc = 0, st1, st2, dg1k, dg2k, st1k, st2k, st, giamua, giaban, dg3, st3;
            string s_mmyy = mmyy(s_ngay), f1, f2;
            if (!bMmyy(s_mmyy)) tao_schema(s_mmyy, 0);
            decimal idkhoa = 0, maql = 0, idvienphi = 0, maql_phongluu = 0;
            decimal d_sotien_ktcao = 0, d_sotien_ktcao_dinhmuc = ck2_ca3_26;
            bool bFound_ktcao_vuot = false, bCLktcao = false;
            tc_tamung = 0;
            b_tatca_sobienlaitamung = "";
            b_sobienlaitamung = "";
            string ngayreset_sophieu = "";
            if (bSophieu_TTRV_theonam)
            {
                ngayreset_sophieu = "31/12/" + s_ngay.Substring(6, 4);
                upd_capsotoa_yy(loaiba, ngayreset_sophieu, 0, 0);
            }
            else if (bSophieu_TTRV_theonam_tinhtu_taosolieu)
            {
                ngayreset_sophieu = get_ngaytao_solieu_thangmoi("01" + s_mmyy.Substring(2, 2), nhom_duoc);
                upd_capsotoa_yy(loaiba, ngayreset_sophieu, 0, 0);
            }
            else if (bSophieu_TTRV_theothang_tinhtu_ngay01)
            {
                ngayreset_sophieu = "01/" + s_ngay.Substring(3, 2) + "/" + s_ngay.Substring(6, 4);
                upd_capsotoa_yy(loaiba, ngayreset_sophieu, 0, 0);
            }
            else if (bSophieu_TTRV_theothang_tinhtu_toasolieu)
            {
                ngayreset_sophieu = get_ngaytao_solieu_thangmoi(s_mmyy, nhom_duoc);
                upd_capsotoa_yy(loaiba, ngayreset_sophieu, 0, 0);
            }
            else
            {
                upd_capsotoa(mmyy(s_ngay), loaiba, s_ngay, 0, 0);
            }
            bool bChenhlechdv = bChenhlech, bCapve = bCapve_noitru, bNgtr = bBHYTngtr_noitru, bndot = bThanhtoan_N_Dot || loaiba == 2 || bKhoa, bChenhlech_dt = bChenhlech_doituong, bCont, bchenhlech_thuoc = bChenhlech_thuoc, bchenhlech_thuoc_dannhmuc = bChenhlech_thuoc_dannhmuc;
            int i_madoituongvao = 2, i_tunguyen = iTunguyen, i_madt = 2, tmp_madt = 2;
            r1 = getrowbyid(dtdt, "madoituong=" + i_tunguyen);
            if (r1 != null) s_doituong = r1["doituong"].ToString();
            decimal mucbhquidinh = muc_bhquidinh, muckhongqua = dKythuatcao_chitratoiday;//muc_khongqua;
            int phantrambhyt = phantram_bhyt;
            bool nhom1, nhom2;
            string huong100 = huong_100, huong100kqua = huong_100_khongqua;
            bool bgia_bh_quydinh = bGia_bh_quydinh, bgia_bh_quydinh_giamua = bGia_bh_quydinh_giamua, bDenngay, bTungay;
            int kythuat = -1, nhom = nhom_duoc, maphu = 0;
            string cl_cholam = mien_chenhlech_cholam.Trim().ToLower(), cl_tendoituong = "", cl_ten = "";
            decimal cl_tyle = mien_chenhlech, iBhyt = 0, st_k = 0, st_tra = 0;
            int cl_doituong = mien_chenhlech_doituong, pos, iKhoan_ma = iKhoan_mavp, iKhoan_ma_pttt = iKhoan_mavp_pttt;
            bool bKhoan = bKhoan_vtth;
            string sKhoan_doituong = sKhoan_madoituong, sKhoan_nhom = sKhoan_nhomvp, makp_k = "", for_ngay = f_ngay;
            string m_madoituong_inttrv = "";
            for (int i = 0; i < dr.Length; i++)
            {
                m_madoituong_inttrv = "";
                if (dr[i]["done"].ToString() == "0") { m_madoituong_inttrv = (dr[i]["chon"].ToString().ToLower() == "true") ? "," + dr[i]["madoituong"].ToString() + "," : ",0,"; }//binh 070611

                r1 = getrowbyid(dtkp, "makp='" + dr[i]["makp"].ToString() + "'");
                i_madoituongvao = int.Parse(dr[i]["madoituongvao"].ToString());
                tamung = 0; sotien = 0; bhyt = 0; mien = 0;
                if (bndot && bKhoa) idkhoa = decimal.Parse(dr[i]["idkhoa"].ToString());//if (bndot) idkhoa = decimal.Parse(dr[i]["idkhoa"].ToString());//bbbb
                maql = decimal.Parse(dr[i]["maql"].ToString()); s_sothe = dr[i]["sothe"].ToString();

                d_sotien_ktcao = 0; bFound_ktcao_vuot = false;//ThanhCuong - 06/08/2012 - Kỹ thuật cao
                pos = dr[i]["denngay"].ToString().IndexOf("^");
                s_tungay = s_denngay = "";
                if (pos != -1)
                {
                    s_tungay = dr[i]["denngay"].ToString().Substring(0, pos);
                    s_denngay = dr[i]["denngay"].ToString().Substring(pos + 1);
                }
                if (loaiba == 4)
                {
                    sql = "select a.maql,a.sothe,to_char(a.tungay,'dd/mm/yyyy') as tungay,to_char(a.denngay,'dd/mm/yyyy') as denngay,";
                    sql += "to_char(a.tungay,'yyyymmdd') as tu,to_char(a.denngay,'yyyymmdd') as den";
                    if (bsothe_ngay_huong) sql += ",to_char(a.ngay1,'dd/mm/yyyy') as ngay1,to_char(a.ngay2,'dd/mm/yyyy') as ngay2,to_char(a.ngay3,'dd/mm/yyyy') as ngay3";
                    sql += ",'' as ngayduyet,b.tenbv||'^'||a.mabv as tenbv";
                    sql += " from " + usr + mmyy(dr[i]["ngayvao"].ToString()) + ".bhyt a," + usr + ".dmnoicapbhyt b where a.mabv=b.mabv and a.maql=" + maql;
                    sql += " order by a.tungay,a.denngay";
                    dtbhyt = get_data(sql).Tables[0];
                    bBhyt = true;
                }
                if (dr[i]["done"].ToString() == "0")
                {
                    if (bThanhtoan_ndot)
                    {
                        s_idvienphi = v.get_id_thvp(dr[i]["mabn"].ToString(), maql, idkhoa, dr[i]["ngayra"].ToString(), s_ngay);//Thuy 07.03.2012 
                    }
                    else
                    {
                        decimal temp = 0;
                        temp = v.get_id_thvp(s_ngay, dr[i]["mabn"].ToString(), maql, idkhoa, dr[i]["ngayvao"].ToString());//Thuy 07.03.2012 
                        s_idvienphi = temp.ToString();
                    }
                    i_tyle_chinhsach = get_tyle_bhyt_chinhsach(dr[i]["sothe"].ToString());
                    if (s_idvienphi != "" && s_idvienphi != "0")
                    {
                        try
                        {
                            s_mmyy = s_idvienphi.Substring(2, 2) + s_idvienphi.Substring(0, 2);
                        }
                        catch { s_mmyy = mmyy(dr[i]["ngayra"].ToString().Substring(0, 10)); }
                        //s_mmyy = s_idvienphi.Substring(2, 2) + s_idvienphi.Substring(0, 2);
                        if (bMmyy(s_mmyy) == false) s_mmyy = mmyy(s_ngay);
                        idvienphi = decimal.Parse(s_idvienphi);
                        if (s_mabn != dr[i]["mabn"].ToString())
                        {
                            s_idthuoc = "";
                            s_mabn = dr[i]["mabn"].ToString();
                            execute_data("delete from " + usr + s_mmyy + ".v_thvpct where id=" + idvienphi);
                        }
                    }
                    else
                    {
                        s_idthuoc = "";
                        s_mmyy = mmyy(s_ngay);
                        s_mabn = dr[i]["mabn"].ToString();
                        idvienphi = v.get_id_thvp();
                        s_idvienphi = idvienphi.ToString();
                    }
                    v.upd_thvpll(idvienphi, dr[i]["mabn"].ToString(), decimal.Parse(dr[i]["mavaovien"].ToString()), maql, idkhoa, dr[i]["ngayvao"].ToString(), dr[i]["ngayra"].ToString(), dr[i]["giuong"].ToString(), dr[i]["makp"].ToString(), dr[i]["chandoan"].ToString(), dr[i]["maicd"].ToString(), sotien, tamung, bhyt, mien, s_mmyy, i_tyle_chinhsach);
                }
                tamung = get_tamung_ct(dr[i]["mabn"].ToString(), maql, idkhoa, dr[i]["ngayvao"].ToString(), dr[i]["ngayra"].ToString(), (makp == "") ? "" : dr[i]["makp"].ToString(), int.Parse(dr[i]["madoituong"].ToString()), int.Parse(dr[i]["done"].ToString()), maql_phongluu, loaiba, bKhoa, dr[i]["maso"].ToString(), dr[i]["idttrv"].ToString());
                tc_tamung += tamung;

                if (b_sobienlaitamung != "" && b_tatca_sobienlaitamung.IndexOf(b_sobienlaitamung) < 0) b_tatca_sobienlaitamung += b_sobienlaitamung;
                #region khoan vtth
                if (bKhoan && sKhoan_doituong.IndexOf(dr[i]["madoituong"].ToString().PadLeft(2, '0')) != -1)
                {
                    #region vtth khoa
                    tmp = get_thuoc_ct(dr[i]["mabn"].ToString(), maql, idkhoa, dr[i]["ngayvao"].ToString(), dr[i]["ngayra"].ToString(), (makp == "" || r1 == null) ? 0 : int.Parse(r1["id"].ToString()), iHaophi, int.Parse(dr[i]["done"].ToString()), maql_phongluu, bChenhlechdv, loaiba, bKhoa, dr[i]["maso"].ToString(), "", bRavien_giagoc, sKhoan_nhom, bThanhtoan_N_Dot, dr[i]["idttrv"].ToString());
                    if (tmp != null)
                    {
                        makp_k = ""; st = st_k = 0;
                        r3 = tmp.Select("true", "makp");
                        if (r3.Length > 0)
                        {
                            makp_k = r3[0]["makp"].ToString();
                            st = decimal.Parse(r3[0]["sotien"].ToString());
                        }

                        for (int j = 0; j < r3.Length; j++)
                        {
                            if (r3[j]["loai"].ToString() == "9")
                                r2 = getrowbyid(dtvp, "id=" + decimal.Parse(r3[j]["mabd"].ToString()));
                            else
                                r2 = getrowbyid(dtbd, "id=" + decimal.Parse(r3[j]["mabd"].ToString()));
                            if (r2 != null && sKhoan_nhom.IndexOf(r2["manhomvp"].ToString().PadLeft(3, '0')) != -1)
                            {
                                if (int.Parse(r3[j]["makp"].ToString()) != int.Parse(makp_k) || j == r3.Length - 1)
                                {
                                    r1 = getrowbyid(dtkpm, "makp='" + r3[j]["makp"].ToString() + "' and giavtth>0");
                                    if (r1 != null)
                                    {
                                        st_k = decimal.Parse(r1["giavtth"].ToString());
                                        st_tra = st_k;// (st_k > st) ? st_k - Math.Round(st) : 0;
                                        i_madt = int.Parse(dr[i]["madoituong"].ToString());
                                        s_dtuong = dr[i]["doituong"].ToString();
                                        r4 = getrowbyid(dtvp, "id=" + iKhoan_ma);
                                        if (r4 != null)
                                        {
                                            if (m_madoituong_inttrv == "" || m_madoituong_inttrv.IndexOf("," + dr[i]["madoituong"].ToString() + ",") >= 0)
                                            {
                                                //binh 070611: do khi chon chuyen so lieu vp, nhung khong chon het doi tuong, chi chon 1 dtuong de in (thuong in lai)
                                                //Khi do SL chuyen xuong vp chi chuyen doi tuong duoc chon --> do do thieu so lieu
                                                //
                                                updrec_ravien(ds, dr[i]["mabn"].ToString(), dr[i]["mabn"].ToString(), decimal.Parse(dr[i]["maql"].ToString()), decimal.Parse(dr[i]["idkhoa"].ToString()), dr[i]["hoten"].ToString(), dr[i]["namsinh"].ToString(), dr[i]["phai"].ToString(),
                                                dr[i]["diachi"].ToString(), i_madt, s_dtuong, dr[i]["sothe"].ToString(), iBhyt, dr[i]["denngay"].ToString(), dr[i]["noigioithieu"].ToString(), dr[i]["noicap"].ToString(),
                                                dr[i]["giuong"].ToString(), r3[j]["makp"].ToString() + ((bKhoa) ? " : " + r3[j]["ngay"].ToString() : ""), r1["tenkp"].ToString() + ((bKhoa) ? " : " + r3[j]["ngay"].ToString() : ""), dr[i]["ngayvao"].ToString(), dr[i]["ngayra"].ToString(), dr[i]["chandoan"].ToString(), dr[i]["maicd"].ToString(), int.Parse(r2["sttnhom"].ToString()),
                                                r2["nhom"].ToString(), int.Parse(r2["sttloai"].ToString()), r2["loai"].ToString(), int.Parse(r4["id"].ToString()),
                                                r4["ten"].ToString().Trim(), r4["dvt"].ToString(), 1, st_k,
                                                st_k, 0, 0, dr[i]["nguoinha"].ToString(), int.Parse(dr[i]["hinhthuc"].ToString()), int.Parse(dr[i]["phuongphap"].ToString()), int.Parse(dr[i]["ketqua"].ToString()), dr[i]["soluutru"].ToString(),
                                                st_k, bChitiet, int.Parse(dr[i]["done"].ToString()), dr[i]["mabs"].ToString(),
                                                dr[i]["tenbs"].ToString(), dr[i]["makp"].ToString(), dr[i]["cholam"].ToString(), i_madoituongvao,
                                                st_k, decimal.Parse(r3[j]["idttrv"].ToString()), st_tra, int.Parse(r3[j]["traituyen"].ToString()),
                                                kythuat, r2["mabs"].ToString());//int.Parse(dr[i]["traituyen"].ToString())
                                            }
                                            if (dr[i]["done"].ToString() == "0")
                                            {
                                                v.upd_thvpct(idvienphi, r3[j]["ngay"].ToString(), r3[j]["makp"].ToString(), i_madt, decimal.Parse(r4["id"].ToString()), 1, st_tra, st_tra, 0, s_mmyy, s_sothe, int.Parse(r3[j]["traituyen"].ToString()), r2["mabs"].ToString(), decimal.Parse(r3[j]["idtonghop"].ToString()), int.Parse(r3[j]["stttonghop"].ToString()));
                                                //
                                            }
                                        }
                                    }
                                    makp_k = r3[j]["makp"].ToString();
                                    st = 0;
                                }
                                else st += decimal.Parse(r3[j]["sotien"].ToString());
                            }
                        }
                    }
                    #endregion

                    #region vtth pttt
                    sql = "select a.mavp,b.giavtth,b.ten,to_char(a.ngay,'dd/mm/yyyy') as ngay,a.makp,c.tenkp ";
                    sql += " from xxx.pttt a," + user + ".v_giavp b," + user + ".btdkp_bv c ";
                    sql += " where a.mavp=b.id and a.makp=c.makp and a.mabn='" + dr[i]["mabn"].ToString() + "' and a.maql=" + maql;
                    if (bThanhtoan_ndot) sql += " and a.ngay between to_date('" + dr[i]["ngayvao"].ToString().Substring(0, 10) + "','" + for_ngay + "') and to_date('" + dr[i]["ngayra"].ToString().Substring(0, 10) + "','" + for_ngay + "')";
                    else if (idkhoa != 0)
                    {
                        sql += " and a.idkhoa=" + idkhoa;
                        if (!bKhoa) sql += " and a.ngay between to_date('" + dr[i]["ngayvao"].ToString().Substring(0, 10) + "','" + for_ngay + "') and to_date('" + dr[i]["ngayra"].ToString().Substring(0, 10) + "','" + for_ngay + "')";
                    }
                    sql += " and b.giavtth>0";
                    foreach (DataRow r in get_data_mmyy(sql, dr[i]["ngayvao"].ToString(), dr[i]["ngayra"].ToString(), true).Tables[0].Rows)
                    {
                        st = 0;
                        tmp = get_thuoc_ct(dr[i]["mabn"].ToString(), maql, idkhoa, dr[i]["ngayvao"].ToString(), dr[i]["ngayra"].ToString(), (makp == "" || r1 == null) ? 0 : int.Parse(r1["id"].ToString()), iHaophi, int.Parse(dr[i]["done"].ToString()), maql_phongluu, bChenhlechdv, loaiba, bKhoa, dr[i]["maso"].ToString(), r["mavp"].ToString().Trim(), bRavien_giagoc, sKhoan_nhom, bThanhtoan_N_Dot, dr[i]["idttrv"].ToString());
                        if (tmp != null)
                        {
                            foreach (DataRow r5 in tmp.Rows)
                            {
                                r2 = getrowbyid(dtbd, "id=" + decimal.Parse(r5["mabd"].ToString()));
                                //if (r2 != null && sKhoan_nhom.IndexOf(r2["manhomvp"].ToString().PadLeft(3, '0')) != -1) st += decimal.Parse(r5["sotien"].ToString());
                                if (r2 != null) st += decimal.Parse(r5["sotien"].ToString());
                            }
                            if (st != 0)
                            {
                                i_madt = int.Parse(dr[i]["madoituong"].ToString());
                                s_dtuong = dr[i]["doituong"].ToString();
                                r4 = getrowbyid(dtvp, "id=" + iKhoan_ma_pttt);
                                if (r4 != null)
                                {
                                    st_k = decimal.Parse(r["giavtth"].ToString());
                                    st_tra = (st_k > st) ? st_k - Math.Round(st) : 0;
                                    if (m_madoituong_inttrv == "" || m_madoituong_inttrv.IndexOf("," + dr[i]["madoituong"].ToString() + ",") >= 0)
                                    {
                                        //binh 070611: do khi chon chuyen so lieu vp, nhung khong chon het doi tuong, chi chon 1 dtuong de in (thuong in lai)
                                        //Khi do SL chuyen xuong vp chi chuyen doi tuong duoc chon --> do do thieu so lieu
                                        //
                                        updrec_ravien(ds, dr[i]["mabn"].ToString(), dr[i]["mabn"].ToString(), decimal.Parse(dr[i]["maql"].ToString()), decimal.Parse(dr[i]["idkhoa"].ToString()), dr[i]["hoten"].ToString(), dr[i]["namsinh"].ToString(), dr[i]["phai"].ToString(),
                                        dr[i]["diachi"].ToString(), i_madt, s_dtuong, dr[i]["sothe"].ToString(), iBhyt, dr[i]["denngay"].ToString(), dr[i]["noigioithieu"].ToString(), dr[i]["noicap"].ToString(),
                                        dr[i]["giuong"].ToString(), r["makp"].ToString() + ((bKhoa) ? " : " + r["ngay"].ToString() : ""), r["tenkp"].ToString() + ((bKhoa) ? " : " + r["ngay"].ToString() : ""), dr[i]["ngayvao"].ToString(), dr[i]["ngayra"].ToString(), dr[i]["chandoan"].ToString(), dr[i]["maicd"].ToString(), int.Parse(r4["sttnhom"].ToString()),
                                        r4["nhom"].ToString(), int.Parse(r4["sttloai"].ToString()), r4["loai"].ToString(), int.Parse(r4["id"].ToString()),
                                        r4["ten"].ToString().Trim() + "(" + r["ten"].ToString().Trim() + ")", r4["dvt"].ToString(), 1, st_k,
                                        st_k, 0, 0, dr[i]["nguoinha"].ToString(), int.Parse(dr[i]["hinhthuc"].ToString()), int.Parse(dr[i]["phuongphap"].ToString()), int.Parse(dr[i]["ketqua"].ToString()), dr[i]["soluutru"].ToString(),
                                        st_k, bChitiet, int.Parse(dr[i]["done"].ToString()), dr[i]["mabs"].ToString(), dr[i]["tenbs"].ToString(), dr[i]["makp"].ToString(), dr[i]["cholam"].ToString(), i_madoituongvao, st_k, decimal.Parse(dr[i]["done"].ToString()), st_tra, int.Parse(dr[i]["traituyen"].ToString()), kythuat, "");
                                    }
                                    if (dr[i]["done"].ToString() == "0" && r["toathuoc"].ToString() == "1")
                                        v.upd_thvpct(idvienphi, r["ngay"].ToString(), r["makp"].ToString(), i_madt, decimal.Parse(r4["id"].ToString()), 1, st_tra, st_tra, 0, s_mmyy, s_sothe, 0, "", decimal.Parse(r4["idtonghop"].ToString()), int.Parse(r4["stttonghop"].ToString()));
                                }
                            }
                        }
                    }
                    #endregion
                }
                #endregion
                //if (!bBosolieuduoc)
                //{
                DataTable tmpthuoc = new DataTable();
                if (bCapcuu_noitru)
                {
                    maql_phongluu = get_maql_phongluu(s_ngay, maql);
                }
                tmp = get_thuoc_ct(dr[i]["mabn"].ToString(), maql, idkhoa, dr[i]["ngayvao"].ToString(), dr[i]["ngayra"].ToString(), (makp == "" || r1 == null) ? 0 : int.Parse(r1["id"].ToString()), int.Parse(dr[i]["madoituong"].ToString()), int.Parse(dr[i]["done"].ToString()), maql_phongluu, bChenhlechdv, bCapve, bNgtr, loaiba, bKhoa, dr[i]["maso"].ToString(), bdieutri_donthuoc, bRavien_giagoc, ngia, bndot, dr[i]["idttrv"].ToString(), dr[i]["quyenso_tt"].ToString(), dr[i]["sobienlai_tt"].ToString());
                if (tmp != null)
                {
                    tmpthuoc = tmp.Copy();
                    tmpthuoc.AcceptChanges();
                    string exs = "id_ktcao=0";
                    if (int.Parse(dr[i]["madoituong"].ToString()) != 1) exs = "";
                    foreach (DataRow r in tmp.Select(exs))
                    {
                        r2 = getrowbyid(dtbd, "id=" + int.Parse(r["mabd"].ToString()));
                        if (r2 != null)
                        {
                            if (dr[i]["done"].ToString() == "0" && (loaiba == 2 || idkhoa != 0 || bndot))
                            {
                                if (s_idthuoc.IndexOf(r["id"].ToString().Trim() + ",") == -1) s_idthuoc += r["id"].ToString().Trim() + ",";
                            }
                            ngayduyet = ""; s_noidk = dr[i]["noicap"].ToString();
                            iBhyt = decimal.Parse(r2["bhyt"].ToString());
                            if (bBhyt)
                            {
                                r3 = dtbhyt.Select("maql=" + maql + " and den>=" + r["ngay"].ToString().Substring(6, 4) + r["ngay"].ToString().Substring(3, 2) + r["ngay"].ToString().Substring(0, 2), "den");
                                if (r3.Length > 0)
                                {
                                    s_tungay = r3[0]["tungay"].ToString();
                                    s_denngay = r3[0]["denngay"].ToString();
                                    s_sothe = r3[0]["sothe"].ToString();
                                    ngayduyet = r3[0]["ngayduyet"].ToString();
                                    s_noidk = r3[0]["tenbv"].ToString();
                                }
                            }
                            DataRow rkp = getrowbyid(dtkpm, "makp='" + r["makp"].ToString() + "'");
                            if (rkp != null) s_tenkp = rkp["tenkp"].ToString().Trim();
                            else if (r["makp"].ToString() != "")
                            {
                                rkp = getrowbyid(dtkpd, "id=" + int.Parse(r["makp"].ToString()));
                                if (rkp != null) s_tenkp = rkp["ten"].ToString();
                            }
                            else s_tenkp = dr[i]["tenkp"].ToString().Trim();
                            s_madt = dr[i]["madoituong"].ToString().Trim();
                            i_madt = int.Parse(s_madt);
                            s_dtuong = dr[i]["doituong"].ToString();
                            s_ten = cl_ten = r2["ten"].ToString();
                            dongia = decimal.Parse(r["dongia"].ToString());
                            bCont = bChenhlechdv && bchenhlech_thuoc;

                            iBhyt = (s_madt == "1") ? get_bhyt(dtbdfull, decimal.Parse(r["mabd"].ToString()), r["ngay"].ToString()) : 0;

                            dg2 = st2 = dg3 = st3 = 0;
                            giamua = decimal.Parse(r["giamua"].ToString());
                            giaban = decimal.Parse(r["giaban"].ToString());
                            bDenngay = true; bTungay = true;
                            kythuat = (r2["kythuat"].ToString() == "") ? -1 : int.Parse(r2["kythuat"].ToString());
                            if (bchenhlech_thuoc_dannhmuc) bCont = bCont && r2["chenhlech"].ToString() == "1";
                            if (!bChenhlech_dt) bCont = bCont && int.Parse(dr[i]["madoituong"].ToString()) == i_madoituongvao;
                            if (s_chenhlech.IndexOf(i_madoituongvao.ToString().Trim() + ",") != -1 && bgia_bh_quydinh && bchenhlech_thuoc_dannhmuc && bCont)// && r2["chenhlech"].ToString() == "0")
                            {
                                //dongia = (decimal.Parse(r2["gia_bh"].ToString()) > 0 && decimal.Parse(r2["gia_bh"].ToString()) <= decimal.Parse(r["giamua"].ToString())) ? decimal.Parse(r2["gia_bh"].ToString()) : decimal.Parse(r["giamua"].ToString());//decimal.Parse(r2["gia_bh"].ToString());
                                dongia = (decimal.Parse(r["gia_bh"].ToString()) > 0 && decimal.Parse(r["gia_bh"].ToString()) <= decimal.Parse(r["giamua"].ToString())) ? decimal.Parse(r["gia_bh"].ToString()) : decimal.Parse(r["giamua"].ToString());
                                st1 = decimal.Parse(r["soluong"].ToString()) * dongia;
                            }
                            else st1 = decimal.Parse(r["sotien"].ToString());
                            dg1 = dongia;
                            if (bCont)
                            {
                                if (s_denngay.Trim().Length == 10) bDenngay = bNgay(s_denngay, r["ngay"].ToString().Substring(0, 10));
                                if (s_tungay.Trim().Length == 10) bTungay = bNgay(r["ngay"].ToString().Substring(0, 10), s_tungay);
                                bCont = s_chenhlech.IndexOf(i_madoituongvao.ToString().Trim() + ",") != -1;
                                if (!bgia_bh_quydinh_giamua) bCont = bCont && r["loai"].ToString().Trim() == "1";
                                if (i_madoituongvao == 1) bCont = bCont && (decimal.Parse(r2["bhyt"].ToString()) > 0);
                                if (bgia_bh_quydinh && bCont)
                                {
                                    if (!bLayGiabhyt_giamua)
                                    {
                                        //giaban = giamua; //gam 24/09/2011 lấy giá bán để tính chênh lệch
                                        giamua = decimal.Parse(r["gia_bh"].ToString() == "" ? "0" : r["gia_bh"].ToString());//giamua = decimal.Parse(r2["gia_bh"].ToString());//luon lay gia BHYT
                                        dg1 = dongia = giamua;
                                        st1 = decimal.Parse(r["soluong"].ToString()) * dg1;
                                    }
                                    else
                                    {
                                        if (bgia_bh_quydinh_giamua)
                                        {
                                            //giaban = giamua;//gam 24/09/2011 lấy giá bán để tính chênh lệch
                                            giamua = (decimal.Parse(r["gia_bh"].ToString()) > 0 || decimal.Parse(r["gia_bh"].ToString()) <= decimal.Parse(r["giamua"].ToString())) ? decimal.Parse(r["gia_bh"].ToString()) : decimal.Parse(r["giamua"].ToString()); //giamua = (decimal.Parse(r2["gia_bh"].ToString()) > 0 || decimal.Parse(r2["gia_bh"].ToString()) <= decimal.Parse(r["giamua"].ToString())) ? decimal.Parse(r2["gia_bh"].ToString()) : decimal.Parse(r["giamua"].ToString());
                                            if (giamua == 0 || Math.Floor(giaban) <= Math.Floor(giamua))
                                            {
                                                dg1 = dongia = giamua = giaban;
                                                st1 = decimal.Parse(r["soluong"].ToString()) * dg1;
                                            }
                                        }
                                        else
                                        {
                                            giamua = (decimal.Parse(r["gia_bh"].ToString()) > 0 && decimal.Parse(r["gia_bh"].ToString()) <= decimal.Parse(r["giamua"].ToString())) ? decimal.Parse(r["gia_bh"].ToString()) : decimal.Parse(r["giamua"].ToString()); //giamua = (decimal.Parse(r2["gia_bh"].ToString()) > 0 && decimal.Parse(r2["gia_bh"].ToString()) <= decimal.Parse(r["giamua"].ToString())) ? decimal.Parse(r2["gia_bh"].ToString()) : decimal.Parse(r["giamua"].ToString()); //decimal.Parse(r2["gia_bh"].ToString());
                                        }
                                    }
                                }
                                bCont = bCont && Math.Floor(giaban) != Math.Floor(giamua);
                                if (bChenhlech_dt) bCont = bCont && (s_madt == i_tunguyen.ToString().Trim());
                                //else bCont = bCont && (ngayduyet == "" || !bNgay((ngayduyet=="")?r["ngay"].ToString():ngayduyet, r["ngay"].ToString()));//bbb
                                bCont = bCont && bTungay && bDenngay;
                                if (bCont)//chenh lech
                                {
                                    i_madt = i_madoituongvao;
                                    r1 = getrowbyid(dtdt, "madoituong=" + i_madt);
                                    if (r1 != null) s_dtuong = r1["doituong"].ToString();

                                    dg1 = giamua;
                                    st1 = decimal.Parse(r["soluong"].ToString()) * dg1;
                                }
                                else if (s_madt == "1" && decimal.Parse(r["sotien"].ToString()) != decimal.Parse(r["bhyt"].ToString()))//dich vu bhyt thanh toan 1 phan
                                {
                                    s_ten += " BHYT thanh toán " + r2["bhyt"].ToString().Trim() + " %";
                                    dg1 = dongia * decimal.Parse(r2["bhyt"].ToString()) / 100;
                                    st1 = decimal.Parse(r["bhyt"].ToString());
                                }
                            }
                            else if (s_madt == "1" && decimal.Parse(r["bhyt"].ToString()) > 0 && decimal.Parse(r["sotien"].ToString()) != decimal.Parse(r["bhyt"].ToString()))
                            {
                                s_ten += " BHYT thanh toán " + r2["bhyt"].ToString().Trim() + " %";
                                dg1 = dongia * decimal.Parse(r2["bhyt"].ToString()) / 100;
                                st1 = decimal.Parse(r["bhyt"].ToString());
                            }
                            else if (s_madt == "1" && r2["kcct"].ToString() == "1")
                            {
                                s_ten += " BHYT thanh toán " + r2["bhyt"].ToString().Trim() + " %";
                            }
                            else if (s_madt == "1" && bGia_bh_quydinh && bLayGiabhyt_giamua==false)
                            {
                                giamua = (r["gia_bh"].ToString() == "") ? 0 : decimal.Parse(r["gia_bh"].ToString());
                                dg1 = dongia = giamua;
                                st1 = decimal.Parse(r["soluong"].ToString()) * dg1;
                            }

                            if (m_madoituong_inttrv == "" || m_madoituong_inttrv.IndexOf("," + dr[i]["madoituong"].ToString() + ",") >= 0)
                            {
                                //binh 070611: do khi chon chuyen so lieu vp, nhung khong chon het doi tuong, chi chon 1 dtuong de in (thuong in lai)
                                //Khi do SL chuyen xuong vp chi chuyen doi tuong duoc chon --> do do thieu so lieu
                                //
                                updrec_ravien(ds, dr[i]["mabn"].ToString(), dr[i]["mabn"].ToString(), decimal.Parse(dr[i]["maql"].ToString()), decimal.Parse(dr[i]["idkhoa"].ToString()), dr[i]["hoten"].ToString(), dr[i]["namsinh"].ToString(), dr[i]["phai"].ToString(),
                                    dr[i]["diachi"].ToString(), i_madt, s_dtuong, s_sothe, iBhyt, s_tungay + "^" + s_denngay, dr[i]["noigioithieu"].ToString(), s_noidk,
                                    dr[i]["giuong"].ToString(), r["makp"].ToString() + ((bKhoa) ? " : " + r["ngay"].ToString() : ""), s_tenkp + ((bKhoa) ? " : " + r["ngay"].ToString() : ""), dr[i]["ngayvao"].ToString(), dr[i]["ngayra"].ToString(), dr[i]["chandoan"].ToString(), dr[i]["maicd"].ToString(), int.Parse(r2["sttnhom"].ToString()),
                                    r2["nhom"].ToString(), int.Parse(r2["sttloai"].ToString()), r2["loai"].ToString(), int.Parse(r["mabd"].ToString()),
                                    s_ten, r2["dvt"].ToString(), decimal.Parse(r["soluong"].ToString()),
                                    st1, decimal.Parse(r["bhyt"].ToString()), (bCont) ? 0 : tamung, decimal.Parse(r["bhytt0107"].ToString()), dr[i]["nguoinha"].ToString(), int.Parse(dr[i]["hinhthuc"].ToString()), int.Parse(dr[i]["phuongphap"].ToString()), int.Parse(dr[i]["ketqua"].ToString()), dr[i]["soluutru"].ToString(),
                                    dg1, bChitiet, int.Parse(dr[i]["done"].ToString()), dr[i]["mabs"].ToString(),
                                    dr[i]["tenbs"].ToString(), dr[i]["makp"].ToString(), dr[i]["cholam"].ToString(),
                                    i_madoituongvao, decimal.Parse(r["gianovat"].ToString()), decimal.Parse(r["idttrv"].ToString()),
                                    st1, int.Parse(dr[i]["traituyen"].ToString()), kythuat, r["mabs"].ToString(), (r["id_ktcao"].ToString() == null || r["id_ktcao"].ToString() == "") ? 0 : decimal.Parse(r["id_ktcao"].ToString()), 0, dKythuatcao_chitratoiday, 0, 0);
                            }
                            if (dr[i]["done"].ToString() == "0" && r["toathuoc"].ToString() == "0")
                            {
                                v.upd_thvpct(idvienphi, r["ngay"].ToString(), r["makp"].ToString(), i_madt, decimal.Parse(r["mabd"].ToString()), decimal.Parse(r["soluong"].ToString()), dg1, st1, 0, s_mmyy, s_sothe, r["mabs"].ToString(), decimal.Parse(r["idtonghop"].ToString()), int.Parse(r["stttonghop"].ToString()));// gam 27/02/2012
                                if (r["id_ktcao"].ToString() != "0") { execute_data(" update " + user + mmyy(s_ngay) + ".v_thvpct set id_ktcao=" + r["id_ktcao"].ToString() + " where id=" + idvienphi + " and mavp=" + long.Parse(r["mabd"].ToString()) + " and makp='" + r["makp"].ToString() + "'"); }
                            }
                            //}

                            bCont = bChenhlechdv && bchenhlech_thuoc;
                            if (bchenhlech_thuoc_dannhmuc) bCont = bCont && r2["chenhlech"].ToString() == "1";
                            if (!bChenhlech_dt)
                                bCont = bCont && int.Parse(dr[i]["madoituong"].ToString()) == i_madoituongvao;
                            if (bCont)
                            {
                                bCont = s_chenhlech.IndexOf(i_madoituongvao.ToString().Trim() + ",") != -1
                                        && Math.Floor(giaban) != Math.Floor(giamua);
                                if (!bgia_bh_quydinh_giamua) bCont = bCont && r["loai"].ToString().Trim() == "1";
                                if (bChenhlech_dt) bCont = bCont && (s_madt == i_tunguyen.ToString().Trim() || s_madt == "1");
                                //else bCont = bCont && (ngayduyet == "" || !bNgay((ngayduyet == "") ? r["ngay"].ToString() : ngayduyet, r["ngay"].ToString()));//bbb
                                if (i_madoituongvao == 1) bCont = bCont && (decimal.Parse(r2["bhyt"].ToString()) > 0);
                                bCont = bCont && bTungay && bDenngay;
                                if (bCont)
                                {
                                    i_madt = i_tunguyen;
                                    r1 = getrowbyid(dtdt, "madoituong=" + i_madt);
                                    if (r1 != null) s_dtuong = r1["doituong"].ToString();
                                    s_ten += " " + schenhlech;
                                    dg2 = giaban - giamua - decimal.Parse(r["datra"].ToString());
                                    if (dg2 != 0 && cl_tyle != 0 && cl_cholam.IndexOf(dr[i]["cholam"].ToString().Trim().ToLower()) != -1 && dr[i]["cholam"].ToString() != "")
                                    {
                                        r1 = getrowbyid(dtdt, "madoituong=" + cl_doituong);
                                        if (r1 != null) cl_tendoituong = r1["doituong"].ToString();
                                        dg3 = dg2 * (cl_tyle / 100);
                                        dg2 -= dg3;
                                        st3 = decimal.Parse(r["soluong"].ToString()) * dg3;
                                    }
                                    st2 = decimal.Parse(r["soluong"].ToString()) * dg2;
                                }
                                else if (s_madt == "1" && decimal.Parse(r["sotien"].ToString()) != decimal.Parse(r["bhyt"].ToString()))//dich vu bhyt tra 1 phan, 1 phan bn tra
                                {
                                    i_madt = i_tunguyen;
                                    s_dtuong = s_doituong;
                                    s_ten = r2["ten"].ToString();
                                    decimal bn = 100 - decimal.Parse(r2["bhyt"].ToString());
                                    s_ten += " BN thanh toán " + bn.ToString().Trim() + " %";
                                    dg2 = dongia * bn / 100;
                                    st2 = decimal.Parse(r["sotien"].ToString()) - decimal.Parse(r["bhyt"].ToString());
                                }
                            }
                            else if (s_madt == "1" && decimal.Parse(r["sotien"].ToString()) - decimal.Parse(r["bhyt"].ToString()) > 0 && decimal.Parse(r["sotien"].ToString()) != decimal.Parse(r["bhyt"].ToString()))
                            {
                                i_madt = (bdichvubhytduoi_100_thuphi) ? 2 : i_tunguyen;
                                s_dtuong = (bdichvubhytduoi_100_thuphi) ? s_doituongtp : s_doituong;
                                s_ten = r2["ten"].ToString();
                                decimal bn = 100 - decimal.Parse(r2["bhyt"].ToString());
                                s_ten += " BN thanh toán " + bn.ToString().Trim() + " %";
                                dg2 = dongia * bn / 100;
                                st2 = decimal.Parse(r["sotien"].ToString()) - decimal.Parse(r["bhyt"].ToString());
                            }
                            if (dg2 > 0) //if (dg2 != 0)
                            {
                                if (m_madoituong_inttrv == "" || m_madoituong_inttrv.IndexOf("," + dr[i]["madoituong"].ToString() + ",") >= 0)
                                {
                                    //binh 070611: do khi chon chuyen so lieu vp, nhung khong chon het doi tuong, chi chon 1 dtuong de in (thuong in lai)
                                    //Khi do SL chuyen xuong vp chi chuyen doi tuong duoc chon --> do do thieu so lieu
                                    //
                                    updrec_ravien(ds, dr[i]["mabn"].ToString(), dr[i]["mabn"].ToString(), decimal.Parse(dr[i]["maql"].ToString()), decimal.Parse(dr[i]["idkhoa"].ToString()), dr[i]["hoten"].ToString(), dr[i]["namsinh"].ToString(), dr[i]["phai"].ToString(),
                                        dr[i]["diachi"].ToString(), i_madt, s_dtuong, dr[i]["sothe"].ToString(), iBhyt, dr[i]["denngay"].ToString(), dr[i]["noigioithieu"].ToString(), s_noidk,
                                        dr[i]["giuong"].ToString(), r["makp"].ToString() + ((bKhoa) ? " : " + r["ngay"].ToString() : ""), s_tenkp + ((bKhoa) ? " : " + r["ngay"].ToString() : ""), dr[i]["ngayvao"].ToString(), dr[i]["ngayra"].ToString(), dr[i]["chandoan"].ToString(), dr[i]["maicd"].ToString(), int.Parse(r2["sttnhom"].ToString()),
                                        r2["nhom"].ToString(), int.Parse(r2["sttloai"].ToString()), r2["loai"].ToString(), int.Parse(r["mabd"].ToString()),
                                        s_ten, r2["dvt"].ToString(), decimal.Parse(r["soluong"].ToString()),
                                        st2,
                                        decimal.Parse(r["bhyt"].ToString()), 0, decimal.Parse(r["bhytt0107"].ToString()), dr[i]["nguoinha"].ToString(), int.Parse(dr[i]["hinhthuc"].ToString()), int.Parse(dr[i]["phuongphap"].ToString()), int.Parse(dr[i]["ketqua"].ToString()), dr[i]["soluutru"].ToString(),
                                        dg2, bChitiet, int.Parse(dr[i]["done"].ToString()), dr[i]["mabs"].ToString(), dr[i]["tenbs"].ToString(), dr[i]["makp"].ToString(), dr[i]["cholam"].ToString(), i_madoituongvao, decimal.Parse(r["gianovat"].ToString()), decimal.Parse(r["idttrv"].ToString()), st2, int.Parse(dr[i]["traituyen"].ToString()), kythuat, r["mabs"].ToString(), (r["id_ktcao"].ToString() == null || r["id_ktcao"].ToString() == "") ? 0 : decimal.Parse(r["id_ktcao"].ToString()), 0, dKythuatcao_chitratoiday, 0, 0);
                                }
                                if (dr[i]["done"].ToString() == "0" && (r["toathuoc"].ToString() == "0" || r["toathuoc"].ToString() == ""))
                                {
                                    v.upd_thvpct(idvienphi, r["ngay"].ToString(), r["makp"].ToString(), i_madt, decimal.Parse(r["mabd"].ToString()), decimal.Parse(r["soluong"].ToString()), dg2, st2, 0, s_mmyy, s_sothe, int.Parse(r["traituyen"].ToString()), r["mabs"].ToString(), decimal.Parse(r["idtonghop"].ToString()), int.Parse(r["stttonghop"].ToString()));
                                    if (r["id_ktcao"].ToString() != "0") { execute_data(" update " + user + mmyy(s_ngay) + ".v_thvpct set id_ktcao=" + r["id_ktcao"].ToString() + " where id=" + idvienphi + " and mavp=" + long.Parse(r["mabd"].ToString()) + " and makp='" + r["makp"].ToString() + "'"); }
                                }
                            }
                            if (dg3 > 0) //if (dg3 != 0)
                            {
                                if (m_madoituong_inttrv == "" || m_madoituong_inttrv.IndexOf("," + dr[i]["madoituong"].ToString() + ",") >= 0)
                                {
                                    //binh 070611: do khi chon chuyen so lieu vp, nhung khong chon het doi tuong, chi chon 1 dtuong de in (thuong in lai)
                                    //Khi do SL chuyen xuong vp chi chuyen doi tuong duoc chon --> do do thieu so lieu
                                    //
                                    updrec_ravien(ds, dr[i]["mabn"].ToString(), dr[i]["mabn"].ToString(), decimal.Parse(dr[i]["maql"].ToString()), decimal.Parse(dr[i]["idkhoa"].ToString()), dr[i]["hoten"].ToString(), dr[i]["namsinh"].ToString(), dr[i]["phai"].ToString(),
                                        dr[i]["diachi"].ToString(), cl_doituong, cl_tendoituong, dr[i]["sothe"].ToString(), iBhyt, dr[i]["denngay"].ToString(), dr[i]["noigioithieu"].ToString(), s_noidk,
                                        dr[i]["giuong"].ToString(), r["makp"].ToString() + ((bKhoa) ? " : " + r["ngay"].ToString() : ""), s_tenkp + ((bKhoa) ? " : " + r["ngay"].ToString() : ""), dr[i]["ngayvao"].ToString(), dr[i]["ngayra"].ToString(), dr[i]["chandoan"].ToString(), dr[i]["maicd"].ToString(), int.Parse(r2["sttnhom"].ToString()),
                                        r2["nhom"].ToString(), int.Parse(r2["sttloai"].ToString()), r2["loai"].ToString(), int.Parse(r["mabd"].ToString()),
                                        cl_ten, r2["dvt"].ToString(), decimal.Parse(r["soluong"].ToString()),
                                        st3,
                                        decimal.Parse(r["bhyt"].ToString()), 0, decimal.Parse(r["bhytt0107"].ToString()), dr[i]["nguoinha"].ToString(), int.Parse(dr[i]["hinhthuc"].ToString()), int.Parse(dr[i]["phuongphap"].ToString()), int.Parse(dr[i]["ketqua"].ToString()), dr[i]["soluutru"].ToString(),
                                        dg3, bChitiet, int.Parse(dr[i]["done"].ToString()), dr[i]["mabs"].ToString(), dr[i]["tenbs"].ToString(), dr[i]["makp"].ToString(), dr[i]["cholam"].ToString(), i_madoituongvao, decimal.Parse(r["gianovat"].ToString()), decimal.Parse(r["idttrv"].ToString()), st3, int.Parse(dr[i]["traituyen"].ToString()), kythuat, r["mabs"].ToString(), (r["id_ktcao"].ToString() == null || r["id_ktcao"].ToString() == "") ? 0 : decimal.Parse(r["id_ktcao"].ToString()), 0, dKythuatcao_chitratoiday, 0, 0);
                                }
                                if (dr[i]["done"].ToString() == "0" && (r["toathuoc"].ToString() == "0" || r["toathuoc"].ToString() == ""))
                                {
                                    v.upd_thvpct(idvienphi, r["ngay"].ToString(), r["makp"].ToString(), cl_doituong, decimal.Parse(r["mabd"].ToString()), decimal.Parse(r["soluong"].ToString()), dg3, st3, 0, s_mmyy, s_sothe, int.Parse(r["traituyen"].ToString()), r["mabs"].ToString(), decimal.Parse(r["idtonghop"].ToString()), int.Parse(r["stttonghop"].ToString()));
                                    if (r["id_ktcao"].ToString() != "0") { execute_data(" update " + user + mmyy(s_ngay) + ".v_thvpct set id_ktcao=" + r["id_ktcao"].ToString() + " where id=" + idvienphi + " and mavp=" + long.Parse(r["mabd"].ToString()) + " and makp='" + r["makp"].ToString() + "'"); }
                                }
                            }
                            if (dr[i]["done"].ToString() == "0")
                            {
                                sotien += decimal.Parse(r["sotien"].ToString());
                                bhyt += decimal.Parse(r["bhyt"].ToString());
                            }
                        }
                    }
                }
                //ds.WriteXml("c:\\test_vp.xml", XmlWriteMode.WriteSchema);
                //}
                tmp = get_vienphi_ct(dr[i]["mabn"].ToString(), maql, idkhoa, dr[i]["ngayvao"].ToString(), dr[i]["ngayra"].ToString(),
                    (makp == "") ? "" : dr[i]["makp"].ToString(), int.Parse(dr[i]["madoituong"].ToString()),
                    int.Parse(dr[i]["done"].ToString()), maql_phongluu, bCapve, bNgtr, loaiba, bKhoa,
                    dr[i]["maso"].ToString(), bThanhtoan_N_Dot, dr[i]["idttrv"].ToString());
                if (tmp != null)
                {
                    //tmp.DataSet.WriteXml("c:\\test_vp.xml", XmlWriteMode.WriteSchema);
                    decimal a_stbhyt = 0, a_sotien = 0;
                    string s_sothe_huong_cpvc = "", s_loaithe_bn = "";
                    //gam 15/08/2011
                    string s_vitri_xet_chiphivanchuyen = d.thetunguyen_vitri(1);
                    int iKytubegin_xet_chiphivanchuyen = 0, ikytuend_xet_chiphivanchuyen = 0;
                    try
                    {
                        iKytubegin_xet_chiphivanchuyen = int.Parse(s_vitri_xet_chiphivanchuyen.Substring(0, 1));
                        ikytuend_xet_chiphivanchuyen = int.Parse(s_vitri_xet_chiphivanchuyen.Substring(2, 1));

                    }
                    catch
                    {
                        iKytubegin_xet_chiphivanchuyen = 0;
                        ikytuend_xet_chiphivanchuyen = 2;
                    }
                    //end gam
                    string s_mavp_congkham = f_get_mavp_congkham();
                    foreach (DataRow r in tmp.Select("", "sotien")) //foreach (DataRow r in tmp.Rows)
                    {
                        //nhap vien khong tin cong kham
                        if (bNhapvien_kocongkham && loaiba == 1 && s_mavp_congkham.Trim().Trim(',') != "")
                        {
                            s_mavp_congkham = "," + s_mavp_congkham.Trim().Trim(',') + ",";
                            if (s_mavp_congkham.IndexOf("," + r["mavp"].ToString() + ",") >= 0) continue;
                        }
                        //
                        DataRow rkp = getrowbyid(dtkpm, "makp='" + r["makp"].ToString() + "'");
                        if (rkp != null) s_tenkp = rkp["tenkp"].ToString().Trim();
                        else s_tenkp = dr[i]["tenkp"].ToString().Trim();
                        //
                        a_stbhyt = (r["bhyt"].ToString() == "") ? 0 : decimal.Parse(r["bhyt"].ToString());
                        a_sotien = (r["sotien"].ToString() == "") ? 0 : decimal.Parse(r["sotien"].ToString());
                        //
                        //s_sothe_huong_cpvc = ""; s_loaithe_bn = "";

                        if ((dr[i]["madoituong"].ToString() == "1" || dr[i]["sothe"].ToString().Trim().Length > iSokytuthe_xet_chiphivanchuyen))//gam 31/08/2011//if (s_loaithe_bn != "" && (dr[i]["madoituong"].ToString() == "1" || dr[i]["sothe"].ToString().Trim().Length > iSokytuthe_xet_chiphivanchuyen))//gam 31/08/2011
                        {
                            //s_loaithe_bn = dr[i]["sothe"].ToString().Substring(0, iSokytuthe_xet_chiphivanchuyen); //gam 15/08/2011 comment
                            s_loaithe_bn = dr[i]["sothe"].ToString().Substring(iKytubegin_xet_chiphivanchuyen, ikytuend_xet_chiphivanchuyen);
                        }
                        int i_mavpttt = int.Parse(r["mavp"].ToString());
                        r2 = getrowbyid(dtvp, "id=" + int.Parse(r["mavp"].ToString()));
                        if (r2 != null)
                        {
                            s_sothe_huong_cpvc = r2["sothe"].ToString().Trim().Trim(',') + ",";
                            if (dr[i]["done"].ToString() == "0" && (loaiba == 2 || idkhoa != 0 || bndot))
                            {
                                if (s_idthuoc.IndexOf(r["id"].ToString().Trim() + ",") == -1) s_idthuoc += r["id"].ToString().Trim() + ",";
                            }
                            iBhyt = (r2["bhyt"].ToString() == "") ? 0 : decimal.Parse(r2["bhyt"].ToString());
                            ngayduyet = ngay1 = ngay2 = ngay3 = ""; s_noidk = dr[i]["noicap"].ToString();
                            if (bBhyt)
                            {
                                r3 = dtbhyt.Select("maql=" + maql + " and den>=" + r["ngay"].ToString().Substring(6, 4) + r["ngay"].ToString().Substring(3, 2) + r["ngay"].ToString().Substring(0, 2), "den");
                                if (r3.Length > 0)
                                {
                                    s_tungay = r3[0]["tungay"].ToString();
                                    s_denngay = r3[0]["denngay"].ToString();
                                    s_sothe = r3[0]["sothe"].ToString();
                                    ngayduyet = r3[0]["ngayduyet"].ToString();
                                    s_noidk = r3[0]["tenbv"].ToString().Trim();
                                    if (bsothe_ngay_huong)
                                    {
                                        ngay1 = r3[0]["ngay1"].ToString().Trim();
                                        ngay2 = r3[0]["ngay2"].ToString().Trim();
                                        ngay3 = r3[0]["ngay3"].ToString().Trim();
                                    }
                                }
                            }
                            s_madt = dr[i]["madoituong"].ToString();
                            i_madt = (s_madt == "") ? 2 : int.Parse(s_madt);
                            s_dtuong = dr[i]["doituong"].ToString();
                            kythuat = (r2["kythuat"].ToString() == "") ? -1 : int.Parse(r2["kythuat"].ToString());
                            if (kythuat != -1 && i_madt == 1)
                            {
                                maphu = (dr[i]["sothe"].ToString().Trim() != "") ? d.get_maphu_noitru(dr[i]["sothe"].ToString(), nhom) : 0;
                                //if (maphu !=0)
                                //{
                                if (ngay1 + ngay2 + ngay3 != "")
                                {
                                    if ((!bNgay(r["ngay"].ToString(), ngay1) && kythuat == 0) ||
                                        (!bNgay(r["ngay"].ToString(), ngay2) && kythuat == 1) ||
                                        (!bNgay(r["ngay"].ToString(), ngay3) && kythuat == 2))
                                    {
                                        i_madt = i_tunguyen;
                                        r1 = getrowbyid(dtdt, "madoituong=" + i_madt);
                                        if (r1 != null) s_dtuong = r1["doituong"].ToString();
                                        kythuat = -1;
                                    }
                                }
                            }
                            cl_ten = s_ten = r2["ten"].ToString();
                            f1 = "th"; f2 = "th";
                            dongia = (r["dongia"].ToString().Trim() == "") ? 0 : decimal.Parse(r["dongia"].ToString());
                            dg1 = dongia;
                            dg2 = st2 = dg3 = st3 = 0;
                            st1 = (r["sotien"].ToString().Trim() == "") ? 0 : decimal.Parse(r["sotien"].ToString()); ;
                            sql = (bChenhlech_dt) ? "madoituong=" + i_madoituongvao : "madoituong=" + i_madt;
                            r1 = getrowbyid(dtdt, sql);
                            if (r1 != null) f1 = r1["field_gia"].ToString().Trim().Substring(r1["field_gia"].ToString().Trim().IndexOf("_") + 1);
                            sql = (bChenhlech_dt) ? "madoituong=" + i_madt : "madoituong=" + i_tunguyen;
                            r1 = getrowbyid(dtdt, sql);
                            if (r1 != null) f2 = r1["field_gia"].ToString().Trim().Substring(r1["field_gia"].ToString().Trim().IndexOf("_") + 1);
                            //tien chi phi van chuyen dua theo the duoc huong - 12/02/2011
                            if (i_madt == 1 && s_loaithe_bn != "" && s_sothe_huong_cpvc.Trim().Trim(',') != "" && s_sothe_huong_cpvc.IndexOf(s_loaithe_bn + ",") < 0)
                            {
                                //BHYT - the khong duoc huong CP Van chuyen
                                i_madt = i_tunguyen;
                                r1 = getrowbyid(dtdt, "madoituong=" + i_madt);
                                if (r1 != null) s_dtuong = r1["doituong"].ToString();
                                get_dongia(decimal.Parse(r["mavp"].ToString()), i_madt.ToString(), r["ngay"].ToString(), false);
                                dg1 = d_dongia + d_vattu;
                                st1 = (r["soluong"].ToString() == "" ? 0 : decimal.Parse(r["soluong"].ToString())) * dg1;
                            }
                            //
                            #region chenhlech
                            bDenngay = true; bTungay = true;
                            string s_tenktcao_chung = "";
                            bCont = i_madt == 1 && bChenhlechdv && r2["chenhlech"].ToString() == "1";//&& !bthutienlien;// bChenhlechdv && r2["chenhlech"].ToString() == "1" && !bthutienlien;
                            if (bCont && !bChenhlech_dt) bCont = bCont && int.Parse(dr[i]["madoituong"].ToString()) == i_madoituongvao;
                            bCont = bCont && r["dachenhlech"].ToString() == "0";
                            if (bCont)
                            {
                                if (s_denngay.Trim().Length == 10) bDenngay = bNgay(s_denngay, r["ngay"].ToString().Substring(0, 10));
                                if (s_tungay.Trim().Length == 10) bTungay = bNgay(r["ngay"].ToString().Substring(0, 10), s_tungay);
                                bCont = s_chenhlech.IndexOf(i_madoituongvao.ToString().Trim() + ",") != -1
                                        && decimal.Parse(r2["gia_" + f1.Trim()].ToString()) <= decimal.Parse(r2["gia_" + f2.Trim()].ToString());
                                if (bChenhlech_dt) bCont = bCont && (s_madt == i_tunguyen.ToString().Trim() || s_madt == "1");
                                //else bCont = bCont && (ngayduyet == "" || !bNgay((ngayduyet == "") ? r["ngay"].ToString() : ngayduyet, r["ngay"].ToString()));//bbb
                                if (i_madoituongvao == 1) bCont = bCont && (decimal.Parse(r2["bhyt"].ToString()) > 0);
                                bCont = bCont && bTungay && bDenngay;
                                if (bCont)
                                {
                                    i_madt = i_madoituongvao;
                                    r1 = getrowbyid(dtdt, "madoituong=" + i_madt);
                                    if (r1 != null) s_dtuong = r1["doituong"].ToString();
                                    //dg1 = decimal.Parse(r2["gia_" + f1.Trim()].ToString()) + decimal.Parse(r2["vattu_" + f1.Trim()].ToString());
                                    d_dongia = dongia;//gam 23/02/2012
                                    get_dongia(decimal.Parse(r["mavp"].ToString()), i_madt.ToString(), r["ngay"].ToString(), true);//gam 25/02/2012 vì đối tượng BHYT lấy theo giá v_chidinh hoac v_vpkhoa. Phụ sản bình dương tính tiền giường khác giá khai o v_giavp.
                                    dg1 = d_dongia + d_vattu;
                                    st1 = (r["soluong"].ToString() == "" ? 0 : decimal.Parse(r["soluong"].ToString())) * dg1;
                                }
                                else if (s_madt == "1" && a_sotien > 0 && a_sotien != a_stbhyt) //else if (s_madt == "1" && decimal.Parse(r["sotien"].ToString()) != decimal.Parse(r["bhyt"].ToString()))
                                {
                                    s_ten += " BHYT thanh toán " + r2["bhyt"].ToString().Trim() + " %";
                                    dg1 = dongia * decimal.Parse(r2["bhyt"].ToString()) / 100;
                                    st1 = decimal.Parse(r["bhyt"].ToString());
                                }
                            }
                            else if (s_madt == "1" && a_stbhyt > 0 && st1 > 0 && st1 != a_stbhyt)//if (s_madt == "1" && decimal.Parse(r["bhyt"].ToString()) >0 && decimal.Parse(r["sotien"].ToString()) != decimal.Parse(r["bhyt"].ToString()))
                            {
                                s_ten += " BHYT thanh toán " + r2["bhyt"].ToString().Trim() + " %";
                                dg1 = dongia * decimal.Parse(r2["bhyt"].ToString() == "" ? "0" : r2["bhyt"].ToString()) / 100;
                                st1 = a_stbhyt;// decimal.Parse(r["bhyt"].ToString());
                            }
                            else if (s_madt == "1" && r2["kcct"].ToString() == "1")
                            {
                                s_ten += " BHYT thanh toán " + r2["bhyt"].ToString().Trim() + " %";
                                dg1 = dongia * decimal.Parse(r2["bhyt"].ToString() == "" ? "0" : r2["bhyt"].ToString()) / 100;
                                st1 = a_stbhyt;//decimal.Parse(r["bhyt"].ToString());
                            }
                            //
                            s_tenktcao_chung = "Tổng chi phí của dịch vụ kỹ thuật cao: " + s_ten;
                            if (r["tylegiam"].ToString().Trim() != "" && decimal.Parse(r["tylegiam"].ToString()) > 0)
                            {
                                s_ten += " - Giảm " + Math.Round(decimal.Parse(r["tylegiam"].ToString()), 0).ToString() + "%";
                            }
                            //
                            #endregion
                            #region muc dich vu ky thuat cao
                            dg1k = dg2k = st1k = st2k = 0;
                            if (bKythuatcao_chitratoiday && kythuat != -1 && i_madt == 1)
                            {
                                //khong tinh theo cong van BHYT nam 2009: chi phi KTC chi tinh 60% khi vuot qua 20 trieu
                                //Ma tinh dua tren 40thang luong toi thieu: vuot qua: chi tra 40thang luong, duoi thi tinh nhu binh thuong
                                mucbhquidinh = dKythuatcao_chitratoiday;
                                muckhongqua = dKythuatcao_chitratoiday;
                                phantrambhyt = 100;
                            }
                            if (kythuat == 0 && i_madt == 1) tongstktc += st1;
                            int vuottran = 0;
                            decimal tLchitraktcao = 0;
                            if (kythuat != -1 && i_madt == 1 && tongstktc > mucbhquidinh) //if (kythuat != -1 && i_madt == 1 && st1 > mucbhquidinh)
                            {
                                //ThanhCuong - 06/08/2012 - Kỹ thuật cao
                                decimal i_tt_ktcao = 0;
                                if (bktCao_ttDV)
                                {
                                    //s_tenktcao_chung = "Tổng chi phí của dịch vụ kỹ thuật cao: " + s_ten;
                                    i_tt_ktcao += decimal.Parse(r["sotien"].ToString());
                                    if (m_madoituong_inttrv == "" || m_madoituong_inttrv.IndexOf("," + dr[i]["madoituong"].ToString() + ",") >= 0)
                                    {
                                        updrec_ravien(ds, dr[i]["mabn"].ToString(), dr[i]["mabn"].ToString(), decimal.Parse(dr[i]["maql"].ToString()), decimal.Parse(dr[i]["idkhoa"].ToString()), dr[i]["hoten"].ToString(), dr[i]["namsinh"].ToString(), dr[i]["phai"].ToString(),
                                            dr[i]["diachi"].ToString(), i_madt, s_dtuong, s_sothe, iBhyt, s_tungay + "^" + s_denngay, dr[i]["noigioithieu"].ToString(), s_noidk,
                                            dr[i]["giuong"].ToString(), r["makp"].ToString() + ((bKhoa) ? " : " + r["ngay"].ToString() : ""), s_tenkp + ((bKhoa) ? " : " + r["ngay"].ToString() : ""), dr[i]["ngayvao"].ToString(), dr[i]["ngayra"].ToString(), dr[i]["chandoan"].ToString(), dr[i]["maicd"].ToString(), int.Parse(r2["sttnhom"].ToString()),
                                            r2["nhom"].ToString(), int.Parse(r2["sttloai"].ToString()), r2["loai"].ToString(), int.Parse(r["mavp"].ToString()),
                                            s_ten, r2["dvt"].ToString(), decimal.Parse(r["soluong"].ToString()),
                                            0,
                                            0, (bCont) ? 0 : tamung, decimal.Parse(r["bhytt0107"].ToString()), dr[i]["nguoinha"].ToString(), int.Parse(dr[i]["hinhthuc"].ToString()), int.Parse(dr[i]["phuongphap"].ToString()), int.Parse(dr[i]["ketqua"].ToString()), dr[i]["soluutru"].ToString(),
                                            dg1, bChitiet, int.Parse(dr[i]["done"].ToString()), dr[i]["mabs"].ToString(), dr[i]["tenbs"].ToString(), dr[i]["makp"].ToString(), dr[i]["cholam"].ToString(), i_madoituongvao, dg1k, decimal.Parse(r["idttrv"].ToString()), 0, int.Parse(dr[i]["traituyen"].ToString()), kythuat, r["mabs"].ToString(), decimal.Parse(r["id_vpkhoa"].ToString()), 0, dKythuatcao_chitratoiday, 0, 0);
                                    }
                                    if (dr[i]["done"].ToString() == "0" && (r["toathuoc"].ToString() == "0" || r["toathuoc"].ToString() == ""))
                                    {
                                        v.upd_thvpct(idvienphi, r["ngay"].ToString(), r["makp"].ToString(), i_madt, decimal.Parse(r["mavp"].ToString()), decimal.Parse(r["soluong"].ToString()), dg1, 0, (r["vattu"].ToString().Trim() == "") ? 0 : decimal.Parse(r["vattu"].ToString()), s_mmyy, s_sothe, int.Parse(r["traituyen"].ToString()), r["mabs"].ToString(), decimal.Parse(r["idtonghop"].ToString()), int.Parse(r["stttonghop"].ToString()));
                                        execute_data(" update " + user + mmyy(s_ngay) + ".v_thvpct set ktcao=1,id_ktcao=" + decimal.Parse(r["id_vpkhoa"].ToString()) + " where id=" + idvienphi + " and mavp=" + long.Parse(r["mavp"].ToString()) + " and makp='" + r["makp"].ToString() + "' and to_char(ngay,'dd/mm/yyyy')='" + r["ngay"].ToString() + "' and madoituong=" + i_madt + " and dongia=" + dg1);
                                    }
                                    if (tmpthuoc.Rows.Count > 0)
                                    {
                                        foreach (DataRow rr3 in tmpthuoc.Select("id_ktcao>0"))
                                        {
                                            if (r["id_vpkhoa"].ToString() == rr3["id_ktcao"].ToString())
                                            {
                                                DataRow rr2;
                                                rr2 = getrowbyid(dtbd, "id=" + int.Parse(rr3["mabd"].ToString()));
                                                if (rr2 != null)
                                                {
                                                    if (dr[i]["done"].ToString() == "0" && (loaiba == 2 || idkhoa != 0 || bndot))
                                                    {
                                                        if (s_idthuoc.IndexOf(rr3["id"].ToString().Trim() + ",") == -1) s_idthuoc += rr3["id"].ToString().Trim() + ",";
                                                    }
                                                    ngayduyet = ""; s_noidk = dr[i]["noicap"].ToString();
                                                    iBhyt = decimal.Parse(r2["bhyt"].ToString());
                                                    if (bBhyt)
                                                    {
                                                        r3 = dtbhyt.Select("maql=" + maql + " and den>=" + rr3["ngay"].ToString().Substring(6, 4) + rr3["ngay"].ToString().Substring(3, 2) + rr3["ngay"].ToString().Substring(0, 2), "den");
                                                        if (r3.Length > 0)
                                                        {
                                                            s_tungay = r3[0]["tungay"].ToString();
                                                            s_denngay = r3[0]["denngay"].ToString();
                                                            s_sothe = r3[0]["sothe"].ToString();
                                                            ngayduyet = r3[0]["ngayduyet"].ToString();
                                                            s_noidk = r3[0]["tenbv"].ToString();
                                                        }
                                                    }
                                                    DataRow rkp1 = getrowbyid(dtkpm, "makp='" + rr3["makp"].ToString() + "'");
                                                    if (rkp1 != null) s_tenkp = rkp1["tenkp"].ToString().Trim();
                                                    else if (rr3["makp"].ToString() != "")
                                                    {
                                                        rkp1 = getrowbyid(dtkpd, "id=" + int.Parse(rr3["makp"].ToString()));
                                                        if (rkp1 != null) s_tenkp = rkp1["ten"].ToString();
                                                    }
                                                    else s_tenkp = dr[i]["tenkp"].ToString().Trim();
                                                    s_madt = dr[i]["madoituong"].ToString().Trim();
                                                    i_madt = int.Parse(s_madt);
                                                    s_dtuong = dr[i]["doituong"].ToString();
                                                    s_ten = cl_ten = rr2["ten"].ToString();
                                                    dongia = decimal.Parse(rr3["dongia"].ToString());
                                                    st1 = decimal.Parse(rr3["soluong"].ToString()) * dongia;
                                                    //bCont = bChenhlechdv && bchenhlech_thuoc;

                                                    //iBhyt = (s_madt == "1") ? get_bhyt(dtbdfull, decimal.Parse(rr3["mabd"].ToString()), rr3["ngay"].ToString()) : 0;

                                                    //dg2 = st2 = dg3 = st3 = 0;
                                                    //giamua = decimal.Parse(rr3["giamua"].ToString());
                                                    //
                                                    i_tt_ktcao += decimal.Parse(rr3["sotien"].ToString());
                                                    //
                                                    //giaban = decimal.Parse(rr3["giaban"].ToString());
                                                    //bDenngay = true; bTungay = true;
                                                    kythuat = (rr2["kythuat"].ToString() == "") ? -1 : int.Parse(rr2["kythuat"].ToString());
                                                    //if (bchenhlech_thuoc_dannhmuc) bCont = bCont && rr2["chenhlech"].ToString() == "1";
                                                    //if (!bChenhlech_dt) bCont = bCont && int.Parse(dr[i]["madoituong"].ToString()) == i_madoituongvao;
                                                    //if (s_chenhlech.IndexOf(i_madoituongvao.ToString().Trim() + ",") != -1 && bgia_bh_quydinh && bchenhlech_thuoc_dannhmuc && bCont && rr2["chenhlech"].ToString() == "0")
                                                    //{
                                                    //    //dongia = (decimal.Parse(r2["gia_bh"].ToString()) > 0 && decimal.Parse(r2["gia_bh"].ToString()) <= decimal.Parse(r["giamua"].ToString())) ? decimal.Parse(r2["gia_bh"].ToString()) : decimal.Parse(r["giamua"].ToString());//decimal.Parse(r2["gia_bh"].ToString());
                                                    //    dongia = (decimal.Parse(rr3["gia_bh"].ToString()) > 0 && decimal.Parse(rr3["gia_bh"].ToString()) <= decimal.Parse(rr3["giamua"].ToString())) ? decimal.Parse(rr3["gia_bh"].ToString()) : decimal.Parse(rr3["giamua"].ToString());
                                                    //    st1 = decimal.Parse(rr3["soluong"].ToString()) * dongia;
                                                    //}
                                                    //else st1 = decimal.Parse(rr3["sotien"].ToString());
                                                    dg1 = dongia;
                                                    //if (bCont)
                                                    //{
                                                    //    if (s_denngay.Trim().Length == 10) bDenngay = bNgay(s_denngay, rr3["ngay"].ToString().Substring(0, 10));
                                                    //    if (s_tungay.Trim().Length == 10) bTungay = bNgay(rr3["ngay"].ToString().Substring(0, 10), s_tungay);
                                                    //    bCont = s_chenhlech.IndexOf(i_madoituongvao.ToString().Trim() + ",") != -1;
                                                    //    if (!bgia_bh_quydinh_giamua) bCont = bCont && rr3["loai"].ToString().Trim() == "1";
                                                    //    if (i_madoituongvao == 1) bCont = bCont && (decimal.Parse(rr2["bhyt"].ToString()) > 0);
                                                    //    if (bgia_bh_quydinh && bCont)
                                                    //    {
                                                    //        if (!bLayGiabhyt_giamua)
                                                    //        {
                                                    //            //giaban = giamua; //gam 24/09/2011 lấy giá bán để tính chênh lệch
                                                    //            giamua = decimal.Parse(rr3["gia_bh"].ToString() == "" ? "0" : rr3["gia_bh"].ToString());//giamua = decimal.Parse(r2["gia_bh"].ToString());//luon lay gia BHYT
                                                    //            dg1 = dongia = giamua;
                                                    //            st1 = decimal.Parse(rr3["soluong"].ToString()) * dg1;
                                                    //        }
                                                    //        else
                                                    //        {
                                                    //            if (bgia_bh_quydinh_giamua)
                                                    //            {
                                                    //                //giaban = giamua;//gam 24/09/2011 lấy giá bán để tính chênh lệch
                                                    //                giamua = (decimal.Parse(rr3["gia_bh"].ToString()) > 0 || decimal.Parse(rr3["gia_bh"].ToString()) <= decimal.Parse(rr3["giamua"].ToString())) ? decimal.Parse(rr3["gia_bh"].ToString()) : decimal.Parse(rr3["giamua"].ToString()); //giamua = (decimal.Parse(r2["gia_bh"].ToString()) > 0 || decimal.Parse(r2["gia_bh"].ToString()) <= decimal.Parse(r["giamua"].ToString())) ? decimal.Parse(r2["gia_bh"].ToString()) : decimal.Parse(r["giamua"].ToString());
                                                    //                if (giamua == 0 || Math.Floor(giaban) <= Math.Floor(giamua))
                                                    //                {
                                                    //                    dg1 = dongia = giamua = giaban;
                                                    //                    st1 = decimal.Parse(rr3["soluong"].ToString()) * dg1;
                                                    //                }
                                                    //            }
                                                    //            else
                                                    //            {
                                                    //                giamua = (decimal.Parse(rr3["gia_bh"].ToString()) > 0 && decimal.Parse(rr3["gia_bh"].ToString()) <= decimal.Parse(rr3["giamua"].ToString())) ? decimal.Parse(rr3["gia_bh"].ToString()) : decimal.Parse(rr3["giamua"].ToString()); //giamua = (decimal.Parse(r2["gia_bh"].ToString()) > 0 && decimal.Parse(r2["gia_bh"].ToString()) <= decimal.Parse(r["giamua"].ToString())) ? decimal.Parse(r2["gia_bh"].ToString()) : decimal.Parse(r["giamua"].ToString()); //decimal.Parse(r2["gia_bh"].ToString());

                                                    //            }
                                                    //        }
                                                    //    }
                                                    //    bCont = bCont && Math.Floor(giaban) != Math.Floor(giamua);
                                                    //    if (bChenhlech_dt) bCont = bCont && (s_madt == i_tunguyen.ToString().Trim());
                                                    //    //else bCont = bCont && (ngayduyet == "" || !bNgay((ngayduyet=="")?r["ngay"].ToString():ngayduyet, r["ngay"].ToString()));//bbb
                                                    //    bCont = bCont && bTungay && bDenngay;
                                                    //    if (bCont)//chenh lech
                                                    //    {
                                                    //        i_madt = i_madoituongvao;
                                                    //        r1 = getrowbyid(dtdt, "madoituong=" + i_madt);
                                                    //        if (r1 != null) s_dtuong = r1["doituong"].ToString();

                                                    //        dg1 = giamua;
                                                    //        st1 = decimal.Parse(rr3["soluong"].ToString()) * dg1;
                                                    //    }
                                                    //    else if (s_madt == "1" && decimal.Parse(rr3["sotien"].ToString()) != decimal.Parse(rr3["bhyt"].ToString()))//dich vu bhyt thanh toan 1 phan
                                                    //    {
                                                    //        s_ten += " BHYT thanh toán " + rr2["bhyt"].ToString().Trim() + " %";
                                                    //        dg1 = dongia * decimal.Parse(rr2["bhyt"].ToString()) / 100;
                                                    //        st1 = decimal.Parse(rr3["bhyt"].ToString());
                                                    //    }
                                                    //}
                                                    //else if (s_madt == "1" && decimal.Parse(rr3["bhyt"].ToString()) > 0 && decimal.Parse(rr3["sotien"].ToString()) != decimal.Parse(rr3["bhyt"].ToString()))
                                                    //{
                                                    //    s_ten += " BHYT thanh toán " + rr2["bhyt"].ToString().Trim() + " %";
                                                    //    dg1 = dongia * decimal.Parse(rr2["bhyt"].ToString()) / 100;
                                                    //    st1 = decimal.Parse(rr3["bhyt"].ToString());
                                                    //}
                                                    //else if (s_madt == "1" && rr2["kcct"].ToString() == "1")
                                                    //{
                                                    //    s_ten += " BHYT thanh toán " + rr2["bhyt"].ToString().Trim() + " %";
                                                    //}
                                                    if (m_madoituong_inttrv == "" || m_madoituong_inttrv.IndexOf("," + dr[i]["madoituong"].ToString() + ",") >= 0)
                                                    {
                                                        updrec_ravien(ds, dr[i]["mabn"].ToString(), dr[i]["mabn"].ToString(), decimal.Parse(dr[i]["maql"].ToString()), decimal.Parse(dr[i]["idkhoa"].ToString()), dr[i]["hoten"].ToString(), dr[i]["namsinh"].ToString(), dr[i]["phai"].ToString(),
                                                            dr[i]["diachi"].ToString(), i_madt, s_dtuong, s_sothe, iBhyt, s_tungay + "^" + s_denngay, dr[i]["noigioithieu"].ToString(), s_noidk,
                                                            dr[i]["giuong"].ToString(), rr3["makp"].ToString() + ((bKhoa) ? " : " + rr3["ngay"].ToString() : ""), s_tenkp + ((bKhoa) ? " : " + rr3["ngay"].ToString() : ""), dr[i]["ngayvao"].ToString(), dr[i]["ngayra"].ToString(), dr[i]["chandoan"].ToString(), dr[i]["maicd"].ToString(), int.Parse(rr2["sttnhom"].ToString()),
                                                            rr2["nhom"].ToString(), int.Parse(rr2["sttloai"].ToString()), rr2["loai"].ToString(), int.Parse(rr3["mabd"].ToString()),
                                                            s_ten, rr2["dvt"].ToString(), decimal.Parse(rr3["soluong"].ToString()),
                                                            0,
                                                            0, (bCont) ? 0 : tamung, decimal.Parse(rr3["bhytt0107"].ToString()), dr[i]["nguoinha"].ToString(), int.Parse(dr[i]["hinhthuc"].ToString()), int.Parse(dr[i]["phuongphap"].ToString()), int.Parse(dr[i]["ketqua"].ToString()), dr[i]["soluutru"].ToString(),
                                                            dg1, bChitiet, int.Parse(dr[i]["done"].ToString()), dr[i]["mabs"].ToString(), dr[i]["tenbs"].ToString(), dr[i]["makp"].ToString(), dr[i]["cholam"].ToString(), i_madoituongvao, 0, decimal.Parse(rr3["idttrv"].ToString()), 0, int.Parse(dr[i]["traituyen"].ToString()), kythuat, rr3["mabs"].ToString(), (rr3["id_ktcao"].ToString() == null || rr3["id_ktcao"].ToString() == "") ? 0 : decimal.Parse(rr3["id_ktcao"].ToString()), 0, dKythuatcao_chitratoiday, 0, 0);
                                                    }
                                                    if (dr[i]["done"].ToString() == "0" && (r["toathuoc"].ToString() == "0" || r["toathuoc"].ToString() == ""))
                                                    {
                                                        v.upd_thvpct(idvienphi, rr3["ngay"].ToString(), rr3["makp"].ToString(), i_madt, decimal.Parse(rr3["mabd"].ToString()), decimal.Parse(rr3["soluong"].ToString()), dg1, 0, 0, s_mmyy, s_sothe, int.Parse(rr3["traituyen"].ToString()), rr3["mabs"].ToString(), decimal.Parse(rr3["idtonghop"].ToString()), int.Parse(rr3["stttonghop"].ToString()));
                                                        execute_data(" update " + user + mmyy(s_ngay) + ".v_thvpct set ktcao=1,id_ktcao=" + rr3["id_ktcao"].ToString() + " where id=" + idvienphi + " and mavp=" + long.Parse(rr3["mabd"].ToString()) + " and makp='" + rr3["makp"].ToString() + "' and to_char(ngay,'dd/mm/yyyy')='" + rr3["ngay"].ToString() + "' and madoituong=" + i_madt + " and dongia=" + dg1);
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    kythuat = 0;
                                }
                                //
                                st1k = st1; dg1k = dg1;
                                if (bktCao_ttDV)
                                {
                                    st1k = i_tt_ktcao; dg1k = i_tt_ktcao;
                                }
                                if (maphu >= 0)
                                {
                                    if (bktCao_ttDV)
                                    {
                                        nhom1 = d.get_nhom_ktcao(dr[i]["sothe"].ToString(), cc1_te1, nhom);
                                        if (!nhom1)
                                        {
                                            if (i_tt_ktcao > 0)
                                            {
                                                tongstktc = i_tt_ktcao;
                                                nhom2 = d.get_nhom_ktcao(dr[i]["sothe"].ToString(), ck2_ca3, nhom);
                                                if (nhom2)// && tongstktc > muckhongqua)
                                                {
                                                    tLchitraktcao = 100;
                                                    if (bktCao_ttDV)
                                                    {
                                                        st1 = st1k; dg1 = dg1k;
                                                    }
                                                    if (tongstktc > muckhongqua)
                                                    {
                                                        st1k = muckhongqua;
                                                        dg1k = st1k / decimal.Parse(r["soluong"].ToString());
                                                        st2k = tongstktc - st1k;
                                                        dg2k = st2k / decimal.Parse(r["soluong"].ToString());
                                                        vuottran = 1;
                                                        //bCLktcao = true;
                                                    }
                                                    else
                                                    {
                                                        st1k = tongstktc;
                                                        dg1k = st1k / decimal.Parse(r["soluong"].ToString());
                                                        st2k = 0;
                                                        dg2k = 0;
                                                        vuottran = 0;
                                                        //bCLktcao = false;
                                                    }
                                                }
                                                else if (d.get_nhom(dr[i]["sothe"].ToString(), bt4_hn4_ht5, nhom))
                                                {
                                                    tLchitraktcao = 95;
                                                    if (tongstktc <= muckhongqua)
                                                    {
                                                        st1k = st1;
                                                        dg1k = dg1;
                                                        st2k = 0;
                                                        dg2k = 0;
                                                        vuottran = 0;
                                                        //bCLktcao = false;
                                                    }
                                                    else if (tongstktc > muckhongqua)
                                                    {
                                                        decimal tmpst = st1;
                                                        st1k = Math.Round(muckhongqua, 0);
                                                        dg1k = Math.Round(st1k / decimal.Parse(r["soluong"].ToString()), 3);
                                                        st2k = tmpst - st1k;
                                                        dg2k = Math.Round(st2k / decimal.Parse(r["soluong"].ToString()), 3);
                                                        vuottran = 1;
                                                        //bCLktcao = true;
                                                    }
                                                }
                                                else
                                                {
                                                    //thanhcuong
                                                    tLchitraktcao = phantrambhyt;
                                                    if (bktCao_ttDV)
                                                    {
                                                        st1 = st1k; dg1 = dg1k;
                                                    }
                                                    if (tongstktc <= muckhongqua)
                                                    {
                                                        st1k = st1;
                                                        dg1k = dg1;
                                                        st2k = 0;
                                                        dg2k = 0;
                                                        vuottran = 0;
                                                        //bCLktcao = false;
                                                    }
                                                    else if (tongstktc > muckhongqua)
                                                    {
                                                        decimal tmpst = st1;
                                                        st1k = Math.Round(muckhongqua, 0);
                                                        dg1k = Math.Round(st1k / decimal.Parse(r["soluong"].ToString()), 3);
                                                        st2k = tmpst - st1k;
                                                        dg2k = Math.Round(st2k / decimal.Parse(r["soluong"].ToString()), 3);
                                                        vuottran = 1;
                                                        //bCLktcao = true;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    else
                                    {
                                        nhom1 = d.get_nhom(dr[i]["sothe"].ToString(), huong100, nhom);
                                        if (!nhom1)
                                        {
                                            nhom2 = d.get_nhom(dr[i]["sothe"].ToString(), huong100kqua, nhom);
                                            if (nhom2 && tongstktc > muckhongqua)//if (nhom2 && st1>muckhongqua)
                                            {
                                                st1k = muckhongqua - (tongstktc - st1);//muckhongqua;
                                                dg1k = st1k / decimal.Parse(r["soluong"].ToString());
                                                st2k = tongstktc - st1k - (tongstktc - st1);//st1 - st1k;
                                                dg2k = st2k / decimal.Parse(r["soluong"].ToString());
                                            }
                                            else
                                            {
                                                st = tongstktc * phantrambhyt / 100; //st = st1 * phantrambhyt / 100;
                                                if (st < mucbhquidinh)
                                                {
                                                    st1k = mucbhquidinh - (tongstktc - st1);//mucbhquidinh
                                                    dg1k = st1k / decimal.Parse(r["soluong"].ToString());
                                                    st2k = tongstktc - st1k - (tongstktc - st1);//st1 - st1k;
                                                    dg2k = st2k / decimal.Parse(r["soluong"].ToString());
                                                }
                                                else if (st > muckhongqua)
                                                {
                                                    st1k = muckhongqua - (tongstktc - st1);//muckhongqua
                                                    dg1k = st1k / decimal.Parse(r["soluong"].ToString());
                                                    st2k = tongstktc - st1k - (tongstktc - st1); // st1 - st1k;
                                                    dg2k = st2k / decimal.Parse(r["soluong"].ToString());
                                                }
                                                else
                                                {
                                                    st1k = tongstktc * phantrambhyt / 100 - (tongstktc - st1);//st1 * phantrambhyt / 100;
                                                    dg1k = st1k / decimal.Parse(r["soluong"].ToString());
                                                    st2k = tongstktc - st1k - (tongstktc - st1);// st1 - st1k;
                                                    dg2k = st2k / decimal.Parse(r["soluong"].ToString());
                                                }
                                            }
                                        }
                                    }
                                }
                                else
                                {
                                    st = tongstktc * ((maphu == 1) ? 80 : (maphu == 2) ? 95 : 100) / 100;//st1 * ((maphu == 1) ? 80 : (maphu == 2) ? 95 : 100) / 100;
                                    if (st > muckhongqua)
                                    {
                                        st1k = muckhongqua * ((maphu == 1) ? 80 : (maphu == 2) ? 95 : 100) / 100;
                                        dg1k = st1k / decimal.Parse(r["soluong"].ToString());
                                        st2k = st1 - st1k;
                                        dg2k = st2k / decimal.Parse(r["soluong"].ToString());
                                    }
                                }
                                if (m_madoituong_inttrv == "" || m_madoituong_inttrv.IndexOf("," + dr[i]["madoituong"].ToString() + ",") >= 0)
                                {
                                    //binh 070611: do khi chon chuyen so lieu vp, nhung khong chon het doi tuong, chi chon 1 dtuong de in (thuong in lai)
                                    //Khi do SL chuyen xuong vp chi chuyen doi tuong duoc chon --> do do thieu so lieu
                                    //
                                    if (bktCao_ttDV)
                                    {
                                        updrec_ravien(ds, dr[i]["mabn"].ToString(), dr[i]["mabn"].ToString(), decimal.Parse(dr[i]["maql"].ToString()), decimal.Parse(dr[i]["idkhoa"].ToString()), dr[i]["hoten"].ToString(), dr[i]["namsinh"].ToString(), dr[i]["phai"].ToString(),
                                        dr[i]["diachi"].ToString(), i_madt, s_dtuong, s_sothe, iBhyt, s_tungay + "^" + s_denngay, dr[i]["noigioithieu"].ToString(), s_noidk,
                                        dr[i]["giuong"].ToString(), r["makp"].ToString() + ((bKhoa) ? " : " + r["ngay"].ToString() : ""), s_tenkp + ((bKhoa) ? " : " + r["ngay"].ToString() : ""), dr[i]["ngayvao"].ToString(), dr[i]["ngayra"].ToString(), dr[i]["chandoan"].ToString(), dr[i]["maicd"].ToString(), int.Parse(r2["sttnhom"].ToString()),
                                        r2["nhom"].ToString(), int.Parse(r2["sttloai"].ToString()), r2["loai"].ToString(), int.Parse(r["mavp"].ToString()),
                                        s_tenktcao_chung, r2["dvt"].ToString(), decimal.Parse(r["soluong"].ToString()),
                                        st1k,
                                        st1k, (bCont) ? 0 : tamung, decimal.Parse(r["bhytt0107"].ToString()), dr[i]["nguoinha"].ToString(), int.Parse(dr[i]["hinhthuc"].ToString()), int.Parse(dr[i]["phuongphap"].ToString()), int.Parse(dr[i]["ketqua"].ToString()), dr[i]["soluutru"].ToString(),
                                        dg1k, bChitiet, int.Parse(dr[i]["done"].ToString()), dr[i]["mabs"].ToString(), dr[i]["tenbs"].ToString(), dr[i]["makp"].ToString(), dr[i]["cholam"].ToString(), i_madoituongvao, dg1k, decimal.Parse(r["idttrv"].ToString()), st1k, int.Parse(dr[i]["traituyen"].ToString()), kythuat, r["mabs"].ToString(), 0, 0, dKythuatcao_chitratoiday, (r["id_vpkhoa"].ToString() == null || r["id_vpkhoa"].ToString() == "") ? 0 : decimal.Parse(r["id_vpkhoa"].ToString()), tLchitraktcao);
                                    }
                                    else
                                    {
                                        updrec_ravien(ds, dr[i]["mabn"].ToString(), dr[i]["mabn"].ToString(), decimal.Parse(dr[i]["maql"].ToString()), decimal.Parse(dr[i]["idkhoa"].ToString()), dr[i]["hoten"].ToString(), dr[i]["namsinh"].ToString(), dr[i]["phai"].ToString(),
                                       dr[i]["diachi"].ToString(), i_madt, s_dtuong, s_sothe, iBhyt, s_tungay + "^" + s_denngay, dr[i]["noigioithieu"].ToString(), s_noidk,
                                       dr[i]["giuong"].ToString(), r["makp"].ToString() + ((bKhoa) ? " : " + r["ngay"].ToString() : ""), s_tenkp + ((bKhoa) ? " : " + r["ngay"].ToString() : ""), dr[i]["ngayvao"].ToString(), dr[i]["ngayra"].ToString(), dr[i]["chandoan"].ToString(), dr[i]["maicd"].ToString(), int.Parse(r2["sttnhom"].ToString()),
                                       r2["nhom"].ToString(), int.Parse(r2["sttloai"].ToString()), r2["loai"].ToString(), int.Parse(r["mavp"].ToString()),
                                       s_tenktcao_chung, r2["dvt"].ToString(), decimal.Parse(r["soluong"].ToString()),
                                       st1k,
                                       st1k, (bCont) ? 0 : tamung, decimal.Parse(r["bhytt0107"].ToString()), dr[i]["nguoinha"].ToString(), int.Parse(dr[i]["hinhthuc"].ToString()), int.Parse(dr[i]["phuongphap"].ToString()), int.Parse(dr[i]["ketqua"].ToString()), dr[i]["soluutru"].ToString(),
                                       dg1k, bChitiet, int.Parse(dr[i]["done"].ToString()), dr[i]["mabs"].ToString(), dr[i]["tenbs"].ToString(), dr[i]["makp"].ToString(), dr[i]["cholam"].ToString(), i_madoituongvao, dg1k, decimal.Parse(r["idttrv"].ToString()), st1k, int.Parse(dr[i]["traituyen"].ToString()), kythuat, r["mabs"].ToString(), 0, 0, dKythuatcao_chitratoiday, 0, tLchitraktcao);
                                    }
                                }
                                if (dr[i]["done"].ToString() == "0" && (r["toathuoc"].ToString() == "0" || r["toathuoc"].ToString() == ""))
                                {
                                    if (bktCao_ttDV)
                                    {
                                        v.upd_thvpct(idvienphi, r["ngay"].ToString(), r["makp"].ToString(), i_madt, decimal.Parse(r["mavp"].ToString()), decimal.Parse(r["soluong"].ToString()), dg1k, st1k, (r["vattu"].ToString().Trim() == "") ? 0 : decimal.Parse(r["vattu"].ToString()), s_mmyy, s_sothe, int.Parse(r["traituyen"].ToString()), r["mabs"].ToString(), decimal.Parse(r["idtonghop"].ToString()), int.Parse(r["stttonghop"].ToString()));
                                        execute_data("update " + user + mmyy(s_ngay) + ".v_thvpct set ktcao=1 where id=" + idvienphi + " and makp='" + r["makp"].ToString() + "' and to_char(ngay,'dd/mm/yyyy')='" + r["ngay"].ToString() + "' and madoituong=" + i_madt + " and mavp=" + r["mavp"].ToString() + " and dongia=" + dg1k);
                                    }
                                    else
                                    {
                                        v.upd_thvpct(idvienphi, r["ngay"].ToString(), r["makp"].ToString(), i_madt, decimal.Parse(r["mavp"].ToString()), decimal.Parse(r["soluong"].ToString()), dg1k, st1k, (r["vattu"].ToString().Trim() == "") ? 0 : decimal.Parse(r["vattu"].ToString()), s_mmyy, s_sothe, int.Parse(r["traituyen"].ToString()), r["mabs"].ToString(), decimal.Parse(r["idtonghop"].ToString()), int.Parse(r["stttonghop"].ToString()));
                                    }

                                }
                                if (dg2k > 0) //if (dg2k != 0)
                                {
                                    s_ten += " BN thanh toán chênh lệch " + ((kythuat == 0) ? "kỹ thuật cao" : "chăm sóc thai sản,sinh đẻ");
                                    s_tenktcao_chung += " BN thanh toán chênh lệch " + ((kythuat == 0) ? "kỹ thuật cao" : "chăm sóc thai sản,sinh đẻ");
                                    r1 = getrowbyid(dtdt, "madoituong=" + i_tunguyen);
                                    if (r1 != null) s_dtuong = r1["doituong"].ToString();
                                    //
                                    if (m_madoituong_inttrv == "" || m_madoituong_inttrv.IndexOf("," + dr[i]["madoituong"].ToString() + ",") >= 0)
                                    {
                                        //binh 070611: do khi chon chuyen so lieu vp, nhung khong chon het doi tuong, chi chon 1 dtuong de in (thuong in lai)
                                        //Khi do SL chuyen xuong vp chi chuyen doi tuong duoc chon --> do do thieu so lieu
                                        //
                                        if (bktCao_ttDV)
                                        {
                                            updrec_ravien(ds, dr[i]["mabn"].ToString(), dr[i]["mabn"].ToString(), decimal.Parse(dr[i]["maql"].ToString()), decimal.Parse(dr[i]["idkhoa"].ToString()), dr[i]["hoten"].ToString(), dr[i]["namsinh"].ToString(), dr[i]["phai"].ToString(),
                                                dr[i]["diachi"].ToString(), i_tunguyen, s_dtuong, s_sothe, iBhyt, s_tungay + "^" + s_denngay, dr[i]["noigioithieu"].ToString(), s_noidk,
                                                dr[i]["giuong"].ToString(), r["makp"].ToString() + ((bKhoa) ? " : " + r["ngay"].ToString() : ""), s_tenkp + ((bKhoa) ? " : " + r["ngay"].ToString() : ""), dr[i]["ngayvao"].ToString(), dr[i]["ngayra"].ToString(), dr[i]["chandoan"].ToString(), dr[i]["maicd"].ToString(), int.Parse(r2["sttnhom"].ToString()),
                                                r2["nhom"].ToString(), int.Parse(r2["sttloai"].ToString()), r2["loai"].ToString(), int.Parse(r["mavp"].ToString()),
                                                s_tenktcao_chung, r2["dvt"].ToString(), decimal.Parse(r["soluong"].ToString()),
                                                st2k,
                                                0, (bCont) ? 0 : tamung, decimal.Parse(r["bhytt0107"].ToString()), dr[i]["nguoinha"].ToString(), int.Parse(dr[i]["hinhthuc"].ToString()), int.Parse(dr[i]["phuongphap"].ToString()), int.Parse(dr[i]["ketqua"].ToString()), dr[i]["soluutru"].ToString(),
                                                dg2k, bChitiet, int.Parse(dr[i]["done"].ToString()), dr[i]["mabs"].ToString(), dr[i]["tenbs"].ToString(), dr[i]["makp"].ToString(), dr[i]["cholam"].ToString(), i_madoituongvao, dg2k, decimal.Parse(r["idttrv"].ToString()), st2k, int.Parse(dr[i]["traituyen"].ToString()), kythuat, r["mabs"].ToString(), 0, vuottran, dKythuatcao_chitratoiday, (r["id_vpkhoa"].ToString() == null || r["id_vpkhoa"].ToString() == "") ? 0 : decimal.Parse(r["id_vpkhoa"].ToString()), 0);
                                        }
                                        else
                                        {
                                            updrec_ravien(ds, dr[i]["mabn"].ToString(), dr[i]["mabn"].ToString(), decimal.Parse(dr[i]["maql"].ToString()), decimal.Parse(dr[i]["idkhoa"].ToString()), dr[i]["hoten"].ToString(), dr[i]["namsinh"].ToString(), dr[i]["phai"].ToString(),
                                                dr[i]["diachi"].ToString(), i_tunguyen, s_dtuong, s_sothe, iBhyt, s_tungay + "^" + s_denngay, dr[i]["noigioithieu"].ToString(), s_noidk,
                                                dr[i]["giuong"].ToString(), r["makp"].ToString() + ((bKhoa) ? " : " + r["ngay"].ToString() : ""), s_tenkp + ((bKhoa) ? " : " + r["ngay"].ToString() : ""), dr[i]["ngayvao"].ToString(), dr[i]["ngayra"].ToString(), dr[i]["chandoan"].ToString(), dr[i]["maicd"].ToString(), int.Parse(r2["sttnhom"].ToString()),
                                                r2["nhom"].ToString(), int.Parse(r2["sttloai"].ToString()), r2["loai"].ToString(), int.Parse(r["mavp"].ToString()),
                                                s_ten, r2["dvt"].ToString(), decimal.Parse(r["soluong"].ToString()),
                                                st2k,
                                                0, (bCont) ? 0 : tamung, decimal.Parse(r["bhytt0107"].ToString()), dr[i]["nguoinha"].ToString(), int.Parse(dr[i]["hinhthuc"].ToString()), int.Parse(dr[i]["phuongphap"].ToString()), int.Parse(dr[i]["ketqua"].ToString()), dr[i]["soluutru"].ToString(),
                                                dg2k, bChitiet, int.Parse(dr[i]["done"].ToString()), dr[i]["mabs"].ToString(), dr[i]["tenbs"].ToString(), dr[i]["makp"].ToString(), dr[i]["cholam"].ToString(), i_madoituongvao, dg2k, decimal.Parse(r["idttrv"].ToString()), st2k, int.Parse(dr[i]["traituyen"].ToString()), kythuat, r["mabs"].ToString(), 0, vuottran, dKythuatcao_chitratoiday, 0, 0);
                                        }
                                    }
                                    if (dr[i]["done"].ToString() == "0" && (r["toathuoc"].ToString() == "0" || r["toathuoc"].ToString() == ""))
                                    {
                                        if (bktCao_ttDV)
                                        {
                                            v.upd_thvpct(idvienphi, r["ngay"].ToString(), r["makp"].ToString(), i_tunguyen, decimal.Parse(r["mavp"].ToString()), decimal.Parse(r["soluong"].ToString()), dg2k, st2k, (r["vattu"].ToString().Trim() == "") ? 0 : decimal.Parse(r["vattu"].ToString()), s_mmyy, s_sothe, int.Parse(r["traituyen"].ToString()), r["mabs"].ToString(), decimal.Parse(r["idtonghop"].ToString()), int.Parse(r["stttonghop"].ToString()));
                                            execute_data("update " + user + mmyy(s_ngay) + ".v_thvpct set ktcao=1 where id=" + idvienphi + " and makp='" + r["makp"].ToString() + "' and to_char(ngay,'dd/mm/yyyy')='" + r["ngay"].ToString() + "' and madoituong=" + i_tunguyen + " and mavp=" + r["mavp"].ToString() + " and dongia=" + dg2k);
                                        }
                                        else
                                        {
                                            v.upd_thvpct(idvienphi, r["ngay"].ToString(), r["makp"].ToString(), i_tunguyen, decimal.Parse(r["mavp"].ToString()), decimal.Parse(r["soluong"].ToString()), dg2k, st2k, (r["vattu"].ToString().Trim() == "") ? 0 : decimal.Parse(r["vattu"].ToString()), s_mmyy, s_sothe, int.Parse(r["traituyen"].ToString()), r["mabs"].ToString(), decimal.Parse(r["idtonghop"].ToString()), int.Parse(r["stttonghop"].ToString()));
                                        }
                                    }
                                }

                            }
                            else
                            {
                                if (m_madoituong_inttrv == "" || m_madoituong_inttrv.IndexOf("," + dr[i]["madoituong"].ToString() + ",") >= 0)
                                {
                                    //binh 070611: do khi chon chuyen so lieu vp, nhung khong chon het doi tuong, chi chon 1 dtuong de in (thuong in lai)
                                    //Khi do SL chuyen xuong vp chi chuyen doi tuong duoc chon --> do do thieu so lieu
                                    //
                                    updrec_ravien(ds, dr[i]["mabn"].ToString(), dr[i]["mabn"].ToString(), decimal.Parse(dr[i]["maql"].ToString()), decimal.Parse(dr[i]["idkhoa"].ToString()), dr[i]["hoten"].ToString(), dr[i]["namsinh"].ToString(), dr[i]["phai"].ToString(),
                                        dr[i]["diachi"].ToString(), i_madt, s_dtuong, s_sothe, iBhyt, s_tungay + "^" + s_denngay, dr[i]["noigioithieu"].ToString(), s_noidk,
                                        dr[i]["giuong"].ToString(), r["makp"].ToString() + ((bKhoa) ? " : " + r["ngay"].ToString() : ""), s_tenkp + ((bKhoa) ? " : " + r["ngay"].ToString() : ""), dr[i]["ngayvao"].ToString(), dr[i]["ngayra"].ToString(), dr[i]["chandoan"].ToString(), dr[i]["maicd"].ToString(), int.Parse(r2["sttnhom"].ToString()),
                                        r2["nhom"].ToString(), int.Parse(r2["sttloai"].ToString()), r2["loai"].ToString(), int.Parse(r["mavp"].ToString()),
                                        s_ten, r2["dvt"].ToString(), decimal.Parse(r["soluong"].ToString()),
                                        st1,
                                        (r["bhyt"].ToString() == "" ? 0 : decimal.Parse(r["bhyt"].ToString())), tamung, decimal.Parse(r["bhytt0107"].ToString()), dr[i]["nguoinha"].ToString(), int.Parse(dr[i]["hinhthuc"].ToString()), int.Parse(dr[i]["phuongphap"].ToString()), int.Parse(dr[i]["ketqua"].ToString()), dr[i]["soluutru"].ToString(),
                                        dg1, bChitiet, (dr[i]["done"].ToString() == "" ? 2 : int.Parse(dr[i]["done"].ToString())), dr[i]["mabs"].ToString(), dr[i]["tenbs"].ToString(), dr[i]["makp"].ToString(), dr[i]["cholam"].ToString(), i_madoituongvao, dg1, decimal.Parse(r["idttrv"].ToString()), st1, (dr[i]["traituyen"].ToString() == "" ? 0 : int.Parse(dr[i]["traituyen"].ToString())), kythuat, r["mabs"].ToString(), 0, 0, dKythuatcao_chitratoiday, 0, 0);
                                }
                                //tmp.WriteXml("c:\\dddd.xml", XmlWriteMode.WriteSchema);
                                if (dr[i]["done"].ToString() == "0" && (r["toathuoc"].ToString() == "0" || r["toathuoc"].ToString() == ""))
                                {
                                    v.upd_thvpct(idvienphi, r["ngay"].ToString(), r["makp"].ToString(), i_madt, (r["mavp"].ToString().Trim() == "") ? 0 : decimal.Parse(r["mavp"].ToString()), (r["soluong"].ToString() == "") ? 0 : decimal.Parse(r["soluong"].ToString()), dg1, st1, (r["vattu"].ToString().Trim() == "") ? 0 : decimal.Parse(r["vattu"].ToString()), s_mmyy, s_sothe, (r["traituyen"].ToString().Trim() == "") ? 0 : int.Parse(r["traituyen"].ToString()), r["mabs"].ToString(), decimal.Parse(r["idtonghop"].ToString()), r["stttonghop"].ToString()==""?0:int.Parse(r["stttonghop"].ToString()));
                                }

                            }
                            #endregion

                            #region chenhlech
                            bCont = bChenhlechdv && r2["chenhlech"].ToString() == "1" && (!bthutienlien || r["dachenhlech"].ToString() == "0");//bCont = bChenhlechdv && r2["chenhlech"].ToString() == "1" && !bthutienlien ;
                            if (!bChenhlech_dt) bCont = bCont && int.Parse(dr[i]["madoituong"].ToString()) == i_madoituongvao;
                            bCont = bCont && r["dachenhlech"].ToString() == "0";//gam 16/11/2011
                            if (bCont)
                            {
                                bCont = s_chenhlech.IndexOf(i_madoituongvao.ToString().Trim() + ",") != -1
                                        && decimal.Parse(r2["gia_" + f1.Trim()].ToString()) <= decimal.Parse(r2["gia_" + f2.Trim()].ToString());
                                if (bChenhlech_dt) bCont = bCont && (s_madt == i_tunguyen.ToString().Trim() || s_madt == "1");
                                //else bCont = bCont && (ngayduyet == "" || !bNgay((ngayduyet == "") ? r["ngay"].ToString() : ngayduyet, r["ngay"].ToString()));//bbb
                                if (i_madoituongvao == 1) bCont = bCont && (decimal.Parse(r2["bhyt"].ToString()) > 0);
                                bCont = bCont && bTungay && bDenngay;
                                if (bCont)
                                {
                                    s_madt = i_tunguyen.ToString();
                                    i_madt = int.Parse(s_madt);
                                    r1 = getrowbyid(dtdt, "madoituong=" + i_madt);
                                    if (r1 != null) s_dtuong = r1["doituong"].ToString();
                                    s_ten += " " + schenhlech;
                                    get_dongia(decimal.Parse(r["mavp"].ToString()), i_madt.ToString(), r["ngay"].ToString(), false);
                                    dg2 = d_dongia + d_vattu - dg1;
                                    //dg2 = decimal.Parse(r2["gia_" + f2.Trim()].ToString()) + decimal.Parse(r2["vattu_" + f2.Trim()].ToString()) - dg1;
                                    if (cl_tyle != 0 && cl_cholam.IndexOf(dr[i]["cholam"].ToString().Trim().ToLower()) != -1 && dr[i]["cholam"].ToString() != "")
                                    {
                                        r1 = getrowbyid(dtdt, "madoituong=" + cl_doituong);
                                        if (r1 != null) cl_tendoituong = r1["doituong"].ToString();
                                        dg3 = dg2 * (cl_tyle / 100);
                                        dg2 -= dg3;
                                        st3 = decimal.Parse(r["soluong"].ToString()) * dg3;
                                    }
                                    st2 = decimal.Parse(r["soluong"].ToString()) * dg2;
                                }
                                else if (s_madt == "1" && a_sotien != a_stbhyt)//else if (s_madt == "1" && decimal.Parse(r["sotien"].ToString()) != decimal.Parse(r["bhyt"].ToString()))
                                {
                                    s_ten = r2["ten"].ToString();
                                    decimal bn = 100 - decimal.Parse(r2["bhyt"].ToString());
                                    s_ten += " BN thanh toán " + bn.ToString().Trim() + " %";
                                    dg2 = dongia * bn / 100;
                                    st2 = a_sotien - a_stbhyt;// decimal.Parse(r["sotien"].ToString()) - decimal.Parse(r["bhyt"].ToString());
                                }

                            }
                            else if (s_madt == "1" && a_sotien - a_stbhyt > 0 && decimal.Parse(r2["bhyt"].ToString()) != 0)//else if (s_madt == "1" && decimal.Parse(r["sotien"].ToString()) - decimal.Parse(r["bhyt"].ToString()) > 0 && decimal.Parse(r["sotien"].ToString()) != decimal.Parse(r["bhyt"].ToString()) && decimal.Parse(r2["bhyt"].ToString()) != 0)
                            {
                                s_ten = r2["ten"].ToString();
                                decimal bn = 100 - decimal.Parse(r2["bhyt"].ToString());
                                s_ten += " BN thanh toán " + bn.ToString().Trim() + " %";
                                dg2 = dongia * bn / 100;
                                st2 = a_sotien - a_stbhyt; //decimal.Parse(r["sotien"].ToString()) - decimal.Parse(r["bhyt"].ToString());
                                if (dg2 > 0)
                                {
                                    i_madt = (bdichvubhytduoi_100_thuphi) ? 2 : i_tunguyen;
                                    s_dtuong = (bdichvubhytduoi_100_thuphi) ? s_doituongtp : (dtdt.Select("madoituong=" + i_madt)[0]["doituong"].ToString());
                                }
                            }
                            #endregion

                            if (dg2 > 0)//if (dg2 != 0)
                            {
                                if (m_madoituong_inttrv == "" || m_madoituong_inttrv.IndexOf("," + dr[i]["madoituong"].ToString() + ",") >= 0)
                                {
                                    //binh 070611: do khi chon chuyen so lieu vp, nhung khong chon het doi tuong, chi chon 1 dtuong de in (thuong in lai)
                                    //Khi do SL chuyen xuong vp chi chuyen doi tuong duoc chon --> do do thieu so lieu
                                    //
                                    updrec_ravien(ds, dr[i]["mabn"].ToString(), dr[i]["mabn"].ToString(), decimal.Parse(dr[i]["maql"].ToString()), decimal.Parse(dr[i]["idkhoa"].ToString()), dr[i]["hoten"].ToString(), dr[i]["namsinh"].ToString(), dr[i]["phai"].ToString(),
                                        dr[i]["diachi"].ToString(), i_madt, s_dtuong, s_sothe, iBhyt, s_tungay + "^" + s_denngay, dr[i]["noigioithieu"].ToString(), s_noidk,
                                        dr[i]["giuong"].ToString(), r["makp"].ToString() + ((bKhoa) ? " : " + r["ngay"].ToString() : ""), s_tenkp + ((bKhoa) ? " : " + r["ngay"].ToString() : ""), dr[i]["ngayvao"].ToString(), dr[i]["ngayra"].ToString(), dr[i]["chandoan"].ToString(), dr[i]["maicd"].ToString(), int.Parse(r2["sttnhom"].ToString()),
                                        r2["nhom"].ToString(), int.Parse(r2["sttloai"].ToString()), r2["loai"].ToString(), int.Parse(r["mavp"].ToString()),
                                        s_ten, r2["dvt"].ToString(), decimal.Parse(r["soluong"].ToString()),
                                        st2,
                                        (r["bhyt"].ToString() == "" ? 0 : decimal.Parse(r["bhyt"].ToString())), 0, decimal.Parse(r["bhytt0107"].ToString()), dr[i]["nguoinha"].ToString(), int.Parse(dr[i]["hinhthuc"].ToString()), int.Parse(dr[i]["phuongphap"].ToString()), int.Parse(dr[i]["ketqua"].ToString()), dr[i]["soluutru"].ToString(),
                                        dg2, bChitiet, int.Parse(dr[i]["done"].ToString()), dr[i]["mabs"].ToString(), dr[i]["tenbs"].ToString(), dr[i]["makp"].ToString(), dr[i]["cholam"].ToString(), i_madoituongvao, dg2, decimal.Parse(r["idttrv"].ToString()), st2, (dr[i]["traituyen"].ToString() == "" ? 0 : int.Parse(dr[i]["traituyen"].ToString())), kythuat, r["mabs"].ToString(), 0, 0, dKythuatcao_chitratoiday, 0, 0);
                                }
                                if (dr[i]["done"].ToString() == "0" && (r["toathuoc"].ToString() == "0" || r["toathuoc"].ToString() == ""))
                                    v.upd_thvpct(idvienphi, r["ngay"].ToString(), r["makp"].ToString(), i_madt, decimal.Parse(r["mavp"].ToString()), decimal.Parse(r["soluong"].ToString()), dg2, st2, decimal.Parse(r["vattu"].ToString()), s_mmyy, s_sothe, int.Parse(r["traituyen"].ToString()), r["mabs"].ToString(), decimal.Parse(r["idtonghop"].ToString()), int.Parse(r["stttonghop"].ToString()));
                            }
                            if (dg3 > 0)//if (dg3 != 0)
                            {
                                if (m_madoituong_inttrv == "" || m_madoituong_inttrv.IndexOf("," + dr[i]["madoituong"].ToString() + ",") >= 0)
                                {
                                    //binh 070611: do khi chon chuyen so lieu vp, nhung khong chon het doi tuong, chi chon 1 dtuong de in (thuong in lai)
                                    //Khi do SL chuyen xuong vp chi chuyen doi tuong duoc chon --> do do thieu so lieu
                                    //
                                    updrec_ravien(ds, dr[i]["mabn"].ToString(), dr[i]["mabn"].ToString(), decimal.Parse(dr[i]["maql"].ToString()), decimal.Parse(dr[i]["idkhoa"].ToString()), dr[i]["hoten"].ToString(), dr[i]["namsinh"].ToString(), dr[i]["phai"].ToString(),
                                        dr[i]["diachi"].ToString(), cl_doituong, cl_tendoituong, s_sothe, iBhyt, s_tungay + "^" + s_denngay, dr[i]["noigioithieu"].ToString(), s_noidk,
                                        dr[i]["giuong"].ToString(), r["makp"].ToString() + ((bKhoa) ? " : " + r["ngay"].ToString() : ""), s_tenkp + ((bKhoa) ? " : " + r["ngay"].ToString() : ""), dr[i]["ngayvao"].ToString(), dr[i]["ngayra"].ToString(), dr[i]["chandoan"].ToString(), dr[i]["maicd"].ToString(), int.Parse(r2["sttnhom"].ToString()),
                                        r2["nhom"].ToString(), int.Parse(r2["sttloai"].ToString()), r2["loai"].ToString(), int.Parse(r["mavp"].ToString()),
                                        cl_ten, r2["dvt"].ToString(), decimal.Parse(r["soluong"].ToString()),
                                        st3,
                                        (r["bhyt"].ToString() == "" ? 0 : decimal.Parse(r["bhyt"].ToString())), 0, decimal.Parse(r["bhytt0107"].ToString()), dr[i]["nguoinha"].ToString(), int.Parse(dr[i]["hinhthuc"].ToString()), int.Parse(dr[i]["phuongphap"].ToString()), int.Parse(dr[i]["ketqua"].ToString()), dr[i]["soluutru"].ToString(),
                                        dg3, bChitiet, int.Parse(dr[i]["done"].ToString()), dr[i]["mabs"].ToString(), dr[i]["tenbs"].ToString(), dr[i]["makp"].ToString(), dr[i]["cholam"].ToString(), i_madoituongvao, dg3, decimal.Parse(r["idttrv"].ToString()), st3, int.Parse(dr[i]["traituyen"].ToString()), kythuat, r["mabs"].ToString(), 0, 0, dKythuatcao_chitratoiday, 0, 0);
                                }
                                if (dr[i]["done"].ToString() == "0" && (r["toathuoc"].ToString() == "0" || r["toathuoc"].ToString() == ""))
                                    v.upd_thvpct(idvienphi, r["ngay"].ToString(), r["makp"].ToString(), cl_doituong, decimal.Parse(r["mavp"].ToString()), decimal.Parse(r["soluong"].ToString()), dg3, st3, decimal.Parse(r["vattu"].ToString()), s_mmyy, s_sothe, int.Parse(r["traituyen"].ToString()), r["mabs"].ToString(), decimal.Parse(r["idtonghop"].ToString()), int.Parse(r["stttonghop"].ToString()));
                            }
                            if (dr[i]["done"].ToString() == "0")
                            {
                                sotien += decimal.Parse(r["sotien"].ToString());
                                bhyt += decimal.Parse(r["bhyt"].ToString());
                            }
                        }
                    }
                }
                if (dr[i]["done"].ToString() == "0")
                {
                    i_tyle_chinhsach = get_tyle_bhyt_chinhsach(dr[i]["sothe"].ToString());//gam 01/12/2011
                    if (dr[i]["madoituong"].ToString() == "1") //bhyt
                    {
                        if (dr[i]["maphu"].ToString() == "0") // Ko cung chi tra
                        {
                            bhyt = sotien; sotien = 0;
                        }
                        else sotien = sotien - bhyt;
                    }
                    else if (mien_doituong(int.Parse(dr[i]["madoituong"].ToString()), dtdt)) //mien
                    {
                        mien = sotien; sotien = 0; bhyt = 0;
                    }
                    else bhyt = 0;
                    v.upd_thvpll(idvienphi, dr[i]["mabn"].ToString(), decimal.Parse(dr[i]["mavaovien"].ToString()), maql, idkhoa, dr[i]["ngayvao"].ToString(), dr[i]["ngayra"].ToString(), dr[i]["giuong"].ToString(), dr[i]["makp"].ToString(), dr[i]["chandoan"].ToString(), dr[i]["maicd"].ToString(), sotien, tamung, bhyt, mien, s_mmyy, i_tyle_chinhsach);
                    if (bndot && s_idthuoc != "") v.execute_data("update " + user + s_mmyy + ".v_thvpll set idthuoc='" + s_idthuoc + "' where id=" + idvienphi);
                    if (dr[i]["sothe"].ToString() != "" && dr[i]["madoituong"].ToString() == "1") v.upd_thvpbhyt(idvienphi, dr[i]["sothe"].ToString().Trim(), iBhyt, get_manoigioithieu(maql), (loaiba == 4 || loaiba == 3) ? get_manoicap(dr[i]["ngayvao"].ToString(), maql, dr[i]["sothe"].ToString()) : get_manoicap("", maql, dr[i]["sothe"].ToString()), s_mmyy, int.Parse(dr[i]["traituyen"].ToString()));
                }
            }
            #region sosinh
            idkhoa = 0; maql = 0; idvienphi = 0;

            for (int i = 0; i < drss.Length; i++)
            {
                r1 = getrowbyid(dtkp, "makp='" + drss[i]["makp"].ToString() + "'");
                i_madoituongvao = int.Parse(drss[i]["madoituongvao"].ToString());
                tamung = 0; sotien = 0; bhyt = 0; mien = 0;
                if (bndot) idkhoa = decimal.Parse(drss[i]["idkhoa"].ToString());
                maql = decimal.Parse(drss[i]["maql"].ToString());
                //if (bVienphi_phongluu) maql_phongluu = get_maql_phongluu(drss[i]["ngayvao"].ToString(),maql);
                //else maql_phongluu = 0;
                //if (maql_phongluu == maql) maql_phongluu = 0;
                if (drss[i]["done"].ToString() == "0")
                {
                    s_idvienphi = v.get_id_thvp(drss[i]["mame"].ToString(), decimal.Parse(drss[i]["maqlme"].ToString()), decimal.Parse(drss[i]["idkhoame"].ToString()), drss[i]["ngayvaome"].ToString(), s_ngay);
                    if (s_idvienphi == "")
                    {
                        s_mmyy = mmyy(s_ngay);
                        idvienphi = v.get_id_thvp();
                    }
                    else
                    {
                        s_mmyy = s_idvienphi.Substring(0, 2) + s_idvienphi.Substring(2, 2);
                        idvienphi = decimal.Parse(s_idvienphi.Substring(4));
                    }
                    //idvienphi = v.get_id_thvp(s_ngay, drss[i]["mame"].ToString(), decimal.Parse(drss[i]["maqlme"].ToString()), decimal.Parse(drss[i]["idkhoame"].ToString()), drss[i]["ngayvaome"].ToString());
                    //if (idvienphi == 0) idvienphi = v.get_id_thvp();
                }
                if (get_data("select * from " + usr + s_mmyy + ".v_thvpll where id=" + idvienphi).Tables[0].Rows.Count == 0)
                    v.upd_thvpll(idvienphi, drss[i]["mame"].ToString(), decimal.Parse(dr[i]["mavaovien"].ToString()), decimal.Parse(drss[i]["maqlme"].ToString()), decimal.Parse(drss[i]["idkhoame"].ToString()), drss[i]["ngayvaome"].ToString(), drss[i]["ngayrame"].ToString(), drss[i]["giuong"].ToString(), drss[i]["makpme"].ToString(), drss[i]["chandoanme"].ToString(), drss[i]["maicdme"].ToString(), sotien, tamung, bhyt, mien, s_mmyy, 0);
                tamung = get_tamung_ct(drss[i]["mabn"].ToString(), maql, idkhoa, drss[i]["ngayvao"].ToString(), drss[i]["ngayra"].ToString(), (makp == "") ? "" : drss[i]["makp"].ToString(), int.Parse(drss[i]["madoituong"].ToString()), int.Parse(drss[i]["done"].ToString()), maql_phongluu, loaiba, bKhoa, drss[i]["maso"].ToString(), dr[i]["idttrv"].ToString());
                tc_tamung += tamung;
                if (b_sobienlaitamung != "" && b_tatca_sobienlaitamung.IndexOf(b_sobienlaitamung) < 0) b_tatca_sobienlaitamung += b_sobienlaitamung;
                if (!bBosolieuduoc)
                {
                    tmp = get_thuoc_ct(drss[i]["mabn"].ToString(), maql, idkhoa, drss[i]["ngayvao"].ToString(), drss[i]["ngayra"].ToString(), (makp == "" || r1 == null) ? 0 : int.Parse(r1["id"].ToString()), int.Parse(drss[i]["madoituong"].ToString()), int.Parse(drss[i]["done"].ToString()), maql_phongluu, bChenhlechdv, bCapve, bNgtr, loaiba, bKhoa, drss[i]["maso"].ToString(), bdieutri_donthuoc, bRavien_giagoc, ngia, bThanhtoan_N_Dot, dr[i]["idttrv"].ToString(), dr[i]["quyenso_tt"].ToString(), dr[i]["sobienlai_tt"].ToString());
                    if (tmp != null)
                    {
                        foreach (DataRow r in tmp.Rows)
                        {
                            r2 = getrowbyid(dtbd, "id=" + int.Parse(r["mabd"].ToString()));
                            if (r2 != null)
                            {
                                iBhyt = int.Parse(r2["bhyt"].ToString());
                                DataRow rkp = getrowbyid(dtkpm, "makp='" + r["makp"].ToString() + "'");
                                if (rkp != null) s_tenkp = rkp["tenkp"].ToString().Trim();
                                else s_tenkp = drss[i]["tenkp"].ToString().Trim();
                                s_madt = drss[i]["madoituong"].ToString().Trim();
                                i_madt = int.Parse(s_madt);
                                s_dtuong = drss[i]["doituong"].ToString();
                                s_ten = r2["ten"].ToString();
                                dongia = decimal.Parse(r["dongia"].ToString());
                                dg1 = dongia; dg2 = 0; st2 = 0; st1 = decimal.Parse(r["sotien"].ToString());
                                if (bChenhlechdv && s_madt == i_tunguyen.ToString().Trim() && i_madoituongvao == 1 && decimal.Parse(r2["bhyt"].ToString()) > 0 && r["loai"].ToString().Trim() == "1" && decimal.Parse(r["giaban"].ToString()) != decimal.Parse(r["giamua"].ToString()))
                                {
                                    i_madt = 1;
                                    r1 = getrowbyid(dtdt, "madoituong=" + i_madt);
                                    if (r1 != null) s_dtuong = r1["doituong"].ToString();
                                    dg1 = decimal.Parse(r["giamua"].ToString());
                                    st1 = decimal.Parse(r["soluong"].ToString()) * dg1;
                                }
                                else if (s_madt == "1" && decimal.Parse(r["sotien"].ToString()) != decimal.Parse(r["bhyt"].ToString()))
                                {
                                    s_ten += " BHYT thanh toán " + r2["bhyt"].ToString().Trim() + " %";
                                    dg1 = dongia * decimal.Parse(r2["bhyt"].ToString()) / 100;
                                    st1 = decimal.Parse(r["bhyt"].ToString());
                                }
                                if (m_madoituong_inttrv == "" || m_madoituong_inttrv.IndexOf("," + dr[i]["madoituong"].ToString() + ",") >= 0)
                                {
                                    //binh 070611: do khi chon chuyen so lieu vp, nhung khong chon het doi tuong, chi chon 1 dtuong de in (thuong in lai)
                                    //Khi do SL chuyen xuong vp chi chuyen doi tuong duoc chon --> do do thieu so lieu
                                    //
                                    updrec_ravien(ds, drss[i]["mame"].ToString(), drss[i]["mabn"].ToString(), decimal.Parse(drss[i]["maql"].ToString()), decimal.Parse(drss[i]["idkhoa"].ToString()), drss[i]["hoten"].ToString(), drss[i]["namsinh"].ToString(), drss[i]["phai"].ToString(),
                                        drss[i]["diachi"].ToString(), i_madt, s_dtuong, "", iBhyt, drss[i]["denngay"].ToString(), drss[i]["noigioithieu"].ToString(), drss[i]["noicap"].ToString(),
                                        drss[i]["giuong"].ToString(), r["makp"].ToString() + ((bKhoa) ? " : " + r["ngay"].ToString() : ""), s_tenkp + ((bKhoa) ? " : " + r["ngay"].ToString() : ""), drss[i]["ngayvao"].ToString(), drss[i]["ngayra"].ToString(), drss[i]["chandoan"].ToString(), drss[i]["maicd"].ToString(), int.Parse(r2["sttnhom"].ToString()),
                                        r2["nhom"].ToString(), int.Parse(r2["sttloai"].ToString()), r2["loai"].ToString(), int.Parse(r["mabd"].ToString()),
                                        s_ten, r2["dvt"].ToString(), decimal.Parse(r["soluong"].ToString()),
                                        st1,
                                        decimal.Parse(r["bhyt"].ToString()), tamung, decimal.Parse(r["bhytt0107"].ToString()), drss[i]["nguoinha"].ToString(), int.Parse(drss[i]["hinhthuc"].ToString()), int.Parse(drss[i]["phuongphap"].ToString()), int.Parse(drss[i]["ketqua"].ToString()), drss[i]["soluutru"].ToString(),
                                        dg1, bChitiet, int.Parse(drss[i]["done"].ToString()), drss[i]["mabs"].ToString(), drss[i]["tenbs"].ToString(), drss[i]["makp"].ToString(), drss[i]["cholam"].ToString(), i_madoituongvao, decimal.Parse(r["gianovat"].ToString()), decimal.Parse(r["idttrv"].ToString()), st1, int.Parse(drss[i]["traituyen"].ToString()), kythuat, r["mabs"].ToString());
                                }
                                if (drss[i]["done"].ToString() == "0" && (r["toathuoc"].ToString() == "0" || r["toathuoc"].ToString() == ""))
                                    v.upd_thvpct(idvienphi, r["ngay"].ToString(), r["makp"].ToString(), i_madt, decimal.Parse(r["mabd"].ToString()), decimal.Parse(r["soluong"].ToString()), dg1, st1, 0, s_mmyy, "", int.Parse(r["traituyen"].ToString()), r["mabs"].ToString(), decimal.Parse(r["idtonghop"].ToString()), int.Parse(r["stttonghop"].ToString()));

                                if (bChenhlechdv && s_madt == i_tunguyen.ToString().Trim() && i_madoituongvao == 1 && decimal.Parse(r2["bhyt"].ToString()) > 0 && r["loai"].ToString().Trim() == "1" && decimal.Parse(r["giaban"].ToString()) != decimal.Parse(r["giamua"].ToString()))
                                {
                                    i_madt = int.Parse(s_madt);
                                    r1 = getrowbyid(dtdt, "madoituong=" + i_madt);
                                    if (r1 != null) s_dtuong = r1["doituong"].ToString();
                                    s_ten += " BN thanh toán chênh lệch ";
                                    dg2 = decimal.Parse(r["giaban"].ToString()) - decimal.Parse(r["giamua"].ToString());
                                    st2 = decimal.Parse(r["soluong"].ToString()) * dg2;
                                }
                                else if (s_madt == "1" && decimal.Parse(r["sotien"].ToString()) != decimal.Parse(r["bhyt"].ToString()))
                                {
                                    i_madt = (bdichvubhytduoi_100_thuphi) ? 2 : i_tunguyen;//i_madt = i_tunguyen;
                                    s_dtuong = (bdichvubhytduoi_100_thuphi) ? s_doituongtp : s_doituong;//s_dtuong = s_doituong;                                                                        
                                    s_ten = r2["ten"].ToString();
                                    decimal bn = 100 - decimal.Parse(r2["bhyt"].ToString());
                                    s_ten += " BN thanh toán " + bn.ToString().Trim() + " %";
                                    dg2 = dongia * bn / 100;
                                    st2 = decimal.Parse(r["sotien"].ToString()) - decimal.Parse(r["bhyt"].ToString());
                                }

                                if (dg2 != 0)
                                {
                                    if (m_madoituong_inttrv == "" || m_madoituong_inttrv.IndexOf("," + dr[i]["madoituong"].ToString() + ",") >= 0)
                                    {
                                        //binh 070611: do khi chon chuyen so lieu vp, nhung khong chon het doi tuong, chi chon 1 dtuong de in (thuong in lai)
                                        //Khi do SL chuyen xuong vp chi chuyen doi tuong duoc chon --> do do thieu so lieu
                                        //
                                        updrec_ravien(ds, drss[i]["mame"].ToString(), drss[i]["mabn"].ToString(), decimal.Parse(drss[i]["maql"].ToString()), decimal.Parse(drss[i]["idkhoa"].ToString()), drss[i]["hoten"].ToString(), drss[i]["namsinh"].ToString(), drss[i]["phai"].ToString(),
                                            drss[i]["diachi"].ToString(), i_madt, s_dtuong, "", iBhyt, drss[i]["denngay"].ToString(), drss[i]["noigioithieu"].ToString(), drss[i]["noicap"].ToString(),
                                            drss[i]["giuong"].ToString(), r["makp"].ToString() + ((bKhoa) ? " : " + r["ngay"].ToString() : ""), s_tenkp + ((bKhoa) ? " : " + r["ngay"].ToString() : ""), drss[i]["ngayvao"].ToString(), drss[i]["ngayra"].ToString(), drss[i]["chandoan"].ToString(), drss[i]["maicd"].ToString(), int.Parse(r2["sttnhom"].ToString()),
                                            r2["nhom"].ToString(), int.Parse(r2["sttloai"].ToString()), r2["loai"].ToString(), int.Parse(r["mabd"].ToString()),
                                            s_ten, r2["dvt"].ToString(), decimal.Parse(r["soluong"].ToString()),
                                            st2,
                                            decimal.Parse(r["bhyt"].ToString()), tamung, decimal.Parse(r["bhytt0107"].ToString()), drss[i]["nguoinha"].ToString(), int.Parse(drss[i]["hinhthuc"].ToString()), int.Parse(drss[i]["phuongphap"].ToString()), int.Parse(drss[i]["ketqua"].ToString()), drss[i]["soluutru"].ToString(),
                                            dg2, bChitiet, int.Parse(drss[i]["done"].ToString()), drss[i]["mabs"].ToString(), drss[i]["tenbs"].ToString(), drss[i]["makp"].ToString(), drss[i]["cholam"].ToString(), i_madoituongvao, decimal.Parse(r["gianovat"].ToString()), decimal.Parse(r["idttrv"].ToString()), st2, int.Parse(drss[i]["traituyen"].ToString()), kythuat, r["mabs"].ToString());
                                    }
                                    if (drss[i]["done"].ToString() == "0" && (r["toathuoc"].ToString() == "0" || r["toathuoc"].ToString() == ""))
                                        v.upd_thvpct(idvienphi, r["ngay"].ToString(), r["makp"].ToString(), i_madt, decimal.Parse(r["mabd"].ToString()), decimal.Parse(r["soluong"].ToString()), dg2, st2, 0, s_mmyy, "", int.Parse(r["traituyen"].ToString()), r["mabs"].ToString(), decimal.Parse(r["idtonghop"].ToString()), int.Parse(r["stttonghop"].ToString()));
                                }
                                if (drss[i]["done"].ToString() == "0")
                                {
                                    sotien += decimal.Parse(r["sotien"].ToString());
                                    bhyt += decimal.Parse(r["bhyt"].ToString());
                                }
                            }
                        }
                    }
                }
                tmp = get_vienphi_ct(drss[i]["mabn"].ToString(), maql, idkhoa, drss[i]["ngayvao"].ToString(), drss[i]["ngayra"].ToString(), (makp == "") ? "" : drss[i]["makp"].ToString(), int.Parse(drss[i]["madoituong"].ToString()), int.Parse(drss[i]["done"].ToString()), maql_phongluu, bCapve, bNgtr, loaiba, bKhoa, drss[i]["maso"].ToString(), bThanhtoan_N_Dot, dr[i]["idttrv"].ToString());
                if (tmp != null)
                {
                    foreach (DataRow r in tmp.Rows)
                    {
                        DataRow rkp = getrowbyid(dtkpm, "makp='" + r["makp"].ToString() + "'");
                        if (rkp != null) s_tenkp = rkp["tenkp"].ToString().Trim();
                        else s_tenkp = drss[i]["tenkp"].ToString().Trim();
                        r2 = getrowbyid(dtvp, "id=" + int.Parse(r["mavp"].ToString()));
                        if (r2 != null)
                        {
                            iBhyt = int.Parse(r2["bhyt"].ToString());
                            s_madt = drss[i]["madoituong"].ToString();
                            i_madt = int.Parse(s_madt);
                            s_dtuong = drss[i]["doituong"].ToString();
                            s_ten = r2["ten"].ToString();
                            f1 = "th"; f2 = "th";
                            //
                            dongia = decimal.Parse(r["dongia"].ToString());
                            dg1 = dongia; dg2 = 0; st2 = 0; st1 = decimal.Parse(r["sotien"].ToString());
                            r1 = getrowbyid(dtdt, "madoituong=1");
                            if (r1 != null) f1 = r1["field_gia"].ToString().Trim().Substring(r1["field_gia"].ToString().Trim().IndexOf("_") + 1);
                            r1 = getrowbyid(dtdt, "madoituong=" + i_madt);
                            if (r1 != null) f2 = r1["field_gia"].ToString().Trim().Substring(r1["field_gia"].ToString().Trim().IndexOf("_") + 1);
                            if (bChenhlechdv && s_madt == i_tunguyen.ToString().Trim() && i_madoituongvao == 1 && decimal.Parse(r2["bhyt"].ToString()) > 0 && decimal.Parse(r2["gia_" + f1.Trim()].ToString()) <= decimal.Parse(r2["gia_" + f2.Trim()].ToString()))
                            {
                                i_madt = 1;
                                r1 = getrowbyid(dtdt, "madoituong=" + i_madt);
                                if (r1 != null) s_dtuong = r1["doituong"].ToString();
                                dg1 = decimal.Parse(r2["gia_" + f1.Trim()].ToString()) + decimal.Parse(r2["vattu_" + f1.Trim()].ToString());
                                st1 = decimal.Parse(r["soluong"].ToString()) * dg1;
                            }
                            else if (s_madt == "1" && decimal.Parse(r["sotien"].ToString()) != decimal.Parse(r["bhyt"].ToString()))
                            {
                                s_ten += " BHYT thanh toán " + r2["bhyt"].ToString().Trim() + " %";
                                dg1 = dongia * decimal.Parse(r2["bhyt"].ToString()) / 100;
                                st1 = decimal.Parse(r["bhyt"].ToString());
                            }
                            if (m_madoituong_inttrv == "" || m_madoituong_inttrv.IndexOf("," + dr[i]["madoituong"].ToString() + ",") >= 0)
                            {
                                //binh 070611: do khi chon chuyen so lieu vp, nhung khong chon het doi tuong, chi chon 1 dtuong de in (thuong in lai)
                                //Khi do SL chuyen xuong vp chi chuyen doi tuong duoc chon --> do do thieu so lieu
                                //
                                updrec_ravien(ds, drss[i]["mame"].ToString(), drss[i]["mabn"].ToString(), decimal.Parse(drss[i]["maql"].ToString()), decimal.Parse(drss[i]["idkhoa"].ToString()), drss[i]["hoten"].ToString(), drss[i]["namsinh"].ToString(), drss[i]["phai"].ToString(),
                                    drss[i]["diachi"].ToString(), i_madt, s_dtuong, "", iBhyt, drss[i]["denngay"].ToString(), drss[i]["noigioithieu"].ToString(), drss[i]["noicap"].ToString(),
                                    drss[i]["giuong"].ToString(), r["makp"].ToString() + ((bKhoa) ? " : " + r["ngay"].ToString() : ""), s_tenkp + ((bKhoa) ? " : " + r["ngay"].ToString() : ""), drss[i]["ngayvao"].ToString(), drss[i]["ngayra"].ToString(), drss[i]["chandoan"].ToString(), drss[i]["maicd"].ToString(), int.Parse(r2["sttnhom"].ToString()),
                                    r2["nhom"].ToString(), int.Parse(r2["sttloai"].ToString()), r2["loai"].ToString(), int.Parse(r["mavp"].ToString()),
                                    s_ten, r2["dvt"].ToString(), decimal.Parse(r["soluong"].ToString()),
                                    st1,
                                    decimal.Parse(r["bhyt"].ToString()), tamung, decimal.Parse(r["bhytt0107"].ToString()), drss[i]["nguoinha"].ToString(), int.Parse(drss[i]["hinhthuc"].ToString()), int.Parse(drss[i]["phuongphap"].ToString()), int.Parse(drss[i]["ketqua"].ToString()), drss[i]["soluutru"].ToString(),
                                    dg1, bChitiet, int.Parse(drss[i]["done"].ToString()), drss[i]["mabs"].ToString(), drss[i]["tenbs"].ToString(), drss[i]["makp"].ToString(), drss[i]["cholam"].ToString(), i_madoituongvao, dg1, decimal.Parse(r["idttrv"].ToString()), st1, int.Parse(drss[i]["traituyen"].ToString()), kythuat, r["mabs"].ToString());
                            }
                            if (drss[i]["done"].ToString() == "0" && (r["toathuoc"].ToString() == "0" || r["toathuoc"].ToString() == ""))
                                v.upd_thvpct(idvienphi, r["ngay"].ToString(), r["makp"].ToString(), i_madt, decimal.Parse(r["mavp"].ToString()), decimal.Parse(r["soluong"].ToString()), dg1, st1, decimal.Parse(r["vattu"].ToString()), s_mmyy, "", int.Parse(r["traituyen"].ToString()), r["mabs"].ToString(), decimal.Parse(r["idtonghop"].ToString()), int.Parse(r["stttonghop"].ToString()));
                            if (bChenhlechdv && s_madt == i_tunguyen.ToString().Trim() && i_madoituongvao == 1 && decimal.Parse(r2["bhyt"].ToString()) > 0 && decimal.Parse(r2["gia_" + f1.Trim()].ToString()) < decimal.Parse(r2["gia_" + f2.Trim()].ToString()))
                            {
                                i_madt = int.Parse(s_madt);
                                r1 = getrowbyid(dtdt, "madoituong=" + i_madt);
                                if (r1 != null) s_dtuong = r1["doituong"].ToString();
                                s_ten += " BN thanh toán chênh lệch ";
                                dg2 = decimal.Parse(r2["gia_" + f2.Trim()].ToString()) + decimal.Parse(r2["vattu_" + f2.Trim()].ToString()) - dg1;
                                st2 = decimal.Parse(r["soluong"].ToString()) * dg2;
                            }
                            else if (s_madt == "1" && decimal.Parse(r["sotien"].ToString()) != decimal.Parse(r["bhyt"].ToString()))
                            {
                                i_madt = (bdichvubhytduoi_100_thuphi) ? 2 : i_tunguyen;//i_madt = i_tunguyen;
                                s_dtuong = (bdichvubhytduoi_100_thuphi) ? s_doituongtp : s_doituong;//s_dtuong = s_doituong; 
                                s_ten = r2["ten"].ToString();
                                decimal bn = 100 - decimal.Parse(r2["bhyt"].ToString());
                                s_ten += " BN thanh toán " + bn.ToString().Trim() + " %";
                                dg2 = dongia * bn / 100;
                                st2 = decimal.Parse(r["sotien"].ToString()) - decimal.Parse(r["bhyt"].ToString());
                            }
                            if (dg2 != 0)
                            {
                                if (m_madoituong_inttrv == "" || m_madoituong_inttrv.IndexOf("," + dr[i]["madoituong"].ToString() + ",") >= 0)
                                {
                                    //binh 070611: do khi chon chuyen so lieu vp, nhung khong chon het doi tuong, chi chon 1 dtuong de in (thuong in lai)
                                    //Khi do SL chuyen xuong vp chi chuyen doi tuong duoc chon --> do do thieu so lieu
                                    //
                                    updrec_ravien(ds, drss[i]["mame"].ToString(), drss[i]["mabn"].ToString(), decimal.Parse(drss[i]["maql"].ToString()), decimal.Parse(drss[i]["idkhoa"].ToString()), drss[i]["hoten"].ToString(), drss[i]["namsinh"].ToString(), drss[i]["phai"].ToString(),
                                        drss[i]["diachi"].ToString(), i_madt, s_dtuong, "", iBhyt, drss[i]["denngay"].ToString(), drss[i]["noigioithieu"].ToString(), drss[i]["noicap"].ToString(),
                                        drss[i]["giuong"].ToString(), r["makp"].ToString() + ((bKhoa) ? " : " + r["ngay"].ToString() : ""), s_tenkp + ((bKhoa) ? " : " + r["ngay"].ToString() : ""), drss[i]["ngayvao"].ToString(), drss[i]["ngayra"].ToString(), drss[i]["chandoan"].ToString(), drss[i]["maicd"].ToString(), int.Parse(r2["sttnhom"].ToString()),
                                        r2["nhom"].ToString(), int.Parse(r2["sttloai"].ToString()), r2["loai"].ToString(), int.Parse(r["mavp"].ToString()),
                                        s_ten, r2["dvt"].ToString(), decimal.Parse(r["soluong"].ToString()),
                                        st2,
                                        decimal.Parse(r["bhyt"].ToString()), tamung, decimal.Parse(r["bhytt0107"].ToString()), drss[i]["nguoinha"].ToString(), int.Parse(drss[i]["hinhthuc"].ToString()), int.Parse(drss[i]["phuongphap"].ToString()), int.Parse(drss[i]["ketqua"].ToString()), drss[i]["soluutru"].ToString(),
                                        dg2, bChitiet, int.Parse(drss[i]["done"].ToString()), drss[i]["mabs"].ToString(), drss[i]["tenbs"].ToString(), drss[i]["makp"].ToString(), drss[i]["cholam"].ToString(), i_madoituongvao, dg2, decimal.Parse(r["idttrv"].ToString()), st2, int.Parse(drss[i]["traituyen"].ToString()), kythuat, r["mabs"].ToString());
                                }
                                if (drss[i]["done"].ToString() == "0" && (r["toathuoc"].ToString() == "0" || r["toathuoc"].ToString() == ""))
                                    v.upd_thvpct(idvienphi, r["ngay"].ToString(), r["makp"].ToString(), i_madt, decimal.Parse(r["mavp"].ToString()), decimal.Parse(r["soluong"].ToString()), dg2, st2, decimal.Parse(r["vattu"].ToString()), s_mmyy, "", int.Parse(r["traituyen"].ToString()), r["mabs"].ToString(), decimal.Parse(r["idtonghop"].ToString()), int.Parse(r["stttonghop"].ToString()));
                            }
                            if (drss[i]["done"].ToString() == "0")
                            {
                                sotien += decimal.Parse(r["sotien"].ToString());
                                bhyt += decimal.Parse(r["bhyt"].ToString());
                            }
                        }
                    }
                }
                if (drss[i]["done"].ToString() == "0")
                {
                    if (drss[i]["madoituong"].ToString() == "1") //bhyt
                    {
                        if (drss[i]["maphu"].ToString() == "0") // Ko cung chi tra
                        {
                            bhyt = sotien; sotien = 0;
                        }
                        else sotien = sotien - bhyt;
                    }
                    else if (mien_doituong(int.Parse(drss[i]["madoituong"].ToString()), dtdt)) //mien
                    {
                        mien = sotien; sotien = 0; bhyt = 0;
                    }
                    else bhyt = 0;
                    if (get_data("select * from " + usr + s_mmyy + ".v_thvpll where id=" + idvienphi).Tables[0].Rows.Count == 0)
                        v.upd_thvpll(idvienphi, drss[i]["mame"].ToString(), decimal.Parse(dr[i]["mavaovien"].ToString()), decimal.Parse(drss[i]["maqlme"].ToString()), decimal.Parse(drss[i]["idkhoame"].ToString()), drss[i]["ngayvaome"].ToString(), drss[i]["ngayrame"].ToString(), drss[i]["giuong"].ToString(), drss[i]["makpme"].ToString(), drss[i]["chandoanme"].ToString(), drss[i]["maicdme"].ToString(), sotien, tamung, bhyt, mien, s_mmyy, 0);
                    else execute_data("update " + usr + s_mmyy + ".v_thvpll set sotien=sotien+" + sotien + ",bhyt=bhyt+" + bhyt + ",mien=mien+" + mien + ",tamung=tamung+" + tamung + " where id=" + idvienphi);
                }
            }
            #endregion
            if (bMau38_Full)
            {
                for (int i = 0; i < dr.Length; i++)
                {
                    if (dr[i]["madoituong"].ToString() == "1")
                    {
                        DataSet ads1 = get_data("select stt, ma, ten from " + user + ".v_nhomvp ");
                        DataRow[] a_dr = ds.Tables[0].Select("madoituong=" + dr[i]["madoituong"].ToString());
                        if (a_dr.Length > 0)
                        {
                            foreach (DataRow adr in ads1.Tables[0].Rows)
                            {

                                string s_exp = " madoituong=" + dr[i]["madoituong"].ToString() + " and sttnhom=" + adr["stt"].ToString();
                                DataRow adr1 = getrowbyid(ds.Tables[0], s_exp);
                                if (adr1 == null)
                                {
                                    if (m_madoituong_inttrv == "" || m_madoituong_inttrv.IndexOf("," + dr[i]["madoituong"].ToString() + ",") >= 0)
                                    {
                                        //binh 070611: do khi chon chuyen so lieu vp, nhung khong chon het doi tuong, chi chon 1 dtuong de in (thuong in lai)
                                        //Khi do SL chuyen xuong vp chi chuyen doi tuong duoc chon --> do do thieu so lieu
                                        //
                                        updrec_ravien(ds, dr[i]["mabn"].ToString(), dr[i]["mabn"].ToString(), decimal.Parse(dr[i]["maql"].ToString()), decimal.Parse(dr[i]["idkhoa"].ToString()), dr[i]["hoten"].ToString(), dr[i]["namsinh"].ToString(), dr[i]["phai"].ToString(),
                                            dr[i]["diachi"].ToString(), int.Parse(dr[i]["madoituong"].ToString()), dr[i]["doituong"].ToString(), s_sothe, iBhyt, s_tungay + "^" + s_denngay, dr[i]["noigioithieu"].ToString(), s_noidk,
                                            dr[i]["giuong"].ToString(), dr[i]["makp"].ToString(), dr[i]["tenkp"].ToString(), dr[i]["ngayvao"].ToString(), dr[i]["ngayra"].ToString(), dr[i]["chandoan"].ToString(), dr[i]["maicd"].ToString(), int.Parse(adr["stt"].ToString()),
                                            adr["ten"].ToString(), 0, "", 0,
                                            "", "", 0, 0, 0, 0, 0, dr[i]["nguoinha"].ToString(), int.Parse(dr[i]["hinhthuc"].ToString()), int.Parse(dr[i]["phuongphap"].ToString()), int.Parse(dr[i]["ketqua"].ToString()), dr[i]["soluutru"].ToString(),
                                            0, bChitiet, int.Parse(dr[i]["done"].ToString()), dr[i]["mabs"].ToString(), dr[i]["tenbs"].ToString(), dr[i]["makp"].ToString(), dr[i]["cholam"].ToString(), i_madoituongvao, 0, 0, 0, int.Parse(dr[i]["traituyen"].ToString()), -1, "");
                                    }
                                }
                            }
                        }
                    }
                }
            }
            try
            {
                ds.Tables[0].Columns.Add("madt", typeof(decimal));
            }
            catch { }
            try
            {
                ds.Tables[0].Columns.Add("haophi", typeof(decimal));
            }
            catch { }
            foreach (DataRow r in ds.Tables[0].Select("true", "matt,mabn,sothe,madoituong,sttnhom,ten"))
            {
                r["madt"] = r["madoituong"].ToString();
                r["haophi"] = 0;
                /*
                if (bKhoan && sKhoan_doituong.IndexOf(r["madoituong"].ToString().PadLeft(2, '0')) != -1 && iKhoan_ma_pttt == int.Parse(r["ma"].ToString()))
                {
                    r["madt"] = iHaophi;
                    r["haophi"] = r["sotien"].ToString();
                }*/
                if (bHaophi_doituongvao && bHaophi && int.Parse(r["madoituong"].ToString()) == iHaophi)
                {
                    //r1=getrowbyid(dtkpm,"makpbo='19' and makp='"+r["makp"].ToString()+"'");
                    r1 = getrowbyid(dtkpm, "makp='" + r["makp"].ToString() + "'");
                    if (r1 != null)
                    {
                        r["sttnhom"] = 1000 + decimal.Parse(r["sttnhom"].ToString());
                        r["nhom"] = r["nhom"].ToString().Trim() + s_nhomhaophi;
                    }
                    r["madoituong"] = r["madoituongvao"].ToString();
                    r1 = getrowbyid(dtdt, "madoituong=" + int.Parse(r["madoituong"].ToString()));
                    if (r1 != null) r["doituong"] = r1["doituong"].ToString();
                }
            }
            //ds.WriteXml("..//xml//ravien.xml", XmlWriteMode.WriteSchema);

            return sort_ttravien_ct(dtdt, ds.Tables[0].Select("true", "matt,mabn,sothe,madoituong,madt,sttnhom,makp,ten"), loaiba, tenuser, usrid, (bHaophi_doituongvao && bHaophi) ? iHaophi : 0, dtvp, ngia, dtbd);//sttnhom,makp
        }

        private void get_dongia(decimal mavp, string madoituong, string ngay, bool ChiLayGiaVatTu)
        {
            //gam 23/02/2012 nếu biến ChiLayGiaVatTu không lấy giá từ v_giavp mà vẫn giữ giá ở v_chidinh
            //chỉ lấy giá vật tư nếu có khai báo, vì phu san binh duong tinh gia giuong thay doi theo ngay 
            //--> không co dinh nen tinh chenh lech bi sai gia
            d_vattu = 0;
            ngay = ngay.Substring(6, 4) + ngay.Substring(3, 2) + ngay.Substring(0, 2);
            string sql1 = "";
            sql1 = "select 0 as loai,id,gia_th,gia_bh,gia_cs,gia_dv,gia_nn,vattu_th,vattu_bh,vattu_cs,vattu_dv,vattu_nn,bhyt,to_char(ngayud,'yyyymmddhh24mi') as ngaygio,to_char(ngayud,'yyyymmdd') as ngay, chenhlech from " + user + ".v_giavp_luu";
            sql1 += " where id=" + mavp;
            sql1 += " union all ";
            sql1 += " select 1 as loai,id,gia_th,gia_bh,gia_cs,gia_dv,gia_nn,vattu_th,vattu_bh,vattu_cs,vattu_dv,vattu_nn,bhyt,to_char(ngayud,'yyyymmddhh24mi') as ngaygio,to_char(ngayud,'yyyymmdd') as ngay, chenhlech from " + user + ".v_giavp";
            sql1 += " where id=" + mavp;
            DataTable dtgia = get_data(sql1).Tables[0];
            string gia = field_gia(madoituong);
            string giavt = "vattu_" + gia.Substring(4).Trim();
            if (!ChiLayGiaVatTu)
            {
                d_dongia = 0;
            }
            sql = "id=" + mavp + " and loai=1 and ngay<=" + ngay;
            DataRow[] dr = dtgia.Select(sql, "ngaygio");
            if (dr.Length > 0)
            {
                if (!ChiLayGiaVatTu)
                {
                    d_dongia = decimal.Parse(dr[0][gia].ToString());
                }
                d_vattu = decimal.Parse(dr[0][giavt].ToString());
            }
            else
            {
                sql = "id=" + mavp + " and loai=0";
                dr = dtgia.Select(sql, "ngaygio desc");
                for (int i = 0; i < dr.Length; i++)
                {
                    if (decimal.Parse(dr[i]["ngay"].ToString()) <= decimal.Parse(ngay))
                    {
                        d_dongia = decimal.Parse(dr[i][gia].ToString());
                        d_vattu = decimal.Parse(dr[i][giavt].ToString());
                        break;
                    }
                }
            }
            if (d_dongia <= 0)
            {
                sql = "id=" + mavp + " and loai=1 ";
                dr = dtgia.Select(sql, "ngaygio");
                if (dr.Length > 0)
                {
                    d_dongia = decimal.Parse(dr[0][gia].ToString());
                    d_vattu = decimal.Parse(dr[0][giavt].ToString());
                }
            }
        }

        public DataSet sort_ttravien_ct_goc(DataTable dtdt, DataRow[] dr, int loaiba, string tenuser, int usrid, int iHaophi, DataTable dtvp, bool ngia, DataTable dtbd)
        {
            FileStream fstr;
            byte[] image = null, imagetk = null, imageuser = null;
            bool bChitiet = bInthanhtoanchitiet, bTruongkhoa = false, bBacsy = false, bUserid = false, Phongluu_bhyt_khambenh = bPhongluu_bhyt_khambenh, Ngoaitru_bhyt_khambenh = bNgoaitru_bhyt_khambenh, Noitru_bhyt_khambenh = bNoitru_bhyt_khambenh; ;
            int iKhoan_ma_pttt = iKhoan_mavp_pttt;
            bool bKhoan = bKhoan_vtth, btraituyen_bhtra = bTraituyen_bhtra;
            string sKhoan_doituong = sKhoan_madoituong;
            decimal lTraituyen = 0;
            int iTraituyen = iTraituyen_bhyt;
            DataSet dsxml = new DataSet();
            dsxml.ReadXml("..//..//..//xml//m_inravien.xml");
            dsxml.Tables[0].Columns.Add("tenuser", typeof(string));
            dsxml.Tables[0].Columns.Add("Image", typeof(byte[]));
            dsxml.Tables[0].Columns.Add("Imagetk", typeof(byte[]));
            dsxml.Tables[0].Columns.Add("Imageuser", typeof(byte[]));
            dsxml.Tables[0].Columns.Add("tenbs");
            dsxml.Tables[0].Columns.Add("mabs");
            dsxml.Tables[0].Columns.Add("makprv");
            dsxml.Tables[0].Columns.Add("cholam");
            dsxml.Tables[0].Columns.Add("madt", typeof(decimal));
            dsxml.Tables[0].Columns.Add("haophi", typeof(decimal));
            dsxml.Tables[0].Columns.Add("gianovat", typeof(decimal));
            dsxml.Tables[0].Columns.Add("idttrv", typeof(decimal));
            dsxml.Tables[0].Columns.Add("sotientra", typeof(decimal));
            dsxml.Tables[0].Columns.Add("traituyen", typeof(decimal));
            if (ngia)
            {
                dsxml.Tables[0].Columns.Add("gia_th", typeof(decimal));
                dsxml.Tables[0].Columns.Add("gia_bh", typeof(decimal));
                dsxml.Tables[0].Columns.Add("gia_dv", typeof(decimal));
                dsxml.Tables[0].Columns.Add("gia_cs", typeof(decimal));
                dsxml.Tables[0].Columns.Add("gia_nn", typeof(decimal));
            }
            dsxml.Tables[0].Columns.Add("tbh", typeof(decimal));
            dsxml.Tables[0].Columns.Add("tbn", typeof(decimal));
            dsxml.Tables[0].Columns.Add("tltraituyen", typeof(decimal));
            dsxml.Tables[0].Columns.Add("dbh", typeof(decimal));
            dsxml.Tables[0].Columns.Add("dbn", typeof(decimal));
            dsxml.Tables[0].Columns.Add("tlchitra", typeof(decimal));
            string mabstk = "";
            if (File.Exists("..//..//..//chukyuser//" + usrid.ToString() + ".bmp"))
            {
                fstr = new FileStream("..//..//..//chukyuser//" + usrid.ToString() + ".bmp", FileMode.Open, FileAccess.Read);
                imageuser = new byte[fstr.Length];
                fstr.Read(imageuser, 0, System.Convert.ToInt32(fstr.Length));
                fstr.Close();
                bUserid = true;
            }
            dichso.numbertotext doiso = new dichso.numbertotext();
            string matt = "", ma = "", makp = "", sothe = "", _ngay = ngayhienhanh_server, _mmyy = mmyy(_ngay), s = "";
            decimal tcsotien = 0, tcbhyt = 0, tcbhytt0107 = 0, tc = 0, st, tbh, tbn;
            decimal stbhyt = 0, bnt = 0, bht = 0, haophi = 0, bntra = 0, bhyttra = 0, mien = 0;
            int nhom = nhom_duoc, maphu = 0, sophieu = 0, lanin = 0, madt = 0, chitra;
            DataRow r, r1;
            bool bhyt20_khambenh = (loaiba == 3) || (loaiba == 2 && Ngoaitru_bhyt_khambenh) || (Phongluu_bhyt_khambenh && loaiba == 4) || (Noitru_bhyt_khambenh && loaiba == 1);

            if (bTraituyen) lTraituyen = (bhyt20_khambenh) ? lTraituyen_phongkham : lTraituyen_noitru;
            for (int i = 0; i < dr.Length; i++)
            {
                if (!bChitiet || iHaophi != 0) makp = dr[i]["makp"].ToString();
                if (sothe != dr[i]["sothe"].ToString() || matt != dr[i]["matt"].ToString() || ma != dr[i]["mabn"].ToString() || madt != int.Parse(dr[i]["madoituong"].ToString())) //|| makp != dr[i]["makp"].ToString())
                {
                    sothe = dr[i]["sothe"].ToString();
                    matt = dr[i]["matt"].ToString(); ma = dr[i]["mabn"].ToString();
                    madt = int.Parse(dr[i]["madoituong"].ToString());
                    makp = dr[i]["makp"].ToString();
                    stbhyt = tcsotien = tcbhyt = tcbhytt0107 = haophi = bntra = bhyttra = mien = 0;
                    if (bhyt20_khambenh)
                    {
                        s = bntra50(dr);
                        bnt = decimal.Parse(s.Substring(0, s.IndexOf("^")));
                        bht = decimal.Parse(s.Substring(s.IndexOf("^") + 1));
                    }
                    if (dr[i]["done"].ToString() == "0")
                    {
                        string tmp_ngay = _ngay;
                        if (bSophieu_TTRV_theonam)
                        {
                            tmp_ngay = "31/12/" + _ngay.Substring(6, 4);
                            sophieu = get_sophieu_ravien_yy(_mmyy, dr[i]["mabn"].ToString(), decimal.Parse(dr[i]["maql"].ToString()), loaiba, tmp_ngay, int.Parse(dr[i]["madoituong"].ToString()), 0, _ngay);
                        }
                        else
                        {
                            sophieu = get_sophieu_ravien(_mmyy, dr[i]["mabn"].ToString(), decimal.Parse(dr[i]["maql"].ToString()), loaiba, _ngay, int.Parse(dr[i]["madoituong"].ToString()), 0);
                        }
                        lanin = get_laninrv(_mmyy, dr[i]["mabn"].ToString(), decimal.Parse(dr[i]["maql"].ToString()), _ngay, int.Parse(dr[i]["madoituong"].ToString()));
                    }
                    bBacsy = false;
                    if (File.Exists("..//..//..//chuky//" + dr[i]["mabs"].ToString() + ".bmp"))
                    {
                        fstr = new FileStream("..//..//..//chuky//" + dr[i]["mabs"].ToString() + ".bmp", FileMode.Open, FileAccess.Read);
                        image = new byte[fstr.Length];
                        fstr.Read(image, 0, System.Convert.ToInt32(fstr.Length));
                        fstr.Close();
                        bBacsy = true;
                    }
                    mabstk = "";
                    foreach (DataRow r2 in get_data("select * from " + user + ".dmbs where makp='" + dr[i]["makprv"].ToString() + "' and nhom=" + truongkhoa).Tables[0].Rows)
                        mabstk = r2["ma"].ToString();
                    if (mabstk != "")
                    {
                        if (File.Exists("..//..//..//chuky//" + mabstk + ".bmp"))
                        {
                            fstr = new FileStream("..//..//..//chuky//" + mabstk + ".bmp", FileMode.Open, FileAccess.Read);
                            imagetk = new byte[fstr.Length];
                            fstr.Read(imagetk, 0, System.Convert.ToInt32(fstr.Length));
                            fstr.Close();
                            bTruongkhoa = true;
                        }
                    }
                }
                tbh = tbn = 0;
                haophi += (int.Parse(dr[i]["madt"].ToString()) == iHaophi) ? decimal.Parse(dr[i]["sotientra"].ToString()) : 0;
                tcsotien += decimal.Parse(dr[i]["sotientra"].ToString());
                tcbhyt += decimal.Parse(dr[i]["bhyt"].ToString());
                tcbhytt0107 += decimal.Parse(dr[i]["bhytt0107"].ToString());
                if (bhyt20_khambenh && dr[i]["madt"].ToString() == "1" && decimal.Parse(dr[i]["maphu"].ToString()) != 100 && decimal.Parse(dr[i]["maphu"].ToString()) > 0)
                    stbhyt += 0;
                else
                    stbhyt += decimal.Parse(dr[i]["sotientra"].ToString());
                /*
                if (bKhoan && sKhoan_doituong.IndexOf(dr[i]["madoituong"].ToString().PadLeft(2, '0')) != -1 && iKhoan_ma_pttt == int.Parse(dr[i]["ma"].ToString()))
                {
                    stbhyt -= decimal.Parse(dr[i]["sotien"].ToString());
                    tcsotien -= decimal.Parse(dr[i]["sotien"].ToString());
                }*/
                r = dsxml.Tables[0].NewRow();
                if (bBacsy)
                {
                    try { r["image"] = image; }
                    catch { }
                }
                if (bTruongkhoa)
                {
                    try { r["imagetk"] = imagetk; }
                    catch { }
                }
                if (bUserid)
                {
                    try { r["imageuser"] = imageuser; }
                    catch { }
                }
                r["loaiba"] = loaiba;
                r["tenbs"] = dr[i]["tenbs"].ToString();
                r["mabs"] = dr[i]["mabs"].ToString();
                r["makprv"] = dr[i]["makprv"].ToString();
                r["tenuser"] = tenuser;
                r["sophieu"] = sophieu;
                r["lanin"] = lanin;
                r["matt"] = matt;
                r["mabn"] = ma;
                r["hoten"] = dr[i]["hoten"].ToString();
                r["maql"] = dr[i]["maql"].ToString();
                r["idkhoa"] = dr[i]["idkhoa"].ToString();
                r["namsinh"] = dr[i]["namsinh"].ToString();
                r["phai"] = dr[i]["phai"].ToString();
                r["diachi"] = dr[i]["diachi"].ToString();
                r["madoituong"] = dr[i]["madoituong"].ToString();
                r["madoituongvao"] = dr[i]["madoituongvao"].ToString();
                r["doituong"] = dr[i]["doituong"].ToString();
                r["sothe"] = dr[i]["sothe"].ToString();
                r["maphu"] = dr[i]["maphu"].ToString();
                r["denngay"] = dr[i]["denngay"].ToString();
                r["noigioithieu"] = dr[i]["noigioithieu"].ToString();
                r["noicap"] = dr[i]["noicap"].ToString();
                r["giuong"] = dr[i]["giuong"].ToString();
                if (bChitiet)
                {
                    r["makp"] = dr[i]["makp"].ToString();
                    r["tenkp"] = dr[i]["tenkp"].ToString();
                }
                else
                {
                    r["makp"] = ""; r["tenkp"] = "";
                }
                if (ngia)
                {
                    r1 = getrowbyid(dtvp, "id=" + int.Parse(dr[i]["ma"].ToString()));
                    if (r1 != null)
                    {
                        r["gia_th"] = r1["gia_th"].ToString();
                        r["gia_bh"] = r1["gia_bh"].ToString();
                        r["gia_dv"] = r1["gia_dv"].ToString();
                        r["gia_cs"] = r1["gia_cs"].ToString();
                        r["gia_nn"] = r1["gia_nn"].ToString();
                    }
                }
                r["ngayvao"] = dr[i]["ngayvao"].ToString();
                r["ngayra"] = dr[i]["ngayra"].ToString();
                r["chandoan"] = dr[i]["chandoan"].ToString();
                r["maicd"] = dr[i]["maicd"].ToString();
                r["sttnhom"] = dr[i]["sttnhom"].ToString();
                r["nhom"] = dr[i]["nhom"].ToString();
                r["sttloai"] = dr[i]["sttloai"].ToString();
                r["loai"] = dr[i]["loai"].ToString();
                r["ma"] = dr[i]["ma"].ToString();
                r["ten"] = dr[i]["ten"].ToString();
                r["dvt"] = dr[i]["dvt"].ToString();
                r["soluutru"] = dr[i]["soluutru"].ToString();
                r["nguoinha"] = dr[i]["nguoinha"].ToString();
                r["hinhthuc"] = dr[i]["hinhthuc"].ToString();
                r["phuongphap"] = dr[i]["phuongphap"].ToString();
                r["ketqua"] = dr[i]["ketqua"].ToString();
                r["soluong"] = dr[i]["soluong"].ToString();
                r["dongia"] = dr[i]["dongia"].ToString();
                r["sotien"] = dr[i]["sotien"].ToString();
                r["sotientra"] = dr[i]["sotientra"].ToString();
                r["tamung"] = dr[i]["tamung"].ToString();
                r["gianovat"] = dr[i]["gianovat"].ToString();
                r["idttrv"] = dr[i]["idttrv"].ToString();
                r["tcsotien"] = tcsotien;
                r["mien"] = 0;
                r["dbh"] = r["dbn"] = r["tlchitra"] = 0;
                r["tltraituyen"] = iTraituyen;
                if (dr[i]["madt"].ToString() == "1" || dr[i]["madt"].ToString() == "99")
                {
                    if (int.Parse(dr[i]["traituyen"].ToString()) != 0 && iTraituyen != 0 && !btraituyen_bhtra)
                    {
                        chitra = iTraituyen;
                        bhyttra = stbhyt * chitra / 100 + bnt;
                        bntra = stbhyt - (stbhyt * chitra / 100) + bht;
                        r["bhyttra"] = bhyttra;
                        r["bntra"] = bntra;
                        r["tlchitra"] = chitra;
                    }
                    else
                    {
                        if (bhyt20_khambenh)
                        {
                            maphu = d.get_maphu_ngtru(dr[i]["sothe"].ToString(), tcsotien, nhom);
                            if (maphu != 0)
                            {
                                chitra = (maphu == 1) ? 80 : 95;
                                bhyttra = stbhyt * chitra / 100 + bnt;
                                bntra = stbhyt - (stbhyt * chitra / 100) + bht;
                                r["tlchitra"] = chitra;
                            }
                            else
                            {
                                bhyttra = tcsotien;
                                bntra = 0;
                                r["tlchitra"] = 100;
                            }
                        }
                        else
                        {
                            maphu = (dr[i]["sothe"].ToString().Trim() != "") ? d.get_maphu_noitru(dr[i]["sothe"].ToString(), nhom) : 0;
                            if (maphu == 0)
                            {
                                bhyttra = tcsotien;
                                bntra = 0;
                                r["tlchitra"] = 100;
                            }
                            else
                            {
                                chitra = (maphu == 1) ? 80 : 95;
                                bhyttra = stbhyt * chitra / 100 + bnt;
                                bntra = stbhyt - (stbhyt * chitra / 100) + bht;
                                r["tlchitra"] = chitra;
                            }
                        }
                        r["dbh"] = bhyttra;
                        r["dbn"] = bntra;
                        if (int.Parse(dr[i]["traituyen"].ToString()) != 0 && iTraituyen != 0)
                        {
                            st = bhyttra;
                            chitra = iTraituyen;
                            tbh = st * chitra / 100;
                            tbn = st - (st * chitra / 100);
                            bhyttra = tbh;
                            bntra += tbn;
                            r["tlchitra"] = bhyttra / stbhyt * 100;
                        }
                        r["bhyttra"] = bhyttra;
                        r["bntra"] = bntra;
                        if (lTraituyen != 0 && decimal.Parse(r["bhyttra"].ToString()) > lTraituyen && int.Parse(dr[i]["traituyen"].ToString()) != 0)
                        {
                            tc = decimal.Parse(r["bhyttra"].ToString()) + decimal.Parse(r["bntra"].ToString());
                            r["bhyttra"] = lTraituyen;
                            r["bntra"] = tc - lTraituyen;
                        }
                    }
                    r["dichsotra"] = doiso.doithapphan(r["bntra"].ToString());
                }
                else if (mien_doituong(int.Parse(dr[i]["madt"].ToString()), dtdt)) //mien
                {
                    r["mien"] = tcsotien; r["bntra"] = 0; r["bhyttra"] = 0;
                    r["dichsotra"] = doiso.doithapphan(r["mien"].ToString());
                }
                else
                {
                    if (dr[i]["madoituong"].ToString() == "1" && int.Parse(dr[i]["madt"].ToString()) == iHaophi)
                    {
                        r["bntra"] = bntra; r["bhyttra"] = bhyttra;
                    }
                    else
                    {
                        r["bntra"] = tcsotien; r["bhyttra"] = 0;
                    }
                    r["dichsotra"] = doiso.doithapphan(r["bntra"].ToString());
                }
                r["dichso"] = doiso.doithapphan(Convert.ToString(Math.Floor(decimal.Parse(r["tcsotien"].ToString()))));
                r["sbltamung"] = b_sobienlaitamung;
                r["cholam"] = dr[i]["cholam"].ToString();
                r["madt"] = dr[i]["madt"].ToString();
                r["haophi"] = haophi;
                r["traituyen"] = dr[i]["traituyen"].ToString();
                r["tbh"] = tbh;
                r["tbn"] = tbn;
                dsxml.Tables[0].Rows.Add(r);
            }
            return dsxml;
        }

        public DataSet sort_ttravien_ct(DataTable dtdt, DataRow[] dr, int loaiba, string tenuser, int usrid, int iHaophi, DataTable dtvp, bool ngia, DataTable dtbd)
        {
            FileStream fstr;
            DataRow row_locthe;
            byte[] image = null, imagetk = null, imageuser = null;
            bool bChitiet = bInthanhtoanchitiet, bTruongkhoa = false, bBacsy = false, bUserid = false, Phongluu_bhyt_khambenh = bPhongluu_bhyt_khambenh, Ngoaitru_bhyt_khambenh = bNgoaitru_bhyt_khambenh, Noitru_bhyt_khambenh = bNoitru_bhyt_khambenh; ;
            int iKhoan_ma_pttt = iKhoan_mavp_pttt;
            bool bKhoan = bKhoan_vtth, btraituyen_bhtra = bTraituyen_bhtra;
            bool bDichvuKhongcungchitra = false;
            decimal dDichvuKhongcungchitra = 0, d_dichvu_tt_bhyttra = 0, d_dichvu_tt_bntra = 0;//tong tien cac dich vu ma BN khong cung chi tr
            string sKhoan_doituong = sKhoan_madoituong;
            decimal lTraituyen = 0;
            int iTraituyen = iTraituyen_bhyt;
            bool bBHYT_Traituyen_tinhtheo_Tyle_khac = bBHYT_Traituyen_tinh_Tyle_khac;
            decimal d_sotien_traituyen_bhyttra = 0;
            int i_sokytuthe_xet_cpvc = iSokytuthe_xet_chiphivanchuyen;
            //gam 15/08/2011
            string s_vitri_xet_chiphivanchuyen = d.thetunguyen_vitri(1);
            decimal d_cpvc = 0;
            int iKytubegin_xet_chiphivanchuyen = 0, ikytuend_xet_chiphivanchuyen = 0;
            try
            {
                iKytubegin_xet_chiphivanchuyen = int.Parse(s_vitri_xet_chiphivanchuyen.Substring(0, 1));
                ikytuend_xet_chiphivanchuyen = int.Parse(s_vitri_xet_chiphivanchuyen.Substring(2, 1));

            }
            catch
            {
                iKytubegin_xet_chiphivanchuyen = 0;
                ikytuend_xet_chiphivanchuyen = 2;
            }
            //end gam

            DataSet dsxml = new DataSet();
            dsxml.ReadXml("..//..//..//xml//m_inravien.xml");
            dsxml.Tables[0].Columns.Add("tenuser", typeof(string));
            dsxml.Tables[0].Columns.Add("Image", typeof(byte[]));
            dsxml.Tables[0].Columns.Add("Imagetk", typeof(byte[]));
            dsxml.Tables[0].Columns.Add("Imageuser", typeof(byte[]));
            dsxml.Tables[0].Columns.Add("tenbs");
            dsxml.Tables[0].Columns.Add("mabs");
            dsxml.Tables[0].Columns.Add("makprv");
            dsxml.Tables[0].Columns.Add("cholam");
            dsxml.Tables[0].Columns.Add("madt", typeof(decimal));
            dsxml.Tables[0].Columns.Add("haophi", typeof(decimal));
            dsxml.Tables[0].Columns.Add("gianovat", typeof(decimal));
            dsxml.Tables[0].Columns.Add("idttrv", typeof(decimal));
            dsxml.Tables[0].Columns.Add("sotientra", typeof(decimal));
            dsxml.Tables[0].Columns.Add("traituyen", typeof(decimal));


            if (ngia)
            {
                dsxml.Tables[0].Columns.Add("gia_th", typeof(decimal));
                dsxml.Tables[0].Columns.Add("gia_bh", typeof(decimal));
                dsxml.Tables[0].Columns.Add("gia_dv", typeof(decimal));
                dsxml.Tables[0].Columns.Add("gia_cs", typeof(decimal));
                dsxml.Tables[0].Columns.Add("gia_nn", typeof(decimal));
            }
            dsxml.Tables[0].Columns.Add("tbh", typeof(decimal));
            dsxml.Tables[0].Columns.Add("tbn", typeof(decimal));
            dsxml.Tables[0].Columns.Add("tltraituyen", typeof(decimal));
            dsxml.Tables[0].Columns.Add("dbh", typeof(decimal));
            dsxml.Tables[0].Columns.Add("dbn", typeof(decimal));
            dsxml.Tables[0].Columns.Add("tlchitra", typeof(decimal));
            dsxml.Tables[0].Columns.Add("kythuat", typeof(decimal));
            dsxml.Tables[0].Columns.Add("loaikythuat", typeof(string));
            //
            dsxml.Tables[0].Columns.Add("tong_tu", typeof(decimal)).DefaultValue = 0;
            dsxml.Tables[0].Columns.Add("bienlai_tu", typeof(string));
            dsxml.Tables[0].Columns.Add("tongcp", typeof(decimal)).DefaultValue = 0;
            dsxml.Tables[0].Columns.Add("tongmien", typeof(decimal)).DefaultValue = 0;
            dsxml.Tables[0].Columns.Add("tongbhyttra", typeof(decimal)).DefaultValue = 0;
            dsxml.Tables[0].Columns.Add("tongbntra", typeof(decimal)).DefaultValue = 0;
            dsxml.Tables[0].Columns.Add("capcuu", typeof(decimal)).DefaultValue = 0;
            //
            dsxml.Tables[0].Columns.Add("tlchinhsach", typeof(decimal));//gam 10/10/2011
            try { dsxml.Tables[0].Columns.Add("ID_KTCAO", typeof(decimal)); }
            catch { }
            try { dsxml.Tables[0].Columns.Add("ID_VPKHOA", typeof(decimal)); }
            catch { }
            try { dsxml.Tables[0].Columns.Add("VUOTTRAN", typeof(decimal)); }
            catch { }
            try { dsxml.Tables[0].Columns.Add("dinhmucKTcao", typeof(decimal)).DefaultValue = 0; }
            catch { }
            try { dsxml.Tables[0].Columns.Add("dichsotamung", typeof(string)); }
            catch { }
            //
            string mabstk = "";
            if (File.Exists("..//..//..//chukyuser//" + usrid.ToString() + ".bmp"))
            {
                fstr = new FileStream("..//..//..//chukyuser//" + usrid.ToString() + ".bmp", FileMode.Open, FileAccess.Read);
                imageuser = new byte[fstr.Length];
                fstr.Read(imageuser, 0, System.Convert.ToInt32(fstr.Length));
                fstr.Close();
                bUserid = true;
            }
            dichso.numbertotext doiso = new dichso.numbertotext();
            string matt = "", ma = "", makp = "", sothe = "", _ngay = ngayhienhanh_server, _mmyy = mmyy(_ngay), s = "";
            decimal tcsotien = 0, tcbhyt = 0, tcbhytt0107 = 0, tc = 0, st, tbh, tbn;
            decimal stbhyt = 0, bnt = 0, bht = 0, haophi = 0, bntra = 0, bhyttra = 0, mien = 0;
            decimal zbntra = 0, zbhyttra = 0, zmien = 0, ztsbhyt = 0;
            decimal d_tongbntra = 0, d_tongbhyttra = 0, d_tongmien = 0, d_tongcp = 0, d_bntra_ct = 0, d_bhyttra_ct = 0;
            decimal d_stbhytthe = 0;
            string stsbhyt_the = "", s_sothe = "", s_cac_sothe = "";
            int nhom = nhom_duoc, maphu = 0, sophieu = 0, lanin = 0, madt = 0;
            decimal chitra = 0, chitra_tt = 0;
            //


            int i_tyle_chinhsach = 0; //gam 10/10/2011 bv kontum ngoai bhyt chi tra theo ti le the thi co them nguon khac chi tra chi phan bn tra coon lai, ty le trong tinh va ngoai tinh la khac nhau

            //
            DataTable table2 = get_data("select id,sothe from " + user + ".d_dmbd where nhom=" + nhom + " and sothe is not null union all select id, sothe from  " + user + ".v_giavp where sothe is not null").Tables[0];
            //
            //
            DataRow r, r1;
            bool bNhapvien = false;
            bool bhyt20_khambenh = true;//Ngay truoc: PK tinh theo nguong, noi tru: kgong xet nguong; gio: tat ca deu tinh theo nguong
            ///bool bhyt20_khambenh =  (loaiba == 3) || (loaiba == 2 && Ngoaitru_bhyt_khambenh) || (Phongluu_bhyt_khambenh && loaiba == 4) || (Noitru_bhyt_khambenh && loaiba == 1);
            if (loaiba == 4 && bPhongluu_bhyt_khambenh_khongnhapvien && dr.Length>0)
            {
                //neu BN phong luu nhap vien thi khong tinh nhu phong kham: dua vao tong chi phi duoi 97.500
                sql = "select a.mabn, a.maql from " + user + ".benhandt a, xxx.benhancc b where a.mavaovien=b.mavaovien and a.mabn='" + dr[0]["mabn"].ToString() + "' and b.maql=" + dr[0]["maql"].ToString();
                bNhapvien = get_data_mmyy(sql, dr[0]["ngayvao"].ToString(), dr[0]["ngayra"].ToString(), true).Tables[0].Rows.Count == 0;
            }
            //lay nhan tu - xac dinh cap cuu hay khong cap cuu
            bool bBNCapcuu = false;
            try
            {
                sql = "select a.mabn, a.maql, a.mavaovien, c.makp from " + user + ".benhandt a inner join xxx.benhancc b on a.mavaovien=b.mavaovien inner join medibv.nhapkhoa c on a.maql=c.maql inner join medibv.bhyt d on c.maql=d.maql ";
                sql+=" where c.khoachuyen='01' and a.mabn='" + dr[0]["mabn"].ToString() + "' and a.maql=" + dr[0]["maql"].ToString();
                sql += " and d.traituyen=0 ";
                bBNCapcuu = get_data_mmyy(sql, dr[0]["ngayvao"].ToString(), dr[0]["ngayra"].ToString(), true).Tables[0].Rows.Count > 0;
            }
            catch { bBNCapcuu = false; }
            //
            bool bDuoimuocchitra = false;//true: tong chi phi thuoc BHYT duoi muc chi tra cung chi tra theo BHYT qui dinh
            if (bTraituyen) lTraituyen = (bhyt20_khambenh) ? lTraituyen_phongkham : lTraituyen_noitru;
            //Lay tong chi phi cua BN thuoc BHYT
            string stendichvu = "";
            for (int i = 0; i < dr.Length; i++)
            {
                stendichvu = dr[i]["ten"].ToString();
                //gam 15/08/2011
                row_locthe = this.getrowbyid(table2, "id=" + int.Parse(dr[i]["ma"].ToString()));
                if (row_locthe != null && row_locthe["sothe"].ToString().Trim() != "")
                {
                    if ((dr[i]["madt"].ToString() == "1") && (row_locthe != null) && (row_locthe["sothe"].ToString().Trim().IndexOf(dr[i]["sothe"].ToString().Substring(iKytubegin_xet_chiphivanchuyen, ikytuend_xet_chiphivanchuyen)) != -1))
                    {
                        d_cpvc += decimal.Parse(dr[i]["bhyt"].ToString() == "" ? "0" : dr[i]["bhyt"].ToString());
                    }
                }
                //end gam
                //ztsbhyt += (dr[i]["madt"].ToString() == "1") ? decimal.Parse(dr[i]["bhyt"].ToString()) : 0;
                ztsbhyt += (dr[i]["madt"].ToString() == "1") ? ((decimal.Parse(dr[i]["bhyt"].ToString()) == 0) ? decimal.Parse(dr[i]["sotien"].ToString()) : decimal.Parse(dr[i]["bhyt"].ToString())) : 0;

                if (dr[i]["madt"].ToString() == "1" && s_sothe != dr[i]["sothe"].ToString())
                {
                    if (d_stbhytthe != 0) stsbhyt_the += d_stbhytthe + "^";
                    d_stbhytthe = 0;
                    s_sothe = dr[i]["sothe"].ToString();
                    s_cac_sothe += dr[i]["sothe"].ToString() + "^";
                }
                else if (dr[i]["madt"].ToString() == "1" && s_sothe == dr[i]["sothe"].ToString())
                {
                    d_stbhytthe += decimal.Parse(dr[i]["bhyt"].ToString());
                }

            }
            if (d_stbhytthe != 0) stsbhyt_the += d_stbhytthe + "^";
            if ((ztsbhyt - d_cpvc) < d.ma16_st(nhom_duoc) && bhyt20_khambenh)//gam 15/08/2011
            {
                bDuoimuocchitra = true;
            }
            //
            for (int i = 0; i < dr.Length; i++)
            {
                if (!bChitiet || iHaophi != 0) makp = dr[i]["makp"].ToString();
                if (sothe != dr[i]["sothe"].ToString() || matt != dr[i]["matt"].ToString() || ma != dr[i]["mabn"].ToString() || madt != int.Parse(dr[i]["madoituong"].ToString())) //|| makp != dr[i]["makp"].ToString())
                {
                    dDichvuKhongcungchitra = 0; d_dichvu_tt_bntra = 0; d_dichvu_tt_bhyttra = 0;
                    sothe = dr[i]["sothe"].ToString();
                    matt = dr[i]["matt"].ToString(); ma = dr[i]["mabn"].ToString();
                    madt = int.Parse(dr[i]["madoituong"].ToString());
                    makp = dr[i]["makp"].ToString();
                    stbhyt = tcsotien = tcbhyt = tcbhytt0107 = haophi = bntra = bhyttra = mien = 0;

                    if (dr[i]["sothe"].ToString() != "" && dr[i]["traituyen"].ToString() == "0")
                    {
                        i_tyle_chinhsach = get_tyle_bhyt_chinhsach(dr[i]["sothe"].ToString());
                    }
                    else
                    {
                        i_tyle_chinhsach = 0;
                    }

                    zbntra = zbhyttra = zmien = 0;
                    //binh comment 20042011
                    //if (bhyt20_khambenh)
                    //{
                    //    s = bntra50(dr);
                    //    bnt = decimal.Parse(s.Substring(0, s.IndexOf("^")));
                    //    bht = decimal.Parse(s.Substring(s.IndexOf("^") + 1));
                    //}
                    //
                    if (dr[i]["done"].ToString() == "0")
                    {
                        //
                        string tmp_ngay = _ngay;
                        if (bSophieu_TTRV_theonam)
                        {
                            tmp_ngay = "31/12/" + _ngay.Substring(6, 4);
                            sophieu = get_sophieu_ravien_yy(_mmyy, dr[i]["mabn"].ToString(), decimal.Parse(dr[i]["maql"].ToString()), loaiba, tmp_ngay, int.Parse(dr[i]["madoituong"].ToString()), 0, _ngay);
                        }
                        else if (bSophieu_TTRV_theonam_tinhtu_taosolieu)
                        {
                            tmp_ngay = get_ngaytao_solieu_thangmoi("01" + _mmyy.Substring(2, 2), nhom_duoc);
                            sophieu = get_sophieu_ravien_yy(_mmyy, dr[i]["mabn"].ToString(), decimal.Parse(dr[i]["maql"].ToString()), loaiba, tmp_ngay, int.Parse(dr[i]["madoituong"].ToString()), 0, _ngay);
                        }
                        else if (bSophieu_TTRV_theothang_tinhtu_ngay01)
                        {
                            tmp_ngay = "01/" + _ngay.Substring(3, 2) + "/" + _ngay.Substring(6, 4);
                            sophieu = get_sophieu_ravien(_mmyy, dr[i]["mabn"].ToString(), decimal.Parse(dr[i]["maql"].ToString()), loaiba, tmp_ngay, int.Parse(dr[i]["madoituong"].ToString()), 0);
                        }
                        else if (bSophieu_TTRV_theothang_tinhtu_toasolieu)
                        {
                            tmp_ngay = get_ngaytao_solieu_thangmoi(_mmyy, nhom_duoc);
                            sophieu = get_sophieu_ravien(_mmyy, dr[i]["mabn"].ToString(), decimal.Parse(dr[i]["maql"].ToString()), loaiba, tmp_ngay, int.Parse(dr[i]["madoituong"].ToString()), 0);
                        }
                        else sophieu = get_sophieu_ravien(_mmyy, dr[i]["mabn"].ToString(), decimal.Parse(dr[i]["maql"].ToString()), loaiba, tmp_ngay, int.Parse(dr[i]["madoituong"].ToString()), 0);


                        lanin = get_laninrv(_mmyy, dr[i]["mabn"].ToString(), decimal.Parse(dr[i]["maql"].ToString()), _ngay, int.Parse(dr[i]["madoituong"].ToString()));
                    }
                    bBacsy = false;
                    if (File.Exists("..//..//..//chuky//" + dr[i]["mabs"].ToString() + ".bmp"))
                    {
                        fstr = new FileStream("..//..//..//chuky//" + dr[i]["mabs"].ToString() + ".bmp", FileMode.Open, FileAccess.Read);
                        image = new byte[fstr.Length];
                        fstr.Read(image, 0, System.Convert.ToInt32(fstr.Length));
                        fstr.Close();
                        bBacsy = true;
                    }
                    mabstk = "";
                    foreach (DataRow r2 in get_data("select * from " + user + ".dmbs where makp='" + dr[i]["makprv"].ToString() + "' and nhom=" + truongkhoa).Tables[0].Rows)
                        mabstk = r2["ma"].ToString();
                    if (mabstk != "")
                    {
                        if (File.Exists("..//..//..//chuky//" + mabstk + ".bmp"))
                        {
                            fstr = new FileStream("..//..//..//chuky//" + mabstk + ".bmp", FileMode.Open, FileAccess.Read);
                            imagetk = new byte[fstr.Length];
                            fstr.Read(imagetk, 0, System.Convert.ToInt32(fstr.Length));
                            fstr.Close();
                            bTruongkhoa = true;
                        }
                    }
                }
                tbh = tbn = 0;
                haophi += (int.Parse(dr[i]["madt"].ToString()) == iHaophi) ? decimal.Parse(dr[i]["sotientra"].ToString()) : 0;
                tcsotien += decimal.Parse(dr[i]["sotientra"].ToString());
                tcbhyt += decimal.Parse(dr[i]["bhyt"].ToString());
                tcbhytt0107 += decimal.Parse(dr[i]["bhytt0107"].ToString());
                //if (bhyt20_khambenh && dr[i]["madt"].ToString() == "1" && decimal.Parse(dr[i]["maphu"].ToString()) != 100 && decimal.Parse(dr[i]["maphu"].ToString()) > 0)
                if (bhyt20_khambenh && dr[i]["madt"].ToString() == "1" && decimal.Parse(dr[i]["maphu"].ToString()) == 0)//100 && decimal.Parse(dr[i]["maphu"].ToString()) > 0)
                    stbhyt += 0;
                else
                    stbhyt += decimal.Parse(dr[i]["sotientra"].ToString());
                /*
                if (bKhoan && sKhoan_doituong.IndexOf(dr[i]["madoituong"].ToString().PadLeft(2, '0')) != -1 && iKhoan_ma_pttt == int.Parse(dr[i]["ma"].ToString()))
                {
                    stbhyt -= decimal.Parse(dr[i]["sotien"].ToString());
                    tcsotien -= decimal.Parse(dr[i]["sotien"].ToString());
                }*/
                r = dsxml.Tables[0].NewRow();
                if (bBacsy)
                {
                    try { r["image"] = image; }
                    catch { }
                }
                if (bTruongkhoa)
                {
                    try { r["imagetk"] = imagetk; }
                    catch { }
                }
                if (bUserid)
                {
                    try { r["imageuser"] = imageuser; }
                    catch { }
                }
                r["loaiba"] = loaiba;
                r["tenbs"] = dr[i]["tenbs"].ToString();
                r["mabs"] = dr[i]["mabs"].ToString();
                r["makprv"] = dr[i]["makprv"].ToString();
                r["tenuser"] = tenuser;
                r["sophieu"] = sophieu;
                r["lanin"] = lanin;
                r["matt"] = matt;
                r["mabn"] = ma;
                r["hoten"] = dr[i]["hoten"].ToString();
                r["maql"] = dr[i]["maql"].ToString();
                r["idkhoa"] = dr[i]["idkhoa"].ToString();
                r["namsinh"] = dr[i]["namsinh"].ToString();
                r["phai"] = dr[i]["phai"].ToString();
                r["diachi"] = dr[i]["diachi"].ToString();
                r["madoituong"] = dr[i]["madoituong"].ToString();
                r["madoituongvao"] = dr[i]["madoituongvao"].ToString();
                r["doituong"] = dr[i]["doituong"].ToString();
                r["sothe"] = dr[i]["sothe"].ToString();
                r["maphu"] = dr[i]["maphu"].ToString();
                r["denngay"] = dr[i]["denngay"].ToString();
                r["noigioithieu"] = dr[i]["noigioithieu"].ToString();
                r["noicap"] = dr[i]["noicap"].ToString();
                r["giuong"] = dr[i]["giuong"].ToString();
                //
                r["tong_tu"] = tc_tamung;
                r["dichsotamung"] = doiso.doithapphan(tc_tamung.ToString());
                r["bienlai_tu"] = b_tatca_sobienlaitamung;
                //
                r["tlchinhsach"] = i_tyle_chinhsach;
                if (bChitiet)
                {
                    r["makp"] = dr[i]["makp"].ToString();
                    r["tenkp"] = dr[i]["tenkp"].ToString();
                }
                else
                {
                    r["makp"] = ""; r["tenkp"] = "";
                }
                bDichvuKhongcungchitra = false;
                r1 = getrowbyid(dtvp, "id=" + int.Parse(dr[i]["ma"].ToString()));
                if (r1 != null)
                {
                    bDichvuKhongcungchitra = r1["kcct"].ToString() == "1";
                }
                else
                {
                    DataRow r12 = getrowbyid(dtbd, "id=" + int.Parse(dr[i]["ma"].ToString()));
                    if (r12 != null)
                    {
                        bDichvuKhongcungchitra = r12["kcct"].ToString() == "1";
                    }
                }
                if (bDichvuKhongcungchitra && dr[i]["madt"].ToString() == "1")
                {
                    dDichvuKhongcungchitra += decimal.Parse(dr[i]["bhyt"].ToString());
                }
                if (bDichvuKhongcungchitra == false) { bnt = bht = 0; }
                if (ngia)
                {
                    //r1 = getrowbyid(dtvp, "id=" + int.Parse(dr[i]["ma"].ToString()));
                    if (r1 != null)
                    {
                        r["gia_th"] = r1["gia_th"].ToString();
                        r["gia_bh"] = r1["gia_bh"].ToString();
                        r["gia_dv"] = r1["gia_dv"].ToString();
                        r["gia_cs"] = r1["gia_cs"].ToString();
                        r["gia_nn"] = r1["gia_nn"].ToString();
                    }
                }
                r["ngayvao"] = dr[i]["ngayvao"].ToString();
                r["ngayra"] = dr[i]["ngayra"].ToString();
                r["chandoan"] = dr[i]["chandoan"].ToString();
                r["maicd"] = dr[i]["maicd"].ToString();
                r["sttnhom"] = dr[i]["sttnhom"].ToString();
                r["nhom"] = dr[i]["nhom"].ToString();
                r["sttloai"] = dr[i]["sttloai"].ToString();
                r["loai"] = dr[i]["loai"].ToString();
                r["ma"] = dr[i]["ma"].ToString();
                r["ten"] = dr[i]["ten"].ToString();
                r["dvt"] = dr[i]["dvt"].ToString();
                r["soluutru"] = dr[i]["soluutru"].ToString() + "^" + ((bNhapvien) ? "1" : "0");
                r["nguoinha"] = dr[i]["nguoinha"].ToString();
                r["hinhthuc"] = dr[i]["hinhthuc"].ToString();
                r["phuongphap"] = dr[i]["phuongphap"].ToString();
                r["ketqua"] = dr[i]["ketqua"].ToString();
                r["soluong"] = dr[i]["soluong"].ToString();
                r["dongia"] = dr[i]["dongia"].ToString();
                r["sotien"] = dr[i]["sotien"].ToString();
                r["sotientra"] = dr[i]["sotientra"].ToString();
                r["tamung"] = dr[i]["tamung"].ToString();
                r["gianovat"] = dr[i]["gianovat"].ToString();
                r["idttrv"] = dr[i]["idttrv"].ToString();
                r["tcsotien"] = tcsotien;
                r["mien"] = 0;
                //
                r["capcuu"] = bBNCapcuu ? "1" : "0";//binh 29102013
                //
                r["dbh"] = r["dbn"] = r["tlchitra"] = 0;
                r["tltraituyen"] = iTraituyen;
                r["kythuat"] = dr[i]["kythuat"].ToString();
                r["loaikythuat"] = dr[i]["loaikythuat"].ToString();
                if (dr[i]["madt"].ToString() == "1" || dr[i]["madt"].ToString() == "99")
                {

                    if (int.Parse(dr[i]["traituyen"].ToString()) != 0 && iTraituyen != 0 && !btraituyen_bhtra)
                    {
                        //chitra = (bDichvuKhongcungchitra) ? 100 : iTraituyen;
                        chitra = iTraituyen;
                        chitra_tt = chitra;
                        row_locthe = this.getrowbyid(table2, "id=" + int.Parse(dr[i]["ma"].ToString()));

                        if (bBHYT_Traituyen_tinhtheo_Tyle_khac && r1 != null && decimal.Parse(r1["bhyt_tt"].ToString()) != decimal.Parse(r1["bhyt"].ToString()))
                        {
                            dDichvuKhongcungchitra += decimal.Parse(dr[i]["sotien"].ToString());// *(decimal.Parse(r1["bhyt_tt"].ToString()) / 100);
                            d_dichvu_tt_bhyttra += decimal.Parse(dr[i]["sotien"].ToString()) * (decimal.Parse(r1["bhyt_tt"].ToString()) / 100);
                            d_dichvu_tt_bntra += decimal.Parse(dr[i]["sotien"].ToString()) * (100 - decimal.Parse(r1["bhyt_tt"].ToString())) / 100;
                            r["ten"] = dr[i]["ten"].ToString() + " [trái tuyến BHYT trả " + decimal.Parse(r1["bhyt_tt"].ToString()).ToString("##") + "%]";
                            chitra_tt = decimal.Parse(r1["bhyt_tt"].ToString());
                        }


                        bhyttra = (stbhyt - dDichvuKhongcungchitra) * chitra / 100 + bnt + d_dichvu_tt_bhyttra;//bhyttra = stbhyt * chitra / 100 + bnt;
                        bntra = (stbhyt - dDichvuKhongcungchitra) - ((stbhyt - dDichvuKhongcungchitra) * chitra / 100) + bht + d_dichvu_tt_bntra;

                        r["bhyttra"] = bhyttra;
                        r["bntra"] = bntra;
                        r["tlchitra"] = chitra_tt;
                        zbhyttra += decimal.Parse(dr[i]["sotien"].ToString()) * chitra / 100;
                        zbntra += decimal.Parse(dr[i]["sotien"].ToString()) - (decimal.Parse(dr[i]["sotien"].ToString()) * chitra / 100);
                    }
                    else
                    {
                        if (bhyt20_khambenh && bDuoimuocchitra)
                        {
                            //gam 15/08/2011 
                            maphu = d.get_maphu_ngtru(dr[i]["sothe"].ToString(), (ztsbhyt - d_cpvc), nhom); //maphu = d.get_maphu_ngtru(dr[i]["sothe"].ToString(), tcsotien, nhom);
                            //end gam
                            if (maphu != 0)
                            {
                                chitra = (maphu == 1) ? 80 : 95;
                                //bhyttra = stbhyt * chitra / 100 + bnt;
                                //bntra = stbhyt - (stbhyt * chitra / 100) + bht;
                                bhyttra = (stbhyt - dDichvuKhongcungchitra) * chitra / 100 + bnt + dDichvuKhongcungchitra;
                                bntra = (stbhyt - dDichvuKhongcungchitra) - ((stbhyt - dDichvuKhongcungchitra) * chitra / 100) + bht;
                                //
                                r["tlchitra"] = (bDichvuKhongcungchitra) ? 100 : chitra;
                                zbhyttra += (bDichvuKhongcungchitra) ? decimal.Parse(dr[i]["sotien"].ToString()) : decimal.Parse(dr[i]["sotien"].ToString()) * chitra / 100;
                                zbntra += (bDichvuKhongcungchitra) ? 0 : decimal.Parse(dr[i]["sotien"].ToString()) - (decimal.Parse(dr[i]["sotien"].ToString()) * chitra / 100);
                            }
                            else
                            {
                                bhyttra = tcsotien;
                                bntra = 0;
                                r["tlchitra"] = 100;
                                zbhyttra += tcsotien;
                                zbntra += 0;
                            }
                        }
                        else
                        {
                            //ThanhCuong - 13/08/2012 - kỹ thuật cao
                            if (decimal.Parse(dr[i]["tLchitraktcao"].ToString()) != 0)
                            {
                                chitra = decimal.Parse(dr[i]["tLchitraktcao"].ToString());
                                if (chitra == 100)
                                {
                                    bhyttra = decimal.Parse(dr[i]["sotien"].ToString());
                                    bntra = 0;
                                    r["tlchitra"] = 100;
                                    zbhyttra += decimal.Parse(dr[i]["sotien"].ToString());
                                    zbntra += 0;
                                }
                                else
                                {
                                    bhyttra = decimal.Parse(dr[i]["sotien"].ToString()) * (chitra / 100);
                                    bntra = decimal.Parse(dr[i]["sotien"].ToString()) - bhyttra;
                                    r["tlchitra"] = chitra;
                                    zbhyttra += decimal.Parse(dr[i]["sotien"].ToString()) * (chitra / 100);
                                    zbntra += decimal.Parse(dr[i]["sotien"].ToString()) - (decimal.Parse(dr[i]["sotien"].ToString()) * (chitra / 100));
                                }
                            }
                            else if (decimal.Parse(dr[i]["id_ktcao"].ToString()) > 0)
                            {
                                maphu = (dr[i]["sothe"].ToString().Trim() != "") ? d.get_maphu_noitru(dr[i]["sothe"].ToString(), nhom) : 0;
                                bhyttra = 0;
                                bntra = 0;
                                r["tlchitra"] = (maphu == 0) ? 100 : (maphu == 1) ? 80 : 95;
                                zbhyttra += 0;
                                zbntra += 0;
                            }
                            //end ThanhCuong
                            else
                            {
                                maphu = (dr[i]["sothe"].ToString().Trim() != "") ? d.get_maphu_noitru(dr[i]["sothe"].ToString(), nhom) : 0;
                                if (maphu == 0)
                                {
                                    bhyttra = tcsotien;
                                    bntra = 0;
                                    r["tlchitra"] = 100;
                                    zbhyttra += tcsotien;
                                    zbntra += 0;
                                }
                                else
                                {
                                    chitra = (maphu == 1) ? 80 : 95;
                                    //bhyttra = stbhyt * chitra / 100 + bnt;
                                    //bntra = stbhyt - (stbhyt * chitra / 100) + bht;
                                    bhyttra = ((stbhyt - dDichvuKhongcungchitra) * chitra / 100) + bnt + dDichvuKhongcungchitra;
                                    bntra = (stbhyt - dDichvuKhongcungchitra) - ((stbhyt - dDichvuKhongcungchitra) * chitra / 100) + bht;// d_dichvu_tt_bntra;
                                    //gam 10/10/2011                               
                                    zmien = bntra * i_tyle_chinhsach / 100;
                                    bntra = bntra - zmien;
                                    r["mien"] = zmien;
                                    //end gam
                                    //r["tlchitra"] = chitra;
                                    r["tlchitra"] = (bDichvuKhongcungchitra) ? 100 : chitra;
                                    zbhyttra += (bDichvuKhongcungchitra) ? decimal.Parse(dr[i]["sotien"].ToString()) : decimal.Parse(dr[i]["sotien"].ToString()) * chitra / 100;
                                    zbntra += (bDichvuKhongcungchitra) ? 0 : decimal.Parse(dr[i]["sotien"].ToString()) - (decimal.Parse(dr[i]["sotien"].ToString()) * chitra / 100);
                                }
                            }
                        }
                        r["dbh"] = bhyttra;
                        r["dbn"] = bntra;
                        if (int.Parse(dr[i]["traituyen"].ToString()) != 0 && iTraituyen != 0)
                        {
                            st = bhyttra;
                            if (bBHYT_Traituyen_tinhtheo_Tyle_khac == false)
                                chitra = iTraituyen;
                            else
                            {
                                chitra = (r1 == null) ? iTraituyen : int.Parse(r1["bhyt_tt"].ToString());
                                if (chitra == 100) chitra = iTraituyen;
                            }
                            tbh = st * chitra / 100;
                            tbn = st - (st * chitra / 100);
                            bhyttra = tbh;
                            bntra += tbn;
                            r["tlchitra"] = bhyttra / stbhyt * 100;
                            //
                            zbntra += zbhyttra - (zbhyttra * chitra / 100);
                            zbhyttra = zbhyttra * chitra / 100;
                            //
                        }
                        r["bhyttra"] = bhyttra;
                        r["bntra"] = bntra;
                        if (lTraituyen != 0 && decimal.Parse(r["bhyttra"].ToString()) > lTraituyen && int.Parse(dr[i]["traituyen"].ToString()) != 0)
                        {
                            tc = decimal.Parse(r["bhyttra"].ToString()) + decimal.Parse(r["bntra"].ToString());
                            r["bhyttra"] = lTraituyen;
                            r["bntra"] = tc - lTraituyen;
                        }
                    }
                    //
                    row_locthe = this.getrowbyid(table2, "id=" + int.Parse(dr[i]["ma"].ToString()));
                    if (row_locthe != null && row_locthe["sothe"].ToString().Trim() != "")
                    {
                        decimal d_st1 = (decimal.Parse(dr[i]["sotien"].ToString()) * chitra / 100);//bhyt tra het: neu dung the
                        decimal d_st2 = decimal.Parse(dr[i]["sotien"].ToString());
                        //if ((maphu != 0 || (int.Parse(dr[i]["traituyen"].ToString()) != 0 && iTraituyen != 0)) && (row_locthe != null) && (row_locthe["sothe"].ToString().Trim().IndexOf(dr[i]["sothe"].ToString().Substring(iKytubegin_xet_chiphivanchuyen, ikytuend_xet_chiphivanchuyen)) != -1))
                        if ((maphu != 0 && int.Parse(dr[i]["traituyen"].ToString()) == 0) && (row_locthe != null) && (row_locthe["sothe"].ToString().Trim().IndexOf(dr[i]["sothe"].ToString().Substring(iKytubegin_xet_chiphivanchuyen, ikytuend_xet_chiphivanchuyen)) != -1))
                        {

                            bhyttra = bhyttra + decimal.Parse(dr[i]["sotien"].ToString());
                            //bntra = bntra + d_st1 - d_st2;
                            //bhyttra = bhyttra + decimal.Parse(dr[i]["sotien"].ToString());
                            chitra = 100;
                            r["bhyttra"] = bhyttra;
                            r["bntra"] = bntra;
                            r["tlchitra"] = chitra;
                            r["dbh"] = r["bhyttra"].ToString();
                            r["dbn"] = r["bntra"].ToString();
                            r["kythuat"] = 9;
                        }
                        //else
                        //{
                        //    bhyttra = bhyttra - d_st2;
                        //    bntra = bntra + d_st2;
                        //    chitra = 0;
                        //    r["bhyttra"] = bhyttra;
                        //    r["bntra"] = bntra;
                        //    r["tlchitra"] = chitra;
                        //    r["dbh"] = r["bhyttra"].ToString();
                        //    r["dbn"] = r["bntra"].ToString();
                        //    r["kythuat"] = 9;
                        //}
                    }
                    //
                    r["dichsotra"] = doiso.doithapphan(r["bntra"].ToString());
                    //
                    d_bntra_ct = bntra; d_bhyttra_ct = bhyttra;
                    //
                }
                else if (mien_doituong(int.Parse(dr[i]["madt"].ToString()), dtdt)) //mien
                {
                    r["mien"] = tcsotien; r["bntra"] = 0; r["bhyttra"] = 0;
                    zmien = tcsotien;
                    r["dichsotra"] = doiso.doithapphan(r["mien"].ToString());
                }
                else
                {
                    if (dr[i]["madoituong"].ToString() == "1" && int.Parse(dr[i]["madt"].ToString()) == iHaophi)
                    {
                        r["bntra"] = bntra; r["bhyttra"] = bhyttra;
                    }
                    else
                    {
                        r["bntra"] = tcsotien; r["bhyttra"] = 0;
                        zbntra = tcsotien;
                    }
                    r["dichsotra"] = doiso.doithapphan(r["bntra"].ToString());
                }
                r["dichso"] = doiso.doithapphan(Convert.ToString(Math.Floor(decimal.Parse(r["tcsotien"].ToString()))));
                r["sbltamung"] = b_sobienlaitamung;
                r["cholam"] = dr[i]["cholam"].ToString();
                r["madt"] = dr[i]["madt"].ToString();
                r["haophi"] = haophi;
                r["traituyen"] = dr[i]["traituyen"].ToString();
                r["tbh"] = tbh;
                r["tbn"] = tbn;
                //
                d_tongcp += decimal.Parse(dr[i]["sotien"].ToString());
                d_tongbhyttra += 0;
                d_tongbntra += (dr[i]["madt"].ToString() == "1" || mien_doituong(int.Parse(dr[i]["madt"].ToString()), dtdt)) ? 0 : decimal.Parse(dr[i]["sotien"].ToString());
                d_tongmien = zmien;
                try
                {
                    r["id_ktcao"] = dr[i]["id_ktcao"].ToString();
                }
                catch { r["id_ktcao"] = 0; }
                try
                {
                    r["id_vpkhoa"] = dr[i]["id_vpkhoa"].ToString();
                }
                catch { r["id_vpkhoa"] = 0; }
                try
                {
                    r["vuottran"] = dr[i]["vuottran"].ToString();
                }
                catch { }
                 try
                {
                    r["dinhmucKTcao"] = dr[i]["dinhmucKTcao"].ToString();
                }
                catch { }
                dsxml.Tables[0].Rows.Add(r);
            }
            //cap nhat lai tong chi phi
            d_tongbhyttra += d_bhyttra_ct;
            d_tongbntra += d_bntra_ct;
            //
            foreach (DataRow r_tong in dsxml.Tables[0].Rows)
            {
                r_tong["tongcp"] = d_tongcp;
                r_tong["tongmien"] = d_tongmien;
                r_tong["tongbhyttra"] = d_tongbhyttra;
                r_tong["tongbntra"] = d_tongbntra;
            }
            dsxml.AcceptChanges();
            //dsxml.WriteXml("..//xml//ravien.xml", XmlWriteMode.WriteSchema);
            //
            return dsxml;
        }

        public string bntra50(DataRow[] dr)
        {
            decimal s1 = 0, s2 = 0, st = 0;
            for (int i = 0; i < dr.Length; i++)
                if (dr[i]["madoituong"].ToString() == "1" && decimal.Parse(dr[i]["maphu"].ToString()) != 100 && decimal.Parse(dr[i]["maphu"].ToString()) > 0)
                {
                    st = decimal.Parse(dr[i]["sotien"].ToString());
                    s1 = st; s2 = st - s1;
                }
            return s1.ToString() + "^" + s2.ToString();
        }

        private decimal get_bhyt(DataTable dt, decimal mabd, string ngay)
        {
            decimal ret = 0; ngay = ngay.Substring(6, 4) + ngay.Substring(3, 2) + ngay.Substring(0, 2);
            sql = "id=" + mabd + " and loai=1 and ngay<=" + ngay;
            DataRow[] dr = dt.Select(sql, "ngaygio");
            if (dr.Length > 0) ret = decimal.Parse(dr[0]["bhyt"].ToString());
            else
            {
                sql = "id=" + mabd + " and loai=0";
                dr = dt.Select(sql, "ngaygio desc");
                for (int i = 0; i < dr.Length; i++)
                {
                    if (decimal.Parse(dr[i]["ngay"].ToString()) <= decimal.Parse(ngay))
                    {
                        ret = decimal.Parse(dr[i]["bhyt"].ToString());
                        break;
                    }
                }
            }
            return ret;
        }

        private DataTable get_thuoc_ct(string mabn, decimal maql, decimal idkhoa, string tu, string den, int makp, int madoituong,
            int done, decimal maql_phongluu, bool bChenhlechdv, bool bCapve, bool bNgtr, int loaiba, bool bKhoa, string maso,
            bool bdieutri_donthuoc, bool bRavien_giagoc, bool ngia, bool bThanhtoan_N_Dot, string idttrv, string quyenso, string sobienlai)
        {
            //bool bLayGiabhyt_giamua = bLaygiamua_khi_giabh_0_giabh_nho_giamua;
            DataSet dst = new DataSet();
            d = new LibDuoc.AccessData();
            DateTime dt1 = d.StringToDate(tu).AddDays(-d.iNgaykiemke);
            DateTime dt2 = d.StringToDate(den).AddDays(d.iNgaykiemke);
            int y1 = dt1.Year, m1 = dt1.Month;
            int y2 = dt2.Year, m2 = dt2.Month;
            int itu, iden, be = 0;
            bool ndot = (done == 0 && (loaiba == 2 || idkhoa != 0)), bTt_ndot = bThanhtoan_N_Dot;// bThanhtoan_ndot;
            string mmyy = "", usr = user, xxx, for_ngay = f_ngay, fie = (bRavien_giagoc) ? "gianovat" : "giamua";
            for (int i = y1; i <= y2; i++)
            {
                itu = (i == y1) ? m1 : 1;
                iden = (i == y2) ? m2 : 12;
                for (int j = itu; j <= iden; j++)
                {
                    mmyy = j.ToString().PadLeft(2, '0') + i.ToString().Substring(2, 2);
                    if (bMmyy(mmyy))
                    {
                        xxx = usr + mmyy;
                        sql = "select a.idttrv,";
                        if (bRavien_giagoc || ngia) sql += "a." + fie + " as gianovat,";
                        else sql += "0 as gianovat,";
                        if (ndot) sql += "a.id,a.datra,";
                        else sql += "0 as id,0 as datra,";
                        if (bChenhlechdv) sql += "c.loai,a.giamua,a.giaban,";
                        else sql += "0 as loai,0 as giamua,0 as giaban,";
                        sql += "to_char(a.ngay,'dd/mm/yyyy') as ngay,case when d.makp='' then trim(to_char(d.id,'99')) else d.makp end as makp,a.mabd,";
                        sql += "case when c.loai=0 then a.giamua else a.giaban end as dongia,";
                        sql += "sum(a.soluong) as soluong,";
                        sql += "sum(case when c.loai=0 then a.soluong*a.giamua else a.soluong*a.giaban end) as sotien,";
                        sql += "sum(0) as bhytt0107,";
                        sql += "sum(case when c.loai=0 then ";
                        sql += "case when a.madoituong=1 then a.soluong*a.giamua*b.bhyt/100 else 0 end ";
                        sql += "else case when a.madoituong=1 then a.soluong*a.giaban*b.bhyt/100 else 0 end  end) as bhyt";
                        sql += ",to_number('0') as toathuoc, a.traituyen ";
                        sql += ", a.gia_bh ";//binh 290611
                        sql += ",a.mabs";//gam 27/0/2012
                        sql += ",b.kythuat,a.id_ktcao, a.id as idtonghop, to_number('0') as stttonghop ";//ThanhCuong - 06/08/2012 - Kỹ thuật cao
                        sql += " from " + xxx + ".d_tienthuoc a," + usr + ".d_dmbd b," + usr + ".d_doituong c," + usr + ".d_duockp d ";
                        sql += " where a.mabd=b.id and a.madoituong=c.madoituong and a.makp=d.id and a.mabn='" + mabn + "'";
                        if (loaiba == 2) sql += " and a.ngay between to_date('" + tu.Substring(0, 10) + "','" + for_ngay + "') and to_date('" + den.Substring(0, 10) + "','" + for_ngay + "')";
                        else
                        {
                            if (bTt_ndot) sql += " and a.ngay between to_date('" + tu.Substring(0, 10) + "','" + for_ngay + "') and to_date('" + den.Substring(0, 10) + "','" + for_ngay + "')";
                            else if (idkhoa != 0)
                            {
                                sql += " and a.idkhoa=" + idkhoa;
                                if (!bKhoa) sql += " and a.ngay between to_date('" + tu.Substring(0, 10) + "','" + for_ngay + "') and to_date('" + den.Substring(0, 10) + "','" + for_ngay + "')";
                            }
                        }
                        sql += " and a.madoituong=" + madoituong;
                        if (done == 0 || done == 2) sql += " and (a.done=0 and a.idttrv=0)";
                        else if (done == 1) sql += " and a.done=" + done;
                        if (idttrv.Trim().Trim(',') != "") sql += " and a.idttrv in(" + idttrv.Trim().Trim(',') + ")";
                        if (makp != 0) sql += " and a.makp=" + makp;
                        if (maso != "")
                        {
                            if (bCapve)
                            {
                                sql += " and a.mavaovien in (" + maso.Substring(0, maso.Length - 1) + ")";
                            }
                            else
                            {
                                sql += " and a.maql in (" + maso.Substring(0, maso.Length - 1) + ")";
                            }
                        }
                        else sql += " and a.maql=" + maql;
                        sql += " group by a.idttrv, a.traituyen,";
                        if (bRavien_giagoc || ngia) sql += "a." + fie + ",";
                        if (ndot) sql += "a.id,a.datra,";
                        if (bChenhlechdv) sql += "c.loai,a.giamua,a.giaban,";
                        sql += "to_char(a.ngay,'dd/mm/yyyy'),case when d.makp='' then trim(to_char(d.id,'99')) else d.makp end, a.mabd,case when c.loai=0 then a.giamua else a.giaban end";
                        sql += ", a.gia_bh ";//binh 290611
                        sql += ",a.mabs";//gam 27/0/2012
                        sql += ",b.kythuat,a.id_ktcao, a.id ";//ThanhCuong - 06/08/2012 - Kỹ thuật cao
                        if (be == 0) dst = get_data(sql);
                        else dst.Merge(get_data(sql));
                        be++;
                        //if (maql_phongluu != 0 )// bỏ đkien && loaiba != 2)//Thuy 07.09.2012 benhanngtr in phieu thanh toan dich vu lay chi phi phong luu len
                        //BN tu phong luu chuyen vao noi tru chi phi tu tien thuoc cua phong luu bi tang double len
                        if (maql_phongluu != 0 && maso.IndexOf(maql_phongluu.ToString()) < 0) //binh 17102012
                        {
                            sql = "select a.idttrv,";
                            if (bRavien_giagoc || ngia) sql += "a." + fie + " as gianovat,";
                            else sql += "0 as gianovat,";
                            if (ndot) sql += "a.id,a.datra,";
                            else sql += "0 as id,0 as datra,";
                            if (bChenhlechdv) sql += "c.loai,a.giamua,a.giaban,";
                            else sql += "0 as loai,0 as giamua,0 as giaban,";
                            sql += "to_char(a.ngay,'dd/mm/yyyy') as ngay,case when d.makp='' then trim(to_char(d.id,'99')) else d.makp end as makp,a.mabd,";
                            sql += "case when c.loai=0 then a.giamua else a.giaban end as dongia,";
                            sql += "sum(a.soluong) as soluong,";
                            sql += "sum(case when c.loai=0 then a.soluong*a.giamua else a.soluong*a.giaban end) as sotien,";
                            sql += "sum(0) as bhytt0107,";
                            sql += "sum(case when c.loai=0 then ";
                            sql += "case when a.madoituong=1 then a.soluong*a.giamua*b.bhyt/100 else 0 end ";
                            sql += "else case when a.madoituong=1 then a.soluong*a.giaban*b.bhyt/100 else 0 end  end) as bhyt";
                            sql += ", to_number('0') as toathuoc, a.traituyen";
                            sql += ", a.gia_bh ";//binh 290611
                            sql += ",a.mabs";//gam 27/0/2012
                            sql += ", b.kythuat,a.id_ktcao, a.id as idtonghop, to_number('0') as stttonghop ";//ThanhCuong - 06/08/2012 - Kỹ thuật cao
                            sql += " from " + xxx + ".d_tienthuoc a," + usr + ".d_dmbd b," + usr + ".d_doituong c," + usr + ".d_duockp d ";
                            sql += " where a.mabd=b.id and a.madoituong=c.madoituong and a.makp=d.id and a.mabn='" + mabn + "'";
                            sql += " and a.maql=" + maql_phongluu;
                            sql += " and a.madoituong=" + madoituong;
                            if (idkhoa != 0) sql += " and a.ngay between to_date('" + tu.Substring(0, 10) + "','" + for_ngay + "') and to_date('" + den.Substring(0, 10) + "','" + for_ngay + "')";
                            if (done == 0 || done == 2) sql += " and (a.done=0 and a.idttrv=0)";
                            else if (done == 1) sql += " and a.done=" + done;
                            if (idttrv.Trim().Trim(',') != "") sql += " and a.idttrv in(" + idttrv.Trim().Trim(',') + ")";
                            sql += " group by a.idttrv,";
                            if (bRavien_giagoc || ngia) sql += "a." + fie + ",";
                            if (ndot) sql += "a.id,a.datra,";
                            if (bChenhlechdv) sql += "c.loai,a.giamua,a.giaban,";
                            sql += "to_char(a.ngay,'dd/mm/yyyy'),case when d.makp='' then trim(to_char(d.id,'99')) else d.makp end,a.mabd,case when c.loai=0 then a.giamua else a.giaban end";
                            sql += ", a.gia_bh ";//binh 290611
                            sql += ",a.mabs";//gam 27/0/2012
                            sql += ",a.traituyen,b.kythuat,a.id_ktcao, a.id ";//ThanhCuong - 06/08/2012 - Kỹ thuật cao
                            dst.Merge(get_data(sql));
                        }
                        if (loaiba == 1 || loaiba == 2 || loaiba == 4)//(bCapve || loaiba == 2 || loaiba==4)
                        {
                            if (loaiba != 2 && bGia_bh_quydinh)//if (loaiba != 2 && bChenhlechdv)
                            {
                                sql = "select k.sobienlai as idttrv,";
                                if (bRavien_giagoc || ngia) sql += "t." + fie + " as gianovat,";
                                else sql += "0 as gianovat,";
                                sql += "0 as id,0 as datra,";
                                if (bChenhlechdv) sql += "1 as loai,t.giamua,t.giaban,";
                                else sql += "0 as loai,0 as giamua,0 as giaban,";
                                sql += "to_char(k.ngay,'dd/mm/yyyy') as ngay,k.makp,a.mabd,t.giaban as dongia,sum(a.soluong) as soluong,";
                                sql += "sum(a.soluong*t.giaban) as sotien,";
                                sql += "sum(0) as bhytt0107,";
                                sql += "sum(a.soluong*t.giaban*b.bhyt/100) as bhyt";
                                //if (bCapve) sql += ", to_number('0') as toathuoc, k.traituyen ";
                                //else sql += ", to_number('1') as toathuoc, k.traituyen";
                                sql += ", to_number('1') as toathuoc, k.traituyen";
                                sql += ", a.gia_bh ";//binh 290611
                                sql += ",k.mabs";//gam 27/0/2012
                                sql += ", b.kythuat,0 id_ktcao, k.id as idtonghop, a.stt as stttonghop ";//ThanhCuong - 06/08/2012 - Kỹ thuật cao
                                sql += " from " + xxx + ".bhytkb k," + xxx + ".bhytthuoc a," + usr + ".d_dmbd b," + usr + ".d_doituong c," + xxx + ".d_theodoi t";
                                sql += " where k.id=a.id and a.sttt=t.id and a.mabd=b.id and k.maphu=c.madoituong and k.mabn='" + mabn + "'";
                                if (done == 0 || done == 2) sql += " and k.sobienlai=0";
                                else if (done == 1) sql += " and k.sobienlai<>0";
                                if (quyenso.Trim().Trim(',') != "" && sobienlai.Trim().Trim(',') != "") sql += " and k.quyenso in(" + quyenso.Trim().Trim(',') + ")  and k.sobienlai in(" + sobienlai.Trim().Trim(',') + ")";
                                if (!bCapve && loaiba == 1) sql += " and k.loaiba=1";
                                if (bCapve && loaiba == 1) sql += " and k.loaiba in(1,3,4)";//Co chon G17: chi lay phong luu, phong kham da duyet ben duoc vao noi tru
                                sql += " and k.maphu=" + madoituong;
                                if (maso != "")
                                {
                                    if (bCapve)
                                    {
                                        sql += " and k.mavaovien in (" + maso.Substring(0, maso.Length - 1) + ")";
                                    }
                                    else
                                    {
                                        sql += " and k.maql in (" + maso.Substring(0, maso.Length - 1) + ")";
                                    }
                                }
                                else sql += " and k.ngay between to_date('" + tu.Substring(0, 10) + "','" + for_ngay + "') and to_date('" + den.Substring(0, 10) + "','" + for_ngay + "')";
                                sql += " group by k.sobienlai, k.traituyen,";
                                if (bRavien_giagoc || ngia) sql += "t." + fie + ",";
                                if (bChenhlechdv) sql += "t.giamua,t.giaban,";
                                sql += "to_char(k.ngay,'dd/mm/yyyy'),k.makp,a.mabd,t.giaban";
                                sql += ", a.gia_bh ";//binh 290611
                                sql += ",k.mabs";//gam 27/0/2012
                                sql += ", b.kythuat, k.id, a.stt ";//ThanhCuong - 06/08/2012 - Kỹ thuật cao
                                merge(dst, get_data(sql));
                            }
                            else
                            {
                                sql = "select k.sobienlai as idttrv,";
                                if (bRavien_giagoc || ngia) sql += "t." + fie + " as gianovat,";
                                else sql += "0 as gianovat,";
                                sql += "0 as id,0 as datra,";
                                if (bChenhlechdv) sql += "c.loai,t.giamua,t.giaban,";
                                else sql += "0 as loai,0 as giamua,0 as giaban,";
                                sql += "to_char(k.ngay,'dd/mm/yyyy') as ngay,k.makp,a.mabd,case when c.loai=0 then t.giamua else t.giaban end as dongia,";
                                sql += "sum(a.soluong) as soluong,sum(case when c.loai=0 then a.soluong*t.giamua else a.soluong*t.giaban end) as sotien,";
                                sql += "sum(0) as bhytt0107,";
                                sql += "sum(case when c.loai=0 then ";
                                sql += "case when k.maphu=1 then a.soluong*t.giamua*b.bhyt/100 else 0 end ";
                                sql += "else case when k.maphu=1 then a.soluong*t.giaban*b.bhyt/100 else 0 end  end) as bhyt";
                                //if (bCapve) sql += ", to_number('0') as toathuoc, k.traituyen ";
                                //else sql += ", to_number('1') as toathuoc, k.traituyen ";
                                sql += ", to_number('1') as toathuoc, k.traituyen";
                                sql += ", a.gia_bh ";//binh 290611
                                sql += ",k.mabs";//gam 27/0/2012
                                sql += ", b.kythuat,0 id_ktcao, k.id as idtonghop, a.stt as stttonghop ";//ThanhCuong - 06/08/2012 - Kỹ thuật cao
                                sql += " from " + xxx + ".bhytkb k," + xxx + ".bhytthuoc a," + usr + ".d_dmbd b," + usr + ".d_doituong c," + xxx + ".d_theodoi t ";
                                sql += " where k.id=a.id and a.sttt=t.id and a.mabd=b.id and k.maphu=c.madoituong and k.mabn='" + mabn + "'";
                                if (done == 0 || done == 2) sql += " and k.sobienlai=0";
                                else if (done == 1) sql += " and k.sobienlai<>0";
                                if (quyenso.Trim().Trim(',') != "" && sobienlai.Trim().Trim(',') != "") sql += " and k.quyenso in(" + quyenso.Trim().Trim(',') + ")  and k.sobienlai in(" + sobienlai.Trim().Trim(',') + ")";
                                if (!bCapve && loaiba == 1) sql += " and k.loaiba=1";
                                sql += " and k.maphu=" + madoituong;
                                if (maso != "")
                                {
                                    if (bCapve)
                                    {
                                        sql += " and k.mavaovien in (" + maso.Substring(0, maso.Length - 1) + ")";
                                    }
                                    else
                                    {
                                        sql += " and k.maql in (" + maso.Substring(0, maso.Length - 1) + ")";
                                    }
                                }
                                else sql += " and k.ngay between to_date('" + tu.Substring(0, 10) + "','" + for_ngay + "') and to_date('" + den.Substring(0, 10) + "','" + for_ngay + "')";
                                sql += " group by k.sobienlai, k.traituyen,";
                                if (bRavien_giagoc || ngia) sql += "t." + fie + ",";
                                if (bChenhlechdv) sql += "c.loai,t.giamua,t.giaban,";
                                sql += "to_char(k.ngay,'dd/mm/yyyy'),k.makp,a.mabd,case when c.loai=0 then t.giamua else t.giaban end";
                                sql += ", a.gia_bh ";//binh 290611
                                sql += ",k.mabs";//gam 27/0/2012
                                sql += ", b.kythuat, k.id, a.stt ";//ThanhCuong - 06/08/2012 - Kỹ thuật cao
                                merge(dst, get_data(sql));
                            }
                        }
                        if (bNgtr && loaiba != 2)//Khi chon G24
                        {
                            sql = "select k.sobienlai as idttrv,";
                            if (bRavien_giagoc || ngia) sql += "t." + fie + " as gianovat,";
                            else sql += "0 as gianovat,";
                            sql += "0 as id,0 as datra,";
                            if (bChenhlechdv) sql += "c.loai,t.giamua,t.giaban,";
                            else sql += "0 as loai,0 as giamua,0 as giaban,";
                            sql += "to_char(k.ngay,'dd/mm/yyyy') as ngay,k.makp,a.mabd,case when c.loai=0 then t.giamua else t.giaban end as dongia,";
                            sql += "sum(a.soluong) as soluong,sum(case when c.loai=0 then a.soluong*t.giamua else a.soluong*t.giaban end) as sotien,";
                            sql += "sum(0) as bhytt0107,";
                            sql += "sum(case when c.loai=0 then ";
                            sql += "case when k.maphu=1 then a.soluong*t.giamua*b.bhyt/100 else 0 end ";
                            sql += "else case when k.maphu=1 then a.soluong*t.giaban*b.bhyt/100 else 0 end  end) as bhyt";
                            //if (bNgtr) sql += ", to_number('0') as toathuoc, k.traituyen ";
                            //else sql += ", to_number('1') as toathuoc, k.traituyen ";
                            sql += ", to_number('1') as toathuoc, k.traituyen";
                            sql += ", a.gia_bh ";//binh 290611
                            sql += ",k.mabs";//gam 27/0/2012
                            sql += ", b.kythuat,0 id_ktcao , k.id as idtonghop, a.stt as stttonghop ";//ThanhCuong - 06/08/2012 - Kỹ thuật cao
                            sql += " from " + xxx + ".bhytkb k," + xxx + ".bhytthuoc a," + usr + ".d_dmbd b," + usr + ".d_doituong c," + xxx + ".d_theodoi t";
                            sql += " where k.id=a.id and a.sttt=t.id and a.mabd=b.id and k.maphu=c.madoituong and k.mabn='" + mabn + "'";
                            sql += " and k.ngay between to_date('" + tu.Substring(0, 10) + "','" + for_ngay + "') and to_date('" + den.Substring(0, 10) + "','" + for_ngay + "')";
                            if (done == 0 || done == 2) sql += " and k.sobienlai=0";
                            else if (done == 1) sql += " and k.sobienlai<>0";
                            if (quyenso.Trim().Trim(',') != "" && sobienlai.Trim().Trim(',') != "") sql += " and k.quyenso in(" + quyenso.Trim().Trim(',') + ")  and k.sobienlai in(" + sobienlai.Trim().Trim(',') + ")";
                            sql += " and k.maphu=" + madoituong;
                            sql += " and k.loaiba=2 ";
                            if (maso != "") sql += " and k.maql in (" + maso.Substring(0, maso.Length - 1) + ")";
                            sql += " group by k.sobienlai, k.traituyen,";
                            if (bRavien_giagoc || ngia) sql += "t." + fie + ",";
                            if (bChenhlechdv) sql += "c.loai,t.giamua,t.giaban,";
                            sql += "to_char(k.ngay,'dd/mm/yyyy'),k.makp,a.mabd,case when c.loai=0 then t.giamua else t.giaban end";
                            sql += ", a.gia_bh ";//binh 290611
                            sql += ",k.mabs";//gam 27/0/2012
                            sql += ", b.kythuat, k.id, a.stt ";//ThanhCuong - 06/08/2012 - Kỹ thuật cao
                            merge(dst, get_data(sql));
                        }

                        if (bdieutri_donthuoc)
                        {
                            sql = "select a.paid as idttrv,";
                            if (bRavien_giagoc || ngia) sql += "t." + fie + " as gianovat,";
                            else sql += "0 as gianovat,";
                            sql += "0 as id,0 as datra,";
                            if (bChenhlechdv) sql += " c.loai,t.giamua,a.giaban,";
                            else sql += " 0 as loai,0 as giamua,0 as giaban,";
                            sql += " to_char(k.ngay,'dd/mm/yyyy') as ngay,d.makp,a.mabd,case when c.loai=0 then t.giamua else a.giaban end as dongia,";
                            sql += " sum(a.soluong) as soluong,sum(case when c.loai=0 then a.soluong*t.giamua else a.soluong*a.giaban end) as sotien,";
                            sql += " sum(0) as bhytt0107,";
                            sql += " sum(case when c.loai=0 then ";
                            sql += " case when a.madoituong=1 then a.soluong*t.giamua*b.bhyt/100 else 0 end ";
                            sql += " else case when a.madoituong=1 then a.soluong*a.giaban*b.bhyt/100 else 0 end  end) as bhyt";
                            sql += ", 0 as toathuoc, 0 as traituyen ";
                            sql += ", t.giamua as gia_bh ";//binh 290611
                            sql += ",k.mabs";//gam 27/0/2012
                            sql += ", b.kythuat,0 id_ktcao, k.id as idtonghop, a.stt as stttonghop ";//ThanhCuong - 06/08/2012 - Kỹ thuật cao
                            sql += " from " + xxx + ".d_ngtrull k," + xxx + ".d_ngtruct a," + usr + ".d_dmbd b," + usr + ".d_doituong c," + xxx + ".d_theodoi t," + usr + ".d_duockp d";
                            sql += " where k.id=a.id and a.sttt=t.id and a.mabd=b.id and a.madoituong=c.madoituong and k.makp=d.id and k.mabn='" + mabn + "'";
                            sql += " and k.ngay between to_date('" + tu.Substring(0, 10) + "','" + for_ngay + "') and to_date('" + den.Substring(0, 10) + "','" + for_ngay + "')";
                            sql += " and a.madoituong=" + madoituong;
                            if (maso != "") sql += " and k.maql in (" + maso.Substring(0, maso.Length - 1) + ")";
                            if (done == 0 || done == 2) sql += " and a.paid=0";
                            else if (done == 1) sql += " and a.paid=" + done;
                            if (idttrv.Trim().Trim(',') != "") sql += " and a.idttrv in(" + idttrv.Trim().Trim(',') + ")";
                            sql += " group by a.paid,";
                            if (bRavien_giagoc || ngia) sql += "t." + fie + ",";
                            if (bChenhlechdv) sql += " c.loai,t.giamua,a.giaban,";
                            sql += " to_char(k.ngay,'dd/mm/yyyy'),d.makp,a.mabd,case when c.loai=0 then t.giamua else a.giaban end";
                            sql += ", t.giamua ";//binh 290611
                            sql += ",k.mabs";//gam 27/0/2012
                            sql += ", b.kythuat, k.id, a.stt";//ThanhCuong - 06/08/2012 - Kỹ thuật cao
                            merge(dst, get_data(sql));
                            if (done == 1) // tra thuoc theo don ban
                            {
                                sql = "select 0 as idttrv,";
                                if (bRavien_giagoc || ngia) sql += "a.giamua as gianovat,";
                                else sql += "0 as gianovat,";
                                sql += "0 as id,0 as datra,";
                                if (bChenhlechdv) sql += " c.loai,a.giamua,a.giaban,";
                                else sql += " 0 as loai,0 as giamua,0 as giaban,";
                                sql += " to_char(k.ngayhd,'dd/mm/yyyy') as ngay,d.makp,a.mabd,case when c.loai=0 then a.giamua else a.giaban end as dongia,";
                                sql += " sum(-1*a.soluong) as soluong,sum(case when c.loai=0 then -1*a.soluong*a.giamua else -1*a.soluong*a.giaban end) as sotien,";
                                sql += " sum(0) as bhytt0107,";
                                sql += " sum(case when c.loai=0 then ";
                                sql += " case when a.tinhtrang=1 then -1*a.soluong*a.giamua*b.bhyt/100 else 0 end ";
                                sql += " else case when a.tinhtrang=1 then -1*a.soluong*a.giaban*b.bhyt/100 else 0 end  end) as bhyt";
                                sql += ", 0 as toathuoc, 0 as traituyen ";
                                sql += ", a.giamua as gia_bh ";//binh 290611
                                sql += ",'' as mabs";//gam 27/0/2012
                                sql += ", b.kythuat,0 id_ktcao, k.id as idtonghop, a.stt as stttonghop ";//ThanhCuong - 06/08/2012 - Kỹ thuật cao
                                sql += " from " + xxx + ".d_nhapll k," + xxx + ".d_nhapct a," + usr + ".d_dmbd b," + usr + ".d_doituong c," + usr + ".d_duockp d";
                                sql += " where k.id=a.id and a.mabd=b.id and a.tinhtrang=c.madoituong and k.chietkhau=d.id and k.sophieu='" + mabn + "'";
                                sql += " and k.ngayhd between to_date('" + tu.Substring(0, 10) + "','" + for_ngay + "') and to_date('" + den.Substring(0, 10) + "','" + for_ngay + "')";
                                sql += " and a.tinhtrang=" + madoituong;
                                sql += " and k.loai='N'";
                                sql += " group by ";
                                if (bRavien_giagoc || ngia) sql += "a.giamua,";
                                if (bChenhlechdv) sql += "c.loai,a.giamua,a.giaban,";
                                sql += "to_char(k.ngayhd,'dd/mm/yyyy'),d.makp,a.mabd,case when c.loai=0 then a.giamua else a.giaban end";
                                sql += ", a.giamua ";//binh 290611
                                sql += ", b.kythuat, k.id, a.stt ";//ThanhCuong - 06/08/2012 - Kỹ thuật cao
                                merge(dst, get_data(sql));
                            }
                        }
                    }
                }
            }
            return (be == 0) ? null : dst.Tables[0];
        }

        private DataTable get_thuoc_ct(string mabn, decimal maql, decimal idkhoa, string tu, string den, int makp, int madoituong,
            int done, decimal maql_phongluu, bool bChenhlechdv, int loaiba, bool bKhoa, string maso, string mavp,
            bool bRavien_giagoc, string nhomvp, bool bThanhtoan_N_Dot, string idttrv)
        {
            DataSet dst = new DataSet();
            d = new LibDuoc.AccessData();
            DateTime dt1 = d.StringToDate(tu).AddDays(-d.iNgaykiemke);
            DateTime dt2 = d.StringToDate(den).AddDays(d.iNgaykiemke);
            int y1 = dt1.Year, m1 = dt1.Month;
            int y2 = dt2.Year, m2 = dt2.Month;
            int itu, iden, be = 0;
            bool ndot = (done == 0 && (loaiba == 2 || idkhoa != 0)), bTt_ndot = bThanhtoan_N_Dot;// bThanhtoan_ndot;
            string mmyy = "", usr = user, xxx, for_ngay = f_ngay;
            for (int i = y1; i <= y2; i++)
            {
                itu = (i == y1) ? m1 : 1;
                iden = (i == y2) ? m2 : 12;
                for (int j = itu; j <= iden; j++)
                {
                    mmyy = j.ToString().PadLeft(2, '0') + i.ToString().Substring(2, 2);
                    if (bMmyy(mmyy))
                    {
                        xxx = usr + mmyy;

                        sql = "select a.idttrv,";
                        if (bRavien_giagoc) sql += "a.gianovat,";
                        else sql += "0 as gianovat,";
                        if (ndot) sql += "a.id,a.datra,";
                        else sql += "0 as id,0 as datra,";
                        if (bChenhlechdv) sql += "c.loai,a.giamua,a.giaban,";
                        else sql += "0 as loai,0 as giamua,0 as giaban,";
                        sql += "to_char(a.ngay,'dd/mm/yyyy') as ngay,case when d.makp='' then trim(to_char(d.id,'99')) else d.makp end as makp,a.mabd,case when c.loai=0 then a.giamua else a.giaban end as dongia,";
                        sql += "sum(a.soluong) as soluong,sum(case when c.loai=0 then a.soluong*a.giamua else a.soluong*a.giaban end) as sotien,";
                        sql += "sum(0) as bhytt0107,";
                        sql += "sum(case when c.loai=0 then ";
                        sql += "case when a.madoituong=1 then a.soluong*a.giamua*b.bhyt/100 else 0 end ";
                        sql += "else case when a.madoituong=1 then a.soluong*a.giaban*b.bhyt/100 else 0 end  end) as bhyt";
                        sql += ", to_number('0') as toathuoc, a.traituyen ";
                        sql += ", a.gia_bh ";//binh 290611
                        sql += ",a.mabs, a.id as idtonghop, to_number('0') as stttonghop ";//gam 27/02/2012
                        sql += " from " + xxx + ".d_tienthuoc a," + usr + ".d_dmbd b," + usr + ".d_doituong c," + usr + ".d_duockp d," + xxx + ".d_xuatsdll e," + usr + ".d_dmnhom f";
                        sql += " where a.id=e.id and a.mabd=b.id and a.madoituong=c.madoituong and a.makp=d.id and b.manhom=f.id and a.mabn='" + mabn + "'";
                        if (loaiba == 2) sql += " and a.ngay between to_date('" + tu.Substring(0, 10) + "','" + for_ngay + "') and to_date('" + den.Substring(0, 10) + "','" + for_ngay + "')";
                        else
                        {
                            if (bTt_ndot) sql += " and a.ngay between to_date('" + tu.Substring(0, 10) + "','" + for_ngay + "') and to_date('" + den.Substring(0, 10) + "','" + for_ngay + "')";
                            else if (idkhoa != 0)
                            {
                                sql += " and a.idkhoa=" + idkhoa;
                                if (!bKhoa) sql += " and a.ngay between to_date('" + tu.Substring(0, 10) + "','" + for_ngay + "') and to_date('" + den.Substring(0, 10) + "','" + for_ngay + "')";
                            }
                        }
                        sql += " and a.madoituong=" + madoituong;
                        if (done == 0 || done == 2) sql += " and (a.done=0 and a.idttrv=0)";
                        else if (done == 1) sql += " and a.done=" + done;
                        //
                        if (idttrv.Trim().Trim(',') != "") sql += " and a.idttrv in(" + idttrv.Trim().Trim(',') + ")";
                        //
                        if (makp != 0) sql += " and a.makp=" + makp;
                        if (maso != "") sql += " and a.maql in (" + maso.Substring(0, maso.Length - 1) + ")";
                        else sql += " and a.maql=" + maql;
                        if (mavp != "") sql += " and e.ghichu='" + mavp + "'";
                        else sql += " and (e.ghichu is null or e.ghichu='')";
                        if (nhomvp != "") sql += " and f.nhomvp in (" + nhomvp.Substring(0, nhomvp.Length - 1) + ")";
                        sql += " group by a.idttrv, a.traituyen, ";
                        if (bRavien_giagoc) sql += "a.gianovat,";
                        if (ndot) sql += "a.id,a.datra,";
                        if (bChenhlechdv) sql += "c.loai,a.giamua,a.giaban,";
                        sql += "to_char(a.ngay,'dd/mm/yyyy'),case when d.makp='' then trim(to_char(d.id,'99')) else d.makp end, a.mabd,case when c.loai=0 then a.giamua else a.giaban end";
                        sql += ", a.gia_bh ";//binh 290611
                        sql += ",a.mabs, a.id ";//gam 27/02/2012
                        if (be == 0) dst = get_data(sql);
                        else dst.Merge(get_data(sql));
                        be++;
                        if (maql_phongluu != 0 && loaiba != 2)
                        {
                            sql = "select a.idttrv,";
                            if (bRavien_giagoc) sql += "a.gianovat,";
                            else sql += "0 as gianovat,";
                            if (ndot) sql += "a.id,a.datra,";
                            else sql += "0 as id,0 as datra,";
                            if (bChenhlechdv) sql += "c.loai,a.giamua,a.giaban,";
                            else sql += "0 as loai,0 as giamua,0 as giaban,";
                            sql += "to_char(a.ngay,'dd/mm/yyyy') as ngay,case when d.makp='' then trim(to_char(d.id,'99')) else d.makp end as makp,a.mabd,case when c.loai=0 then a.giamua else a.giaban end as dongia,";
                            sql += "sum(a.soluong) as soluong,sum(case when c.loai=0 then a.soluong*a.giamua else a.soluong*a.giaban end) as sotien,";
                            sql += "sum(0) as bhytt0107,";
                            sql += "sum(case when c.loai=0 then ";
                            sql += "case when a.madoituong=1 then a.soluong*a.giamua*b.bhyt/100 else 0 end ";
                            sql += "else case when a.madoituong=1 then a.soluong*a.giaban*b.bhyt/100 else 0 end  end) as bhyt";
                            sql += ", to_number('0') as toathuoc, a.traituyen ";
                            sql += ", a.gia_bh ";//binh 290611
                            sql += ",a.mabs, a.id as idtonghop, to_number('0') as stttonghop ";//gam 27/02/2012
                            sql += " from " + xxx + ".d_tienthuoc a," + usr + ".d_dmbd b," + usr + ".d_doituong c," + usr + ".d_duockp d," + xxx + ".d_xuatsdll e," + usr + ".d_dmnhom f";
                            sql += " where a.id=e.id and a.mabd=b.id and a.madoituong=c.madoituong and a.makp=d.id and b.manhom=f.id and a.mabn='" + mabn + "'";
                            sql += " and a.maql=" + maql_phongluu;
                            sql += " and a.madoituong=" + madoituong;
                            if (idkhoa != 0) sql += " and a.ngay between to_date('" + tu.Substring(0, 10) + "','" + for_ngay + "') and to_date('" + den.Substring(0, 10) + "','" + for_ngay + "')";
                            if (done == 0 || done == 2) sql += " and (a.done=0 and a.idttrv=0)";
                            else if (done == 1) sql += " and a.done=" + done;
                            if (idttrv.Trim().Trim(',') != "") sql += " and a.idttrv in(" + idttrv.Trim().Trim(',') + ")";
                            if (mavp != "") sql += " and e.ghichu='" + mavp + "'";
                            else sql += " and (e.ghichu is null or e.ghichu='')";
                            if (nhomvp != "") sql += " and f.nhomvp in (" + nhomvp.Substring(0, nhomvp.Length - 1) + ")";
                            sql += " group by a.idttrv, a.traituyen,";
                            if (bRavien_giagoc) sql += "a.gianovat,";
                            if (ndot) sql += "a.id,a.datra,";
                            if (bChenhlechdv) sql += "c.loai,a.giamua,a.giaban,";
                            sql += "to_char(a.ngay,'dd/mm/yyyy'),case when d.makp='' then trim(to_char(d.id,'99')) else d.makp end,a.mabd,case when c.loai=0 then a.giamua else a.giaban end";
                            sql += ", a.gia_bh ";//binh 290611
                            sql += ",a.mabs, a.id ";//gam 27/02/2012
                            dst.Merge(get_data(sql));
                        }
                        if (mavp == "")
                        {
                            sql = "select a.idttrv,";
                            if (bRavien_giagoc) sql += "a.dongia+a.vattu as gianovat,";
                            else sql += "0 as gianovat,";
                            if (ndot) sql += "a.id,0 as datra,";
                            else sql += "0 as id,0 as datra,";
                            if (bChenhlechdv) sql += "9 as loai,a.dongia+a.vattu as giamua,a.dongia+a.vattu as giaban,";
                            else sql += "9 as loai,0 as giamua,0 as giaban,";
                            sql += "to_char(a.ngay,'dd/mm/yyyy') as ngay,d.makp,a.mavp as mabd,a.dongia+a.vattu as dongia,";
                            sql += "sum(a.soluong) as soluong,sum(a.soluong*(a.dongia+a.vattu)) as sotien,";
                            sql += "sum(0) as bhytt0107,";
                            sql += "sum(case when a.madoituong=1 then a.soluong*(a.dongia+a.vattu)*b.bhyt/100 else 0 end) as bhyt";
                            sql += ", to_number('0') as toathuoc, a.traituyen ";
                            sql += ", a.dongia as gia_bh ";//binh 290611
                            sql += ",'' as mabs, a.id as idtonghop, to_number('0') as stttonghop ";//gam 27/02/2012
                            sql += " from " + xxx + ".v_vpkhoa a," + usr + ".v_giavp b," + usr + ".doituong c," + usr + ".btdkp_bv d," + usr + ".v_loaivp e";
                            sql += " where a.mavp=b.id and a.madoituong=c.madoituong and a.makp=d.makp and b.id_loai=e.id and a.mabn='" + mabn + "'";
                            if (loaiba == 2) sql += " and a.ngay between to_date('" + tu.Substring(0, 10) + "','" + for_ngay + "') and to_date('" + den.Substring(0, 10) + "','" + for_ngay + "')";
                            else
                            {
                                if (bTt_ndot) sql += " and a.ngay between to_date('" + tu.Substring(0, 10) + "','" + for_ngay + "') and to_date('" + den.Substring(0, 10) + "','" + for_ngay + "')";
                                else if (idkhoa != 0)
                                {
                                    sql += " and a.idkhoa=" + idkhoa;
                                    if (!bKhoa) sql += " and a.ngay between to_date('" + tu.Substring(0, 10) + "','" + for_ngay + "') and to_date('" + den.Substring(0, 10) + "','" + for_ngay + "')";
                                }
                            }
                            sql += " and a.madoituong=" + madoituong;
                            if (done == 0 || done == 2) sql += " and (a.done=0 and a.idttrv=0)";
                            else if (done == 1) sql += " and a.done=" + done;
                            if (idttrv.Trim().Trim(',') != "") sql += " and a.idttrv in(" + idttrv.Trim().Trim(',') + ")";
                            if (makp != 0) sql += " and a.makp=" + makp;
                            if (maso != "") sql += " and a.maql in (" + maso.Substring(0, maso.Length - 1) + ")";
                            else sql += " and a.maql=" + maql;
                            if (nhomvp != "") sql += " and e.id_nhom in (" + nhomvp.Substring(0, nhomvp.Length - 1) + ")";
                            sql += " group by a.idttrv,a.traituyen, ";
                            if (bRavien_giagoc) sql += "a.dongia+a.vattu,";
                            if (ndot) sql += "a.id,";
                            if (bChenhlechdv) sql += "a.dongia+a.vattu,a.dongia+a.vattu,";
                            sql += "to_char(a.ngay,'dd/mm/yyyy'),d.makp, a.mavp,a.dongia+a.vattu";
                            sql += ", a.dongia , a.id";//binh 290611
                            //dst.Merge(get_data(sql));
                            merge(dst, get_data(sql));
                        }
                    }
                }
            }
            return (be == 0) ? null : dst.Tables[0];
        }
        private DataTable get_vienphi_ct(string mabn, decimal maql, decimal idkhoa, string tu, string den,
            string makp, int madoituong, int done, decimal maql_phongluu, bool bCapve, bool bNgtr, int loaiba,
            bool bKhoa, string maso, bool bThanhtoan_N_Dot, string idttrv)
        {
            DataSet dsv = new DataSet();
            d = new LibDuoc.AccessData();
            DateTime dt1 = d.StringToDate(tu).AddDays(-d.iNgaykiemke);
            DateTime dt2 = d.StringToDate(den).AddDays(d.iNgaykiemke);
            int y1 = dt1.Year, m1 = dt1.Month;
            int y2 = dt2.Year, m2 = dt2.Month;
            int itu, iden, be = 0;
            string s_mavp_congkham = f_get_mavp_congkham();
            string mmyy = "", usr = user, xxx, stime = "'" + f_ngay + "'";
            maso = maso.Trim().Trim(','); //Khuong 09/11/2011 Hjx, debug nua ngay moi ra duoc loi, 1 dam rung tim ra 1 dong la giai quyet duoc van de
            string[] s_maso = maso.Split(',');
            bool doub_maql = false;
            for (int i = 0; i < s_maso.Length; i++)
            {
                if (s_maso[i].ToString() == maql_phongluu.ToString())
                {
                    doub_maql = true;
                    break;
                }
            }
            bool ndot = (done == 0 && (loaiba == 2 || idkhoa != 0)), bTt_ndot = bThanhtoan_N_Dot;// bThanhtoan_ndot;
            for (int i = y1; i <= y2; i++)
            {
                itu = (i == y1) ? m1 : 1;
                iden = (i == y2) ? m2 : 12;
                for (int j = itu; j <= iden; j++)
                {
                    mmyy = j.ToString().PadLeft(2, '0') + i.ToString().Substring(2, 2);
                    if (bMmyy(mmyy))
                    {
                        xxx = usr + mmyy;
                        //if (done == 0)
                        //{
                        sql = "select a.idttrv,";
                        if (ndot) sql += " a.id,";
                        else sql += " 0 as id,";
                        sql += "to_char(a.ngay,'dd/mm/yyyy') as ngay,a.makp,a.mavp,a.dongia+a.vattu-a.stgiam as dongia,sum(a.soluong) as soluong,sum(a.soluong*(a.dongia+a.vattu-a.stgiam)) as sotien, ";
                        sql += "sum(0) as bhytt0107,";
                        sql += "sum(case when a.madoituong=1 then a.soluong*(a.dongia+a.vattu-a.stgiam)*b.bhyt/100 else 0 end ) as bhyt,";
                        sql += "sum(a.soluong*a.vattu) as vattu, b.id_loai ";
                        sql += ", to_number('0') as toathuoc, a.traituyen, a.tylegiam, a.dachenhlech ";
                        sql += ",'' as mabs,a.id as id_vpkhoa, a.id as idtonghop, to_number('0') as stttonghop ";//gam 27/02/2012
                        sql += " from " + xxx + ".v_vpkhoa a," + usr + ".v_giavp b where a.mavp=b.id and a.mabn='" + mabn + "'";
                        if (loaiba == 2) sql += " and " + for_ngay("a.ngay", stime) + " between to_date('" + tu.Substring(0, 10) + "'," + stime + ") and to_date('" + den.Substring(0, 10) + "'," + stime + ")";
                        else
                        {
                            if (bTt_ndot) sql += " and " + for_ngay("a.ngay", stime) + " between to_date('" + tu.Substring(0, 10) + "'," + stime + ") and to_date('" + den.Substring(0, 10) + "'," + stime + ")";
                            else if (idkhoa != 0)
                            {
                                sql += " and a.idkhoa=" + idkhoa;
                                if (!bKhoa) sql += " and " + for_ngay("a.ngay", stime) + " between to_date('" + tu.Substring(0, 10) + "'," + stime + ") and to_date('" + den.Substring(0, 10) + "'," + stime + ")";
                            }
                        }
                        sql += " and a.madoituong=" + madoituong;
                        if (makp != "") sql += " and a.makp='" + makp + "'";
                        if (done == 0 || done == 2) sql += " and (a.done=0 and a.idttrv=0)";
                        else if (done == 1) sql += " and a.done=" + done;
                        if (idttrv.Trim().Trim(',') != "") sql += " and a.idttrv in(" + idttrv.Trim().Trim(',') + ")";
                        if (maso != "") sql += " and a.maql in (" + maso + ")";
                        else sql += " and a.maql=" + maql;
                        if (s_mavp_congkham.Trim() != "" && madoituong == 1 && loaiba == 1 && bNhapvien_kocongkham) sql += " and (a.mavp not in (" + s_mavp_congkham + ") or (a.mavp in (" + s_mavp_congkham + ") and (a.makp='99' or a.makp='999')))";//bbbb
                        sql += " group by a.idttrv, a.traituyen, a.tylegiam, ";
                        if (ndot) sql += " a.id,";
                        sql += "to_char(a.ngay,'dd/mm/yyyy'),a.makp,a.mavp,a.dongia+a.vattu-a.stgiam,b.id_loai, a.dachenhlech,a.id";
                        if (bChidinh_vienphi)
                        {
                            sql += " union all ";
                            sql += "select  a.idttrv,";
                            if (ndot) sql += " a.id,";
                            else sql += " 0 as id,";
                            sql += " to_char(a.ngay,'dd/mm/yyyy') as ngay,a.makp,a.mavp,a.dongia+a.vattu-a.stgiam as dongia,sum(a.soluong) as soluong,sum(a.soluong*(a.dongia+a.vattu-a.stgiam)) as sotien, ";
                            sql += "sum(0) as bhytt0107,";
                            sql += "sum(case when a.madoituong=1 then a.soluong*(a.dongia+a.vattu-a.stgiam)*b.bhyt/100 else 0 end ) as bhyt,";
                            sql += "sum(a.soluong*a.vattu) as vattu, b.id_loai ";
                            sql += ", to_number('0') as toathuoc, a.traituyen, a.tylegiam, a.dachenhlech ";
                            sql += ",a.mabs,0 as id_vpkhoa, a.id as idtonghop, to_number('0') as stttonghop  ";//gam 27/02/2012
                            sql += " from " + xxx + ".v_chidinh a," + usr + ".v_giavp b where a.mavp=b.id and a.mabn='" + mabn + "'";
                            if (loaiba == 2) sql += " and " + for_ngay("a.ngay", stime) + " between to_date('" + tu.Substring(0, 10) + "'," + stime + ") and to_date('" + den.Substring(0, 10) + "'," + stime + ")";
                            else
                            {
                                if (bTt_ndot) sql += " and " + for_ngay("a.ngay", stime) + " between to_date('" + tu.Substring(0, 10) + "'," + stime + ") and to_date('" + den.Substring(0, 10) + "'," + stime + ")";
                                else if (idkhoa != 0)
                                {
                                    sql += " and a.idkhoa=" + idkhoa;
                                    if (!bKhoa) sql += " and " + for_ngay("a.ngay", stime) + " between to_date('" + tu.Substring(0, 10) + "'," + stime + ") and to_date('" + den.Substring(0, 10) + "'," + stime + ")";
                                }
                            }
                            sql += " and a.madoituong=" + madoituong;
                            if (makp != "") sql += " and a.makp='" + makp + "'";
                            if (done == 0 || done == 2)
                            {
                                if (loaiba == 2) sql += " and a.paid=0";
                                else sql += " and (a.paid=0 and a.idttrv=0)";
                            }
                            else if (done == 1) sql += " and a.paid=" + done;
                            if (idttrv.Trim().Trim(',') != "") sql += " and a.idttrv in(" + idttrv.Trim().Trim(',') + ")";
                            if (maso != "")
                            {
                                if (bCapve)
                                {
                                    sql += " and a.mavaovien in (" + maso + ")";
                                }
                                else
                                {
                                    sql += " and a.maql in (" + maso + ")";
                                }
                            }
                            else sql += " and a.maql=" + maql;

                            if (s_mavp_congkham.Trim() != "" && madoituong == 1 && loaiba == 1 && bNhapvien_kocongkham) sql += " and (a.mavp not in (" + s_mavp_congkham + ") or (a.mavp in (" + s_mavp_congkham + ") and (a.makp='99' or a.makp='999')))";//bbbb

                            sql += " group by a.idttrv,a.traituyen, a.tylegiam, ";
                            if (ndot) sql += " a.id,";
                            sql += "to_char(a.ngay,'dd/mm/yyyy'),a.makp,a.mavp,a.dongia+a.vattu-a.stgiam,b.id_loai, a.dachenhlech";
                            sql += ",a.mabs, a.id ";//gam 27/02/2012
                        }
                        if (be == 0) dsv = get_data(sql);
                        else dsv.Merge(get_data(sql));
                        be++;
                        //if (maql_phongluu != 0)// bỏ đkien && loaiba != 2)//Thuy 07.09.2012 lay chi phí phong luu xử trí đtri ngtru khi in phieu tt dich vu ở ngoai tru
                        if (maql_phongluu != 0 && maso.IndexOf(maql_phongluu.ToString()) < 0) //binh 17122012: do bn tu pl chuyen vao noi tru bi double
                        {
                            sql = "select a.idttrv,";
                            if (ndot) sql += " a.id,";
                            else sql += " 0 as id,";
                            sql += "to_char(a.ngay,'dd/mm/yyyy') as ngay,a.makp,a.mavp,a.dongia+a.vattu-a.stgiam as dongia,sum(a.soluong) as soluong,sum(a.soluong*(a.dongia+a.vattu-a.stgiam)) as sotien, ";
                            sql += "sum(0) as bhytt0107,";
                            sql += "sum(case when a.madoituong=1 then a.soluong*(a.dongia+a.vattu-a.stgiam)*b.bhyt/100 else 0 end ) as bhyt,";
                            sql += "sum(a.soluong*a.vattu) as vattu, b.id_loai ";
                            sql += ", to_number('0') as toathuoc, a.traituyen, a.tylegiam, a.dachenhlech ";
                            sql += ",'' as mabs,a.id as id_vpkhoa, a.id as idtonghop, to_number('0') as stttonghop  ";//gam 27/02/2012
                            sql += " from " + xxx + ".v_vpkhoa a," + usr + ".v_giavp b where a.mavp=b.id and a.mabn='" + mabn + "'";
                            sql += " and a.maql=" + maql_phongluu;
                            sql += " and a.madoituong=" + madoituong;
                            if (idkhoa != 0) sql += " and " + for_ngay("a.ngay", stime) + " between to_date('" + tu.Substring(0, 10) + "'," + stime + ") and to_date('" + den.Substring(0, 10) + "'," + stime + ")";
                            if (done == 0 || done == 2) sql += " and (a.done=0 and a.idttrv=0)";
                            else if (done == 1) sql += " and a.done=" + done;
                            if (idttrv.Trim().Trim(',') != "") sql += " and a.idttrv in(" + idttrv.Trim().Trim(',') + ")";
                            if (s_mavp_congkham.Trim() != "" && madoituong == 1 && loaiba == 1 && bNhapvien_kocongkham) sql += " and (a.mavp not in (" + s_mavp_congkham + ") or (a.mavp in (" + s_mavp_congkham + ") and (a.makp='99' or a.makp='999')))";//bbbb
                            sql += " group by a.idttrv,a.traituyen, a.tylegiam,";
                            if (ndot) sql += " a.id,";
                            sql += "to_char(a.ngay,'dd/mm/yyyy'),a.makp,a.mavp,a.dongia+a.vattu-a.stgiam,b.id_loai, a.dachenhlech,a.id";
                            if (bChidinh_vienphi && !doub_maql)
                            {
                                sql += " union all ";
                                sql += "select  a.idttrv,";
                                if (ndot) sql += " a.id,";
                                else sql += " 0 as id,";
                                sql += " to_char(a.ngay,'dd/mm/yyyy') as ngay,a.makp,a.mavp,a.dongia+a.vattu-a.stgiam as dongia,sum(a.soluong) as soluong,sum(a.soluong*(a.dongia+a.vattu-a.stgiam)) as sotien, ";
                                sql += "sum(0) as bhytt0107,";
                                sql += "sum(case when a.madoituong=1 then a.soluong*(a.dongia+a.vattu-a.stgiam)*b.bhyt/100 else 0 end ) as bhyt,";
                                sql += "sum(a.soluong*a.vattu) as vattu, b.id_loai ";
                                sql += ", to_number('0') as toathuoc, a.traituyen, a.tylegiam, a.dachenhlech ";
                                sql += ",a.mabs,0 as id_vpkhoa, a.id as idtonghop, to_number('0') as stttonghop  ";//gam 27/02/2012
                                sql += " from " + xxx + ".v_chidinh a," + usr + ".v_giavp b where a.mavp=b.id and a.mabn='" + mabn + "'";
                                sql += " and a.maql=" + maql_phongluu;
                                sql += " and a.madoituong=" + madoituong;
                                if (done == 0 || done == 2)
                                {
                                    if (loaiba == 2) sql += " and a.paid=0";
                                    else sql += " and (a.paid=0 and a.idttrv=0)";
                                }
                                else if (done == 1) sql += " and a.paid=" + done;
                                if (idttrv.Trim().Trim(',') != "") sql += " and a.idttrv in(" + idttrv.Trim().Trim(',') + ")";
                                if (idkhoa != 0) sql += " and " + for_ngay("a.ngay", stime) + " between to_date('" + tu.Substring(0, 10) + "'," + stime + ") and to_date('" + den.Substring(0, 10) + "'," + stime + ")";

                                if (s_mavp_congkham.Trim() != "" && madoituong == 1 && loaiba == 1 && bNhapvien_kocongkham) sql += " and (a.mavp not in (" + s_mavp_congkham + ") or (a.mavp in (" + s_mavp_congkham + ") and (a.makp='99' or a.makp='999')))";//bbbb
                                sql += " group by a.idttrv, a.traituyen, a.tylegiam, ";
                                if (ndot) sql += " a.id,";
                                sql += "to_char(a.ngay,'dd/mm/yyyy'),a.makp,a.mavp,a.dongia+a.vattu-a.stgiam,b.id_loai, a.dachenhlech";
                                sql += ",a.mabs, a.id ";//gam 27/02/2012
                            }
                            dsv.Merge(get_data(sql));
                        }
                        if (v.bThongtu03)
                        {
                            sql = "select 0 as idttrv,0 as id,to_char(a.ngay,'dd/mm/yyyy') as ngay,a.makp,c.mavp,b.gia_th+b.vattu_th as dongia,sum(a.somat) as soluong,sum(a.somat*(b.gia_th+b.vattu_th)) as sotien, ";
                            sql += "sum(0) as bhytt0107,";
                            sql += "sum(case when a.madoituong=1 then a.somat*(b.gia_th+b.vattu_th)*b.bhyt/100 else 0 end ) as bhyt,";
                            sql += "sum(a.somat*b.vattu_th) as vattu,b.id_loai ";
                            sql += ", to_number('0') as toathuoc, 0 as traituyen, 0 as tylegiam, 1 as dachenhlech,0 as id_vpkhoa ";
                            sql += ", a.id as idtonghop, to_number('0') as stttonghop ";
                            sql += " from " + xxx + ".pttt a," + usr + ".v_giavp b," + usr + ".dmpttt c where a.mapt=c.mapt and c.mavp=b.id and a.mabn='" + mabn + "'";
                            sql += " and " + for_ngay("a.ngay", stime) + " between to_date('" + tu.Substring(0, 10) + "'," + stime + ") and to_date('" + den.Substring(0, 10) + "'," + stime + ")";
                            sql += " and a.madoituong=" + madoituong;
                            if (makp != "") sql += " and a.makp='" + makp + "'";
                            if (maso != "") sql += " and a.maql in (" + maso + ")";
                            sql += " group by to_char(a.ngay,'dd/mm/yyyy'),a.makp,c.mavp,b.gia_th+b.vattu_th,b.id_loai";
                            sql += ", a.id ";
                            if (be == 0) dsv = get_data(sql);
                            else dsv.Merge(get_data(sql));
                        }
                    }
                }
            }
            if ((bCapve || bNgtr || loaiba == 2 || loaiba == 4) && (done != 3 && done != 1))// Neu G17 co chon va ...//gam 14/09/2011 them dk done!=1
            {
                dt1 = d.StringToDate(tu).AddDays(-d.iNgaykiemke);
                dt2 = d.StringToDate(den).AddDays(d.iNgaykiemke);
                y1 = dt1.Year; m1 = dt1.Month;
                y2 = dt2.Year; m2 = dt2.Month;
                mmyy = "";
                for (int i = y1; i <= y2; i++)
                {
                    itu = (i == y1) ? m1 : 1;
                    iden = (i == y2) ? m2 : 12;
                    for (int j = itu; j <= iden; j++)
                    {
                        mmyy = j.ToString().PadLeft(2, '0') + i.ToString().Substring(2, 2);
                        if (bMmyy(mmyy))
                        {
                            //chuyen chi phi phong kham , cap cuu da duyet ben duoc --> vao noi tru
                            xxx = usr + mmyy;

                            sql = "select k.done as idttrv,0 as id,to_char(k.ngay,'dd/mm/yyyy') as ngay,k.makp,a.mavp,a.dongia,sum(a.soluong) as soluong,sum(a.soluong*a.dongia) as sotien, ";
                            sql += "sum(0) as bhytt0107,";
                            sql += "sum(case when k.maphu=1 then a.soluong*a.dongia*b.bhyt/100 else 0 end ) as bhyt, 0 as vattu, ";
                            sql += "b.id_loai ";
                            sql += ", to_number('0') as toathuoc, k.traituyen, 0 as tylegiam, 1 as dachenhlech ";
                            sql += ",k.mabs,0 as id_vpkhoa, k.id as idtonghop, a.stt as stttonghop  ";//gam 27/02/2012
                            sql += " from " + xxx + ".bhytkb k," + xxx + ".bhytcls a," + usr + ".v_giavp b ";
                            sql += " where k.id=a.id and a.mavp=b.id and k.mabn='" + mabn + "'";
                            sql += " and " + for_ngay("k.ngay", stime) + " between to_date('" + tu.Substring(0, 10) + "'," + stime + ") and to_date('" + den.Substring(0, 10) + "'," + stime + ")";
                            sql += " and k.maphu=" + madoituong;
                            if (done == 0 || done == 2) sql += " and k.sobienlai=0";
                            else if (done == 1) sql += " and k.sobienlai<>0";
                            //if (idttrv.Trim().Trim(',') != "") sql += " and a.idttrv in(" + idttrv.Trim().Trim(',') + ")";
                            if (maso != "") sql += " and k.maql in (" + maso + ")";
                            if (loaiba != 2) sql += " and k.loaiba in(1, 3, 4)";
                            else sql += " and k.loaiba in(2)";
                            sql += " group by k.done,to_char(k.ngay,'dd/mm/yyyy'),k.makp,a.mavp,a.dongia,b.id_loai, k.traituyen";
                            sql += ",k.mabs, k.id, a.stt ";//gam 27/02/2012
                            if (be == 0) dsv = get_data(sql);
                            else merge(dsv, get_data(sql)); //dsv.Merge(get_data(sql));
                            be++;

                            if (bNgtr && loaiba != 2)//If G24 chon  //chuyen chi phi dieu tri ngoai tru da duyet ben duoc --> vao noi tru                            
                            {
                                sql = "select  k.done as idttrv,0 as id,to_char(k.ngay,'dd/mm/yyyy') as ngay,k.makp,a.mavp,a.dongia,sum(a.soluong) as soluong,sum(a.soluong*a.dongia) as sotien, ";
                                sql += "sum(0) as bhytt0107,";
                                sql += "sum(case when k.maphu=1 then a.soluong*a.dongia*b.bhyt/100 else 0 end ) as bhyt, 0 as vattu, ";
                                sql += "b.id_loai";
                                sql += ", to_number('0') as toathuoc, k.traituyen, 0 as tylegiam, 1 as dachenhlech ";
                                sql += ",k.mabs,0 as id_vpkhoa, k.id as idtonghop, a.stt as stttonghop  ";//gam 27/02/2012
                                sql += " from " + xxx + ".bhytkb k," + xxx + ".bhytcls a," + usr + ".v_giavp b where k.id=a.id and a.mavp=b.id and k.mabn='" + mabn + "'";
                                sql += " and " + for_ngay("k.ngay", stime) + " between to_date('" + tu.Substring(0, 10) + "'," + stime + ") and to_date('" + den.Substring(0, 10) + "'," + stime + ")";
                                sql += " and k.maphu=" + madoituong;
                                if (maso != "") sql += " and k.maql in (" + maso + ")";
                                sql += " and k.loaiba=2";
                                sql += " group by k.done,to_char(k.ngay,'dd/mm/yyyy'),k.makp,a.mavp,a.dongia,b.id_loai, k.traituyen ";
                                sql += ",k.mabs, k.id, a.stt ";//gam 27/02/2012
                                if (be == 0) dsv = get_data(sql);
                                else merge(dsv, get_data(sql)); //dsv.Merge(get_data(sql));
                                be++;
                            }
                        }
                    }
                }
                if (loaiba == 4 && bInchiphi_congkham && madoituong == 1)
                {
                    int iMavp_congkham = d.iMavp_congkham(nhom_duoc);
                    sql = "select  0 as idttrv,id,'" + tu.Substring(0, 10) + "' as ngay,'" + ((makp == "") ? "99" : makp) + "' as makp,";
                    sql += " id as mavp,gia_bh as dongia,1.00 as soluong,gia_bh as sotien, ";
                    sql += "0 as bhytt0107,";
                    sql += "gia_bh as bhyt,0 as vattu";
                    sql += "id_loai,0 as toathuoc,0 as traituyen,to_number('0') as tylegiam,1 as dachenhlech,0 as mabs,0 as id_vpkhoa,0 as idtonghop,0 as stttonghop from " + usr + ".v_giavp where id=" + iMavp_congkham;
                    if (be == 0) dsv = get_data(sql);
                    else merge(dsv, get_data(sql)); //dsv.Merge(get_data(sql));
                }
            }
            //sum những dòng trùng key khi thêm vào thvpct
            DataSet dsv1 = dsv.Clone();
            DataRow dr1;
            decimal soluong = 0, sotien = 0, bhyt = 0;
            foreach (DataRow dr0 in dsv.Tables[0].Rows)
            {
                dr1 = getrowbyid(dsv1.Tables[0], "id=" + dr0["id"].ToString() + ""
                    + " and makp='" + dr0["makp"].ToString() + "' and dongia=" + dr0["dongia"].ToString() + " and mavp="
                    + dr0["mavp"].ToString() + " and ngay='" + dr0["ngay"].ToString() + "'");
                if (dr1 == null)
                {
                    dsv1.Tables[0].ImportRow(dr0);
                }
                else
                {
                    soluong = decimal.Parse(dr1["soluong"].ToString()) + decimal.Parse(dr0["soluong"].ToString());
                    sotien = decimal.Parse(dr1["sotien"].ToString()) + decimal.Parse(dr0["sotien"].ToString());
                    bhyt = decimal.Parse(dr1["bhyt"].ToString()) + decimal.Parse(dr0["bhyt"].ToString());
                    dr1["soluong"] = soluong.ToString();
                    dr1["sotien"] = sotien.ToString();
                    dr1["bhyt"] = bhyt.ToString();
                    dsv1.AcceptChanges();
                }
            }
            return (be == 0) ? null : dsv1.Tables[0];
        }

        public decimal sotiengiuong(DataSet dsv, string tu, string den, int dichvu, string makp, int madoituong, decimal dongia, int idgiuong)
        {
            decimal st = 0;
            string usr = user;
            decimal so = (bNgayra_ngayvao_1 || bNgaygiuong_tinhtheo_sangchieu) ? songaygiuong(StringToDateTime(den), StringToDateTime(tu), 1, idgiuong) : Math.Max(1, songay(StringToDateTime(den.Substring(0, 10)), StringToDateTime(tu.ToString().Substring(0, 10)), (makp == "01") ? 1 : 0));
            st = so * dongia;

            if (dsv != null)
            {
                sql = "select 0 as idttrv,0 as id,'" + den.Substring(0, 10) + "' as ngay,'" + makp + "' as makp,b.id as mavp," + dongia + " as dongia," + so + " as soluong," + st + " as sotien, ";
                sql += "0 as bhytt0107, case when b.bhyt<= 0 then 0 else b.gia_bh*" + so + " end as bhyt,0 as vattu, b.id_loai, 0 as toathuoc, 0 as traituyen, 0 as tylegiam";
                if (madoituong == 1) sql += ", 0 as dachenhlech ";
                else sql += ", 1 as dachenhlech ";
                sql += " from " + usr + ".v_giavp b," + usr + ".v_loaivp c where b.id_loai=c.id and b.id=" + idgiuong;
                merge(dsv, get_data(sql));
                //if (madoituong == 1 && bChenhlech && bGia_vp_cochenhlech(idgiuong))
                //{
                //    string fie = field_gia(iTunguyen.ToString());
                //    sql = "select 0 as idttrv,0 as id,'" + den.Substring(0, 10) + "' as ngay,'" + makp + "' as makp,b.id as mavp,b." + fie + "-" + dongia + " as dongia," + so + " as soluong,(b." + fie + "-" + dongia + ")*" + so + " as sotien, ";
                //    sql += "0 as bhytt0107, 0 as bhyt,b.id_loai, 0 as traituyen, 0 as tylegiam," + iTunguyen + " as madoituong ";
                //    sql += " from " + usr + ".v_giavp b," + usr + ".v_loaivp c where b.id_loai=c.id and b.id=" + idgiuong;
                //    merge(dsv, get_data(sql));
                //}
            }
            return st;
        }

        private decimal get_tamung_ct(string mabn, decimal maql, decimal idkhoa, string tu, string den, string makp, int madoituong, int done, decimal maql_phongluu, int loaiba, bool bKhoa, string maso, string idttrv)
        {
            decimal ret = 0;
            bool b_bTonghopbienlaitamung_chuahoan = bTonghopbienlaitamung_chuahoan;
            DateTime dt1 = d.StringToDate(tu).AddDays(-d.iNgaykiemke);
            DateTime dt2 = d.StringToDate(den).AddDays(d.iNgaykiemke);
            int y1 = dt1.Year, m1 = dt1.Month;
            int y2 = dt2.Year, m2 = dt2.Month;
            int itu, iden;
            string mmyy = "", usr = user, xxx, s = "";
            string stime = "'" + f_ngay + "'";
            bool bTt_ndot = bThanhtoan_ndot;
            for (int i = y1; i <= y2; i++)
            {
                itu = (i == y1) ? m1 : 1;
                iden = (i == y2) ? m2 : 12;
                for (int j = itu; j <= iden; j++)
                {
                    mmyy = j.ToString().PadLeft(2, '0') + i.ToString().Substring(2, 2);
                    if (bMmyy(mmyy))
                    {
                        xxx = usr + mmyy;
                        sql = "select sum(a.sotien) as sotien,a.quyenso, b.sohieu,a.sobienlai  from " + xxx + ".v_tamung a, " + usr + ".v_quyenso b ";
                        sql += " where a.quyenso=b.id and a.mabn='" + mabn + "'";
                        sql += " and madoituong=" + madoituong;
                        if (done == 0 || done == 2) sql += " and a.done=0";
                        else if (done == 1) sql += " and a.done=" + done;
                        if (idttrv.Trim().Trim(',') != "") sql += " and a.idttrv in(" + idttrv.Trim().Trim(',') + ")";
                        if (loaiba == 2) sql += " and " + for_ngay("a.ngay", stime) + " between to_date('" + tu.Substring(0, 10) + "'," + stime + ") and to_date('" + den.Substring(0, 10) + "'," + stime + ")";
                        else
                        {
                            if (bTt_ndot) sql += " and " + for_ngay("a.ngay", stime) + " between to_date('" + tu.Substring(0, 10) + "'," + stime + ") and to_date('" + den.Substring(0, 10) + "'," + stime + ")";
                            else if (idkhoa != 0)
                            {
                                //sql += " and a.idkhoa in (0,"+idkhoa+")";
                                if (!bKhoa) sql += " and " + for_ngay("a.ngay", stime) + " between to_date('" + tu.Substring(0, 10) + "'," + stime + ") and to_date('" + den.Substring(0, 10) + "'," + stime + ")";
                            }
                        }
                        if (!b_bTonghopbienlaitamung_chuahoan)
                        {
                            if (makp != "") sql += " and a.makp='" + makp + "'";
                            if (maso != "") sql += " and a.maql in (0," + maso.Substring(0, maso.Length - 1) + ")";
                            else sql += " and (a.maql=" + maql + " or a.maql=0)";
                        }
                        sql += " group by a.quyenso, b.sohieu, a.sobienlai";
                        ds = get_data(sql);
                        foreach (DataRow r in ds.Tables[0].Rows)
                        {
                            if (r["sotien"].ToString() != "")
                            {
                                ret += decimal.Parse(r["sotien"].ToString());
                                b_sobienlaitamung += r["sohieu"].ToString().Trim() + "-" + r["sobienlai"].ToString().Trim() + ":" + r["sotien"].ToString().Trim() + ";";
                                s += r["quyenso"].ToString().Trim() + "-" + r["sobienlai"].ToString().Trim() + ";";
                            }
                        }//121102182311771071
                        if (maql_phongluu != 0)
                        {
                            string[] s_maso = maso.Split(',');
                            bool bTrung_Maql_PLuu = false;
                            for (int k = 0; k < s_maso.Length -1; k++)
                            {
                                if (maql_phongluu == decimal.Parse(s_maso[k].ToString()))
                                {
                                    bTrung_Maql_PLuu = true;
                                }
                            }
                            if (!bTrung_Maql_PLuu)
                            {
                                sql = "select sum(a.sotien) as sotien,a.quyenso,b.sohieu,a.sobienlai from " + xxx + ".v_tamung a, " + usr + ".v_quyenso b where a.quyenso=b.id and a.mabn='" + mabn + "'";
                                sql += " and a.maql=" + maql_phongluu;
                                sql += " and madoituong=" + madoituong;
                                if (idttrv.Trim().Trim(',') != "") sql += " and a.idttrv in(" + idttrv.Trim().Trim(',') + ")";
                                if (done == 0 || done == 2) sql += " and a.done=0";
                                else if (done == 1) sql += " and a.done=" + done;
                                if (idkhoa != 0) sql += " and " + for_ngay("a.ngay", stime) + " between to_date('" + tu.Substring(0, 10) + "'," + stime + ") and to_date('" + den.Substring(0, 10) + "'," + stime + ")";
                                sql += " group by a.quyenso,b.sohieu,a.sobienlai";
                                ds = get_data(sql);
                                foreach (DataRow r in ds.Tables[0].Rows)
                                {
                                    if (r["sotien"].ToString() != "")
                                    {
                                        ret += decimal.Parse(r["sotien"].ToString());
                                        b_sobienlaitamung += r["sohieu"].ToString().Trim() + "-" + r["sobienlai"].ToString().Trim() + ":" + r["sotien"].ToString().Trim() + ";";
                                        s += r["quyenso"].ToString().Trim() + "-" + r["sobienlai"].ToString().Trim() + ";";
                                    }
                                }
                            }
                        }
                    }
                }
            }
            //hoan tra
            for (int i = y1; i <= y2; i++)
            {
                itu = (i == y1) ? m1 : 1;
                iden = (i == y2) ? m2 : 12;
                for (int j = itu; j <= iden; j++)
                {
                    mmyy = j.ToString().PadLeft(2, '0') + i.ToString().Substring(2, 2);
                    if (bMmyy(mmyy))
                    {
                        xxx = usr + mmyy;
                        sql = "select sum(a.sotien) as sotien, a.quyenso, b.sohieu,a.sobienlai  from " + xxx + ".v_hoantra a, " + user + ".v_quyenso b where a.quyenso=b.id and a.mabn='" + mabn + "'";
                        sql += " and " + for_ngay("a.ngay", stime) + " between to_date('" + tu.Substring(0, 10) + "'," + stime + ") and to_date('" + den.Substring(0, 10) + "'," + stime + ")";
                        sql += " and a.loaibn=2";
                        sql += " group by a.quyenso, b.sohieu, a.sobienlai";
                        ds = get_data(sql);
                        foreach (DataRow r in ds.Tables[0].Rows)
                        {
                            if (s.IndexOf(r["quyenso"].ToString().Trim() + "-" + r["sobienlai"].ToString().Trim() + ";") != -1)
                            {
                                ret -= decimal.Parse(r["sotien"].ToString());
                                b_sobienlaitamung += "Hoàn trả " + r["sohieu"].ToString().Trim() + "-" + r["sobienlai"].ToString().Trim() + ":" + r["sotien"].ToString().Trim() + ";";
                            }
                        }
                    }
                }
            }
            return ret;
        }

        public int get_sophieu_ravien(string mmyy, string mabn, decimal maql, int loaiba, string ngay, int madoituong, int userid)
        {
            int so = 0;
            string xxx = user + mmyy;
            DataTable dt = get_data("select so from " + xxx + ".sophieurv where so<>0 and mabn='" + mabn + "' and to_char(ngay,'dd/mm/yyyy')='" + ngay.Substring(0, 10) + "' and madoituong=" + madoituong + " and maql=" + maql).Tables[0];
            if (dt.Rows.Count > 0)
            {
                so = int.Parse(dt.Rows[0]["so"].ToString());
                execute_data("update " + xxx + ".sophieurv set lanin=lanin+1 where mabn='" + mabn + "' and to_char(ngay,'dd/mm/yyyy')='" + ngay.Substring(0, 10) + "' and madoituong=" + madoituong + " and maql=" + maql);
            }
            else
            {
                sql = "update " + xxx + ".capsotoa set sotoa=sotoa+1 where id=" + loaiba + " and to_char(ngay,'dd/mm/yyyy')='" + ngay.Substring(0, 10) + "'";
                //if (madoituong!=0) sql+=" and loai="+madoituong;
                if (userid != 0) sql += " and userid=" + userid;
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                int i_rec= cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (i_rec == 0)
                {
                    //binh??? field loai lai gi
                    sql = "insert into " + xxx + ".capsotoa (id, ngay, sotoa, loai) values(" + loaiba + ", to_date('" + ngay.Substring(0, 10) + "','dd/mm/yyyy'),1,0)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
                //
                sql = "select sotoa from " + xxx + ".capsotoa where id=" + loaiba + " and to_char(ngay,'dd/mm/yyyy')='" + ngay.Substring(0, 10) + "'";
                //if (madoituong!=0) sql+=" and loai="+madoituong;
                if (userid != 0) sql += " and userid=" + userid;
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                dest = new NpgsqlDataAdapter(cmd);
                ds = new DataSet();
                dest.Fill(ds);
                cmd.Dispose();
                //
                con.Close(); con.Dispose();
                so = int.Parse(ds.Tables[0].Rows[0]["sotoa"].ToString());
                upd_sophieurv(mmyy, mabn, maql, loaiba, ngay, madoituong, so);
            }
            return so;
        }

        public int get_sophieu_ravien_yy(string mmyy, string mabn, decimal maql, int loaiba, string ngay, int madoituong, int userid, string ngayrv)
        {
            int so = 0;
            string xxx = user;
            DataTable dt = get_data("select so from " + xxx + ".sophieurv where so<>0 and mabn='" + mabn + "' and to_char(ngay,'dd/mm/yyyy')='" + ngayrv.Substring(0, 10) + "' and madoituong=" + madoituong + " and maql=" + maql).Tables[0];
            if (dt.Rows.Count > 0)
            {
                so = int.Parse(dt.Rows[0]["so"].ToString());
                execute_data("update " + xxx + ".sophieurv set lanin=lanin+1 where mabn='" + mabn + "' and to_char(ngay,'dd/mm/yyyy')='" + ngayrv.Substring(0, 10) + "' and madoituong=" + madoituong + " and maql=" + maql);
            }
            else
            {
                //sql = "update " + xxx + ".capsotoa set sotoa=sotoa+1 where id=" + loaiba + " and to_char(ngay,'dd/mm/yyyy')='" + ngay.Substring(0, 10) + "'";
                sql = "update " + xxx + ".capsotoa set sotoa=sotoa+1 where id=" + loaiba + " and to_char(ngay,'dd/mm/yyyy')='" + ngay.Substring(0, 10) + "'";
                //if (madoituong!=0) sql+=" and loai="+madoituong;
                if (userid != 0) sql += " and userid=" + userid;
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
                //
                sql = "select sotoa from " + xxx + ".capsotoa where id=" + loaiba + " and to_char(ngay,'dd/mm/yyyy')='" + ngay.Substring(0, 10) + "'";
                //if (madoituong!=0) sql+=" and loai="+madoituong;
                if (userid != 0) sql += " and userid=" + userid;
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                dest = new NpgsqlDataAdapter(cmd);
                ds = new DataSet();
                dest.Fill(ds);
                cmd.Dispose();
                //
                con.Close(); con.Dispose();
                so = int.Parse(ds.Tables[0].Rows[0]["sotoa"].ToString());
                upd_sophieurv_yy(mabn, maql, loaiba, ngayrv, madoituong, so);
            }
            return so;
        }
        public void upd_sophieurv(string mmyy, string mabn, decimal maql, int loaiba, string ngay, int madoituong, int so)
        {
            try
            {
                sql = "update " + user + mmyy + ".sophieurv set so=" + so + ",lanin=lanin+1 where maql=" + maql + " and to_char(ngay,'dd/mm/yyyy')='" + ngay.Substring(0, 10) + "'";
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                int i = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (i == 0)
                {
                    sql = "insert into " + user + mmyy + ".sophieurv(mabn,maql,loaiba,ngay,madoituong,so,lanin) values ('" + mabn + "'," + maql + "," + loaiba + ",to_date('" + ngay + "','dd/mm/yyyy hh24:mi')," + madoituong + "," + so + ",1)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.ExecuteNonQuery();
                }
            }
            catch { }
            finally
            {
                con.Close();
                con.Dispose();
            }
            //execute_data(sql);//linh 03112012
        }

        public void upd_sophieurv_yy(string mabn, decimal maql, int loaiba, string ngay, int madoituong, int so)
        {
            sql = "insert into " + user + ".sophieurv(mabn,maql,loaiba,ngay,madoituong,so,lanin) values ('" + mabn + "'," + maql + "," + loaiba + ",to_date('" + ngay + "','dd/mm/yyyy hh24:mi')," + madoituong + "," + so + ",1)";
            execute_data(sql);
        }
        public int get_laninrv(string mmyy, string mabn, decimal maql, string ngay, int madoituong)
        {
            sql = "select lanin from " + user + mmyy + ".sophieurv where mabn='" + mabn + "' and to_char(ngay,'dd/mm/yyyy')='" + ngay.Substring(0, 10) + "' and madoituong=" + madoituong + " and maql=" + maql;
            DataTable tmp = get_data(sql).Tables[0];
            if (tmp.Rows.Count == 0) return 0;
            else return int.Parse(tmp.Rows[0]["lanin"].ToString());
        }

        public string get_ghichurv(string mmyy, string mabn, decimal maql)
        {
            sql = "select ghichu from " + user + mmyy + ".sophieurv where mabn='" + mabn + "' and maql=" + maql;
            DataTable tmp = get_data(sql).Tables[0];
            if (tmp.Rows.Count == 0) return "";
            else return tmp.Rows[0]["ghichu"].ToString();
        }

        public bool upd_sophieurv(string m_mmyy, string m_mabn, decimal m_maql, string m_ghichu)
        {
            sql = "update " + user + m_mmyy + ".sophieurv set ghichu=:m_ghichu where mabn=:m_mabn and maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Varchar, 254).Value = m_ghichu;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "d_sophieurv");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }



        public string get_giuong(decimal maql, string makp)
        {
            //gam 31/08/2011 nếu như có khai báo danh mục phòng, giường thì lấy tên phòng giường, ngược lại lấy mã người dùng nhập khi nhập khoa
            DataSet dsgiuong = get_data("select a.ma,a.ten ||' - '||b.ten as tengiuong from " + user + ".dmgiuong a inner join " + user + ".dmphong b on a.idphong=b.id");
            sql = "select giuong from " + user + ".nhapkhoa where maql=" + maql;
            if (makp != "") sql += " and makp='" + makp + "'";
            sql += " order by ngay desc";
            ds = get_data(sql);
            try
            {
                if (ds.Tables[0].Rows.Count > 0)
                {
                    DataRow[] rct = dsgiuong.Tables[0].Select("ma='" + ds.Tables[0].Rows[0]["giuong"].ToString() + "'");
                    if (rct.Length > 0)
                    {
                        return rct[0]["tengiuong"].ToString();
                    }
                    else
                    {
                        return ds.Tables[0].Rows[0]["giuong"].ToString();
                    }
                }
                else return "";
            }
            catch
            { return ""; }
        }

        public bool upd_vantay(string m_mabn, byte[] m_kytu, byte[] m_hinhanh)
        {
            sql = "update vantay set kytu=:m_kytu,hinhanh=:m_hinhanh ";
            sql += "where mabn=:m_mabn";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_kytu", NpgsqlDbType.Bytea, m_kytu.Length).Value = m_kytu;
                cmd.Parameters.Add("m_hinhanh", NpgsqlDbType.Bytea, m_hinhanh.Length).Value = m_hinhanh;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into vantay(mabn,kytu,hinhanh) values (:m_mabn,:m_kytu,:m_hinhanh)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_kytu", NpgsqlDbType.Bytea, m_kytu.Length).Value = m_kytu;
                    cmd.Parameters.Add("m_hinhanh", NpgsqlDbType.Bytea, m_hinhanh.Length).Value = m_hinhanh;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "vantay");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool mien_doituong(int madoituong, DataTable dt)
        {
            return getrowbyid(dt, "mien=1 and madoituong=" + madoituong) != null;
        }

        public bool mien_doituong(int madoituong)
        {
            sql = "select * from " + user + ".doituong where mien=1 and madoituong=" + madoituong;
            return get_data(sql).Tables[0].Rows.Count > 0;

        }
        public string get_cholam(string mabn)
        {
            sql = "select cholam from " + user + ".btdbn where mabn='" + mabn + "'";
            ds = get_data(sql);
            if (ds.Tables[0].Rows.Count > 0) return ds.Tables[0].Rows[0]["cholam"].ToString().Trim();
            else return "";
        }

        public string get_nguoinha(string mabn, decimal maql)
        {
            DataTable dt;
            sql = "select * from " + user + ".hcsosinh where mabn='" + mabn + "'";
            dt = get_data(sql).Tables[0];
            if (dt.Rows.Count > 0) return (dt.Rows[0]["hoten_me"].ToString() != "") ? dt.Rows[0]["hoten_me"].ToString().Trim() : dt.Rows[0]["hoten_bo"].ToString().Trim();
            sql = "select * from " + user + ".hcnhi where mabn='" + mabn + "'";
            dt = get_data(sql).Tables[0];
            if (dt.Rows.Count > 0) return (dt.Rows[0]["hoten_me"].ToString() != "") ? dt.Rows[0]["hoten_me"].ToString().Trim() : dt.Rows[0]["hoten_bo"].ToString().Trim();
            return "";
        }

        public string get_nguoinha(string mmyy, string mabn, decimal maql)
        {
            DataTable dt;
            sql = "select * from " + user + ".hcsosinh where mabn='" + mabn + "'";
            dt = get_data(sql).Tables[0];
            if (dt.Rows.Count > 0) return (dt.Rows[0]["hoten_me"].ToString() != "") ? dt.Rows[0]["hoten_me"].ToString().Trim() : dt.Rows[0]["hoten_bo"].ToString().Trim();
            sql = "select * from " + user + ".hcnhi where mabn='" + mabn + "'";
            dt = get_data(sql).Tables[0];
            if (dt.Rows.Count > 0) return (dt.Rows[0]["hoten_me"].ToString() != "") ? dt.Rows[0]["hoten_me"].ToString().Trim() : dt.Rows[0]["hoten_bo"].ToString().Trim();
            sql = "select * from " + user + mmyy + ".quanhe where maql=" + maql;
            dt = get_data(sql).Tables[0];
            if (dt.Rows.Count > 0) return dt.Rows[0]["hoten"].ToString().Trim();
            return "";
        }

        public int phuongphapdieutri(string makp)
        {
            int ret = 1;
            ds = get_data("select makpbo from " + user + ".btdkp_bv where makp='" + makp + "'");
            if (ds.Tables[0].Rows.Count > 0)
            {
                string makpbo = ds.Tables[0].Rows[0]["makpbo"].ToString();
                if (ngoaikhoa.IndexOf(makpbo) != -1) ret = 2;
                else if (yhdt.IndexOf(makpbo) != -1) ret = 3;
            }
            return ret;
        }

        public int ketquadieutri(int ketqua, int ttlucrv)
        {
            int ret = 0;
            if (ketqua < 3) ret = ketqua;
            else if (ttlucrv == 6) return ret = 3;
            else if (ttlucrv == 7) return ret = 4;
            return ret;
        }

        public decimal get_maql_phongluu(string ngay, decimal maql)
        {
            decimal mavaovien = 0;
            ds = get_data("select mavaovien from " + user + ".benhandt where maql=" + maql);
            if (ds.Tables[0].Rows.Count > 0)
            {
                mavaovien = decimal.Parse(ds.Tables[0].Rows[0]["mavaovien"].ToString());
            }//Thuy 07.09.2012 get maql from benhanngtru for case print chi phi of phong luu in ngoaitru->phieu thanh toan dich vu
            else
            {
                ds = get_data("select mavaovien from " + user + ".benhanngtr where maql=" + maql);
                if (ds.Tables[0].Rows.Count > 0)
                {
                    mavaovien = decimal.Parse(ds.Tables[0].Rows[0]["mavaovien"].ToString());
                }
            }
            if (bMmyy(ngay))
            {
                ds = get_data("select maql from " + user + mmyy(ngay) + ".benhancc where mavaovien=" + mavaovien);
                if (ds.Tables[0].Rows.Count > 0) return decimal.Parse(ds.Tables[0].Rows[0]["maql"].ToString());
                else return 0;
            }
            else return 0;
        }

        public int get_sobienlai(decimal m_id, bool m_tang)
        {
            if (!m_tang) return get_sobienlai(m_id, 1);
            else
            {
                sql = "update " + user + ".v_quyenso set soghi=soghi+1 where id=:m_id";
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
                sql = "select soghi from " + user + ".v_quyenso where id=" + m_id;
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                dest = new NpgsqlDataAdapter(cmd);
                ds = new DataSet();
                dest.Fill(ds);
                cmd.Dispose();
                con.Close(); con.Dispose();
                return int.Parse(ds.Tables[0].Rows[0][0].ToString());
            }
        }

        public string get_soluutru(string mabn)
        {
            sql = "select b.soluutru from " + user + ".benhandt a," + user + ".lienhe b where a.maql=b.maql and a.mabn='" + mabn + "' order by a.maql desc";
            ds = get_data(sql);
            if (ds.Tables[0].Rows.Count > 0) return ds.Tables[0].Rows[0]["soluutru"].ToString();
            else return "";
        }

        public string get_soluutru(string nam, string mabn)
        {
            string ret = "";
            sql = "select b.soluutru from xxx.benhanpk a," + user + ".lienhe b where a.maql=b.maql and a.mabn='" + mabn + "' order by a.maql desc";
            foreach (DataRow r in get_data_nam_dec(nam, sql).Tables[0].Rows) ret = r["soluutru"].ToString();
            return ret;
        }

        public void updrec_donthuoc(DataTable dt, int mabd, string ma, string ten, string dang, string tenhc, int stt,string doituong,int madoituong)
        {
            string exp = "mabd=" + mabd;
            DataRow r = getrowbyid(dt, exp);
            if (r == null)
            {
                DataRow nrow = dt.NewRow();
                nrow["stt"] = stt;
                nrow["mabd"] = mabd;
                nrow["ma"] = ma;
                nrow["ten"] = ten;
                nrow["tenhc"] = tenhc;
                nrow["dang"] = dang;
                nrow["soluong"] = 1;
                nrow["doituong"] = doituong;
                nrow["madoituong"] = madoituong;
                dt.Rows.Add(nrow);
            }
        }

        public string field_gia(string madoituong)
        {
            string fie = "gia_th";
            if (madoituong != "")
            {
                try
                {
                    DataTable tmp = get_data("select field_gia from " + user + ".doituong where madoituong=" + int.Parse(madoituong)).Tables[0];
                    if (tmp.Rows.Count > 0) return tmp.Rows[0]["field_gia"].ToString().Trim();
                }
                catch { }
            }
            return fie;
        }

        public string field_gia1(int imavp, int itraituyen)
        {
            string fie = "";
            try
            {
                DataTable tmp = get_data("select a.gia_1 from " + user + ".congthucchenhlech a inner join " + user +
                    ".v_loaivp b on a.id_loaivp=b.id inner join " + user + ".v_giavp c on c.id_loai=b.id  where c.id=" + imavp + " and a.loai=" + itraituyen).Tables[0];
                if (tmp.Rows.Count > 0) return tmp.Rows[0]["gia_1"].ToString().Trim();
            }
            catch { }

            return fie;
        }

        public string field_gia2(int imavp, int itraituyen)
        {
            string fie = "";
            try
            {
                DataTable tmp = get_data("select a.gia_2 from " + user + ".congthucchenhlech a inner join " + user +
                    ".v_loaivp b on a.id_loaivp=b.id inner join " + user + ".v_giavp c on c.id_loai=b.id  where c.id=" + imavp + " and a.loai=" + itraituyen).Tables[0];
                if (tmp.Rows.Count > 0) return tmp.Rows[0]["gia_2"].ToString().Trim();
            }
            catch { }

            return fie;
        }

        public bool upd_danhmuc_sankhoa(int m_id, int m_stt, string m_ma, string m_ten, string m_table)
        {
            sql = "update " + user + "." + m_table + " set stt=:m_stt,ma=:m_ma,ten=:m_ten";
            sql += " where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 10).Value = m_ma;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + "." + m_table + " (id,stt,ma,ten) values (:m_id,:m_stt,:m_ma,:m_ten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 10).Value = m_ma;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, m_table);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public decimal get_id_hiendien_do_cdvv(string s_mabn, decimal s_maql, string s_noichuyen)
        {
            decimal lid = 0;
            sql = "select * from " + user + ".hiendien where mabn='" + s_mabn + "' and maql=" + s_maql + " and noichuyen='" + s_noichuyen + "' and nhapkhoa=0 and xuatkhoa=0 order by id desc";
            DataTable dt = get_data(sql).Tables[0];
            if (dt.Rows.Count > 0)
            {
                lid = decimal.Parse(dt.Rows[0]["id"].ToString());
            }
            dt.Dispose();
            return lid;
        }

        public DataSet get_thanhtoan(decimal l_maql, decimal l_idkhoa, string ngayvv, string ngayrv, int loaiba, bool bKhoa, string tenuser, int usrid)
        {
            LibDuoc.AccessData d = new LibDuoc.AccessData();
            string mabn = "", s_tenkp = "", s_sothe = "", s_denngay = "", s_tenbv = "", s_vao = "", s_ra = "", usr = user, maso = l_maql.ToString() + ",";
            int i_madoituong = 1;
            bool in_sovaovien = bInsovaovien_ravien;
            DataSet dsngay = new DataSet();
            DataSet dsxml = new DataSet();
            DataSet ds = new DataSet();
            DataSet dsss = new DataSet();
            DataTable dtkp;
            DataRow dr;
            decimal mavaovien = 0;
            dtkp = get_data("select * from " + usr + ".d_duockp").Tables[0];
            dsngay.ReadXml("..//..//..//xml//m_ngayvao.xml");
            dsngay.Tables[0].Columns.Add("mabs");
            dsngay.Tables[0].Columns.Add("tenbs");
            dsngay.Tables[0].Columns.Add("cholam");
            dsngay.Tables[0].Columns.Add("traituyen", typeof(decimal));
            dsxml.ReadXml("..//..//..//xml//m_inravien.xml");
            //binh 070807 - Thieu so voi ben medisoft - phong luu, thanh toan ra vien, nen em copy sang
            //con phia duoi em chua xu ly, de tam cho BV xuat khoa duoc
            dsxml.Tables[0].Columns.Add("Image", typeof(byte[]));
            dsxml.Tables[0].Columns.Add("Imagetk", typeof(byte[]));
            dsxml.Tables[0].Columns.Add("Imageuser", typeof(byte[]));
            dsxml.Tables[0].Columns.Add("mabs");
            dsxml.Tables[0].Columns.Add("tenbs");
            dsxml.Tables[0].Columns.Add("makprv");
            dsxml.Tables[0].Columns.Add("cholam");
            dsxml.Tables[0].Columns.Add("gianovat", typeof(decimal));
            dsxml.Tables[0].Columns.Add("idttrv", typeof(string));
            dsxml.Tables[0].Columns.Add("sotientra", typeof(decimal));
            dsxml.Tables[0].Columns.Add("traituyen", typeof(decimal));
            dsxml.Tables[0].Columns.Add("kythuat", typeof(decimal));
            dsxml.Tables[0].Columns.Add("loaikythuat", typeof(string));
            dsxml.Tables[0].Columns.Add("quyenso_tt", typeof(string));
            dsxml.Tables[0].Columns.Add("sobienlai_tt", typeof(string));
            try
            {
                dsxml.Tables[0].Columns.Add("mabsct", typeof(string));//gam 27/02/2012
            }
            catch { }
            try
            {
                dsxml.Tables[0].Columns.Add("id_ktcao", typeof(decimal));
            }
            catch { }
            //end binh
            ds.ReadXml("..//..//..//xml//m_ravien.xml");
            ds.Tables[0].Columns.Add("chon", typeof(bool));
            ds.Tables[0].Columns.Add("mabs");
            ds.Tables[0].Columns.Add("tenbs");
            ds.Tables[0].Columns.Add("cholam");
            ds.Tables[0].Columns.Add("gianovat", typeof(decimal));
            ds.Tables[0].Columns.Add("idttrv", typeof(decimal));
            ds.Tables[0].Columns.Add("sotientra", typeof(decimal));
            ds.Tables[0].Columns.Add("traituyen", typeof(decimal));
            ds.Tables[0].Columns.Add("kythuat", typeof(decimal));
            ds.Tables[0].Columns.Add("loaikythuat", typeof(string));
            ds.Tables[0].Columns.Add("quyenso_tt", typeof(string));
            ds.Tables[0].Columns.Add("sobienlai_tt", typeof(string));


            dsss.ReadXml("..//..//..//xml//m_ravienss.xml");
            dsss.Tables[0].Columns.Add("chon", typeof(bool));
            dsss.Tables[0].Columns.Add("mabs");
            dsss.Tables[0].Columns.Add("tenbs");
            dsss.Tables[0].Columns.Add("cholam");
            dsss.Tables[0].Columns.Add("gianovat", typeof(decimal));
            dsss.Tables[0].Columns.Add("idttrv", typeof(decimal));
            dsss.Tables[0].Columns.Add("sotientra", typeof(decimal));
            dsss.Tables[0].Columns.Add("traituyen", typeof(decimal));
            dsss.Tables[0].Columns.Add("kythuat", typeof(decimal));
            dsss.Tables[0].Columns.Add("loaikythuat", typeof(string));
            dsss.Tables[0].Columns.Add("quyenso_tt", typeof(string));
            dsss.Tables[0].Columns.Add("sobienlai_tt", typeof(string));
            if (loaiba == 1)
            {
                if (bKhoa)
                {
                    sql = "select a.mabn,c.hoten,c.namsinh,c.phai,c.sonha,c.thon,h.mavaovien,a.maql,a.id,a.giuong,";
                    sql += "to_char(a.ngay,'dd/mm/yyyy hh24:mi') as ngayvao,";
                    sql += "case when b.ngay is null then to_char(now(),'dd/mm/yyyy hh24:mi') else to_char(b.ngay,'dd/mm/yyyy hh24:mi') end as ngayra,";
                    sql += "a.makp,d.tenkp,b.chandoan,b.maicd,e.tentt,f.tenquan,g.tenpxa,";
                    sql += "case when b.ketqua is null then 0 else b.ketqua end as ketqua,";
                    sql += "case when b.ttlucrk is null then 0 else b.ttlucrk end as ttlucrv,";
                    if (in_sovaovien) sql += "'^'||nvl(h.sovaovien,'') as soluutru,";
                    else sql += "' ^' as soluutru,";
                    sql += "h.madoituong,h.mavaovien,b.mabs,i.hoten as tenbs,c.cholam ";
                    sql += "from " + usr + ".nhapkhoa a inner join " + usr + ".xuatkhoa b on a.id=b.id ";
                    sql += "inner join " + usr + ".btdbn c on a.mabn=c.mabn ";
                    sql += "inner join " + usr + ".btdkp_bv d on a.makp=d.makp ";
                    sql += "inner join " + usr + ".btdtt e on c.matt=e.matt ";
                    sql += "inner join " + usr + ".btdquan f on c.maqu=f.maqu ";
                    sql += "inner join " + usr + ".btdpxa g on c.maphuongxa=g.maphuongxa ";
                    sql += "inner join " + usr + ".benhandt h on a.maql=h.maql ";
                    sql += "left join " + usr + ".dmbs i on b.mabs=i.ma ";//Thuy 24.05.2012
                    sql += "where a.id=" + l_idkhoa;
                }
                else
                {
                    sql = "select a.mabn,c.hoten,c.namsinh,c.phai,c.sonha,c.thon,a.mavaovien,a.maql,0 as id,' ' as giuong,";
                    sql += "to_char(a.ngay,'dd/mm/yyyy hh24:mi') as ngayvao,";
                    sql += "case when b.ngay is null then to_char(now(),'dd/mm/yyyy hh24:mi') else to_char(b.ngay,'dd/mm/yyyy hh24:mi') end as ngayra,";
                    sql += "case when b.makp is null then a.makp else b.makp end as makp,case when b.makp is null then h.tenkp else d.tenkp end as tenkp,";
                    sql += "case when b.chandoan is null then a.chandoan else b.chandoan end as chandoan,case when b.maicd is null then a.maicd else b.maicd end as maicd,";
                    sql += "e.tentt,f.tenquan,g.tenpxa,case when b.ketqua is null then 0 else b.ketqua end as ketqua,";
                    sql += "case when b.ttlucrv is null then 0 else b.ttlucrv end as ttlucrv,";
                    if (in_sovaovien) sql += "nvl(b.soluutru,'')||'^'||nvl(a.sovaovien,'') as soluutru,";
                    else sql += "nvl(b.soluutru,'')||'^' as soluutru,";
                    sql += " a.madoituong,a.mavaovien,b.mabs,i.hoten as tenbs,c.cholam ";
                    sql += "from " + usr + ".benhandt a left join " + usr + ".xuatvien b on a.maql=b.maql ";
                    sql += " inner join " + usr + ".btdbn c on a.mabn=c.mabn ";
                    sql += " left join " + usr + ".btdkp_bv d on b.makp=d.makp ";
                    sql += " inner join " + usr + ".btdtt e on c.matt=e.matt ";
                    sql += " inner join " + usr + ".btdquan f on c.maqu=f.maqu ";
                    sql += " inner join " + usr + ".btdpxa g on c.maphuongxa=g.maphuongxa ";
                    sql += " inner join " + usr + ".btdkp_bv h on a.makp=h.makp ";
                    sql += " left join " + usr + ".dmbs i on b.mabs=i.ma ";//Thuy 24.05.2012
                    sql += " where a.maql=" + l_maql;
                }
            }
            else if (loaiba == 4)
            {
                sql = "select a.mabn,c.hoten,c.namsinh,c.phai,c.sonha,c.thon,a.mavaovien,a.maql,0 as id,a.giuong,";
                sql += "to_char(a.ngay,'dd/mm/yyyy hh24:mi') as ngayvao,";
                sql += "case when a.ngayrv is null then to_char(now(),'dd/mm/yyyy hh24:mi') else to_char(a.ngayrv,'dd/mm/yyyy hh24:mi') end as ngayra,";
                sql += "a.makp,h.tenkp,";
                sql += "case when a.chandoanrv is null then a.chandoan else a.chandoanrv end as chandoan,case when a.maicdrv is null then a.maicd else a.maicdrv end as maicd,";
                sql += "e.tentt,f.tenquan,g.tenpxa,a.ketqua,a.ttlucrv,a.soluutru,a.madoituong,a.mavaovien,a.mabs,i.hoten as tenbs,c.cholam ";
                sql += "from xxx.benhancc a inner join " + usr + ".btdbn c on a.mabn=c.mabn ";
                sql += " inner join " + usr + ".btdtt e on c.matt=e.matt ";
                sql += " inner join " + usr + ".btdquan f on c.maqu=f.maqu ";
                sql += " inner join " + usr + ".btdpxa g on c.maphuongxa=g.maphuongxa ";
                sql += " inner join " + usr + ".btdkp_bv h on a.makp=h.makp ";
                sql += " left join " + usr + ".dmbs i on a.mabs=i.ma ";//Thuy 24.05.2012
                sql += " where a.maql=" + l_maql;
            }
            else
            {
                sql = "select a.mabn,c.hoten,c.namsinh,c.phai,c.sonha,c.thon,a.mavaovien,a.maql,0 as id,' ' as giuong,";
                sql += "to_char(a.ngay,'dd/mm/yyyy hh24:mi') as ngayvao,";
                sql += "case when a.ngayrv is null then to_char(now(),'dd/mm/yyyy hh24:mi') else to_char(a.ngayrv,'dd/mm/yyyy hh24:mi') end as ngayra,";
                sql += "a.makp,h.tenkp,";
                sql += "case when a.chandoanrv is null then a.chandoan else a.chandoanrv end as chandoan,case when a.maicdrv is null then a.maicd else a.maicdrv end as maicd,";
                sql += "e.tentt,f.tenquan,g.tenpxa,a.ketqua,a.ttlucrv,a.soluutru,a.madoituong,a.mavaovien,a.mabs,i.hoten as tenbs,c.cholam ";
                sql += "from " + usr + ".benhanngtr a inner join " + usr + ".btdbn c on a.mabn=c.mabn ";
                sql += " inner join " + usr + ".btdtt e on c.matt=e.matt ";
                sql += " inner join " + usr + ".btdquan f on c.maqu=f.maqu ";
                sql += " inner join " + usr + ".btdpxa g on c.maphuongxa=g.maphuongxa ";
                sql += " inner join " + usr + ".btdkp_bv h on a.makp=h.makp ";
                sql += "left join " + usr + ".dmbs i on a.mabs=i.ma ";//Thuy 24.05.2012
                sql += " where a.maql=" + l_maql;
            }
            string _chandoan = "", _maicd = "";
            int traituyen = 0;

            foreach (DataRow r in (loaiba == 4) ? get_data_mmyy(sql, ngayvv, ngayrv, false).Tables[0].Rows : get_data(sql).Tables[0].Rows)
            {
                traituyen = 0;
                if (loaiba == 1) s_vao = get_ngay_Capcuu_noitru(r["ngayvao"].ToString(), l_maql, loaiba);
                else s_vao = r["ngayvao"].ToString();
                s_ra = r["ngayra"].ToString();
                s_tenkp = r["tenkp"].ToString();
                mabn = r["mabn"].ToString();
                mavaovien = decimal.Parse(r["mavaovien"].ToString());
                _chandoan = r["chandoan"].ToString().Trim() + ";";
                _maicd = r["maicd"].ToString().Trim() + ";";
                string s_usr = usr + s_vao.Substring(3, 2) + s_vao.Substring(8, 2);
                s_usr = (loaiba == 3 || loaiba == 4) ? s_usr : usr;
                foreach (DataRow r1 in get_data("select a.sothe,to_char(a.denngay,'dd/mm/yyyy') as denngay,b.tenbv,a.traituyen, a.mabv, to_char(a.tungay,'dd/mm/yyyy') as tungay from " + s_usr + ".bhyt a left join " + usr + ".dmnoicapbhyt b on a.mabv=b.mabv where a.maql=" + l_maql).Tables[0].Rows)
                {
                    s_sothe = r1["sothe"].ToString(); s_denngay = r1["tungay"].ToString() + "^" + r1["denngay"].ToString();
                    s_tenbv = r1["tenbv"].ToString() + "^" + r1["mabv"].ToString(); traituyen = int.Parse(r1["traituyen"].ToString());
                    break;
                }
                DataSet ads1 = get_cdkemtheo(mavaovien.ToString(), ngayvv, ngayrv);
                foreach (DataRow r1 in ads1.Tables[0].Rows)
                {
                    if (_maicd.IndexOf(r1["maicd"].ToString().Trim() + ";") == -1)
                    {
                        _chandoan += r1["chandoan"].ToString().Trim() + ";";
                        _maicd += r1["maicd"].ToString().Trim() + ";";
                    }
                }
                i_madoituong = int.Parse(r["madoituong"].ToString());
                updrec_ravien(dsngay, r["mabn"].ToString(), decimal.Parse(r["mavaovien"].ToString()), l_maql, decimal.Parse(r["id"].ToString()),
                    r["hoten"].ToString(), r["namsinh"].ToString(), (r["phai"].ToString() == "0") ? "Nam" : "Nữ", r["sonha"].ToString().Trim() + " " + r["thon"].ToString().Trim() + ", " + r["tenpxa"].ToString().Trim() + ", " + r["tenquan"].ToString().Trim() + ", " + r["tentt"].ToString().Trim(),
                    int.Parse(r["madoituong"].ToString()), "", s_sothe, s_denngay, get_noigioithieu(l_maql), s_tenbv, r["giuong"].ToString(),
                    r["makp"].ToString(), r["tenkp"].ToString(), s_vao, s_ra, _chandoan, _maicd, get_nguoinha(r["mabn"].ToString(), l_maql),
                    2, phuongphapdieutri(r["makp"].ToString()), ketquadieutri(int.Parse(r["ketqua"].ToString()),
                    int.Parse(r["ttlucrv"].ToString())), r["soluutru"].ToString(), r["mabs"].ToString(),
                    r["tenbs"].ToString(), r["cholam"].ToString(), traituyen);
            }//linh 06062012
            if (this.bPhonggiuong && i_madoituong==1)
            {
                string _tungay = "", _denngay = "";
                string[] s_ngaysudungthe = s_denngay.Split('^');
                _tungay = s_ngaysudungthe[0];
                _denngay = s_ngaysudungthe[1];
                sql = "select a.id,a.ma,a.ten,a.dvt,b.stt as sttloai,b.ten as loai,c.stt as sttnhom,c.ten as nhom,a.bhyt";
                sql += ",a.gia_th,a.gia_bh,a.gia_cs,a.gia_dv,a.gia_nn,a.vattu_th,a.vattu_bh,a.vattu_cs,a.vattu_dv,a.vattu_nn,a.chenhlech,a.kythuat,c.ma as manhomvp ";
                sql += ", a.kcct, a.bhyt_tt, a.sothe ";
                sql += " from " + userid + ".v_giavp a," + userid + ".v_loaivp b," + userid + ".v_nhomvp c";
                sql += " where a.id_loai=b.id and b.id_nhom=c.ma";
                DataTable dtvp = get_data(sql).Tables[0];
                this.TongHopTienGiuong(mabn, mavaovien, l_maql, i_madoituong, s_vao, s_vao, s_ra, _tungay, _denngay, dtvp, bThanhtoan_ndot, loaiba);
            }
            if (s_vao != "" && s_ra != "") d.upd_laitienthuoc(mabn, l_maql, s_vao, s_ra, true);
            string s = get_doituong(mabn, l_maql, 0, s_vao, s_ra, "", dtkp, 0, bCapcuu_noitru, loaiba, (bChiphikp_noingoai) ? mavaovien : 0);
            if (s.Trim().Length > 1)
            {
                maso += get_maql_Capcuu_noitru(s_vao, mavaovien);
                maso += get_maql_Capve_noitru(s_vao, mavaovien);
                if (bBHYTngtr_noitru || bChiphikp_noingoai) maso += get_maql_ngoaitru(s_vao, ngayrv, mavaovien);//chuyen chi phi ngoai tru vao noi tru
                maso += mavaovien+",";

                sql = "select * from " + usr + ".d_doituong where madoituong in (" + s.Substring(0, s.Length - 1) + ")";
                foreach (DataRow r in get_data(sql).Tables[0].Rows)
                {
                    #region updrec
                    dr = ds.Tables[0].NewRow();
                    dr["madoituongvao"] = i_madoituong;
                    dr["mabn"] = dsngay.Tables[0].Rows[0]["mabn"].ToString();
                    dr["hoten"] = dsngay.Tables[0].Rows[0]["hoten"].ToString();
                    dr["namsinh"] = dsngay.Tables[0].Rows[0]["namsinh"].ToString();
                    dr["ngayvao"] = dsngay.Tables[0].Rows[0]["ngayvao"].ToString();
                    dr["ngayra"] = dsngay.Tables[0].Rows[0]["ngayra"].ToString();
                    dr["madoituong"] = r["madoituong"].ToString();
                    dr["doituong"] = r["doituong"].ToString();
                    dr["sothe"] = dsngay.Tables[0].Rows[0]["sothe"].ToString();
                    dr["maphu"] = 0;
                    dr["makp"] = dsngay.Tables[0].Rows[0]["makp"].ToString();
                    dr["tenkp"] = dsngay.Tables[0].Rows[0]["tenkp"].ToString();
                    dr["mavaovien"] = dsngay.Tables[0].Rows[0]["mavaovien"].ToString();
                    dr["maql"] = l_maql;
                    dr["idkhoa"] = l_idkhoa;
                    dr["phai"] = dsngay.Tables[0].Rows[0]["phai"].ToString();
                    dr["diachi"] = dsngay.Tables[0].Rows[0]["diachi"].ToString();
                    dr["denngay"] = dsngay.Tables[0].Rows[0]["denngay"].ToString();
                    dr["noigioithieu"] = dsngay.Tables[0].Rows[0]["noigioithieu"].ToString();
                    dr["noicap"] = dsngay.Tables[0].Rows[0]["noicap"].ToString();
                    dr["giuong"] = dsngay.Tables[0].Rows[0]["giuong"].ToString();
                    dr["chandoan"] = dsngay.Tables[0].Rows[0]["chandoan"].ToString();
                    dr["maicd"] = dsngay.Tables[0].Rows[0]["maicd"].ToString();
                    dr["nguoinha"] = dsngay.Tables[0].Rows[0]["nguoinha"].ToString();
                    dr["hinhthuc"] = dsngay.Tables[0].Rows[0]["hinhthuc"].ToString();
                    dr["phuongphap"] = dsngay.Tables[0].Rows[0]["phuongphap"].ToString();
                    dr["ketqua"] = dsngay.Tables[0].Rows[0]["ketqua"].ToString();
                    dr["soluutru"] = dsngay.Tables[0].Rows[0]["soluutru"].ToString();
                    dr["done"] = 0;
                    dr["chon"] = true;
                    dr["maso"] = maso;
                    dr["cholam"] = dsngay.Tables[0].Rows[0]["cholam"].ToString();
                    dr["traituyen"] = int.Parse(dsngay.Tables[0].Rows[0]["traituyen"].ToString());
                    ds.Tables[0].Rows.Add(dr);
                    #endregion
                }
                string s_inkem = Thongso("ttrv_inkem");
                string s_tenbd = (bTTRV_Intenhoatchat_Truoc) ? "case when trim(a.tenhc)!=trim(a.ten) then trim(a.tenhc||' ['||a.ten||']') else trim(a.ten) end" : "case when trim(a.tenhc)!=trim(a.ten) then trim(a.ten||' ['||a.tenhc||']') else trim(a.ten) end ";
                string s_hangnuoc = (s_inkem == "1" || s_inkem == "") ? "||' ['||trim(b.ten)||']'" : (s_inkem == "2") ? "||' ['||trim(e.ten)||']'" : (s_inkem == "3") ? "||' ['||case when b.ten=e.ten then trim(b.ten) else trim(b.ten||', '||e.ten) end||']'" : "";
                sql = "select a.id,a.ma," + s_tenbd + "||' '||trim(a.hamluong)" + s_hangnuoc + " as ten,";
                sql += "a.dang as dvt,c.stt as sttloai,c.ten as loai,d.stt as sttnhom,d.ten as nhom,a.bhyt,a.gia_bh,a.kythuat,d.ma as manhomvp";
                if (bChenhlech_thuoc_dannhmuc) sql += ",a.chenhlech ";
                sql += ", a.kcct, a.bhyt as bhyt_tt, a.sothe ";
                sql += " from " + usr + ".d_dmbd a," + usr + ".d_dmhang b," + usr + ".d_dmnhom c," + usr + ".v_nhomvp d, " + usr + ".d_dmnuoc e ";
                sql += " where a.mahang=b.id and a.manhom=c.id and c.nhomvp=d.ma and a.manuoc=e.id(+) ";
                DataTable dtbd = get_data(sql).Tables[0];
                sql = "select a.id,a.ma,a.ten,a.dvt,b.stt as sttloai,b.ten as loai,c.stt as sttnhom,c.ten as nhom,a.bhyt";
                sql += ",a.gia_th,a.gia_bh,a.gia_cs,a.gia_dv,a.gia_nn,a.vattu_th,a.vattu_bh,a.vattu_cs,a.vattu_dv,a.vattu_nn,a.chenhlech,a.kythuat,c.ma as manhomvp ";
                sql += ", a.kcct, a.bhyt_tt, a.sothe ";
                sql += " from " + usr + ".v_giavp a," + usr + ".v_loaivp b," + usr + ".v_nhomvp c";
                sql += " where a.id_loai=b.id and b.id_nhom=c.ma";
                DataTable dtvp = get_data(sql).Tables[0];
                dsxml = get_ttravien_ct(dsxml, ds.Tables[0].Select("chon=true"), dsss.Tables[0].Select("chon=true"), dtkp, dtbd, dtvp, "", bCapcuu_noitru, loaiba, bKhoa, tenuser, usrid, false);
                if (loaiba == 1)
                {
                    decimal tc = 0;
                    foreach (DataRow r in dsxml.Tables[0].Rows) tc += decimal.Parse(r["sotien"].ToString());
                    d.execute_data("update " + usr + ".xuatvien set sotien=" + tc + " where maql=" + l_maql);
                }
            }
            return dsxml;
        }


        public string get_tenkp(string makp)
        {
            ds = get_data("select tenkp from " + user + ".btdkp_bv where makp='" + makp + "'");
            if (ds.Tables[0].Rows.Count > 0) return ds.Tables[0].Rows[0]["tenkp"].ToString();
            else return "";
        }

        public bool get_capso(string makp)
        {
            return get_data("select * from " + user + ".btdkp_bv where capso>0 and makp='" + makp + "'").Tables[0].Rows.Count > 0;
        }

        public bool upd_ttmat(string m_ngay, decimal m_maql, string m_mp, string m_mt, string m_nhanapp, string m_nhanapt)
        {
            sql = "update " + user + mmyy(m_ngay) + ".ttmat set mp=:m_mp,mt=:m_mt,nhanapp=:m_nhanapp,nhanapt=:m_nhanapt";
            sql += " where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mp", NpgsqlDbType.Varchar, 10).Value = m_mp;
                cmd.Parameters.Add("m_mt", NpgsqlDbType.Varchar, 10).Value = m_mt;
                cmd.Parameters.Add("m_nhanapp", NpgsqlDbType.Varchar, 10).Value = m_nhanapp;
                cmd.Parameters.Add("m_nhanapt", NpgsqlDbType.Varchar, 10).Value = m_nhanapt;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + mmyy(m_ngay) + ".ttmat(maql,mp,mt,nhanapp,nhanapt) values (:m_maql,:m_mp,:m_mt,:m_nhanapp,:m_nhanapt)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_mp", NpgsqlDbType.Varchar, 10).Value = m_mp;
                    cmd.Parameters.Add("m_mt", NpgsqlDbType.Varchar, 10).Value = m_mt;
                    cmd.Parameters.Add("m_nhanapp", NpgsqlDbType.Varchar, 10).Value = m_nhanapp;
                    cmd.Parameters.Add("m_nhanapt", NpgsqlDbType.Varchar, 10).Value = m_nhanapt;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message, sComputer, "ttmat " + m_maql.ToString());
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_ttmat(decimal m_maql, string m_mp, string m_mt, string m_nhanapp, string m_nhanapt)
        {
            sql = "update " + user + ".ttmat set mp=:m_mp,mt=:m_mt,nhanapp=:m_nhanapp,nhanapt=:m_nhanapt";
            sql += " where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mp", NpgsqlDbType.Varchar, 10).Value = m_mp;
                cmd.Parameters.Add("m_mt", NpgsqlDbType.Varchar, 10).Value = m_mt;
                cmd.Parameters.Add("m_nhanapp", NpgsqlDbType.Varchar, 10).Value = m_nhanapp;
                cmd.Parameters.Add("m_nhanapt", NpgsqlDbType.Varchar, 10).Value = m_nhanapt;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".ttmat(maql,mp,mt,nhanapp,nhanapt) values (:m_maql,:m_mp,:m_mt,:m_nhanapp,:m_nhanapt)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_mp", NpgsqlDbType.Varchar, 10).Value = m_mp;
                    cmd.Parameters.Add("m_mt", NpgsqlDbType.Varchar, 10).Value = m_mt;
                    cmd.Parameters.Add("m_nhanapp", NpgsqlDbType.Varchar, 10).Value = m_nhanapp;
                    cmd.Parameters.Add("m_nhanapt", NpgsqlDbType.Varchar, 10).Value = m_nhanapt;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ttmat " + m_maql.ToString());
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public void check_process_Excel()
        {
            Process[] processes = Process.GetProcesses();

            if (processes.Length > 1)
            {
                int i = 0;
                for (int n = 0; n <= processes.Length - 1; n++)
                {
                    if (((Process)processes[n]).ProcessName == "EXCEL")
                    {
                        i++;
                        ((Process)processes[n]).Kill();
                    }
                }
            }
        }

        public bool upd_cls_danhmuc(string m_table, decimal m_id, int m_loai, string m_ten)
        {
            sql = "update " + user + "." + m_table + " set ten=:m_ten,loai=:m_loai where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text, 100).Value = m_ten;
                cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + "." + m_table + " (id,ten,loai) values (:m_id,:m_ten,:m_loai)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text, 100).Value = m_ten;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message.ToString().Trim(), sComputer, m_table);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_cls_loai(int m_id, string m_ten, int m_hinh, int m_nhomvp, int m_ytaphu, int m_thuoc, int m_canquang, int m_gayme, int m_mat, int m_phanung, int m_sa, int m_phim, int m_madia, int m_may, string m_path_access)
        {
            sql = "update " + user + ".cls_loai set ten=:m_ten,hinh=:m_hinh,nhomvp=:m_nhomvp,ytaphu=:m_ytaphu,thuoc=:m_thuoc,canquang=:m_canquang,gayme=:m_gayme,mat=:m_mat,phanung=:m_phanung,sa=:m_sa,phim=:m_phim,madia=:m_madia,may=:m_may,path_access=:m_path_access where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_hinh", NpgsqlDbType.Numeric).Value = m_hinh;
                cmd.Parameters.Add("m_nhomvp", NpgsqlDbType.Numeric).Value = m_nhomvp;
                cmd.Parameters.Add("m_ytaphu", NpgsqlDbType.Numeric).Value = m_ytaphu;
                cmd.Parameters.Add("m_thuoc", NpgsqlDbType.Numeric).Value = m_thuoc;
                cmd.Parameters.Add("m_canquang", NpgsqlDbType.Numeric).Value = m_canquang;
                cmd.Parameters.Add("m_gayme", NpgsqlDbType.Numeric).Value = m_gayme;
                cmd.Parameters.Add("m_mat", NpgsqlDbType.Numeric).Value = m_mat;
                cmd.Parameters.Add("m_phanung", NpgsqlDbType.Numeric).Value = m_phanung;
                cmd.Parameters.Add("m_sa", NpgsqlDbType.Numeric).Value = m_sa;
                cmd.Parameters.Add("m_phim", NpgsqlDbType.Numeric).Value = m_phim;
                cmd.Parameters.Add("m_madia", NpgsqlDbType.Numeric).Value = m_madia;
                cmd.Parameters.Add("m_may", NpgsqlDbType.Numeric).Value = m_may;
                cmd.Parameters.Add("m_path_access", NpgsqlDbType.Text).Value = m_path_access;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".cls_loai (id,ten,hinh,nhomvp,ytaphu,thuoc,canquang,gayme,mat,phanung,sa,phim,madia,may,path_access) values (:m_id,:m_ten,:m_hinh,:m_nhomvp,:m_ytaphu,:m_thuoc,:m_canquang,:m_gayme,:m_mat,:m_phanung,:m_sa,:m_phim,:m_madia,:m_may,:m_path_access)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text, 100).Value = m_ten;
                    cmd.Parameters.Add("m_hinh", NpgsqlDbType.Numeric).Value = m_hinh;
                    cmd.Parameters.Add("m_nhomvp", NpgsqlDbType.Numeric).Value = m_nhomvp;
                    cmd.Parameters.Add("m_ytaphu", NpgsqlDbType.Numeric).Value = m_ytaphu;
                    cmd.Parameters.Add("m_thuoc", NpgsqlDbType.Numeric).Value = m_thuoc;
                    cmd.Parameters.Add("m_canquang", NpgsqlDbType.Numeric).Value = m_canquang;
                    cmd.Parameters.Add("m_gayme", NpgsqlDbType.Numeric).Value = m_gayme;
                    cmd.Parameters.Add("m_mat", NpgsqlDbType.Numeric).Value = m_mat;
                    cmd.Parameters.Add("m_phanung", NpgsqlDbType.Numeric).Value = m_phanung;
                    cmd.Parameters.Add("m_sa", NpgsqlDbType.Numeric).Value = m_sa;
                    cmd.Parameters.Add("m_phim", NpgsqlDbType.Numeric).Value = m_phim;
                    cmd.Parameters.Add("m_madia", NpgsqlDbType.Numeric).Value = m_madia;
                    cmd.Parameters.Add("m_may", NpgsqlDbType.Numeric).Value = m_may;
                    cmd.Parameters.Add("m_path_access", NpgsqlDbType.Text).Value = m_path_access;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message.ToString().Trim(), sComputer, "cls_loai");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_cls_kehoach(string m_mmyy, int m_id, decimal m_so)
        {
            sql = "update " + user + ".cls_kehoach set so=:m_so where mmyy=:m_mmyy and id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_so", NpgsqlDbType.Numeric).Value = m_so;
                cmd.Parameters.Add("m_mmyy", NpgsqlDbType.Varchar, 4).Value = m_mmyy;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".cls_kehoach (mmyy,id,so) values (:m_mmyy,:m_id,:m_so)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mmyy", NpgsqlDbType.Varchar, 4).Value = m_mmyy;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_so", NpgsqlDbType.Numeric).Value = m_so;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message.ToString().Trim(), sComputer, "cls_kehoach");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_cls_hen(string m_ngay, decimal m_id, int m_songay, string m_ghichu, int m_loai, string m_ngaychup, string m_ngaytra)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".cls_hen set songay=:m_songay,ghichu=:m_ghichu,loai=:m_loai ";
            if (m_ngaychup != "") sql += ",ngaychup=to_timestamp(:m_ngaychup,'dd/mm/yyyy hh24:mi')";
            if (m_ngaytra != "") sql += ",ngaytra=to_timestamp(:m_ngaytra,'dd/mm/yyyy hh24:mi')";
            sql += " where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_songay", NpgsqlDbType.Numeric).Value = m_songay;
                cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text, 254).Value = m_ghichu;
                cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                if (m_ngaychup != "") cmd.Parameters.Add("m_ngaychup", NpgsqlDbType.Varchar, 16).Value = m_ngaychup;
                if (m_ngaytra != "") cmd.Parameters.Add("m_ngaytra", NpgsqlDbType.Varchar, 16).Value = m_ngaytra;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".cls_hen (id,songay,ghichu,loai";
                    if (m_ngaychup != "") sql += ",ngaychup";
                    if (m_ngaytra != "") sql += ",ngaytra";
                    sql += ") values (:m_id,:m_songay,:m_ghichu,:m_loai";
                    if (m_ngaychup != "") sql += ",to_timestamp(:m_ngaychup,'dd/mm/yyyy hh24:mi')";
                    if (m_ngaytra != "") sql += ",to_timestamp(:m_ngaytra,'dd/mm/yyyy hh24:mi')";
                    sql += ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_songay", NpgsqlDbType.Numeric).Value = m_songay;
                    cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text, 254).Value = m_ghichu;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                    if (m_ngaychup != "") cmd.Parameters.Add("m_ngaychup", NpgsqlDbType.Varchar, 16).Value = m_ngaychup;
                    if (m_ngaytra != "") cmd.Parameters.Add("m_ngaytra", NpgsqlDbType.Varchar, 16).Value = m_ngaytra;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message.ToString().Trim(), sComputer, "cls_hen");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_cls_hinh(string m_ngay, decimal m_id, int m_stt, string m_hinh)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".cls_hinh set stt=:m_stt,hinh=:m_hinh where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                cmd.Parameters.Add("m_hinh", NpgsqlDbType.Varchar, 254).Value = m_hinh;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".cls_hinh (id,stt,hinh) values (:m_id,:m_stt,:m_hinh)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_hinh", NpgsqlDbType.Varchar, 254).Value = m_hinh;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message.ToString().Trim(), sComputer, "cls_hinh");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_cls_mota(decimal m_id, string m_noidung)
        {
            sql = "update " + user + ".cls_mota set noidung=:m_noidung where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_noidung", NpgsqlDbType.Text, 2000).Value = m_noidung;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".cls_mota (id,noidung) values (:m_id,:m_noidung)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_noidung", NpgsqlDbType.Text, 2000).Value = m_noidung;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message.ToString().Trim(), sComputer, "cls_mota");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_cls_motact_cd(string m_ngay, decimal m_id, int m_gayme, int m_phanung, int m_sa)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".cls_motact set gayme=:m_gayme,phanung=:m_phanung,sa=:m_sa where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_gayme", NpgsqlDbType.Numeric).Value = m_gayme;
                cmd.Parameters.Add("m_phanung", NpgsqlDbType.Numeric).Value = m_phanung;
                cmd.Parameters.Add("m_sa", NpgsqlDbType.Numeric).Value = m_sa;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".cls_motact (id,gayme,phanung,sa) values (:m_id,:m_gayme,:m_phanung,:m_sa)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_gayme", NpgsqlDbType.Numeric).Value = m_gayme;
                    cmd.Parameters.Add("m_phanung", NpgsqlDbType.Numeric).Value = m_phanung;
                    cmd.Parameters.Add("m_sa", NpgsqlDbType.Numeric).Value = m_sa;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message.ToString().Trim(), sComputer, "cls_motact");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_cls_motact(string m_ngay, decimal m_id, int m_canquang, int m_gayme, int m_phanung, int m_sa)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".cls_motact set canquang=:m_canquang,gayme=:m_gayme,phanung=:m_phanung,sa=:m_sa where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_canquang", NpgsqlDbType.Numeric).Value = m_canquang;
                cmd.Parameters.Add("m_gayme", NpgsqlDbType.Numeric).Value = m_gayme;
                cmd.Parameters.Add("m_phanung", NpgsqlDbType.Numeric).Value = m_phanung;
                cmd.Parameters.Add("m_sa", NpgsqlDbType.Numeric).Value = m_sa;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".cls_motact (id,canquang,gayme,phanung,sa) values (:m_id,:m_canquang,:m_gayme,:m_phanung,:m_sa)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_canquang", NpgsqlDbType.Numeric).Value = m_canquang;
                    cmd.Parameters.Add("m_gayme", NpgsqlDbType.Numeric).Value = m_gayme;
                    cmd.Parameters.Add("m_phanung", NpgsqlDbType.Numeric).Value = m_phanung;
                    cmd.Parameters.Add("m_sa", NpgsqlDbType.Numeric).Value = m_sa;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message.ToString().Trim(), sComputer, "cls_motact");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_cls_noidung(decimal m_id, int m_loai, string m_ma, string m_ten)
        {
            sql = "update " + user + ".cls_noidung set loai=:m_loai,ma=:m_ma,ten=:m_ten where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 10).Value = m_ma;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text, 254).Value = m_ten;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".cls_noidung (id,loai,ma,ten) values (:m_id,:m_loai,:m_ma,:m_ten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 10).Value = m_ma;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text, 254).Value = m_ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message.ToString().Trim(), sComputer, "cls_noidung");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_cls_thuchien(decimal m_id, string m_mabn, decimal m_mavaovien, decimal m_maql, string m_makp, string m_ngay, int m_loai,
            string m_bscd, string m_bsth, string m_maicd, string m_chandoan, int m_loaibn, int m_kham, int m_madoituong,
            string m_ma, string m_ten, int m_ketqua, int m_denghi, string m_ghichu, int m_userid, string m_ytaphu)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".cls_thuchien set mabn=:m_mabn,mavaovien=:m_mavaovien,maql=:m_maql,makp=:m_makp,ngay=:m_ngay,loai=:m_loai,";
            sql += "bscd=:m_bscd,bsth=:m_bsth,maicd=:m_maicd,chandoan=:m_chandoan,loaibn=:m_loaibn,";
            sql += "kham=:m_kham,madoituong=:m_madoituong,ma=:m_ma,ten=:m_ten,ketqua=:m_ketqua,denghi=:m_denghi,";
            sql += "ghichu=:m_ghichu,userid=:m_userid,ytaphu=:m_ytaphu where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                cmd.Parameters.Add("m_bscd", NpgsqlDbType.Varchar, 4).Value = m_bscd;
                cmd.Parameters.Add("m_bsth", NpgsqlDbType.Varchar, 4).Value = m_bsth;
                cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text, 254).Value = m_chandoan;
                cmd.Parameters.Add("m_loaibn", NpgsqlDbType.Numeric).Value = m_loaibn;
                cmd.Parameters.Add("m_kham", NpgsqlDbType.Numeric).Value = m_kham;
                cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 10).Value = m_ma;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text, 2000).Value = m_ten;
                cmd.Parameters.Add("m_ketqua", NpgsqlDbType.Numeric).Value = m_ketqua;
                cmd.Parameters.Add("m_denghi", NpgsqlDbType.Numeric).Value = m_denghi;
                cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text, 500).Value = m_ghichu;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_ytaphu", NpgsqlDbType.Varchar, 4).Value = m_ytaphu;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".cls_thuchien (id,mabn,mavaovien,maql,makp,ngay,loai,bscd,bsth,maicd,chandoan,loaibn,kham,madoituong,ma,ten,ketqua,denghi,ghichu,userid,ytaphu) values (:m_id,:m_mabn,:m_mavaovien,:m_maql,:m_makp,:m_ngay,:m_loai,:m_bscd,:m_bsth,:m_maicd,:m_chandoan,:m_loaibn,:m_kham,:m_madoituong,:m_ma,:m_ten,:m_ketqua,:m_denghi,:m_ghichu,:m_userid,:m_ytaphu)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                    cmd.Parameters.Add("m_bscd", NpgsqlDbType.Varchar, 4).Value = m_bscd;
                    cmd.Parameters.Add("m_bsth", NpgsqlDbType.Varchar, 4).Value = m_bsth;
                    cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                    cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text, 254).Value = m_chandoan;
                    cmd.Parameters.Add("m_loaibn", NpgsqlDbType.Numeric).Value = m_loaibn;
                    cmd.Parameters.Add("m_kham", NpgsqlDbType.Numeric).Value = m_kham;
                    cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 10).Value = m_ma;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text, 2000).Value = m_ten;
                    cmd.Parameters.Add("m_ketqua", NpgsqlDbType.Numeric).Value = m_ketqua;
                    cmd.Parameters.Add("m_denghi", NpgsqlDbType.Numeric).Value = m_denghi;
                    cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text, 500).Value = m_ghichu;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    cmd.Parameters.Add("m_ytaphu", NpgsqlDbType.Varchar, 4).Value = m_ytaphu;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message.ToString().Trim(), sComputer, "cls_thuchien");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        /// <summary>
        /// Begin Dong 
        public bool upd_chidinh_cosoden(decimal v_id, string v_mabn, decimal v_mavaovien, decimal v_maql, decimal v_idkhoa, string v_ngay, int v_loai,
            string v_makp, int v_madoituong, int v_mavp, decimal v_soluong, decimal v_dongia, decimal v_vattu, int v_userid,
            int v_tinhtrang, int v_thuchien, decimal v_idchidinh, string v_maicd, string v_chandoan, string v_mabs,
            int v_loaiba, string v_ghichu, string sdataden)
        {
            string xxx = user + mmyy(v_ngay);
            sql = "update " + xxx + ".v_chidinh@" + sdataden + " set mabn=:v_mabn,mavaovien=:v_mavaovien,maql=:v_maql,idkhoa=:v_idkhoa,ngay=to_date('" + v_ngay + "','dd/mm/yyyy hh24:mi'), ";
            sql += "loai=:v_loai,makp=:v_makp,madoituong=:v_madoituong,mavp=:v_mavp,soluong=:v_soluong,dongia=:v_dongia,vattu=:v_vattu,";
            sql += "userid=:v_userid,tinhtrang=:v_tinhtrang,thuchien=:v_thuchien,computer=:v_computer,idchidinh=:v_idchidinh,maicd=:v_maicd,";
            sql += "chandoan=:v_chandoan,mabs=:v_mabs,loaiba=:v_loaiba,ghichu=:v_ghichu";
            sql += " where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
                cmd.Parameters.Add("v_mavaovien", NpgsqlDbType.Numeric).Value = v_mavaovien;
                cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
                cmd.Parameters.Add("v_idkhoa", NpgsqlDbType.Numeric).Value = v_idkhoa;
                //cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 16).Value = v_ngay;
                cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
                cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = v_makp;
                cmd.Parameters.Add("v_madoituong", NpgsqlDbType.Numeric).Value = v_madoituong;
                cmd.Parameters.Add("v_mavp", NpgsqlDbType.Numeric).Value = v_mavp;
                cmd.Parameters.Add("v_soluong", NpgsqlDbType.Numeric).Value = v_soluong;
                cmd.Parameters.Add("v_dongia", NpgsqlDbType.Numeric).Value = v_dongia;
                cmd.Parameters.Add("v_vattu", NpgsqlDbType.Numeric).Value = v_vattu;
                cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                cmd.Parameters.Add("v_tinhtrang", NpgsqlDbType.Numeric).Value = v_tinhtrang;
                cmd.Parameters.Add("v_thuchien", NpgsqlDbType.Numeric).Value = v_thuchien;
                cmd.Parameters.Add("v_computer", NpgsqlDbType.Text).Value = sComputer;
                cmd.Parameters.Add("v_idchidinh", NpgsqlDbType.Numeric).Value = v_idchidinh;
                cmd.Parameters.Add("v_maicd", NpgsqlDbType.Varchar, 9).Value = v_maicd;
                cmd.Parameters.Add("v_chandoan", NpgsqlDbType.Text).Value = v_chandoan;
                cmd.Parameters.Add("v_mabs", NpgsqlDbType.Varchar, 4).Value = v_mabs;
                cmd.Parameters.Add("v_loaiba", NpgsqlDbType.Numeric).Value = v_loaiba;
                cmd.Parameters.Add("v_ghichu", NpgsqlDbType.Text).Value = v_ghichu;
                cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".v_chidinh@" + sdataden + " (id,mabn,mavaovien,maql,idkhoa,ngay,loai,makp,madoituong,mavp,soluong,dongia,vattu,userid,tinhtrang,thuchien,computer,idchidinh,maicd,chandoan,mabs,loaiba,ghichu)";
                    sql += " values (:v_id,:v_mabn,:v_mavaovien,:v_maql,:v_idkhoa,to_date('" + v_ngay + "','dd/mm/yyyy hh24:mi'),:v_loai,:v_makp,:v_madoituong,:v_mavp,:v_soluong,:v_dongia,:v_vattu,:v_userid,:v_tinhtrang,:v_thuchien,:v_computer,:v_idchidinh,:v_maicd,:v_chandoan,:v_mabs,:v_loaiba,:v_ghichu)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
                    cmd.Parameters.Add("v_mavaovien", NpgsqlDbType.Numeric).Value = v_mavaovien;
                    cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
                    cmd.Parameters.Add("v_idkhoa", NpgsqlDbType.Numeric).Value = v_idkhoa;
                    //cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 16).Value = v_ngay;
                    cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
                    cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = v_makp;
                    cmd.Parameters.Add("v_madoituong", NpgsqlDbType.Numeric).Value = v_madoituong;
                    cmd.Parameters.Add("v_mavp", NpgsqlDbType.Numeric).Value = v_mavp;
                    cmd.Parameters.Add("v_soluong", NpgsqlDbType.Numeric).Value = v_soluong;
                    cmd.Parameters.Add("v_dongia", NpgsqlDbType.Numeric).Value = v_dongia;
                    cmd.Parameters.Add("v_vattu", NpgsqlDbType.Numeric).Value = v_vattu;
                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                    cmd.Parameters.Add("v_tinhtrang", NpgsqlDbType.Numeric).Value = v_tinhtrang;
                    cmd.Parameters.Add("v_thuchien", NpgsqlDbType.Numeric).Value = v_thuchien;
                    cmd.Parameters.Add("v_computer", NpgsqlDbType.Text).Value = sComputer;
                    cmd.Parameters.Add("v_idchidinh", NpgsqlDbType.Numeric).Value = v_idchidinh;
                    cmd.Parameters.Add("v_maicd", NpgsqlDbType.Varchar, 9).Value = v_maicd;
                    cmd.Parameters.Add("v_chandoan", NpgsqlDbType.Text).Value = v_chandoan;
                    cmd.Parameters.Add("v_mabs", NpgsqlDbType.Varchar, 4).Value = v_mabs;
                    cmd.Parameters.Add("v_loaiba", NpgsqlDbType.Numeric).Value = v_loaiba;
                    cmd.Parameters.Add("v_ghichu", NpgsqlDbType.Text).Value = v_ghichu;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(v_ngay, ex.Message, sComputer, "v_chidinh@" + sdataden);
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_btdbn_client(string m_mabn, string m_hoten, string m_namsinh, int m_phai, string m_mann, string m_madantoc, string m_sonha, string m_thon, string m_cholam, string m_matt, string m_maqu, string m_maphuongxa, int m_userid, string m_hotenkdau, string m_nam, string m_cmnd, string m_msthue, string s_datacosoden)
        {
            sql = "update " + user + ".btdbn@" + s_datacosoden + " set hoten=:m_hoten,namsinh=:m_namsinh,phai=:m_phai,mann=:m_mann,madantoc=:m_madantoc,sonha=:m_sonha,thon=:m_thon,cholam=:m_cholam,matt=:m_matt,maqu=:m_maqu,maphuongxa=:m_maphuongxa,userid=:m_userid,hotenkdau=:m_hotenkdau,nam=:m_nam,cmnd=:m_cmnd,msthue=:m_msthue  where mabn=:m_mabn";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_hoten", NpgsqlDbType.Text).Value = m_hoten;
                //cmd.Parameters.Add("m_ngaysinh", NpgsqlDbType.Varchar, 10).Value = m_ngaysinh;
                cmd.Parameters.Add("m_namsinh", NpgsqlDbType.Varchar, 4).Value = m_namsinh;
                cmd.Parameters.Add("m_phai", NpgsqlDbType.Numeric).Value = m_phai;
                cmd.Parameters.Add("m_mann", NpgsqlDbType.Varchar, 2).Value = m_mann;
                cmd.Parameters.Add("m_madantoc", NpgsqlDbType.Varchar, 2).Value = m_madantoc;
                cmd.Parameters.Add("m_sonha", NpgsqlDbType.Text).Value = m_sonha;
                cmd.Parameters.Add("m_thon", NpgsqlDbType.Text).Value = m_thon;
                cmd.Parameters.Add("m_cholam", NpgsqlDbType.Text).Value = m_cholam;
                cmd.Parameters.Add("m_matt", NpgsqlDbType.Varchar, 3).Value = m_matt;
                cmd.Parameters.Add("m_maqu", NpgsqlDbType.Varchar, 5).Value = m_maqu;
                cmd.Parameters.Add("m_maphuongxa", NpgsqlDbType.Varchar, 7).Value = m_maphuongxa;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_hotenkdau", NpgsqlDbType.Text).Value = m_hotenkdau;
                cmd.Parameters.Add("m_nam", NpgsqlDbType.Text).Value = m_nam;
                cmd.Parameters.Add("m_cmnd", NpgsqlDbType.Text).Value = m_cmnd;
                cmd.Parameters.Add("m_msthue", NpgsqlDbType.Text).Value = m_msthue;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".btdbn@" + s_datacosoden + " (mabn,hoten,namsinh,phai,mann,madantoc,sonha,thon,cholam,matt,maqu,maphuongxa,userid,hotenkdau,nam,cmnd,msthue) values (:m_mabn,:m_hoten,:m_namsinh,:m_phai,:m_mann,:m_madantoc,:m_sonha,:m_thon,:m_cholam,:m_matt,:m_maqu,:m_maphuongxa,:m_userid,:m_hotenkdau,:m_nam,:m_cmnd,:m_msthue)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_hoten", NpgsqlDbType.Text).Value = m_hoten;
                    //cmd.Parameters.Add("m_ngaysinh", NpgsqlDbType.Varchar, 10).Value = m_ngaysinh;
                    cmd.Parameters.Add("m_namsinh", NpgsqlDbType.Varchar, 4).Value = m_namsinh;
                    cmd.Parameters.Add("m_phai", NpgsqlDbType.Numeric).Value = m_phai;
                    cmd.Parameters.Add("m_mann", NpgsqlDbType.Varchar, 2).Value = m_mann;
                    cmd.Parameters.Add("m_madantoc", NpgsqlDbType.Varchar, 2).Value = m_madantoc;
                    cmd.Parameters.Add("m_sonha", NpgsqlDbType.Text).Value = m_sonha;
                    cmd.Parameters.Add("m_thon", NpgsqlDbType.Text).Value = m_thon;
                    cmd.Parameters.Add("m_cholam", NpgsqlDbType.Text).Value = m_cholam;
                    cmd.Parameters.Add("m_matt", NpgsqlDbType.Varchar, 3).Value = m_matt;
                    cmd.Parameters.Add("m_maqu", NpgsqlDbType.Varchar, 5).Value = m_maqu;
                    cmd.Parameters.Add("m_maphuongxa", NpgsqlDbType.Varchar, 7).Value = m_maphuongxa;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    cmd.Parameters.Add("m_hotenkdau", NpgsqlDbType.Text).Value = m_hotenkdau;
                    cmd.Parameters.Add("m_nam", NpgsqlDbType.Text).Value = m_nam;
                    cmd.Parameters.Add("m_cmnd", NpgsqlDbType.Text).Value = m_cmnd;
                    cmd.Parameters.Add("m_msthue", NpgsqlDbType.Text).Value = m_msthue;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "btdbn");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
                con.Dispose();
            }
            return true;
        }
        public bool upd_tiepdon_client(string m_mabn, decimal m_mavaovien, decimal m_maql, string m_makp, string m_ngay, int m_madoituong, string m_sovaovien, string m_tuoivao, string m_done, int m_bnmoi, int m_noitiepdon, int m_loai, int m_userid, decimal m_idchidinh, string s_datacosoden)
        {
            string xxx = user + mmyy(m_ngay);
            sql = " update " + xxx + ".tiepdon@" + s_datacosoden + " set makp=:m_makp,ngay=to_date('" + m_ngay + "','dd/mm/yyyy hh24:mi'),madoituong=:m_madoituong,sovaovien=:m_sovaovien,tuoivao=:m_tuoivao,done=:m_done,bnmoi=:m_bnmoi,noitiepdon=:m_noitiepdon,loai=:m_loai,userid=:m_userid,idchidinh=:m_idchidinh  where mabn=:m_mabn and mavaovien=:m_mavaovien and maql=:m_maql ";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                //cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                cmd.Parameters.Add("m_sovaovien", NpgsqlDbType.Varchar, 10).Value = m_sovaovien;
                cmd.Parameters.Add("m_tuoivao", NpgsqlDbType.Varchar, 4).Value = m_tuoivao;
                cmd.Parameters.Add("m_done", NpgsqlDbType.Varchar, 1).Value = m_done;
                cmd.Parameters.Add("m_bnmoi", NpgsqlDbType.Numeric).Value = m_bnmoi;
                cmd.Parameters.Add("m_noitiepdon", NpgsqlDbType.Numeric).Value = m_noitiepdon;
                cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_idchidinh", NpgsqlDbType.Numeric).Value = m_idchidinh;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar, i_maxlength_mabn).Value = m_mabn;
                cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".tiepdon@" + s_datacosoden + " (mabn,mavaovien,maql,makp,ngay,madoituong,sovaovien,tuoivao,done,bnmoi,noitiepdon,loai,userid,idchidinh) values (:m_mabn,:m_mavaovien,:m_maql,:m_makp,to_date('" + m_ngay + "','dd/mm/yyyy hh24:mi'),:m_madoituong,:m_sovaovien,:m_tuoivao,:m_done,:m_bnmoi,:m_noitiepdon,:m_loai,:m_userid,:m_idchidinh)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar, i_maxlength_mabn).Value = m_mabn;
                    cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    //cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                    cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                    cmd.Parameters.Add("m_sovaovien", NpgsqlDbType.Varchar, 10).Value = m_sovaovien;
                    cmd.Parameters.Add("m_tuoivao", NpgsqlDbType.Varchar, 4).Value = m_tuoivao;
                    cmd.Parameters.Add("m_done", NpgsqlDbType.Varchar, 1).Value = m_done;
                    cmd.Parameters.Add("m_bnmoi", NpgsqlDbType.Numeric).Value = m_bnmoi;
                    cmd.Parameters.Add("m_noitiepdon", NpgsqlDbType.Numeric).Value = m_noitiepdon;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    cmd.Parameters.Add("m_idchidinh", NpgsqlDbType.Numeric).Value = m_idchidinh;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message, sComputer, "tiepdon");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_benhanpk_client(string m_mabn, decimal m_mavaovien, decimal m_maql, string m_makp, string m_ngay, int m_dentu, int m_nhantu, int m_madoituong, string m_chandoan, string m_maicd, int m_ttlucrv, string m_mabs, string m_sovaovien, int m_bienchung, int m_taibien, int m_giaiphau, decimal m_mangtr, int m_userid, string s_datacosoden)
        {
            string xxx = user + mmyy(m_ngay);
            sql = " update " + xxx + ".benhanpk@" + s_datacosoden + " set makp=:m_makp,ngay=to_date('" + m_ngay + "','dd/mm/yyyy hh24:mi'),dentu=:m_dentu,nhantu=:m_nhantu,madoituong=:m_madoituong,chandoan=:m_chandoan,maicd=:m_maicd,ttlucrv=:m_ttlucrv,mabs=:m_mabs,sovaovien=:m_sovaovien,taibien=:m_taibien,giaiphau=:m_giaiphau,mangtr=:m_mangtr,userid=:m_userid where mabn=:m_mabn and maql=:m_maql and mavaovien=:m_mavaovien ";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                //cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                cmd.Parameters.Add("m_dentu", NpgsqlDbType.Numeric).Value = m_dentu;
                cmd.Parameters.Add("m_nhantu", NpgsqlDbType.Numeric).Value = m_nhantu;
                cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                cmd.Parameters.Add("m_ttlucrv", NpgsqlDbType.Numeric).Value = m_ttlucrv;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_sovaovien", NpgsqlDbType.Varchar, 10).Value = m_sovaovien;
                cmd.Parameters.Add("m_bienchung", NpgsqlDbType.Numeric).Value = m_bienchung;
                cmd.Parameters.Add("m_taibien", NpgsqlDbType.Numeric).Value = m_taibien;
                cmd.Parameters.Add("m_giaiphau", NpgsqlDbType.Numeric).Value = m_giaiphau;
                cmd.Parameters.Add("m_mangtr", NpgsqlDbType.Numeric).Value = m_mangtr;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;

                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = " insert into " + xxx + ".benhanpk@" + s_datacosoden + " (mabn,mavaovien,maql,makp,ngay,dentu,nhantu,madoituong,chandoan,maicd,ttlucrv,mabs,sovaovien,bienchung,taibien,giaiphau,mangtr,userid) values(:m_mabn,:m_mavaovien,:m_maql,:m_makp,to_date('" + m_ngay + "','dd/mm/yyyy hh24:mi'),:m_dentu,:m_nhantu,:m_madoituong,:m_chandoan,:m_maicd,:m_ttlucrv,:m_mabs,:m_sovaovien,:m_bienchung,:m_taibien,:m_giaiphau,:m_mangtr,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    //cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                    cmd.Parameters.Add("m_dentu", NpgsqlDbType.Numeric).Value = m_dentu;
                    cmd.Parameters.Add("m_nhantu", NpgsqlDbType.Numeric).Value = m_nhantu;
                    cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                    cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                    cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                    cmd.Parameters.Add("m_ttlucrv", NpgsqlDbType.Numeric).Value = m_ttlucrv;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    cmd.Parameters.Add("m_sovaovien", NpgsqlDbType.Varchar, 10).Value = m_sovaovien;
                    cmd.Parameters.Add("m_bienchung", NpgsqlDbType.Numeric).Value = m_bienchung;
                    cmd.Parameters.Add("m_taibien", NpgsqlDbType.Numeric).Value = m_taibien;
                    cmd.Parameters.Add("m_giaiphau", NpgsqlDbType.Numeric).Value = m_giaiphau;
                    cmd.Parameters.Add("m_mangtr", NpgsqlDbType.Numeric).Value = m_mangtr;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message, sComputer, "benhanpk");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
            return true;
        }
        /// </summary> End Dong
        /// <param name="m_ngay"></param>
        /// <param name="m_id"></param>
        /// <param name="m_mp"></param>
        /// <param name="m_mt"></param>
        /// <returns></returns>

        public bool upd_cls_mat(string m_ngay, decimal m_id, int m_mp, int m_mt)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".cls_mat set mp=:m_mp,mt=:m_mt where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mp", NpgsqlDbType.Numeric).Value = m_mp;
                cmd.Parameters.Add("m_mt", NpgsqlDbType.Numeric).Value = m_mt;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".cls_mat (id,mp,mt) values (:m_id,:m_mp,:m_mt)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_mp", NpgsqlDbType.Numeric).Value = m_mp;
                    cmd.Parameters.Add("m_mt", NpgsqlDbType.Numeric).Value = m_mt;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message.ToString().Trim(), sComputer, "cls_mat");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_cls_sdthuoc(string m_ngay, decimal m_id, int m_thuoc, decimal m_soluong)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".cls_sdthuoc set thuoc=:m_thuoc,soluong=:m_soluong where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_thuoc", NpgsqlDbType.Numeric).Value = m_thuoc;
                cmd.Parameters.Add("m_soluong", NpgsqlDbType.Numeric).Value = m_soluong;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".cls_sdthuoc (id,thuoc,soluong) values (:m_id,:m_thuoc,:m_soluong)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_thuoc", NpgsqlDbType.Numeric).Value = m_thuoc;
                    cmd.Parameters.Add("m_soluong", NpgsqlDbType.Numeric).Value = m_soluong;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message.ToString().Trim(), sComputer, "cls_sdthuoc");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        //public decimal get_tamung(string mabn, decimal maql, string tu, string den, string makp, int madoituong)
        //{
        //    DateTime dt1 = StringToDate(tu);
        //    DateTime dt2 = StringToDate(den);
        //    int y1 = dt1.Year, m1 = dt1.Month;
        //    int y2 = dt2.Year, m2 = dt2.Month;
        //    int itu, iden;
        //    decimal st = 0;
        //    DataTable dt;
        //    decimal maql_phongluu = 0;
        //    if (bCapcuu_noitru) maql_phongluu = get_maql_phongluu(tu, maql);
        //    string sql, d_mmyy = "", usr = user, xxx, stime = "'" + f_ngay + "'", s = "";
        //    for (int i = y1; i <= y2; i++)
        //    {
        //        itu = (i == y1) ? m1 : 1;
        //        iden = (i == y2) ? m2 : 12;
        //        for (int j = itu; j <= iden; j++)
        //        {
        //            d_mmyy = j.ToString().PadLeft(2, '0') + i.ToString().Substring(2, 2);
        //            if (bMmyy(d_mmyy))
        //            {
        //                xxx = usr + d_mmyy;
        //                sql = "select sum(sotien) as sotien,quyenso,sobienlai from " + xxx + ".v_tamung where maql=" + maql;
        //                if (makp != "") sql += " and makp='" + makp + "'";
        //                if (madoituong != 0) sql += " and madoituong=" + madoituong;
        //                sql += " group by quyenso,sobienlai";
        //                dt = get_data(sql).Tables[0];
        //                foreach (DataRow r in dt.Rows)
        //                {
        //                    s += r["quyenso"].ToString().Trim() + "-" + r["sobienlai"].ToString().Trim() + ";";
        //                    st += decimal.Parse(r["sotien"].ToString());
        //                }
        //                if (maql_phongluu != 0)
        //                {
        //                    sql = "select sum(sotien) as sotien,quyenso,sobienlai from " + xxx + ".v_tamung where maql=" + maql_phongluu;
        //                    if (madoituong != 0) sql += " and madoituong=" + madoituong;
        //                    sql += " group by quyenso,sobienlai";
        //                    dt = get_data(sql).Tables[0];
        //                    foreach (DataRow r in dt.Rows)
        //                    {
        //                        s += r["quyenso"].ToString().Trim() + "-" + r["sobienlai"].ToString().Trim() + ";";
        //                        st += decimal.Parse(r["sotien"].ToString());
        //                    }
        //                }
        //            }
        //        }
        //    }
        //    //hoan tra
        //    for (int i = y1; i <= y2; i++)
        //    {
        //        itu = (i == y1) ? m1 : 1;
        //        iden = (i == y2) ? m2 : 12;
        //        for (int j = itu; j <= iden; j++)
        //        {
        //            d_mmyy = j.ToString().PadLeft(2, '0') + i.ToString().Substring(2, 2);
        //            if (bMmyy(d_mmyy))
        //            {
        //                xxx = usr + d_mmyy;
        //                sql = "select sum(a.sotien) as sotien, a.quyenso,a.sobienlai  from " + xxx + ".v_hoantra a, " + user + ".v_quyenso b where a.quyenso=b.id and a.mabn='" + mabn + "'";
        //                sql += " and a.ngay between to_date('" + tu + "'," + stime + ") and to_date('" + den + "'," + stime + ")";
        //                sql += " and a.loaibn=2";
        //                sql += " group by a.quyenso,a.sobienlai";
        //                ds = get_data(sql);
        //                foreach (DataRow r in ds.Tables[0].Rows)
        //                {
        //                    if (s.IndexOf(r["quyenso"].ToString().Trim() + "-" + r["sobienlai"].ToString().Trim() + ";") != -1)
        //                        st -= decimal.Parse(r["sotien"].ToString());
        //                }
        //            }
        //        }
        //    }
        //    return st;
        //}
 public decimal get_tamung(string mabn, decimal maql, string tu, string den, string makp, int madoituong)
        {
            DateTime dt1 = StringToDate(tu);
            DateTime dt2 = StringToDate(den);
            int y1 = dt1.Year, m1 = dt1.Month;
            int y2 = dt2.Year, m2 = dt2.Month;
            int itu, iden;
            decimal st = 0;
            DataTable dt;
            decimal maql_phongluu = 0;
            if (bCapcuu_noitru) maql_phongluu = get_maql_phongluu(tu, maql);
            string sql, d_mmyy = "", usr = user, xxx, stime = "'" + f_ngay + "'", s = "";
            for (int i = y1; i <= y2; i++)
            {
                itu = (i == y1) ? m1 : 1;
                iden = (i == y2) ? m2 : 12;
                for (int j = itu; j <= iden; j++)
                {
                    d_mmyy = j.ToString().PadLeft(2, '0') + i.ToString().Substring(2, 2);
                    if (bMmyy(d_mmyy))
                    {
                        xxx = usr + d_mmyy;
                        sql = "select sum(sotien) as sotien,quyenso,sobienlai from " + xxx + ".v_tamung where mabn='" + mabn + "' and maql=" + maql +" and done =0 ";
                        //if (makp != "") sql += " and makp='" + makp + "'";
                        if (madoituong != 0) sql += " and madoituong=" + madoituong;
                        sql += " group by quyenso,sobienlai";
                        dt = get_data(sql).Tables[0];
                        foreach (DataRow r in dt.Rows)
                        {
                            s += r["quyenso"].ToString().Trim() + "-" + r["sobienlai"].ToString().Trim() + ";";
                            st += decimal.Parse(r["sotien"].ToString());
                        }
                        if (maql_phongluu != 0)
                        {
                            sql = "select sum(sotien) as sotien,quyenso,sobienlai from " + xxx + ".v_tamung where mabn='" + mabn + "' and maql=" + maql_phongluu +" and done=0 ";
                            if (madoituong != 0) sql += " and madoituong=" + madoituong;
                            sql += " group by quyenso,sobienlai";
                            dt = get_data(sql).Tables[0];
                            foreach (DataRow r in dt.Rows)
                            {
                                s += r["quyenso"].ToString().Trim() + "-" + r["sobienlai"].ToString().Trim() + ";";
                                st += decimal.Parse(r["sotien"].ToString());
                            }
                        }
                    }
                }
            }
            //////tru lai tien hoan tra --> binh25042014: bo code nay: do phan tam ung tren da loai bo phan tra: done=0 chi lay phan chua tra
            ////for (int i = y1; i <= y2; i++)
            ////{
            ////    itu = (i == y1) ? m1 : 1;
            ////    iden = (i == y2) ? m2 : 12;
            ////    for (int j = itu; j <= iden; j++)
            ////    {
            ////        d_mmyy = j.ToString().PadLeft(2, '0') + i.ToString().Substring(2, 2);
            ////        if (bMmyy(d_mmyy))
            ////        {
            ////            xxx = usr + d_mmyy;
            ////            sql = "select sum(a.sotien) as sotien, a.quyenso,a.sobienlai  from " + xxx + ".v_hoantra a, " + user + ".v_quyenso b where a.quyenso=b.id and a.mabn='" + mabn + "'";
            ////            sql += " and a.ngay between to_date('" + tu + "'," + stime + ") and to_date('" + den + "'," + stime + ")";
            ////            sql += " and a.loaibn=2";
            ////            sql += " group by a.quyenso,a.sobienlai";
            ////            ds = get_data(sql);
            ////            foreach (DataRow r in ds.Tables[0].Rows)
            ////            {
            ////                if (s.IndexOf(r["quyenso"].ToString().Trim() + "-" + r["sobienlai"].ToString().Trim() + ";") != -1)
            ////                    st -= decimal.Parse(r["sotien"].ToString());
            ////            }
            ////        }
            ////    }
            ////}
            return st;
        }





        public decimal get_vienphi(decimal maql, string tu, string den, string makp, int madoituong, bool bCongno)
        {
            DateTime dt1 = StringToDate(tu);
            DateTime dt2 = StringToDate(den);
            int y1 = dt1.Year, m1 = dt1.Month;
            int y2 = dt2.Year, m2 = dt2.Month;
            int itu, iden;
            decimal st = 0;
            DataTable dt;
            string sql, d_mmyy = "", usr = user, xxx, stime = "'" + f_ngay + "'";
            for (int i = y1; i <= y2; i++)
            {
                itu = (i == y1) ? m1 : 1;
                iden = (i == y2) ? m2 : 12;
                for (int j = itu; j <= iden; j++)
                {
                    d_mmyy = j.ToString().PadLeft(2, '0') + i.ToString().Substring(2, 2);
                    if (bMmyy(d_mmyy))
                    {
                        xxx = usr + d_mmyy;
                        sql = "select sum(a.soluong*a.dongia) as sotien from " + xxx + ".v_vpkhoa a," + usr + ".btdkp_bv b," + usr + ".doituong c where a.makp=b.makp and a.madoituong=c.madoituong";
                        sql += " and a.maql=" + maql;
                        if (bCongno) sql += " and c.mien=0";
                        sql += " and a.ngay between to_date('" + tu + "'," + stime + ") and to_date('" + den + "'," + stime + ")";
                        if (makp != "") sql += " and a.makp='" + makp + "'";
                        if (madoituong != 0) sql += " and a.madoituong=" + madoituong;
                        dt = get_data(sql).Tables[0];
                        if (dt.Rows[0]["sotien"].ToString() != "") st += decimal.Parse(dt.Rows[0]["sotien"].ToString());
                        if (bChidinh_vienphi)
                        {
                            sql = "select sum(a.soluong*a.dongia) as sotien from " + xxx + ".v_chidinh a," + usr + ".btdkp_bv b," + usr + ".doituong c where a.makp=b.makp and a.madoituong=c.madoituong";
                            sql += " and a.maql=" + maql;
                            if (bCongno) sql += " and c.mien=0";
                            sql += " and a.ngay between to_date('" + tu + "'," + stime + ") and to_date('" + den + "'," + stime + ")";
                            if (makp != "") sql += " and a.makp='" + makp + "'";
                            if (madoituong != 0) sql += " and a.madoituong=" + madoituong;
                            dt = get_data(sql).Tables[0];
                            if (dt.Rows[0]["sotien"].ToString() != "") st += decimal.Parse(dt.Rows[0]["sotien"].ToString());
                        }
                    }
                }
            }
            return st;
        }

        public string get_sovaovien(decimal maql)
        {
            ds = get_data("select sovaovien from " + user + ".benhandt where maql=" + maql);
            if (ds.Tables[0].Rows.Count > 0) return ds.Tables[0].Rows[0]["sovaovien"].ToString();
            else return "";
        }

        public bool upd_le_danhmuc(string m_table, decimal m_id, string m_ma, string m_ten)
        {
            sql = "update " + user + "." + m_table + " set ma=:m_ma,ten=:m_ten where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 10).Value = m_ma;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + "." + m_table + " (id,ma,ten) values (:m_id,:m_ma,:m_ten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 10).Value = m_ma;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message.ToString().Trim(), sComputer, m_table);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_le_mat(decimal m_id, int m_mp, int m_mt)
        {
            sql = "update le_mat set mp=:m_mp,mt=:m_mt where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mp", NpgsqlDbType.Numeric).Value = m_mp;
                cmd.Parameters.Add("m_mt", NpgsqlDbType.Numeric).Value = m_mt;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into le_mat (id,mp,mt) values (:m_id,:m_mp,:m_mt)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_mp", NpgsqlDbType.Numeric).Value = m_mp;
                    cmd.Parameters.Add("m_mt", NpgsqlDbType.Numeric).Value = m_mt;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message.ToString().Trim(), sComputer, "le_mat");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_le_thuchien(decimal m_id, string m_mabn, decimal m_maql, string m_makp, string m_ngay,
            int m_loaibn, int m_kham, int m_madoituong, int m_sohoso, string m_mabs, int m_userid)
        {
            sql = "update le_thuchien set mabn=:m_mabn,maql=:m_maql,makp=:m_makp,ngay=:m_ngay,";
            sql += "loaibn=:m_loaibn,kham=:m_kham,madoituong=:m_madoituong,sohoso=:m_sohoso,mabs=:m_mabs,userid=:m_userid where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_loaibn", NpgsqlDbType.Numeric).Value = m_loaibn;
                cmd.Parameters.Add("m_kham", NpgsqlDbType.Numeric).Value = m_kham;
                cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                cmd.Parameters.Add("m_sohoso", NpgsqlDbType.Numeric).Value = m_sohoso;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into le_thuchien (id,mabn,maql,makp,ngay,loaibn,kham,madoituong,sohoso,mabs,userid) values (:m_id,:m_mabn,:m_maql,:m_makp,:m_ngay,:m_loaibn,:m_kham,:m_madoituong,:m_sohoso,:m_mabs,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_loaibn", NpgsqlDbType.Numeric).Value = m_loaibn;
                    cmd.Parameters.Add("m_kham", NpgsqlDbType.Numeric).Value = m_kham;
                    cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                    cmd.Parameters.Add("m_sohoso", NpgsqlDbType.Numeric).Value = m_sohoso;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message.ToString().Trim(), sComputer, "le_thuchien");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_le_hen(decimal m_id, int m_songay, string m_ghichu, int m_loai)
        {
            sql = "update le_hen set songay=:m_songay,ghichu=:m_ghichu,loai=:m_loai where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_songay", NpgsqlDbType.Numeric).Value = m_songay;
                cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text).Value = m_ghichu;
                cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into le_hen (id,songay,ghichu,loai) values (:m_id,:m_songay,:m_ghichu,:m_loai)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_songay", NpgsqlDbType.Numeric).Value = m_songay;
                    cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text).Value = m_ghichu;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message.ToString().Trim(), sComputer, "le_hen");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public decimal get_id_le(string m_mabn, string m_ngaygio, bool gio)
        {
            sql = "select id from le_thuchien where mabn='" + m_mabn + "'";
            if (gio) sql += " and to_char(ngay,'dd/mm/yyyy hh24:mi')='" + m_ngaygio + "'";
            else sql += " and to_char(ngay,'dd/mm/yyyy')='" + m_ngaygio.Substring(0, 10) + "'";
            ds = get_data(sql);
            decimal l_id = (ds.Tables[0].Rows.Count == 0) ? 0 : decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            return l_id;
        }

        public decimal get_id_le(string m_mabn, string m_makp, string m_ngaygio)
        {
            ds = get_data("select id from le_thuchien where mabn='" + m_mabn + "' and makp='" + m_makp + "'" + " and to_char(ngay,'dd/mm/yyyy hh24:mi')='" + m_ngaygio + "'");
            decimal l_id = (ds.Tables[0].Rows.Count == 0) ? 0 : decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            if (l_id == 0) l_id = getidyymmddhhmiss_stt_computer;// get_capid(-7);
            return l_id;
        }

        public bool upd_kx_thoiquen(string m_mabn, string m_thoiquen)
        {
            sql = "update kx_thoiquen set thoiquen=:m_thoiquen where mabn=:m_mabn";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_thoiquen", NpgsqlDbType.Text).Value = m_thoiquen;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into kx_thoiquen (mabn,thoiquen) values (:m_mabn,:m_thoiquen)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_thoiquen", NpgsqlDbType.Text).Value = m_thoiquen;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message.ToString().Trim(), sComputer, "kx_thoiquen");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_kx_hen(decimal m_id, int m_songay, string m_ghichu, int m_loai)
        {
            sql = "update kx_hen set songay=:m_songay,ghichu=:m_ghichu,loai=:m_loai where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_songay", NpgsqlDbType.Numeric).Value = m_songay;
                cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text).Value = m_ghichu;
                cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into kx_hen (id,songay,ghichu,loai) values (:m_id,:m_songay,:m_ghichu,:m_loai)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_songay", NpgsqlDbType.Numeric).Value = m_songay;
                    cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text).Value = m_ghichu;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message.ToString().Trim(), sComputer, "kx_hen");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_kx_dieutri(decimal m_id, string m_mabn, decimal m_maql, string m_ngay,
            int m_loaibn, int m_kham, int m_madoituong, string m_tlxkk_mp, string m_tlxkk_mt, string m_tlkl_mp,
            string m_tlkl_mt, string m_tlg_mp, string m_tlg_mt, string m_dttb_xa, string m_dttb_gan, string m_dtxtm_mp,
            string m_dtxtm_mt, string m_dtgtm_mp, string m_dtgtm_mt, string m_kql1_mp, string m_kql1_mt, string m_kqtll1_mp, string m_kqtll1_mt,
            string m_cql1_mp, string m_cql1_mt, string m_cqtll1_mp, string m_cqtll1_mt, int m_chidinh,
            string m_kql2_mp, string m_kql2_mt, string m_kqtll2_mp, string m_kqtll2_mt, string m_cql2_mp,
            string m_cql2_mt, string m_cqtll2_mp, string m_cqtll2_mt, string m_ct_mp, string m_ct_mt,
            string m_cttl_mp, string m_cttl_mt, string m_dc_mp, string m_dc_mt, string m_dctl_mp, string m_dctl_mt,
            string m_kc_mp, string m_kc_mt, string m_ctk_mp, string m_ctk_mt, int m_xutri, string m_capdon,
            string m_chuyen, string m_loidan, string m_khac, string m_ktv, string m_maicd, string m_chandoan,
            string m_maicdk, string m_chandoank, int m_userid)
        {
            sql = "update kx_dieutri set mabn=:m_mabn,maql=:m_maql,ngay=:m_ngay,";
            sql += "loaibn=:m_loaibn,kham=:m_kham,madoituong=:m_madoituong,";
            sql += "tlxkk_mp=:m_tlxkk_mp,tlxkk_mt=:m_tlxkk_mt,tlkl_mp=:m_tlkl_mp,tlkl_mt=:m_tlkl_mt,";
            sql += "tlg_mp=:m_tlg_mp,tlg_mt=:m_tlg_mt,dttb_xa=:m_dttb_xa,dttb_gan=:m_dttb_gan,";
            sql += "dtxtm_mp=:m_dtxtm_mp,dtxtm_mt=:m_dtxtm_mt,dtgtm_mp=:m_dtgtm_mp,dtgtm_mt=:m_dtgtm_mt,kql1_mp=:m_kql1_mp,kql1_mt=:m_kql1_mt,";
            sql += "kqtll1_mp=:m_kqtll1_mp,kqtll1_mt=:m_kqtll1_mt,cql1_mp=:m_cql1_mp,cql1_mt=:m_cql1_mt,";
            sql += "cqtll1_mp=:m_cqtll1_mp,cqtll1_mt=:m_cqtll1_mt,chidinh=:m_chidinh,kql2_mp=:m_kql2_mp,kql2_mt=:m_kql2_mt,";
            sql += "kqtll2_mp=:m_kqtll2_mp,kqtll2_mt=:m_kqtll2_mt,cql2_mp=:m_cql2_mp,cql2_mt=:m_cql2_mt,cqtll2_mp=:m_cqtll2_mp,cqtll2_mt=:m_cqtll2_mt,";
            sql += "ct_mp=:m_ct_mp,ct_mt=:m_ct_mt,cttl_mp=:m_cttl_mp,cttl_mt=:m_cttl_mt,dc_mp=:m_dc_mp,dc_mt=:m_dc_mt,";
            sql += "dctl_mp=:m_dctl_mp,dctl_mt=:m_dctl_mt,kc_mp=:m_kc_mp,kc_mt=:m_kc_mt,ctk_mp=:m_ctk_mp,ctk_mt=:m_ctk_mt,";
            sql += "xutri=:m_xutri,capdon=:m_capdon,chuyen=:m_chuyen,loidan=:m_loidan,khac=:m_khac,ktv=:m_ktv,";
            sql += "maicd=:m_maicd,chandoan=:m_chandoan,maicdk=:m_maicdk,chandoank=:m_chandoank,";
            sql += "userid=:m_userid where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_loaibn", NpgsqlDbType.Numeric).Value = m_loaibn;
                cmd.Parameters.Add("m_kham", NpgsqlDbType.Numeric).Value = m_kham;
                cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                cmd.Parameters.Add("m_tlxkk_mp", NpgsqlDbType.Varchar, 10).Value = m_tlxkk_mp;
                cmd.Parameters.Add("m_tlxkk_mt", NpgsqlDbType.Varchar, 10).Value = m_tlxkk_mt;
                cmd.Parameters.Add("m_tlkl_mp", NpgsqlDbType.Varchar, 10).Value = m_tlkl_mp;
                cmd.Parameters.Add("m_tlkl_mt", NpgsqlDbType.Varchar, 10).Value = m_tlkl_mt;
                cmd.Parameters.Add("m_tlg_mp", NpgsqlDbType.Varchar, 10).Value = m_tlg_mp;
                cmd.Parameters.Add("m_tlg_mt", NpgsqlDbType.Varchar, 10).Value = m_tlg_mt;
                cmd.Parameters.Add("m_dttb_xa", NpgsqlDbType.Varchar, 10).Value = m_dttb_xa;
                cmd.Parameters.Add("m_dttb_gan", NpgsqlDbType.Varchar, 10).Value = m_dttb_gan;
                cmd.Parameters.Add("m_dtxtm_mp", NpgsqlDbType.Varchar, 10).Value = m_dtxtm_mp;
                cmd.Parameters.Add("m_dtxtm_mt", NpgsqlDbType.Varchar, 10).Value = m_dtxtm_mt;
                cmd.Parameters.Add("m_dtgtm_mp", NpgsqlDbType.Varchar, 10).Value = m_dtgtm_mp;
                cmd.Parameters.Add("m_dtgtm_mt", NpgsqlDbType.Varchar, 10).Value = m_dtgtm_mt;
                cmd.Parameters.Add("m_kql1_mp", NpgsqlDbType.Text).Value = m_kql1_mp;
                cmd.Parameters.Add("m_kql1_mt", NpgsqlDbType.Text).Value = m_kql1_mt;
                cmd.Parameters.Add("m_kqtll1_mp", NpgsqlDbType.Varchar, 10).Value = m_kqtll1_mp;
                cmd.Parameters.Add("m_kqtll1_mt", NpgsqlDbType.Varchar, 10).Value = m_kqtll1_mt;
                cmd.Parameters.Add("m_cql1_mp", NpgsqlDbType.Text).Value = m_cql1_mp;
                cmd.Parameters.Add("m_cql1_mt", NpgsqlDbType.Text).Value = m_cql1_mt;
                cmd.Parameters.Add("m_cqtll1_mp", NpgsqlDbType.Varchar, 10).Value = m_cqtll1_mp;
                cmd.Parameters.Add("m_cqtll1_mt", NpgsqlDbType.Varchar, 10).Value = m_cqtll1_mt;
                cmd.Parameters.Add("m_chidinh", NpgsqlDbType.Numeric).Value = m_chidinh;
                cmd.Parameters.Add("m_kql2_mp", NpgsqlDbType.Text).Value = m_kql2_mp;
                cmd.Parameters.Add("m_kql2_mt", NpgsqlDbType.Text).Value = m_kql2_mt;
                cmd.Parameters.Add("m_kqtll2_mp", NpgsqlDbType.Varchar, 10).Value = m_kqtll2_mp;
                cmd.Parameters.Add("m_kqtll2_mt", NpgsqlDbType.Varchar, 10).Value = m_kqtll2_mt;
                cmd.Parameters.Add("m_cql2_mp", NpgsqlDbType.Text).Value = m_cql2_mp;
                cmd.Parameters.Add("m_cql2_mt", NpgsqlDbType.Text).Value = m_cql2_mt;
                cmd.Parameters.Add("m_cqtll2_mp", NpgsqlDbType.Varchar, 10).Value = m_cqtll2_mp;
                cmd.Parameters.Add("m_cqtll2_mt", NpgsqlDbType.Varchar, 10).Value = m_cqtll2_mt;
                cmd.Parameters.Add("m_ct_mp", NpgsqlDbType.Text).Value = m_ct_mp;
                cmd.Parameters.Add("m_ct_mt", NpgsqlDbType.Text).Value = m_ct_mt;
                cmd.Parameters.Add("m_cttl_mp", NpgsqlDbType.Varchar, 10).Value = m_cttl_mp;
                cmd.Parameters.Add("m_cttl_mt", NpgsqlDbType.Varchar, 10).Value = m_cttl_mt;
                cmd.Parameters.Add("m_dc_mp", NpgsqlDbType.Text).Value = m_dc_mp;
                cmd.Parameters.Add("m_dc_mt", NpgsqlDbType.Text).Value = m_dc_mt;
                cmd.Parameters.Add("m_dctl_mp", NpgsqlDbType.Varchar, 10).Value = m_dctl_mp;
                cmd.Parameters.Add("m_dctl_mt", NpgsqlDbType.Varchar, 10).Value = m_dctl_mt;
                cmd.Parameters.Add("m_kc_mp", NpgsqlDbType.Varchar, 10).Value = m_kc_mp;
                cmd.Parameters.Add("m_kc_mt", NpgsqlDbType.Varchar, 10).Value = m_kc_mt;
                cmd.Parameters.Add("m_ctk_mp", NpgsqlDbType.Text).Value = m_ctk_mp;
                cmd.Parameters.Add("m_ctk_mt", NpgsqlDbType.Text).Value = m_ctk_mt;
                cmd.Parameters.Add("m_xutri", NpgsqlDbType.Numeric).Value = m_xutri;
                cmd.Parameters.Add("m_capdon", NpgsqlDbType.Text).Value = m_capdon;
                cmd.Parameters.Add("m_chuyen", NpgsqlDbType.Text).Value = m_chuyen;
                cmd.Parameters.Add("m_loidan", NpgsqlDbType.Text).Value = m_loidan;
                cmd.Parameters.Add("m_khac", NpgsqlDbType.Text).Value = m_khac;
                cmd.Parameters.Add("m_ktv", NpgsqlDbType.Varchar, 4).Value = m_ktv;
                cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_maicdk", NpgsqlDbType.Varchar, 9).Value = m_maicdk;
                cmd.Parameters.Add("m_chandoank", NpgsqlDbType.Text).Value = m_chandoank;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into kx_dieutri (id,mabn,maql,ngay,loaibn,kham,madoituong,tlxkk_mp,tlxkk_mt,tlkl_mp,tlkl_mt,tlg_mp,tlg_mt,";
                    sql += "dttb_xa,dttb_gan,dtxtm_mp,dtxtm_mt,dtgtm_mp,dtgtm_mt,kql1_mp,kql1_mt,kqtll1_mp,kqtll1_mt,cql1_mp,cql1_mt,cqtll1_mp,cqtll1_mt,chidinh,";
                    sql += "kql2_mp,kql2_mt,kqtll2_mp,kqtll2_mt,cql2_mp,cql2_mt,cqtll2_mp,cqtll2_mt,ct_mp,ct_mt,cttl_mp,cttl_mt,dc_mp,dc_mt,";
                    sql += "dctl_mp,dctl_mt,kc_mp,kc_mt,ctk_mp,ctk_mt,xutri,capdon,chuyen,loidan,khac,ktv,maicd,chandoan,maicdk,chandoank,userid)";
                    sql += " values ";
                    sql += " (:m_id,:m_mabn,:m_maql,:m_ngay,:m_loaibn,:m_kham,:m_madoituong,:m_tlxkk_mp,:m_tlxkk_mt,:m_tlkl_mp,:m_tlkl_mt,:m_tlg_mp,:m_tlg_mt,";
                    sql += ":m_dttb_xa,:m_dttb_gan,:m_dtxtm_mp,:m_dtxtm_mt,:m_dtgtm_mp,:m_dtgtm_mt,:m_kql1_mp,:m_kql1_mt,:m_kqtll1_mp,:m_kqtll1_mt,:m_cql1_mp,:m_cql1_mt,:m_cqtll1_mp,:m_cqtll1_mt,:m_chidinh,";
                    sql += ":m_kql2_mp,:m_kql2_mt,:m_kqtll2_mp,:m_kqtll2_mt,:m_cql2_mp,:m_cql2_mt,:m_cqtll2_mp,:m_cqtll2_mt,:m_ct_mp,:m_ct_mt,:m_cttl_mp,:m_cttl_mt,:m_dc_mp,:m_dc_mt,";
                    sql += ":m_dctl_mp,:m_dctl_mt,:m_kc_mp,:m_kc_mt,:m_ctk_mp,:m_ctk_mt,:m_xutri,:m_capdon,:m_chuyen,:m_loidan,:m_khac,:m_ktv,:m_maicd,:m_chandoan,:m_maicdk,:m_chandoank,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_loaibn", NpgsqlDbType.Numeric).Value = m_loaibn;
                    cmd.Parameters.Add("m_kham", NpgsqlDbType.Numeric).Value = m_kham;
                    cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                    cmd.Parameters.Add("m_tlxkk_mp", NpgsqlDbType.Varchar, 10).Value = m_tlxkk_mp;
                    cmd.Parameters.Add("m_tlxkk_mt", NpgsqlDbType.Varchar, 10).Value = m_tlxkk_mt;
                    cmd.Parameters.Add("m_tlkl_mp", NpgsqlDbType.Varchar, 10).Value = m_tlkl_mp;
                    cmd.Parameters.Add("m_tlkl_mt", NpgsqlDbType.Varchar, 10).Value = m_tlkl_mt;
                    cmd.Parameters.Add("m_tlg_mp", NpgsqlDbType.Varchar, 10).Value = m_tlg_mp;
                    cmd.Parameters.Add("m_tlg_mt", NpgsqlDbType.Varchar, 10).Value = m_tlg_mt;
                    cmd.Parameters.Add("m_dttb_xa", NpgsqlDbType.Varchar, 10).Value = m_dttb_xa;
                    cmd.Parameters.Add("m_dttb_gan", NpgsqlDbType.Varchar, 10).Value = m_dttb_gan;
                    cmd.Parameters.Add("m_dtxtm_mp", NpgsqlDbType.Varchar, 10).Value = m_dtxtm_mp;
                    cmd.Parameters.Add("m_dtxtm_mt", NpgsqlDbType.Varchar, 10).Value = m_dtxtm_mt;
                    cmd.Parameters.Add("m_dtgtm_mp", NpgsqlDbType.Varchar, 10).Value = m_dtgtm_mp;
                    cmd.Parameters.Add("m_dtgtm_mt", NpgsqlDbType.Varchar, 10).Value = m_dtgtm_mt;
                    cmd.Parameters.Add("m_kql1_mp", NpgsqlDbType.Text).Value = m_kql1_mp;
                    cmd.Parameters.Add("m_kql1_mt", NpgsqlDbType.Text).Value = m_kql1_mt;
                    cmd.Parameters.Add("m_kqtll1_mp", NpgsqlDbType.Varchar, 10).Value = m_kqtll1_mp;
                    cmd.Parameters.Add("m_kqtll1_mt", NpgsqlDbType.Varchar, 10).Value = m_kqtll1_mt;
                    cmd.Parameters.Add("m_cql1_mp", NpgsqlDbType.Text).Value = m_cql1_mp;
                    cmd.Parameters.Add("m_cql1_mt", NpgsqlDbType.Text).Value = m_cql1_mt;
                    cmd.Parameters.Add("m_cqtll1_mp", NpgsqlDbType.Varchar, 10).Value = m_cqtll1_mp;
                    cmd.Parameters.Add("m_cqtll1_mt", NpgsqlDbType.Varchar, 10).Value = m_cqtll1_mt;
                    cmd.Parameters.Add("m_chidinh", NpgsqlDbType.Numeric).Value = m_chidinh;
                    cmd.Parameters.Add("m_kql2_mp", NpgsqlDbType.Text).Value = m_kql2_mp;
                    cmd.Parameters.Add("m_kql2_mt", NpgsqlDbType.Text).Value = m_kql2_mt;
                    cmd.Parameters.Add("m_kqtll2_mp", NpgsqlDbType.Varchar, 10).Value = m_kqtll2_mp;
                    cmd.Parameters.Add("m_kqtll2_mt", NpgsqlDbType.Varchar, 10).Value = m_kqtll2_mt;
                    cmd.Parameters.Add("m_cql2_mp", NpgsqlDbType.Text).Value = m_cql2_mp;
                    cmd.Parameters.Add("m_cql2_mt", NpgsqlDbType.Text).Value = m_cql2_mt;
                    cmd.Parameters.Add("m_cqtll2_mp", NpgsqlDbType.Varchar, 10).Value = m_cqtll2_mp;
                    cmd.Parameters.Add("m_cqtll2_mt", NpgsqlDbType.Varchar, 10).Value = m_cqtll2_mt;
                    cmd.Parameters.Add("m_ct_mp", NpgsqlDbType.Text).Value = m_ct_mp;
                    cmd.Parameters.Add("m_ct_mt", NpgsqlDbType.Text).Value = m_ct_mt;
                    cmd.Parameters.Add("m_cttl_mp", NpgsqlDbType.Varchar, 10).Value = m_cttl_mp;
                    cmd.Parameters.Add("m_cttl_mt", NpgsqlDbType.Varchar, 10).Value = m_cttl_mt;
                    cmd.Parameters.Add("m_dc_mp", NpgsqlDbType.Text).Value = m_dc_mp;
                    cmd.Parameters.Add("m_dc_mt", NpgsqlDbType.Text).Value = m_dc_mt;
                    cmd.Parameters.Add("m_dctl_mp", NpgsqlDbType.Varchar, 10).Value = m_dctl_mp;
                    cmd.Parameters.Add("m_dctl_mt", NpgsqlDbType.Varchar, 10).Value = m_dctl_mt;
                    cmd.Parameters.Add("m_kc_mp", NpgsqlDbType.Varchar, 10).Value = m_kc_mp;
                    cmd.Parameters.Add("m_kc_mt", NpgsqlDbType.Varchar, 10).Value = m_kc_mt;
                    cmd.Parameters.Add("m_ctk_mp", NpgsqlDbType.Text).Value = m_ctk_mp;
                    cmd.Parameters.Add("m_ctk_mt", NpgsqlDbType.Text).Value = m_ctk_mt;
                    cmd.Parameters.Add("m_xutri", NpgsqlDbType.Numeric).Value = m_xutri;
                    cmd.Parameters.Add("m_capdon", NpgsqlDbType.Text).Value = m_capdon;
                    cmd.Parameters.Add("m_chuyen", NpgsqlDbType.Text).Value = m_chuyen;
                    cmd.Parameters.Add("m_loidan", NpgsqlDbType.Text).Value = m_loidan;
                    cmd.Parameters.Add("m_khac", NpgsqlDbType.Text).Value = m_khac;
                    cmd.Parameters.Add("m_ktv", NpgsqlDbType.Varchar, 4).Value = m_ktv;
                    cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                    cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                    cmd.Parameters.Add("m_maicdk", NpgsqlDbType.Varchar, 9).Value = m_maicdk;
                    cmd.Parameters.Add("m_chandoank", NpgsqlDbType.Text).Value = m_chandoank;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message.ToString().Trim(), sComputer, "kx_dieutri");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        public decimal get_id_kx(string m_mabn, string m_ngaygio, bool gio)
        {
            sql = "select id from kx_dieutri where mabn='" + m_mabn + "'";
            if (gio) sql += " and to_char(ngay,'dd/mm/yyyy hh24:mi')='" + m_ngaygio + "'";
            else sql += " and to_char(ngay,'dd/mm/yyyy')='" + m_ngaygio.Substring(0, 10) + "'";
            ds = get_data(sql);
            decimal l_id = (ds.Tables[0].Rows.Count == 0) ? 0 : decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            return l_id;
        }

        public decimal get_id_kx(string m_mabn, string m_ngaygio)
        {
            ds = get_data("select id from kx_dieutri where mabn='" + m_mabn + "' and to_char(ngay,'dd/mm/yyyy hh24:mi')='" + m_ngaygio + "'");
            decimal l_id = (ds.Tables[0].Rows.Count == 0) ? 0 : decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            if (l_id == 0) l_id = getidyymmddhhmiss_stt_computer;// get_capid(-11);
            return l_id;
        }
        public bool upd_table(string m_mmyy, int m_userid)
        {
            sql = "update " + user + ".table set userid=:m_userid where mmyy=:m_mmyy";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_mmyy", NpgsqlDbType.Text, 4).Value = m_mmyy;

                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".table (mmyy,userid,computer) values (:m_mmyy,:m_userid,:m_computer)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mmyy", NpgsqlDbType.Text, 4).Value = m_mmyy;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    cmd.Parameters.Add("m_computer", NpgsqlDbType.Varchar, 20).Value = sComputer;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "table");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool bMmyy(string m_mmyy)
        {
            return get_data("select * from " + user + ".table where mmyy='" + ((m_mmyy.Trim().Length == 4) ? m_mmyy : mmyy(m_mmyy)) + "'").Tables[0].Rows.Count > 0;
        }

        public bool bSchema(string Schema)
        {
            try
            {
                if (bKiemtra_taoschema) return get_data("select * from sys.user_tables where schemaname='" + Schema.ToUpper() + "'").Tables[0].Rows.Count > 0;
                else return true;
            }
            catch
            {
                if (bKiemtra_taoschema) return get_data("select * from pg_tableS where upper(schemaname)='" + Schema.ToUpper() + "'").Tables[0].Rows.Count > 0;
                else return true;
            }
        }
        public void tao_primary_key()//gam 02/02/2012
        {
            string usr = userid;
            string asql = "";
            asql += "alter table " + usr + ".btdbn add constraint pk_btdbn  PRIMARY KEY (mabn);";
            asql += "alter table " + usr + ".btdkp_bv add constraint pk_btdkp_bv  PRIMARY KEY (makp);";
            asql += "alter table " + usr + ".dmchinhanh add constraint pk_dmchinhanh  PRIMARY KEY (id);";
            asql += "alter table " + usr + ".dmbs add constraint pk_dmbs  PRIMARY KEY (ma);\n ";
            asql += "alter table " + usr + ".d_dmnguon add constraint pk_dmnguon  PRIMARY KEY (id);";
            asql += "alter table " + usr + ".d_dmbd add constraint pk_dmbd  PRIMARY KEY (id);";
            asql += "alter table " + usr + ".blgd_nguoigaybl add constraint pk_blgd_nguoigaybl  PRIMARY KEY (id);";
            asql += "alter table " + usr + ".blgd_tdhv add constraint pk_blgd_tdhv  PRIMARY KEY (id);";
            asql += "alter table " + usr + ".blgd_tgchiudung add constraint pk_blgd_tgchiudung  PRIMARY KEY (id);";
            asql += "alter table " + usr + ".blgd_tthonnhan add constraint pk_blgd_tthonnhan  PRIMARY KEY (id);";
            asql += "alter table " + usr + ".d_dutrukholl add constraint pk_dutrukholl  PRIMARY KEY (id);";
            asql += "alter table " + usr + ".d_duyetdutrukholl add constraint pk_duyetdutrukholl  PRIMARY KEY (id);";
            asql += "alter table " + usr + ".d_dutrucsttll add constraint pk_dutrucsttll  PRIMARY KEY (id);";
            asql += "alter table " + usr + ".d_duyetdutrucsttll add constraint pk_duyetdutrucsttll  PRIMARY KEY (id);";
            asql += "alter table " + usr + ".d_chonhapll add constraint pk_chonhapll  PRIMARY KEY (id);";
            asql += "alter table " + usr + ".dmphongthuchiencls add constraint pk_dmphongthuchiencls  PRIMARY KEY (id);";
            asql += "alter table " + usr + ".dlogin add constraint pk_dlogin  PRIMARY KEY (id);";
            asql += "alter table " + usr + ".dmpttt add constraint pk_dmpttt  PRIMARY KEY (mapt);";
            asql += "alter table " + usr + ".icd10 add constraint pk_icd10  PRIMARY KEY (cicd10);";
            asql += "alter table " + usr + ".btdnn_bv add constraint pk_btdnn_bv  PRIMARY KEY (mann);";
            asql += "alter table " + usr + ".benhandt add constraint pk_benhandt  PRIMARY KEY (maql);";
            asql += "alter table " + usr + ".nhapkhoa add constraint pk_nhapkhoa  PRIMARY KEY (id);";
            asql += "alter table " + usr + ".xuatkhoa add constraint pk_xuatkhoa  PRIMARY KEY (id);";
            asql += "alter table " + usr + ".xuatvien add constraint pk_xuatvien  PRIMARY KEY (maql);";
            asql += "alter table " + usr + ".hiendien add constraint pk_hiendien  PRIMARY KEY (id);";
            asql += "alter table " + usr + ".chuyenkhoa add constraint pk_chuyenkhoa  PRIMARY KEY (id);";
            asql += "alter table " + usr + ".chuyenvien add constraint pk_chuyenvien  PRIMARY KEY (maql);";
            asql += "alter table " + usr + ".lienhe add constraint pk_lienhe  PRIMARY KEY (maql);";
            asql += "alter table " + usr + ".doituong add constraint pk_doituong  PRIMARY KEY (madoituong);";
            asql += "alter table " + usr + ".d_doituong add constraint pk_d_doituong  PRIMARY KEY (madoituong);";
            asql += "alter table " + usr + ".d_duockp add constraint pk_duockp  PRIMARY KEY (id);";
            asql += "alter table " + usr + ".d_dmphieu add constraint pk_dmphieu  PRIMARY KEY (id);\n ";
            asql += "alter table " + usr + ".d_loaiphieu add constraint pk_loaiphieu  PRIMARY KEY (id);\n ";
            asql += "alter table " + usr + ".d_dmkho add constraint pk_dmkho  PRIMARY KEY (id);\n ";
            asql += "alter table " + usr + ".btdpxa add constraint pk_btdpxa  PRIMARY KEY (maphuongxa);\n ";
            asql += "alter table " + usr + ".btdquan add constraint pk_btdquan  PRIMARY KEY (maqu);\n ";
            asql += "alter table " + usr + ".btdtt add constraint pk_btdtt  PRIMARY KEY (matt);\n ";
            asql += "alter table " + usr + ".v_giavp add constraint pk_v_giavp  PRIMARY KEY (id);\n ";
            asql += "alter table " + usr + ".d_dmnx add constraint pk_d_dmnx  PRIMARY KEY (id);\n ";
            asql += "alter table " + usr + ".d_dmnhomkho add constraint pk_d_dmnhomkho  PRIMARY KEY (id);\n ";
            asql += "alter table " + usr + ".dmcomputer add constraint pk_dmcomputer  PRIMARY KEY (id);\n ";
            asql += "alter table " + usr + ".dmtables add constraint pk_dmtables  PRIMARY KEY (id);\n ";
            asql += "alter table " + usr + ".ct_donvi add constraint pk_ct_donvi  PRIMARY KEY (id);\n ";
            asql += "alter table " + usr + ".ct_loai add constraint pk_ct_loai  PRIMARY KEY (id);\n ";
            asql += "alter table " + usr + ".di_dmphieu add constraint pk_di_dmphieu  PRIMARY KEY (id);\n ";
            asql += "alter table " + usr + ".ct_ketqua add constraint pk_ct_ketqua  PRIMARY KEY (id);\n ";
            asql += "alter table " + usr + ".d_ctghisoll add constraint pk_d_ctghisoll  PRIMARY KEY (id);\n ";
            asql += "alter table " + usr + ".d_ctghisoll add constraint pk_d_ctghisoll  PRIMARY KEY (id);\n ";
            foreach (string text in asql.Split(';'))
            {
                execute_data(text);
            }
            execute_data(asql);


        }
        public void tao_schema(string m_mmyy, int m_userid)
        {
            if (m_mmyy.IndexOf("/") != -1)
            {
                System.Windows.Forms.MessageBox.Show("Tháng / năm " + m_mmyy + " không hợp lệ !", Msg);
                return;
            }
            tao_primary_key();//gam 02/02/2012
            if (!bMmyy(m_mmyy))
            {
                string usr = userid;
                schema = usr + m_mmyy;
                string s_sql = "CREATE SCHEMA " + schema + " AUTHORIZATION " + owner + ";\n";
                //linh 17112012
                s_sql += "CREATE TABLE " + schema + ".benhanpk(mabn varchar(" + i_maxlength_mabn + "),mavaovien numeric DEFAULT 0,maql numeric NOT NULL DEFAULT 0,makp varchar(" + i_maxlength_makp + "),ngay timestamp,dentu numeric(1) DEFAULT 0,nhantu numeric(1) DEFAULT 0,madoituong numeric(2) DEFAULT 0,chandoan text,maicd varchar(9),ttlucrv numeric(2) DEFAULT 0,mabs varchar(4),sovaovien varchar(10),bienchung numeric(1) DEFAULT 0,taibien numeric(1) DEFAULT 0,giaiphau numeric(1) DEFAULT 0,mangtr numeric DEFAULT 0,cschandoan text,userid numeric(7) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_benhanpk PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_benhancc_btdbn FOREIGN KEY (mabn) REFERENCES " + usr + ".btdbn (mabn) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_benhancc_btdkp_bv FOREIGN KEY (makp) REFERENCES " + usr + ".btdkp_bv (makp) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT, CONSTRAINT fk_benhancc_doituong FOREIGN KEY (madoituong) REFERENCES " + usr + ".doituong (madoituong) MATCH SIMPLE   ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".benhanpk OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".benhancc(mabn varchar(" + i_maxlength_mabn + "),mavaovien numeric DEFAULT 0,maql numeric NOT NULL DEFAULT 0,makp varchar(" + i_maxlength_makp + "),ngay timestamp,dentu numeric(1) DEFAULT 0,nhantu numeric(1) DEFAULT 0,madoituong numeric(2) DEFAULT 0,mabsnb varchar(4),chandoan text,maicd varchar(9),ngayrv timestamp,ketqua numeric(1) DEFAULT 0,ttlucrv numeric(2) DEFAULT 0,chandoanrv text,maicdrv varchar(9),mabs varchar(4),sovaovien varchar(10),soluutru varchar(10),giuong varchar(20),bienchung numeric(1) DEFAULT 0,taibien numeric(1) DEFAULT 0,giaiphau numeric(1) DEFAULT 0,userid numeric(7) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_benhancc PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_benhanpk_btdbn FOREIGN KEY (mabn) REFERENCES " + usr + ".btdbn (mabn) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT, CONSTRAINT fk_benhanpk_btdkp_bv FOREIGN KEY (makp) REFERENCES " + usr + ".btdkp_bv (makp) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_benhanpk_doituong FOREIGN KEY (madoituong) REFERENCES " + usr + ".doituong (madoituong) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".benhancc OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".bhyt(mabn varchar(" + i_maxlength_mabn + "),maql numeric NOT NULL DEFAULT 0,sothe varchar(20),denngay timestamp,mabv varchar(10),maphu numeric(2) DEFAULT 0,tungay timestamp,ngay1 timestamp,ngay2 timestamp,ngay3 timestamp,sudung numeric(1) default 1,traituyen numeric(1) default 0,CONSTRAINT pk_bhyt PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_bhyt_btdbn FOREIGN KEY (mabn) REFERENCES " + usr + ".btdbn (mabn) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".bhyt OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".cdkemtheo(id numeric NOT NULL DEFAULT 0,maql numeric NOT NULL DEFAULT 0,loai numeric(3) NOT NULL DEFAULT 0,chandoan text,maicd varchar(9) NOT NULL,stt numeric(2) NOT NULL DEFAULT 0,CONSTRAINT pk_cdkemtheo PRIMARY KEY (id, loai, maicd, maql, stt) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdkemtheo OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".cdnguyennhan(id numeric NOT NULL DEFAULT 0,maql numeric NOT NULL DEFAULT 0,chandoan text,maicd varchar(9),CONSTRAINT pk_cdnguyennhan PRIMARY KEY (id, maql) USING INDEX TABLESPACE medi_index)WITH OIDS;ALTER TABLE " + schema + ".cdnguyennhan OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".cdsankhoa(maql numeric NOT NULL DEFAULT 0,ngay timestamp,cachthucde text,kiemsoat numeric(1) DEFAULT 0,mataibien varchar(10),CONSTRAINT pk_cdsankhoa PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdsankhoa OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".cdungbuou(id numeric DEFAULT 0,maql numeric DEFAULT 0,t_v text,n_v text,m_v text,giaidoan_v text,t_r text,n_r text,m_r text,giaidoan_r text) WITH OIDS;ALTER TABLE " + schema + ".cdungbuou OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_dausinhton(id numeric NOT NULL DEFAULT 0,idkhoa numeric DEFAULT 0,iddutru numeric DEFAULT 0,ngay timestamp,mabs varchar(4),manv varchar(4),mach numeric(5) DEFAULT 0,nhietdo numeric(7) DEFAULT 0,huyetap varchar(7),nhiptho numeric(5) DEFAULT 0,cannang numeric(5) DEFAULT 0,phong varchar(10),giuong varchar(20),ghichu text,CONSTRAINT pk_d_dausinhton PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".d_dausinhton OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_duyet(id numeric NOT NULL DEFAULT 0,nhom numeric(2) DEFAULT 0,ngay timestamp,loai numeric(2) DEFAULT 0,phieu numeric(3) DEFAULT 0,makp numeric(6) DEFAULT 0,done numeric(1) DEFAULT 0,userid numeric(7) DEFAULT 0,ngayud timestamp DEFAULT now(),makhoa numeric(6) DEFAULT 0,CONSTRAINT pk_d_duyet PRIMARY KEY (id) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_d_duyet_d_dmphieu FOREIGN KEY (loai) REFERENCES " + usr + ".d_dmphieu (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_duyet_d_duockp FOREIGN KEY (makp)REFERENCES " + usr + ".d_duockp (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_duyet_d_loaiphieu FOREIGN KEY (phieu) REFERENCES " + usr + ".d_loaiphieu (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_duyet OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_dutrull(id numeric NOT NULL DEFAULT 0,idduyet numeric DEFAULT 0,mabn varchar(" + i_maxlength_mabn + "),mavaovien numeric DEFAULT 0,maql numeric DEFAULT 0,idkhoa numeric DEFAULT 0,ngayvv timestamp,songay numeric(2) DEFAULT 1, traituyen numeric(1) default 0,CONSTRAINT pk_d_dutrull PRIMARY KEY (id) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_d_dutrull_btdbn FOREIGN KEY (mabn) REFERENCES " + usr + ".btdbn (mabn) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_dutrull_d_duyet FOREIGN KEY (idduyet) REFERENCES " + schema + ".d_duyet (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_dutrull OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_dutruct(id numeric NOT NULL DEFAULT 0,stt numeric(3) NOT NULL DEFAULT 0,madoituong numeric(2) DEFAULT 0,makho numeric(5) DEFAULT 0,mabd numeric(10) DEFAULT 0,slyeucau numeric(12,4) DEFAULT 0,slthuc numeric(12,4) DEFAULT 0,cachdung text,manguon numeric(2) DEFAULT 0,tutruc numeric(1) DEFAULT 0,solan numeric(2) DEFAULT 1,lan numeric(12,4) DEFAULT 0,choduyet numeric(1) default 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_d_dutruct PRIMARY KEY (id, stt) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_d_dutruct_d_dmbd FOREIGN KEY (mabd) REFERENCES " + usr + ".d_dmbd (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_dutruct_d_dmkho FOREIGN KEY (makho) REFERENCES " + usr + ".d_dmkho (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_dutruct_d_dmnguon FOREIGN KEY (manguon) REFERENCES " + usr + ".d_dmnguon (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_dutruct_d_doituong FOREIGN KEY (madoituong) REFERENCES " + usr + ".d_doituong (madoituong) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_dutruct_d_dutrull FOREIGN KEY (id) REFERENCES " + schema + ".d_dutrull (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_dutruct OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_haophill(id numeric NOT NULL DEFAULT 0,idduyet numeric DEFAULT 0,sophieu varchar(8),CONSTRAINT pk_d_haophill PRIMARY KEY (id) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_d_haophill_d_duyet FOREIGN KEY (idduyet) REFERENCES " + schema + ".d_duyet (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_haophill OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_haophict(id numeric NOT NULL DEFAULT 0,stt numeric(3) NOT NULL DEFAULT 0,madoituong numeric(1) DEFAULT 0,makho numeric(5) DEFAULT 0,mabd numeric(10) DEFAULT 0,slyeucau numeric(12,4) DEFAULT 0,slthuc numeric(12,4) DEFAULT 0,manguon numeric(2) DEFAULT 0,tutruc numeric(1) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_d_haophict PRIMARY KEY (id, stt) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_d_haophict_d_dmbd FOREIGN KEY (mabd) REFERENCES " + usr + ".d_dmbd (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_haophict_d_dmkho FOREIGN KEY (makho) REFERENCES " + usr + ".d_dmkho (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_haophict_d_dmnguon FOREIGN KEY (manguon) REFERENCES " + usr + ".d_dmnguon (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_haophict_d_haophill FOREIGN KEY (id) REFERENCES " + schema + ".d_haophill (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_haophict OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_hoantrall(id numeric NOT NULL DEFAULT 0,idduyet numeric DEFAULT 0,mabn varchar(" + i_maxlength_mabn + "),mavaovien numeric DEFAULT 0,maql numeric DEFAULT 0,idkhoa numeric DEFAULT 0,ngayvv timestamp,lydo numeric(2) DEFAULT 0,thuoc numeric(1) DEFAULT 0,traituyen numeric(1) default 0,CONSTRAINT pk_d_hoantrall PRIMARY KEY (id) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_d_hoantrall_d_duyet FOREIGN KEY (idduyet) REFERENCES " + schema + ".d_duyet (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_hoantrall OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_hoantract(id numeric NOT NULL DEFAULT 0,stt numeric(3) NOT NULL DEFAULT 0,ngay timestamp,madoituong numeric(2) DEFAULT 0,makho numeric(5) DEFAULT 0,mabd numeric(10) DEFAULT 0,slyeucau numeric(12,4) DEFAULT 0,slthuc numeric(12,4) DEFAULT 0,manguon numeric(2) DEFAULT 0,ghichu varchar(10),sttt numeric NOT NULL DEFAULT 0,ngayud timestamp DEFAULT now(), idx numeric(20) DEFAULT 0,sttx numeric(5) DEFAULT 0,CONSTRAINT pk_d_hoantract PRIMARY KEY (id, stt) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_d_hoantract_d_dmbd FOREIGN KEY (mabd) REFERENCES " + usr + ".d_dmbd (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_hoantract_d_dmkho FOREIGN KEY (makho) REFERENCES " + usr + ".d_dmkho (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_hoantract_d_dmnguon FOREIGN KEY (manguon)  REFERENCES " + usr + ".d_dmnguon (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_hoantract_d_doituong FOREIGN KEY (madoituong) REFERENCES " + usr + ".d_doituong (madoituong) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_hoantract_d_hoantrall FOREIGN KEY (id) REFERENCES " + schema + ".d_hoantrall (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_hoantract OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_ngayduyet(nhom numeric(2) DEFAULT 0,loai numeric(2) DEFAULT 0,makp numeric(6) DEFAULT 0,ngay timestamp,idduyet numeric DEFAULT 0,phieu numeric(3) DEFAULT 0,makho text,sttduyet text,CONSTRAINT fk_d_ngayduyet_d_dmphieu FOREIGN KEY (loai) REFERENCES " + usr + ".d_dmphieu (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_ngayduyet_d_duockp FOREIGN KEY (makp) REFERENCES " + usr + ".d_duockp (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_ngayduyet_d_loaiphieu FOREIGN KEY (phieu) REFERENCES " + usr + ".d_loaiphieu (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_ngayduyet OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_ngaylanh(id numeric NOT NULL DEFAULT 0,stt numeric(4) NOT NULL DEFAULT 0,ngay timestamp,CONSTRAINT pk_d_ngaylanh PRIMARY KEY (id, stt) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".d_ngaylanh OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_theodoiduyet(nhom numeric(2) NOT NULL DEFAULT 0,ngay timestamp NOT NULL,loai numeric(2) NOT NULL DEFAULT 0,makp numeric(6) NOT NULL DEFAULT 0,CONSTRAINT pk_d_theodoiduyet PRIMARY KEY (loai, makp, ngay, nhom) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_d_theodoiduyet_d_dmphieu FOREIGN KEY (loai) REFERENCES " + usr + ".d_dmphieu (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_theodoiduyet_d_duockp FOREIGN KEY (makp) REFERENCES " + usr + ".d_duockp (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_theodoiduyet OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_thuocbhytll(id numeric NOT NULL DEFAULT 0,nhom numeric(2) DEFAULT 0,ngay timestamp,mabn varchar(" + i_maxlength_mabn + "),mavaovien numeric DEFAULT 0,maql numeric DEFAULT 0,done numeric(1) DEFAULT 0,madoituong numeric(2) DEFAULT 0,ghichu text,songay numeric(2) DEFAULT 0,idduyet numeric DEFAULT 0,makp varchar(" + i_maxlength_makp + "),mabs varchar(4),chandoan text,maicd varchar(9),loaiba numeric(1) DEFAULT 3,image bytea,userid numeric(7) DEFAULT 0,ngayud timestamp DEFAULT now(),idtt_cl numeric default 0,CONSTRAINT pk_d_thuocbhytll PRIMARY KEY (id) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_d_thucbhytll_btdbn FOREIGN KEY (mabn) REFERENCES " + usr + ".btdbn (mabn) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_thuocbhytll OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_thuocbhytct(id numeric NOT NULL DEFAULT 0,stt numeric(3) NOT NULL DEFAULT 0,makho numeric(5) DEFAULT 0,mabd numeric(10) DEFAULT 0,slyeucau numeric(12,4) DEFAULT 0,slthuc numeric(12,4) DEFAULT 0,cachdung text,manguon numeric(2) DEFAULT 0,solan numeric(2) DEFAULt 1,lan numeric(12,4) DEFAULT 0,madoituong numeric(2) default 1,ngayud timestamp DEFAULT now(), paid numeric default 0, idttrv numeric(21) default 0,CONSTRAINT pk_d_thuocbhytct PRIMARY KEY (id, stt) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_d_thucbhytct_d_dmbd FOREIGN KEY (mabd) REFERENCES " + usr + ".d_dmbd (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_thucbhytct_d_dmkho FOREIGN KEY (makho) REFERENCES " + usr + ".d_dmkho (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_thucbhytct_d_dmnguon FOREIGN KEY (manguon) REFERENCES " + usr + ".d_dmnguon (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_thuocbhytct_d_thuocbhytll FOREIGN KEY (id) REFERENCES " + schema + ".d_thuocbhytll (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_thuocbhytct OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_toathuocll(id numeric NOT NULL DEFAULT 0,sophieu numeric(5) DEFAULT 0,mabn varchar(" + i_maxlength_mabn + "),maql numeric DEFAULT 0,ngay timestamp,makp varchar(" + i_maxlength_makp + "),chandoan text,maicd varchar(9),mabs varchar(4),ghichu text,idngtru numeric DEFAULT 0,done numeric(1) DEFAULT 0,songay numeric(2) DEFAULt 1,image bytea,userid numeric(7) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_d_toathuocll PRIMARY KEY (id) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_d_toathuocll_btdbn FOREIGN KEY (mabn) REFERENCES " + usr + ".btdbn (mabn) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_toathuocll OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_toathuocct(id numeric NOT NULL DEFAULT 0,stt numeric(3) NOT NULL DEFAULT 0,mabd numeric(10) DEFAULT 0,soluong numeric(12,4) DEFAULT 0,cachdung text,done numeric(1) DEFAULT 0,solan numeric(2) DEFAULt 1,lan numeric(12,4) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_d_toathuocct PRIMARY KEY (id, stt) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_d_toathuocct_d_toathuocll FOREIGN KEY (id) REFERENCES " + schema + ".d_toathuocll (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_toathuocct OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_xtutrucll(id numeric NOT NULL DEFAULT 0,idduyet numeric DEFAULT 0,mabn varchar(" + i_maxlength_mabn + "),mavaovien numeric DEFAULT 0,maql numeric DEFAULT 0,idkhoa numeric DEFAULT 0,ngayvv timestamp,read numeric(1) DEFAULT 0,songay numeric(2) DEFAULT 0, traituyen number(1) default 0,CONSTRAINT pk_d_xtutrucll PRIMARY KEY (id) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_d_xtutrucll_btdbn FOREIGN KEY (mabn) REFERENCES " + usr + ".btdbn (mabn) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_xtutrucll_d_duyet FOREIGN KEY (idduyet) REFERENCES " + schema + ".d_duyet (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_xtutrucll OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_xtutrucct(id numeric NOT NULL DEFAULT 0,stt numeric(3) NOT NULL DEFAULT 0,madoituong numeric(2) DEFAULT 0,makho numeric(5) DEFAULT 0,mabd numeric(10) DEFAULT 0,slyeucau numeric(12,4) DEFAULT 0,slthuc numeric(12,4) DEFAULT 0,cachdung text,manguon numeric(2) DEFAULT 0,idvpkhoa numeric DEFAULT 0,solan numeric(2) DEFAULT 1,lan numeric(12,4) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_d_xtutrucct PRIMARY KEY (id, stt) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_d_xtutrucct_d_dmbd FOREIGN KEY (mabd) REFERENCES " + usr + ".d_dmbd (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_xtutrucct_d_dmkho FOREIGN KEY (makho) REFERENCES " + usr + ".d_dmkho (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_xtutrucct_d_dmnguon FOREIGN KEY (manguon) REFERENCES " + usr + ".d_dmnguon (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT, CONSTRAINT fk_d_xtutrucct_d_doituong FOREIGN KEY (madoituong)  REFERENCES " + usr + ".d_doituong (madoituong) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_xtutrucct_d_xtutrucll FOREIGN KEY (id) REFERENCES " + schema + ".d_xtutrucll (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS; ALTER TABLE " + schema + ".d_xtutrucct OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".dasuamadt(maql numeric DEFAULT 0,idkhoa numeric DEFAULT 0) WITH OIDS;ALTER TABLE " + schema + ".dasuamadt OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".dausinhton(maql numeric NOT NULL DEFAULT 0,mach numeric(5) DEFAULT 0,nhietdo numeric(5) DEFAULT 0,huyetap varchar(7),cannang numeric(7,2) DEFAULT 0,chieucao numeric(5) DEFAULT 0,CONSTRAINT pk_dausinhton PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".dausinhton OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".error(message text,computer varchar(20),tables varchar(20),ngayud timestamp DEFAULT now()) WITH OIDS;ALTER TABLE " + schema + ".error OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".giayravien(maql numeric NOT NULL DEFAULT 0,dieutri text,loidan text,kyravien numeric(2) DEFAULT 0,lanin numeric(3) DEFAULT 0,userid numeric(7) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_giayravien PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".giayravien OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".lienhe(maql numeric NOT NULL DEFAULT 0,sonha varchar(15),thon text,cholam text,matt varchar(3),maqu varchar(5),maphuongxa varchar(7),tuoivao varchar(4),soluutru varchar(10),honnhan numeric(1) DEFAULT 0,mabs varchar(4),loai numeric(1) DEFAULT 0,bnmoi numeric(1) DEFAULT 0,CONSTRAINT pk_lienhe PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".lienhe OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".lydokham(maql numeric NOT NULL DEFAULT 0,lydo text,phanbiet text,CONSTRAINT pk_lydokham PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".lydokham OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".ngaykb(maql numeric NOT NULL DEFAULT 0,mabn varchar(" + i_maxlength_mabn + "),ngay timestamp,CONSTRAINT pk_ngaykb PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".ngaykb OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".noigioithieu(maql numeric NOT NULL DEFAULT 0,mabv varchar(10),chandoan text,maicd varchar(9),CONSTRAINT pk_noigioithieu PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".noigioithieu OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".pttt(id numeric DEFAULT 0,mabn varchar(" + i_maxlength_mabn + "),mavaovien numeric DEFAULT 0,maql numeric DEFAULT 0,sophieu numeric(5) DEFAULT 0,makp varchar(" + i_maxlength_makp + "),ngay timestamp,chandoant text,maicdt varchar(9),chandoans text,maicds varchar(9),mapt varchar(6),tenpt text,phuongphap varchar(2),tinhhinh numeric(1) DEFAULT 0,ptv varchar(4),taibien numeric(1) DEFAULT 0,tuvong numeric(1) DEFAULT 0,userid numeric(7) DEFAULT 0,ngayud timestamp DEFAULT now(),mamau varchar(10),ngaykt timestamp,mach numeric(5) DEFAULT 0,nhietdo numeric(5) DEFAULT 0,huyetap varchar(7),phu1 varchar(4),phu2 varchar(4),bsgayme varchar(4),ktvgayme varchar(4),hoisuc varchar(4),dungcu varchar(4),noidung text,loaibn numeric(1) DEFAULT 0,mapmo varchar(2),somat numeric(1) DEFAULT 0,molaimien numeric(1) DEFAULT 0,idvpkhoa numeric DEFAULT 0,idduoc numeric DEFAULT 0,idkhoa numeric DEFAULT 0,idchidinh numeric DEFAULT 0,mavp numeric(10) DEFAULT 0,madoituong numeric(2) DEFAULT 0,loai numeric(1) DEFAULT 0,noisoi numeric(1) default 0,tylegiam numeric(5,2) default 0, stgiam numeric (18) default 0,CONSTRAINT pk_pttt PRIMARY KEY (id) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_pttt_btdbn FOREIGN KEY (mabn) REFERENCES " + usr + ".btdbn (mabn) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_pttt_btdkp_bv FOREIGN KEY (makp) REFERENCES " + usr + ".btdkp_bv (makp) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".pttt OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".pttt_lichmo(id numeric NOT NULL DEFAULT 0,mabn varchar(" + i_maxlength_mabn + "),maql numeric DEFAULT 0,idkhoa numeric DEFAULT 0,makp varchar(" + i_maxlength_makp + "),ngay timestamp,stt numeric(3) DEFAULT 0,maicd varchar(9),mamau varchar(10),phuongphap varchar(2),ptv varchar(4),gayme varchar(4),phu varchar(4),userid numeric(7) DEFAULT 0, ngayud timestamp DEFAULT now(),CONSTRAINT pk_pttt_lichmo PRIMARY KEY (id) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_pttt_lichmo_btdbn FOREIGN KEY (mabn) REFERENCES " + usr + ".btdbn (mabn) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_pttt_lichmo_btdkp_bv FOREIGN KEY (makp) REFERENCES " + usr + ".btdkp_bv (makp) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".pttt_lichmo OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".quanhe(maql numeric NOT NULL DEFAULT 0,quanhe varchar(30),hoten text,diachi text,dienthoai varchar(20),phuongtien text,CONSTRAINT pk_quanhe PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".quanhe OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".sukien(mabn varchar(" + i_maxlength_mabn + "),matiepdon numeric NOT NULL DEFAULT 0,noitiepdon numeric(2) NOT NULL DEFAULT 0,macap numeric NOT NULL DEFAULT 0,CONSTRAINT pk_sukien PRIMARY KEY (macap, matiepdon, noitiepdon) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".sukien OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".tainantt(mabn varchar(" + i_maxlength_mabn + "),maql numeric NOT NULL DEFAULT 0,ngay timestamp,diadiem numeric(1) DEFAULT 0,bophan numeric(1) DEFAULT 0,nguyennhan numeric(1) DEFAULT 0,ngodoc numeric(1) DEFAULT 0,dienbien numeric(1) DEFAULT 0,xutri numeric(1) DEFAULT 0,thon text,matt varchar(3),maqu varchar(5),maphuongxa varchar(7),lydo text, chandoan text, dieutri text, lucvao text, lucra text, CONSTRAINT pk_tainantt PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_tainantt_btdbn FOREIGN KEY (mabn) REFERENCES " + usr + ".btdbn (mabn) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_tainantt_btdpxa FOREIGN KEY (maphuongxa) REFERENCES " + usr + ".btdpxa (maphuongxa) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_tainantt_btdquan FOREIGN KEY (maqu) REFERENCES " + usr + ".btdquan (maqu) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_tainantt_btdtt FOREIGN KEY (matt) REFERENCES " + usr + ".btdtt (matt) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".tainantt OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".tiepdon(mabn varchar(" + i_maxlength_mabn + "),mavaovien numeric DEFAULT 0,maql numeric NOT NULL DEFAULT 0,makp varchar(" + i_maxlength_makp + "),ngay timestamp,madoituong numeric(2) DEFAULT 0,sovaovien varchar(10),tuoivao varchar(4),done varchar(1),bnmoi numeric(1) DEFAULT 0,noitiepdon numeric(2) DEFAULT 0,loai numeric(1) DEFAULT 0,userid numeric(7) DEFAULT 0,ngayud timestamp DEFAULT now(), idchidinh numeric(20) default 0,CONSTRAINT pk_tiepdon PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_tiepdon_btdbn FOREIGN KEY (mabn) REFERENCES " + usr + ".btdbn (mabn) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_tiepdon_btdkp_bv FOREIGN KEY (makp) REFERENCES " + usr + ".btdkp_bv (makp) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_tiepdon_doituong FOREIGN KEY (madoituong) REFERENCES " + usr + ".doituong (madoituong) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".tiepdon OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".ttbong(maql numeric NOT NULL DEFAULT 0,ngay timestamp,CONSTRAINT pk_ttbong PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".ttbong OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".ttkhamthai(mabn varchar(" + i_maxlength_mabn + "),maql numeric NOT NULL DEFAULT 0,para varchar(8),kinhcc timestamp,ngaysanh timestamp,dacdiem text,CONSTRAINT pk_ttkhamthai PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_ttkhamthai_btdbn FOREIGN KEY (mabn) REFERENCES " + usr + ".btdbn (mabn) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".ttkhamthai OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".ttmat(maql numeric NOT NULL DEFAULT 0,mp varchar(10),mt varchar(10),nhanapp varchar(10),nhanapt varchar(10),CONSTRAINT pk_ttmat PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".ttmat OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".tttamthan(maql numeric NOT NULL DEFAULT 0,vanhoa varchar(30),CONSTRAINT pk_tttamthan PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".tttamthan OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".xutrikbct(maql numeric NOT NULL DEFAULT 0,xutri text,makp varchar(" + i_maxlength_makp + "),CONSTRAINT pk_xutrikbct PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".xutrikbct OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".khoacdkham(mabn varchar(" + i_maxlength_mabn + "),mavaovien numeric DEFAULT 0,maql numeric NOT NULL DEFAULT 0,makp varchar(" + i_maxlength_makp + "),ngay timestamp,userid numeric(7) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_khoacdkham PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_khoacdkham_btdbn FOREIGN KEY (mabn) REFERENCES " + usr + ".btdbn (mabn) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".khoacdkham OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_error(message text,computer varchar(20),tables varchar(20),ngayud timestamp DEFAULT now()) WITH OIDS;ALTER TABLE " + schema + ".d_error OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".hen(maql numeric DEFAULT 0,songay numeric(5, 0) DEFAULT 0,ghichu text,loai numeric(1, 0) DEFAULT 0,tiepdon numeric(1, 0) DEFAULT 0,CONSTRAINT pk_hen PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".hen OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".trieuchung(maql numeric NOT NULL DEFAULT 0,ten text,CONSTRAINT pk_trieuchung PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index) WITH OIDS;\n";
                s_sql += "CREATE TABLE " + schema + ".d_htrathuocll(id numeric NOT NULL DEFAULT 0,nhom numeric(2) DEFAULT 0,ngay timestamp,mabn varchar(" + i_maxlength_mabn + "),mavaovien numeric DEFAULT 0,maql numeric DEFAULT 0,madoituong numeric(2) DEFAULT 0,makp varchar(" + i_maxlength_makp + "), mabs varchar(4), loaiba numeric(1) DEFAULT 3,ghichu text,idduyet numeric default 0,done numeric(1) DEFAULT 0,userid numeric(7) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_d_htrathuocll PRIMARY KEY (id),CONSTRAINT fk_d_htrathuocll_btdbn FOREIGN KEY (mabn) REFERENCES " + usr + ".btdbn (mabn) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;\n";
                s_sql += "CREATE TABLE " + schema + ".d_htrathuocct(id numeric NOT NULL DEFAULT 0,stt numeric(3) NOT NULL DEFAULT 0,sttt numeric DEFAULT 0,ngay timestamp,makho numeric(5) DEFAULT 0,mabd numeric(10) DEFAULT 0,soluong numeric(12,4) DEFAULT 0,giaban numeric(11) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_d_htrathuocct PRIMARY KEY (id, stt),CONSTRAINT fk_d_htrathuocct_d_dmbd FOREIGN KEY (mabd) REFERENCES " + usr + ".d_dmbd (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_htrathuocct_d_dmkho FOREIGN KEY (makho) REFERENCES " + usr + ".d_dmkho (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_htrathuocct_d_htrathuocll FOREIGN KEY (id) REFERENCES " + schema + ".d_htrathuocll (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;\n";

                s_sql += "CREATE TABLE " + schema + ".d_theodoi(id numeric DEFAULT 0,mabd numeric(10) DEFAULT 0,manguon numeric(2) DEFAULT 0,nhomcc numeric(7) DEFAULT 0,handung varchar(10),losx varchar(20),sothe varchar(20), namsx varchar(10), namsd varchar(10),baohanh numeric(7) DEFAULT 0,nguongoc numeric(2) DEFAULT 0,tinhtrang numeric(2) DEFAULT 0,giamua numeric(24,10) DEFAULT 0,giaban numeric(15,4) DEFAULT 0,chietkhau numeric(5, 2) DEFAULT 0,giaban2 numeric(15,4) DEFAULT 0,gianovat numeric(24,10) DEFAULT 0,tyle_ggia numeric(5, 2) DEFAULT 0,st_ggia numeric(24,10) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_d_thedoi PRIMARY KEY (id) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_d_theodoi_d_dmbd FOREIGN KEY (mabd) REFERENCES " + usr + ".d_dmbd (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_theodoi_d_dmnguon FOREIGN KEY (manguon) REFERENCES " + usr + ".d_dmnguon (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_theodoi OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".bhytds(mabn varchar(" + i_maxlength_mabn + "),hoten text,namsinh varchar(4),diachi text,CONSTRAINT pk_bhytds PRIMARY KEY (mabn) USING INDEX TABLESPACE medi_index)WITH OIDS;ALTER TABLE " + schema + ".bhytds OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".bhytkb(id numeric NOT NULL DEFAULT 0,nhom numeric(2) DEFAULT 0,quyenso numeric(7) DEFAULT 0,sobienlai numeric(10) DEFAULT 0,ngay timestamp,mabn varchar(" + i_maxlength_mabn + "),mavaovien numeric DEFAULT 0,maql numeric NOT NULL DEFAULT 0,makp varchar(" + i_maxlength_makp + "),chandoan text,maicd varchar(128),mabs varchar(4),sothe varchar(20),maphu numeric(2) DEFAULT 0,mabv varchar(10),traituyen numeric(1) default 0,congkham numeric(10) DEFAULT 0,thuoc numeric(15,4) DEFAULT 0,cls numeric(10) DEFAULT 0,bntra numeric(15,4) DEFAULT 0,bhyttra numeric(15,4) DEFAULT 0,userid numeric(7) DEFAULT 0,ngayud timestamp DEFAULT now(),done numeric(1) DEFAULT 0,sotoa numeric(7) DEFAULT 0,loaiba numeric(1) DEFAULT 3,bhytghichu text,CONSTRAINT pk_bhytkb PRIMARY KEY (id) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_bhytkb_bhytds FOREIGN KEY (mabn)  REFERENCES " + schema + ".bhytds (mabn) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".bhytkb OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".bhytthuoc(id numeric DEFAULT 0,stt numeric(3) DEFAULT 0,sttt numeric DEFAULT 0,makho numeric(5) DEFAULT 0,mabd numeric(10) DEFAULT 0,soluong numeric(12,4) DEFAULT 0,cachdung text,giaban numeric DEFAULT 0,gia_bh numeric(18,4) default 0,bhytduyet numeric(1) default 1,ketoan numeric(20) default 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_bhytthuoc PRIMARY KEY (id, stt) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_bhytthuoc_bhytkb FOREIGN KEY (id) REFERENCES " + schema + ".bhytkb (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_bhytthuoc_d_dmbd FOREIGN KEY (mabd) REFERENCES " + usr + ".d_dmbd (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".bhytthuoc OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".bhytcls(id numeric DEFAULT 0,stt numeric(3) DEFAULT 0,mavp numeric(10) DEFAULT 0,soluong numeric(7,2) DEFAULT 0,dongia numeric DEFAULT 0,idchidinh numeric DEFAULT 0,bhytduyet numeric(1) default 1,ngayud timestamp DEFAULT now(),CONSTRAINT pk_bhytcls PRIMARY KEY (id, stt) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_bhytcls_bhytkb FOREIGN KEY (id) REFERENCES " + schema + ".bhytkb (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_bhytcls_v_giavp FOREIGN KEY (mavp) REFERENCES " + usr + ".v_giavp (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".bhytcls OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_capsotoa(id numeric(2) NOT NULL DEFAULT 0,ngay timestamp NOT NULL,loai numeric(2) NOT NULL DEFAULT 0,sotoa numeric(7) DEFAULT 0,userid numeric(7) default 0,CONSTRAINT pk_d_capsotoa PRIMARY KEY (id, loai, ngay,userid) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".d_capsotoa OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_chandoan(id numeric NOT NULL DEFAULT 0,loai numeric(1) NOT NULL DEFAULT 0,maicd varchar(9) NOT NULL,chandoan text,CONSTRAINT pk_d_chandoan PRIMARY KEY (id, loai, maicd) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".d_chandoan OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_chuyenll(id numeric NOT NULL DEFAULT 0,nhom numeric(2) DEFAULT 0,sophieu varchar(10),ngay timestamp,lydo text,userid numeric(7) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_d_chuyenll PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".d_chuyenll OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_chuyenct(id numeric NOT NULL DEFAULT 0,stt numeric(5) NOT NULL DEFAULT 0,sttt numeric DEFAULT 0,makho numeric(5) DEFAULT 0,mabd numeric(10) DEFAULT 0,soluong numeric(12,4) DEFAULT 0,nguonchuyen numeric(2) DEFAULT 0,stttchuyen numeric DEFAULT 0,ketoan numeric(20) default 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_d_chuyenct PRIMARY KEY (id, stt) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_d_chuyenct_d_chuyenll FOREIGN KEY (id) REFERENCES " + schema + ".d_chuyenll (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_chuyenct_d_dmbd FOREIGN KEY (mabd) REFERENCES " + usr + ".d_dmbd (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_chuyenct_d_dmkho FOREIGN KEY (makho) REFERENCES " + usr + ".d_dmkho (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_chuyenct_d_dmnguon FOREIGN KEY (nguonchuyen) REFERENCES " + usr + ".d_dmnguon (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_chuyenct_d_theodoi FOREIGN KEY (sttt) REFERENCES " + schema + ".d_theodoi (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_chuyenct OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_ctghisoll(id numeric NOT NULL DEFAULT 0,nhom numeric(2) DEFAULT 0,soct varchar(10),ngay timestamp,userid numeric(7) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_d_ctghisoll PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".d_ctghisoll OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_ctghisoct(id numeric NOT NULL DEFAULT 0,makho numeric(5) NOT NULL DEFAULT 0,makp numeric(6) NOT NULL DEFAULT 0,no varchar(10),co varchar(10),sotien numeric(15,4) DEFAULT 0,diengiai text,CONSTRAINT pk_d_ctghisoct PRIMARY KEY (id, makho, makp) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_d_ctghisoct_d_ctghisoll FOREIGN KEY (id) REFERENCES " + schema + ".d_ctghisoll (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_ctghisoct_d_dmkho FOREIGN KEY (makho) REFERENCES " + usr + ".d_dmkho (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_ctghisoct_d_duockp FOREIGN KEY (makp) REFERENCES " + usr + ".d_duockp (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_ctghisoct OWNER TO " + owner + ";\n";//gam 02/02/12 sửa \"no\"
                s_sql += "CREATE TABLE " + schema + ".d_dutrucapll(id numeric NOT NULL DEFAULT 0,nhom numeric(2) DEFAULT 0,sophieu varchar(10),ngay timestamp,loai varchar(2),khox numeric(5) DEFAULT 0,khon numeric(5) DEFAULT 0,userid numeric(7) DEFAULT 0,ngayud timestamp DEFAULT now(),done numeric(1) DEFAULT 0,CONSTRAINT pk_d_dutrucapll PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".d_dutrucapll OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_dutrucapct(id numeric NOT NULL DEFAULT 0,manguon numeric(2) NOT NULL DEFAULT 0,mabd numeric(6) NOT NULL DEFAULT 0,slyeucau numeric(12,4) DEFAULT 0,slthuc numeric(12,4) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_d_dutrucapct PRIMARY KEY (id, mabd, manguon) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_d_dutrucapct_d_dmbd FOREIGN KEY (mabd) REFERENCES " + usr + ".d_dmbd (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_dutrucapct_d_dmnguon FOREIGN KEY (manguon) REFERENCES " + usr + ".d_dmnguon (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_dutrucapct_d_dutrucapll FOREIGN KEY (id) REFERENCES " + schema + ".d_dutrucapll (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_dutrucapct OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_huybanll(id numeric NOT NULL DEFAULT 0,nhom numeric(2) DEFAULT 0,mabn varchar(" + i_maxlength_mabn + "),hoten text,namsinh varchar(4),ngay timestamp,mabs varchar(4),makp numeric(6) DEFAULT 0,loai numeric(2) DEFAULT 0,done numeric(1) DEFAULT 0,userid numeric(7) DEFAULT 0,ngayud timestamp DEFAULT now(),lanin numeric(2) DEFAULT 0,sotoa numeric(7) DEFAULT 0,maql numeric DEFAULT 0,idduyet numeric(3) DEFAULT 0,CONSTRAINT pk_d_huybanll PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".d_huybanll OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_huybanct(id numeric NOT NULL DEFAULT 0,stt numeric(3) NOT NULL DEFAULT 0,sttt numeric DEFAULT 0,makho numeric(5) DEFAULT 0,mabd numeric(10) DEFAULT 0,soluong numeric(12,4) DEFAULT 0,giaban numeric DEFAULT 0,madoituong numeric(2) default 1,paid numeric(1) default 1,idttrv numeric default 0,ketoan numeric(20) default 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_d_huybanct PRIMARY KEY (id, stt) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_d_huybanct_d_dmbd FOREIGN KEY (mabd) REFERENCES " + usr + ".d_dmbd (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_huybanct_d_dmkho FOREIGN KEY (makho) REFERENCES " + usr + ".d_dmkho (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_huybanct_d_huybanll FOREIGN KEY (id) REFERENCES " + schema + ".d_huybanll (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_huybanct_d_theodoi FOREIGN KEY (sttt) REFERENCES " + schema + ".d_theodoi (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_huybanct OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_ngtrull(id numeric NOT NULL DEFAULT 0,nhom numeric(2) DEFAULT 0,mabn varchar(" + i_maxlength_mabn + "),hoten text,namsinh varchar(4),ngay timestamp,mabs varchar(4),makp numeric(6) DEFAULT 0,loai numeric(2) DEFAULT 0,done numeric(1) DEFAULT 0,lanin numeric(2) DEFAULT 0,sotoa numeric(7) DEFAULT 0,maql numeric DEFAULT 0,idduyet numeric(3) DEFAULT 0,diachi text,ghichu text,songay numeric(5) default 0,userid numeric(7) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_d_ngtrull PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".d_ngtrull OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_ngtruct(id numeric NOT NULL DEFAULT 0,stt numeric(3) NOT NULL DEFAULT 0,sttt numeric DEFAULT 0,makho numeric(5) DEFAULT 0,mabd numeric(10) DEFAULT 0,soluong numeric(12,4) DEFAULT 0,giaban numeric DEFAULT 0,madoituong numeric(2) default 1,paid numeric(1) default 1,idttrv numeric default 0,ketoan numeric(20) default 0,ngayud timestamp DEFAULT now(), cachdung text,CONSTRAINT pk_d_ngtruct PRIMARY KEY (id, stt) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_d_ngtruct_d_dmbd FOREIGN KEY (mabd)  REFERENCES " + usr + ".d_dmbd (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_ngtruct_d_dmkho FOREIGN KEY (makho) REFERENCES " + usr + ".d_dmkho (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_ngtruct_d_ngtrull FOREIGN KEY (id) REFERENCES " + schema + ".d_ngtrull (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_ngtruct_d_theodoi FOREIGN KEY (sttt) REFERENCES " + schema + ".d_theodoi (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_ngtruct OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_bienlai(id numeric NOT NULL DEFAULT 0,sohieu varchar(20),sobienlai numeric(10) DEFAULT 0,sotien numeric(15,4) DEFAULT 0,CONSTRAINT pk_d_bienlai PRIMARY KEY (id) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_d_bienlai_d_ngtrull FOREIGN KEY (id) REFERENCES " + schema + ".d_ngtrull (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_bienlai OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_nhapll(id numeric NOT NULL DEFAULT 0,nhom numeric(2) DEFAULT 0,sophieu varchar(10),ngaysp timestamp,sohd text,ngayhd timestamp,bbkiem varchar(15),ngaykiem timestamp,loai varchar(1),nguoigiao text,madv numeric(7) DEFAULT 0,makho numeric(5) DEFAULT 0,manguon numeric(2) DEFAULT 0,nhomcc numeric(7) DEFAULT 0,no text,co varchar(10),userid numeric(7) DEFAULT 0,ngayud timestamp DEFAULT now(),paid numeric(1) DEFAULT 0,lydo numeric(2) DEFAULT 0,chietkhau numeric(5, 2) DEFAULT 0,lanin numeric(3) default 0,ketoan numeric(20) default 0,CONSTRAINT pk_d_nhapll PRIMARY KEY (id) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_d_nhapll_d_dmkho FOREIGN KEY (makho) REFERENCES " + usr + ".d_dmkho (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_nhapll_d_dmnguon FOREIGN KEY (manguon) REFERENCES " + usr + ".d_dmnguon (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_nhapll OWNER TO " + owner + ";\n";//gam 02/02/2012 sửa \"no\"
                s_sql += "CREATE TABLE " + schema + ".d_nhapct(id numeric NOT NULL DEFAULT 0,stt numeric(3) NOT NULL DEFAULT 0,mabd numeric(10) DEFAULT 0,handung varchar(10),losx varchar(20),vat numeric(3) DEFAULT 0,soluong numeric(12,4) DEFAULT 0,dongia numeric(24,10) DEFAULT 0,sotien numeric(15,4) DEFAULT 0,giaban numeric DEFAULT 0,giamua numeric(24,10) DEFAULT 0,sl1 numeric(12,4) DEFAULT 0,sl2 numeric(5) DEFAULT 0,tyle numeric(7,2) DEFAULT 0,cuocvc numeric(15,4) DEFAULT 0,chaythu numeric(15,4) DEFAULT 0,tailieu text,giabancu numeric DEFAULT 0,namsx varchar(10),baohanh numeric(7) DEFAULT 0,nguongoc numeric(2) DEFAULT 0,tinhtrang numeric(2) DEFAULT 0,sothe varchar(20),giamuacu numeric(24,10) DEFAULT 0,giaban2 numeric(11, 0) DEFAULT 0,tyle2 numeric(7,2) DEFAULT 0,tyle_ggia numeric(5, 2) DEFAULT 0,st_ggia numeric(24,10) DEFAULT 0,chietkhau numeric(5, 2) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_d_nhapct PRIMARY KEY (id, stt) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_d_nhapct_d_dmbd FOREIGN KEY (mabd) REFERENCES " + usr + ".d_dmbd (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_nhapct_d_nhapll FOREIGN KEY (id) REFERENCES " + schema + ".d_nhapll (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_nhapct OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_nhapbbll(id numeric NOT NULL DEFAULT 0,nhom numeric(2) DEFAULT 0,sophieu varchar(10),ngaysp timestamp,sohd text,ngayhd timestamp,bbkiem varchar(15),ngaykiem timestamp,loai varchar(1),nguoigiao varchar(30),madv numeric(7) DEFAULT 0,makho numeric(5) DEFAULT 0,manguon numeric(2) DEFAULT 0,nhomcc numeric(4) DEFAULT 0,no text,co varchar(10),userid numeric(7) DEFAULT 0,ngayud timestamp DEFAULT now(),paid numeric(1) DEFAULT 0,lydo numeric(2) DEFAULT 0,chietkhau numeric(5, 2) DEFAULT 0,CONSTRAINT pk_d_nhapbbll PRIMARY KEY (id) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_d_nhapbbll_d_dmkho FOREIGN KEY (makho) REFERENCES " + usr + ".d_dmkho (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_nhapbbll_d_dmnguon FOREIGN KEY (manguon) REFERENCES " + usr + ".d_dmnguon (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_nhapbbll_d_dmnx FOREIGN KEY (madv) REFERENCES " + usr + ".d_dmnx (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_nhapbbll_d_dmnx_cc FOREIGN KEY (nhomcc) REFERENCES " + usr + ".d_dmnx (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_nhapbbll OWNER TO " + owner + ";\n";//gam 02/02/2012 sửa \"no\"
                s_sql += "CREATE TABLE " + schema + ".d_nhapbbct(id numeric NOT NULL DEFAULT 0,stt numeric(3) NOT NULL DEFAULT 0,mabd numeric(10) DEFAULT 0,handung varchar(10),losx varchar(20),vat numeric(3) DEFAULT 0,soluong numeric(12,4) DEFAULT 0,dongia numeric(15,4) DEFAULT 0,sotien numeric(15,4) DEFAULT 0,giaban numeric DEFAULT 0,giamua numeric(24,10) DEFAULT 0,sl1 numeric(12,4) DEFAULT 0,sl2 numeric(5) DEFAULT 0,tyle numeric(7,2) DEFAULT 0,cuocvc numeric(15,4) DEFAULT 0,chaythu numeric(15,4) DEFAULT 0,tailieu text,giabancu numeric DEFAULT 0,namsx varchar(10),baohanh numeric(7) DEFAULT 0,nguongoc numeric(2) DEFAULT 0,tinhtrang numeric(2) DEFAULT 0,sothe varchar(20),giamuacu numeric(24,10) DEFAULT 0,giaban2 numeric(11, 0) DEFAULT 0,tyle2 numeric(7,2) DEFAULT 0,tyle_ggia numeric(5, 2) DEFAULT 0,st_ggia numeric(24,10) DEFAULT 0,chietkhau numeric(5, 2) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_d_nhapbbct PRIMARY KEY (id, stt) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_d_nhapbbct_d_dmbd FOREIGN KEY (mabd) REFERENCES " + usr + ".d_dmbd (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_nhapbbct_d_nhapll FOREIGN KEY (id) REFERENCES " + schema + ".d_nhapbbll (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_nhapbbct OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_nhapct2(id numeric NOT NULL DEFAULT 0,stt numeric(3) NOT NULL DEFAULT 0,mabd numeric(10) NOT NULL DEFAULT 0,soluong numeric(12,4) DEFAULT 0,sotien numeric(15,4) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_d_nhapct2 PRIMARY KEY (id, mabd, stt) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_d_nhapct2_d_dmbd FOREIGN KEY (mabd) REFERENCES " + usr + ".d_dmbd (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_nhapct2_d_nhapll FOREIGN KEY (id) REFERENCES " + schema + ".d_nhapll (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_nhapct2 OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_nhapslll(id numeric NOT NULL DEFAULT 0,nhom numeric(2) DEFAULT 0,sophieu varchar(10),ngaysp timestamp,sohd text,ngayhd timestamp,loai varchar(1),nguoigiao varchar(30),madv numeric(7) DEFAULT 0,makho numeric(5) DEFAULT 0,done numeric(1) DEFAULT 0,userid numeric(7) DEFAULT 0,ngayud timestamp DEFAULT now(), CONSTRAINT pk_d_nhapslll PRIMARY KEY (id) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_d_nhapslll_d_dmkho FOREIGN KEY (makho) REFERENCES " + usr + ".d_dmkho (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_nhapslll_d_dmnx FOREIGN KEY (madv) REFERENCES " + usr + ".d_dmnx (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_nhapslll OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_nhapslct(id numeric NOT NULL DEFAULT 0,stt numeric(3) NOT NULL DEFAULT 0,mabd numeric(10) DEFAULT 0,handung varchar(10),losx varchar(20),soluong numeric(12,4) DEFAULT 0,sl1 numeric(12,4) DEFAULT 0,sl2 numeric(5) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_d_nhapslct PRIMARY KEY (id, stt) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_d_nhapslct_d_dmbd FOREIGN KEY (mabd) REFERENCES " + usr + ".d_dmbd (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_nhapslct_d_nhapslll FOREIGN KEY (id) REFERENCES " + schema + ".d_nhapslll (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_nhapslct OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_phieuxuat(id numeric NOT NULL DEFAULT 0,soct varchar(10),ngay timestamp,makp numeric(6) DEFAULT 0,nhom numeric(2) DEFAULT 0,loai varchar(10),phieu varchar(20),kho varchar(20),sotien numeric(15,4) DEFAULT 0,no varchar(20),co varchar(20),diengiai text,userid numeric(7) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_d_phieuxuat PRIMARY KEY (id) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_d_phieuxuat_d_duockp FOREIGN KEY (makp) REFERENCES " + usr + ".d_duockp (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_phieuxuat OWNER TO " + owner + ";\n";//gam 02/02/2012 sửa \"no\"
                s_sql += "CREATE TABLE " + schema + ".d_sophieu(nhom numeric(2) NOT NULL DEFAULT 0,ngay timestamp NOT NULL,makp numeric(6) NOT NULL DEFAULT 0,loai numeric(2) NOT NULL DEFAULT 0,phieu numeric(3) NOT NULL DEFAULT 0,loaiin numeric(2) NOT NULL DEFAULT 0,makho numeric(5) NOT NULL DEFAULT 0,madoituong text,so numeric(10) DEFAULT 0,lanin numeric(3) DEFAULT 0,manguon text NOT NULL,nguoilinh text,CONSTRAINT pk_d_sophieu PRIMARY KEY (loai, loaiin, madoituong, makho, makp, manguon,ngay, nhom, phieu) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_d_sophieu_d_dmkho FOREIGN KEY (makho)  REFERENCES " + usr + ".d_dmkho (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_sophieu_d_dmphieu FOREIGN KEY (loai) REFERENCES " + usr + ".d_dmphieu (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_sophieu_d_duockp FOREIGN KEY (makp) REFERENCES " + usr + ".d_duockp (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_sophieu_d_loaiphieu FOREIGN KEY (phieu) REFERENCES " + usr + ".d_loaiphieu (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_sophieu OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_thanhtoan(id numeric NOT NULL DEFAULT 0,ngay timestamp DEFAULT now(),no varchar(100),co varchar(10),sotien numeric(15,4) DEFAULT 0,datra numeric(15,4) DEFAULT 0,lanin numeric(2) default 0,userid numeric(7) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_d_thanhtoan PRIMARY KEY (id) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_d_thanhtoan_d_nhapll FOREIGN KEY (id) REFERENCES " + schema + ".d_nhapll (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_thanhtoan OWNER TO " + owner + ";\n";//gam 02/02/2012 sửa \"no\"
                s_sql += "create table " + schema + ".d_thanhtoanct(id numeric,stt numeric(3),so varchar(50),ngay timestamp,no varchar(100),co varchar(50),sotien numeric(18,4) default 0,ghichu text,ketoan numeric(20) default 0,ngayct timestamp default now(),userid numeric(7) default 0,ngayud timestamp default now(),constraint pk_d_thanhtoanct primary key(id,stt) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_d_thanhtoanct_d_thanhtoan FOREIGN KEY (id)      REFERENCES " + schema + ".d_thanhtoan (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_thanhtoanct OWNER TO " + owner + ";\n";//gam 02/02/2012 sửa \"no\"
                s_sql += "CREATE TABLE " + schema + ".d_theodoigia(mabd numeric(10) NOT NULL DEFAULT 0,ngay timestamp NOT NULL,dongia numeric(24,10) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_d_theodoigia PRIMARY KEY (mabd, ngay) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_d_theodoigia_d_dmbd FOREIGN KEY (mabd)REFERENCES " + usr + ".d_dmbd (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_theodoigia OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_theodoitscd(nam numeric(4) NOT NULL DEFAULT 0,sttt numeric NOT NULL DEFAULT 0,tyle numeric(7,2) DEFAULT 0,phanloai numeric(2) DEFAULT 0,phutrach text,chucdanh text,daotao text,coquan text,tailieu text,quyetdinh text,ngay timestamp,tuoitho text,baotri numeric(7) default 0,tinhhinh text,khauhao text,tiettrung numeric(7) default 0,canchinh numeric(7) default 0,CONSTRAINT pk_d_theodoitscd PRIMARY KEY (sttt) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_d_theodoitscd_d_theodoi FOREIGN KEY (sttt) REFERENCES " + schema + ".d_theodoi (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_theodoitscd OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_tienthuoc(id numeric,mabn varchar(" + i_maxlength_mabn + ") NOT NULL,mavaovien numeric DEFAULT 0,maql numeric NOT NULL DEFAULT 0,idkhoa numeric NOT NULL DEFAULT 0,ngay timestamp NOT NULL,makp numeric(6) NOT NULL DEFAULT 0,madoituong numeric(2) NOT NULL DEFAULT 0,mabd numeric(10) NOT NULL DEFAULT 0,soluong numeric(12,4) DEFAULT 0,giaban numeric DEFAULT 0,giamua numeric(24,10) NOT NULL DEFAULT 0,gianovat numeric(24,10) NOT NULL DEFAULT 0,done numeric(1) DEFAULT 0,idttrv numeric default 0,datra numeric(24,10) default 0, traituyen numeric(1) default 0,CONSTRAINT pk_d_tienthuoc PRIMARY KEY (id,mabn,maql, idkhoa, ngay, makp, madoituong, mabd, giamua, done) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_d_tienthuoc_btdbn FOREIGN KEY (mabn) REFERENCES " + usr + ".btdbn (mabn) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_tienthuoc_d_dmbd FOREIGN KEY (mabd) REFERENCES " + usr + ".d_dmbd (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_tienthuoc_d_duockp FOREIGN KEY (makp) REFERENCES " + usr + ".d_duockp (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_tienthuoc OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_tonkhoct(makho numeric(5) NOT NULL DEFAULT 0,stt numeric NOT NULL DEFAULT 0,idn numeric DEFAULT 0,sttn numeric(3) DEFAULT 0,mabd numeric(10) DEFAULT 0,tondau numeric(12,4) DEFAULT 0,slnhap numeric(12,4) DEFAULT 0,slxuat numeric(12,4) DEFAULT 0,CONSTRAINT pk_d_tonkhoct PRIMARY KEY (makho,stt) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_d_tonkhoct_d_dmbd FOREIGN KEY (mabd) REFERENCES " + usr + ".d_dmbd (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_tonkhoct_d_dmkho FOREIGN KEY (makho) REFERENCES " + usr + ".d_dmkho (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_tonkhoct_d_theodoi FOREIGN KEY (stt) REFERENCES " + schema + ".d_theodoi (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_tonkhoct OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_tonkhokemtheo(makhot numeric(3) NOT NULL DEFAULT 0,sttt numeric NOT NULL DEFAULT 0,makho numeric(5) NOT NULL DEFAULT 0,stt numeric NOT NULL DEFAULT 0,idn numeric DEFAULT 0,sttn numeric(3) DEFAULT 0,mabd numeric(10) DEFAULT 0,tondau numeric(12,4) DEFAULT 0,slnhap numeric(12,4) DEFAULT 0,slxuat numeric(12,4) DEFAULT 0,giamua numeric(24,10) DEFAULT 0,CONSTRAINT pk_d_tonkhokemtheo PRIMARY KEY (makho, makhot, stt, sttt) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_d_tonkhokemtheo_d_dmbd FOREIGN KEY (mabd) REFERENCES " + usr + ".d_dmbd (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_tonkhokemtheo_d_dmkho FOREIGN KEY (makhot) REFERENCES " + usr + ".d_dmkho (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_tonkhokemtheo_d_theodoi FOREIGN KEY (sttt) REFERENCES " + schema + ".d_theodoi (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_tonkhokemtheo OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_tonkhoth(makho numeric(5) NOT NULL DEFAULT 0,mabd numeric(10) NOT NULL DEFAULT 0,tondau numeric(12,4) DEFAULT 0,slnhap numeric(12,4) DEFAULT 0,slxuat numeric(12,4) DEFAULT 0,slyeucau numeric(12,4) DEFAULT 0,manguon numeric(2) NOT NULL DEFAULT 0,CONSTRAINT pk_d_tonkhoth PRIMARY KEY (mabd, makho, manguon) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_d_tonkhoth_d_dmbd FOREIGN KEY (mabd) REFERENCES " + usr + ".d_dmbd (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_tonkhoth_d_dmkho FOREIGN KEY (makho) REFERENCES " + usr + ".d_dmkho (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_tonkhoth_d_dmnguon FOREIGN KEY (manguon) REFERENCES " + usr + ".d_dmnguon (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_tonkhoth OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_tutrucct(makp numeric(6) NOT NULL DEFAULT 0,makho numeric(5) NOT NULL DEFAULT 0,stt numeric NOT NULL DEFAULT 0,mabd numeric(10) DEFAULT 0,tondau numeric(12,4) DEFAULT 0,slnhap numeric(12,4) DEFAULT 0,slxuat numeric(12,4) DEFAULT 0,CONSTRAINT pk_d_tutrucct PRIMARY KEY (makho, makp,stt) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_d_tutrucct_d_dmbd FOREIGN KEY (mabd) REFERENCES " + usr + ".d_dmbd (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_tutrucct_d_dmkho FOREIGN KEY (makho) REFERENCES " + usr + ".d_dmkho (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_tutrucct_d_duockp FOREIGN KEY (makp) REFERENCES " + usr + ".d_duockp (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_tutrucct_d_theodoi FOREIGN KEY (stt) REFERENCES " + schema + ".d_theodoi (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_tutrucct OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_tutruckemtheo(makhot numeric(3) NOT NULL DEFAULT 0,sttt numeric NOT NULL DEFAULT 0,makp numeric(6) NOT NULL DEFAULT 0,makho numeric(5) NOT NULL DEFAULT 0,stt numeric NOT NULL DEFAULT 0,mabd numeric(10) DEFAULT 0,tondau numeric(12,4) DEFAULT 0,slnhap numeric(12,4) DEFAULT 0,slxuat numeric(12,4) DEFAULT 0,giamua numeric(24,10) DEFAULT 0,CONSTRAINT pk_d_tutruckemtheo PRIMARY KEY (makho, makhot, makp, stt, sttt) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_d_tutruckemtheo_d_dmbd FOREIGN KEY (mabd) REFERENCES " + usr + ".d_dmbd (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_tutruckemtheo_d_dmkho FOREIGN KEY (makhot) REFERENCES " + usr + ".d_dmkho (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_tutruckemtheo_d_duockp FOREIGN KEY (makp) REFERENCES " + usr + ".d_duockp (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_tutruckemtheo_d_theodoi FOREIGN KEY (sttt) REFERENCES " + schema + ".d_theodoi (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_tutruckemtheo OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_tutructh(makp numeric(6) NOT NULL DEFAULT 0,makho numeric(5) NOT NULL DEFAULT 0,mabd numeric(10) NOT NULL DEFAULT 0,tondau numeric(12,4) DEFAULT 0,slnhap numeric(12,4) DEFAULT 0,slxuat numeric(12,4) DEFAULT 0,slyeucau numeric(12,4) DEFAULT 0,manguon numeric(2) NOT NULL DEFAULT 0,CONSTRAINT pk_d_tutructh PRIMARY KEY (mabd, makho, makp, manguon) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_d_tutructh_d_dmbd FOREIGN KEY (mabd) REFERENCES " + usr + ".d_dmbd (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_tutructh_d_dmkho FOREIGN KEY (makho) REFERENCES " + usr + ".d_dmkho (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_tutructh_d_dmnguon FOREIGN KEY (manguon) REFERENCES " + usr + ".d_dmnguon (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_tutructh_d_duockp FOREIGN KEY (makp) REFERENCES " + usr + ".d_duockp (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_tutructh OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_xuatll(id numeric NOT NULL DEFAULT 0,nhom numeric(2) DEFAULT 0,sophieu varchar(10),ngay timestamp,loai varchar(2),khox numeric(5) DEFAULT 0,khon numeric(5) DEFAULT 0,lydo text,userid numeric(7) DEFAULT 0,ngayud timestamp DEFAULT now(),idduyet numeric DEFAULT 0,lanin numeric(3) default 0,CONSTRAINT pk_d_xuatll PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".d_xuatll OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_xuatct(id numeric NOT NULL DEFAULT 0,stt numeric(3) NOT NULL DEFAULT 0,sttt numeric DEFAULT 0,mabd numeric(10) DEFAULT 0,soluong numeric(12,4) DEFAULT 0,mabs varchar(4),hotenbn text,giaban numeric DEFAULT 0,ketoan numeric(20) default 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_d_xuatct PRIMARY KEY (id, stt) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_d_xuatct_d_dmbd FOREIGN KEY (mabd) REFERENCES " + usr + ".d_dmbd (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_xuatct_d_theodoi FOREIGN KEY (sttt) REFERENCES " + schema + ".d_theodoi (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_xuatct_d_xuatll FOREIGN KEY (id) REFERENCES " + schema + ".d_xuatll (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_xuatct OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_xuatsdll(id numeric NOT NULL DEFAULT 0,nhom numeric(2) DEFAULT 0,mabn varchar(" + i_maxlength_mabn + "),mavaovien numeric DEFAULT 0,maql numeric DEFAULT 0,idkhoa numeric DEFAULT 0,ngayylenh timestamp,ngay timestamp,loai numeric(2) DEFAULT 0,phieu numeric(3) DEFAULT 0,makp numeric(6) DEFAULT 0,userid numeric(7) DEFAULT 0,traituyen numeric(1) default 0,ngayud timestamp DEFAULT now(),idduyet numeric DEFAULT 0,thuoc numeric(1) DEFAULT 0,makhoa numeric(6) DEFAULT 0,lydo numeric(7) DEFAULT 0,lk numeric(1) DEFAULT 0,ghichu text,CONSTRAINT pk_d_xuatsdll PRIMARY KEY (id) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_d_xuatsdll_d_dmphieu FOREIGN KEY (loai)  REFERENCES " + usr + ".d_dmphieu (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_xuatsdll_d_duockp FOREIGN KEY (makp)  REFERENCES " + usr + ".d_duockp (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_xuatsdll_d_loaiphieu FOREIGN KEY (phieu) REFERENCES " + usr + ".d_loaiphieu (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_xuatsdll OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_xuatsdct(id numeric NOT NULL DEFAULT 0,stt numeric(4) NOT NULL DEFAULT 0,sttt numeric DEFAULT 0,madoituong numeric(2) DEFAULT 0,makho numeric(5) DEFAULT 0,mabd numeric(10) DEFAULT 0,soluong numeric(12,4) DEFAULT 0,sttduyet numeric(3) DEFAULT 0,giaban numeric DEFAULT 0,ngayud timestamp DEFAULT now(), sltra numeric(10,4) default 0,ngayylenh timestamp, gia_bh numeric default 0,CONSTRAINT pk_d_xuatsdct PRIMARY KEY (id, stt) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_d_xuatsdct_d_dmbd FOREIGN KEY (mabd) REFERENCES " + usr + ".d_dmbd (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_xuatsdct_d_dmkho FOREIGN KEY (makho) REFERENCES " + usr + ".d_dmkho (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_xuatsdct_d_theodoi FOREIGN KEY (sttt) REFERENCES " + schema + ".d_theodoi (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_xuatsdct_d_xuatsdll FOREIGN KEY (id) REFERENCES " + schema + ".d_xuatsdll (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_xuatsdct OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_bucstt(id numeric NOT NULL DEFAULT 0,stt numeric(3) NOT NULL DEFAULT 0,sttt numeric DEFAULT 0,makho numeric(5) DEFAULT 0,mabd numeric(10) DEFAULT 0,soluong numeric(12,4) DEFAULT 0,sttduyet numeric(3) DEFAULT 0,giaban numeric DEFAULT 0,sltreo numeric(12,4) default 0,madoituong numeric(2) default 1,ngayud timestamp DEFAULT now(),CONSTRAINT pk_d_bucstt PRIMARY KEY (id, stt) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_d_bucstt_d_dmbd FOREIGN KEY (mabd) REFERENCES " + usr + ".d_dmbd (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_bucstt_d_dmkho FOREIGN KEY (makho) REFERENCES " + usr + ".d_dmkho (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_bucstt_d_theodoi FOREIGN KEY (sttt) REFERENCES " + schema + ".d_theodoi (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_bucstt_d_xuatsdll FOREIGN KEY (id) REFERENCES " + schema + ".d_xuatsdll (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_bucstt OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_thucbucstt(id numeric NOT NULL DEFAULT 0,sttt numeric NOT NULL DEFAULT 0,makho numeric(5) NOT NULL DEFAULT 0,mabd numeric(10) DEFAULT 0,soluong numeric(12,4) DEFAULT 0,stt numeric(3) NOT NULL DEFAULT 0, giaban numeric DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_d_thucbucstt PRIMARY KEY (id, makho, stt, sttt) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_d_thucbucstt_d_dmbd FOREIGN KEY (mabd) REFERENCES " + usr + ".d_dmbd (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_thucbucstt_d_dmkho FOREIGN KEY (makho) REFERENCES " + usr + ".d_dmkho (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_thucbucstt_d_theodoi FOREIGN KEY (sttt) REFERENCES " + schema + ".d_theodoi (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_thucbucstt_d_xuatsdll FOREIGN KEY (id)  REFERENCES " + schema + ".d_xuatsdll (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_thucbucstt OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_thucxuat(id numeric NOT NULL DEFAULT 0,sttt numeric NOT NULL DEFAULT 0,madoituong numeric(2) NOT NULL DEFAULT 0,makho numeric(5) NOT NULL DEFAULT 0,mabd numeric(10) DEFAULT 0,soluong numeric(12,4) DEFAULT 0,stt numeric(4) NOT NULL DEFAULT 0,giaban numeric DEFAULT 0,ketoan numeric(20) default 0,ngayud timestamp DEFAULT now(), gia_bh numeric default 0, CONSTRAINT pk_d_thucxuat PRIMARY KEY (id, madoituong, makho, stt, sttt) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_d_thucxuat_d_dmbd FOREIGN KEY (mabd) REFERENCES " + usr + ".d_dmbd (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_thucxuat_d_dmkho FOREIGN KEY (makho) REFERENCES " + usr + ".d_dmkho (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_thucxuat_d_theodoi FOREIGN KEY (sttt) REFERENCES " + schema + ".d_theodoi (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_thucxuat_d_xuatsdll FOREIGN KEY (id) REFERENCES " + schema + ".d_xuatsdll (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_thucxuat OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_thucxuat2(id numeric NOT NULL DEFAULT 0,sttt numeric NOT NULL DEFAULT 0,makho numeric(5) NOT NULL DEFAULT 0,mabd numeric(10) DEFAULT 0,soluong numeric(12,4) DEFAULT 0,giamua numeric(24,10) DEFAULT 0,stt numeric(4) NOT NULL DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_d_thucxuat2 PRIMARY KEY (id, makho, stt, sttt) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_d_thucxuat2_d_dmbd FOREIGN KEY (mabd) REFERENCES " + usr + ".d_dmbd (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_thucxuat2_d_dmkho FOREIGN KEY (makho) REFERENCES " + usr + ".d_dmkho (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_thucxuat2_d_theodoi FOREIGN KEY (sttt) REFERENCES " + schema + ".d_theodoi (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_thucxuat2_d_xuatsdll FOREIGN KEY (id) REFERENCES " + schema + ".d_xuatsdll (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_thucxuat2 OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_kiemtra(nhom numeric(2) DEFAULT 0,ngay timestamp,userid numeric(7) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_d_kiemtra PRIMARY KEY (nhom,ngay) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".d_kiemtra OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_solankiemtra(makho numeric(5) NOT NULL DEFAULT 0,lan numeric(3) DEFAULT 0,userid numeric(7) NOT NULL DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_d_solankiemtra PRIMARY KEY (makho,userid) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_d_solankiemtra_d_dmkho FOREIGN KEY (makho) REFERENCES " + usr + ".d_dmkho (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_solankiemtra OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_solankiemtracstt(makp numeric(6) NOT NULL DEFAULT 0,makho numeric(5) NOT NULL DEFAULT 0,lan numeric(3) DEFAULT 0,userid numeric(7) NOT NULL DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_d_solankiemtracstt PRIMARY KEY (makho, makp,userid) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_d_solankiemtracstt_d_dmkho FOREIGN KEY (makho) REFERENCES " + usr + ".d_dmkho (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_solankiemtracstt_d_duockp FOREIGN KEY (makp) REFERENCES " + usr + ".d_duockp (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_solankiemtracstt OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_daduyet(nhom numeric(2) NOT NULL DEFAULT 0,ngay timestamp NOT NULL,makp numeric(6) NOT NULL DEFAULT 0,loai numeric(2) NOT NULL DEFAULT 0,phieu numeric(3) NOT NULL DEFAULT 0,makho numeric(5) NOT NULL DEFAULT 0,done numeric(1) not null default 0,duyettreole numeric(1) default 0,ngayud timestamp NOT NULL DEFAULT now(),CONSTRAINT fk_d_daduyet_d_dmkho FOREIGN KEY (makho) REFERENCES " + usr + ".d_dmkho (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_daduyet_d_dmphieu FOREIGN KEY (loai) REFERENCES " + usr + ".d_dmphieu (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_daduyet_d_duockp FOREIGN KEY (makp) REFERENCES " + usr + ".d_duockp (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_daduyet_d_loaiphieu FOREIGN KEY (phieu) REFERENCES " + usr + ".d_loaiphieu (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_daduyet_d_dmnhomkho FOREIGN KEY (nhom) REFERENCES " + usr + ".d_dmnhomkho (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".d_daduyet OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_duyetkho(idduyet numeric NOT NULL DEFAULT 0,makho numeric(5) NOT NULL DEFAULT 0,done numeric(1) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_d_duyetkho PRIMARY KEY (idduyet, makho) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".d_duyetkho OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".d_sophieukb(mabn varchar(" + i_maxlength_mabn + "),mavaovien numeric(22, 0) DEFAULT 0,ngay timestamp,madoituong numeric(2, 0) DEFAULT 0,so numeric(5, 0) DEFAULT 0,lanin numeric(5, 0) DEFAULT 0,ghichu text,userid numeric(5, 0) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_d_sophieukb PRIMARY KEY (mabn, mavaovien, ngay, madoituong) USING INDEX TABLESPACE medi_index) WITH OIDS;\n";

                s_sql += "CREATE TABLE " + schema + ".v_bhyt(id numeric NOT NULL DEFAULT 0,sothe varchar(20),maphu numeric(2) DEFAULT 0,mabv varchar(10),noigioithieu varchar(8),traituyen numeric(1) default 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_v_bhyt PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".v_bhyt OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".v_chidinh(id numeric NOT NULL DEFAULT 0,mabn varchar(" + i_maxlength_mabn + "),mavaovien numeric DEFAULT 0,maql numeric DEFAULT 0,idkhoa numeric DEFAULT 0,ngay timestamp,loai numeric(1) DEFAULT 0,makp varchar(" + i_maxlength_makp + "),madoituong numeric(2) DEFAULT 0,mavp numeric(10) DEFAULT 0,soluong numeric(10,2) DEFAULT 0,dongia numeric DEFAULT 0,paid numeric(1) DEFAULT 0,done numeric(1) DEFAULT 0,vattu numeric(10) DEFAULT 0,tinhtrang numeric(1) DEFAULT 0,thuchien numeric(1) DEFAULT 0,computer text,idchidinh numeric default 0,idttrv number(22) default 0,maicd varchar(9),chandoan text,mabs varchar(4),loaiba numeric(1) default 3,ngaythuchien timestamp,idtrongoi numeric(7) default 0,hide numeric(1) default 0,duyet numeric(1) default 1,ghichu text,userid numeric(7) DEFAULT 0, lan numeric(2) default 0,  traituyen numeric(1) default 0,tylegiam numeric(5,2) default 0, stgiam numeric default 0, lydogiam text,ngayud timestamp DEFAULT now(),CONSTRAINT pk_v_chidinh PRIMARY KEY (id) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_v_chidinh_btdbn FOREIGN KEY (mabn) REFERENCES " + usr + ".btdbn (mabn) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_v_chidinh_btdkp_bv FOREIGN KEY (makp) REFERENCES " + usr + ".btdkp_bv (makp) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_v_chidinh_v_giavp FOREIGN KEY (mavp) REFERENCES " + usr + ".v_giavp (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".v_chidinh OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".v_congno(mabn varchar(" + i_maxlength_mabn + "),mavaovien numeric DEFAULT 0,maql numeric NOT NULL DEFAULT 0,idkhoa numeric NOT NULL DEFAULT 0,mavp numeric(10) NOT NULL DEFAULT 0,sotien numeric(15,4) DEFAULT 0,dathu numeric(15,4) DEFAULT 0,CONSTRAINT pk_v_congno PRIMARY KEY (idkhoa, maql, mavp) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_v_congno_btdbn FOREIGN KEY (mabn) REFERENCES " + usr + ".btdbn (mabn) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".v_congno OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".v_giuong(id numeric NOT NULL DEFAULT 0,mavp numeric(10) NOT NULL DEFAULT 0,ngay timestamp NOT NULL,dongia numeric DEFAULT 0,CONSTRAINT pk_v_giuong PRIMARY KEY (id, mavp, ngay) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".v_giuong OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".v_hoantra(id numeric NOT NULL DEFAULT 0,quyenso numeric(7) DEFAULT 0,sobienlai numeric(10) DEFAULT 0,ngay timestamp,mabn varchar(" + i_maxlength_mabn + "),mavaovien numeric DEFAULT 0,maql numeric DEFAULT 0,hoten text,makp varchar(" + i_maxlength_makp + "),sotien numeric(15,4) DEFAULT 0,ghichu text,ketoan numeric(20) default 0,userid numeric(7) DEFAULT 0,ngayud timestamp DEFAULT now(),loai numeric(1) DEFAULT 0,loaibn numeric(2) DEFAULT 0,CONSTRAINT pk_v_hoantra PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".v_hoantra OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".v_hoantract(id numeric NOT NULL DEFAULT 0,loaivp numeric(7) NOT NULL DEFAULT 0,sotien numeric(15,4) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_v_hoantract PRIMARY KEY (id, loaivp) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_v_hoantract_v_hoantra FOREIGN KEY (id) REFERENCES " + schema + ".v_hoantra (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT)WITH OIDS;ALTER TABLE " + schema + ".v_hoantract OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".v_mienngtru(id numeric NOT NULL DEFAULT 0,sotien numeric(15,4) DEFAULT 0,ghichu text,maduyet numeric(4) DEFAULT 0,lydo numeric(2) DEFAULT 0,CONSTRAINT pk_v_mienngtru PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".v_mienngtru OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".v_miennoitru(id numeric NOT NULL DEFAULT 0,lydo numeric(2) DEFAULT 0,ghichu text,maduyet numeric(4) DEFAULT 0,CONSTRAINT pk_v_miennoitru PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".v_miennoitru OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".v_nhom(id numeric NOT NULL DEFAULT 0,ma numeric(3) NOT NULL DEFAULT 0,sotien numeric(15,4) DEFAULT 0,CONSTRAINT pk_v_nhom PRIMARY KEY (id, ma) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".v_nhom OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".v_phieuchill(id numeric NOT NULL DEFAULT 0,quyenso numeric(7) DEFAULT 0,sobienlai numeric(10) DEFAULT 0,ngay timestamp,mabn varchar(" + i_maxlength_mabn + "),maql numeric DEFAULT 0,idkhoa numeric DEFAULT 0,makp varchar(" + i_maxlength_makp + "),hoten text,loai numeric(2) DEFAULT 0,loaibn numeric(2) DEFAULT 0,ketoan numeric(20) default 0,userid numeric(7) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_v_phieuchill PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".v_phieuchill OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".v_phieuchict(id numeric NOT NULL DEFAULT 0,stt numeric(3) NOT NULL DEFAULT 0,mavp numeric(10) DEFAULT 0,sotien numeric(15,4) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_v_phieuchict PRIMARY KEY (id, stt) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_v_phieuchict_v_phieuchill FOREIGN KEY (id) REFERENCES " + schema + ".v_phieuchill (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".v_phieuchict OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".v_tamung(id numeric NOT NULL DEFAULT 0,mabn varchar(" + i_maxlength_mabn + "),mavaovien numeric DEFAULT 0,maql numeric DEFAULT 0,idkhoa numeric DEFAULT 0,quyenso numeric(7) DEFAULT 0,sobienlai numeric(10) DEFAULT 0,ngay timestamp,loai numeric(1) DEFAULT 0,makp varchar(" + i_maxlength_makp + "),madoituong numeric(2) DEFAULT 0,sotien numeric(15,4) DEFAULT 0,ketoan numeric(20) default 0,done numeric(1) DEFAULT 0,lanin numeric(2) DEFAULT 0,loaibn numeric(2) DEFAULT 0,idttrv numeric DEFAULT 0,datru numeric(15,4) default 0,userid numeric(7) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_v_tamung PRIMARY KEY (id) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_v_tamung_btdbn FOREIGN KEY (mabn) REFERENCES " + usr + ".btdbn (mabn) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_v_tamung_btdkp_bv FOREIGN KEY (makp) REFERENCES " + usr + ".btdkp_bv (makp) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".v_tamung OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".v_tontamung(id numeric NOT NULL DEFAULT 0,mabn varchar(" + 
                    i_maxlength_mabn + "),mavaovien numeric DEFAULT 0,maql numeric DEFAULT 0,"+
                    "idkhoa numeric DEFAULT 0,quyenso numeric(7) DEFAULT 0,sobienlai numeric(10) DEFAULT 0,"+
                    "ngay timestamp,loai numeric(1) DEFAULT 0,makp varchar(" + i_maxlength_makp + "),"+
                    "madoituong numeric(2) DEFAULT 0,sotien numeric(15,4) DEFAULT 0,ketoan numeric(20) default 0,"+
                    "done numeric(1) DEFAULT 0,lanin numeric(2) DEFAULT 0,loaibn numeric(2) DEFAULT 0,"+
                    "idttrv numeric DEFAULT 0,datru numeric(15,4) default 0,userid numeric(7) DEFAULT 0,"+
                    "ngayud timestamp DEFAULT now(),CONSTRAINT pk_v_tontamung PRIMARY KEY (id) USING INDEX "+
                    "TABLESPACE medi_index,CONSTRAINT fk_v_tontamung_btdbn FOREIGN KEY (mabn) REFERENCES " +
                    usr + ".btdbn (mabn) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT "+
                    "fk_v_tontamung_btdkp_bv FOREIGN KEY (makp) REFERENCES " + usr + 
                    ".btdkp_bv (makp) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT) WITHOUT OIDS;ALTER TABLE " + schema + ".v_tontamung OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".v_tamungct(id numeric NOT NULL DEFAULT 0,loaivp numeric(3) NOT NULL DEFAULT 0,sotien numeric(15,4) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_v_tamungct PRIMARY KEY (id, loaivp) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_v_tamungct_v_tamung FOREIGN KEY (id) REFERENCES " + schema + ".v_tamung (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".v_tamungct OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".v_thngayll(id numeric NOT NULL DEFAULT 0,madoituong numeric(2) DEFAULT 0,mabn varchar(" + i_maxlength_mabn + "),mavaovien numeric DEFAULT 0,maql numeric DEFAULT 0,ngayvao timestamp,tu timestamp,den timestamp,giuong varchar(20),makp varchar(" + i_maxlength_makp + "),conlai numeric(15,4) DEFAULT 0,sotien numeric(15,4) DEFAULT 0,datra numeric(15,4) DEFAULT 0,done numeric(1) DEFAULT 0,CONSTRAINT pk_v_thngayll PRIMARY KEY (id) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_v_thngayll_btdbn FOREIGN KEY (mabn) REFERENCES " + usr + ".btdbn (mabn) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_v_thngayll_btdkp_bv FOREIGN KEY (makp) REFERENCES " + usr + ".btdkp_bv (makp) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".v_thngayll OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".v_thngayct(id numeric NOT NULL DEFAULT 0,ngay timestamp NOT NULL,mavp numeric(10) NOT NULL DEFAULT 0,soluong numeric(12,4) DEFAULT 0,dongia numeric NOT NULL DEFAULT 0,sotien numeric(15,4) DEFAULT 0,CONSTRAINT pk_v_thngayct PRIMARY KEY (dongia, id, mavp, ngay) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_v_thngayct_v_thngayll FOREIGN KEY (id) REFERENCES " + schema + ".v_thngayll (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".v_thngayct OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".v_thvpll(id numeric NOT NULL DEFAULT 0,mabn varchar(" + i_maxlength_mabn + "),mavaovien numeric DEFAULT 0,maql numeric DEFAULT 0,idkhoa numeric DEFAULT 0,ngayvao timestamp,ngayra timestamp,giuong varchar(20),makp varchar(" + i_maxlength_makp + "),chandoan text,maicd text,sotien numeric(15,4) DEFAULT 0,tamung numeric(10) DEFAULT 0,bhyt numeric(15,4) DEFAULT 0,mien numeric(15,4) DEFAULT 0,done numeric(1) DEFAULT 0,idttrv numeric default 0,idthuoc text,CONSTRAINT pk_v_thvpll PRIMARY KEY (id) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_v_thvpll_btdbn FOREIGN KEY (mabn) REFERENCES " + usr + ".btdbn (mabn) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".v_thvpll OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".v_thvpct(id numeric NOT NULL DEFAULT 0,ngay timestamp NOT NULL,makp varchar(" + i_maxlength_makp + ") NOT NULL,madoituong numeric(2) NOT NULL DEFAULT 0,mavp numeric(10) NOT NULL DEFAULT 0,soluong numeric(12,4) DEFAULT 0,dongia numeric NOT NULL DEFAULT 0,sotien numeric(15,4) DEFAULT 0,vattu numeric(10) DEFAULT 0,sothe varchar(20),done numeric(1) default 0,idttrv numeric DEFAULT 0,traituyen numeric(1) default 0, ngayud timestamp DEFAULT now(),mabs varchar(4),CONSTRAINT pk_v_thvpct PRIMARY KEY (dongia, id, madoituong, makp, mavp, ngay, mabs ,sothe) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_v_thvpct_v_thvpll FOREIGN KEY (id) REFERENCES " + schema + ".v_thvpll (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".v_thvpct OWNER TO " + owner + ";\n";//linh 09062012
                s_sql += "CREATE TABLE " + schema + ".v_thvpbhyt(id numeric NOT NULL DEFAULT 0,sothe varchar(20),maphu numeric(7,2) DEFAULT 0,noigioithieu varchar(8),noicap varchar(8),traituyen numeric(1) default 0,CONSTRAINT pk_v_thvpbhyt PRIMARY KEY (id) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_v_thvpbhyt_v_thvpll FOREIGN KEY (id) REFERENCES " + schema + ".v_thvpll (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".v_thvpbhyt OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".v_ttrvds(id numeric NOT NULL DEFAULT 0,mabn varchar(" + i_maxlength_mabn + "),mavaovien numeric DEFAULT 0,maql numeric DEFAULT 0,idkhoa numeric DEFAULT 0,giuong varchar(20),ngayvao timestamp,ngayra timestamp,chandoan text,maicd varchar(9),CONSTRAINT pk_v_ttrvds PRIMARY KEY (id) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_v_ttrvds_btdbn FOREIGN KEY (mabn) REFERENCES " + usr + ".btdbn (mabn) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".v_ttrvds OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".v_ttrvll(id numeric NOT NULL DEFAULT 0,loaibn numeric(2) DEFAULT 0,loai numeric(2) DEFAULT 0,quyenso numeric(7) DEFAULT 0,sobienlai numeric(10) DEFAULT 0,ngay timestamp,makp varchar(" + i_maxlength_makp + "),sotien numeric(15,4) DEFAULT 0,tamung numeric(10) DEFAULT 0,mien numeric(15,4) DEFAULT 0,bhyt numeric(15,4) DEFAULT 0,ketoan numeric(20) default 0,userid numeric(7) DEFAULT 0,ngayud timestamp DEFAULT now(),nopthem numeric(15,4) DEFAULT 0,thieu numeric(15,4) DEFAULT 0,vattu numeric(10) DEFAULT 0,lanin numeric(2) DEFAULT 0,idtonghop numeric DEFAULT 0,chenhlech numeric(15,4) DEFAULT 0,thua numeric(15,4) DEFAULT 0,quyensodv numeric(7) DEFAULT 0,sobienlaidv numeric(10) DEFAULT 0,bhytghichu text,CONSTRAINT pk_v_ttrvll PRIMARY KEY (id) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_v_ttrvll_v_ttrvds FOREIGN KEY (id)  REFERENCES " + schema + ".v_ttrvds (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".v_ttrvll OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".v_ttrvbhyt(id numeric NOT NULL DEFAULT 0,sothe varchar(20),maphu numeric(2) DEFAULT 0,tungay timestamp,ngay timestamp,mabv varchar(10),noigioithieu varchar(8),traituyen numeric(1) default 0,CONSTRAINT pk_v_ttrvbhyt PRIMARY KEY (id) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_v_ttrvbhyt_v_ttrvll FOREIGN KEY (id) REFERENCES " + schema + ".v_ttrvll (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".v_ttrvbhyt OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".v_ttrvct(id numeric NOT NULL DEFAULT 0,stt numeric(5) NOT NULL DEFAULT 0,ngay timestamp,makp varchar(" + i_maxlength_makp + "),madoituong numeric(2) DEFAULT 0,mavp numeric(10) DEFAULT 0,soluong numeric(12,4) DEFAULT 0,dongia numeric DEFAULT 0,giamua numeric(24,10) DEFAULT 0,vat numeric(3) DEFAULT 0,vattu numeric(10) DEFAULT 0,sotien numeric(15,4) DEFAULT 0,sothe varchar(20),bhytduyet numeric(1) default 1,bhyttra numeric(15,4) default 0,gia_bh numeric(18,4) default 0,ngayud timestamp DEFAULT now(),traituyen numeric (1) default 0,idtra numeric default 0,CONSTRAINT pk_v_ttrvct PRIMARY KEY (id, stt) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_v_ttrvct_v_ttrvll FOREIGN KEY (id) REFERENCES " + schema + ".v_ttrvll (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".v_ttrvct OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".v_ttrvdv(id numeric NOT NULL DEFAULT 0,stt numeric(5) NOT NULL DEFAULT 0,ngay timestamp,makp varchar(" + i_maxlength_makp + "),madoituong numeric(2) DEFAULT 0,mavp numeric(10) DEFAULT 0,soluong numeric(12,4) DEFAULT 0,dongia numeric DEFAULT 0,giamua numeric(24,10) DEFAULT 0,vat numeric(3) DEFAULT 0,vattu numeric(10) DEFAULT 0,sotien numeric(15,4) DEFAULT 0,sothe varchar(20),bhytduyet numeric(1) default 1,bhyttra numeric(15,4) default 0,gia_bh numeric(18,4) default 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_v_ttrvdv PRIMARY KEY (id, stt) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_v_ttrvdv_v_ttrvll FOREIGN KEY (id) REFERENCES " + schema + ".v_ttrvll (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".v_ttrvdv OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".v_ttrvnhom(id numeric NOT NULL DEFAULT 0,ma numeric(3) NOT NULL DEFAULT 0,sotien numeric(15,4) DEFAULT 0,CONSTRAINT pk_v_ttrvnhom PRIMARY KEY (id, ma) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_v_ttrvnhom_v_ttrvll FOREIGN KEY (id) REFERENCES " + schema + ".v_ttrvll (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT)WITH OIDS;ALTER TABLE " + schema + ".v_ttrvnhom OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".v_ttrvpttt(id numeric NOT NULL DEFAULT 0,ngay timestamp,songay_tpt numeric(3) DEFAULT 0,songay_spt numeric(3) DEFAULT 0,mavp numeric(10) DEFAULT 0,so numeric(1) DEFAULT 0,loaipt numeric(1) DEFAULT 0,tenpt text,CONSTRAINT pk_v_ttrvpttt PRIMARY KEY (id) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_v_ttrvpttt_v_ttrvll FOREIGN KEY (id) REFERENCES " + schema + ".v_ttrvll (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".v_ttrvpttt OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".v_ttrvptttct(id numeric NOT NULL DEFAULT 0,stt numeric(1) NOT NULL DEFAULT 0,songay numeric(3) DEFAULT 0,dongia numeric DEFAULT 0,loaipt numeric(2) DEFAULT 0,CONSTRAINT pk_v_ttrvptttct PRIMARY KEY (id, stt) USING INDEX TABLESPACE medi_index,  CONSTRAINT fk_v_ttrvptttct_v_ttrvll FOREIGN KEY (id) REFERENCES " + schema + ".v_ttrvll (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".v_ttrvptttct OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".v_trongoi(id numeric DEFAULT 0,sotien numeric(10) DEFAULT 0,tamung numeric(10) DEFAULT 0,hoantra numeric(10) DEFAULT 0,pm numeric(1) DEFAULT 0,yc numeric(1) DEFAULT 0,ghichu text,CONSTRAINT pk_v_trongoi PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS; ALTER TABLE " + schema + ".v_trongoi OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".v_vienphill(id numeric NOT NULL DEFAULT 0,quyenso numeric(7) DEFAULT 0,sobienlai numeric(10) DEFAULT 0,ngay timestamp,mabn varchar(" + i_maxlength_mabn + "),mavaovien numeric DEFAULT 0,maql numeric DEFAULT 0,idkhoa numeric DEFAULT 0,makp varchar(" + i_maxlength_makp + "),hoten text,phai numeric(1) default 0,namsinh varchar(4),diachi text,loai numeric(2) DEFAULT 0,loaibn numeric(2) DEFAULT 0,lanin numeric(2) DEFAULT 0,masothue varchar(20),ghichu text,bacsi text,makptd varchar(2),quyensodv numeric(7) DEFAULT 0,sobienlaidv numeric(10) DEFAULT 0,ketoan numeric(20) default 0,userid numeric(7) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_v_vienphill PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".v_vienphill OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".v_vienphict(id numeric NOT NULL DEFAULT 0,stt numeric(3) NOT NULL DEFAULT 0,madoituong numeric(2) DEFAULT 0,mavp numeric(10) DEFAULT 0,ten text,soluong numeric(12,4) DEFAULT 0,dongia numeric DEFAULT 0,vat numeric(7,2) default 0,mien numeric(15,4) DEFAULT 0,thieu numeric(15,4) DEFAULT 0,vattu numeric(10) DEFAULT 0,mabs varchar(4),makp varchar(" + i_maxlength_makp + "),tra numeric(15,4) default 0,ngaytra timestamp,lanin numeric(2) default 0,done numeric(1) default 0,useridtra numeric(5) default 0,idchidinh numeric default 0,ngayud timestamp DEFAULT now(),idtra numeric default 0,idphongcls numeric(5) default 0, sttcho numeric(5) default 0,CONSTRAINT pk_v_vienphict PRIMARY KEY (id, stt) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_v_vienphict_v_vienphill FOREIGN KEY (id) REFERENCES " + schema + ".v_vienphill (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".v_vienphict OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".v_vienphidv(id numeric NOT NULL DEFAULT 0,stt numeric(3) NOT NULL DEFAULT 0,madoituong numeric(2) DEFAULT 0,mavp numeric(10) DEFAULT 0,ten text,soluong numeric(12,4) DEFAULT 0,dongia numeric DEFAULT 0,vat numeric(7,2) default 0,mien numeric(15,4) DEFAULT 0,thieu numeric(15,4) DEFAULT 0,vattu numeric(10) DEFAULT 0,mabs varchar(4),makp varchar(" + i_maxlength_makp + "),tra numeric(15,4) default 0,ngaytra timestamp,lanin numeric(2) default 0,done numeric(1) default 0,useridtra numeric(5) default 0,idchidinh numeric default 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_v_vienphidv PRIMARY KEY (id, stt) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_v_vienphidv_v_vienphill FOREIGN KEY (id) REFERENCES " + schema + ".v_vienphill (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".v_vienphidv OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".v_vpkhoa(id numeric NOT NULL DEFAULT 0,mabn varchar(" + i_maxlength_mabn + "),mavaovien numeric DEFAULT 0,maql numeric DEFAULT 0,idkhoa numeric DEFAULT 0,ngay timestamp,makp varchar(" + i_maxlength_makp + "),madoituong numeric(2) DEFAULT 0,mavp numeric(10) DEFAULT 0,soluong numeric(12,4) DEFAULT 0,dongia numeric DEFAULT 0,done numeric(1) DEFAULT 0,userid numeric(7) DEFAULT 0,ngayud timestamp DEFAULT now(),vattu numeric(10) DEFAULT 0,readonly numeric(1) DEFAULT 0,buoi numeric(1) DEFAULT 0,idttrv numeric default 0,traituyen numeric(1) default 0,tylegiam numeric(5,2) default 0, stgiam numeric default 0, lydogiam text,CONSTRAINT pk_v_vpkhoa PRIMARY KEY (id) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_v_vpkhoa_btdbn FOREIGN KEY (mabn) REFERENCES " + usr + ".btdbn (mabn) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_v_vpkhoa_btdkp_bv FOREIGN KEY (makp) REFERENCES " + usr + ".btdkp_bv (makp) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_v_vpkhoa_v_giavp FOREIGN KEY (mavp) REFERENCES " + usr + ".v_giavp (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".v_vpkhoa OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".v_error(message text,computer varchar(20),tables varchar(20),ngayud timestamp DEFAULT now()) WITH OIDS;ALTER TABLE " + schema + ".v_error OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".v_huybienlai(id numeric NOT NULL DEFAULT 0,tables varchar(20),loai numeric(2) DEFAULT 0,mabn varchar(" + i_maxlength_mabn + "),hoten text,makp varchar(" + i_maxlength_makp + "),ngay timestamp,quyenso numeric(7) DEFAULT 0,sobienlai numeric(10) DEFAULT 0,sotien numeric(15,4) default 0,lydo text,ketoan numeric(20) default 0,userid numeric(7) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_v_huybienlai PRIMARY KEY (id,tables) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".v_huybienlai OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".ng_vienphill(id numeric NOT NULL DEFAULT 0,loai numeric(2),quyenso numeric(7),sobienlai numeric(10),ngay timestamp,mabn varchar(" + i_maxlength_mabn + "),hoten text,masothue varchar(20),lanin numeric(2) DEFAULT 0,userid numeric(7) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_ng_vienphill PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".ng_vienphill OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".ng_vienphict(id numeric NOT NULL DEFAULT 0,idll numeric,mavp numeric(10),ten text,soluong numeric(7) DEFAULT 0,dongia numeric,sotiennop numeric,CONSTRAINT pk_ng_vienphict PRIMARY KEY (id) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_ng_vienphict_ng_vienphill FOREIGN KEY (idll) REFERENCES " + schema + ".ng_vienphill (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".ng_vienphict OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".ng_chia(id numeric NOT NULL DEFAULT 0,manv numeric(4),sotien numeric,CONSTRAINT pk_ng_chia PRIMARY KEY (id,manv) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".ng_chia OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".ng_huybienlai(id numeric NOT NULL DEFAULT 0,tables varchar(20) NOT NULL,loai numeric(2) DEFAULT 0,mabn varchar(" + i_maxlength_mabn + "),hoten text,makp varchar(" + i_maxlength_makp + "),ngay timestamp,quyenso numeric(7) DEFAULT 0,sobienlai numeric(10) DEFAULT 0,lydo text,userid numeric(7) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_ng_huybienlai PRIMARY KEY (id, tables) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".ng_huybienlai OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".ng_hoantra(id numeric NOT NULL DEFAULT 0,quyenso numeric(7) DEFAULT 0,sobienlai numeric(10) DEFAULT 0,ngay timestamp,mabn varchar(" + i_maxlength_mabn + "),mavaovien numeric DEFAULT 0,maql numeric DEFAULT 0,hoten text,makp varchar(" + i_maxlength_makp + "),sotien numeric(15,4) DEFAULT 0,ghichu text,userid numeric(7) DEFAULT 0,ngayud timestamp DEFAULT now(),loai numeric(1) DEFAULT 0,loaibn numeric(2) DEFAULT 0,CONSTRAINT pk_ng_hoantra PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".ng_hoantra OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".ng_hoantract(id numeric NOT NULL DEFAULT 0,loaivp numeric(7) NOT NULL DEFAULT 0,sotien numeric(15,4) DEFAULT 0,CONSTRAINT pk_ng_hoantract PRIMARY KEY (id, loaivp) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_ng_hoantract_ng_hoantra FOREIGN KEY (id) REFERENCES " + schema + ".ng_hoantra (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".ng_hoantract OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".ng_dmnv(ngay timestamp,id numeric(4) NOT NULL DEFAULT 0,idloai numeric(2),stt numeric(4),ma varchar(10),ten varchar(100),userid numeric(7) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_ng_dmnv PRIMARY KEY (ngay,id) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".ng_dmnv OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".ng_tiencong(ngay timestamp,idct numeric NOT NULL DEFAULT 0,mavp numeric(10) DEFAULT 0,idnv numeric(4) NOT NULL DEFAULT 0,soluong numeric(3) DEFAULT 0,phan numeric(5,2) default 0,sotien numeric DEFAULT 0,CONSTRAINT pk_ng_tiencong PRIMARY KEY (ngay,idct,mavp,idnv) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".ng_tiencong OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".eve_tables(tableid numeric(9) NOT NULL DEFAULT 0,ngay timestamp NOT NULL,userid numeric(7) NOT NULL DEFAULT 0,computerid numeric(7) NOT NULL DEFAULT 0,ins numeric(9) DEFAULT 0,upd numeric(9) DEFAULT 0,del numeric(9) DEFAULT 0,CONSTRAINT pk_eve_tables PRIMARY KEY (tableid, ngay, userid, computerid) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_eve_tables_dmcomputer FOREIGN KEY (computerid) REFERENCES " + usr + ".dmcomputer (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_eve_tables_dmtables FOREIGN KEY (tableid) REFERENCES " + usr + ".dmtables (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".eve_tables OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".eve_upd_del(tableid numeric(7) DEFAULT 0,ngay timestamp DEFAULT now(),userid numeric(9) DEFAULT 0,computerid numeric(7) DEFAULT 0,command varchar(3),noidung text,CONSTRAINT fk_eve_upd_del_dmcomputer FOREIGN KEY (computerid) REFERENCES " + usr + ".dmcomputer (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_eve_upd_del_dmtables FOREIGN KEY (tableid) REFERENCES " + usr + ".dmtables (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".eve_upd_del OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".cls_hen(id numeric NOT NULL DEFAULT 0,songay numeric(7) default 0,ghichu text,loai numeric(1) DEFAULT 0,ngaychup timestamp,ngaytra timestamp,CONSTRAINT pk_cls_hen PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cls_hen OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".cls_hinh(id numeric NOT NULL DEFAULT 0,stt numeric(3) default 0,hinh text,CONSTRAINT pk_cls_hinh PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cls_hinh OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".cls_mat(id numeric NOT NULL DEFAULT 0,mp numeric(1) default 0,mt numeric(1) default 0,CONSTRAINT pk_cls_mat PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cls_mat OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".cls_sdthuoc(id numeric NOT NULL DEFAULT 0,thuoc numeric(7) default 0,soluong numeric(12,4) default 0,CONSTRAINT pk_cls_sdthuoc PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cls_sdthuoc OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".cls_motact(id numeric NOT NULL DEFAULT 0,canquang numeric(1) default 0,gayme numeric(1) default 0,phanung numeric(1) default 0,sa numeric(1) default 0,CONSTRAINT pk_cls_motact PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cls_motact OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".cls_thuchien(id numeric NOT NULL DEFAULT 0,mabn varchar(" + i_maxlength_mabn + "),mavaovien numeric default 0,maql numeric default 0,makp varchar(" + i_maxlength_makp + "),ngay timestamp,loai numeric(2) default 0,bscd varchar(4),bsth varchar(4),maicd varchar(9),chandoan text,loaibn numeric(1) default 0, kham numeric default 0,  madoituong numeric(2) default 0,  ma varchar(10),  ten text,  ketqua numeric(7) default 0,   denghi numeric(7) default 0,  ghichu text,  userid numeric(7) default 0,  ngayud timestamp default now(),  ytaphu varchar(4),  CONSTRAINT pk_cls_thuchien PRIMARY KEY (id) USING INDEX TABLESPACE medi_index,  CONSTRAINT fk_cls_thuchien_btdbn FOREIGN KEY (mabn) REFERENCES " + usr + ".btdbn (mabn) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".cls_thuchien OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".tttiepdon(maql numeric,manv varchar(4),bacsy text,benhvien text,kythuat text,dienthoai text,CONSTRAINT pk_tttiepdon PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".tttiepdon OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".cls_ketqua(id numeric NOT NULL DEFAULT 0,loai numeric(2) DEFAULT 0,mabn varchar(" + i_maxlength_mabn + "), mavaovien numeric, maql numeric,ngay timestamp,madoituong numeric(2),idcls varchar(11),idvp varchar(12),bscd text,makpcd text,bvcd text,cp numeric(10) default 0,lt numeric(10) default 0,bh numeric(10) default 0,chandoan text,ketqua text,mabs varchar(4),maktv varchar(4),idmay numeric(7) default 0,idvung numeric(7) default 0,idvungdg numeric(7) default 0,idloai numeric(7) default 0,kqcuoi numeric(1) default 0,madia varchar(20),soluongphim numeric(5) default 0,nhankq text,userid numeric(7) default 0,ngayud timestamp default now(),CONSTRAINT pk_cls_ketqua PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cls_ketqua OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".ct_btdbn(iddonvi numeric(10),stt numeric(3) DEFAULT 0,mabn varchar(" + i_maxlength_mabn + ") NOT NULL,hoten text,namsinh varchar(4),phai numeric(1) DEFAULT 0,hotenkdau text,done numeric(1) default 0,userid numeric(7),ngayud timestamp DEFAULT now(),CONSTRAINT pk_ct_btdbn PRIMARY KEY (mabn) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".ct_btdbn OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".ct_ketqua(id numeric NOT NULL DEFAULT 0,iddonvi numeric(10) DEFAULT 0,mabn varchar(" + i_maxlength_mabn + "),ngay timestamp,mabs varchar(4),loai numeric(2) DEFAULT 0,ketluan text,userid numeric(7) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_ct_ketqua PRIMARY KEY (id) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_ct_ketqua_ct_btdbn FOREIGN KEY (mabn) REFERENCES " + schema + ".ct_btdbn (mabn) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_ct_ketqua_ct_donvi FOREIGN KEY (iddonvi) REFERENCES " + usr + ".ct_donvi (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_ct_ketqua_ct_loai FOREIGN KEY (loai) REFERENCES " + usr + ".ct_loai (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".ct_ketqua OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".ct_chitiet(id numeric NOT NULL DEFAULT 0,stt numeric(3) NOT NULL DEFAULT 0,mavp numeric(10) DEFAULT 0,ten text,dongia numeric DEFAULT 0,ngoaihd numeric(1) DEFAULT 0,lamthem text,ketqua text,ghichu text,CONSTRAINT pk_ct_chitiet PRIMARY KEY (id, stt) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_ct_chitiet_ct_ketqua FOREIGN KEY (id) REFERENCES " + schema + ".ct_ketqua (id) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;ALTER TABLE " + schema + ".ct_chitiet OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".ng_khamll(id numeric NOT NULL DEFAULT 0,ngay timestamp NOT NULL,userid numeric(7) NOT NULL DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_ng_khamll PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".ng_khamll OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".ng_khamct(id numeric NOT NULL DEFAULT 0,kyhieu varchar(20),tu numeric(7) DEFAULT 0,den numeric(7) DEFAULT 0,mavp numeric(10) NOT NULL DEFAULT 0,soluong numeric(7) DEFAULT 0,dongia numeric DEFAULT 0,CONSTRAINT pk_ng_khamct PRIMARY KEY (id,kyhieu,tu,mavp) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".ng_khamct OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".inchiphipk(mabn varchar(" + i_maxlength_mabn + "),mavaovien numeric NOT NULL DEFAULT 0,ngay timestamp,makp varchar(" + i_maxlength_makp + "),lan numeric(2) DEFAULT 0,CONSTRAINT pk_inchiphipk PRIMARY KEY (mavaovien) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".inchiphipk OWNER TO " + owner + ";\n";
                s_sql += "create table " + schema + ".di_duyet(id numeric,ngay timestamp,makp varchar(" + i_maxlength_makp + "),phieu numeric(2),sobn numeric(4),hienco numeric(4),vao numeric(3),ra numeric(3),cat numeric(3),bao numeric(3),done numeric(1) default 0,userid numeric(7),ngayud timestamp DEFAULT now(),constraint pk_di_duyet primary key(id) USING INDEX TABLESPACE medi_index) WITH OIDS;\n";
                s_sql += "create table " + schema + ".di_kthucdonll(id numeric,idduyet numeric,mabn varchar(" + i_maxlength_mabn + "),maql numeric,idkhoa numeric,madoituong numeric(2),idcu numeric(2),moi numeric(1) default 0,dacbiet numeric(1) default 0,giuong varchar(20),maicd varchar(9),chandoan text,mabs varchar(4),yta varchar(4),constraint pk_di_kthucdonll primary key(id) USING INDEX TABLESPACE medi_index) WITH OIDS;\n";
                s_sql += "create table " + schema + ".di_kthucdonct(id numeric,stt numeric(3),idgioan numeric(3),idthucdon numeric(10),soluong numeric(2) default 1,e numeric(7) default 0,p numeric(7) default 0,l numeric(7) default 0,g numeric(7) default 0,idchedoan numeric(7) default 0,dongia numeric,ngayud timestamp DEFAULT now(),constraint pk_di_kthucdonct primary key(id,stt) USING INDEX TABLESPACE medi_index) WITH OIDS;\n";
                s_sql += "create table " + schema + ".di_thucdonll(id numeric,idduyet numeric,mabn varchar(" + i_maxlength_mabn + "),maql numeric,idkhoa numeric,makp varchar(" + i_maxlength_makp + "),ngay timestamp,phieu numeric(2),madoituong numeric(2),idcu numeric(2),moi numeric(1) default 0,dacbiet numeric(1) default 0,giuong varchar(20),mabs varchar(4),yta varchar(4),userid numeric(7),ngayud timestamp DEFAULT now(),constraint pk_di_thucdonll primary key(id) USING INDEX TABLESPACE medi_index) WITH OIDS;\n";
                s_sql += "create table " + schema + ".di_thucdonct(id numeric,stt numeric(3),idgioan numeric(3),idthucdon numeric(10),soluong numeric(2) default 1,e numeric(7) DEFAULT 0,p numeric(7) DEFAULT 0,l numeric(7) DEFAULT 0,g numeric(7) DEFAULT 0,idchedoan numeric(7) DEFAULT 0,dongia numeric,vpkhoa numeric default 0,ngayud timestamp DEFAULT now(),constraint pk_di_thucdonct primary key(id,stt) USING INDEX TABLESPACE medi_index) WITH OIDS;\n";
                s_sql += "create table " + schema + ".di_nauan(id numeric,ngay timestamp,ghichu1 text,ghichu2 text,userid numeric(7),ngayud timestamp DEFAULT now(),constraint pk_di_nauan primary key(id) USING INDEX TABLESPACE medi_index) WITH OIDS;\n";
                s_sql += "create table " + schema + ".di_nauanct(id numeric,idgioan numeric(3),chedoan text,thucpham text,ngayud timestamp DEFAULT now(),constraint pk_di_nauanct primary key(id,idgioan) USING INDEX TABLESPACE medi_index) WITH OIDS;\n";
                s_sql += "create table " + schema + ".di_anlong(id numeric,idchedoan numeric(7),sang text,chieu text,constraint pk_di_anlong primary key(id,idchedoan) USING INDEX TABLESPACE medi_index) WITH OIDS;\n";
                s_sql += "CREATE TABLE " + schema + ".stttiepdon(id numeric(5) DEFAULT 0,ngay timestamp DEFAULT now(),stt numeric(5) DEFAULT 0,CONSTRAINT pk_stttiepdon PRIMARY KEY (id, ngay) USING INDEX TABLESPACE medi_index) WITH OIDS;\n";
                s_sql += "CREATE TABLE " + schema + ".sttkham(makp varchar(" + i_maxlength_makp + ") DEFAULT 0,ngay timestamp DEFAULT now(),stt numeric(5) DEFAULT 0,CONSTRAINT pk_sttkham PRIMARY KEY (makp, ngay) USING INDEX TABLESPACE medi_index) WITH OIDS;\n";
                s_sql += "CREATE TABLE " + schema + ".di_ngayduyet(makp varchar(" + i_maxlength_makp + "),ngay timestamp,idduyet numeric DEFAULT 0,phieu numeric(2) DEFAULT 0,CONSTRAINT pk_di_ngayduyet PRIMARY KEY (makp,ngay,idduyet,phieu) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_di_ngayduyet_di_dmphieu FOREIGN KEY (phieu)  REFERENCES " + usr + ".di_dmphieu (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_di_ngayduyet_btdkp_bv FOREIGN KEY (makp) REFERENCES " + usr + ".btdkp_bv (makp) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;\n";
                s_sql += "CREATE TABLE " + schema + ".sokhamthai(mabn varchar(" + i_maxlength_mabn + "),mavaovien numeric DEFAULT 0,cao numeric(5) DEFAULT 0,para varchar(8),dacdiem text,chuky numeric(2) DEFAULT 0,tinhchat numeric(1) DEFAULT 0,luongkinh numeric(1) DEFAULT 0,songay numeric(2) DEFAULT 0,vat1 text,vat2 text,tiensu text,ngaykc timestamp,ngaydd timestamp,userid numeric(7) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_sokhamthai PRIMARY KEY (mavaovien) USING INDEX TABLESPACE medi_index) WITH OIDS;\n";
                s_sql += "CREATE TABLE " + schema + ".sokhamthaict(mavaovien numeric DEFAULT 0,maql numeric DEFAULT 0,ngay timestamp,cannang numeric(7,2) DEFAULT 0,huyetap varchar(7),mach numeric(5) DEFAULT 0,phu numeric(1) DEFAULT 0,bctc text,timthai text,ngoi numeric(3) default 0,ketluan text,ngayud timestamp DEFAULT now(),CONSTRAINT pk_sokhamthaict PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index) WITH OIDS;\n";
                s_sql += "CREATE TABLE " + schema + ".bask_chiso(mabn varchar(" + i_maxlength_mabn + "),maql numeric NOT NULL DEFAULT 0,ngay timestamp,socmnd varchar(20),capngay timestamp,tai varchar(3),lydo text,tiensu text,  CONSTRAINT pk_bask_chiso PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;\n";
                s_sql += "CREATE TABLE " + schema + ".bask_cls(maql numeric NOT NULL DEFAULT 0,mavaovien numeric DEFAULT 0,stt numeric(3) default 0,idchidinh numeric default 0,loai numeric(1) default 0,  ketluan text,  image bytea,  CONSTRAINT pk_bask_cls PRIMARY KEY (idchidinh) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;\n";
                s_sql += "CREATE TABLE " + schema + ".bask_donvi(mabn varchar(" + i_maxlength_mabn + "),maql numeric NOT NULL DEFAULT 0,madonvi numeric DEFAULT 0,mach numeric(3) DEFAULT 0,chieucao numeric(6) DEFAULT 0, nhietdo numeric(5,2) DEFAULT 0,  cannang numeric(7,2) DEFAULT 0,  huyetap varchar(7),  nhiptho numeric(3) DEFAULT 0,  CONSTRAINT pk_bask_donvi PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;\n";
                s_sql += "CREATE TABLE " + schema + ".bask_mat(  maql numeric NOT NULL DEFAULT 0,  mavaovien numeric DEFAULT 0,  ngay timestamp,  makp varchar(" + i_maxlength_makp + "),  mat text,  thiluc text,  tlcp text,  tlct text,  tlkp text,  tlkt text,  sop text,  sot text,  sacgiac text,  khac text,  mabs varchar(4),  userid numeric(7) DEFAULT 0,  ngayud timestamp DEFAULT now(),  CONSTRAINT pk_bask_mat PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;\n";
                s_sql += "CREATE TABLE " + schema + ".bask_ngkhoa(  maql numeric NOT NULL DEFAULT 0,  mavaovien numeric DEFAULT 0,  ngay timestamp,  makp varchar(" + i_maxlength_makp + "),  ngoai text,  dalieu text,  khac text,  mabs varchar(4),  userid numeric(7) DEFAULT 0,  ngayud timestamp DEFAULT now(),  CONSTRAINT pk_bask_ngkhoa PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;\n";
                s_sql += "CREATE TABLE " + schema + ".bask_noikhoa(  maql numeric NOT NULL DEFAULT 0,  mavaovien numeric DEFAULT 0,  ngay timestamp,  makp varchar(" + i_maxlength_makp + "),  toanthan text,  tonghop text,  timmach text,  tamthan text,  thankinh text,  khac text,  mabs varchar(4),  userid numeric(7) DEFAULT 0,  ngayud timestamp DEFAULT now(),  CONSTRAINT pk_bask_noikhoa PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;\n";
                s_sql += "CREATE TABLE " + schema + ".bask_rmh(  maql numeric NOT NULL DEFAULT 0,  mavaovien numeric DEFAULT 0,  ngay timestamp,  makp varchar(" + i_maxlength_makp + "),  rhm text,  saurang text,  nhanhu text,  matrang text,  hammat text,  khac text,  mabs varchar(4),  userid numeric(7) DEFAULT 0,  ngayud timestamp DEFAULT now(),  CONSTRAINT pk_bask_rmh PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;\n";
                s_sql += "CREATE TABLE " + schema + ".bask_sanphu(  maql numeric NOT NULL DEFAULT 0,  mavaovien numeric DEFAULT 0,  ngay timestamp,  makp varchar(" + i_maxlength_makp + "),  san text,  phu text,  khac text,  mabs varchar(4),  userid numeric(7) DEFAULT 0,  ngayud timestamp DEFAULT now(),  CONSTRAINT pk_bask_sanphu PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;\n";
                s_sql += "CREATE TABLE " + schema + ".bask_tmh(  maql numeric NOT NULL DEFAULT 0,  mavaovien numeric DEFAULT 0,  ngay timestamp,  makp varchar(" + i_maxlength_makp + "),  tmh text,  thuongt text,  thamt text,  thuongp text,  thamp text,  khac text,  mabs varchar(4),  userid numeric(7) DEFAULT 0,  ngayud timestamp DEFAULT now(),  CONSTRAINT pk_bask_tmh PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;\n";
                s_sql += "CREATE TABLE " + schema + ".bask_tongket(  maql numeric NOT NULL DEFAULT 0,  mavaovien numeric DEFAULT 0,  ngay timestamp,  makp varchar(" + i_maxlength_makp + "),  phanloai numeric(2) DEFAULT 0,  ketluan text,  khac text,  mabs varchar(4),  userid numeric(7) DEFAULT 0,  ngayud timestamp DEFAULT now(),  CONSTRAINT pk_bask_tongket PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;\n";
                s_sql += "create table " + schema + ".sophieurv(mabn varchar2(8),maql numeric,loaiba numeric(1),ngay timestamp,madoituong numeric(2),so numeric(5) default 0,lanin numeric(5) default 1,ghichu text,constraint pk_sophieurv primary key(maql,ngay)) with oids;\n";
                s_sql += "create table " + schema + ".capsotoa(id numeric(3),ngay timestamp,loai numeric(3),sotoa numeric(7) default 0,userid numeric(7),constraint pk_capsotoa primary key(id,ngay,loai,userid)) with oids;\n";
                s_sql += " CREATE TABLE " + schema + ".cdha_bnll(id numeric NOT NULL DEFAULT 0, id_loai varchar(2), mabn varchar(" + i_maxlength_mabn + "), maql numeric NOT NULL DEFAULT 0,  makp varchar(" + i_maxlength_makp + "),  ngay timestamp,  gio varchar(5),  maicd varchar(9),chandoan text,bsdt varchar(4),ktv varchar(4),loaibn numeric(2) DEFAULT 0,ngoaigio numeric(1) DEFAULT 0,madoituong numeric(2) DEFAULT 0,mabhyt varchar(18),userid numeric(7),ngayud timestamp DEFAULT now(),paid numeric(1) DEFAULT 0,ghichu text, ketluan text,tinhtrang numeric(1), bsdoc varchar(4), may numeric(2) default 0,bschidinh text,tcls text,lanin numeric(2) default 0,CONSTRAINT PK_CDHA_BNLL PRIMARY KEY(id) USING INDEX TABLESPACE medi_index )WITH OIDS;ALTER TABLE " + schema + ".cdha_bnll OWNER TO " + owner + ";\n";
                s_sql += " CREATE TABLE " + schema + ".cdha_bnct(id numeric NOT NULL DEFAULT 0, makt varchar(7) NOT NULL, solan numeric(2) DEFAULT 1, ketluan text, mota text, denghi text, CONSTRAINT pk_cdha_bnct PRIMARY KEY (id, makt) USING INDEX TABLESPACE medi_index)WITH OIDS;ALTER TABLE " + schema + ".cdha_bnct OWNER TO " + owner + ";\n";
                s_sql += " CREATE TABLE " + schema + ".cdha_ctphimxq(id numeric NOT NULL DEFAULT 0, makt varchar(7) NOT NULL, loai numeric(2) NOT NULL DEFAULT 0,  idtp varchar(6) NOT NULL,  soluong numeric(10,2),  stt numeric(2) DEFAULT 1,  hu numeric(1) DEFAULT 0,  CONSTRAINT pk_cdha_ctphimxq PRIMARY KEY (id, makt, loai, idtp,stt) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdha_ctphimxq OWNER TO " + owner + ";\n";
                s_sql += " CREATE TABLE " + schema + ".cdha_ctxq(id numeric NOT NULL DEFAULT 0, makt varchar(7) NOT NULL, id_p varchar(3),  sl_p numeric(2) DEFAULT 0,  id_t varchar(3),  sl_t numeric(2),  CONSTRAINT pk_cdha_ctxq PRIMARY KEY (id, makt) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdha_ctxq OWNER TO " + owner + ";\n";
                s_sql += " CREATE TABLE " + schema + ".cdha_data_2d(id numeric NOT NULL DEFAULT 0, makt varchar(7) NOT NULL, ao text, la text,  avd text,  ivsd text,  ivss text,  lvdd text,  lvds text,  lvpwd text,  lvpws text,  ef text,  fs text,  vlt text,  vln text,  mnt text,  vdk text,ann_2l text,ann_3l text,cd2l text,ann_dmp text,than_dmp text,phai_dmp text,trai_dmp text,thatphai text,vmean_2l text,pgmean_2l text, rldongvung text,  CONSTRAINT pk_cdha_data_2d PRIMARY KEY (id, makt) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdha_data_2d OWNER TO " + owner + ";\n";
                s_sql += " CREATE TABLE " + schema + ".cdha_data_2d_md( id numeric NOT NULL DEFAULT 0,  makt varchar(7) NOT NULL,  thatphai text,  vlt text,  dklv text,  thanhsaulv text,  ef text,  sv text,  dkovao text,  vao text,  v2lef text,  vv text,  cdltv2l text,  ttt text,  cdmc text,  dmp text,  nhitrai text,  vdmp text,  vln text,  ytk text,  ivsd text,  lvdd text,  pwd text,  avo text,  de text,  quai text,  phai text,  ivss text,  lvds text,  tylecohoi text,  co text,  la text,  kieumo text,  eivs text,  nepvan text,  tinhmachphoi text,  xuong text,  trai text,  nhiphai text,  vachlienthat text,  mangngoaitim text,  pws text,  CONSTRAINT pk_cdha_data_2d_md PRIMARY KEY (id, makt) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdha_data_2d_md OWNER TO " + owner + ";\n";
                s_sql += " CREATE TABLE " + schema + ".cdha_data_doppler(  id numeric NOT NULL DEFAULT 0,  makt varchar(7) NOT NULL,  ea_ea text,  ea_vte text,  ea_vta text,  ea_epg text,  ea_apg text,  ea_hovan text,  ea_vmax text,  ea_hepvan text,  ea_mva text,  dmc_vmax text,  dmc_vmin text,  dmc_pgmax text,  dmc_pgmin text,  dmc_hv text,  dmc_dk text,  dmc_hepvan text,  dmc_dldh text,  dq_ho text,  dq_vmax text,  dq_pgmax text,  dq_pap text,  dmp_vmax text,  dmp_vmin text,  dmp_pgmax text,  dmp_pgmin text,  dmp_hepvan text,  dmp_papm text,  dmp_papd text,  denghi text,  ketluan text,  batthuong_vlt text,  batthuong_vln text,vandekhac text ,vmean_2l text,pgmean_2l text, CONSTRAINT pk_cdha_data_doppler PRIMARY KEY (id, makt) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdha_data_doppler OWNER TO " + owner + ";\n";
                s_sql += " CREATE TABLE " + schema + ".cdha_data_doppler_md(  id numeric NOT NULL DEFAULT 0,  makt varchar(7) NOT NULL,  ea text,  vttd text,  vttdtb1 text,  dcatd text,  dcatdtb1 text,  dongpn1 text,  mdlandongpn1 text,  hv2lmucdo text,  mucdothoigian text,  hv2lvmax text,  maxgp text,  hepv2l text,  pht text,  dientichovan1 text,  vttdvmax2 text,  vttdvmaxtb2 text,  dcatd2 text,  dcatdtb2 text,  hepvandmc text,  dientichovan2 text,  hovandmc text,  phd text,  ddf text,  dkdongpn2 text,  donglanpn2 text,  hovan3la text,  hovan3lamucdo text,  homax text,  apluctamthupap text,  chenhaptd3 text,  captdtrungbinh3 text,  toithieu3 text,  vttdvmax4 text,  chenhaptd4 text,  captdtrungbinh4 text,  toithieu4 text,  papmean text,  apluctt text,  cpqs text,  vachlienthat5 text,  vachliennhi6 text,  khac6 text,  denghi text,  ketluan text,  CONSTRAINT pk_cdha_data_doppler_md PRIMARY KEY (id, makt) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdha_data_doppler_md OWNER TO " + owner + ";\n";
                s_sql += " CREATE TABLE " + schema + ".cdha_data_machmau(  id numeric NOT NULL,  makt varchar(7) NOT NULL,  vt text,  dm1 text,  dm2 text,  dm3 text,  dm4 text,  dm5 text,  dm6 text,  dm_dong varchar(20),  dm_pho varchar(20),  dm_vmax varchar(20),  dm_ghichu text,  tm1 text,  tm2 text,  tm3 text,  tm4 text,  tm5 text,  tm6 text,  tm_dong varchar(20),  tm_pho varchar(20),  tm_vmax varchar(20),  tm_ghichu text,  mmcq text,  vdk text,  kl text,  dn text,  CONSTRAINT pk_cdha_data_machmau PRIMARY KEY (id, makt) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdha_data_machmau OWNER TO " + owner + ";\n";
                s_sql += " CREATE TABLE " + schema + ".cdha_data_noisoimuixoang(id numeric default 0,makt text,tiendinhmui_P text,tiendinhmui_T text,kheduoi_P text,kheduoi_T text,khegiua_P text,khegiua_T text,khetren_P text,khetren_T text,mommoc_P text,mommoc_T text,bongsang_P text,bongsang_T text,o_xoangham_P text,o_xoangham_T text,o_xoangsang_P text,o_xoangsang_T text,o_xoangtran_P text,o_xoangtran_T text,o_xoangbuom_P text,o_xoangbuom_T text,vachngan_P text,vachngan_T text,cuonduoi_P text,cuonduoi_T text,cuongiua_P text,cuongiua_T text,cuontren_P text,cuontren_T text,vomhong_P text,vomhong_T text,vomnhi_P text,vomnhi_T text,khac_P text,khac_T text,ketluan text,denghi text, constraint pk_sa_data_noisoimuixoang primary key(id,makt) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdha_data_noisoimuixoang OWNER TO " + owner + ";\n";
                s_sql += " CREATE TABLE " + schema + ".cdha_data_noisoitai(  id numeric NOT NULL DEFAULT 0,  makt text NOT NULL,  ongtai_p text,  ongtai_t text,  mangnhi_p text,  mangnhi_t text,  canbua_p text,  canbua_t text,  homnhi_p text,  homnhi_t text,  khac_p text,  khac_t text,  ketluan text,  denghi text,  CONSTRAINT pk_sa_data_noisoitai PRIMARY KEY (id, makt)USING INDEX TABLESPACE medi_index ) WITH OIDS;ALTER TABLE " + schema + ".cdha_data_noisoitai OWNER TO " + owner + ";\n";
                s_sql += " CREATE TABLE " + schema + ".cdha_data_noisoithanhquan(id numeric default 0,makt text,hahong_P text,hahong_T text,dayluoi_P text,dayluoi_T text,thanhthiet_P text,thanhthiet_T text,neppheuthanhthiet_P text,neppheuthanhthiet_T text,sunpheu_P text,sunpheu_T text,thuongthanhmon_P text,thuongthanhmon_T text,thanhnhat_P text,thanhnhat_T text,daythanh_P text,daythanh_T text,hathanhmon_P text,hathanhmon_T text,xoangle_P text,xoangle_T text,khac_P text,khac_T text,ketluan text,denghi text, constraint pk_sa_data_noisoithanhquan primary key(id,makt) USING INDEX TABLESPACE medi_index )WITH OIDS;ALTER TABLE " + schema + ".cdha_data_noisoithanhquan OWNER TO " + owner + ";\n";
                s_sql += " CREATE TABLE " + schema + ".cdha_data_nsdaday(  id numeric NOT NULL,  makt varchar(50) NOT NULL,  tq text,  dzccr text,  tv text,  pv text,  thanvi text,  bcl text,  bcn text,  vg text,  hv text,  mv text,  tt text,  mdd2tt text,  st text,  clotest text,  kl text,  dn text,tienmonvi text,  CONSTRAINT pk_cdha_data_nsdaday PRIMARY KEY (id, makt) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdha_data_nsdaday OWNER TO " + owner + ";\n";
                s_sql += " CREATE TABLE " + schema + ".cdha_data_nsdaitrang(  id numeric NOT NULL,  makt varchar(7) NOT NULL,  bnn text,  mst text,  dtp text,  dtgg text,  dtn text,  dtgl text,  dtt text,  dtsm text,  tt text,  hm text,  kl text,  dn text,  CONSTRAINT pk_cdha_data_nsdaitrang PRIMARY KEY (id, makt) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdha_data_nsdaitrang OWNER TO " + owner + ";\n";
                s_sql += " CREATE TABLE " + schema + ".cdha_data_phanmem(  id numeric NOT NULL,  makt varchar(7) NOT NULL,  vt text,  tt varchar(10),  kt varchar(10),  ct text,  bo text,  mmcq text,  hach text,  ttk text,  bung text,  tm text,  kl text,  dn text,  CONSTRAINT pk_cdha_data_phanmem PRIMARY KEY (id, makt) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdha_data_phanmem OWNER TO " + owner + ";\n";
                s_sql += " CREATE TABLE " + schema + ".cdha_data_phukhoa(  id numeric NOT NULL DEFAULT 0,  makt text NOT NULL,  tuthe text,  dap text,  noimac text,  cotucung text,  longtucung text,  tonthuong text,  vitri text,  cautruc text,  kichthuoc text,  btt text,  btp text,  tvt text,  tvp text,  tuicung text,  vdk text,  kl text,  dn text,  CONSTRAINT pk_cdha_data_phukhoa PRIMARY KEY (id, makt) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdha_data_phukhoa OWNER TO " + owner + ";\n";
                s_sql += " CREATE TABLE " + schema + ".cdha_data_san(id numeric NOT NULL,  makt varchar(7) NOT NULL,  soluong text,  timthai text,  cudong text,  ngoi text,  gioitinh text,  vitri text,  nhom text,  dotruongthanh text,  nuocoi text,  bpd varchar(50),  fml varchar(50),  aptd varchar(50),  ttd varchar(50),  trongluong text,  ngaysinh text,  v_r text,  ri_r text,  v_t text,  ri_t text,  v_p text,  ri_p text,  v_n text,  ri_n text,  dtbt text,  vdk text,  kl text,  dn text,  gs text,  crl text,  tuoithai text,  bohopso text,  cautrucduonggiua text,  hinhanhnao text,  kichthuochosau text,  cautructim text,  cotsong text,  hinhanhdaday text,  bangquang text,  dayron text,  ac varchar(50),thaituongduong text,ngaykinhcc timestamp,tuan text,ngay text, ngaydks timestamp, tucung text,amvangthai text,tuinoanhoan text,buongtrung text,cungdo text,thoigian numeric(2) DEFAULT 0,  CONSTRAINT pk_cdha_data_san PRIMARY KEY (id, makt)) WITH OIDS;ALTER TABLE " + schema + ".cdha_data_san OWNER TO " + owner + ";\n";
                s_sql += " CREATE TABLE " + schema + ".cdha_data_san_chitiet(  id numeric NOT NULL DEFAULT 0,  makt varchar(50) NOT NULL,  tuoithai text,  tuithai text,  botuithai text,  phoithai text,  tuthe text,  dap text,  phanphu text,  noimac text,  ctctc text,  tuicung text,  thoigian numeric DEFAULT 0,  CONSTRAINT pk_cdha_data_sans PRIMARY KEY (id, makt) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdha_data_san_chitiet OWNER TO " + owner + ";\n";
                s_sql += " CREATE TABLE " + schema + ".cdha_data_tongquat(  id numeric NOT NULL DEFAULT 0,  makt varchar(7) NOT NULL,  gan text,  mat text,  tuylach text,  haithan text,  bangquang text,  tlt text,  dmcbung text,  dichobung text,  duongtieuhoa text,  tuthe text,  dap text,  noimac text,  cotucung text,  longtucung text,  tuicung text,  phanphu text,  vdk text,  kl text,  dn text,  thanphai text,lach text,  duongmat text,ongmat text,tinhmach text,buongtrung text,  CONSTRAINT pk_cdha_data_tonguat PRIMARY KEY (id, makt) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdha_data_tongquat OWNER TO " + owner + ";\n";
                s_sql += " CREATE TABLE " + schema + ".cdha_data_tuyengiap(  id numeric NOT NULL,  makt varchar(7) NOT NULL,  tp1 varchar(10),  tp2 varchar(10),  tp3 varchar(10),  v_tp varchar(10),  tt1 varchar(10),  tt2 varchar(10),  tt3 varchar(10),  v_tt varchar(10),  ha text,  tt text,  vt text,  ct text,  kt text,  tt_trai varchar(10),  vt_trai text,  ct_trai text,  kt_trai text,  hc text,  ctk text,  kl text,  dn text,  cautruc text,  lantoa text,  khutru text,  bo text,  didong text,  CONSTRAINT pk_cdha_data_tuyengiap PRIMARY KEY (id, makt) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdha_data_tuyengiap OWNER TO " + owner + ";\n";
                s_sql += " CREATE TABLE " + schema + ".cdha_data_tuyenvu(  id numeric NOT NULL,  makt varchar(7) NOT NULL,  mtv text,mtvphai text,  tt_vt varchar(10),  vt_vt varchar(100),  ct_vt text,  kt_vt varchar(100),  tt_vp varchar(10),  vt_vp varchar(100),  ct_vp text,  kt_vp varchar(100),  hn text,  vdk text,  kl text,  dn text,  CONSTRAINT pk_cdha_data_tuyenvu PRIMARY KEY (id, makt) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdha_data_tuyenvu OWNER TO " + owner + ";\n";
                s_sql += " CREATE TABLE " + schema + ".cdha_data_vu(  id numeric NOT NULL DEFAULT 0,  makt text NOT NULL,  f1 text,  f2 text,  f3 text,  f4 text,  f5 text,  f6 text,  f7 text,  f8 text,  f9 text,  f10 text,  f11 text,  f12 text,  f13 text,  f14 text,  f15 text,  f16 text,  f17 text,  CONSTRAINT pk_cdha_data_vu PRIMARY KEY (id, makt) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdha_data_vu OWNER TO " + owner + ";\n";
                s_sql += " CREATE TABLE " + schema + ".cdha_image(  id_hinh numeric NOT NULL,  id numeric NOT NULL,  makt varchar(7) NOT NULL,  image bytea,chon number default 1,  CONSTRAINT pk_cdha_image PRIMARY KEY (id_hinh,id,makt) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdha_image OWNER TO " + owner + ";\n";
                s_sql += " CREATE TABLE " + schema + ".cdha_kqvp(  id numeric NOT NULL DEFAULT 0,  id_loaicdha varchar(2),  mavp numeric(12) NOT NULL DEFAULT 0,  mabn varchar(" + i_maxlength_mabn + "),  code_ligne numeric DEFAULT 0,  idchidinh numeric DEFAULT 0,  gia numeric(10) DEFAULT 0,  makp varchar(" + i_maxlength_makp + "),  madoituong numeric(2) DEFAULT 0,  ngay timestamp,  diengiai text,  CONSTRAINT pk_cdha_kqvp PRIMARY KEY (id, mavp) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdha_kqvp OWNER TO " + owner + ";\n";
                s_sql += " create table " + schema + ".cdha_data_2d_doppler(id numeric NOT NULL DEFAULT 0,makt varchar(7) NOT NULL,nhitrai varchar(50),dongmachchu varchar(50),thattrai_dd varchar(50),thattrai_ds varchar(50),thattrai_vd varchar(50),thattrai_vs varchar(50),thattrai_d varchar(50),thattrai_ef varchar(50),dkthatphai varchar(50),beday_vlt_tamtruong varchar(50),beday_vlt_tamthu varchar(50),beday_tstt_tamtruong varchar(50),beday_tstt_tamthu varchar(50),didong_vlt varchar(50),didong_tstt varchar(50),v2l_dangdidong text,v2l_doctamtruong varchar(50),v2l_biendomo text,v2l_khoangcachhaibovan varchar(50),v2l_tinhtrangdaychang text,v2l_mepvan text,v2l_e varchar(50),v2l_huyetkhoinhitrai text,v2l_ea text,v2l_gradent text,v2l_trungbinh varchar(50),v2l_hovan text,v2l_dientich varchar(50),v2l_pht varchar(50),dmc_tinhtrangvan text,dmc_dangdidong text,dmc_biendomo varchar(50),dmc_gradent text,dmc_trungbinh varchar(50),dmc_hovan text,dmc_dientich varchar(50),dmc_pht varchar(50),dmp_tinhtrangvan text,dmp_duongkinh varchar(50),dmp_apluc text,dmp_tamthu varchar(50),dmp_gradent text,dmp_trungbinh_tamthu varchar(50),dmp_hovan text,dmp_cuoitamtruong varchar(50),dmp_trungbinh varchar(50),v3l_tinhtrangvan text,v3l_hovan text,v3l_gradent text,mangngoaitim text,tansotim text,hohl_td varchar(50),hohl_bb varchar(50),dkdhocdrtt varchar(50),ketluan text,denghi text,CONSTRAINT pk_cdha_data_2d_doppler PRIMARY KEY (id, makt)) WITH OIDS;ALTER TABLE " + schema + ".cdha_data_2d_doppler OWNER TO " + owner + ";\n";
                s_sql += " CREATE TABLE " + schema + ".cdha_benh(id numeric NOT NULL DEFAULT 0,makt varchar(7) NOT NULL,id_coquan numeric(7) DEFAULT 0, ketqua text, CONSTRAINT pk_cdha_benh PRIMARY KEY (id, makt,id_coquan)) WITH OIDS;ALTER TABLE " + schema + ".cdha_benh OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + schema + ".xn_done(id numeric NOT NULL DEFAULT 0,mabn varchar(" + i_maxlength_mabn + "),maql numeric DEFAULT 0,ngaycd timestamp,maxnvp text,mavp numeric(10) DEFAULT 0,ngayxn timestamp,done numeric(1) DEFAULT 0,CONSTRAINT pk_xn_done PRIMARY KEY (id)) WITH OIDS;\n";
                s_sql += "CREATE TABLE " + schema + ".xn_error(message text,computer varchar(20),tables varchar(20),ngayud timestamp) WITH OIDS;\n";
                s_sql += "CREATE TABLE " + schema + ".xn_hoachatbn(id numeric NOT NULL DEFAULT 0,id_phieu numeric DEFAULT 0,mabn varchar(" + i_maxlength_mabn + "),maql numeric DEFAULT 0,id_bv_chitiet numeric(11) DEFAULT 0,mahc numeric(7) DEFAULT 0,soluong numeric(10) DEFAULT 0,slquidoi numeric(10) DEFAULT 0,id_xtutrucll numeric DEFAULT 0,idduyet numeric DEFAULT 0,CONSTRAINT pk_xn_hoachatbn PRIMARY KEY (id)) WITH OIDS;\n";
                s_sql += "CREATE TABLE " + schema + ".xn_ketqua(id numeric NOT NULL DEFAULT 0,id_ten numeric(7) NOT NULL DEFAULT 0,idvienphi numeric DEFAULT 0,idduoc numeric DEFAULT 0,ketqua text,ghichu text,done numeric(1) DEFAULT 0,id_may numeric(5) DEFAULT 0,CONSTRAINT pk_xn_ketqua PRIMARY KEY (id, id_ten)) WITH OIDS;\n";
                s_sql += "CREATE TABLE " + schema + ".xn_ketqua_ksd(id numeric NOT NULL DEFAULT 0,id_ksd numeric DEFAULT 0,id_khangsinh numeric(7) DEFAULT 0,bankinh numeric(10) DEFAULT 0,sir varchar(1),maxr numeric(10) DEFAULT 0,mins numeric(10) DEFAULT 0,CONSTRAINT pk_xn_ketqua_ksd PRIMARY KEY (id)) WITH OIDS;\n";
                s_sql += "CREATE TABLE " + schema + ".xn_ksd(id numeric NOT NULL DEFAULT 0,id_phieu numeric DEFAULT 0,id_bv_vitrung numeric(5) DEFAULT 0,id_mauthu numeric(4) DEFAULT 0, maso_mt varchar(10),gram varchar(1),ketqua text,CONSTRAINT pk_xn_ksd PRIMARY KEY (id)) WITH OIDS;\n";
                s_sql += "CREATE TABLE " + schema + ".xn_laymau(id numeric NOT NULL DEFAULT 0,mabn varchar(" + i_maxlength_mabn + "),maql numeric DEFAULT 0,id_mauthu numeric(4) DEFAULT 0,id_tinhtrang numeric(1) DEFAULT 0,ngay timestamp,soluong numeric(7) DEFAULT 0,ktv varchar(4),id_vitri numeric(4) DEFAULT 0,id_diadiem numeric(4) DEFAULT 0,cothai numeric(1) DEFAULT 0,ghichu text,mavach text,userid numeric(7) DEFAULT 0,loaibn numeric(1) DEFAULT 0,loai numeric(1) DEFAULT 0,madoituong numeric(2) DEFAULT 2,readonly numeric(1) DEFAULT 0, CONSTRAINT pk_xn_laymau PRIMARY KEY (id)) WITH OIDS;\n";
                s_sql += "CREATE TABLE " + schema + ".xn_laymau_done(id numeric NOT NULL DEFAULT 0,id_chidinh numeric NOT NULL DEFAULT 0,id_vpkhoa numeric DEFAULT 0,CONSTRAINT pk_xn_laymau_done PRIMARY KEY (id, id_chidinh)) WITH OIDS;\n";
                s_sql += "CREATE TABLE " + schema + ".xn_nhuomgram(id numeric NOT NULL DEFAULT 0,id_phieu numeric DEFAULT 0,id_mauthu numeric(4) DEFAULT 0,gram varchar(10),CONSTRAINT pk_xn_nhuomgram PRIMARY KEY (id)) WITH OIDS;\n";
                s_sql += "CREATE TABLE " + schema + ".xn_phieu(id numeric NOT NULL DEFAULT 0,sophieu numeric(5) DEFAULT 0,mabn varchar(" + i_maxlength_mabn + "),maql numeric DEFAULT 0,idkhoa numeric DEFAULT 0,ngay timestamp,makp varchar(" + i_maxlength_makp + "),mabs varchar(4),loaibn numeric(1) DEFAULT 0,tinhtrang numeric(1) DEFAULT 0,loai numeric(1) DEFAULT 0,maicd varchar(9),madoituong numeric(2) DEFAULT 0,ktv varchar(4),ngayra timestamp,mabsdoc varchar(4),ghichu text,nhanxet text,ketluan text,denghi text,mabenhpham text,userid numeric(7) DEFAULT 0,ngayud timestamp,stt text,lanin numeric DEFAULT 0,ngaylaymau timestamp DEFAULT now(),CONSTRAINT pk_xn_phieu PRIMARY KEY (id)) WITH OIDS;\n";
                s_sql += "CREATE TABLE " + schema + ".xn_phieu_done(id numeric NOT NULL DEFAULT 0,id_chidinh numeric NOT NULL DEFAULT 0,id_vpkhoa numeric DEFAULT 0,CONSTRAINT pk_xn_phieu_done PRIMARY KEY (id, id_chidinh)) WITH OIDS;\n";
                s_sql += "CREATE TABLE " + schema + ".xn_vpkhoa(id numeric(7) NOT NULL DEFAULT 0,id_phieu numeric DEFAULT 0,mabn varchar(" + i_maxlength_mabn + "),maql numeric DEFAULT 0,id_bv_chitiet numeric(17) DEFAULT 0,mavp numeric(10) DEFAULT 0,soluong numeric(10) DEFAULT 0,dongia numeric DEFAULT 0,idvpkhoa numeric DEFAULT 0,CONSTRAINT pk_xn_vpkhoa PRIMARY KEY (id)) WITH OIDS;\n";
                s_sql += "CREATE TABLE " + schema + ".ba_khambenh(maql numeric DEFAULT 0,benhsu text,tiensu text,toanthan text,bophan text,CONSTRAINT pk_ba_khambenh PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index) WITH OIDS;\n";
                s_sql += "CREATE TABLE " + schema + ".d_bbkk(makho numeric(5) DEFAULT 0,makp numeric(6) DEFAULT 0,sttt numeric DEFAULT 0,mabd numeric(10) DEFAULT 0,slton numeric(12, 2) DEFAULT 0,slkk numeric(12, 2) DEFAULT 0,thua numeric(10, 2) DEFAULT 0,thieu numeric(10, 2) DEFAULT 0,userid numeric(7) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_d_bbkk PRIMARY KEY (makho, makp, sttt) USING INDEX TABLESPACE medi_index) WITH OIDS;\n";
                s_sql += "create table " + schema + ".tainangt(maql numeric,sophieu varchar(10),ngay timestamp,socap numeric(1) default 0,ptvv text,pttn text,ptgaytn numeric(2) default 0,ptgaykhac text,mubaohiem numeric(1) default 0,gaiquai numeric(1) default 0,bivo numeric(1) default 0,loaimu text,ruoubia numeric(1) default 0,camquan numeric(1) default 0,mau numeric(5) default 0,hoitho numeric(5) default 0,sonao numeric(1) default 0,glassgow numeric(5) default 0,cotsongco numeric(1) default 0,thuongkhac numeric(1) default 0,nhapvien numeric(1) default 0,mocapcuu numeric(1) default 0,tuvong numeric(1) default 0,xinve numeric(1) default 0,mabv varchar(10),manv varchar(4),constraint pk_tainangt primary key(maql) USING INDEX TABLESPACE medi_index) WITH OIDS;\n";
                s_sql += "create table " + schema + ".v_tamungdatru(id numeric,idttrv numeric,ngay timestamp,sotien numeric(15,4) default 0,constraint pk_v_tamungdatru primary key(id,idttrv) USING INDEX TABLESPACE medi_index) WITH OIDS;\n";
                s_sql += "create table " + schema + ".pttt_hinh(id numeric,image1 bytea,image2 bytea,constraint pk_pttt_hinh primary key(id) using index tablespace medi_index) with oids;\n";
                s_sql += "CREATE TABLE " + schema + ".v_tamungcd(id numeric NOT NULL DEFAULT 0,mabn varchar(" + i_maxlength_mabn + "), mavaovien numeric, maql numeric,idkhoa numeric, makp varchar(" + i_maxlength_makp + "),ngay timestamp,madoituong numeric(2),loai numeric(2), loaibn numeric(2),ten text,sotien numeric(12,2) DEFAULT 0, idduyet numeric DEFAULT 0, done numeric(1) DEFAULT 0, userid numeric(7), ngayud timestamp DEFAULT now(), CONSTRAINT pk_v_tamungcd PRIMARY KEY (id) USING INDEX TABLESPACE medi_index,  CONSTRAINT fk_v_tamungcd_btdbn FOREIGN KEY (mabn)  REFERENCES " + usr + ".btdbn (mabn) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_v_tamungcd_btdkp_bv FOREIGN KEY (makp)  REFERENCES " + usr + ".btdkp_bv (makp) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS;\n";
                s_sql += "CREATE TABLE " + schema + ".v_sophieucls(mabn varchar(" + i_maxlength_mabn + "),mavaovien numeric(22, 0) DEFAULT 0,ngay timestamp,madoituong numeric(2, 0) DEFAULT 0,so numeric(5, 0) DEFAULT 0,lanin numeric(5, 0) DEFAULT 0,ghichu text,userid numeric(5, 0) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_v_sophieucls PRIMARY KEY (mabn, mavaovien, ngay, madoituong) USING INDEX TABLESPACE medi_index) WITH OIDS;\n";
                s_sql += "create table " + schema + ".d_thuhoi (nhom numeric(3), ngay timestamp, loai numeric(3) default 0, makp numeric(6), phieu numeric (5) default 0, userid numeric(7) default(0), ngayud timestamp, constraint pk_d_thuhoi primary key(ngayud, loai, phieu, makp, userid) USING INDEX TABLESPACE medi_index) with oids;\n";
                //ksk
                s_sql += "CREATE TABLE " + schema + ".bask_tiensu (mavaovien numeric(21, 0), id numeric(5, 0), ghichu text, CONSTRAINT pk_bask_tiensu PRIMARY KEY (mavaovien,id) USING INDEX TABLESPACE medi_index ) WITHOUT OIDS TABLESPACE medi_index;ALTER TABLE " + schema + ".bask_tiensu OWNER TO medisoft;\n";
                s_sql += "create table " + schema + ".bask_rhm(mavaovien numeric(21, 0), mabn varchar(10), maql numeric(21, 0), ngay timestamp, makp varchar(" + i_maxlength_makp + "), image bytea, sucnhai text, nhanxet text, khac text, maicd varchar(9), chandoan text, phanloai numeric(2), mabs varchar(4), userid numeric(9, 0), ngayud timestamp DEFAULT now(), CONSTRAINT pk_bask_rhm PRIMARY KEY (mavaovien) USING INDEX TABLESPACE medi_index ) WITHOUT OIDS TABLESPACE medi_index;ALTER TABLE " + schema + ".bask_rhm OWNER TO medisoft;\n";
                s_sql += "create table " + schema + ".bask_dalieu(mavaovien numeric(21, 0), mabn varchar(10), maql numeric(21, 0), ngay timestamp, makp varchar(" + i_maxlength_makp + "), tongquat text, khac text, maicd varchar(9), chandoan text, phanloai numeric(2),mabs varchar(4), userid numeric(9, 0), ngayud timestamp DEFAULT now(), CONSTRAINT pk_bask_dalieu PRIMARY KEY (mavaovien) USING INDEX TABLESPACE medi_index) WITHOUT OIDS TABLESPACE medi_index;ALTER TABLE " + schema + ".bask_dalieu OWNER TO medisoft;\n";
                s_sql += "create table " + schema + ".bask_coxuong (mavaovien numeric(21, 0), maql numeric(21, 0), ngay timestamp, makp varchar(" + i_maxlength_makp + "),  tongquat text,  khac text,  maicd varchar(9),  chandoan text, phanloai numeric(2), mabs varchar(4), userid numeric(9, 0),  ngayud timestamp DEFAULT now(), CONSTRAINT pk_bask_coxuong PRIMARY KEY (mavaovien) USING INDEX TABLESPACE medi_index) WITHOUT OIDS TABLESPACE medi_index;ALTER TABLE " + schema + ".bask_coxuong OWNER TO medisoft;\n";
                //execute_data(s_sql);
                s_sql += "alter table " + schema + ".v_vienphill add done numeric(1) default 0;\n";
                s_sql += "alter table " + schema + ".bask_chiso add userid numeric(9,0);\n";
                s_sql += "alter table " + schema + ".bask_chiso add  mantinh text;\n";
                s_sql += "alter table " + schema + ".bask_chiso add  namvien text;\n";
                s_sql += "alter table " + schema + ".bask_chiso add  ruou numeric;\n";
                s_sql += "alter table " + schema + ".bask_chiso add  thuocla numeric;\n";
                s_sql += "alter table " + schema + ".bask_chiso add  diung numeric;\n";
                s_sql += "alter table " + schema + ".bask_chiso add  tendiung text;\n";
                s_sql += "alter table " + schema + ".bask_chiso add  viemgana numeric;\n";
                s_sql += "alter table " + schema + ".bask_chiso add  viemganb numeric;\n";
                s_sql += "alter table " + schema + ".bask_chiso add  khac text;\n";
                s_sql += "alter table " + schema + ".bask_chiso add  para text;\n";
                s_sql += "alter table " + schema + ".bask_chiso add  soi numeric;\n";
                s_sql += "alter table " + schema + ".bask_chiso add  viemnao numeric;\n";
                s_sql += "alter table " + schema + ".bask_chiso add  lao numeric;\n";
                s_sql += "alter table " + schema + ".bask_chiso add  uonvan numeric;\n";
                s_sql += "alter table " + schema + ".bask_chiso add  bachhau numeric;\n";
                s_sql += "alter table " + schema + ".bask_chiso add  cum numeric;\n";
                s_sql += "alter table " + schema + ".bask_chiso add  ngayud timestamp default now();\n";
                s_sql += "alter table " + schema + ".bask_mat add mabn varchar(10);\n";
                s_sql += "alter table " + schema + ".bask_mat add truoc varchar(254);\n";
                s_sql += "alter table " + schema + ".bask_mat add sau varchar(254);\n";
                s_sql += "alter table " + schema + ".bask_mat add nhanapp varchar(254);\n";
                s_sql += "alter table " + schema + ".bask_mat add nhanapt varchar(254);\n";
                s_sql += "alter table " + schema + ".bask_mat add maicd varchar(9);\n";
                s_sql += "alter table " + schema + ".bask_mat add chandoan text;\n";
                s_sql += "alter table " + schema + ".bask_mat add pic_mt01 bytea;\n";
                s_sql += "alter table " + schema + ".bask_mat add pic_mt02 bytea;\n";
                s_sql += "alter table " + schema + ".bask_mat add pic_mp01 bytea;\n";
                s_sql += "alter table " + schema + ".bask_mat add pic_mp02 bytea;\n";
                s_sql += "alter table " + schema + ".bask_mat add phanloai numeric(1);\n";
                s_sql += "alter table " + schema + ".bask_sanphu add maicd varchar(9);\n";
                s_sql += "alter table " + schema + ".bask_sanphu add chandoan text;\n";
                s_sql += "alter table " + schema + ".bask_sanphu add phanloai numeric(1);\n";
                s_sql += "alter table " + schema + ".bask_tongket add mabn varchar(10);\n";
                s_sql += "alter table " + schema + ".bask_tongket add nhanxet text;\n";
                s_sql += "alter table " + schema + ".bask_tongket add denghi text;\n";
                s_sql += "alter table " + schema + ".bask_tongket add madenghi numeric;\n";
                s_sql += "alter table " + schema + ".bask_tongket add maicd varchar(9);\n";
                s_sql += "alter table " + schema + ".bask_tongket add chandoan text;\n";
                s_sql += "alter table " + schema + ".bask_tmh add mabn varchar(10);\n";
                s_sql += "alter table " + schema + ".bask_tmh add chandoan text;\n";
                s_sql += "alter table " + schema + ".bask_tmh add tai text;\n";
                s_sql += "alter table " + schema + ".bask_tmh add mui text;\n";
                s_sql += "alter table " + schema + ".bask_tmh add hong text;\n";
                s_sql += "alter table " + schema + ".bask_tmh add thanhquan text;\n";
                s_sql += "alter table " + schema + ".bask_tmh add daumatco text;\n";
                s_sql += "alter table " + schema + ".bask_tmh add pic_tmh1 bytea;\n";
                s_sql += "alter table " + schema + ".bask_tmh add pic_tmh2 bytea;\n";
                s_sql += "alter table " + schema + ".bask_tmh add maicd varchar(9);\n";
                s_sql += "alter table " + schema + ".bask_tmh add phanloai numeric(1);\n";
                s_sql += "alter table " + schema + ".bask_donvi add stt numeric(6,0);\n";
                s_sql += "alter table " + schema + ".bask_donvi add vongbung numeric(7,2);\n";
                s_sql += "alter table " + schema + ".bask_donvi add coso numeric(1,0);\n";
                s_sql += "alter table " + schema + ".bask_donvi add ngayud timestamp ;\n";
                s_sql += "alter table " + schema + ".bask_noikhoa add  hohap text;\n";
                s_sql += "alter table " + schema + ".bask_noikhoa add  tieuhoa text;\n";
                s_sql += "alter table " + schema + ".bask_noikhoa add  than text;\n";
                s_sql += "alter table " + schema + ".bask_noikhoa add  noitiet text;\n";
                s_sql += "alter table " + schema + ".bask_noikhoa add  chuyenhoa text;\n";
                s_sql += "alter table " + schema + ".bask_noikhoa add  chandoan varchar(254);\n";
                s_sql += "alter table " + schema + ".bask_noikhoa add  maicd varchar(9);\n";
                s_sql += "alter table " + schema + ".bask_noikhoa add  maicdhh varchar(9);\n";
                s_sql += "alter table " + schema + ".bask_noikhoa add  maicdth varchar(9);\n";
                s_sql += "alter table " + schema + ".bask_noikhoa add  maicdtn varchar(9);\n";
                s_sql += "alter table " + schema + ".bask_noikhoa add  maicdtt varchar(9);\n";
                s_sql += "alter table " + schema + ".bask_noikhoa add  maicdnt varchar(9);\n";
                s_sql += "alter table " + schema + ".bask_noikhoa add  maicdch varchar(9);\n";
                s_sql += "alter table " + schema + ".bask_noikhoa add  maicdtamthan varchar(9);\n";
                s_sql += "alter table " + schema + ".bask_noikhoa add  phanloai numeric(2);\n";
                s_sql += "alter table " + schema + ".bask_ngkhoa add mabn varchar(10);\n";
                s_sql += "alter table " + schema + ".bask_ngkhoa add  tongquat text;\n";
                s_sql += "alter table " + schema + ".bask_ngkhoa add  chanthuong text;\n";
                s_sql += "alter table " + schema + ".bask_ngkhoa add  ubuou text;\n";
                s_sql += "alter table " + schema + ".bask_ngkhoa add  maicd varchar(9);\n";
                s_sql += "alter table " + schema + ".bask_ngkhoa add  chandoan varchar(254);\n";
                s_sql += "alter table " + schema + ".bask_ngkhoa add  maicdub varchar(9);\n";
                s_sql += "alter table " + schema + ".bask_ngkhoa add  phanloai numeric(2);\n";
                s_sql += "alter table " + schema + ".bask_rhm alter column mabn type varchar(10);\n";
                s_sql += "alter table " + schema + ".bask_rhm alter column makp type varchar(3);\n";
                s_sql += "alter table " + schema + ".bask_rhm alter column ngay type timestamp;\n";
                s_sql += "alter table " + schema + ".bask_tmh alter column makp type varchar(3);\n";
                s_sql += "alter table " + schema + ".bask_dalieu alter column mabn type varchar(10);\n";
                s_sql += "alter table " + schema + ".bask_dalieu alter column makp type varchar(3);\n";
                s_sql += "alter table " + schema + ".bask_dalieu alter column ngay type timestamp;\n";
                s_sql += "alter table " + schema + ".bask_coxuong add mabn varchar(10);\n";
                s_sql += "alter table " + schema + ".bask_coxuong alter column mabn type varchar(10);\n";
                s_sql += "alter table " + schema + ".bask_coxuong alter column makp type varchar(3);\n";
                s_sql += "alter table " + schema + ".bask_coxuong alter column ngay type timestamp;\n";
                s_sql += "alter table " + schema + ".ct_btdbn add docthan numeric(1);\n";
                s_sql += "alter table " + schema + ".ct_btdbn add idmuc numeric;\n";
                //End KSK
                //linh 10052012
                s_sql += "alter table " + userid + m_mmyy + ".v_vpkhoa add idtheodoigiuong numeric(22) default 0;\n";
                s_sql += "alter table " + schema + ".d_tonkhoth alter column makho type numeric(5);\n";//Travinh,binhan data cu kieu character
                s_sql += "alter table " + userid + m_mmyy + ".d_xuatll alter column khox type numeric(5);\n";//Travinh,binhan data cu kieu character
                s_sql += "ALTER TABLE " + userid + m_mmyy + ".d_xtutrucll ADD CONSTRAINT chk_d_xtutrucll_idduyet" + m_mmyy + " CHECK (idduyet<>0);\n";
                s_sql += "ALTER TABLE " + userid + m_mmyy + ".d_xtutrucll ALTER COLUMN idduyet SET NOT NULL;\n";
                //
                s_sql = s_sql.Trim('\n');
                s_sql = s_sql.Trim(';');
                //
                //Xuat ra file tmp
                if (System.IO.Directory.Exists("..\\..\\sql") == false) System.IO.Directory.CreateDirectory("..\\..\\sql");
                string tenfile = "..\\..\\sql\\tao_schema.sql";
                if (File.Exists(tenfile)) File.Delete(tenfile);
                FileStream file = new FileStream(tenfile, FileMode.CreateNew, FileAccess.Write);
                StreamWriter sw = new StreamWriter(file);
                sw.Write(sql);
                sw.Close();
                //
                foreach (string query in s_sql.Split(';'))
                {
                    string s_tmp = query.Trim('\n');
                    if (s_tmp != "")
                    {
                        execute(s_tmp);
                    }
                }
                //end linh
                if (bSchema(schema))
                {
                    upd_table(m_mmyy, m_userid);
                    tao_function(m_mmyy);
                }
                modify_schema(m_mmyy, m_userid);
            }
        }

        public void modify_schema(string m_mmyy, int m_userid)
        {
            string s_sql = "";
            if (bMmyy(m_mmyy))
            {
                string sSchema = userid + m_mmyy;
                try
                {
                    ds.Dispose();
                    ds = null;
                    ds = new DataSet();
                    if (System.IO.File.Exists("..//taotable.xml")) ds.ReadXml("..//taotable.xml");                    
                    if (ds != null && ds.Tables.Count > 0)
                    {
                        foreach (DataRow r in ds.Tables[0].Rows)
                        {
                            s_sql = r["ten"].ToString().Trim().Replace("xxx", sSchema).Replace("zzz", m_mmyy.Substring(2));
                            execute(s_sql,false );
                        }
                    }
                }
                catch { }
                //linh
                #region old
                s_sql = "alter table " + userid + ".dmchinhanh add port varchar2(4);\n";
                s_sql += "alter table " + userid + ".dmchinhanh add database_local varchar2(50);\n";
                s_sql += "alter table " + userid + ".chuyenvien add daduyet numeric(1) default 0;\n";
                s_sql += "alter table " + userid + ".chuyenvien add userid_duyet numeric(5) default 0;\n";
                s_sql += "alter table " + userid + ".d_dmkho alter chinhanh type numeric(2);\n";
                s_sql += "alter table " + userid + ".d_duockp alter matutruc type numeric(5);\n";
                s_sql += "alter table " + userid + ".v_giavp add guimau numeric(1) default 0;\n";
                s_sql += "alter table " + userid + ".v_giavp add guinguoi numeric(1) default 0;\n";
                s_sql += "alter table " + userid + ".v_giavp add guingoai numeric(1) default 0;\n";
                s_sql += "alter table " + userid + ".v_giavp alter tgtrakq type varchar2(10);\n";
                s_sql += "alter table " + sSchema + ".v_chidinh add trangthai numeric(1) default 0;\n";
                s_sql += "alter table " + sSchema + ".tiepdon alter loai type numeric(2);\n";
                s_sql += "alter table " + sSchema + ".tiepdon alter bnmoi type numeric(2);\n";
                s_sql += "create table " + userid + ".bienbantuvong(mabn varchar(10),maql numeric,makp varchar(3),chinhanh numeric(2),mabs varchar(6),manv varchar(6),nguoithan text,hotennguoidua text,namsinh varchar(4),phai numeric(1),diachi text,cmnd varchar(20),quanhe text,phuongtien text,soxe varchar(15),tinhtrang text,chandoan text,daxuly text,ngaytuvong timestamp,nguyennhan text,ykien text,taisan text,congan text,CONSTRAINT pk_bienbantuvong PRIMARY KEY (mabn),CONSTRAINT uni_phieutiemchung UNIQUE (maql),CONSTRAINT fk_bienbantuvong_btdbn FOREIGN KEY (mabn) REFERENCES " + userid + ".btdbn (mabn),CONSTRAINT fk_bienbantuvong_btdkp_bv FOREIGN KEY (makp) REFERENCES " + userid + ".btdkp_bv(makp),CONSTRAINT fk_bienbantuvong_dmchinhanh FOREIGN KEY (chinhanh) REFERENCES " + userid + ".dmchinhanh(id),CONSTRAINT fk_bienbantuvong_dmbs FOREIGN KEY (mabs) REFERENCES " + userid + ".dmbs(ma));\n";
                s_sql += "alter table " + userid + ".ct_doan add ghichuthoigianthuphatsinh text;\n";

                //ThanhCuong 01/03/2012
                s_sql += "alter table " + sSchema + ".d_dutruct add userid numeric(7) default 0;\n";
                s_sql += "alter table " + sSchema + ".d_xtutrucct add userid numeric(7) default 0;\n";
                s_sql += "alter table " + sSchema + ".d_haophict add userid numeric(7) default 0;\n";

                //ksk
                s_sql += "alter table " + userid + ".ct_doan add column laymau_tungay timestamp without time zone; ";
                s_sql += "alter table " + userid + ".ct_doan add column laymau_denngay timestamp without time zone;\n";
                s_sql += "alter table " + userid + ".ct_doan add column id_noilaymau smallint;\n";
                s_sql += "alter table " + userid + ".ct_doan add column khuvuclaymau  bit(1);\n";
                s_sql += "alter table " + userid + ".ct_doan add column diachilaymau  text;\n";
                s_sql += "alter table " + userid + ".ct_doan add column giolaymausang time without time zone;\n";
                s_sql += "alter table " + userid + ".ct_doan add column giolaymauchieu time without time zone;\n";
                s_sql += "alter table " + userid + ".ct_doan add column id_chinhanh numeric(2);\n";
                s_sql += "alter table " + userid + ".ct_doan add column thoigianthuphatsinh numeric(1) DEFAULT 0;\n";
                s_sql += "alter table " + userid + ".ct_doan add column ghichuthoigianthuphatsinh text;\n";

                s_sql += "ALTER TABLE " + sSchema + ".ct_btdbn ALTER COLUMN stt TYPE numeric(10);\n";
                s_sql += "alter table " + sSchema + ".ct_btdbn add column cmnd character varying(30);\n";
                s_sql += "alter table " + sSchema + ".ct_btdbn add column machucvu numeric;\n";
                s_sql += "alter table " + sSchema + ".ct_btdbn add column vitricongtac numeric(10);\n";
                s_sql += "alter table " + sSchema + ".ct_btdbn add column  nghenghiep character varying(8);\n";
                s_sql += "alter table " + sSchema + ".ct_btdbn add column  vip numeric(1);\n";
                s_sql += "alter table " + sSchema + ".ct_btdbn add column  idmuc numeric;\n";
                //
                s_sql += "alter table " + sSchema + ".d_thuocbhytct add column ghichu text;\n";
                s_sql += "alter table " + userid + ".theodoitsu add column loai numeric(1) default 0;\n";
                s_sql += "ALTER TABLE " + userid + ".theodoitsu add column id serial NOT NULL;\n";
                s_sql += "alter table " + userid + ".theodoitsu drop constraint pk_theodoitsu;\n";
                s_sql += "alter table " + userid + ".theodoitsu add constraint pk_theodoitsu primary key (id);\n";
                s_sql += "alter table " + userid + ".theodoitsu drop constraint pk_theodoitsu;\n";
                s_sql += "alter table " + userid + ".theodoitsu alter maicd type varchar2(22);\n";
                s_sql += "alter table " + sSchema + ".d_thuocbhytll add ngaynghi numeric(10) default 0;\n";
                s_sql += "alter table " + sSchema + ".d_thuocbhytll add ngaynghi_tungay timestamp without time zone;\n";
                s_sql += "alter table " + sSchema + ".d_thuocbhytll add songayhen numeric(2) default 0;\n";
                s_sql += "alter table " + sSchema + ".d_thuocbhytll add sotoa numeric(10) default 0;\n";//Thuy 30.03.2012

                s_sql += "alter table " + sSchema + ".v_ttrvct add ngaygiodangky timestamp;\n";
                s_sql += "alter table " + sSchema + ".v_ttrvct add idloaitg numeric(2) default 0;\n";
                s_sql += "alter table " + sSchema + ".v_ttrvct add mabs varchar(4) default 0;\n";
                s_sql += "alter table " + sSchema + ".d_dausinhton add chieucao numeric(7,2) default 0;\n";
                s_sql += "alter table " + sSchema + ".d_dausinhton add maql numeric default 0;\n";
                s_sql += "alter table " + sSchema + ".d_dausinhton add mavaovien numeric default 0;\n";
                s_sql += "alter table " + sSchema + ".d_hoantract add userid numeric(7) default 0;\n";//Thuy 03.02.12
                s_sql += "alter table " + userid + ".btdbn add chuyendi text default '" + "0".PadLeft(300, '0') + "';\n";
                s_sql += "alter table " + userid + ".lienhe add chuyendi text default '" + "0".PadLeft(300, '0') + "';\n";
                s_sql += "alter table " + userid + ".quanhe add chuyendi text default '" + "0".PadLeft(300, '0') + "';\n";
                s_sql += "CREATE TABLE " + userid + ".kyten(id serial,mabn character varying(14) NOT NULL, loaichungtu numeric(2,0), ngay date, ngayud date DEFAULT now(), userid numeric(7,0) default 0, computer varchar2(100),lydo text) WITH (OIDS = TRUE) TABLESPACE medi_data;\n";
                s_sql += "create table " + userid + ".d_kehoachdathang(id numeric,ngay timestamp,phieu numeric(12),manguon numeric(2),mua numeric(1),userid numeric(7),ngayud timestamp default now(),CONSTRAINT pk_d_kehoachdathang PRIMARY KEY (id),CONSTRAINT fk_d_kehoachdathang_d_dmnguon FOREIGN KEY (manguon) REFERENCES " + userid + ".d_dmnguon (id)) with oids;\n";
                s_sql += "create table " + userid + ".d_kehoachdathangct(id numeric,stt numeric(5),mabd numeric(7),soluong numeric(10,2),giamua numeric(10,4),vat numeric(7),slthucte numeric(10,2),CONSTRAINT pk_d_kehoachdathangct PRIMARY KEY (id,stt),CONSTRAINT fk_d_kehoachdathangct_d_dmbd FOREIGN KEY (mabd) REFERENCES " + userid + ".d_dmbd (id)) with oids;\n";
                s_sql += "create table " + userid + ".d_kehoachdathangtheodoi(id numeric,id_duyetdutrukho numeric,CONSTRAINT pk_d_kehoachdathangtheodoi PRIMARY KEY (id)) with oids;\n";
                s_sql += "create table " + userid + ".d_duyetdutrukholl(id numeric,phieu numeric(12),ngay timestamp,userid numeric(7),ngayud timestamp default now(),CONSTRAINT pk_d_duyetdutrukholl PRIMARY KEY (id)) with oids;\n";
                s_sql += "create table " + userid + ".d_duyetdutrukhoct(id numeric,stt numeric(5),mabd numeric(7),soluong numeric(10,2),sldutru numeric(10,2),CONSTRAINT pk_d_duyetdutrukhoct PRIMARY KEY (id,stt),CONSTRAINT fk_d_kehoachdathangct_d_dmbd FOREIGN KEY (mabd) REFERENCES " + userid + ".d_dmbd (id)) with oids;\n";
                s_sql += "create table " + userid + ".d_theodoiduyetdutru(id numeric,id_dutru numeric,makho numeric(5),id_chinhanh numeric(2),done numeric(1),CONSTRAINT pk_d_theodoiduyetdutru PRIMARY KEY (id)) with oids;\n";
                s_sql += "CREATE TABLE " + userid + ".blgd_vao(  mabn varchar(10) NOT NULL,  mavaovien numeric(21) NOT NULL,  maql numeric(21) NOT NULL,  ngay timestamp,  tdhv numeric(3),  tthonnhan numeric(3),  chungsong numeric(2),  contrai numeric(2),  congai numeric(2),  tennguoigaybl text,  quanhe numeric(3),  tgchiudung numeric(3),  tgchiudungkhac text,  loaibaoluc text,  ghichu text,  tiensu text,  khamtt text,  tonhaisk numeric(3),  userid numeric(7),  ngayud timestamp DEFAULT now(),  chuyendi text DEFAULT '0'::text,  CONSTRAINT pk_blgd_vao PRIMARY KEY (mabn, mavaovien),  CONSTRAINT fk_blgd_vao_blgd_nguoigaybl FOREIGN KEY (quanhe)      REFERENCES " + userid + ".blgd_nguoigaybl (id) MATCH SIMPLE      ON UPDATE RESTRICT ON DELETE NO ACTION,  CONSTRAINT fk_blgd_vao_blgd_tdhv FOREIGN KEY (tdhv)      REFERENCES " + userid + ".blgd_tdhv (id) MATCH SIMPLE      ON UPDATE RESTRICT ON DELETE NO ACTION,  CONSTRAINT fk_blgd_vao_blgd_tgchiudung FOREIGN KEY (tgchiudung)      REFERENCES " + userid + ".blgd_tgchiudung (id) MATCH SIMPLE      ON UPDATE RESTRICT ON DELETE NO ACTION,  CONSTRAINT fk_blgd_vao_blgd_tthonnhan FOREIGN KEY (tthonnhan)      REFERENCES " + userid + ".blgd_tthonnhan (id) MATCH SIMPLE      ON UPDATE RESTRICT ON DELETE NO ACTION,  CONSTRAINT fk_blgd_vao_btdbn FOREIGN KEY (mabn)      REFERENCES " + userid + ".btdbn (mabn) MATCH SIMPLE      ON UPDATE RESTRICT ON DELETE NO ACTION) WITH OIDS;ALTER TABLE " + userid + ".blgd_vao OWNER TO medisoft;\n";
                s_sql += "alter table " + userid + ".d_kehoachdathang add phieu numeric;\n";
                s_sql += "alter table " + userid + ".d_duyetdutrukholl alter id type numeric;\n";
                s_sql += "alter table " + userid + ".d_duyetdutrukholl alter userid type numeric(9);\n";
                s_sql += "alter table " + userid + ".d_duyetdutrukholl alter phieu type numeric(12);\n";
                s_sql += "alter table " + userid + ".d_duyetdutrukhoct alter id type numeric;\n";
                s_sql += "alter table " + userid + ".d_dutrukholl alter id type numeric;\n";
                s_sql += "alter table " + userid + ".d_dutrukholl alter sophieu type numeric(12);\n";
                s_sql += "alter table " + userid + ".d_dutrukhoct alter id type numeric;\n";
                s_sql += "alter table " + userid + ".d_theodoiduyetdutru alter id type numeric;\n";
                s_sql += "alter table " + userid + ".d_theodoiduyetdutru alter id_dutru type numeric;\n";
                s_sql += "alter table " + userid + ".d_kehoachdathang add phieu numeric(12);\n";
                s_sql += "alter table " + userid + ".d_kehoachdathang alter id type numeric;\n";
                s_sql += "alter table " + userid + ".d_kehoachdathang alter userid type numeric(9);\n";
                s_sql += "alter table " + userid + ".d_kehoachdathangct alter id type numeric;\n";
                s_sql += "alter table " + sSchema + ".v_vienphict add mabs varchar2(4) default 0;\n";//gam 15/02/2012
                s_sql += "alter table " + sSchema + ".v_ttrvct add mabs varchar2(4) default 0;\n";//gam 15/02/2012
                s_sql += "alter table " + sSchema + ".v_thvpct add mabs varchar2(4) default 0;\n";//gam 15/02/2012
                s_sql += "alter table " + sSchema + ".d_tienthuoc add mabs varchar2(4) default 0;\n";//gam 15/02/2012
                s_sql += "alter table " + sSchema + ".v_vienphidv add mabs varchar2(4) default 0;\n";//gam 15/02/2012
                s_sql += "alter table " + sSchema + ".d_xuatsdll add mabs varchar2(4) default 0;\n";//gam 15/02/2012

                s_sql += "alter table " + sSchema + ".v_hoantra alter column loai type numeric(2);\n";//gam 29032012
                s_sql += "alter table " + sSchema + ".lienhe alter column soluutru type character varying(15);\n"; //gam 02042012
                s_sql += "alter table " + userid + ".lienhe alter column soluutru type character varying(15);\n"; //gam 02042012
                s_sql += "alter table " + sSchema + ".d_xuatll add idchinhanh numeric(2);\n";
                s_sql += "alter table " + sSchema + ".bhytkb alter column maicd type character varying(11);\n";

                s_sql += "CREATE TABLE " + userid + ".khamchuyenkhoa(mabn character varying(10),mavaovien numeric DEFAULT 0,maql numeric NOT NULL DEFAULT 0,ngay timestamp without time zone,yeucau text,userid numeric(5) default 0,ngayud timestamp without time zone DEFAULT now(),constraint pk_khamchuyenkhoa primary key(maql),constraint fk_khamchuyenkhoa_btdbn FOREIGN KEY (mabn) REFERENCES " + userid + ".btdbn (mabn)) WITH (OIDS = TRUE) TABLESPACE medi_data;\n";
                // Hien : du tru kho 
                // tao du tru thuoc ll
                string sql11 = "create table " + user + ".d_dutrukholl(ID numeric not null,nhom numeric(2),sophieu numeric(12) not null,ngay date ,makho varchar(100),done numeric(1) not null default 0,userid numeric(5),ngayud date default now(),constraint pk_d_dutrukholl primary key(ID)) with (oids=true);\n";
                execute(sql11);
                sql11 = "create or replace Function " + user + ".upd_d_dutrukholl(d_id numeric,d_nhom numeric,d_sophieu numeric,d_ngay varchar,d_makho varchar,d_done numeric,d_userid numeric)returns void as ";
                sql11 += "\n $BODY$";
                sql11 += "\n begin ";
                sql11 += "\n update " + user + ".d_dutrukholl set  makho=d_makho, done=d_done, userid=d_userid where id=d_id and nhom=d_nhom and sophieu=d_sophieu;\n";
                sql11 += "\n if(found=false) then ";
                sql11 += "\n insert into " + user + ".d_dutrukholl(id,nhom,sophieu,ngay,makho,done,userid) values(d_id,d_nhom,d_sophieu,to_date(d_ngay,'dd/mm/yyyy'),d_makho,d_done,d_userid);\n";
                sql11 += "\n end if;\n";
                sql11 += "\n end;\n";
                sql11 += "\n $BODY$ ";
                sql11 += "\n language 'plpgsql' volatile;\n";
                execute(sql11);
                sql11 = "create or replace function " + user + ".del_d_dutrukho(d_id numeric,d_sophieu numeric)";
                sql11 += "returns void as";
                sql11 += "\n $BODY$";
                sql11 += "\n begin ";
                sql11 += "\n delete from " + user + ".d_dutrukhoct where id=d_id;\n";
                sql11 += "\n delete from " + user + ".d_dutrukholl where id=d_id and sophieu=d_sophieu;\n";
                sql11 += "\n end;\n";
                sql11 += "\n $BODY$";
                sql11 += "\n language 'plpgsql' volatile;  ";
                execute(sql11);
                // du tru kho ct
                sql11 = "create table " + user + ".d_dutrukhoct (ID numeric not null,stt numeric(5) not null default 0,mabd numeric(9) not null,slton numeric(14,2) not null default 0,xuat10 numeric(14,2) not null default 0,xuat30 numeric(14,2) not null default 0,xuat numeric(1) not null default 0,slgoiy numeric(14,2) not null default 0,soluong numeric(14,2) not null default 0,donvi varchar(50),nhacc varchar(50),manguon varchar(50),lydo text,constraint pk_d_dutrukhoct primary key(ID,stt,mabd),constraint fk_d_dutrukhoct_d_dutrukholl foreign key(ID) references " + user + ".d_dutrukholl(ID) match simple ON UPDATE RESTRICT ON DELETE RESTRICT)with (oids=true);\n";
                execute(sql11);

                sql11 = "create or replace Function " + user + ".upd_d_dutrukhoct(d_id numeric,d_stt numeric,d_mabd numeric,d_slton numeric,d_xuat10 numeric,d_xuat30 numeric,d_slgoiy numeric,d_soluong numeric,d_donvi varchar,d_nhacc varchar,d_manguon varchar,d_lydo varchar)returns void as ";
                sql11 += "\n $BODY$";
                sql11 += "\n begin ";
                sql11 += "\n update " + user + ".d_dutrukhoct set slton=d_slton, xuat10=d_xuat10, xuat30=d_xuat30,slgoiy=d_slgoiy,soluong=d_soluong,donvi=d_donvi,nhacc=d_nhacc,manguon=d_manguon,lydo=d_lydo,stt=d_stt where id=d_id  and mabd=d_mabd;\n";
                sql11 += "\n if(found=false) then ";
                sql11 += "\n insert into " + user + ".d_dutrukhoct(id,stt,mabd,slton,xuat10,xuat30,slgoiy,soluong,donvi,nhacc,manguon,lydo) values(d_id,d_stt,d_mabd,d_slton,d_xuat10,d_xuat30,d_slgoiy,d_soluong,d_donvi,d_nhacc,d_manguon,d_lydo);\n";
                sql11 += "\n end if;\n";
                sql11 += "\n end;\n";
                sql11 += "\n $BODY$";
                sql11 += "\n language 'plpgsql' volatile;\n";
                execute(sql11);
                // duyet du tru ll
                sql11 = "create table " + user + ".d_duyetdutrukholl(id numeric not null default 0,phieu numeric(12) not null,ngay date ,userid numeric(5),constraint pk_d_duyetdutrukholl primary key(id)) with(oids=true)";
                execute(sql11);

                sql11 = "create or replace function " + user + ".upd_d_duyetdutrukholl(d_id numeric,d_phieu numeric,d_ngay varchar,d_user numeric)returns void as";
                sql11 += "\n $BODY$";
                sql11 += "\n begin";
                sql11 += "\n update " + user + ".d_duyetdutrukholl set ngay=to_date(d_ngay,'dd/mm/yyyy'),userid=d_user where id=d_id and phieu=d_phieu;\n";
                sql11 += "\n if found=false then ";
                sql11 += "\n insert into " + user + ".d_duyetdutrukholl(id,phieu,ngay,userid) values (d_id,d_phieu,to_date(d_ngay,'dd/mm/yyyy'),d_user);\n";
                sql11 += "\n end if;\n";
                sql11 += "\n end;\n";
                sql11 += "\n $BODY$";
                sql11 += "\n language 'plpgsql' volatile;\n";
                execute(sql11);
                // duyet du tru kho ct
                sql11 = "create table " + user + ".d_duyetdutrukhoct(id numeric not null,stt numeric(5) not null default 1,mabd numeric(9) not null,soluong numeric(14,2) not null default 0,sldutru numeric(14,2) not null,constraint pk_d_duyetdutrukhoct primary key (id,stt),constraint fk_d_duyetdutrukhoct_d_duyetdutrukholl foreign key(ID)references " + user + ".d_duyetdutrukholl(ID) match simple ON UPDATE RESTRICT ON DELETE RESTRICT)";
                execute(sql11);

                sql11 = "create or replace function " + user + ".upd_d_duyetdutrukhoct(d_id numeric,d_stt numeric,d_mabd numeric,d_soluong numeric,d_sldutru numeric) returns void as ";
                sql11 += "\n $BODY$";
                sql11 += "\n begin";
                sql11 += "\n update " + user + ".d_duyetdutrukhoct set stt=d_stt,soluong=d_soluong,sldutru=d_sldutru where id=d_id and mabd=d_mabd;\n";
                sql11 += "\n if found= false then";
                sql11 += "\n insert into " + user + ".d_duyetdutrukhoct (id,stt,mabd,soluong,sldutru) values(d_id,d_stt,d_mabd,d_soluong,d_sldutru);\n";
                sql11 += "\n end if;\n";
                sql11 += "\n end;\n";
                sql11 += "\n $BODY$";
                sql11 += "\n language 'plpgsql' volatile;\n";
                execute(sql11);
                // theo doi duyet du tru 
                sql11 = "create table " + user + ".d_theodoiduyetdutru(id numeric not null,id_dutru numeric not null,makho numeric(5) ,id_chinhanh numeric(3), done numeric(1) not null default 0,constraint pk_d_theodoiduyetdutru primary key(id))with (oids=true)";
                execute(sql11);

                sql11 = "create or replace function " + user + ".upd_d_theodoiduyetdutru(d_id numeric,d_iddutru numeric,d_makho numeric,d_idchinhanh numeric,d_done numeric) returns void as";
                sql11 += "\n $BODY$";
                sql11 += "\n begin";
                sql11 += "\n update " + user + ".d_theodoiduyetdutru set id_chinhanh=d_idchinhanh,makho=d_makho,id_dutru=d_iddutru,done=d_done where id=d_id;\n";
                sql11 += "\n if found =false then";
                sql11 += "\n insert into " + user + ".d_theodoiduyetdutru(id,id_dutru,makho,id_chinhanh,done) values (d_id,d_iddutru,d_makho,d_idchinhanh,d_done);\n";
                sql11 += "\n end if;\n";
                sql11 += "\n update " + user + ".d_dutrukholl set done =2 where id=d_iddutru;\n";
                sql11 += "\n end;\n";
                sql11 += "\n $BODY$";
                sql11 += "\n language 'plpgsql' volatile;\n";
                execute(sql11);

                sql11 = "create or replace function " + user + ".huy_duyetdutrukho(d_id numeric,d_iddutru numeric,d_makho numeric,d_sophieu numeric)returns void as";
                sql11 += "\n $BODY$";
                sql11 += "\n begin ";
                sql11 += "\n delete " + user + ".d_theodoiduyetdutru where id=d_id and makho=d_makho and id_dutru=d_iddutru and done<>2;\n";
                sql11 += "\n if found = false then exit;\n";
                sql11 += "\n end if;\n";
                sql11 += "\n delete " + user + ".d_duyetdutrukhoct where id=d_id;\n";
                sql11 += "\n delete " + user + ".d_duyetdutrukholl where id=d_id and phieu=d_sophieu;\n";
                sql11 += "\n update " + user + ".d_dutrukholl set done=1 where id=d_iddutru;\n";
                sql11 += "\n end;\n";
                sql11 += "\n $BODY$";
                sql11 += "\n language 'plpgsql' volatile;\n";
                execute(sql11);
                //-- Du tru co so tu truc--
                sql11 = "create table " + userid + ".d_dutrucsttll(ID numeric(22) not null,nhom numeric(2),sophieu varchar2(12) not null,ngay date ," +
                    " makho numeric(5),nhomkp varchar(3), matutruc numeric(5),makp numeric(5) not null, done numeric(1) not null default 0,userid numeric(7)," +
                    " ngayud date not null default now(),constraint pk_d_dutrucsttll primary key(ID)) with (oids=true);\n";
                execute(sql11);
                sql11 = " create or replace function " + userid + ".upd_d_dutrucsttll(d_id numeric,d_nhom numeric,d_sophieu varchar,d_ngay varchar," +
                    "d_makho numeric,d_nhomkp varchar,d_matutruc numeric, d_makp numeric,d_done numeric,d_userid numeric) returns void as " +
                      "\n $BODY$ " +
                      "\n begin  " +
                      "\n update " + userid + ".d_dutrucsttll set nhom=d_nhom,sophieu=d_sophieu,done=d_done, makho=d_makho,matutruc=d_matutruc, makp=d_makp,ngay=to_date(d_ngay,'dd/mm/yyyy') where id=d_id;" +
                      "\n   if found=false then " +
                      "\n   insert into " + userid + ".d_dutrucsttll(id,nhom,sophieu,ngay,makho,nhomkp,matutruc,makp,done,userid) values (d_id,d_nhom,d_sophieu,to_date(d_ngay,'dd/mm/yyyy'),d_makho,d_nhomkp,d_matutruc,d_makp,d_done,d_userid);" +
                      "\n   end if;" +
                      "\n end;" +
                      "\n $BODY$ " +
                      "\n language 'plpgsql' volatile;\n";
                execute(sql11);
                //------- Du tru co so tu truc ct -----
                sql11 = "create table " + userid + ".d_dutrucsttct (ID numeric not null,stt numeric(5) not null default 0,mabd numeric(9) not null," +
                    "slton numeric(14,2) not null default 0,csduyet numeric(14,2) not null default 0,soluong numeric(14,2) not null default 0," +
                    "donvi varchar(50),nhacc varchar(50),manguon varchar(50),lydo text,constraint pk_d_dutrucsttct primary key(ID,stt,mabd)," +
                    "constraint fk_d_dutrucsttct_d_dutrucsttll foreign key(ID) references " + userid + ".d_dutrucsttll(ID) match simple ON UPDATE RESTRICT ON DELETE RESTRICT )with (oids=true);\n";
                execute(sql11);
                sql11 = "create or replace function " + userid + ".upd_d_dutrucsttct(d_id numeric,d_stt numeric,d_mabd numeric,d_slton numeric,d_csduyet numeric," +
                    "d_soluong numeric,d_donvi varchar,d_nhacc varchar,d_manguon varchar,d_lydo varchar) returns void as " +
                     "\n $BODY$ " +
                     "\n begin " +
                     "\n   update " + userid + ".d_dutrucsttct set stt=d_stt,slton=d_slton,csduyet=d_csduyet,soluong=d_soluong,donvi=d_donvi,nhacc=d_nhacc,manguon=d_manguon,lydo=d_lydo where id=d_id and mabd=d_mabd;" +
                     "\n   if found=false then " +
                     "\n   insert into " + userid + ".d_dutrucsttct(id,stt,mabd,slton,csduyet,soluong,donvi,nhacc,manguon,lydo) values (d_id,d_stt,d_mabd,d_slton,d_csduyet,d_soluong,d_donvi,d_nhacc,d_manguon,d_lydo); " +
                     "\n   end if; " +
                     "\n end; " +
                     "\n $BODY$ " +
                     "\n language 'plpgsql' volatile; ";
                execute(sql11);
                // -------------- Xoa du tru co so tt -----------
                sql11 = "create or replace function " + userid + ".del_d_dutrucstt(d_id numeric,d_sophieu numeric,d_ngay varchar) returns void as " +
                "\n $BODY$ " +
                "\n begin " +
                "\n    delete from " + userid + ".d_dutrucsttct where id=d_id; " +
                "\n    delete from " + userid + ".d_dutrucsttll where id=d_id;" +
                "\n end; " +
                "\n $BODY$ " +
                "\n language 'plpgsql' volatile; ";
                execute(sql11);
                sql11 = "alter table " + userid + ".d_cosotutruc alter makp type numeric(5)";
                execute(sql11);
                //---------------------------d_duyetdutrucsttll--------------------------------------
                sql11 = "create table " + userid + ".d_duyetdutrucsttll(id numeric not null default 0,phieu numeric(12) not null,ngay date ,userid numeric(5),constraint pk_d_duyetdutrucsttll primary key(id)) with(oids=true)";
                execute(sql11);
                //---function update
                sql11 = "create or replace function " + userid + ".upd_d_duyetdutrucsttll(d_id numeric,d_phieu numeric,d_ngay varchar,d_user numeric) " +
                "\n returns void as " +
                "\n $BODY$ " +
                "\n begin " +
                "\n update " + userid + ".d_duyetdutrucsttll set ngay=to_date(d_ngay,'dd/mm/yyyy'),userid=d_user where id=d_id and phieu=d_phieu; " +
                "\n if found=false then  " +
                "\n insert into " + userid + ".d_duyetdutrucsttll(id,phieu,ngay,userid) values (d_id,d_phieu,to_date(d_ngay,'dd/mm/yyyy'),d_user); " +
                "\n end if; " +
                "\n end; " +
                "\n $BODY$ " +
                "\n language 'plpgsql' volatile; " +
                execute(sql11);
                //---------------- d_duyetdutrucsttct ------------
                sql11 = "create table " + userid + ".d_duyetdutrucsttct ( id numeric not null,stt numeric(5) not null default 1,mabd numeric(9) not null,soluong numeric(14,2) not null default 0,sldutru numeric(14,2) not null,constraint pk_d_duyetdutrucsttct primary key (id,stt),constraint fk_d_duyetdutrucsttct_d_duyetdutrucsttll foreign key(ID)references " + userid + ".d_duyetdutrucsttll(ID) match simple ON UPDATE RESTRICT ON DELETE RESTRICT)";
                execute(sql11);
                //--- create function---
                sql11 = "create or replace function " + userid + ".upd_d_duyetdutrucsttct(d_id numeric,d_stt numeric,d_mabd numeric,d_soluong numeric,d_sldutru numeric) " +
                "\n returns void as  " +
                "\n $BODY$ " +
                "\n begin " +
                "\n update " + userid + ".d_duyetdutrucsttct set stt=d_stt,soluong=d_soluong,sldutru=d_sldutru where id=d_id and mabd=d_mabd; " +
                "\n if found= false then " +
                "\n insert into " + userid + ".d_duyetdutrucsttct (id,stt,mabd,soluong,sldutru) values(d_id,d_stt,d_mabd,d_soluong,d_sldutru); " +
                "\n end if; " +
                "\n end; " +
                "\n $BODY$ " +
                "\n language 'plpgsql' volatile; ";
                execute(sql11);
                //----------------------------- d_theodoiduyetdutrucstt -----------
                sql11 = "create table " + userid + ".d_theodoiduyetdutrucstt(id numeric not null,id_dutru numeric not null,makho numeric(5) ,makp numeric(5),done numeric(1) not null default 0, constraint pk_d_theodoiduyetdutrucstt primary key(id))with (oids=true)";
                execute(sql11);
                //--- create function ---
                sql11 = "create or replace function " + userid + ".upd_d_theodoiduyetdutrucstt(d_id numeric,d_iddutru numeric,d_makho numeric,d_makp numeric,d_done numeric) " +
                "\n returns void as " +
                "\n $BODY$ " +
                "\n begin " +
                "\n update " + userid + ".d_theodoiduyetdutrucstt set makho=d_makho,id_dutru=d_iddutru,done=d_done where id=d_id; " +
                "\n if found =false then " +
                "\n insert into " + userid + ".d_theodoiduyetdutrucstt(id,id_dutru,makho,makp,done) values (d_id,d_iddutru,d_makho,d_makp,d_done); " +
                "\n end if; " +
                "\n update " + userid + ".d_dutrucsttll set done =1 where id=d_iddutru; " +
                "\n end; " +
                "\n $BODY$ " +
                "\n language 'plpgsql' volatile;\n";
                execute(sql11);
                //---- Huy du tru kho ------ 
                sql11 = "create or replace function " + userid + ".huy_duyetdutrucstt(d_id numeric,d_iddutru numeric,d_makho numeric,d_sophieu numeric,d_makp varchar) " +
                "\n returns void as " +
                "\n $BODY$ " +
                "\n begin  " +
                "\n delete " + userid + ".d_theodoiduyetdutrucstt where id=d_id and makho=d_makho and id_dutru=d_iddutru and makp=d_makp ; " +
                "\n if found = false then exit; " +
                "\n end if; " +
                "\n delete " + userid + ".d_duyetdutrucsttct where id=d_id; " +
                "\n delete " + userid + ".d_duyetdutrucsttll where id=d_id and phieu=d_sophieu; " +
                "\n update " + userid + ".d_dutrucsttll set done=2 where id=d_iddutru; " +
                "\n end; " +
                "\n $BODY$ " +
                "\n language 'plpgsql' volatile; ";
                execute(sql11);
                // end hien
                s_sql += "alter table " + userid + ".d_dmbd add stt_chaohang varchar2(20);\n";
                s_sql += "alter table " + userid + ".d_dmbd alter column madv type numeric(7);\n";
                s_sql += "alter table " + userid + ".d_dmbd add stt_dm12 varchar2(20);\n";
                s_sql += "alter table " + userid + ".d_dmbd add ngaycapsdk timestamp without time zone;\n";
                s_sql += "alter table " + userid + ".d_dmbd add vat numeric(3);\n";
                s_sql += "alter table " + userid + ".d_dmbd add gia_phuthu numeric(24,8) default 0;\n";
                s_sql += "alter table " + userid + ".d_dmbd add gia_cucduoc numeric(24,8) default 0;\n";
                s_sql += "alter table " + userid + ".d_dmbd add vtyt numeric(1) default 0;\n";
                s_sql += "alter table " + userid + ".d_dmbd add stt02 character varying(20);\n";
                s_sql += "alter table " + userid + ".d_dmbd add sttvb character varying(20);\n";
                s_sql += "alter table " + userid + ".d_dmbd add vacxin numeric(1) DEFAULT 0;\n";
                s_sql += "alter table " + sSchema + ".d_nhapll alter id type numeric;\n";
                s_sql += "alter table " + sSchema + ".v_chidinh add userid_duyet numeric(7) default 0;\n";
                s_sql += "CREATE TABLE " + userid + ".d_chonhapll(id numeric(22,0) NOT NULL DEFAULT 0,nhom numeric(2,0) DEFAULT 0,sophieu character " +
                    " varying(10),ngaysp timestamp without time zone,loai character varying(2),ngayud timestamp without time zone DEFAULT now()," +
                    " done numeric(1,0) DEFAULT 0,idchinhanhchuyen numeric(2,0) DEFAULT 0,idchinhanhnhan numeric(2,0) DEFAULT 0,userid numeric(7,0)," +
                    " chuyendi text, CONSTRAINT pk_d_chonhapll PRIMARY KEY (id) USING INDEX TABLESPACE medi_index)WITH ( OIDS=TRUE);\n";
                s_sql += "ALTER TABLE " + userid + ".d_chonhapll OWNER TO medisoft;\n";
                s_sql += "CREATE TABLE " + userid + ".d_chonhapct(id numeric(22,0) NOT NULL DEFAULT 0,stt numeric(3,0) NOT NULL DEFAULT 0," +
                    "mabd numeric(10,0) DEFAULT 0,handung character varying(10),losx character varying(20),vat numeric(3,0) DEFAULT 0," +
                    "soluong numeric(12,4) DEFAULT 0,dongia numeric(24,10) DEFAULT 0,sotien numeric(15,4) DEFAULT 0,giaban numeric(22,0) DEFAULT 0," +
                    "giamua numeric(24,10) DEFAULT 0,manguon numeric(2,0) DEFAULT 0,nhomcc numeric(4,0) DEFAULT 0,chuyendi text," +
                    "ngayud timestamp without time zone DEFAULT now(),CONSTRAINT pk_d_chonhapct PRIMARY KEY (id, stt) USING INDEX TABLESPACE medi_index," +
                    " CONSTRAINT fk_d_chonhapct_d_chonhapll FOREIGN KEY (id) REFERENCES " + userid + ".d_chonhapll (id) MATCH SIMPLE" +
                    " ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_chonhapct_d_dmbd FOREIGN KEY (mabd)REFERENCES " + userid + ".d_dmbd (id) MATCH SIMPLE" +
                    " ON UPDATE RESTRICT ON DELETE RESTRICT,CONSTRAINT fk_d_chonhapct_d_dmnguon FOREIGN KEY (manguon)REFERENCES " + userid + ".d_dmnguon (id) MATCH SIMPLE" +
                    " ON UPDATE RESTRICT ON DELETE RESTRICT)WITH (OIDS=TRUE);\n";
                s_sql += "ALTER TABLE " + userid + ".d_chonhapct OWNER TO " + owner + ";\n";
                s_sql += "alter table " + sSchema + ".d_xuatct add mavach numeric(22);\n";
                s_sql += "alter table " + sSchema + ".d_ngtruct add mavach numeric(22);\n";
                s_sql += "alter table " + sSchema + ".bhytthuoc add mavach numeric(22);\n";
                s_sql += "alter table " + sSchema + ".d_ngtrull add quyenso numeric(7) default 0;\n";
                s_sql += "alter table " + sSchema + ".d_ngtrull add sobienlai numeric(10) default 0;\n";
                s_sql += "ALTER TABLE " + userid + ".d_capid alter ma type numeric(4);\n";
                s_sql += "alter table " + userid + ".benhantc add nguoinhap numeric(7) default 0;\n";
                s_sql += "alter table " + sSchema + ".d_nhapll add id_kehoachdathang numeric(22) default 0;\n";
                s_sql += "alter table " + userid + ".xutrikb add hide numeric(1) default 0;\n";
                s_sql += "alter table " + sSchema + ".v_chidinh add idchinhanh numeric(2) default 0;\n";
                s_sql += "alter table " + sSchema + ".v_chidinh add trangthai numeric(1) default 0;\n";
                s_sql += "alter table " + sSchema + ".v_chidinh add xn_goidi numeric(1) default 0;\n";
                s_sql += "alter table " + sSchema + ".v_chidinh add kskphatsinh numeric(1) default 0;\n";
                s_sql += "alter table " + sSchema + ".v_chidinh add id_goi numeric(22) default 0;\n";
                s_sql += "alter table " + sSchema + ".v_chidinh add chuyendi text default lpad(300,'0');\n";
                s_sql += "alter table " + sSchema + ".bhyt add chuyendi text default lpad(300,'0');\n";
                s_sql += "alter table " + sSchema + ".lienhe add chuyendi text default lpad(300,'0');\n";
                s_sql += "alter table " + sSchema + ".tiepdon add chuyendi text default lpad(300,'0');\n";
                s_sql += "alter table " + sSchema + ".benhanpk add chuyendi text default lpad(300,'0');\n";
                s_sql += "alter table " + sSchema + ".benhancc add chuyendi text default lpad(300,'0');\n";
                s_sql += " alter table " + userid + ".btdkp_bv add khonghiendien_chochidinh numeric(1) default 0;\n";
                s_sql += " alter table " + userid + ".btdkp_bv add khonghiendien_chodutru numeric(1) default 0;\n";

                s_sql += "alter table " + sSchema + ".v_chidinh add chandoansobo text;\n";
                s_sql += "alter table " + sSchema + ".bhytkb add idttrv numeric(22) default 0;\n";
                s_sql += "alter table " + sSchema + ".d_ngtrull add idttrv numeric(22) default 0;\n";
                s_sql += "alter table " + userid + ".chuyenvien add lydotraituyen text;\n";
                s_sql += "alter table " + sSchema + ".d_xtutrucct add sttt numeric(22);\n";
                s_sql += "alter table " + sSchema + ".lydokham add id_lydokham text default '+';\n";
                s_sql += "alter table " + sSchema + ".lydokham add id_lydodungtuyen text default '+';\n";
                s_sql += "alter table " + sSchema + ".lydokham add chuyendi text default lpad('300','0');\n";
                s_sql += "CREATE TABLE " + userid + ".theodoinhietdo(id_phongthuchiencls numeric(3) not null," +
                    "ngay date not null,nhietdo_sang numeric(3) ,nhietdo_chieu numeric(3),userid numeric(7) default 0,ngayud date default now(), " +
                    "CONSTRAINT pk_theodoinhietdolanh PRIMARY KEY (id_phongthuchiencls,ngay) USING INDEX TABLESPACE medi_index," +
                    "CONSTRAINT fk_theodoinhietdo_phongthuchiencls FOREIGN KEY (id_phongthuchiencls) REFERENCES " + userid +
                    ".dmphongthuchiencls (id) ON UPDATE RESTRICT ON DELETE no action, " +
                    "CONSTRAINT fk_theodoinhietdo_dlogin FOREIGN KEY (userid) REFERENCES " + userid +
                    ".dlogin(id) ON UPDATE RESTRICT ON DELETE no action " +
                    " )WITH ( OIDS=TRUE);\n";
                s_sql += "CREATE TABLE " + userid + ".theodoivltl " +
                        "        (" +
                        "       id numeric(22) DEFAULT 0," +
                        "      mabn character varying(10)," +
                        "     mavaovien numeric(22) DEFAULT 0," +
                        "    maql numeric(22) NOT NULL DEFAULT 0," +
                        "   ngay timestamp without time zone," +
                        "  mabs character varying(6) NOT NULL," +
                        " sieuam text," +
                        "keodan text," +
                        "        dien text," +
                        "       tutruong text," +
                        "      apsuat text," +
                        "     khac text," +
                        "    userid numeric(5) DEFAULT 0," +
                        "   ngayud timestamp without time zone DEFAULT now()," +
                        "  constraint pk_theodoivltl primary key(id)" +
                        " )WITH OIDS;ALTER TABLE " + userid + ".theodoivltl OWNER TO " + owner + ";\n";

                //
                s_sql += "alter table " + sSchema + ".v_ttrvct add dongchitra numeric(1) default 0;\n";
                s_sql += "alter table " + sSchema + ".v_ttrvct add mabs varchar(4);\n";//
                s_sql += "alter table " + sSchema + ".v_ttrvct add dongchitra numeric(1) default 0;\n";//1: la dich vu can tinh lai dong chi tra, 0: bhyt chi tra da xet
                s_sql += "alter table " + sSchema + ".v_ttrvct add ngaygiodangky timestamp default now();\n";//1: la dich vu can tinh lai dong chi tra, 0: bhyt chi tra da xet
                s_sql += "alter table " + sSchema + ".v_ttrvct add idloaitg numeric(2) default 0;\n";//1: la dich vu can tinh lai dong chi tra, 0: bhyt chi tra da xet
                s_sql += "alter table " + sSchema + ".v_ttrvll add sokham varchar(20);\n";

                s_sql += "alter table " + sSchema + ".v_ttrvct add makp varchar(3) default 0;\n";
                s_sql += "alter table " + sSchema + ".v_ttrvct add mabs varchar(4) default 0;\n";
                s_sql += "alter table " + sSchema + ".v_ttrvct add losx varchar(20) default 0;\n";
                s_sql += "alter table " + sSchema + ".v_ttrvct add handung varchar(10) default 0;\n";
                s_sql += "alter table " + sSchema + ".v_ttrvct add idchinhanh numeric(2) default 0;\n";
                s_sql += "alter table " + sSchema + ".v_ttrvct add idchinhanhden numeric(2) default 0;\n";
                s_sql += "CREATE TABLE " + userid + ".dmloaibhyt_chinhsach(  id numeric(5) NOT NULL,  ma varchar(2),  tu numeric(2),  den numeric(2),  chieudai numeric(2),trongtinh numeric(3),ngoaitinh numeric(3),  hide numeric(1) default 0,  CONSTRAINT pk_dmloaibhyt_chinhsach PRIMARY KEY (ma) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + userid + ".dmloaibhyt_chinhsach OWNER TO " + owner + ";\n";//gam 02/12/2011
                // gam
                s_sql += "alter table " + sSchema + ".v_tamung add ngaytra timestamp;\n";
                s_sql += "alter table " + sSchema + ".v_tontamung add ngaytra timestamp;\n";
                s_sql += "alter table " + sSchema + ".v_ttrvll add madoituong number(2) default 0;\n";
                s_sql += "alter table " + sSchema + ".v_ttrvds add dain38 numeric default 0;\n";

                s_sql += "alter table " + sSchema + ".d_ngtrull add idttrv number default 0;\n";
                s_sql += "alter table " + sSchema + ".d_ngtrull add quyenso numeric default 0;\n";
                s_sql += "alter table " + sSchema + ".d_ngtrull add sobienlai numeric default 0;\n";
                s_sql += "alter table " + sSchema + ".d_ngtrull add userid_vp numeric(5) default 0;\n";//Thuy 29.02.2012
                s_sql += "alter table " + userid + ".d_doituong add makho varchar(128);\n";

                s_sql += "alter table " + sSchema + ".v_thvpll alter giuong type character varying(100);\n";//Khuong 05/11/2011

                s_sql += "alter table " + userid + ".xutrikb add hide numeric(1) default 0;\n";
                s_sql += "alter table " + userid + ".d_dmnguon add mien numeric(1) default 0;\n";
                s_sql += "alter table " + userid + ".dmgiuong add khongdung numeric(1) default 0;\n";
                s_sql += "alter table " + userid + ".dmpttt add sande numeric(1) default 0;\n";//khuong 11/11
                s_sql += "CREATE TABLE " + userid + ".dmloidan (  id numeric(2) NOT NULL DEFAULT 0,  ten text,  "+
                    "CONSTRAINT pk_dmloidan PRIMARY KEY (id))WITH (OIDS=TRUE);"+
                    "ALTER TABLE " + userid + ".dmloidan OWNER TO " + owner + ";\n"; //Khuong 16/11/2011

                s_sql += "alter table " + sSchema + ".tainangt add nguyennhantuvong numeric(1) default 0;\n";//Khuong 25/11/2011 them nguyen nhan tu vong trong form tai nan giao thong
                s_sql += "alter table " + sSchema + ".v_vpkhoa add idcha numeric default 0;\n"; //Khuong 29/11/2011 
                s_sql += "alter table " + sSchema + ".bhytkb add bove numeric(1) default 0;\n"; // Khuong 06/12/2011
                s_sql += "alter table " + sSchema + ".d_dutrull add userid numeric(5) default 0;\n";
                s_sql += "alter table " + sSchema + ".d_xtutrucct add loaipttt numeric(1) default 0;\n";
                s_sql += "alter table " + sSchema + ".v_vienphill add dain numeric(1) default 0;\n";
                s_sql += "alter table " + sSchema + ".v_ttrvll add chinhsach numeric(3) default 0;\n";

                //Khuong 15/12/2011
                s_sql += "CREATE TABLE " + userid + ".pttt_phuongphap(  id numeric NOT NULL DEFAULT 0,  mapt character varying(6), tenpt text, userid numeric(7) DEFAULT 0, ngayud timestamp without time zone DEFAULT now(), CONSTRAINT pk_pttt_phuongphap PRIMARY KEY (id,mapt) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_pttt_phuongphap_dmpttt FOREIGN KEY (mapt) REFERENCES " + userid + ".dmpttt (mapt))WITH (OIDS=TRUE);ALTER TABLE " + userid + ".pttt_phuongphap OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + userid + ".pttt_chandoan( id numeric NOT NULL DEFAULT 0, maicd character varying(9), chandoan text, loai numeric(1) default 0, userid numeric(7) DEFAULT 0, ngayud timestamp without time zone DEFAULT now(), CONSTRAINT pk_pttt_chandoan PRIMARY KEY (id,maicd,loai) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_pttt_chandoan_icd10 FOREIGN KEY (maicd) REFERENCES " + userid + ".icd10 (cicd10))WITH (OIDS=TRUE);ALTER TABLE " + userid + ".pttt_chandoan OWNER TO " + owner + ";\n";

                execute("create table " + userid + ".v_giagiuongbhyt (id numeric(3) NOT NULL,ten text,dongia numeric(10) default 0,makpbo text,userid numeric(5),ngayud timestamp without time zone DEFAULT now(), CONSTRAINT pk_v_giagiuongbhyt PRIMARY KEY (id)); ALTER TABLE " + userid + ".v_giagiuongbhyt OWNER TO " + owner + ";");//Khuong 02/12/2011
                execute("insert into " + userid + ".v_giagiuongbhyt (id,ten,makpbo) values (1,'Ngày giường bệnh hồi sức cấp cứu, ngày đẻ và 02 ngày sau đẻ','02');insert into " + userid + ".v_giagiuongbhyt (id,ten,makpbo) values (2,'Các khoa truyền nhiễm, Hô hấp, Tim mạch, Thần kinh, Huyết học, Ung thư, Tiêu hoá, Nhi,  Thận học,  ngày thứ 3 sau  đẻ trở đi, ngày điều trị ngoại khoa sau mổ kể từ ngày thứ 11 trở đi','11,03,10,28,04,14,17,05,07');insert into " + userid + ".v_giagiuongbhyt (id,ten,makpbo) values (3,'Các khoa Cơ - Xương - Khớp, Da liễu, Dị ứng Tai-Mũi-Họng, Mắt, RHM, Ngoại, Phụ sản không mổ','06,13,09,23,25,24,18');insert into " + userid + ".v_giagiuongbhyt (id,ten,makpbo) values (4,'Các khoa đông y, phục hồi chức năng','16,26');insert into " + userid + ".v_giagiuongbhyt (id,ten,makpbo) values (5,'Sau phẩu thuật loại đặc biệt, bỏng loại 3,  4 > 70%','');insert into " + userid + ".v_giagiuongbhyt (id,ten,makpbo) values (6,'Sau các phẩu thuật loại 1, bỏng loại 3, 4 từ 25-70 %','');insert into " + userid + ".v_giagiuongbhyt (id,ten,makpbo) values (7,'Sau các phẩu thuật loại 2 ,bỏng độ 2 > 30% bỏng  độ 3, 4 < 25%','');insert into " + userid + ".v_giagiuongbhyt (id,ten,makpbo) values (8,'Sau các phẩu thuật loại 3, bỏng độ 1, 2 <30%','');");
                execute("update " + userid + ".v_giagiuongbhyt set makpbo='06,13,09,23,25,24,18,22,18' where id=3;");
                //Khuong 02/11 rang buoc so luong khong duoc <0
                s_sql += "alter table " + userid + ".dmgiuong add check (soluong>=0);\n";
                // thuy 21/12/2011 
                s_sql += "ALTER TABLE " + userid + ".benhandt ADD COLUMN para character varying(8) DEFAULT 0;\n";
                s_sql += "ALTER TABLE " + userid + ".xuatvien ADD COLUMN para character varying(8) DEFAULT 0;\n";
                s_sql += "ALTER TABLE " + userid + ".xuatkhoa ADD COLUMN para character varying(8) DEFAULT 0;\n";
                s_sql += "ALTER TABLE " + userid + ".nhapkhoa ADD COLUMN para character varying(8) DEFAULT 0;\n";// thuy
                s_sql += "alter table " + sSchema + ".v_vienphill add column dain numeric(1) default 0;\n";//Thuy 28.12.2011
                // Thuy 30.12.2011 -> bảng dm_11_dk_1 , biểu 15-2010
                s_sql += "CREATE TABLE " + userid + ".dm_11_dk_1(ma character varying(3),ten text,dk text)WITH (OIDS=FALSE);ALTER TABLE " + userid + ".dm_11_dk_1 OWNER TO " + owner + ";\n";
                s_sql += "delete from " + userid + ".dm_11_dk_1;\n";
                s_sql += "insert into " + userid + ".dm_11_dk_1 values('C01','<Tại khoa khám bệnh/Tổng số>','(C01>=MAX(C02,C03,C04)');\n";
                s_sql += "insert into " + userid + ".dm_11_dk_1 values('C02','<Tại khoa khám bệnh/Trong đó Nữ>','(C02<=C01)');\n";
                s_sql += "insert into " + userid + ".dm_11_dk_1 values('C03','<Tại khoa khám bệnh/Trong đó TE<15 tuổi>','(C03<=C01)');\n";
                s_sql += "insert into " + userid + ".dm_11_dk_1 values('C04','<Tại khoa khám bệnh/trong đó Số tử vong>','(C04<=C01)');\n";
                s_sql += "insert into " + userid + ".dm_11_dk_1 values('C05','<Điều trị nội trú/Tổng số/Mắc/Tổng số >','(C05>=MAX(C07,C09,C11))');\n";
                s_sql += "insert into " + userid + ".dm_11_dk_1 values('C06','<Điều trị nội trú/Tổng số/Mắc / trong đó Nữ >','(C06<= C05)');\n";
                s_sql += "insert into " + userid + ".dm_11_dk_1 values('C07','<Điều trị nội trú/Tổng số/Số tử vong/ Tổng số >','(C07<=C05)');\n";
                s_sql += "insert into " + userid + ".dm_11_dk_1 values('C08','<Điều trị nội trú/Tổng số/Số tử vong / trong đó Nữ >','(C08<=C07)');\n";
                s_sql += "insert into " + userid + ".dm_11_dk_1 values('C09','<Điều trị nội trú/Trong đó TE<15 tuổi /Mắc/ Tổng số >','(C09<=C05)');\n";
                s_sql += "insert into " + userid + ".dm_11_dk_1 values('C10','<Điều trị nội trú/Trong đó TE<15 tuổi/Mắc/Nữ>','(C10<=C09)');\n";
                s_sql += "insert into " + userid + ".dm_11_dk_1 values('C11','<Điều trị nội trú/Trong đó TE<15 tuổi/Số tử vong/Tổng số>','(C11<=C09 AND C11<=C07)');\n";
                s_sql += "insert into " + userid + ".dm_11_dk_1 values('C12','<Điều trị nội trú/Trong đó TE<15 tuổi/Số tử vong/Nữ>','(C12<=C11)');\n";
                //end Thuy 30.12.2011
                //Thuy 04.01.2012
                s_sql += "alter table " + sSchema + ".d_tienthuoc drop CONSTRAINT pk_d_tienthuoc;\n";
                s_sql += "alter table " + sSchema + ".d_tienthuoc add constraint pk_d_tienthuoc PRIMARY KEY (id,giamua, idkhoa, mabd, mabn, madoituong, makp, maql, ngay, id_ktcao);\n";
                s_sql += "alter table " + userid + ".xuatvien alter column soluutru type character varying(20);\n";
                s_sql += "alter table "+sSchema+".d_thuocbhytll add column lanin numeric(3) default 0;\n";
                //end Thuy 04.01.2012
                //Thuy 18.01.2012
                s_sql += "ALTER TABLE " + userid + ".thuocnghingo_adr ADD COLUMN lydodungthuoc character varying(100);\n";
                s_sql += "ALTER TABLE " + userid + ".phanungthuoc_adr ADD COLUMN xetnghiem character varying(200);\n";
                s_sql += "ALTER TABLE " + userid + ".phanungthuoc_adr ADD COLUMN thoigianxuathienphanung character varying(10);\n";
                s_sql += "CREATE TABLE " + userid + ".thuocsudungdongthoi";
                s_sql += " (";
                s_sql += "     id numeric(22) NOT NULL,";
                s_sql += "     stt numeric(4) NOT NULL,";
                s_sql += "     mabd numeric(7),";
                s_sql += "     ngaybatdau timestamp without time zone,";
                s_sql += "     ngayketthuc timestamp without time zone,";
                s_sql += "     userid numeric(5),";
                s_sql += "     ngayud timestamp without time zone DEFAULT now(),";
                s_sql += "     CONSTRAINT pk_thuocsudungdongthoi PRIMARY KEY (id, stt) USING INDEX TABLESPACE medi_index";
                s_sql += "  )";
                s_sql += " WITH (OIDS=FALSE);\n";
                s_sql += " ALTER TABLE " + userid + ".thuocsudungdongthoi OWNER TO " + owner + ";\n";
                s_sql += "CREATE TABLE " + userid + ".dmmucdo";
                s_sql += " (";
                s_sql += "     id numeric(3) NOT NULL,";
                s_sql += "     ten text,";
                s_sql += "     CONSTRAINT pk_dmmucdo PRIMARY KEY (id) USING INDEX TABLESPACE medi_index";
                s_sql += "  )";
                s_sql += " WITH (OIDS=TRUE);\n";
                s_sql += " ALTER TABLE " + userid + ".dmmucdo OWNER TO medisoft;\n";
                s_sql += "insert into " + userid + ".dmmucdo values(1,'Tử vong');\n";
                s_sql += "insert into " + userid + ".dmmucdo values(2,'Đe dọa tính mạng');\n";
                s_sql += "insert into " + userid + ".dmmucdo values(3,'Nhập viện/Kéo dài thời gian nằm viện');\n";
                s_sql += "insert into " + userid + ".dmmucdo values(4,'Tàn tật vĩnh viễn/nặng nề');\n";
                s_sql += "insert into " + userid + ".dmmucdo values(5,'Dị tật thai nhi');\n";
                s_sql += "insert into " + userid + ".dmmucdo values(6,'Không nghiêm trọng');\n";
                s_sql += "CREATE TABLE " + userid + ".dmketquapu";
                s_sql += " (";
                s_sql += "      id numeric(3) NOT NULL,";
                s_sql += "      ten text,";
                s_sql += "      CONSTRAINT pk_dmketquapu PRIMARY KEY (id) USING INDEX TABLESPACE medi_index";
                s_sql += "  )";
                s_sql += "  WITH (OIDS=TRUE);\n";
                s_sql += "  ALTER TABLE " + userid + ".dmketquapu OWNER TO " + owner + ";\n";
                s_sql += "insert into " + userid + ".dmketquapu values(1,'Tử vong do ADR');\n";
                s_sql += "insert into " + userid + ".dmketquapu values(2,'Tử vong không liên quan đến thuốc');\n";
                s_sql += "insert into " + userid + ".dmketquapu values(3,'Chưa hồi phục');\n";
                s_sql += "insert into " + userid + ".dmketquapu values(4,'Đang hồi phục');\n";
                s_sql += "insert into " + userid + ".dmketquapu values(5,'Hồi phục có di chứng');\n";
                s_sql += "insert into " + userid + ".dmketquapu values(6,'Hồi phục không có di chứng');\n";
                s_sql += "insert into " + userid + ".dmketquapu values(7,'Không rõ');\n";
                s_sql += "ALTER TABLE " + userid + ".phanungthuoc_adr ADD COLUMN mucdopu numeric(3) default 0;\n";
                s_sql += "ALTER TABLE " + userid + ".phanungthuoc_adr ADD COLUMN kqxutripu numeric(3,0);\n";
                s_sql += "ALTER TABLE " + userid + ".thuocnghingo_adr ADD COLUMN caithien numeric(2,0);\n";
                s_sql += "ALTER TABLE " + userid + ".thuocnghingo_adr ADD COLUMN taiphanung numeric(2,0);\n";
                s_sql += "ALTER TABLE " + userid + ".thuocnghingo_adr ADD COLUMN moilan numeric(2,0);\n";
                s_sql += "alter table " + userid + ".xutri_adr alter column thamdinhadr_chuyengia type character varying(50);\n";
                s_sql += "alter table " + userid + ".xutri_adr rename column thamdinhadr_chuyengia to thangthamdinhadr_chuyengia;\n";
                //end 18.01.2012
                s_sql += "create table " + userid + ".d_danglaysolieu(makp numeric(5) not null,phieu numeric(3) not null,ngay timestamp not null,userid numeric(5),computer varchar(50),ngayud timestamp,CONSTRAINT pk_danglaysolieu PRIMARY KEY (makp,phieu,ngay) USING INDEX TABLESPACE medi_index);\n";//gam 07/01/2011
                //gam 01/01/2012
                s_sql += "create table " + userid + ".congthucchenhlech (loai numeric(1) not null,id_loaivp numeric (3),gia_1 varchar(10),gia_2 varchar(10),CONSTRAINT pk_congthucchenhlech PRIMARY KEY (loai,id_loaivp) USING INDEX TABLESPACE medi_index);\n";
                s_sql += "alter table " + sSchema + ".xn_ketqua add ketqua_hople numeric(1) default 0;\n";
                s_sql += "alter table " + sSchema + ".xn_ketqua add userd numeric(7) default 0;\n";
                s_sql += "alter table " + sSchema + ".xn_ketqua add ketqua_ori varchar(50);\n";
                s_sql += "alter table " + userid + ".d_dmnguon add nguon_tt numeric(1) default 0;\n";
                //end gam 01/01/2012
                s_sql += "alter table " + userid + ".d_dmthuoc add hamluong varchar2(20);\n";
                s_sql += "alter table " + userid + ".xuatkhoa add phatqua numeric(1) default 0;\n";
                s_sql += "alter table " + userid + ".xuatvien add phatqua numeric(1) default 0;\n";
                s_sql += "alter table " + userid + ".xuatvien add ngaythoinoi timestamp;\n";
                s_sql += "alter table " + userid + ".btdtt add viettat character varying (2);\n";//Thuy 15.05.2012
                s_sql += "alter table " + userid + ".btdnn_bv add viettat character varying (5);\n ";//Thuy 15.05.2012
                s_sql += "alter table " + userid + ".dmdiadiem add viettat character varying (5);\n ";//Thuy 16.05.2012
                s_sql += "alter table " + userid + ".dmbophan add viettat character varying (5);\n ";//Thuy 16.05.2012
                s_sql += "alter table " + userid + ".dmdienbien add viettat character varying (5);\n ";//Thuy 16.05.2012
                s_sql += "alter table " + userid + ".dmnguyennhan add viettat character varying (6);\n ";//Thuy 16.05.2012
                s_sql += "alter table " + userid + ".btdquan add viettat character varying (7);\n ";//Thuy 16.05.2012
                s_sql += "alter table " + userid + ".dmxutri add viettat character varying (5);\n ";//Thuy 16.05.2012
                s_sql += "alter table " + userid + ".dmnguyennhan alter column ma type numeric(3,0);\n ";//Thuy 24.05.2012
                s_sql += "alter table " + userid + ".dmdienbien alter column ma type numeric(3,0);\n ";//Thuy 24.05.2012
                s_sql += "alter table " + userid + ".dmbophan alter column ma type numeric(3,0);\n ";//Thuy 24.05.2012
                s_sql += "alter table " + userid + ".capmabns alter column computer type numeric(6,0);\n";
                s_sql += "alter table " + sSchema + ".v_vpkhoa add idtheodoigiuong numeric(" + iChieuDaiID.ToString() + ") default 0;\n ";
                s_sql += "alter table " + sSchema + ".d_xuatll add id_kehoachdathang numeric(" + iChieuDaiID.ToString() + ") default 0;\n ";
                foreach (string s_query in s_sql.Trim(';').Split(';'))
                {
                    string s_tmp = s_query.Replace("xxx.", sSchema + ".");
                    s_tmp = s_tmp.Replace("medibv.", userid + ".");
                    execute(s_tmp);
                }
                #endregion
                s_sql = "alter table " + sSchema + ".tainantt alter column diadiem type numeric(3);\n";
                s_sql += "alter table " + sSchema + ".tainantt alter column bophan type numeric(3);\n";
                s_sql += "alter table " + sSchema + ".tainantt alter column nguyennhan type numeric(3);\n";
                s_sql += "alter table " + sSchema + ".tainantt alter column dienbien type numeric(3);\n";
                s_sql += "alter table " + sSchema + ".tainantt alter column xutri type numeric(3);\n";
                s_sql += "alter table " + sSchema + ".d_tienthuoc add column gia_bh numeric(22,4) default 0 not null;\n";
                s_sql += "alter table " + userid + ".dmnguyennhan add tainangt numeric(1); \n";
                s_sql += "alter table " + sSchema + ".d_theodoi add mavach numeric(" + iChieuDaiID.ToString() + ") default 0;\n ";
                s_sql += "update " + userid + ".dmnguyennhan set tainangt=1 where ma=0 and tainangt is null;\n";
                s_sql += "update " + userid + ".dmnguyennhan set tainangt=0 where ma<>0 and tainangt is null;\n";
                s_sql += "create table " + userid + ".datao (ngaygio timestamp, constraint pk_datao primary key (ngaygio) USING INDEX TABLESPACE medi_index)  WITH OIDS;\n";
                s_sql += "alter table " + sSchema + ".sttkham add dakham numeric(5) default 0;\n";
                s_sql += "alter table " + sSchema + ".d_dausinhton alter nhietdo type numeric(7,2);\n";
                s_sql += "alter table " + sSchema + ".d_dausinhton add mabn varchar(10);\n";
                s_sql += "create table " + sSchema + ".bask_rhm(mavaovien numeric(" + iChieuDaiID.ToString() + "), mabn varchar(10), maql numeric(" + iChieuDaiID.ToString() + "), ngay timestamp, makp varchar(" + i_maxlength_makp + "), image bytea, sucnhai text, nhanxet text, khac text, maicd varchar(9), chandoan text, phanloai numeric(2), mabs varchar(4), userid numeric(9, 0), ngayud timestamp DEFAULT now(), CONSTRAINT pk_bask_rhm PRIMARY KEY (mavaovien) USING INDEX TABLESPACE medi_index ) WITH OIDS;ALTER TABLE " + sSchema + ".bask_rhm OWNER TO medisoft;\n";
                s_sql += "create table " + sSchema + ".bask_dalieu(mavaovien numeric(" + iChieuDaiID.ToString() + "), mabn varchar(10), maql numeric(" + iChieuDaiID.ToString() + "), ngay timestamp, makp varchar(" + i_maxlength_makp + "), tongquat text, khac text, maicd varchar(9), chandoan text, phanloai numeric(2),mabs varchar(4), userid numeric(9, 0), ngayud timestamp DEFAULT now(), CONSTRAINT pk_bask_dalieu PRIMARY KEY (mavaovien) USING INDEX TABLESPACE medi_index) WITH OIDS; ALTER TABLE " + sSchema + ".bask_dalieu OWNER TO medisoft;\n";
                s_sql += "create table " + sSchema + ".bask_coxuong (mavaovien numeric(" + iChieuDaiID.ToString() + "),mabn varchar(10), maql numeric(" + iChieuDaiID.ToString() + "), ngay timestamp, makp varchar(" + i_maxlength_makp + "),  tongquat text,  khac text,  maicd varchar(9),  chandoan text, phanloai numeric(2), mabs varchar(4), userid numeric(9, 0),  ngayud timestamp DEFAULT now(), CONSTRAINT pk_bask_coxuong PRIMARY KEY (mavaovien) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + sSchema + ".bask_coxuong OWNER TO medisoft;\n";
                s_sql += "CREATE TABLE " + sSchema + ".bask_tiensu (mavaovien numeric(" + iChieuDaiID.ToString() + "),mabn varchar(10), id numeric(5, 0), ghichu text, CONSTRAINT pk_bask_tiensu PRIMARY KEY (mavaovien,id) USING INDEX TABLESPACE medi_index ) WITHOUT OIDS TABLESPACE medi_index;ALTER TABLE " + sSchema + ".bask_tiensu OWNER TO medisoft;\n";
                s_sql += "alter table " + sSchema + ".bask_chiso add userid numeric(9,0);\n";
                s_sql += "alter table " + sSchema + ".bask_chiso add  mantinh text;\n";
                s_sql += "alter table " + sSchema + ".bask_chiso add  namvien text;\n";
                s_sql += "alter table " + sSchema + ".bask_chiso add  ruou numeric;\n";
                s_sql += "alter table " + sSchema + ".bask_chiso add  thuocla numeric;\n";
                s_sql += "alter table " + sSchema + ".bask_chiso add  diung numeric;\n";
                s_sql += "alter table " + sSchema + ".bask_chiso add  tendiung text;\n";
                s_sql += "alter table " + sSchema + ".bask_chiso add  viemgana numeric;\n";
                s_sql += "alter table " + sSchema + ".bask_chiso add  viemganb numeric;\n";
                s_sql += "alter table " + sSchema + ".bask_chiso add  khac text;\n";
                s_sql += "alter table " + sSchema + ".bask_chiso add  para text;\n";
                s_sql += "alter table " + sSchema + ".bask_chiso add  soi numeric;\n";
                s_sql += "alter table " + sSchema + ".bask_chiso add  viemnao numeric;\n";
                s_sql += "alter table " + sSchema + ".bask_chiso add  lao numeric;\n";
                s_sql += "alter table " + sSchema + ".bask_chiso add  uonvan numeric;\n";
                s_sql += "alter table " + sSchema + ".bask_chiso add  bachhau numeric;\n";
                s_sql += "alter table " + sSchema + ".bask_chiso add  cum numeric;\n";
                s_sql += "alter table " + sSchema + ".bask_chiso add  ngayud timestamp default now();\n";
                s_sql += "alter table " + sSchema + ".bask_mat add mabn varchar(10);\n";
                s_sql += "alter table " + sSchema + ".bask_mat add truoc varchar(254);\n";
                s_sql += "alter table " + sSchema + ".bask_mat add sau varchar(254);\n";
                s_sql += "alter table " + sSchema + ".bask_mat add nhanapp varchar(254);\n";
                s_sql += "alter table " + sSchema + ".bask_mat add nhanapt varchar(254);\n";
                s_sql += "alter table " + sSchema + ".bask_mat add maicd varchar(9);\n";
                s_sql += "alter table " + sSchema + ".bask_mat add chandoan text;\n";
                s_sql += "alter table " + sSchema + ".bask_mat add pic_mt01 bytea;\n";
                s_sql += "alter table " + sSchema + ".bask_mat add pic_mt02 bytea;\n";
                s_sql += "alter table " + sSchema + ".bask_mat add pic_mp01 bytea;\n";
                s_sql += "alter table " + sSchema + ".bask_mat add pic_mp02 bytea;\n";
                s_sql += "alter table " + sSchema + ".bask_mat add phanloai numeric(1);\n";
                s_sql += "alter table " + sSchema + ".bask_sanphu add maicd varchar(9);\n";
                s_sql += "alter table " + sSchema + ".bask_sanphu add chandoan text;\n";
                s_sql += "alter table " + sSchema + ".bask_sanphu add phanloai numeric(1);\n";
                s_sql += "alter table " + sSchema + ".bask_tongket add mabn varchar(10);\n";
                s_sql += "alter table " + sSchema + ".bask_tongket add nhanxet text;\n";
                s_sql += "alter table " + sSchema + ".bask_tongket add denghi text;\n";
                s_sql += "alter table " + sSchema + ".bask_tongket add madenghi numeric;\n";
                s_sql += "alter table " + sSchema + ".bask_tongket add maicd varchar(9);\n";
                s_sql += "alter table " + sSchema + ".bask_tongket add chandoan text;\n";
                s_sql += "alter table " + sSchema + ".bask_tmh add mabn varchar(10);\n";
                s_sql += "alter table " + sSchema + ".bask_tmh add chandoan text;\n";
                s_sql += "alter table " + sSchema + ".bask_tmh add tai text;\n";
                s_sql += "alter table " + sSchema + ".bask_tmh add mui text;\n";
                s_sql += "alter table " + sSchema + ".bask_tmh add hong text;\n";
                s_sql += "alter table " + sSchema + ".bask_tmh add thanhquan text;\n";
                s_sql += "alter table " + sSchema + ".bask_tmh add daumatco text;\n";
                s_sql += "alter table " + sSchema + ".bask_tmh add pic_tmh1 bytea;\n";
                s_sql += "alter table " + sSchema + ".bask_tmh add pic_tmh2 bytea;\n";
                s_sql += "alter table " + sSchema + ".bask_tmh add maicd varchar(9);\n";
                s_sql += "alter table " + sSchema + ".bask_tmh add phanloai numeric(1);\n";
                s_sql += "alter table " + sSchema + ".bask_donvi add stt numeric(6,0);\n";
                s_sql += "alter table " + sSchema + ".bask_donvi add vongbung numeric(7,2);\n";
                s_sql += "alter table " + sSchema + ".bask_donvi add coso numeric(1,0);\n";
                s_sql += "alter table " + sSchema + ".bask_donvi add ngayud timestamp ;\n";
                s_sql += "alter table " + sSchema + ".bask_noikhoa add mabn varchar(10);\n";
                s_sql += "alter table " + sSchema + ".bask_noikhoa add  hohap text;\n";
                s_sql += "alter table " + sSchema + ".bask_noikhoa add  tieuhoa text;\n";
                s_sql += "alter table " + sSchema + ".bask_noikhoa add  than text;\n";
                s_sql += "alter table " + sSchema + ".bask_noikhoa add  noitiet text;\n";
                s_sql += "alter table " + sSchema + ".bask_noikhoa add  chuyenhoa text;\n";
                s_sql += "alter table " + sSchema + ".bask_noikhoa add  chandoan varchar(254);\n";
                s_sql += "alter table " + sSchema + ".bask_noikhoa add  maicd varchar(9);\n";
                s_sql += "alter table " + sSchema + ".bask_noikhoa add  maicdhh varchar(9);\n";
                s_sql += "alter table " + sSchema + ".bask_noikhoa add  maicdth varchar(9);\n";
                s_sql += "alter table " + sSchema + ".bask_noikhoa add  maicdtn varchar(9);\n";
                s_sql += "alter table " + sSchema + ".bask_noikhoa add  maicdtt varchar(9);\n";
                s_sql += "alter table " + sSchema + ".bask_noikhoa add  maicdnt varchar(9);\n";
                s_sql += "alter table " + sSchema + ".bask_noikhoa add  maicdch varchar(9);\n";
                s_sql += "alter table " + sSchema + ".bask_noikhoa add  maicdtamthan varchar(9);\n";
                s_sql += "alter table " + sSchema + ".bask_noikhoa add  phanloai numeric(2);\n";
                s_sql += "alter table " + sSchema + ".bask_ngkhoa add mabn varchar(10);\n";
                s_sql += "alter table " + sSchema + ".bask_ngkhoa add  tongquat text;\n";
                s_sql += "alter table " + sSchema + ".bask_ngkhoa add  chanthuong text;\n";
                s_sql += "alter table " + sSchema + ".bask_ngkhoa add  ubuou text;\n";
                s_sql += "alter table " + sSchema + ".bask_ngkhoa add  maicd varchar(9);\n";
                s_sql += "alter table " + sSchema + ".bask_ngkhoa add  chandoan varchar(254);\n";
                s_sql += "alter table " + sSchema + ".bask_ngkhoa add  maicdub varchar(9);\n";
                s_sql += "alter table " + sSchema + ".bask_ngkhoa add  phanloai numeric(2);\n";
                s_sql += "alter table " + sSchema + ".bask_rhm alter column mabn type varchar(10);\n";
                s_sql += "alter table " + sSchema + ".bask_rhm alter column makp type varchar(3);\n";
                s_sql += "alter table " + sSchema + ".bask_rhm alter column ngay type timestamp;\n";
                s_sql += "alter table " + sSchema + ".bask_tmh alter column makp type varchar(3);\n";
                s_sql += "alter table " + sSchema + ".bask_dalieu alter column mabn type varchar(10);\n";
                s_sql += "alter table " + sSchema + ".bask_dalieu alter column makp type varchar(3);\n";
                s_sql += "alter table " + sSchema + ".bask_dalieu alter column ngay type timestamp;\n";
                s_sql += "alter table " + sSchema + ".bask_coxuong add mabn varchar(10);\n";
                s_sql += "alter table " + sSchema + ".bask_coxuong alter column mabn type varchar(10);\n";
                s_sql += "alter table " + sSchema + ".bask_coxuong alter column makp type varchar(3);\n";
                s_sql += "alter table " + sSchema + ".bask_coxuong alter column ngay type timestamp;\n";
                s_sql += "alter table " + sSchema + ".ct_btdbn add docthan numeric(1);\n";
                s_sql += "alter table " + sSchema + ".ct_btdbn add idmuc numeric;\n";
                s_sql += "alter table " + sSchema + ".v_chidinh add idphongthuchiencls numeric(5) default 0;\n";
                s_sql += "alter table " + sSchema + ".v_chidinh add stt numeric(5) default 0;\n";
                s_sql += "alter table " + sSchema + ".v_chidinh add idloaitg numeric(1) default 0;\n";
                s_sql += "create table " + sSchema + ".stt_phongcls(idphongcls numeric(5), stt numeric(5), ngay timestamp, constraint pk_stt_phongcls (idphongcls, ngay)USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + sSchema + ".stt_phongcls OWNER TO medisoft;\n";
                s_sql += "alter table " + sSchema + ".d_thuocbhytct add paid numeric(1) default 0;\n";
                s_sql += "alter table " + sSchema + ".d_thuocbhytct add idttrv numeric(21) default 0;\n";
                s_sql += "alter table " + sSchema + ".v_vienphict add idphongcls numeric(5) default 0;\n";
                s_sql += "alter table " + sSchema + ".v_vienphict add sttcho numeric(5) default 0;\n";
                s_sql += "alter table " + sSchema + ".v_chidinh add kskdoan numeric(1) default 0;\n";
                s_sql += "alter table " + sSchema + ".d_dausinhton add chieucao numeric(3) default 0;\n";
                s_sql += "alter table " + sSchema + ".d_thuocbhytll add ngaynghi numeric(3) default 0;\n";
                s_sql += "CREATE TABLE " + sSchema + ".xn_maubenhpham_ct(id_xnphieu numeric NOT NULL,id_mauthu numeric DEFAULT -1,id_vatchuamau numeric DEFAULT 0,soluong numeric DEFAULT 0,chatluongmau numeric(1) DEFAULT 0, Ghichu varchar(200) default '',laymaulai numeric(1) DEFAULT 0, userid numeric DEFAULT 0, userD numeric DEFAULT 0, nhanmau numeric(1) default 1, ngaynhan timestamp default now(), ngayud timestamp DEFAULT now(), PRIMARY KEY (id_xnphieu,id_mauthu, id_vatchuamau));\n";
                s_sql += "alter table " + sSchema + ".xn_maubenhpham_ct add nhanmau numeric(1) default 0;\n";
                s_sql += "alter table " + sSchema + ".xn_maubenhpham_ct add ngaynhan timestamp default now();\n";
                s_sql += "alter table " + sSchema + ".xn_phieu add ketqua_hople numeric(1) default 0;\n";
                s_sql += "alter table " + sSchema + ".xn_phieu add ketqua_ori text default '';\n";
                s_sql += "alter table " + sSchema + ".xn_phieu add userd numeric default 0;\n";
                s_sql += "alter table " + sSchema + ".d_xuatsdct add gia_bh numeric default 0;\n";
                s_sql += "alter table " + sSchema + ".d_tienthuoc add gia_bh numeric default 0;\n";
                s_sql += "alter table " + sSchema + ".d_thucxuat add gia_bh numeric default 0;\n";
                //s_sql += "update " + sSchema + ".d_xuatsdct set gia_bh=(select max(gia_bh) as gia_bh from " + userid + ".d_dmbd  where " + sSchema + ".d_xuatsdct.mabd=" + userid + ".d_dmbd.id) where gia_bh=0 and mabd in(select id from " + userid + ".d_dmbd where gia_bh>0);\n ";
                //s_sql += "update " + sSchema + ".d_thucxuat set gia_bh=(select max(gia_bh) as gia_bh from " + userid + ".d_dmbd  where " + sSchema + ".d_thucxuat.mabd=" + userid + ".d_dmbd.id) where gia_bh=0 and mabd in(select id from " + userid + ".d_dmbd where gia_bh>0);\n ";
                //s_sql += "update " + sSchema + ".d_tienthuoc set gia_bh=(select max(gia_bh) as gia_bh from " + userid + ".d_dmbd  where " + sSchema + ".d_tienthuoc.mabd=" + userid + ".d_dmbd.id) where gia_bh=0 and mabd in(select id from " + userid + ".d_dmbd where gia_bh>0);\n ";
                s_sql += "alter table " + sSchema + ".bhytkb add ngaynghi numeric default 0;\n";
                s_sql += "alter table " + sSchema + ".lydokham add id_lydokham text default '+';\n";
                s_sql += "alter table " + sSchema + ".lydokham add id_lydodungtuyen text default '+';\n";
                s_sql += "alter table " + sSchema + ".v_chidinh add idduoc numeric default 0;\n";
                s_sql += "alter table " + sSchema + ".d_xuatsdct add done numeric(1) default 0;\n";
                s_sql += "alter table " + sSchema + ".v_vienphill add thanhtoan numeric(2) default 0 ;\n";
                s_sql += "alter table " + sSchema + ".v_ttrvll add thanhtoan numeric(2) default 0 ;\n";
                s_sql += "alter table " + sSchema + ".v_vienphict add idphongcls numeric(5) default 0;\n ";
                s_sql += "alter table " + sSchema + ".v_vienphict add sttcho numeric(5) default 0;\n ";
                s_sql += "alter table " + sSchema + ".v_ttrvct add idphongcls numeric(5) default 0 ;\n";
                s_sql += "alter table " + sSchema + ".v_ttrvct add sttcho numeric(5) default 0 ;\n";
                s_sql += "alter table " + sSchema + ".v_ttrvct add mien numeric default;\n 0 ";
                s_sql += "alter table " + sSchema + ".v_ttrvct add phuthu numeric(1) default 0;\n ";
                s_sql += "alter table " + sSchema + ".v_chidinh add xn_guidi numeric(1) default 0;\n ";
                s_sql += "alter table " + sSchema + ".d_thuocbhytct add ghichu text;\n ";
                s_sql += "alter table " + sSchema + ".v_ttrvct add ngaygiodangky timestamp ;\n";
                s_sql += "alter table " + sSchema + ".v_ttrvct add idloaitg number(2) default 0 ;\n";
                s_sql += "alter table " + sSchema + ".v_ttrvct add mabs varchar2(4) ;\n";
                s_sql += "alter table " + sSchema + ".v_ttrvll add sokham varchar2(20) ;\n";
                s_sql += "create table " + userid + ".v_capsokham (id numeric, ddmmyy varchar(6), loai varchar(2), chinhanh numeric(2) default 0, ngayud timestamp default now(), stt numeric default 0, constraint pk_v_capsokham primary key(id,ddmmyy, loai, chinhanh)USING INDEX TABLESPACE medi_index) WITH OIDS;\n ";
                s_sql += "alter table " + sSchema + ".bhytkb add idttrv numeric default 0 ;\n";
                s_sql += "alter table " + sSchema + ".xn_ketqua add chaylai numeric default 0 ;\n";
                s_sql += "alter table " + sSchema + ".xn_ketqua add lydochaylai text;\n";
                s_sql += "alter table " + sSchema + ".xn_ketqua add ketquachaylai text;\n";
                s_sql += "alter table " + sSchema + ".xn_ketqua add chuyendi text default lpad('0', 300, '0') ;\n";
                s_sql += "alter table " + sSchema + ".v_chidinh add chenhlech numeric(1) default 0;\n";
                s_sql += "alter table " + sSchema + ".v_chidinh add dachenhlech numeric(1) default 0;\n";
                s_sql += "alter table " + sSchema + ".v_vpkhoa add dachenhlech numeric(1) default 0;\n";
                s_sql += "alter table " + userid + ".dmcomputer alter column id type numeric(6);\n";
                s_sql += "alter table " + sSchema + ".d_xuatll add sophieudutru numeric default 0 ;\n";
                s_sql += "alter table " + sSchema + ".d_xuatsdct add id_ktcao numeric(25) default 0;\n";
                s_sql += "alter table " + sSchema + ".d_xtutrucct add id_ktcao numeric(25) default 0;\n";
                s_sql += "alter table " + sSchema + ".d_thucxuat add id_ktcao numeric(25) default 0;\n";
                s_sql += "alter table " + sSchema + ".d_tienthuoc add id_ktcao numeric(25) default 0;\n";
                s_sql += "alter table " + sSchema + ".v_thvpct add id_ktcao numeric(25) default 0;\n";
                s_sql += "alter table " + sSchema + ".v_thvpct add ktcao numeric(1) default 0;\n";
                s_sql += "alter table " + sSchema + ".v_ttrvct add id_ktcao numeric(25) default 0;\n";
                s_sql += "alter table " + sSchema + ".v_ttrvct add ktcao numeric(1) default 0;\n";
                s_sql += "alter table " + sSchema + ".benhancc add mabsnb character varying;\n";
                s_sql += " alter table " + sSchema + ".d_chuyenct alter column stttchuyen type numeric;\n";
                s_sql += "alter table " + userid + ".d_dmbd alter column manhom type numeric(6);\n";
                s_sql += "alter table " + userid + ".d_dmbd alter column mahang type numeric(7);\n";
                s_sql += "alter table " + userid + ".d_sophieu alter column madoituong type character varying(25);\n";
                s_sql += "insert into "+userid+".loaipttt (ma,ten,l3) values('9','Thủ thuật','x');\n";
                s_sql += "alter table " + userid + ".d_suamadt alter column makp type numeric(5);\n";
                s_sql += "alter table "+userid+".dmphong alter column dichvu type numeric(3,0);\n";
                s_sql += "alter table "+userid+".dmphong alter column dichvu set default 0;\n";
                s_sql += "update " + userid + ".dmphong set dichvu=0 where dichvu is null;\n";
                s_sql += "alter table " + userid + ".ddsosinh add column sochungsinh numeric(22,0) default 0;\n";
                s_sql += "alter table " + userid + ".ddsosinh add column quyensochungsinh text;\n";
                s_sql += "alter table " + userid + ".ddsosinh add column lansinh numeric(2,0) default 0;\n";
                s_sql += "alter table " + userid + ".ddsosinh add column soconsong numeric(2,0) default 0;\n";
                s_sql += "alter table " + userid + ".ddsosinh add column suckhoe text;\n";
                //linh 25/2012 ap dung thong tu lien tich
                s_sql += "CREATE TABLE " + userid + ".V_KHUNGGIA (ID_VP numeric(7,0), NGAY DATE, " +
                    "GIA_TH numeric(10,0) DEFAULT 0, GIA_BH numeric(10,0) DEFAULT 0, GIA_CS numeric(10,0) DEFAULT 0," +
                    "GIA_DV numeric(10,0) DEFAULT 0, GIA_NN numeric(10,0) DEFAULT 0, VATTU_TH numeric(10,0) DEFAULT 0, " +
                    "VATTU_BH numeric(10,0) DEFAULT 0, VATTU_CS numeric(10,0) DEFAULT 0, VATTU_DV numeric(10,0) DEFAULT 0, " +
                    "VATTU_NN numeric(10,0) DEFAULT 0, BHYT numeric(3,0) DEFAULT 0, THUONG numeric(1,0) DEFAULT 0, " +
                    "HIDE numeric(1,0) DEFAULT 0, USERID numeric(7,0), NGAYUD DATE DEFAULT sysdate, COMPUTER VARCHAR2(50)," +
                    "GIA_KSK numeric(10,0) DEFAULT 0, VATTU_KSK numeric(10,0) DEFAULT 0, APGIA numeric(1,0) DEFAULT 0, " +
                    "GIA_VIP numeric(12,2) DEFAULT 0, VATTU_VIP numeric(12,2) DEFAULT 0," +
                    "constraint pk_v_khunggia primary key(id_vp,ngay)," +
                    "constraint fk_v_giavp_v_khunggia foreign key(id_vp) references " + userid + ".v_giavp(id));\n";
                s_sql += "CREATE TABLE " + userid + ".V_GIAVP_DAAPGIA (ID_VP numeric(7,0), NGAY DATE, " +
                    "GIA_TH numeric(10,0) DEFAULT 0, GIA_BH numeric(10,0) DEFAULT 0, GIA_CS numeric(10,0) DEFAULT 0, " +
                    "GIA_DV numeric(10,0) DEFAULT 0, GIA_NN numeric(10,0) DEFAULT 0, VATTU_TH numeric(10,0) DEFAULT 0, " +
                    "VATTU_BH numeric(10,0) DEFAULT 0, VATTU_CS numeric(10,0) DEFAULT 0, VATTU_DV numeric(10,0) DEFAULT 0, " +
                    "VATTU_NN numeric(10,0) DEFAULT 0, BHYT numeric(3,0) DEFAULT 0, THUONG numeric(1,0) DEFAULT 0, " +
                    "HIDE numeric(1,0) DEFAULT 0, USERID numeric(7,0), NGAYUD DATE DEFAULT sysdate, " +
                    "GIA_KSK numeric(10,0) DEFAULT 0, VATTU_KSK numeric(10,0) DEFAULT 0, COMPUTER VARCHAR2(50 )," +
                    "GIA_VIP numeric(12,2) DEFAULT 0, VATTU_VIP numeric(12,2) DEFAULT 0," +
                    "constraint pk_V_GIAVP_DAAPGIA primary key(id_vp,ngay)," +
                    "constraint fk_v_giavp_V_GIAVP_DAAPGIA foreign key(id_vp) references " + userid + ".v_giavp(id));\n";
                s_sql += "alter table " + userid + m_mmyy + ".d_duyet add loaipttt numeric(1) default 0 not null";
                s_sql += "alter table " + userid + m_mmyy + ".d_xuatsdll add loaipttt numeric(1) default 0 not null";//linh 02112012
                s_sql += "alter table " + userid + m_mmyy + ".v_chidinh_huy add cosoden  numeric(2) default 0;\n";
                s_sql += "alter table " + userid + m_mmyy + ".v_tamung add idtonghop numeric(" + iChieuDaiID + ") default 0;\n";
                s_sql += "alter table " + userid + ".eve_upd_del alter computerid type numeric(7);\n";
                s_sql += "alter table " + userid + ".eve_tables alter computerid type numeric(7);\n";
                s_sql += "alter table " + userid + ".eve_upd_del alter computerid set default 0;\n";
                s_sql += "alter table " + userid + ".eve_tables alter computerid set default 0;\n";
                s_sql += "alter table " + userid + m_mmyy + ".lienhe add nvienbv numeric(1) default 0;\n";
                s_sql += "alter table " + userid + ".dausinhton add cannang numeric(7,2) default 0;\n";
                s_sql += "alter table " + userid + m_mmyy + ".benhanpk alter column mangtr type numeric(22,0);\n";
                s_sql += " alter table " + userid + m_mmyy + ".d_nhapct add column tieuchuanchatluong character varying(25);\n";
                s_sql += " alter table " + userid + m_mmyy + ".d_nhapct add column hansudung character varying(20);\n";//Thuy 19.01.2013
                s_sql += " alter table " + userid + m_mmyy + ".d_nhapct add column muathau numeric(1) default 0 not null;\n";//Thuy 04.03.2013 Quản lí thuốc mua trúng thầu hay ko
                s_sql += " update " + userid + ".d_dmbd set vat=0 where vat is null;\n";
                s_sql += " alter table " + userid + ".dmtyleban add column nhomkho numeric(2) default 1;\n";
                s_sql += " ALTER TABLE " + userid + ".dmtyleban DROP CONSTRAINT pk_dmtyleban;\n";
                s_sql += " ALTER TABLE " + userid + ".dmtyleban ADD CONSTRAINT pk_dmtyleban PRIMARY KEY (tu,den,nhomkho);\n";
                s_sql += " alter table " + userid + m_mmyy + ".d_nhapct add column haohut numeric(5,2) default 0;\n";//Thuy 19.01.2013
                s_sql += " alter table " + userid + m_mmyy + ".d_nhapct add column giahaohut numeric(24,10) default 0;\n";//Thuy 19.01.2013
                s_sql += " alter table " + userid + ".d_dmkho add column haohut numeric(1,0) default 0;\n";//Thuy 19.01.2013 
                s_sql += " alter table " + userid + m_mmyy + ".tiepdon add column doituonguutien numeric(1,0) default 0;\n";
                s_sql += " alter table " + userid + m_mmyy + ".dausinhton add column nhiptho numeric(5,0) default 0;\n";
                s_sql += " alter table " + userid + ".khdm_01 add c17 numeric(7) default 0;\n";
                s_sql += " alter table " + userid + ".khdm_01 add c18 numeric(7) default 0;\n";
                s_sql += " alter table " + userid + ".khbieu_01 add c17 numeric(7) default 0;\n";
                s_sql += " alter table " + userid + ".khbieu_01 add c18 numeric(7) default 0;\n";
                s_sql += " alter table " + userid + ".khdm_09 add ghichu varchar(128);\n";
                s_sql += " alter table " + userid + ".khbieu_09 add ghichu varchar(128);\n";

                //Lào Cai data cũ quá lỗi ko set default 0
                s_sql += "alter table " + userid + ".v_giavp alter column hoichan type numeric(1,0);";//Thuy 19.01.2013 
                s_sql += "update " + userid + ".v_giavp set hoichan=0 where hoichan is null;";
                s_sql += "alter table " + userid + ".v_giavp alter column xamlan type numeric(1,0);";//Thuy 19.01.2013 
                s_sql += "update " + userid + ".v_giavp set xamlan=0 where xamlan is null;";
                s_sql += "alter table " + userid + ".v_giavp alter column coso type numeric(3,0);";//Thuy 19.01.2013 
                s_sql += "update " + userid + ".v_giavp set coso=0 where coso is null;";
                s_sql += "alter table " + userid + ".v_giavp alter column tutuoi type numeric(3,0);";//Thuy 19.01.2013
                s_sql += "update " + userid + ".v_giavp set tutuoi=0 where tutuoi is null;";
                s_sql += "alter table " + userid + ".v_giavp alter column dentuoi type numeric(3,0);";//Thuy 19.01.2013 
                s_sql += "update " + userid + ".v_giavp set dentuoi=0 where dentuoi is null;";
                s_sql += "alter table " + userid + ".v_giavp alter column giaycamdoan type numeric(3,0);";//Thuy 19.01.2013 
                s_sql += "update " + userid + ".v_giavp set giaycamdoan=0 where giaycamdoan is null;";
                s_sql += "alter table " + userid + ".v_giavp alter column giaycamdoan type numeric(3,0);";//Thuy 19.01.2013 
                s_sql += "update " + userid + ".v_giavp set giaycamdoan=0 where giaycamdoan is null;";
                s_sql += "alter table " + userid + ".v_giavp alter column ctscannercq type numeric(3,0);";//Thuy 19.01.2013 
                s_sql += "alter table " + userid + ".ddsosinh add column socon numeric(2,0) default 0;";//Thuy 14.03.2013
                //cao Vu 18.03.2013
                s_sql += "alter table " + userid + ".dmvungsale add doituong numeric(2) default 0;";
                s_sql += "insert into " + userid + ".dmchucdanh(id,ten) values(0,'KXD');";
                s_sql += "alter table " + userid + ".dmbschidinh drop column idvung;";
                s_sql += "alter table " + userid + ".dmbs add id_vung numeric(3) default 0;";
                s_sql += "alter table " + userid + ".dmbs add ngaysinh varchar(10);";
                s_sql += "alter table " + userid + ".dmbschidinh add ngaysinh varchar(10);";
                s_sql += "alter table " + userid + ".dmbschidinh add diachi varchar(254);";
                s_sql += "alter table " + userid + ".dmbschidinh add dienthoainha varchar(254);";
                s_sql += "alter table " + userid + ".dmbschidinh add dtdd varchar(254);";
                s_sql += "alter table " + userid + ".dmbschidinh add email varchar(254);";
                s_sql += "alter table " + userid + ".dmbschidinh rename column benhvien to noilamviec;";//end VU 18.03.2013


                s_sql += "update " + userid + ".v_giavp set ctscannercq=0 where ctscannercq is null;";
                s_sql += " CREATE TABLE " + userid + ".dmloaict";
                s_sql += "(";
                s_sql += "id numeric(3) NOT NULL,";
                s_sql += "stt numeric(3),";
                s_sql += "ten text,";
                s_sql += "userid numeric(5),";
                s_sql += "ngayud timestamp without time zone DEFAULT now(),";
                s_sql += "chuyendi text DEFAULT '000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'::text,";
                s_sql += "CONSTRAINT pk_dmloaict PRIMARY KEY (id)";
                s_sql += ")";
                s_sql += "WITH (OIDS=TRUE);";
                s_sql += "ALTER TABLE " + userid + ".dmloaict OWNER TO medisoft;\n";

                s_sql += "CREATE TABLE " + userid + ".hachungtu";
                s_sql +="(";
                s_sql +="mabn character varying(10) NOT NULL,";
                s_sql +="mavaovien numeric(21) NOT NULL,";
                s_sql +="id_loaict numeric(3) NOT NULL,";
                s_sql +="duongdan text,";
                s_sql +="userid numeric(7),";
                s_sql +="ngayud timestamp without time zone DEFAULT now(),";
                s_sql +="chuyendi text DEFAULT '000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'::text,";
                s_sql +="CONSTRAINT pk_hachungtu PRIMARY KEY (mabn, mavaovien, id_loaict),";
                s_sql +="CONSTRAINT fk_hachungtu_dmloaict FOREIGN KEY (id_loaict) ";
                s_sql += "REFERENCES " + userid + ".dmloaict (id) MATCH SIMPLE ";
                s_sql +="ON UPDATE NO ACTION ON DELETE NO ACTION ";
                s_sql +=")";
                s_sql +="WITH (OIDS=TRUE);";
                s_sql += "ALTER TABLE " + userid + ".hachungtu OWNER TO medisoft;\n";
                s_sql += "ALTER TABLE " + userid + ".pttt_bs_duyetmo alter column id type numeric(25);\n";
                s_sql += "ALTER TABLE xxx.pttt_duyetmo alter column id type numeric(25);\n";
                s_sql += "ALTER TABLE xxx.d_xuatsdll alter column lydo type numeric(7);\n";
                s_sql += "ALTER TABLE " + userid + ".d_dmkho add hide numeric(1) default 0;\n";

                s_sql += "ALTER TABLE xxx.hen add maql_moi numeric default 0;\n";
                s_sql += "ALTER TABLE " + userid + ".hen add maql_moi numeric default 0;\n";
                s_sql += "insert into " + userid + ".d_dmnx(id) values(0);\n";
                s_sql += "alter table " + userid + ".d_dutrukho add column sophieu numeric default 0;\n";
                s_sql += "alter table " + userid + ".d_dutrukho add column diengiai varchar2(255);\n";
                s_sql += "alter table " + userid + ".d_dutrukho add column loaiphieu numeric(1,0) default 0;\n";
                s_sql += "alter table " + userid + ".d_dutrukho add column idnhacc numeric(7,0) default 0;\n";
                s_sql += "alter table " + userid + ".d_dutrukho add column tungay timestamp without time zone DEFAULT now();\n";
                s_sql += "alter table " + userid + ".d_dutrukho add column denngay timestamp without time zone DEFAULT now();\n";
                s_sql += "alter table " + userid + ".d_theodonct add column madoituong numeric(2,0) default 0;\n";
                s_sql += " alter table " + userid + m_mmyy + ".d_nhapct add column sodangky character varying (20);\n";
                s_sql += " alter table " + userid + m_mmyy + ".d_theodoi add column sodangky character varying (20);\n";
                s_sql += " alter table xxx.d_tonkhoth add stt serial ;";
                s_sql += " alter table xxx.d_tutructh add stt serial ;";

                foreach (string s_query in s_sql.Trim(';').Split(';'))
                {
                    string s_tmp = s_query.Replace("xxx.", sSchema + ".");
                    s_tmp = s_tmp.Replace("medibv.", userid + ".");
                    execute(s_tmp, false);
                }
                //end linh
                tao_function(m_mmyy);
                sql_taocdha(sSchema);
                f_Modify_maxlenghtKyTu(m_mmyy);
            }
        }
        public void sql_taocdha(string schema)
        {
            sql = " CREATE TABLE " + schema + ".cdha_bnll(id numeric("+iChieuDaiID+") NOT NULL DEFAULT 0, id_loai varchar(2), mabn varchar(8), maql numeric("+iChieuDaiID+") NOT NULL DEFAULT 0,  makp varchar(2),  ngay timestamp,  gio varchar(5),  maicd varchar(9),chandoan text,bsdt varchar(4),ktv varchar(4),loaibn numeric(2) DEFAULT 0,ngoaigio numeric(1) DEFAULT 0,madoituong numeric(1) DEFAULT 0,mabhyt varchar("+iChieuDaiID+"),userid numeric(7),ngayud timestamp DEFAULT now(),paid numeric(1) DEFAULT 0,ghichu text, ketluan text,tinhtrang numeric(1), bsdoc varchar(4), may numeric(2) default 0,bschidinh text,tcls text,lanin numeric(2) default 0,done numeric(1) default 0,useriddo numeric(5) default 0, CONSTRAINT PK_CDHA_BNLL PRIMARY KEY(id) USING INDEX TABLESPACE medi_index )WITH OIDS;ALTER TABLE " + schema + ".cdha_bnll OWNER TO " + owner + ";\n";
            sql += " CREATE TABLE " + schema + ".cdha_bnct(id numeric("+iChieuDaiID+") NOT NULL DEFAULT 0, makt varchar(7) NOT NULL, solan numeric(2) DEFAULT 1, ketluan text, mota text, denghi text, CONSTRAINT pk_cdha_bnct PRIMARY KEY (id, makt) USING INDEX TABLESPACE medi_index)WITH OIDS;ALTER TABLE " + schema + ".cdha_bnct OWNER TO " + owner + ";\n";
            sql += " CREATE TABLE " + schema + ".cdha_ctphimxq(id numeric("+iChieuDaiID+") NOT NULL DEFAULT 0, makt varchar(7) NOT NULL, loai numeric(2) NOT NULL DEFAULT 0,  idtp varchar(6) NOT NULL,  soluong numeric(10,2),  stt numeric(2) DEFAULT 1,  hu numeric(1) DEFAULT 0,  CONSTRAINT pk_cdha_ctphimxq PRIMARY KEY (id, makt, loai, idtp,stt) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdha_ctphimxq OWNER TO " + owner + ";\n";
            sql += " CREATE TABLE " + schema + ".cdha_ctxq(id numeric("+iChieuDaiID+") NOT NULL DEFAULT 0, makt varchar(7) NOT NULL, id_p varchar(3),  sl_p numeric(2) DEFAULT 0,  id_t varchar(3),  sl_t numeric(2),  CONSTRAINT pk_cdha_ctxq PRIMARY KEY (id, makt) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdha_ctxq OWNER TO " + owner + ";\n";
            sql += " CREATE TABLE " + schema + ".cdha_data_2d(id numeric("+iChieuDaiID+") NOT NULL DEFAULT 0, makt varchar(7) NOT NULL, ao text, la text,  avd text,  ivsd text,  ivss text,  lvdd text,  lvds text,  lvpwd text,  lvpws text,  ef text,  fs text,  vlt text,  vln text,  mnt text,  vdk text,ann_2l text,ann_3l text,cd2l text,ann_dmp text,than_dmp text,phai_dmp text,trai_dmp text,thatphai text,vmean_2l text,pgmean_2l text, rldongvung text,  CONSTRAINT pk_cdha_data_2d PRIMARY KEY (id, makt) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdha_data_2d OWNER TO " + owner + ";\n";
            sql += " CREATE TABLE " + schema + ".cdha_data_2d_md(id numeric("+iChieuDaiID+") NOT NULL DEFAULT 0,  makt varchar(7) NOT NULL,  thatphai text,  vlt text,  dklv text,  thanhsaulv text,  ef text,  sv text,  dkovao text,  vao text,  v2lef text,  vv text,  cdltv2l text,  ttt text,  cdmc text,  dmp text,  nhitrai text,  vdmp text,  vln text,  ytk text,  ivsd text,  lvdd text,  pwd text,  avo text,  de text,  quai text,  phai text,  ivss text,  lvds text,  tylecohoi text,  co text,  la text,  kieumo text,  eivs text,  nepvan text,  tinhmachphoi text,  xuong text,  trai text,  nhiphai text,  vachlienthat text,  mangngoaitim text,  pws text,  CONSTRAINT pk_cdha_data_2d_md PRIMARY KEY (id, makt) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdha_data_2d_md OWNER TO " + owner + ";\n";
            sql += " CREATE TABLE " + schema + ".cdha_data_doppler(id numeric("+iChieuDaiID+") NOT NULL DEFAULT 0,  makt varchar(7) NOT NULL,  ea_ea text,  ea_vte text,  ea_vta text,  ea_epg text,  ea_apg text,  ea_hovan text,  ea_vmax text,  ea_hepvan text,  ea_mva text,  dmc_vmax text,  dmc_vmin text,  dmc_pgmax text,  dmc_pgmin text,  dmc_hv text,  dmc_dk text,  dmc_hepvan text,  dmc_dldh text,  dq_ho text,  dq_vmax text,  dq_pgmax text,  dq_pap text,  dmp_vmax text,  dmp_vmin text,  dmp_pgmax text,  dmp_pgmin text,  dmp_hepvan text,  dmp_papm text,  dmp_papd text,  denghi text,  ketluan text,  batthuong_vlt text,  batthuong_vln text,vandekhac text ,vmean_2l text,pgmean_2l text, CONSTRAINT pk_cdha_data_doppler PRIMARY KEY (id, makt) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdha_data_doppler OWNER TO " + owner + ";\n";
            sql += " CREATE TABLE " + schema + ".cdha_data_doppler_md(id numeric("+iChieuDaiID+") NOT NULL DEFAULT 0,  makt varchar(7) NOT NULL,  ea text,  vttd text,  vttdtb1 text,  dcatd text,  dcatdtb1 text,  dongpn1 text,  mdlandongpn1 text,  hv2lmucdo text,  mucdothoigian text,  hv2lvmax text,  maxgp text,  hepv2l text,  pht text,  dientichovan1 text,  vttdvmax2 text,  vttdvmaxtb2 text,  dcatd2 text,  dcatdtb2 text,  hepvandmc text,  dientichovan2 text,  hovandmc text,  phd text,  ddf text,  dkdongpn2 text,  donglanpn2 text,  hovan3la text,  hovan3lamucdo text,  homax text,  apluctamthupap text,  chenhaptd3 text,  captdtrungbinh3 text,  toithieu3 text,  vttdvmax4 text,  chenhaptd4 text,  captdtrungbinh4 text,  toithieu4 text,  papmean text,  apluctt text,  cpqs text,  vachlienthat5 text,  vachliennhi6 text,  khac6 text,  denghi text,  ketluan text,  CONSTRAINT pk_cdha_data_doppler_md PRIMARY KEY (id, makt) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdha_data_doppler_md OWNER TO " + owner + ";\n";
            sql += " CREATE TABLE " + schema + ".cdha_data_machmau(id numeric("+iChieuDaiID+") NOT NULL,  makt varchar(7) NOT NULL,  vt text,  dm1 text,  dm2 text,  dm3 text,  dm4 text,  dm5 text,  dm6 text,  dm_dong varchar(20),  dm_pho varchar(20),  dm_vmax varchar(20),  dm_ghichu text,  tm1 text,  tm2 text,  tm3 text,  tm4 text,  tm5 text,  tm6 text,  tm_dong varchar(20),  tm_pho varchar(20),  tm_vmax varchar(20),  tm_ghichu text,  mmcq text,  vdk text,  kl text,  dn text,  CONSTRAINT pk_cdha_data_machmau PRIMARY KEY (id, makt) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdha_data_machmau OWNER TO " + owner + ";\n";
            sql += " CREATE TABLE " + schema + ".cdha_data_noisoimuixoang(id numeric("+iChieuDaiID+") default 0,makt text,tiendinhmui_P text,tiendinhmui_T text,kheduoi_P text,kheduoi_T text,khegiua_P text,khegiua_T text,khetren_P text,khetren_T text,mommoc_P text,mommoc_T text,bongsang_P text,bongsang_T text,o_xoangham_P text,o_xoangham_T text,o_xoangsang_P text,o_xoangsang_T text,o_xoangtran_P text,o_xoangtran_T text,o_xoangbuom_P text,o_xoangbuom_T text,vachngan_P text,vachngan_T text,cuonduoi_P text,cuonduoi_T text,cuongiua_P text,cuongiua_T text,cuontren_P text,cuontren_T text,vomhong_P text,vomhong_T text,vomnhi_P text,vomnhi_T text,khac_P text,khac_T text,ketluan text,denghi text, constraint pk_sa_data_noisoimuixoang primary key(id,makt) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdha_data_noisoimuixoang OWNER TO " + owner + ";\n";
            sql += " CREATE TABLE " + schema + ".cdha_data_noisoitai(id numeric("+iChieuDaiID+") NOT NULL DEFAULT 0,  makt text NOT NULL,  ongtai_p text,  ongtai_t text,  mangnhi_p text,  mangnhi_t text,  canbua_p text,  canbua_t text,  homnhi_p text,  homnhi_t text,  khac_p text,  khac_t text,  ketluan text,  denghi text,  CONSTRAINT pk_sa_data_noisoitai PRIMARY KEY (id, makt)USING INDEX TABLESPACE medi_index ) WITH OIDS;ALTER TABLE " + schema + ".cdha_data_noisoitai OWNER TO " + owner + ";\n";
            sql += " CREATE TABLE " + schema + ".cdha_data_noisoithanhquan(id numeric("+iChieuDaiID+") default 0,makt text,hahong_P text,hahong_T text,dayluoi_P text,dayluoi_T text,thanhthiet_P text,thanhthiet_T text,neppheuthanhthiet_P text,neppheuthanhthiet_T text,sunpheu_P text,sunpheu_T text,thuongthanhmon_P text,thuongthanhmon_T text,thanhnhat_P text,thanhnhat_T text,daythanh_P text,daythanh_T text,hathanhmon_P text,hathanhmon_T text,xoangle_P text,xoangle_T text,khac_P text,khac_T text,ketluan text,denghi text, constraint pk_sa_data_noisoithanhquan primary key(id,makt) USING INDEX TABLESPACE medi_index )WITH OIDS;ALTER TABLE " + schema + ".cdha_data_noisoithanhquan OWNER TO " + owner + ";\n";
            sql += " CREATE TABLE " + schema + ".cdha_data_nsdaday(id numeric("+iChieuDaiID+") NOT NULL,  makt varchar(50) NOT NULL,  tq text,  dzccr text,  tv text,  pv text,  thanvi text,  bcl text,  bcn text,  vg text,  hv text,  mv text,  tt text,  mdd2tt text,  st text,  clotest text,  kl text,  dn text,tienmonvi text,  CONSTRAINT pk_cdha_data_nsdaday PRIMARY KEY (id, makt) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdha_data_nsdaday OWNER TO " + owner + ";\n";
            sql += " CREATE TABLE " + schema + ".cdha_data_nsdaitrang(id numeric("+iChieuDaiID+") NOT NULL,  makt varchar(7) NOT NULL,  bnn text,  mst text,  dtp text,  dtgg text,  dtn text,  dtgl text,  dtt text,  dtsm text,  tt text,  hm text,  kl text,  dn text,  CONSTRAINT pk_cdha_data_nsdaitrang PRIMARY KEY (id, makt) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdha_data_nsdaitrang OWNER TO " + owner + ";\n";
            sql += " CREATE TABLE " + schema + ".cdha_data_phanmem(id numeric("+iChieuDaiID+") NOT NULL,  makt varchar(7) NOT NULL,  vt text,  tt varchar(10),  kt varchar(10),  ct text,  bo text,  mmcq text,  hach text,  ttk text,  bung text,  tm text,  kl text,  dn text,  CONSTRAINT pk_cdha_data_phanmem PRIMARY KEY (id, makt) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdha_data_phanmem OWNER TO " + owner + ";\n";
            sql += " CREATE TABLE " + schema + ".cdha_data_phukhoa(id numeric NOT NULL DEFAULT 0,  makt text NOT NULL,  tuthe text,  dap text,  noimac text,  cotucung text,  longtucung text,  tonthuong text,  vitri text,  cautruc text,  kichthuoc text,  btt text,  btp text,  tvt text,  tvp text,  tuicung text,  vdk text,  kl text,  dn text,  CONSTRAINT pk_cdha_data_phukhoa PRIMARY KEY (id, makt) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdha_data_phukhoa OWNER TO " + owner + ";\n";
            sql += " CREATE TABLE " + schema + ".cdha_data_san(id numeric("+iChieuDaiID+") NOT NULL,  makt varchar(7) NOT NULL,  soluong text,  timthai text,  cudong text,  ngoi text,  gioitinh text,  vitri text,  nhom text,  dotruongthanh text,  nuocoi text,  bpd varchar(50),  fml varchar(50),  aptd varchar(50),  ttd varchar(50),  trongluong text,  ngaysinh text,  v_r text,  ri_r text,  v_t text,  ri_t text,  v_p text,  ri_p text,  v_n text,  ri_n text,  dtbt text,  vdk text,  kl text,  dn text,  gs text,  crl text,  tuoithai text,  bohopso text,  cautrucduonggiua text,  hinhanhnao text,  kichthuochosau text,  cautructim text,  cotsong text,  hinhanhdaday text,  bangquang text,  dayron text,  ac varchar(50),thaituongduong text,ngaykinhcc timestamp,tuan text,ngay text, ngaydks timestamp, tucung text,amvangthai text,tuinoanhoan text,buongtrung text,cungdo text,thoigian numeric(2) DEFAULT 0,  CONSTRAINT pk_cdha_data_san PRIMARY KEY (id, makt)) WITH OIDS;ALTER TABLE " + schema + ".cdha_data_san OWNER TO " + owner + ";\n";
            sql += " CREATE TABLE " + schema + ".cdha_data_san_chitiet(id numeric NOT NULL DEFAULT 0,  makt varchar(50) NOT NULL,  tuoithai text,  tuithai text,  botuithai text,  phoithai text,  tuthe text,  dap text,  phanphu text,  noimac text,  ctctc text,  tuicung text,  thoigian numeric DEFAULT 0,  CONSTRAINT pk_cdha_data_sans PRIMARY KEY (id, makt) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdha_data_san_chitiet OWNER TO " + owner + ";\n";
            sql += " CREATE TABLE " + schema + ".cdha_data_tongquat(id numeric("+iChieuDaiID+") NOT NULL DEFAULT 0,  makt varchar(7) NOT NULL,  gan text,  mat text,  tuylach text,  haithan text,  bangquang text,  tlt text,  dmcbung text,  dichobung text,  duongtieuhoa text,  tuthe text,  dap text,  noimac text,  cotucung text,  longtucung text,  tuicung text,  phanphu text,  vdk text,  kl text,  dn text,  thanphai text,lach text,  duongmat text,ongmat text,tinhmach text,buongtrung text,  CONSTRAINT pk_cdha_data_tonguat PRIMARY KEY (id, makt) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdha_data_tongquat OWNER TO " + owner + ";\n";
            sql += " CREATE TABLE " + schema + ".cdha_data_tuyengiap(id numeric("+iChieuDaiID+") NOT NULL,  makt varchar(7) NOT NULL,  tp1 varchar(10),  tp2 varchar(10),  tp3 varchar(10),  v_tp varchar(10),  tt1 varchar(10),  tt2 varchar(10),  tt3 varchar(10),  v_tt varchar(10),  ha text,  tt text,  vt text,  ct text,  kt text,  tt_trai varchar(10),  vt_trai text,  ct_trai text,  kt_trai text,  hc text,  ctk text,  kl text,  dn text,  cautruc text,  lantoa text,  khutru text,  bo text,  didong text,  CONSTRAINT pk_cdha_data_tuyengiap PRIMARY KEY (id, makt) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdha_data_tuyengiap OWNER TO " + owner + ";\n";
            sql += " CREATE TABLE " + schema + ".cdha_data_tuyenvu(id numeric("+iChieuDaiID+") NOT NULL,  makt varchar(7) NOT NULL,  mtv text,mtvphai text,  tt_vt varchar(10),  vt_vt varchar(100),  ct_vt text,  kt_vt varchar(100),  tt_vp varchar(10),  vt_vp varchar(100),  ct_vp text,  kt_vp varchar(100),  hn text,  vdk text,  kl text,  dn text,  CONSTRAINT pk_cdha_data_tuyenvu PRIMARY KEY (id, makt) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdha_data_tuyenvu OWNER TO " + owner + ";\n";
            sql += " CREATE TABLE " + schema + ".cdha_data_vu(id numeric NOT NULL DEFAULT 0,  makt text NOT NULL,  f1 text,  f2 text,  f3 text,  f4 text,  f5 text,  f6 text,  f7 text,  f8 text,  f9 text,  f10 text,  f11 text,  f12 text,  f13 text,  f14 text,  f15 text,  f16 text,  f17 text,  CONSTRAINT pk_cdha_data_vu PRIMARY KEY (id, makt) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdha_data_vu OWNER TO " + owner + ";\n";
            sql += " CREATE TABLE " + schema + ".cdha_image(id_hinh numeric("+iChieuDaiID+") NOT NULL,  id numeric("+iChieuDaiID+") NOT NULL,  makt varchar(7) NOT NULL,  image bytea,chon number default 1,  CONSTRAINT pk_cdha_image PRIMARY KEY (id_hinh,id,makt) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdha_image OWNER TO " + owner + ";\n";
            sql += " CREATE TABLE " + schema + ".cdha_kqvp(id numeric("+iChieuDaiID+") NOT NULL DEFAULT 0,  id_loaicdha varchar(2),  mavp numeric(12) NOT NULL DEFAULT 0,  mabn varchar(8),  code_ligne numeric("+iChieuDaiID+") DEFAULT 0,  idchidinh numeric("+iChieuDaiID+") DEFAULT 0,  gia numeric(10) DEFAULT 0,  makp varchar(2),  madoituong numeric(2) DEFAULT 0,  ngay timestamp,  diengiai text,  CONSTRAINT pk_cdha_kqvp PRIMARY KEY (id, mavp) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + schema + ".cdha_kqvp OWNER TO " + owner + ";\n";
            sql += " create table " + schema + ".cdha_data_2d_doppler(id numeric("+iChieuDaiID+") NOT NULL DEFAULT 0,makt varchar(7) NOT NULL,nhitrai varchar(50),dongmachchu varchar(50),thattrai_dd varchar(50),thattrai_ds varchar(50),thattrai_vd varchar(50),thattrai_vs varchar(50),thattrai_d varchar(50),thattrai_ef varchar(50),dkthatphai varchar(50),beday_vlt_tamtruong varchar(50),beday_vlt_tamthu varchar(50),beday_tstt_tamtruong varchar(50),beday_tstt_tamthu varchar(50),didong_vlt varchar(50),didong_tstt varchar(50),v2l_dangdidong text,v2l_doctamtruong varchar(50),v2l_biendomo text,v2l_khoangcachhaibovan varchar(50),v2l_tinhtrangdaychang text,v2l_mepvan text,v2l_e varchar(50),v2l_huyetkhoinhitrai text,v2l_ea text,v2l_gradent text,v2l_trungbinh varchar(50),v2l_hovan text,v2l_dientich varchar(50),v2l_pht varchar(50),dmc_tinhtrangvan text,dmc_dangdidong text,dmc_biendomo varchar(50),dmc_gradent text,dmc_trungbinh varchar(50),dmc_hovan text,dmc_dientich varchar(50),dmc_pht varchar(50),dmp_tinhtrangvan text,dmp_duongkinh varchar(50),dmp_apluc text,dmp_tamthu varchar(50),dmp_gradent text,dmp_trungbinh_tamthu varchar(50),dmp_hovan text,dmp_cuoitamtruong varchar(50),dmp_trungbinh varchar(50),v3l_tinhtrangvan text,v3l_hovan text,v3l_gradent text,mangngoaitim text,tansotim text,hohl_td varchar(50),hohl_bb varchar(50),dkdhocdrtt varchar(50),ketluan text,denghi text,CONSTRAINT pk_cdha_data_2d_doppler PRIMARY KEY (id, makt)) WITH OIDS;ALTER TABLE " + schema + ".cdha_data_2d_doppler OWNER TO " + owner + ";\n";
            sql += " CREATE TABLE " + schema + ".cdha_benh(id numeric("+iChieuDaiID+") NOT NULL DEFAULT 0,makt varchar(7) NOT NULL,id_coquan numeric(7) DEFAULT 0,idmau numeric(5) DEFAULT 0, ketqua text, CONSTRAINT pk_cdha_benh PRIMARY KEY (id, makt,id_coquan)) WITH OIDS;ALTER TABLE " + schema + ".cdha_benh OWNER TO " + owner + ";\n";
            execute_data(sql);

        }
        public void f_Modify_maxlenghtKyTu(string s_mmyy)
        {
            execute_data(" ALTER TABLE " + user + s_mmyy + ".cdha_bnll alter column id type  numeric("+iChieuDaiID+") ");
            execute_data(" ALTER TABLE " + user + s_mmyy + ".cdha_bnct alter column id type  numeric("+iChieuDaiID+") ");
            execute_data(" ALTER TABLE " + user + s_mmyy + ".cdha_ctxq alter column id type  numeric("+iChieuDaiID+") ");
            execute_data(" ALTER TABLE " + user + s_mmyy + ".cdha_data_2d alter column id type  numeric("+iChieuDaiID+") ");
            execute_data(" ALTER TABLE " + user + s_mmyy + ".cdha_data_2d_md alter column id type  numeric("+iChieuDaiID+") ");
            execute_data(" ALTER TABLE " + user + s_mmyy + ".cdha_data_doppler alter column id type  numeric("+iChieuDaiID+") ");
            execute_data(" ALTER TABLE " + user + s_mmyy + ".cdha_data_doppler_md alter column id type  numeric("+iChieuDaiID+") ");
            execute_data(" ALTER TABLE " + user + s_mmyy + ".cdha_data_machmau alter column id type  numeric("+iChieuDaiID+") ");
            execute_data(" ALTER TABLE " + user + s_mmyy + ".cdha_data_nsdaday alter column id type  numeric("+iChieuDaiID+") ");
            execute_data(" ALTER TABLE " + user + s_mmyy + ".cdha_data_nsdaitrang alter column id type  numeric("+iChieuDaiID+") ");
            execute_data(" ALTER TABLE " + user + s_mmyy + ".cdha_data_phanmem alter column id type  numeric("+iChieuDaiID+") ");
            execute_data(" ALTER TABLE " + user + s_mmyy + ".cdha_data_phukhoa alter column id type  numeric("+iChieuDaiID+") ");
            execute_data(" ALTER TABLE " + user + s_mmyy + ".cdha_data_san alter column id type  numeric("+iChieuDaiID+") ");
            execute_data(" ALTER TABLE " + user + s_mmyy + ".cdha_data_san_chitiet alter column id type  numeric("+iChieuDaiID+") ");
            execute_data(" ALTER TABLE " + user + s_mmyy + ".cdha_data_tongquat alter column id type  numeric("+iChieuDaiID+") ");
            execute_data(" ALTER TABLE " + user + s_mmyy + ".cdha_data_tuyengiap alter column id type  numeric("+iChieuDaiID+") ");
            execute_data(" ALTER TABLE " + user + s_mmyy + ".cdha_data_tuyenvu alter column id type  numeric("+iChieuDaiID+") ");
            execute_data(" ALTER TABLE " + user + s_mmyy + ".cdha_data_vu alter column id type  numeric("+iChieuDaiID+") ");
            execute_data(" ALTER TABLE " + user + s_mmyy + ".cdha_image alter column id type  numeric("+iChieuDaiID+") ");
            execute_data(" ALTER TABLE " + user + s_mmyy + ".cdha_image alter column id_hinh type  numeric("+iChieuDaiID+") ");
            execute_data(" ALTER TABLE " + user + s_mmyy + ".cdha_kqvp alter column id type  numeric("+iChieuDaiID+") ");
            execute_data(" ALTER TABLE " + user + s_mmyy + ".cdha_ctphimxq alter column id type  numeric("+iChieuDaiID+") ");
            execute_data(" ALTER TABLE " + user + s_mmyy + ".cdha_data_noisoitai alter column id type  numeric("+iChieuDaiID+") ");
            execute_data(" ALTER TABLE " + user + s_mmyy + ".cdha_data_noisoimuixoang alter column id type  numeric("+iChieuDaiID+") ");



        }

        /// <summary>
        /// tăng chiều dài id, mabn,maql,makp... tháng năm
        /// </summary>
        /// <param name="m_mmyy">mmyy cần tăng</param>
        void modify_schema_thucong(string m_mmyy)
        {
            string s_sql = "";
            if (bMmyy(m_mmyy))
            {
                string sSchema = userid + m_mmyy;
                #region  maql mmyy
                s_sql = "alter table " + sSchema + ".bhytkb alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".d_xuatsdll alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".d_dutrull alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".d_hoantrall alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".d_htrathuocll alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".d_huybanll alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".d_ngtrull alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".d_thuocbhytll alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".d_tienthuoc alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".d_toathuocll alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".d_xtutrucll alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".v_chidinh alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".v_chidinh_huy alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".xn_phieu alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".v_phieuchill alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".v_phieuchill alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".v_thngayll alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".v_thvpll alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".v_vienphill alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".ba_khambenh alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".ba_thuchien alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".bask_chiso alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".bask_cls alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".bask_coxuong alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".bask_dalieu alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".bask_donvi alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".bask_kqcls alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".bask_mat alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".bask_ngkhoa alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".bask_noikhoa alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".bask_rhm alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".bask_rmh alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".bask_sanphu alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".bask_tmh alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".bask_tongket alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".bavv_chung alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".bavv_dausinhton alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".bavv_mat alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".bavv_rhm alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".bavv_tmh alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".bavv_tmhct alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".benhancc alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".benhanpk alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".bhyt alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".bhytkb alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".cdha_bnll alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".cdkemtheo alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".cdnguyennhan alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".cdsankhoa alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".cdungbuou alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".cls_ketqua alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".cls_thuchien alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".d_dausinhton alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".dasuamadt alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".dausinhton alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".di_kthucdonll alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".di_thucdonll alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".giayravien alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".hen alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".khoacdkham alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".lienhe alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".lydokham alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".ng_hoantra alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".ngaykb alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".noigioithieu alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".pttt alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".pttt_lichmo alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".quanhe alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".sokhamthaict alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".sophieurv alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".tainangt alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".tainantt alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".tiepdon alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".trieuchung alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".ttbong alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".ttkhamthai alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".ttmat alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".tttamthan alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".tttiepdon alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".v_congno alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".v_hoantra alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".v_tamung alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".v_tamungcd alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".v_thngayll alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".v_thvpll alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".v_tontamung alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".v_ttrvds alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".v_ttrvds1211 alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".v_vienphill alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".v_vpkhoa alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".xn_done alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".xn_hoachatbn alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".xn_laymau alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".xn_phieu alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                s_sql += "alter table " + sSchema + ".xn_vpkhoa alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);\n";
                #endregion
                #region id mmyy
                s_sql += "alter table " + sSchema + ".d_chuyenll   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".bhytkb  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".bhytthuoc    alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ct_ketqua    alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_xuatsdll   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_theodoi    alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_bucstt     alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_ctghisoll  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_ctghisoct  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_dutrucapll alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_dutrucapct alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_duyet alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_dutrull    alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_haophill   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_hoantrall  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_hoantract  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_htrathuocll alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_htrathuocct alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_huybanll   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_huybanct   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_ngtrull    alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_nhapbbll   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_nhapbbct   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_nhapll     alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_nhapct     alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_nhapct2    alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_nhapslll   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_nhapslct   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_phieuxuat  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_thanhtoan  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_thucbucstt alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_thucxuat   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_thucxuat2  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_thuocbhytll alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_thuocbhytct alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_tienthuoc  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_toathuocll alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_toathuocct alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_xtutrucll  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_xtutrucct  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_xuatll     alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_xuatct     alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_xuatsdct   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ng_vienphill alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_chidinh    alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_chidinh_huy alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".xn_phieu     alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_phieuchill alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_phieuchill alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_phieuchict alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_thngayll   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_thvpll     alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_ttrvll     alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_vienphill  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_camdoan   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_chamsoc   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_chamsocct alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_chung     alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_danhgia1  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_dieutri   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_dieutrict alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_dongmachvanh  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_giaonhan  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_giaonhanct alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_hbdacdiem alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_hinh alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_hoichan   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_hoichancc alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_hoichanccxn   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_hoichanthuoc  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_hoichanxn alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_kbdausinhton  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_khamtienme alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_kiemsoat  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_kiemsoatcc alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_kiemsoatccct  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_kiemsoatct alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_linhmau   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_linhmauct alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_locmauct  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_locmaull  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_noikhoa   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_puthuoc   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_scan alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_soket     alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_thuchien  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_tkhoso    alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_tomtat    alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_truyendich alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_truyendichct  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_truyenmau alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_truyenmauct   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_vanchuyen alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ba_vanchuyenct   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".bask_tiensu  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".bhytcls alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".bhytkb  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".capsotoa     alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".cdha_benh    alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".cdha_bnct    alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".cdha_bnll    alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".cdha_bnct_thuocphim   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".cdha_ctphimxq alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".cdha_ctxq    alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".cdha_data_2d alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".cdha_data_2d_doppler  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".cdha_data_2d_md  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".cdha_data_doppler     alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".cdha_data_doppler_md  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".cdha_data_machmau     alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".cdha_data_noisoimuixoang   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".cdha_data_noisoitai   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".cdha_data_noisoithanhquan  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".cdha_data_nsdaday     alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".cdha_data_nsdaitrang  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".cdha_data_phanmem     alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".cdha_data_phukhoa     alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".cdha_data_san alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".cdha_data_san_chitiet alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".cdha_data_tongquat    alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".cdha_data_tuyengiap   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".cdha_data_tuyenvu     alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".cdha_data_vu alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".cdha_image   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".cdha_kqvp    alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".cdkemtheo    alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".cdnguyennhan alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".cdungbuou    alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".cls_hen alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".cls_hinh     alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".cls_ketqua   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".cls_mat alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".cls_motact   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".cls_sdthuoc  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".cls_thuchien alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ct_chitiet   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ct_ketqua    alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ct_kham alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_bienlai    alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_capsotoa   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_chandoan   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_chonhapct alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_chonhapll  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_dausinhton alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_ngaylanh   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_ngtruct    alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_thanhtoanct alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".d_xuat_mavachct  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".di_anlong    alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".di_duyet     alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".di_kthucdonct alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".di_kthucdonll alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".di_nauan     alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".di_nauanct   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".di_thucdonct alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".di_thucdonll alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ng_chia alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ng_dmnv alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ng_hoantra   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ng_hoantract alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ng_huybienlai alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ng_khamct    alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ng_khamll    alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ng_vienphict alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".ng_vienphill alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".pttt    alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".pttt_duyetmo alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".pttt_hinh    alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".pttt_lichmo  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".stttiepdon   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_bhyt  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_bienlaitaichinhll   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_bienlaitaichinhct   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_giuong     alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_hoantra    alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_hoantract  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_huybienlai alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_mienngtru  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_miennoitru alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_nhom  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_phieuchict alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_tamung     alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_tamungcd   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_tamungct   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_tamungdatru alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_thngayct   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_thngayll   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_thvpbhyt   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_thvpct     alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_thvpll     alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_tontamung  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_trongoi    alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_ttrvbhyt   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_ttrvct     alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_ttrvct_luu alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_ttrvds     alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_ttrvds1211 alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_ttrvdv     alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_ttrvll     alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_ttrvnhom   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_ttrvpttt   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_ttrvptttct alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_vienphict  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_vienphidv  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_vienphill  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".v_vpkhoa     alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".x_kq    alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".xn_done alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".xn_hc   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".xn_hoachatbn alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".xn_ketqua    alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".xn_ketqua_ksd alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".xn_ksd  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".xn_laymau    alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".xn_laymau_done   alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".xn_nhuomgram alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".xn_phieu     alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".xn_phieu_done alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".xn_vpkhoa    alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                s_sql += "alter table " + sSchema + ".xn_worksheet_ct  alter column id type  numeric(" + iChieuDaiID.ToString() + ") ;\n";
                #endregion
                #region mabn mmyy
                s_sql += "alter table " + sSchema + ".bhytkb alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ct_ketqua alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".d_xuatsdll alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".d_dutrull alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".d_hoantrall alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".d_htrathuocll alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".d_huybanll alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".d_ngtrull alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".d_thuocbhytll alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".d_tienthuoc alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".d_toathuocll alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".d_xtutrucll alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ng_vienphill alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".v_chidinh alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".v_chidinh_huy alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".xn_phieu alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".v_phieuchill alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".v_phieuchill alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".v_thngayll alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".v_thvpll alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".v_vienphill alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ba_camdoan alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ba_chamsoc alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ba_chung alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ba_danhgia1 alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ba_danhgia2 alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ba_danhgia" + i_maxlength_makp.ToString() + " alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ba_dieutri alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ba_dongmachvanh alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ba_giaonhan alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ba_hbdacdiem alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ba_hinh alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ba_hoichan alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ba_hoichancc alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ba_hoichanccxn alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ba_hoichanthuoc alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ba_hoichanxn alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ba_kbdausinhton alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ba_khamtienme alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ba_kiemsoat alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ba_kiemsoatcc alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ba_linhmau alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ba_locmaull alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ba_noikhoa alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ba_puthuoc alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ba_scan alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ba_soket alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ba_thuchien alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ba_tkhoso alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ba_tomtat alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ba_truyendich alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ba_truyenmau alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ba_vanchuyen alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".bask_chiso alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".bask_cls alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".bask_coxuong alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".bask_dalieu alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".bask_donvi alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".bask_kqcls alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".bask_mat alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".bask_ngkhoa alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".bask_noikhoa alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".bask_rhm alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".bask_sanphu alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".bask_tmh alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".bask_tongket alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".bavv_chung alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".bavv_dausinhton alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".bavv_mat alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".bavv_rhm alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".bavv_tmh alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".benhancc alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".benhanpk alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".bhyt alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".bhytkb alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".cdha_bnll alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".cdha_kqvp alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".cls_ketqua alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".cls_thuchien alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ct_btdbn alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ct_ketqua alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".d_dausinhton alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".d_sophieukb alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".di_kthucdonll alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".di_thucdonll alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".inchiphipk alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".khoacdkham alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ng_hoantra alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ng_huybienlai alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ng_vienphill alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ngaykb alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".pttt alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".pttt_lichmo alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".sokhamthai alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".sophieurv alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".sukien alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".tainantt alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".tiepdon alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".ttkhamthai alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".v_bienlaitaichinhll alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".v_bienlaitaichinhct alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".v_congno alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".v_hoantra alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".v_huybienlai alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".v_sophieucls alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".v_tamung alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".v_tamungcd alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".v_thngayll alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".v_thvpll alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".v_tontamung alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".v_ttrvds alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".v_vienphill alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".v_vpkhoa alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".xn_done alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".xn_hoachatbn alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".xn_laymau alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".xn_phieu alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                s_sql += "alter table " + sSchema + ".xn_vpkhoa alter column mabn type character varying((" + i_maxlength_mabn.ToString() + ");\n";
                #endregion
                #region makp mmyy
                s_sql += "alter table " + schema + ".bhytkb alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".d_thuocbhytll alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".d_toathuocll alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".v_chidinh alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".v_chidinh_huy alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".v_phieuchill alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".v_phieuchill alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".v_thvpll alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".v_ttrvll alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".v_vienphill alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".v_vienphill alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".ba_thuchien alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".bask_coxuong alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".bask_dalieu alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".bask_mat alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".bask_ngkhoa alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".bask_noikhoa alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".bask_rhm alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".bask_rmh alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".bask_sanphu alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".bask_tmh alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".bask_tongket alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".benhancc alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".benhanpk alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".bhytkb alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".cdha_bnll alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".cdha_kqvp alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".cls_thuchien alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".d_dausinhton alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".di_duyet alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".di_ngayduyet alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".di_thucdonll alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".inchiphipk alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".khoacdkham alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".ng_hoantra alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".ng_huybienlai alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".pttt alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".pttt_lichmo alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".sttkham alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".tiepdon alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".v_bienlaitaichinhct alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".v_hoantra alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".v_huybienlai alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".v_tamung alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".v_tamungcd alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".v_thngayll alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".v_thvpct alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".v_thvpll alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".v_tontamung alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".v_ttrvct alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".v_ttrvct_luu alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".v_ttrvdv alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".v_ttrvll alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".v_vienphict alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".v_vienphidv alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".v_vienphill alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".v_vienphill alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".v_vpkhoa alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
                s_sql += "alter table " + schema + ".xn_phieu alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";

                #endregion
                foreach (string s_query in s_sql.Trim(';').Split(';'))
                {
                    string s_tmp = s_query.Replace("xxx.", sSchema + ".");
                    s_tmp = s_tmp.Replace("medibv.", userid + ".");
                    execute(s_tmp);
                }
            }
        }
        /// <summary>
        /// tăng chiều dài id, mabn,maql,makp... gốc
        /// </summary>
        public void modify_schema_thucong()
        {
            #region maql gốc
            string s_sql = "alter table " + userid + ".bavv_thuchien  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".ba_luutru  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0);  \n";
            s_sql += "alter table " + userid + ".ba_muon  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".barv_mat  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".bbtuvong  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".bbtuvongnv  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".benhandt  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".benhanngtr  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".benhantc  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".bhytkb  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".bienbantuvong  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".bienbantuvong1  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".blgd_ra  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".blgd_sangloc  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".blgd_vao  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".capmaql  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".cdha_bienban_holter  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".chuyenkhoa  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".chuyenvien  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".d_suamadt  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".dd_anll  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".dd_chidinhll  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".ddsosinh  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".eha_noisoi_ll  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".ghichudt  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".giayxacnhan  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".hiendien  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".hiendienngtr  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".hoichan_cdha  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".kbct_canquangll  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".kehoachdt  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".khamchuyenkhoa  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".khdieutri  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".khuyettat  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".lydo  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".lydokham  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".nhapkhoa  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".nhapkhoangtr  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".phanungthuoc_adr  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".t_cdnguyennhan  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".t_congkhai  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".t_pttt  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".t_thcpdt  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".t_ttba  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".theodoidt  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".theodoigiuong  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".theodoivltl  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".tresosinh  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".trieuchung  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".ttptttkhoa  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".tuchoi  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".tusat  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".tuvong  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".v_capsokham  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".v_paid  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".v_theodoicongno  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".v_ttrvthatthu  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".v_ttrvthua  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".xn_hoachat  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".xn_phanquyennhom  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".xuattam  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".xuatvien  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".xn_phieu  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".hen_tapvltl  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".sstt_benhsu  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".sstt_canlamsang  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".sstt_chandoan  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".sstt_hanhchanh  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".sstt_hinhanhhoc  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".sstt_kham  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".sstt_test  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".sstt_tiencancanhan  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".vltl_thuchien  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".bienbansuahoso  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            s_sql += "alter table " + userid + ".bntaikhamsom  alter column maql type numeric(" + iChieuDaiID.ToString() + ",0); \n";
            #endregion
            #region mabn gốc
            s_sql += "alter table " + userid + ".ba_tkhoso alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ");\n";
            s_sql += "alter table " + userid + ".ct_henksk alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".btdbnct alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".bhytds_pkcb alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".btdbn alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".diungthuoc alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".ba_camdoan alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".ba_chamsoc alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".bavv_thuchien alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".ba_luutru alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".ba_muon alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".bbtuvong alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".benhandt alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".benhanngtr alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".benhantc alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".benhmantinh alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".bhytds alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".bhytkb alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".bienbantuvong alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".bienbantuvong1 alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".blgd_ra alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".blgd_sangloc alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".blgd_vao alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".bndk_tg alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".bn_dangthu alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".btdbn_hen alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".btdbn_trungcao alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".btdbn_uudai alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".cdha_bienban_holter alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".chuyenkhoa alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".ct_btdbn_muc alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".ct_btdbn alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".ct_ketqua alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".ct_mucbn alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".cuochen alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".d_phatthuoc alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".d_suamadt alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".datgiuong alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".dd_anll alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".dd_btdbn alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".dd_chidinhll alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".ddsosinh alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".dienthoai alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".dmbhyt alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".dmthe alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".eba_barcode alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".eba_hinhbn alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".eha_noisoi_hc alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".eha_noisoi_ll alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".ghichudt alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".giaythuphanungthuoc alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".giayxacnhan alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".hachungtu alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".hcnhi alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".hcsosinh alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".hiendien alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".hiendienngtr alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".hoichan_cdha alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".kbct_canquangll alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".kehoachdt alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".khamchuyenkhoa alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".khdieutri alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".khuyettat alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".kskbtdbn alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".kyten alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".lydo alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".nhapkhoa alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".nhapkhoangtr alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".nuocngoai alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".phanung_sautc alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".phanungthuoc_adr alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".phieutiemchung alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".t_thcpdt alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".t_ttba alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".theodoidt alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".theodoigiuong alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".theodoitiensu alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".theodoitsu alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".theodoivltl alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".ttptttkhoa alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".tuchoi alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".tusat alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".tylemien_km alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".tylemien_mg alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".tylemien_ud alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".v_lcd alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".v_paid alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".v_theodoicongno alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".v_ttrvthatthu alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".v_ttrvthua alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".v_tylegiamll alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".vantay alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".vantay_new alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".xuattam alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".xuatvien alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".yeucauhoadon alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".ng_huybienlai alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".dg_ketquadg alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".eba_vantay alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".hen_tapvltl alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".hoithao_dangky alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".inthebn alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".sstt_benhsu alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".sstt_canlamsang alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".sstt_chandoan alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".sstt_hanhchanh alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".sstt_hinhanhhoc alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".sstt_kham alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".sstt_test alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".sstt_tiencancanhan alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".vltl_thuchien alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".bienbansuahoso alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".bntaikhamsom alter column mabn type character varying(" + i_maxlength_mabn.ToString() + ") ;\n";
            #endregion
            #region makp gốc
            s_sql += "alter table " + userid + ".dmbs alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".xn_dlogin alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".btdkp_bv alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".btdkp_bv alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".d_duockp alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".cdha_loai alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".bavv_thuchien alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".bc_nhomkhoabvct alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".bc_nhomkhoabvll alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".benhandt alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".benhanngtr alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".bhytkb alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".bienbantuvong alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".bienbantuvong1 alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".btdkp_add alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".btdkp_ksk alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".btdpmo alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".chuyenkhoa alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".ct_giavp alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".d_ttngay alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".dd_chidinhll alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".dmbs1 alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".dmphong alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".hiendien alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".hiendienngtr alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".icd10_bv alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".kehoachdt alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".ksk_chuyenkhoapk alter column makp type character varying(" + i_maxlength_makp.ToString() + ");\n";
            s_sql += "alter table " + userid + ".nhapkhoa alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".nhapkhoangtr alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".phieutiemchung alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".pttt_mau alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".t_congkhai alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".t_thcpdt alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".thctkh alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".thctkhngtr alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".theodoigiuong alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".ththbn alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".tuchoi alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".user_active alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".v_dmghe alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".v_nhomkhoabvct alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".v_trongoipk alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".v_tylegiamll alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".v_webt_ttrvct alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".v_webt_vienphict alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".xn_hoachatdm alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".xuattam alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".xuatvien alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".yeucauhoadonct alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".ng_huybienlai alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".lichlamviec_bs alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".sstt_test alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".xndm alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".bienbansuahoso alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".bntaikhamsom alter column makp type character varying(" + i_maxlength_makp.ToString() + ") ;\n";
            s_sql += "alter table " + userid + ".dmbs alter column mapk type character varying(" + i_maxlength_makp.ToString() + ");\n";
            s_sql += "alter table" + userid + ". khdieutri alter column mapk type character varying(" + i_maxlength_makp.ToString() + ");\n";

            #endregion
            foreach (string s_query in s_sql.Trim(';').Split(';'))
            {
                string s_tmp = s_query.Replace("medibv.", userid + ".");
                execute(s_tmp);
            }
        }
        public void modify_schema(string m_mmyy, int m_userid, string s_tenfile_taotable)
        {
            if (bMmyy(m_mmyy))
            {
                string usr = userid;
                schema = usr + m_mmyy;
                if (ds != null)
                {
                    ds.Dispose();
                    ds = null;
                }

                ds = new DataSet();
                if (System.IO.File.Exists("..//" + s_tenfile_taotable.Replace(".xml", "") + ".xml")) ds.ReadXml("..//" + s_tenfile_taotable.Replace(".xml", "") + ".xml");
                else ds.ReadXml("..//..//..//xml//" + s_tenfile_taotable.Replace(".xml", "") + ".xml");
                foreach (DataRow r in ds.Tables[0].Rows)
                {
                    sql = r["ten"].ToString().Trim().Replace("xxx", schema).Replace("zzz", m_mmyy.Substring(2));
                    if (con != null)
                    {
                        con.Close(); con.Dispose();
                    }
                    con = new NpgsqlConnection(sConn);
                    try
                    {
                        con.Open();
                        cmd = new NpgsqlCommand(sql, con);
                        cmd.CommandType = CommandType.Text;
                        cmd.ExecuteNonQuery();
                        cmd.Dispose();
                        con.Close(); con.Dispose();
                    }
                    catch { cmd.Dispose(); con.Close(); con.Dispose(); }
                }
                tao_function(m_mmyy);
            }
        }

        public void tao_index(string m_mmyy)
        {
            return;
            #region hide
            /*
            if (bMmyy(m_mmyy))
            {
                schema=user+m_mmyy;
                sql="CREATE INDEX benhancc_index ON "+schema+".benhancc (maql, mabn) TABLESPACE medi_index;\n";
                sql+="CREATE INDEX benhanpk_index ON "+schema+".benhanpk (maql, mabn) TABLESPACE medi_index;\n";
                sql+="CREATE INDEX bhyt_index ON "+schema+".bhyt (maql, mabn) TABLESPACE medi_index;\n";
                sql+="CREATE INDEX bhytcls_index  ON "+schema+".bhytcls (id, mavp) TABLESPACE medi_index;\n";
                sql+="CREATE INDEX bhytkb_index ON "+schema+".bhytkb (nhom, id, maql, mabn) TABLESPACE medi_index;\n";
                sql+="CREATE INDEX bhytthuoc_index ON "+schema+".bhytthuoc (id, sttt, makho, mabd) TABLESPACE medi_index;\n";
                sql+="CREATE INDEX cdkemtheo_index ON "+schema+".cdkemtheo (id, maql) TABLESPACE medi_index;\n";
                sql+="CREATE INDEX cdnguyennhan_index ON "+schema+".cdnguyennhan (id, maql) TABLESPACE medi_index;\n";
                sql+="CREATE INDEX cdungbuou_index ON "+schema+".cdungbuou (id, maql) TABLESPACE medi_index;\n";
                sql+="CREATE INDEX cls_ketqua_index ON "+schema+".cls_ketqua (id, maql, mabn) TABLESPACE medi_index;\n";
                sql+="CREATE INDEX cls_thuchien_index ON "+schema+".cls_thuchien (id, maql, mabn) TABLESPACE medi_index;\n";
                sql+="CREATE INDEX ct_chitiet_index ON "+schema+".ct_chitiet (id, mavp) TABLESPACE medi_index;\n";
                sql+="CREATE INDEX ct_ketqua_index ON "+schema+".ct_ketqua (id, mabn) TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_bucstt_index ON "+schema+".d_bucstt (id, sttt, makho, mabd) TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_chuyenct_index ON "+schema+".d_chuyenct (id, sttt, makho, mabd) TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_chuyenll_index ON "+schema+".d_chuyenll (nhom, id)  TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_ctghisoct_index ON "+schema+".d_ctghisoct (id, makho, makp) TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_ctghisoll_index   ON "+schema+".d_ctghisoll (nhom, id)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_daduyet_index   ON "+schema+".d_daduyet (nhom, makp, makho, loai, phieu)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_dausinhton_index   ON "+schema+".d_dausinhton (id, idkhoa, iddutru)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_dutrucapct_index   ON "+schema+".d_dutrucapct (id, manguon, mabd)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_dutrucapll_index   ON "+schema+".d_dutrucapll (nhom, id, khox, khon)      TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_dutruct_index   ON "+schema+".d_dutruct (id, madoituong, makho, manguon, mabd)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_dutrull_index   ON "+schema+".d_dutrull (id, idduyet, maql, mabn)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_duyet_index   ON "+schema+".d_duyet (nhom, id, makp, makhoa, loai, phieu)     TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_haophict_index   ON "+schema+".d_haophict (id, madoituong, makho, manguon, mabd)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_haophill_index   ON "+schema+".d_haophill (id, idduyet)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_hoantract_index   ON "+schema+".d_hoantract (id, madoituong, makho, slthuc, mabd)      TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_hoantrall_index   ON "+schema+".d_hoantrall (id, idduyet, maql, idkhoa, mabn)      TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_huybanct_index   ON "+schema+".d_huybanct (id, sttt, makho, mabd)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_huybanll_index   ON "+schema+".d_huybanll (nhom, id)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_ngayduyet_index   ON "+schema+".d_ngayduyet (nhom, idduyet, loai, phieu, makp)      TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_ngtruct_index   ON "+schema+".d_ngtruct (id, sttt, makho, mabd)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_ngtrull_index   ON "+schema+".d_ngtrull (nhom, id)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_nhapct2_index   ON "+schema+".d_nhapct2 (id, mabd)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_nhapct_index   ON "+schema+".d_nhapct (id, mabd)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_nhapll_index   ON "+schema+".d_nhapll (nhom, id, madv, makho, manguon)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_nhapbbct_index   ON "+schema+".d_nhapbbct (id, mabd)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_nhapbbll_index   ON "+schema+".d_nhapbbll (nhom, id, madv, makho, manguon)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_nhapslct_index   ON "+schema+".d_nhapslct (id, mabd)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_nhapslll_index   ON "+schema+".d_nhapslll (nhom, id, madv, makho)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_phieuxuat_index   ON "+schema+".d_phieuxuat (nhom, id, makp, kho, loai, phieu)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_sophieu_index   ON "+schema+".d_sophieu (nhom, makp, makho, loai, phieu)      TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_theodoi_index   ON "+schema+".d_theodoi (id, mabd, manguon, nhomcc)      TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_thucbucstt_index   ON "+schema+".d_thucbucstt (id, sttt, makho, mabd)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_thucxuat_index   ON "+schema+".d_thucxuat (id, sttt, makho, mabd)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_thucxuat2_index   ON "+schema+".d_thucxuat2 (id, sttt, makho, mabd)    TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_thuocbhytct_index   ON "+schema+".d_thuocbhytct (id, makho, manguon, mabd)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_thuocbhytll_index   ON "+schema+".d_thuocbhytll (nhom, id, maql, mabn)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_tienthuoc_index   ON "+schema+".d_tienthuoc (maql, mabn, madoituong, mabd, makp)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_toathuocct_index   ON "+schema+".d_toathuocct (id, mabd)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_toathuocll_index   ON "+schema+".d_toathuocll (id, maql, mabn)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_tonkhoct_index   ON "+schema+".d_tonkhoct (makho, stt, mabd)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_tonhokemtheo_index   ON "+schema+".d_tonkhokemtheo (makhot, sttt, makho, stt, mabd)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_tonkhoth_index   ON "+schema+".d_tonkhoth (makho, manguon, mabd)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_tutrucct_index   ON "+schema+".d_tutrucct (makp, makho, stt, mabd)     TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_tutruckemtheo_index   ON "+schema+".d_tutruckemtheo (makhot, sttt, makp, makho, stt, mabd)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_tutructh_index   ON "+schema+".d_tutructh (makp, makho, manguon, mabd)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_xtutrucct_index   ON "+schema+".d_xtutrucct (id, makho, manguon, mabd)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_xtutrucll_index   ON "+schema+".d_xtutrucll (id, idduyet, maql, mabn)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_xuatct_index   ON "+schema+".d_xuatct (id, sttt, mabd)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_xuatll_index   ON "+schema+".d_xuatll (nhom, id, khox, khon)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_xuatsdct_index   ON "+schema+".d_xuatsdct (id, sttt, makho, mabd)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX d_xuatsdll_index   ON "+schema+".d_xuatsdll (nhom, id, maql, mabn, makp, loai)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX khoacdkham_index   ON "+schema+".khoacdkham (maql, mabn)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX ng_hoantra_index   ON "+schema+".ng_hoantra (id, maql, mabn)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX ng_vienphict_index   ON "+schema+".ng_vienphict (idll, id, mavp)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX ng_vienphill_index   ON "+schema+".ng_vienphill (id, mabn)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX ngaykb_index   ON "+schema+".ngaykb (maql, mabn)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX noigioithieu_index   ON "+schema+".noigioithieu (maql, mabv)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX pttt_index   ON "+schema+".pttt (maql, mabn)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX pttt_lichmo_index   ON "+schema+".pttt_lichmo (maql, mabn)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX tainantt_index   ON "+schema+".tainantt (maql, mabn)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX tiepdon_index   ON "+schema+".tiepdon (maql, mabn)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX ttkhamthai_index   ON "+schema+".ttkhamthai (maql, mabn)      TABLESPACE medi_index;\n";
                sql+="CREATE INDEX v_chidinh_index   ON "+schema+".v_chidinh (maql, mabn, mavp)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX v_congno_index   ON "+schema+".v_congno (maql, mabn, mavp)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX v_hoantra_index   ON "+schema+".v_hoantra (id, maql, mabn)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX v_phieuchict_index   ON "+schema+".v_phieuchict (id, mavp)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX v_phieuchill_index   ON "+schema+".v_phieuchill (id, maql, mabn)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX v_tamung_index   ON "+schema+".v_tamung (id, maql, mabn)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX v_thngayct_index   ON "+schema+".v_thngayct (id, mavp)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX v_thngayll_index   ON "+schema+".v_thngayll (id, maql, mabn)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX v_thvpct_index   ON "+schema+".v_thvpct (id, mavp)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX v_thvpll_index   ON "+schema+".v_thvpll (id, maql, mabn, ngayvao)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX v_ttrvct_index   ON "+schema+".v_ttrvct (id, mavp)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX v_ttrvds_index   ON "+schema+".v_ttrvds (id, maql, mabn)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX v_vienphict_index   ON "+schema+".v_vienphict (id, mavp)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX v_vienphill_index   ON "+schema+".v_vienphill (id, maql, mabn)      TABLESPACE medi_index;\n";
                sql+="CREATE INDEX v_vpkhoa_index   ON "+schema+".v_vpkhoa (id, maql, mabn, mavp)       TABLESPACE medi_index;\n";
                sql+="CREATE INDEX inchiphipk_index   ON " + schema + ".inchiphipk (mavaovien, mabn)       TABLESPACE medi_index;\n";

                con = new NpgsqlConnection(sConn);
                try
                {
                    con.Open();
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.ExecuteNonQuery();
                    cmd.Dispose();
                    con.Close();con.Dispose();
                }
                catch { cmd.Dispose(); con.Close();con.Dispose(); }
            }*/
            #endregion
        }

        public void tao_function(string m_mmyy)
        {
            if (bMmyy(m_mmyy))
            {
                LibDuoc.AccessData d = new LibDuoc.AccessData();
                bool bUpdtienthuoc = bThanhtoan_khoa || bThanhtoan_ndot || bDieutri_donthuoc;
                string usr = user;
                bool bGiaban = false;
                if (!d.bGiaban_theodot(nhom_duoc))
                    bGiaban = get_data("select * from " + usr + ".d_doituong where loai=1").Tables[0].Rows.Count > 0;
                schema = usr + m_mmyy;
                sql = "create or replace function " + schema + ".upd_tiepdon(m_mabn varchar,m_maql numeric,m_makp varchar,m_ngay varchar,m_madoituong numeric,m_sovaovien varchar,m_tuoivao varchar,m_userid numeric,m_bnmoi numeric,m_noitiepdon numeric,m_loai numeric) returns void as \n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".tiepdon set mabn=m_mabn,makp=m_makp,ngay=to_timestamp(m_ngay,'dd/mm/yyyy hh24:mi'),madoituong=m_madoituong,sovaovien=m_sovaovien,tuoivao=m_tuoivao,userid=m_userid,bnmoi=m_bnmoi,noitiepdon=m_noitiepdon,loai=m_loai where maql=m_maql;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".tiepdon(mabn,maql,makp,ngay,madoituong,sovaovien,tuoivao,userid,bnmoi,noitiepdon,loai) values (m_mabn,m_maql,m_makp,to_timestamp(m_ngay,'dd/mm/yyyy hh24:mi'),m_madoituong,m_sovaovien,m_tuoivao,m_userid,m_bnmoi,m_noitiepdon,m_loai);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "language 'plpgsql' VOLATILE;\n";
                sql = "create or replace function " + schema + ".upd_tiepdon(m_mabn varchar,m_mavaovien numeric,m_maql numeric,m_makp varchar,m_ngay varchar,m_madoituong numeric,m_sovaovien varchar,m_tuoivao varchar,m_userid numeric,m_bnmoi numeric,m_noitiepdon numeric,m_loai numeric) returns void as \n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".tiepdon set mabn=m_mabn,mavaovien=m_mavaovien,makp=m_makp,ngay=to_timestamp(m_ngay,'dd/mm/yyyy hh24:mi'),madoituong=m_madoituong,sovaovien=m_sovaovien,tuoivao=m_tuoivao,userid=m_userid,bnmoi=m_bnmoi,noitiepdon=m_noitiepdon,loai=m_loai where maql=m_maql;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".tiepdon(mabn,mavaovien,maql,makp,ngay,madoituong,sovaovien,tuoivao,userid,bnmoi,noitiepdon,loai) values (m_mabn,m_mavaovien,m_maql,m_makp,to_timestamp(m_ngay,'dd/mm/yyyy hh24:mi'),m_madoituong,m_sovaovien,m_tuoivao,m_userid,m_bnmoi,m_noitiepdon,m_loai);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "language 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_lienhe(m_maql numeric,m_sonha text,m_thon text,m_cholam text,m_matt varchar,m_maqu varchar,m_maphuongxa varchar,m_tuoivao varchar,m_loai numeric,m_bnmoi numeric)  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".lienhe set  sonha=m_sonha,thon=m_thon,cholam=m_cholam,matt=m_matt,maqu=m_maqu,maphuongxa=m_maphuongxa,tuoivao=m_tuoivao,loai=m_loai,bnmoi=m_bnmoi where maql=m_maql;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".lienhe(maql,sonha,thon,cholam,matt,maqu,maphuongxa,tuoivao,loai,bnmoi) values (m_maql,m_sonha,m_thon,m_cholam,m_matt,m_maqu,m_maphuongxa,m_tuoivao,m_loai,m_bnmoi);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_quanhe(m_maql numeric,m_quanhe text,m_hoten text,m_diachi text,m_dienthoai text)  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".quanhe set quanhe=m_quanhe,hoten=m_hoten,diachi=m_diachi,dienthoai=m_dienthoai  where maql=m_maql;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".quanhe(maql,quanhe,hoten,diachi,dienthoai) values (m_maql,m_quanhe,m_hoten,m_diachi,m_dienthoai);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_quanhe(m_maql numeric,m_quanhe text,m_hoten text,m_diachi text,m_dienthoai text,m_phuongtien text)  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".quanhe set quanhe=m_quanhe,hoten=m_hoten,diachi=m_diachi,dienthoai=m_dienthoai,phuongtien=m_phuongtien  where maql=m_maql;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".quanhe(maql,quanhe,hoten,diachi,dienthoai,phuongtien) values (m_maql,m_quanhe,m_hoten,m_diachi,m_dienthoai,m_phuongtien);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_sukien(m_mabn varchar,m_matiepdon numeric,m_noitiepdon numeric,m_macap numeric)\n";
                sql += "RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".sukien set mabn=m_mabn where matiepdon=m_matiepdon and noitiepdon=m_noitiepdon and macap=m_macap;\n";
                sql += "    if found=false then\n";
                sql += "         insert into " + schema + ".sukien(mabn,matiepdon,noitiepdon,macap) values (m_mabn,m_matiepdon,m_noitiepdon,m_macap);\n";
                sql += " 	end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_chidinh(v_id numeric,v_mabn varchar,v_mavaovien numeric,v_maql numeric,v_idkhoa numeric,v_ngay varchar,v_loai numeric,v_makp varchar,v_madoituong numeric,v_mavp numeric,v_soluong numeric,v_dongia numeric,v_vattu numeric,v_userid numeric,v_tinhtrang numeric,v_thuchien numeric,v_computer varchar,v_idchidinh numeric,v_maicd varchar,v_chandoan text,v_mabs text,v_loaiba numeric)\n";
                sql += "RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".v_chidinh set mabn=v_mabn,mavaovien=v_mavaovien,maql=v_maql,idkhoa=v_idkhoa,ngay=to_timestamp(v_ngay,'dd/mm/yyyy hh24:mi'),loai=v_loai,makp=v_makp,madoituong=v_madoituong,mavp=v_mavp,soluong=v_soluong,dongia=v_dongia,vattu=v_vattu,userid=v_userid,tinhtrang=v_tinhtrang,thuchien=v_thuchien,computer=v_computer,maicd=v_maicd,chandoan=v_chandoan,mabs=v_mabs,loaiba=v_loaiba where id=v_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".v_chidinh(id,mabn,mavaovien,maql,idkhoa,ngay,loai,makp,madoituong,mavp,soluong,dongia,vattu,userid,tinhtrang,thuchien,computer,idchidinh,maicd,chandoan,mabs,loaiba) values (v_id,v_mabn,v_mavaovien,v_maql,v_idkhoa,to_timestamp(v_ngay,'dd/mm/yyyy hh24:mi'),v_loai,v_makp,v_madoituong,v_mavp,v_soluong,v_dongia,v_vattu,v_userid,v_tinhtrang,v_thuchien,v_computer,v_idchidinh,v_maicd,v_chandoan,v_mabs,v_loaiba);\n";
                sql += "	end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_chidinh(v_id numeric,v_mabn varchar,v_mavaovien numeric,v_maql numeric,v_idkhoa numeric,v_ngay varchar,v_loai numeric,v_makp varchar,v_madoituong numeric,v_mavp numeric,v_soluong numeric,v_dongia numeric,v_vattu numeric,v_userid numeric,v_tinhtrang numeric,v_thuchien numeric,v_computer varchar,v_idchidinh numeric,v_maicd varchar,v_chandoan text,v_mabs text,v_loaiba numeric,v_ghichu text)\n";
                sql += "RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".v_chidinh set mabn=v_mabn,mavaovien=v_mavaovien,maql=v_maql,idkhoa=v_idkhoa,ngay=to_timestamp(v_ngay,'dd/mm/yyyy hh24:mi'),loai=v_loai,makp=v_makp,madoituong=v_madoituong,mavp=v_mavp,soluong=v_soluong,dongia=v_dongia,vattu=v_vattu,userid=v_userid,tinhtrang=v_tinhtrang,thuchien=v_thuchien,computer=v_computer,maicd=v_maicd,chandoan=v_chandoan,mabs=v_mabs,loaiba=v_loaiba,ghichu=v_ghichu where id=v_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".v_chidinh(id,mabn,mavaovien,maql,idkhoa,ngay,loai,makp,madoituong,mavp,soluong,dongia,vattu,userid,tinhtrang,thuchien,computer,idchidinh,maicd,chandoan,mabs,loaiba,ghichu) values (v_id,v_mabn,v_mavaovien,v_maql,v_idkhoa,to_timestamp(v_ngay,'dd/mm/yyyy hh24:mi'),v_loai,v_makp,v_madoituong,v_mavp,v_soluong,v_dongia,v_vattu,v_userid,v_tinhtrang,v_thuchien,v_computer,v_idchidinh,v_maicd,v_chandoan,v_mabs,v_loaiba,v_ghichu);\n";
                sql += "	end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_v_bhyt(v_id numeric,v_sothe varchar,v_maphu numeric,v_mabv varchar,v_noigioithieu varchar)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".v_bhyt set sothe=v_sothe,maphu=v_maphu,mabv=v_mabv,noigioithieu=v_noigioithieu where id=v_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".v_bhyt(id,sothe,maphu,mabv,noigioithieu) values (v_id,v_sothe,v_maphu,v_mabv,v_noigioithieu);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_vienphill(v_id numeric,v_quyenso numeric,v_sobienlai numeric,v_ngay varchar,v_mabn varchar,v_mavaovien numeric,v_maql numeric,v_idkhoa numeric,v_makp varchar,v_hoten text,v_phai numeric,v_namsinh varchar,v_diachi text,v_loai numeric,v_loaibn numeric,v_userid numeric,v_masothue in varchar)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".v_vienphill set quyenso=v_quyenso,sobienlai=v_sobienlai,ngay=to_timestamp(v_ngay,'dd/mm/yyyy hh24:mi'),mabn=v_mabn,mavaovien=v_mavaovien,maql=v_maql,idkhoa=v_idkhoa,makp=v_makp,hoten=v_hoten,phai=v_phai,namsinh=v_namsinh,diachi=v_diachi,loai=v_loai,loaibn=v_loaibn,userid=v_userid,masothue=v_masothue where id=v_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".v_vienphill(id,quyenso,sobienlai,ngay,mabn,mavaovien,maql,idkhoa,makp,hoten,phai,namsinh,diachi,loai,loaibn,userid,masothue) values (v_id,v_quyenso,v_sobienlai,to_timestamp(v_ngay,'dd/mm/yyyy hh24:mi'),v_mabn,v_mavaovien,v_maql,v_idkhoa,v_makp,v_hoten,v_phai,v_namsinh,v_diachi,v_loai,v_loaibn,v_userid,v_masothue);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_vienphict(v_id numeric,v_stt numeric,v_madoituong numeric,v_mavp numeric,v_ten text,v_soluong numeric,v_dongia numeric,v_mien numeric,v_thieu numeric,v_vattu numeric,v_mabs varchar,v_makp varchar)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".v_vienphict set madoituong=v_madoituong,mavp=v_mavp,ten=v_ten,soluong=v_soluong,dongia=v_dongia,mien=v_mien,thieu=v_thieu,vattu=v_vattu,mabs=v_mabs,makp=v_makp  where id=v_id and stt=v_stt;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".v_vienphict(id,stt,madoituong,mavp,ten,soluong,dongia,mien,thieu,vattu,mabs,makp) values (v_id,v_stt,v_madoituong,v_mavp,v_ten,v_soluong,v_dongia,v_mien,v_thieu,v_vattu,v_mabs,v_makp);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_kiemtra(d_nhom numeric) \n";//linh 29052012
                sql += "RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "DECLARE\n";
                sql += "    d_id numeric;d_makho numeric;d_manguon numeric;d_nhomcc numeric;d_sttt numeric;d_tyle_ggia numeric;d_st_ggia numeric;d_slnhap numeric;d_slxuat numeric;\n";
                sql += "    d_stt numeric;d_mabd numeric;d_handung varchar;d_losx varchar;d_soluong numeric;d_giaban numeric;d_giamua numeric;\n";
                sql += "    d_loai varchar;d_khox numeric;d_khon numeric;d_thuoc numeric;i_loai numeric;d_makp numeric;d_theodoi numeric;\n";
                sql += "    d_stttchuyen numeric;d_namsx varchar;d_baohanh numeric;d_nguongoc numeric;d_tinhtrang numeric;d_sothe varchar;d_found numeric;\n";
                sql += "    cur_ll cursor (p_nhom numeric) is select id,makho,manguon,nhomcc from " + schema + ".d_nhapll where nhom=p_nhom;\n";
                sql += "    cur_ct cursor (p_id numeric) is select stt,mabd,handung,losx,soluong,giaban,giamua,namsx,baohanh,nguongoc,tinhtrang,sothe,tyle_ggia,st_ggia from " + schema + ".d_nhapct where id=p_id;\n";
                sql += "    cur_temp_tonkho cursor (p_nhom numeric) is select makho,mabd,sttt,sum(slnhap) as slnhap,sum(slxuat) as slxuat from temp_tonkhoct group by makho,mabd,sttt;\n";
                sql += "    cur_temp_tutruc cursor (p_nhom numeric) is select makho,makp,mabd,sttt,sum(slnhap) as slnhap,sum(slxuat) as slxuat from temp_tutrucct group by makho,makp,mabd,sttt;\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_tonkhoct set slnhap=0,slxuat=0 where makho in (select id from medibv.d_dmkho where nhom=d_nhom);\n";
                sql += "    update " + schema + ".d_tutrucct set slnhap=0,slxuat=0 where makho in (select id from medibv.d_dmkho where nhom=d_nhom);\n";
                sql += "    open cur_ll(d_nhom);\n";
                sql += "    loop\n";
                sql += "        fetch cur_ll into d_id,d_makho,d_manguon,d_nhomcc;\n";
                sql += "        if found=false then\n";
                sql += "            exit;\n";
                sql += "        end if;\n";
                sql += "        open cur_ct(d_id);\n";
                sql += "        loop\n";
                sql += "            fetch cur_ct into d_stt,d_mabd,d_handung,d_losx,d_soluong,d_giaban,d_giamua,d_namsx,d_baohanh,d_nguongoc,d_tinhtrang,d_sothe,d_tyle_ggia,d_st_ggia;\n";
                sql += "            if found=false then\n";
                sql += "                exit;\n";
                sql += "            end if;\n";
                sql += "            update " + schema + ".d_tonkhoct set slnhap=slnhap+d_soluong where idn=d_id and sttn=d_stt and makho=d_makho;\n";
                sql += "            d_found:=1;\n";
                sql += "            if found=false then\n";
                sql += "                update medibv.d_capid set id=id+1 where ma=9;\n";
                sql += "                select to_number(to_char(now(),'yyMMdd') || trim(to_char(floor(random()*100000000000) ,'000000000000'))) into d_sttt ;\n";
                sql += "                d_found:=0;\n";
                sql += "            else\n";
                sql += "                select stt into d_sttt from " + schema + ".d_tonkhoct where idn=d_id and sttn=d_stt and makho=d_makho;\n";
                sql += "            end if;\n";
                sql += "            update " + schema + ".d_theodoi set mabd=d_mabd,manguon=d_manguon,nhomcc=d_nhomcc,handung=d_handung,losx=d_losx,sothe=d_sothe,namsx=d_namsx,baohanh=d_baohanh,nguongoc=d_nguongoc,tinhtrang=d_tinhtrang,giamua=d_giamua,giaban=d_giaban,tyle_ggia=d_tyle_ggia,st_ggia=d_st_ggia where id=d_sttt;\n";
                sql += "            if found=false then\n";
                sql += "                insert into " + schema + ".d_theodoi(id,mabd,manguon,nhomcc,handung,losx,sothe,namsx,namsd,baohanh,nguongoc,tinhtrang,giamua,giaban,tyle_ggia,st_ggia) values (d_sttt,d_mabd,d_manguon,d_nhomcc,d_handung,d_losx,d_sothe,d_namsx,d_namsx,d_baohanh,d_nguongoc,d_tinhtrang,d_giamua,d_giaban,d_tyle_ggia,d_st_ggia);\n";
                sql += "            end if;\n";
                sql += "            if d_found=0 then\n";
                sql += "                insert into " + schema + ".d_tonkhoct(makho,stt,idn,sttn,mabd,tondau,slnhap,slxuat) values (d_makho,d_sttt,d_id,d_stt,d_mabd,0,d_soluong,0);\n";
                sql += "            end if;\n";
                sql += "        end loop;\n";
                sql += "        close cur_ct;\n";
                sql += "    end loop;\n";
                sql += "    close cur_ll;\n";
                sql += "    CREATE GLOBAL TEMPORARY TABLE temp_tonkhoct ( \n";//linh 04102012
                sql += "    makho numeric(3) default 0,sttt numeric(25) default 0, mabd numeric(7), tondau numeric(12,4), slnhap numeric(12,4), slxuat numeric(12,4))WITH OIDS ON COMMIT PRESERVE ROWS TABLESPACE medi_data;\n";
                sql += "    truncate table temp_tonkhoct;\n";
                sql += "    insert into temp_tonkhoct(makho,mabd,sttt,slxuat,slnhap)\n";
                sql += "        select a.khox as makho,b.mabd,b.sttt,sum(soluong) as slxuat, 0 as slnhap from " + schema + ".d_xuatll a," + schema + ".d_xuatct b," + schema + ".d_theodoi c where a.id=b.id and b.sttt=c.id and a.nhom=d_nhom and a.loai in('BS','CK','XK','VA','XC') group by a.khox,b.mabd,b.sttt;\n";
                sql += "    insert into temp_tonkhoct(makho,mabd,sttt,slxuat,slnhap)\n";
                sql += "        select a.khon as makho,b.mabd,b.sttt,0 as slxuat,sum(soluong) as slnhap from " + schema + ".d_xuatll a," + schema + ".d_xuatct b," + schema + ".d_theodoi c where a.id=b.id  and b.sttt=c.id and a.nhom=d_nhom and a.loai in('CK','TH','HT','NC') group by a.khon,b.mabd,b.sttt;\n";
                sql += "    insert into temp_tonkhoct(makho,mabd,sttt,slxuat,slnhap)\n";
                sql += "        select b.makho,b.mabd,b.sttt,sum(soluong) as slxuat,0 as slnhap from " + schema + ".d_ngtrull a," + schema + ".d_ngtruct b," + schema + ".d_theodoi c where a.id=b.id and b.sttt=c.id  and a.nhom=d_nhom  group by b.makho,b.mabd,b.sttt;\n";
                sql += "    insert into temp_tonkhoct(makho,mabd,sttt,slxuat,slnhap)\n";
                sql += "        select b.makho,b.mabd,b.sttt,sum(soluong) as slxuat,0 as slnhap from " + schema + ".bhytkb a," + schema + ".bhytthuoc b," + schema + ".d_theodoi c where a.id=b.id and b.sttt=c.id  and a.nhom=d_nhom  group by b.makho,b.mabd,b.sttt;\n";
                sql += "    insert into temp_tonkhoct(makho,mabd,sttt,slxuat,slnhap)\n";
                sql += "        select b.makho,b.mabd,b.sttt,sum(soluong) as slxuat,0 as slnhap from " + schema + ".d_xuatsdll a," + schema + ".d_thucxuat b," + schema + ".d_theodoi c where a.id=b.id and b.sttt=c.id  and a.nhom=d_nhom  and loai not in(2,3) group by b.makho,b.mabd,b.sttt;\n";
                sql += "    insert into temp_tonkhoct(makho,mabd,sttt,slxuat,slnhap)\n";
                sql += "        select b.makho,b.mabd,b.sttt,0 as slxuat,sum(soluong) as slnhap from " + schema + ".d_xuatsdll a," + schema + ".d_thucxuat b," + schema + ".d_theodoi c where a.id=b.id  and b.sttt=c.id and a.nhom=d_nhom  and loai in(3) group by b.makho,b.mabd,b.sttt;\n";
                sql += "    insert into temp_tonkhoct(makho,mabd,sttt,slxuat,slnhap)\n";
                sql += "        select b.makho,b.mabd,b.sttt,sum(soluong) as slxuat,0 as slnhap from " + schema + ".d_xuatsdll a," + schema + ".d_thucbucstt b," + schema + ".d_theodoi c where a.id=b.id and b.sttt=c.id  and a.nhom=d_nhom  and loai in(2) group by b.makho,b.mabd,b.sttt;\n";
                sql += "    insert into temp_tonkhoct(makho,mabd,sttt,slxuat,slnhap)\n";
                sql += "        select b.makho,b.mabd,b.sttt,sum(soluong) as slxuat,0 as slnhap from " + schema + ".d_chuyenll a," + schema + ".d_chuyenct b," + schema + ".d_theodoi c where a.id=b.id and b.sttt=c.id  and a.nhom=d_nhom  group by b.makho,b.mabd,b.sttt;\n";
                sql += "    insert into temp_tonkhoct(makho,mabd,sttt,slxuat,slnhap)\n";
                sql += "        select b.makho,b.mabd,b.stttchuyen sttt,0 as slxuat,sum(soluong) as slnhap from " + schema + ".d_chuyenll a," + schema + ".d_chuyenct b," + schema + ".d_theodoi c where a.id=b.id and b.stttchuyen=c.id  and a.nhom=d_nhom  group by b.makho,b.mabd,b.stttchuyen;\n";
                sql += "    open cur_temp_tonkho(d_nhom);\n";
                sql += "        loop\n";
                sql += "            fetch cur_temp_tonkho into d_makho,d_mabd,d_sttt,d_slnhap,d_slxuat;\n";
                sql += "            if found=false then\n";
                sql += "                exit;\n";
                sql += "            end if;\n";
                //sql += "            update " + schema + ".d_tonkhoct set slnhap=slnhap+d_slnhap,slxuat=slxuat+d_slxuat where makho=d_makho and mabd=d_mabd and stt=d_sttt;\n";//Binh 22.03.2013
                sql += "            update " + schema + ".d_tonkhoct set slnhap=slnhap+d_slnhap,slxuat=slxuat+d_slxuat where makho=d_makho and stt=d_sttt;\n";// and mabd=d_mabd;\n";
                //binh them vao 11082012
                sql += "            if found=false then\n";
                sql += "                insert into " + schema + ".d_tonkhoct(makho,stt,idn,sttn,mabd,tondau,slnhap,slxuat) values (d_makho,d_sttt,0,0,d_mabd,0,d_slnhap,d_slxuat);\n";
                sql += "            end if;\n";
                //end 11082012
                sql += "        end loop;\n";
                sql += "    close cur_temp_tonkho;\n";
                sql += "    CREATE GLOBAL TEMPORARY TABLE temp_tutrucct ( \n";//linh 04102012
                sql += "        makho numeric(3) default 0,makp numeric(7),sttt numeric(25) default 0, mabd numeric(7), tondau numeric(12,4), slnhap numeric(12,4), slxuat numeric(12,4))WITH OIDS ON COMMIT PRESERVE ROWS TABLESPACE medi_data;\n";
                sql += "    truncate table temp_tutrucct;\n";
                sql += "    insert into temp_tutrucct(makp,makho,mabd,sttt,slxuat,slnhap)\n";
                sql += "        select a.khox as makp,a.khon as makho,b.mabd,b.sttt,sum(soluong) as slxuat,0 as slnhap from " + schema + ".d_xuatll a," + schema + ".d_xuatct b," + schema + ".d_theodoi c where a.id=b.id and b.sttt=c.id and a.nhom=1 and a.loai in('HT','TH')\n";
                sql += "        group by a.khox,a.khon,b.mabd,b.sttt;\n";
                sql += "    insert into temp_tutrucct(makp,makho,mabd,sttt,slxuat,slnhap)    \n";
                sql += "        select a.khon as makp,a.khox makho,b.mabd,b.sttt,0 as slxuat,sum(soluong) as slnhap from " + schema + ".d_xuatll a," + schema + ".d_xuatct b," + schema + ".d_theodoi c where a.id=b.id and b.sttt=c.id  and a.nhom=d_nhom and a.loai in('BS')\n";
                sql += "        group by a.khon,a.khox,b.mabd,b.sttt;\n";
                sql += "    insert into temp_tutrucct(makp,makho,mabd,sttt,slxuat,slnhap)\n";
                sql += "        select a.makp,b.makho,b.mabd,b.sttt,sum(soluong) as slxuat,0 as slnhap from " + schema + ".d_xuatsdll a," + schema + ".d_thucxuat b," + schema + ".d_theodoi c where a.id=b.id and b.sttt=c.id and a.nhom=d_nhom  and a.loai in(2)\n";
                sql += "        group by a.makp,b.makho,b.mabd,b.sttt;\n";
                sql += "    insert into temp_tutrucct(makp,makho,mabd,sttt,slxuat,slnhap)\n";
                sql += "        select a.makp,b.makho,b.mabd,b.sttt,0 as slxuat,sum(soluong) as slnhap from " + schema + ".d_xuatsdll a," + schema + ".d_thucbucstt b," + schema + ".d_theodoi c where a.id=b.id and b.sttt=c.id and a.nhom=d_nhom and a.loai in(2)\n";
                sql += "        group by a.makp,b.makho,b.mabd,b.sttt;\n";
                sql += "    open cur_temp_tutruc(d_nhom);\n";
                sql += "        loop\n";
                sql += "            fetch cur_temp_tutruc into d_makho,d_makp,d_mabd,d_sttt,d_slnhap,d_slxuat;\n";
                sql += "            if found=false then\n";
                sql += "                exit;\n";
                sql += "            end if;\n";
                sql += "            update " + schema + ".d_tutrucct set slnhap=slnhap+d_slnhap,slxuat=slxuat+d_slxuat where makho=d_makho and makp=d_makp and mabd=d_mabd and stt=d_sttt;\n";
                sql += "            if found=false then\n";
                sql += "                insert into " + schema + ".d_tutrucct(makp,makho,stt,mabd,tondau,slnhap,slxuat) values (d_makp,d_makho,d_sttt,d_mabd,0,d_slnhap,d_slxuat);\n";
                sql += "            end if;\n";
                sql += "        end loop;\n";
                sql += "   close cur_temp_tutruc;\n";
                sql += "   update " + schema + ".d_tutrucct set slnhap=0 where slnhap is null;\n";
                sql += "   update " + schema + ".d_tutrucct set slxuat=0 where slxuat is null;\n";
                sql += "   update " + schema + ".d_tonkhoct set slnhap=0 where slnhap is null;\n";
                sql += "   update " + schema + ".d_tonkhoct set slxuat=0 where slxuat is null;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += " LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_kiemtra_cstt(d_nhom numeric)\n";
                sql += "RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "DECLARE\n";
                sql += "    d_id numeric;d_makho numeric;d_manguon numeric;d_nhomcc numeric;d_sttt numeric;d_tyle_ggia numeric;d_st_ggia numeric;\n";
                sql += "    d_stt numeric;d_mabd numeric;d_handung varchar;d_losx varchar;d_soluong numeric;d_giaban numeric;d_giamua numeric;\n";
                sql += "    d_loai varchar;d_khox numeric;d_khon numeric;d_thuoc numeric;i_loai numeric;d_makp numeric;d_theodoi numeric;\n";
                sql += "    d_stttchuyen numeric;d_namsx varchar;d_baohanh numeric;d_nguongoc numeric;d_tinhtrang numeric;d_sothe varchar;d_found numeric;\n";
                sql += "    cur_xuatll cursor (p_nhom numeric) is select id,loai,khox,khon from " + schema + ".d_xuatll where nhom=p_nhom and loai='BS';\n";
                sql += "    cur_xuatct cursor (p_id numeric) is select stt,sttt,mabd,soluong from " + schema + ".d_xuatct where id=p_id;\n";
                sql += "    cur_sdll cursor (p_nhom numeric) is select id,makp,loai,thuoc from " + schema + ".d_xuatsdll where nhom=p_nhom and loai=4;\n";
                sql += "    cur_xuat cursor (p_id numeric) is select a.sttt,a.makho,a.mabd,a.soluong,c.theodoi from " + schema + ".d_thucxuat a," + user + ".d_dmbd b," + user + ".d_dmnhom c where a.mabd=b.id and b.manhom=c.id and a.id=p_id;\n";
                sql += "    cur_sdbu cursor (p_nhom numeric) is select id,makp,loai,thuoc from " + schema + ".d_xuatsdll where loai=2 and nhom=p_nhom;\n";
                sql += "    cur_bu cursor (p_id numeric) is select sttt,makho,mabd,soluong from " + schema + ".d_thucbucstt where id=p_id;\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_tutrucct set slnhap=0 where makho in (select id from " + user + ".d_dmkho where nhom=d_nhom);\n";
                sql += "    open cur_xuatll(d_nhom);\n";
                sql += "    loop\n";
                sql += "        fetch cur_xuatll into d_id,d_loai,d_khox,d_khon;\n";
                sql += "        if found=false then\n";
                sql += "            exit;\n";
                sql += "        end if;\n";
                sql += "        open cur_xuatct(d_id);\n";
                sql += "        loop\n";
                sql += "            fetch cur_xuatct into d_stt,d_sttt,d_mabd,d_soluong;\n";
                sql += "            if found=false then\n";
                sql += "                exit;\n";
                sql += "            end if;\n";
                sql += "            if d_loai='BS' then\n";
                sql += "                update " + schema + ".d_tutrucct set slnhap=slnhap+d_soluong where makp=d_khon and makho=d_khox and stt=d_sttt;\n";
                sql += "                if found=false then\n";
                sql += "	                insert into " + schema + ".d_tutrucct(makp,makho,stt,mabd,tondau,slnhap,slxuat) values (d_khon,d_khox,d_sttt,d_mabd,0,d_soluong,0);\n";
                sql += "                end if;\n";
                sql += "            end if;\n";
                sql += "        end loop;\n";
                sql += "        close cur_xuatct;\n";
                sql += "    end loop;\n";
                sql += "    close cur_xuatll;\n";
                sql += "    open cur_sdll(d_nhom);\n";
                sql += "    loop\n";
                sql += "        fetch cur_sdll into d_id,d_makp,i_loai,d_thuoc;\n";
                sql += "        if found=false then\n";
                sql += "            exit;\n";
                sql += "        end if;\n";
                sql += "        open cur_xuat(d_id);\n";
                sql += "        loop\n";
                sql += "            fetch cur_xuat into d_sttt,d_makho,d_mabd,d_soluong,d_theodoi;\n";
                sql += "            if found=false then\n";
                sql += "                exit;\n";
                sql += "            end if;\n";
                sql += "            if d_theodoi=1 then\n";
                sql += "                if i_loai=4 then\n";
                sql += "	                update " + schema + ".d_tutrucct set slnhap=slnhap+d_soluong where makp=d_makp and makho=d_makho and stt=d_sttt;\n";
                sql += "	                if found=false then\n";
                sql += "		                insert into " + schema + ".d_tutrucct(makp,makho,stt,mabd,tondau,slnhap,slxuat) values (d_makp,d_makho,d_sttt,d_mabd,0,d_soluong,0);\n";
                sql += "	                end if;\n";
                sql += "                end if;\n";
                sql += "            end if;\n";
                sql += "        end loop;\n";
                sql += "        close cur_xuat;\n";
                sql += "    end loop;\n";
                sql += "    close cur_sdll;\n";
                sql += "    open cur_sdbu(d_nhom);\n";
                sql += "    loop\n";
                sql += "        fetch cur_sdbu into d_id,d_makp,i_loai,d_thuoc;\n";
                sql += "        if found=false then\n";
                sql += "            exit;\n";
                sql += "        end if;\n";
                sql += "        open cur_bu(d_id);\n";
                sql += "        loop\n";
                sql += "            fetch cur_bu into d_sttt,d_makho,d_mabd,d_soluong;\n";
                sql += "            if found=false then\n";
                sql += "                exit;\n";
                sql += "            end if;\n";
                sql += "            update " + schema + ".d_tutrucct set slnhap=slnhap+d_soluong where makp=d_makp and makho=d_makho and stt=d_sttt;\n";
                sql += "            if found=false then\n";
                sql += "                insert into " + schema + ".d_tutrucct(makp,makho,stt,mabd,tondau,slnhap,slxuat) values(d_makp,d_makho,d_sttt,d_mabd,0,d_soluong,0);\n";
                sql += "            end if;\n";
                sql += "        end loop;\n";
                sql += "    close cur_bu;\n";
                sql += "    end loop;\n";
                sql += "    close cur_sdbu;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += " LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_theodoi(d_id numeric,d_mabd numeric,d_manguon numeric,d_nhomcc numeric,d_handung varchar,d_losx varchar,d_sothe varchar,d_namsx varchar,d_namsd varchar,d_baohanh numeric,d_nguongoc numeric,d_tinhtrang numeric,d_giamua numeric,d_giaban numeric,d_chietkhau numeric,d_giaban2 numeric,d_gianovat numeric,d_tyle_ggia numeric,d_st_ggia numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_theodoi set mabd=d_mabd,manguon=d_manguon,nhomcc=d_nhomcc,handung=d_handung,losx=d_losx,sothe=d_sothe,namsx=d_namsx,namsd=d_namsd,baohanh=d_baohanh,nguongoc=d_nguongoc,tinhtrang=d_tinhtrang,giamua=d_giamua,giaban=d_giaban,chietkhau=d_chietkhau,giaban2=d_giaban2,gianovat=d_gianovat,tyle_ggia=d_tyle_ggia,st_ggia=d_st_ggia where id=d_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_theodoi(id,mabd,manguon,nhomcc,handung,losx,sothe,namsx,namsd,baohanh,nguongoc,tinhtrang,giamua,giaban,chietkhau,giaban2,gianovat,tyle_ggia,st_ggia) values (d_id,d_mabd,d_manguon,d_nhomcc,d_handung,d_losx,d_sothe,d_namsx,d_namsd,d_baohanh,d_nguongoc,d_tinhtrang,d_giamua,d_giaban,d_chietkhau,d_giaban2,d_gianovat,d_tyle_ggia,d_st_ggia);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_theodoi(d_id numeric,d_mabd numeric,d_manguon numeric,d_nhomcc numeric,d_handung varchar,d_losx varchar,d_sothe varchar,d_namsx varchar,d_namsd varchar,d_baohanh numeric,d_nguongoc numeric,d_tinhtrang numeric,d_giamua numeric,d_giaban numeric,d_chietkhau numeric,d_gianovat numeric,d_tyle_ggia numeric,d_st_ggia numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_theodoi set mabd=d_mabd,manguon=d_manguon,nhomcc=d_nhomcc,handung=d_handung,losx=d_losx,sothe=d_sothe,namsx=d_namsx,namsd=d_namsd,baohanh=d_baohanh,nguongoc=d_nguongoc,tinhtrang=d_tinhtrang,giamua=d_giamua,giaban=d_giaban,chietkhau=d_chietkhau,gianovat=d_gianovat,tyle_ggia=d_tyle_ggia,st_ggia=d_st_ggia where id=d_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_theodoi(id,mabd,manguon,nhomcc,handung,losx,sothe,namsx,namsd,baohanh,nguongoc,tinhtrang,giamua,giaban,chietkhau,gianovat,tyle_ggia,st_ggia) values (d_id,d_mabd,d_manguon,d_nhomcc,d_handung,d_losx,d_sothe,d_namsx,d_namsd,d_baohanh,d_nguongoc,d_tinhtrang,d_giamua,d_giaban,d_chietkhau,d_gianovat,d_tyle_ggia,d_st_ggia);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_theodoi(d_id numeric,d_mabd numeric,d_manguon numeric,d_nhomcc numeric,d_handung varchar,d_losx varchar,d_sothe varchar,d_namsx varchar,d_namsd varchar,d_baohanh numeric,d_nguongoc numeric,d_tinhtrang numeric,d_giamua numeric,d_giaban numeric,d_gianovat numeric,d_tyle_ggia numeric,d_st_ggia numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_theodoi set mabd=d_mabd,manguon=d_manguon,nhomcc=d_nhomcc,handung=d_handung,losx=d_losx,sothe=d_sothe,namsx=d_namsx,namsd=d_namsd,baohanh=d_baohanh,nguongoc=d_nguongoc,tinhtrang=d_tinhtrang,giamua=d_giamua,giaban=d_giaban,gianovat=d_gianovat,tyle_ggia=d_tyle_ggia,st_ggia=d_st_ggia where id=d_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_theodoi(id,mabd,manguon,nhomcc,handung,losx,sothe,namsx,namsd,baohanh,nguongoc,tinhtrang,giamua,giaban,gianovat,tyle_ggia,st_ggia) values (d_id,d_mabd,d_manguon,d_nhomcc,d_handung,d_losx,d_sothe,d_namsx,d_namsd,d_baohanh,d_nguongoc,d_tinhtrang,d_giamua,d_giaban,d_gianovat,d_tyle_ggia,d_st_ggia);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_tonkho(d_nhom numeric,d_loai numeric)\n";
                sql += " RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "DECLARE\n";
                sql += "   d_makp numeric;d_makho numeric;d_mabd numeric;d_tondau numeric;d_slnhap numeric;d_slxuat numeric;d_manguon numeric;\n";
                sql += "   cur_tonkho cursor (p_nhom numeric) is select a.makho,a.mabd,sum(a.tondau) as tondau,sum(a.slnhap) as slnhap,sum(a.slxuat) as slxuat,b.manguon from " + schema + ".d_tonkhoct a," + schema + ".d_theodoi b where a.stt=b.id and a.makho in (select id from " + user + ".d_dmkho where nhom=p_nhom) group by a.makho,a.mabd,b.manguon;\n";
                sql += "   cur_tutruc cursor (p_nhom numeric) is select a.makp,a.makho,a.mabd,sum(a.tondau) as tondau,sum(a.slnhap) as slnhap,sum(a.slxuat) as slxuat,b.manguon from " + schema + ".d_tutrucct a," + schema + ".d_theodoi b where a.stt=b.id and a.makho in (select id from " + user + ".d_dmkho where nhom=p_nhom) group by a.makp,a.makho,a.mabd,b.manguon;\n";
                sql += "begin\n";
                sql += "    if d_loai=0 or d_loai=1 then\n";
                sql += "        update " + schema + ".d_tonkhoth set tondau=0,slnhap=0,slxuat=0 where makho in (select id from " + user + ".d_dmkho where nhom=d_nhom);\n";
                sql += "        open cur_tonkho(d_nhom);\n";
                sql += "        loop\n";
                sql += "            fetch cur_tonkho into d_makho,d_mabd,d_tondau,d_slnhap,d_slxuat,d_manguon;\n";
                sql += "            if found=false then\n";
                sql += "                exit;\n";
                sql += "            end if;\n";
                sql += "            update " + schema + ".d_tonkhoth set tondau=tondau+d_tondau,slnhap=slnhap+d_slnhap,slxuat=slxuat+d_slxuat where makho=d_makho and mabd=d_mabd and manguon=d_manguon;\n";
                sql += "            if found=false then\n";
                sql += "                  insert into " + schema + ".d_tonkhoth(makho,mabd,tondau,slnhap,slxuat,manguon) values (d_makho,d_mabd,d_tondau,d_slnhap,d_slxuat,d_manguon);\n";
                sql += "            end if;\n";
                sql += "        end loop;\n";
                sql += "        close cur_tonkho;\n";
                sql += "    end if;\n";
                sql += "    if d_loai=0 or d_loai=2 then\n";
                sql += "        update " + schema + ".d_tutructh set tondau=0,slnhap=0,slxuat=0 where makho in (select id from " + user + ".d_dmkho where nhom=d_nhom);\n";
                sql += "        open cur_tutruc(d_nhom);\n";
                sql += "        loop\n";
                sql += "            fetch cur_tutruc into d_makp,d_makho,d_mabd,d_tondau,d_slnhap,d_slxuat,d_manguon;\n";
                sql += "            if found=false then\n";
                sql += "                exit;\n";
                sql += "            end if;\n";
                sql += "            update " + schema + ".d_tutructh set tondau=tondau+d_tondau,slnhap=slnhap+d_slnhap,slxuat=slxuat+d_slxuat where makp=d_makp and makho=d_makho and mabd=d_mabd and manguon=d_manguon;\n";
                sql += "            if found=false then\n";
                sql += "                insert into " + schema + ".d_tutructh(makp,makho,mabd,tondau,slnhap,slxuat,manguon) values (d_makp,d_makho,d_mabd,d_tondau,d_slnhap,d_slxuat,d_manguon);\n";
                sql += "            end if;\n";
                sql += "        end loop;\n";
                sql += "        close cur_tutruc;\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_tonkho(d_makho numeric)\n";
                sql += " RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "DECLARE\n";
                sql += "   d_mabd numeric;d_tondau numeric;d_slnhap numeric;d_slxuat numeric;d_manguon numeric;\n";
                sql += "   cur_tonkho cursor(p_makho numeric) is select a.mabd,sum(a.tondau) as tondau,sum(a.slnhap) as slnhap,sum(a.slxuat) as slxuat,b.manguon from " + schema + ".d_tonkhoct a," + schema + ".d_theodoi b where a.stt=b.id and a.makho=p_makho group by a.mabd,b.manguon;\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_tonkhoth set tondau=0,slnhap=0,slxuat=0 where makho=d_makho;\n";
                sql += "    open cur_tonkho(d_makho);\n";
                sql += "    loop\n";
                sql += "        fetch cur_tonkho into d_mabd,d_tondau,d_slnhap,d_slxuat,d_manguon;\n";
                sql += "        if found=false then\n";
                sql += "            exit;\n";
                sql += "        end if;\n";
                sql += "        update " + schema + ".d_tonkhoth set tondau=tondau+d_tondau,slnhap=slnhap+d_slnhap,slxuat=slxuat+d_slxuat where makho=d_makho and mabd=d_mabd and manguon=d_manguon;\n";
                sql += "        if found=false then\n";
                sql += "              insert into " + schema + ".d_tonkhoth(makho,mabd,tondau,slnhap,slxuat,manguon) values (d_makho,d_mabd,d_tondau,d_slnhap,d_slxuat,d_manguon);\n";
                sql += "        end if;\n";
                sql += "    end loop;\n";
                sql += "    close cur_tonkho;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_tonkhoct(d_makho numeric,d_stt numeric,d_mabd numeric,d_tondau numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_tonkhoct set mabd=d_mabd,tondau=d_tondau where makho=d_makho and stt=d_stt;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_tonkhoct(makho,stt,idn,sttn,mabd,tondau,slnhap,slxuat) values (d_makho,d_stt,0,0,d_mabd,d_tondau,0,0);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_tutrucct(d_makp numeric,d_makho numeric,d_stt numeric,d_mabd numeric,d_tondau numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_tutrucct set mabd=d_mabd,tondau=d_tondau where makp=d_makp and makho=d_makho and stt=d_stt;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_tutrucct(makp,makho,stt,mabd,tondau,slnhap,slxuat) values (d_makp,d_makho,d_stt,d_mabd,d_tondau,0,0);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_nhapll(d_id numeric,d_nhom numeric,d_sophieu varchar,d_ngaysp varchar,d_sohd text,d_ngayhd varchar,d_bbkiem varchar,d_ngaykiem varchar,d_loai varchar,d_nguoigiao text,d_madv numeric,d_makho numeric,d_manguon numeric,d_nhomcc numeric,d_no text,d_co varchar,d_userid numeric,d_lydo numeric,d_chietkhau numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_nhapll set nhom=d_nhom,sophieu=d_sophieu,ngaysp=to_timestamp(d_ngaysp,'dd/mm/yyyy'),sohd=d_sohd,ngayhd=to_timestamp(d_ngayhd,'dd/mm/yyyy'),bbkiem=d_bbkiem,ngaykiem=null,loai=d_loai,nguoigiao=d_nguoigiao,madv=d_madv,makho=d_makho,manguon=d_manguon,nhomcc=d_nhomcc,no=d_no,co=d_co,userid=d_userid,lydo=d_lydo,chietkhau=d_chietkhau where id=d_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_nhapll(id,nhom,sophieu,ngaysp,sohd,ngayhd,bbkiem,ngaykiem,loai,nguoigiao,madv,makho,manguon,nhomcc,no,co,userid,lydo,chietkhau) values (d_id,d_nhom,d_sophieu,to_timestamp(d_ngaysp,'dd/mm/yyyy'),d_sohd,to_timestamp(d_ngayhd,'dd/mm/yyyy'),d_bbkiem,null,d_loai,d_nguoigiao,d_madv,d_makho,d_manguon,d_nhomcc,d_no,d_co,d_userid,d_lydo,d_chietkhau);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_nhapll_kk(d_id numeric,d_nhom numeric,d_sophieu varchar,d_ngaysp varchar,d_sohd text,d_ngayhd varchar,d_bbkiem varchar,d_ngaykiem varchar,d_loai varchar,d_nguoigiao text,d_madv numeric,d_makho numeric,d_manguon numeric,d_nhomcc numeric,d_no text,d_co varchar,d_userid numeric,d_lydo numeric,d_chietkhau numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_nhapll set nhom=d_nhom,sophieu=d_sophieu,ngaysp=to_timestamp(d_ngaysp,'dd/mm/yyyy'),sohd=d_sohd,ngayhd=to_timestamp(d_ngayhd,'dd/mm/yyyy'),bbkiem=d_bbkiem,ngaykiem=to_timestamp(d_ngaykiem,'dd/mm/yyyy'),loai=d_loai,nguoigiao=d_nguoigiao,madv=d_madv,makho=d_makho,manguon=d_manguon,nhomcc=d_nhomcc,no=d_no,co=d_co,userid=d_userid,lydo=d_lydo,chietkhau=d_chietkhau where id=d_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_nhapll(id,nhom,sophieu,ngaysp,sohd,ngayhd,bbkiem,ngaykiem,loai,nguoigiao,madv,makho,manguon,nhomcc,no,co,userid,lydo,chietkhau) values (d_id,d_nhom,d_sophieu,to_timestamp(d_ngaysp,'dd/mm/yyyy'),d_sohd,to_timestamp(d_ngayhd,'dd/mm/yyyy'),d_bbkiem,to_timestamp(d_ngaykiem,'dd/mm/yyyy'),d_loai,d_nguoigiao,d_madv,d_makho,d_manguon,d_nhomcc,d_no,d_co,d_userid,d_lydo,d_chietkhau);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_nhapct(d_id numeric,d_stt numeric,d_mabd numeric,d_handung varchar,d_losx varchar,d_vat numeric,d_soluong numeric,d_dongia numeric,d_sotien numeric,d_giaban numeric,d_giamua numeric,d_sl1 numeric,d_sl2 numeric,d_tyle numeric,d_cuocvc numeric,d_chaythu numeric,d_namsx varchar,d_tailieu text,d_baohanh numeric,d_nguongoc numeric,d_tinhtrang numeric,d_sothe varchar,d_giabancu numeric,d_tyle_ggia numeric,d_st_ggia numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_nhapct set mabd=d_mabd,handung=d_handung,losx=d_losx,vat=d_vat,soluong=d_soluong,dongia=d_dongia,sotien=d_sotien,giaban=d_giaban,giamua=d_giamua,sl1=d_sl1,sl2=d_sl2,tyle=d_tyle,cuocvc=d_cuocvc,chaythu=d_chaythu,namsx=d_namsx,tailieu=d_tailieu,baohanh=d_baohanh,nguongoc=d_nguongoc,tinhtrang=d_tinhtrang,sothe=d_sothe,giabancu=d_giabancu,tyle_ggia=d_tyle_ggia,st_ggia=d_st_ggia where id=d_id and stt=d_stt;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_nhapct(id,stt,mabd,handung,losx,vat,soluong,dongia,sotien,giaban,giamua,sl1,sl2,tyle,cuocvc,chaythu,namsx,tailieu,baohanh,nguongoc,tinhtrang,sothe,giabancu,tyle_ggia,st_ggia) values (d_id,d_stt,d_mabd,d_handung,d_losx,d_vat,d_soluong,d_dongia,d_sotien,d_giaban,d_giamua,d_sl1,d_sl2,d_tyle,d_cuocvc,d_chaythu,d_namsx,d_tailieu,d_baohanh,d_nguongoc,d_tinhtrang,d_sothe,d_giabancu,d_tyle_ggia,d_st_ggia);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_nhapct(d_id numeric,d_stt numeric,d_mabd numeric,d_handung varchar,d_losx varchar,d_vat numeric,d_soluong numeric,d_dongia numeric,d_sotien numeric,d_giaban numeric,d_giamua numeric,d_sl1 numeric,d_sl2 numeric,d_tyle numeric,d_cuocvc numeric,d_chaythu numeric,d_namsx varchar,d_tailieu text,d_baohanh numeric,d_nguongoc numeric,d_tinhtrang numeric,d_sothe varchar,d_giabancu numeric,d_giamuacu numeric,d_tyle_ggia numeric,d_st_ggia numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_nhapct set mabd=d_mabd,handung=d_handung,losx=d_losx,vat=d_vat,soluong=d_soluong,dongia=d_dongia,sotien=d_sotien,giaban=d_giaban,giamua=d_giamua,sl1=d_sl1,sl2=d_sl2,tyle=d_tyle,cuocvc=d_cuocvc,chaythu=d_chaythu,namsx=d_namsx,tailieu=d_tailieu,baohanh=d_baohanh,nguongoc=d_nguongoc,tinhtrang=d_tinhtrang,sothe=d_sothe,giabancu=d_giabancu,giamuacu=d_giamuacu,tyle_ggia=d_tyle_ggia,st_ggia=d_st_ggia where id=d_id and stt=d_stt;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_nhapct(id,stt,mabd,handung,losx,vat,soluong,dongia,sotien,giaban,giamua,sl1,sl2,tyle,cuocvc,chaythu,namsx,tailieu,baohanh,nguongoc,tinhtrang,sothe,giabancu,giamuacu,tyle_ggia,st_ggia) values (d_id,d_stt,d_mabd,d_handung,d_losx,d_vat,d_soluong,d_dongia,d_sotien,d_giaban,d_giamua,d_sl1,d_sl2,d_tyle,d_cuocvc,d_chaythu,d_namsx,d_tailieu,d_baohanh,d_nguongoc,d_tinhtrang,d_sothe,d_giabancu,d_giamuacu,d_tyle_ggia,d_st_ggia);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_nhapct(d_id numeric,d_stt numeric,d_mabd numeric,d_handung varchar,d_losx varchar,d_vat numeric,d_soluong numeric,d_dongia numeric,d_sotien numeric,d_giaban numeric,d_giamua numeric,d_sl1 numeric,d_sl2 numeric,d_tyle numeric,d_cuocvc numeric,d_chaythu numeric,d_namsx varchar,d_tailieu text,d_baohanh numeric,d_nguongoc numeric,d_tinhtrang numeric,d_sothe varchar,d_giabancu numeric,d_giamuacu numeric,d_giaban2 numeric,d_tyle2 numeric,d_tyle_ggia numeric,d_st_ggia numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_nhapct set mabd=d_mabd,handung=d_handung,losx=d_losx,vat=d_vat,soluong=d_soluong,dongia=d_dongia,sotien=d_sotien,giaban=d_giaban,giamua=d_giamua,sl1=d_sl1,sl2=d_sl2,tyle=d_tyle,cuocvc=d_cuocvc,chaythu=d_chaythu,namsx=d_namsx,tailieu=d_tailieu,baohanh=d_baohanh,nguongoc=d_nguongoc,tinhtrang=d_tinhtrang,sothe=d_sothe,giabancu=d_giabancu,giamuacu=d_giamuacu,giaban2=d_giaban2,tyle2=d_tyle2,tyle_ggia=d_tyle_ggia,st_ggia=d_st_ggia where id=d_id and stt=d_stt;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_nhapct(id,stt,mabd,handung,losx,vat,soluong,dongia,sotien,giaban,giamua,sl1,sl2,tyle,cuocvc,chaythu,namsx,tailieu,baohanh,nguongoc,tinhtrang,sothe,giabancu,giamuacu,giaban2,tyle2,tyle_ggia,st_ggia) values (d_id,d_stt,d_mabd,d_handung,d_losx,d_vat,d_soluong,d_dongia,d_sotien,d_giaban,d_giamua,d_sl1,d_sl2,d_tyle,d_cuocvc,d_chaythu,d_namsx,d_tailieu,d_baohanh,d_nguongoc,d_tinhtrang,d_sothe,d_giabancu,d_giamuacu,d_giaban2,d_tyle2,d_tyle_ggia,d_st_ggia);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_nhapct2(d_id numeric,d_stt numeric,d_mabd numeric,d_soluong numeric,d_sotien numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_nhapct2 set mabd=d_mabd,soluong=d_soluong,sotien=d_sotien where id=d_id and stt=d_stt;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_nhapct2(id,stt,mabd,soluong,sotien) values (d_id,d_stt,d_mabd,d_soluong,d_sotien);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_nhapbbll(d_id numeric,d_nhom numeric,d_sophieu varchar,d_ngaysp varchar,d_sohd text,d_ngayhd varchar,d_bbkiem varchar,d_ngaykiem varchar,d_loai varchar,d_nguoigiao text,d_madv numeric,d_makho numeric,d_manguon numeric,d_nhomcc numeric,d_no text,d_co varchar,d_userid numeric,d_lydo numeric,d_chietkhau numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_nhapbbll set nhom=d_nhom,sophieu=d_sophieu,ngaysp=to_timestamp(d_ngaysp,'dd/mm/yyyy'),sohd=d_sohd,ngayhd=to_timestamp(d_ngayhd,'dd/mm/yyyy'),bbkiem=d_bbkiem,ngaykiem=null,loai=d_loai,nguoigiao=d_nguoigiao,madv=d_madv,makho=d_makho,manguon=d_manguon,nhomcc=d_nhomcc,no=d_no,co=d_co,userid=d_userid,lydo=d_lydo,chietkhau=d_chietkhau where id=d_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_nhapbbll(id,nhom,sophieu,ngaysp,sohd,ngayhd,bbkiem,ngaykiem,loai,nguoigiao,madv,makho,manguon,nhomcc,no,co,userid,lydo,chietkhau) values (d_id,d_nhom,d_sophieu,to_timestamp(d_ngaysp,'dd/mm/yyyy'),d_sohd,to_timestamp(d_ngayhd,'dd/mm/yyyy'),d_bbkiem,null,d_loai,d_nguoigiao,d_madv,d_makho,d_manguon,d_nhomcc,d_no,d_co,d_userid,d_lydo,d_chietkhau);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_nhapbbll_kk(d_id numeric,d_nhom numeric,d_sophieu varchar,d_ngaysp varchar,d_sohd text,d_ngayhd varchar,d_bbkiem varchar,d_ngaykiem varchar,d_loai varchar,d_nguoigiao text,d_madv numeric,d_makho numeric,d_manguon numeric,d_nhomcc numeric,d_no text,d_co varchar,d_userid numeric,d_lydo numeric,d_chietkhau numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_nhapbbll set nhom=d_nhom,sophieu=d_sophieu,ngaysp=to_timestamp(d_ngaysp,'dd/mm/yyyy'),sohd=d_sohd,ngayhd=to_timestamp(d_ngayhd,'dd/mm/yyyy'),bbkiem=d_bbkiem,ngaykiem=to_timestamp(d_ngaykiem,'dd/mm/yyyy'),loai=d_loai,nguoigiao=d_nguoigiao,madv=d_madv,makho=d_makho,manguon=d_manguon,nhomcc=d_nhomcc,no=d_no,co=d_co,userid=d_userid,lydo=d_lydo,chietkhau=d_chietkhau where id=d_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_nhapbbll(id,nhom,sophieu,ngaysp,sohd,ngayhd,bbkiem,ngaykiem,loai,nguoigiao,madv,makho,manguon,nhomcc,no,co,userid,lydo,chietkhau) values (d_id,d_nhom,d_sophieu,to_timestamp(d_ngaysp,'dd/mm/yyyy'),d_sohd,to_timestamp(d_ngayhd,'dd/mm/yyyy'),d_bbkiem,to_timestamp(d_ngaykiem,'dd/mm/yyyy'),d_loai,d_nguoigiao,d_madv,d_makho,d_manguon,d_nhomcc,d_no,d_co,d_userid,d_lydo,d_chietkhau);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_nhapbbct(d_id numeric,d_stt numeric,d_mabd numeric,d_handung varchar,d_losx varchar,d_vat numeric,d_soluong numeric,d_dongia numeric,d_sotien numeric,d_giaban numeric,d_giamua numeric,d_sl1 numeric,d_sl2 numeric,d_tyle numeric,d_cuocvc numeric,d_chaythu numeric,d_namsx varchar,d_tailieu text,d_baohanh numeric,d_nguongoc numeric,d_tinhtrang numeric,d_sothe varchar,d_giabancu numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_nhapbbct set mabd=d_mabd,handung=d_handung,losx=d_losx,vat=d_vat,soluong=d_soluong,dongia=d_dongia,sotien=d_sotien,giaban=d_giaban,giamua=d_giamua,sl1=d_sl1,sl2=d_sl2,tyle=d_tyle,cuocvc=d_cuocvc,chaythu=d_chaythu,namsx=d_namsx,tailieu=d_tailieu,baohanh=d_baohanh,nguongoc=d_nguongoc,tinhtrang=d_tinhtrang,sothe=d_sothe,giabancu=d_giabancu where id=d_id and stt=d_stt;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_nhapbbct(id,stt,mabd,handung,losx,vat,soluong,dongia,sotien,giaban,giamua,sl1,sl2,tyle,cuocvc,chaythu,namsx,tailieu,baohanh,nguongoc,tinhtrang,sothe,giabancu) values (d_id,d_stt,d_mabd,d_handung,d_losx,d_vat,d_soluong,d_dongia,d_sotien,d_giaban,d_giamua,d_sl1,d_sl2,d_tyle,d_cuocvc,d_chaythu,d_namsx,d_tailieu,d_baohanh,d_nguongoc,d_tinhtrang,d_sothe,d_giabancu);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_theodoigia(d_mabd numeric,d_ngay varchar,d_dongia numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_theodoigia set dongia=d_dongia where mabd=d_mabd and to_char(ngay,'dd/mm/yyyy')=d_ngay;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_theodoigia(mabd,ngay,dongia) values (d_mabd,to_timestamp(d_ngay,'dd/mm/yyyy'),d_dongia);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_thanhtoan(d_id numeric,d_ngay varchar,d_no varchar,d_co varchar,d_datra numeric,d_userid numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_thanhtoan set ngay=to_timestamp(d_ngay,'dd/mm/yyyy'),no=d_no,co=d_co,datra=d_datra,userid=d_userid where id=d_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_thanhtoan(id,ngay,no,co,sotien,datra,userid) values (d_id,to_timestamp(d_ngay,'dd/mm/yyyy'),d_no,d_co,0,d_datra,d_userid);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_nhapslll(d_id numeric,d_nhom numeric,d_sophieu varchar,d_ngaysp varchar,d_sohd text,d_ngayhd varchar,d_loai varchar,d_nguoigiao text,d_madv numeric,d_makho numeric,d_userid numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_nhapslll set nhom=d_nhom,sophieu=d_sophieu,ngaysp=to_timestamp(d_ngaysp,'dd/mm/yyyy'),sohd=d_sohd,ngayhd=to_timestamp(d_ngayhd,'dd/mm/yyyy'),loai=d_loai,madv=d_madv,makho=d_makho,userid=d_userid where id=d_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_nhapslll(id,nhom,sophieu,ngaysp,sohd,ngayhd,loai,nguoigiao,madv,makho,userid) values (d_id,d_nhom,d_sophieu,to_timestamp(d_ngaysp,'dd/mm/yyyy'),d_sohd,to_timestamp(d_ngayhd,'dd/mm/yyyy'),d_loai,d_nguoigiao,d_madv,d_makho,d_userid);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_nhapslct(d_id numeric,d_stt numeric,d_mabd numeric,d_handung varchar,d_losx varchar,d_soluong numeric,d_sl1 numeric,d_sl2 numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_nhapslct set mabd=d_mabd,handung=d_handung,losx=d_losx,soluong=d_soluong,sl1=d_sl1,sl2=d_sl2 where id=d_id and stt=d_stt;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_nhapslct(id,stt,mabd,handung,losx,soluong,sl1,sl2) values (d_id,d_stt,d_mabd,d_handung,d_losx,d_soluong,d_sl1,d_sl2);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_xuatll(d_id numeric,d_nhom numeric,d_sophieu varchar,d_ngay varchar,d_loai varchar,d_khox numeric,d_khon numeric,d_lydo text,d_userid numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_xuatll set nhom=d_nhom,sophieu=d_sophieu,ngay=to_timestamp(d_ngay,'dd/mm/yyyy'),loai=d_loai,khox=d_khox,khon=d_khon,lydo=d_lydo,userid=d_userid where id=d_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_xuatll(id,nhom,sophieu,ngay,loai,khox,khon,lydo,userid) values (d_id,d_nhom,d_sophieu,to_timestamp(d_ngay,'dd/mm/yyyy'),d_loai,d_khox,d_khon,d_lydo,d_userid);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_xuatll(d_id numeric,d_nhom numeric,d_sophieu varchar,d_ngay varchar,d_loai varchar,d_khox numeric,d_khon numeric,d_lydo text,d_userid numeric,d_idduyet numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_xuatll set nhom=d_nhom,sophieu=d_sophieu,ngay=to_timestamp(d_ngay,'dd/mm/yyyy'),loai=d_loai,khox=d_khox,khon=d_khon,lydo=d_lydo,userid=d_userid,idduyet=d_idduyet where id=d_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_xuatll(id,nhom,sophieu,ngay,loai,khox,khon,lydo,userid,idduyet) values (d_id,d_nhom,d_sophieu,to_timestamp(d_ngay,'dd/mm/yyyy'),d_loai,d_khox,d_khon,d_lydo,d_userid,d_idduyet);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_xuatct(d_id numeric,d_stt numeric,d_sttt numeric,d_mabd numeric,d_soluong numeric,d_mabs varchar,d_hotenbn text,d_giaban numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_xuatct set sttt=d_sttt,mabd=d_mabd,soluong=d_soluong,mabs=d_mabs,hotenbn=d_hotenbn,giaban=d_giaban where id=d_id and stt=d_stt;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_xuatct(id,stt,sttt,mabd,soluong,mabs,hotenbn,giaban) values (d_id,d_stt,d_sttt,d_mabd,d_soluong,d_mabs,d_hotenbn,d_giaban);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_dutrucapll(d_id numeric,d_nhom numeric,d_sophieu varchar,d_ngay varchar,d_loai varchar,d_khox numeric,d_khon numeric,d_userid numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_dutrucapll set nhom=d_nhom,sophieu=d_sophieu,loai=d_loai,ngay=to_timestamp(d_ngay,'dd/mm/yyyy'),khox=d_khox,khon=d_khon,userid=d_userid where id=d_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_dutrucapll(id,nhom,sophieu,ngay,loai,khox,khon,userid) values (d_id,d_nhom,d_sophieu,to_timestamp(d_ngay,'dd/mm/yyyy'),d_loai,d_khox,d_khon,d_userid);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_dutrucapct(d_id numeric,d_manguon numeric,d_mabd numeric,d_slyeucau numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_dutrucapct set slyeucau=d_slyeucau where id=d_id and manguon=d_manguon and mabd=d_mabd;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_dutrucapct(id,manguon,mabd,slyeucau) values (d_id,d_manguon,d_mabd,d_slyeucau);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_chuyenll(d_id numeric,d_nhom numeric,d_sophieu varchar,d_ngay varchar,d_lydo varchar,d_userid numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_chuyenll set nhom=d_nhom,sophieu=d_sophieu,ngay=to_timestamp(d_ngay,'dd/mm/yyyy'),lydo=d_lydo,userid=d_userid where id=d_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_chuyenll(id,nhom,sophieu,ngay,lydo,userid) values (d_id,d_nhom,d_sophieu,to_timestamp(d_ngay,'dd/mm/yyyy'),d_lydo,d_userid);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;  \n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_chuyenct(d_id numeric,d_stt numeric,d_sttt numeric,d_makho numeric,d_mabd numeric,d_soluong numeric,d_nguonchuyen numeric,d_stttchuyen numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_chuyenct set sttt=d_sttt,makho=d_makho,mabd=d_mabd,soluong=d_soluong,nguonchuyen=d_nguonchuyen,stttchuyen=d_stttchuyen where id=d_id and stt=d_stt;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_chuyenct(id,stt,sttt,makho,mabd,soluong,nguonchuyen,stttchuyen) values (d_id,d_stt,d_sttt,d_makho,d_mabd,d_soluong,d_nguonchuyen,d_stttchuyen);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE; \n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_ngtrull(d_id numeric,d_nhom numeric,d_mabn varchar,d_hoten text,d_namsinh varchar,d_ngay varchar,d_mabs varchar,d_makp numeric,d_loai numeric,d_userid numeric,d_sotoa numeric,d_maql numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_ngtrull set nhom=d_nhom,mabn=d_mabn,hoten=d_hoten,namsinh=d_namsinh,ngay=to_timestamp(d_ngay,'dd/mm/yyyy'),mabs=d_mabs,makp=d_makp,loai=d_loai,userid=d_userid,sotoa=d_sotoa,maql=d_maql where id=d_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_ngtrull(id,nhom,mabn,hoten,namsinh,ngay,mabs,makp,loai,userid,sotoa,maql) values (d_id,d_nhom,d_mabn,d_hoten,d_namsinh,to_timestamp(d_ngay,'dd/mm/yyyy'),d_mabs,d_makp,d_loai,d_userid,d_sotoa,d_maql);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE; \n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_ngtrull(d_id numeric,d_nhom numeric,d_mabn varchar,d_hoten text,d_namsinh varchar,d_ngay varchar,d_mabs varchar,d_makp numeric,d_loai numeric,d_userid numeric,d_sotoa numeric,d_maql numeric,d_diachi text,d_ghichu text)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_ngtrull set nhom=d_nhom,mabn=d_mabn,hoten=d_hoten,namsinh=d_namsinh,ngay=to_timestamp(d_ngay,'dd/mm/yyyy'),mabs=d_mabs,makp=d_makp,loai=d_loai,userid=d_userid,sotoa=d_sotoa,maql=d_maql,diachi=d_diachi,ghichu=d_ghichu where id=d_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_ngtrull(id,nhom,mabn,hoten,namsinh,ngay,mabs,makp,loai,userid,sotoa,maql,diachi,ghichu) values (d_id,d_nhom,d_mabn,d_hoten,d_namsinh,to_timestamp(d_ngay,'dd/mm/yyyy'),d_mabs,d_makp,d_loai,d_userid,d_sotoa,d_maql,d_diachi,d_ghichu);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE; \n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_ngtruct(d_id numeric,d_stt numeric,d_sttt numeric,d_makho numeric,d_mabd numeric,d_soluong numeric,d_giaban numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_ngtruct set sttt=d_sttt,makho=d_makho,mabd=d_mabd,soluong=d_soluong,giaban=d_giaban where id=d_id and stt=d_stt;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_ngtruct(id,stt,sttt,makho,mabd,soluong,giaban) values (d_id,d_stt,d_sttt,d_makho,d_mabd,d_soluong,d_giaban);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE; \n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_ngtruct(d_id numeric,d_stt numeric,d_sttt numeric,d_makho numeric,d_mabd numeric,d_soluong numeric,d_giaban numeric,d_madoituong numeric(2),d_paid numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_ngtruct set sttt=d_sttt,makho=d_makho,mabd=d_mabd,soluong=d_soluong,giaban=d_giaban,madoituong=d_madoituong,paid=d_paid where id=d_id and stt=d_stt;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_ngtruct(id,stt,sttt,makho,mabd,soluong,giaban,madoituong,paid) values (d_id,d_stt,d_sttt,d_makho,d_mabd,d_soluong,d_giaban,d_madoituong,d_paid);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE; \n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_xuatsdll(d_id numeric,d_nhom numeric,d_mabn varchar,d_mavaovien numeric,d_maql numeric,d_idkhoa numeric,d_ngay varchar,d_loai numeric,d_phieu numeric,d_makp numeric,d_userid numeric,d_idduyet numeric,d_thuoc numeric,d_makhoa numeric,d_lydo numeric,d_lk numeric,d_ghichu text,d_ngayylenh varchar)\n";
                sql += "    RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_xuatsdll set nhom=d_nhom,mabn=d_mabn,mavaovien=d_mavaovien,maql=d_maql,idkhoa=d_idkhoa,ngayylenh=to_timestamp(d_ngayylenh,'dd/mm/yyyy'),ngay=to_timestamp(d_ngay,'dd/mm/yyyy'),loai=d_loai,phieu=d_phieu,makp=d_makp,userid=d_userid,idduyet=d_idduyet,thuoc=d_thuoc,makhoa=d_makhoa,lydo=d_lydo,lk=d_lk,ghichu=d_ghichu where id=d_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_xuatsdll(id,nhom,mabn,mavaovien,maql,idkhoa,ngayylenh,ngay,loai,phieu,makp,userid,idduyet,thuoc,makhoa,lydo,lk,ghichu) values (d_id,d_nhom,d_mabn,d_mavaovien,d_maql,d_idkhoa,to_timestamp(d_ngayylenh,'dd/mm/yyyy'),to_timestamp(d_ngay,'dd/mm/yyyy'),d_loai,d_phieu,d_makp,d_userid,d_idduyet,d_thuoc,d_makhoa,d_lydo,d_lk,d_ghichu);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE; \n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_xuatsdct(d_id numeric,d_stt numeric,d_sttt numeric,d_madoituong numeric,d_makho numeric,d_mabd numeric,d_soluong numeric,d_sttduyet numeric,d_giaban numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_xuatsdct set sttt=d_sttt,madoituong=d_madoituong,makho=d_makho,mabd=d_mabd,soluong=d_soluong,sttduyet=d_sttduyet,giaban=d_giaban where id=d_id and stt=d_stt;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_xuatsdct(id,stt,sttt,madoituong,makho,mabd,soluong,sttduyet,giaban) values (d_id,d_stt,d_sttt,d_madoituong,d_makho,d_mabd,d_soluong,d_sttduyet,d_giaban);\n";
                sql += "    end if;	\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE; \n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_xuatsdct(d_id numeric,d_stt numeric,d_sttt numeric,d_madoituong numeric,d_makho numeric,d_mabd numeric,d_soluong numeric,d_sttduyet numeric,d_giaban numeric, d_ngayylenh varchar)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_xuatsdct set sttt=d_sttt,madoituong=d_madoituong,makho=d_makho,mabd=d_mabd,soluong=d_soluong,sttduyet=d_sttduyet,giaban=d_giaban, ngayylenh=to_timestamp(d_ngayylenh,'dd/mm/yyyy') where id=d_id and stt=d_stt;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_xuatsdct(id,stt,sttt,madoituong,makho,mabd,soluong,sttduyet,giaban, ngayylenh) values (d_id,d_stt,d_sttt,d_madoituong,d_makho,d_mabd,d_soluong,d_sttduyet,d_giaban,to_timestamp(d_ngayylenh,'dd/mm/yyyy') );\n";
                sql += "    end if;	\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE; \n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_bucstt(d_id numeric,d_stt numeric,d_sttt numeric,d_makho numeric,d_mabd numeric,d_soluong numeric,d_sttduyet numeric,d_giaban numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_bucstt set sttt=d_sttt,makho=d_makho,mabd=d_mabd,soluong=d_soluong,sttduyet=d_sttduyet,giaban=d_giaban where id=d_id and stt=d_stt;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_bucstt(id,stt,sttt,makho,mabd,soluong,sttduyet,giaban) values (d_id,d_stt,d_sttt,d_makho,d_mabd,d_soluong,d_sttduyet,d_giaban);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE; \n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_bucstt(d_id numeric,d_stt numeric,d_sttt numeric,d_makho numeric,d_mabd numeric,d_soluong numeric,d_sttduyet numeric,d_giaban numeric,d_sltreo numeric,d_madoituong numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_bucstt set sttt=d_sttt,makho=d_makho,mabd=d_mabd,soluong=d_soluong,sttduyet=d_sttduyet,giaban=d_giaban,sltreo=d_sltreo,madoituong=d_madoituong where id=d_id and stt=d_stt;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_bucstt(id,stt,sttt,makho,mabd,soluong,sttduyet,giaban,sltreo,madoituong) values (d_id,d_stt,d_sttt,d_makho,d_mabd,d_soluong,d_sttduyet,d_giaban,d_sltreo,d_madoituong);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE; \n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_thucxuat(d_id numeric,d_sttt numeric,d_madoituong numeric,d_makho numeric,d_mabd numeric,d_soluong numeric,d_giaban numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_thucxuat set mabd=d_mabd,soluong=soluong+d_soluong,giaban=d_giaban where id=d_id and sttt=d_sttt and madoituong=d_madoituong and makho=d_makho;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_thucxuat(id,sttt,madoituong,makho,mabd,soluong,giaban) values (d_id,d_sttt,d_madoituong,d_makho,d_mabd,d_soluong,d_giaban);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE; \n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_thucxuat_stt(d_id numeric,d_sttt numeric,d_madoituong numeric,d_makho numeric,d_mabd numeric,d_soluong numeric,d_stt numeric,d_giaban numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "   update " + schema + ".d_thucxuat set mabd=d_mabd,soluong=d_soluong,sttt=d_sttt,madoituong=d_madoituong,makho=d_makho,giaban=d_giaban where id=d_id and stt=d_stt;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_thucxuat(id,sttt,madoituong,makho,mabd,soluong,stt,giaban) values (d_id,d_sttt,d_madoituong,d_makho,d_mabd,d_soluong,d_stt,d_giaban);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE; \n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_thucbucstt(d_id numeric,d_sttt numeric,d_makho numeric,d_mabd numeric,d_soluong numeric,d_giaban numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_thucbucstt set mabd=d_mabd,soluong=soluong+d_soluong,giaban=d_giaban where id=d_id and sttt=d_sttt and makho=d_makho;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_thucbucstt(id,sttt,makho,mabd,soluong,giaban) values (d_id,d_sttt,d_makho,d_mabd,d_soluong,d_giaban);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE; \n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_thucbucstt_stt(d_id numeric,d_sttt numeric,d_makho numeric,d_mabd numeric,d_soluong numeric,d_stt numeric,d_giaban numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_thucbucstt set mabd=d_mabd,soluong=d_soluong,sttt=d_sttt,makho=d_makho,giaban=d_giaban where id=d_id and stt=d_stt;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_thucbucstt(id,sttt,makho,mabd,soluong,stt,giaban) values (d_id,d_sttt,d_makho,d_mabd,d_soluong,d_stt,d_giaban);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE; \n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_bhytkb(d_id numeric,d_nhom numeric,d_quyenso numeric,d_sobienlai numeric,d_ngay varchar,d_mabn varchar,d_mavaovien numeric,d_maql numeric,d_makp varchar,d_chandoan text,d_maicd varchar,d_mabs varchar,d_sothe varchar,d_maphu numeric,d_mabv varchar,d_congkham numeric,d_thuoc numeric,d_cls numeric,d_bntra numeric,d_bhyttra numeric,d_userid numeric,d_loaiba numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".bhytkb set nhom=d_nhom,quyenso=d_quyenso,sobienlai=d_sobienlai,ngay=to_timestamp(d_ngay,'dd/mm/yyyy'),mabn=d_mabn,mavaovien=d_mavaovien,maql=d_maql,makp=d_makp,chandoan=d_chandoan,maicd=d_maicd,mabs=d_mabs,sothe=d_sothe,maphu=d_maphu,mabv=d_mabv,congkham=d_congkham,thuoc=d_thuoc,cls=d_cls,bntra=d_bntra,bhyttra=d_bhyttra,userid=d_userid,loaiba=d_loaiba where id=d_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".bhytkb(id,nhom,quyenso,sobienlai,ngay,mabn,mavaovien,maql,makp,chandoan,maicd,mabs,sothe,maphu,mabv,congkham,thuoc,cls,bntra,bhyttra,userid,sotoa,loaiba) values (d_id,d_nhom,d_quyenso,d_sobienlai,to_timestamp(d_ngay,'dd/mm/yyyy'),d_mabn,d_mavaovien,d_maql,d_makp,d_chandoan,d_maicd,d_mabs,d_sothe,d_maphu,d_mabv,d_congkham,d_thuoc,d_cls,d_bntra,d_bhyttra,d_userid,0,d_loaiba);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE; \n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_bhytkb(d_id numeric,d_nhom numeric,d_quyenso numeric,d_sobienlai numeric,d_ngay varchar,d_mabn varchar,d_mavaovien numeric,d_maql numeric,d_makp varchar,d_chandoan text,d_maicd varchar,d_mabs varchar,d_sothe varchar,d_maphu numeric,d_mabv varchar,d_congkham numeric,d_thuoc numeric,d_cls numeric,d_bntra numeric,d_bhyttra numeric,d_userid numeric,d_loaiba numeric,d_traituyen numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".bhytkb set nhom=d_nhom,quyenso=d_quyenso,sobienlai=d_sobienlai,ngay=to_timestamp(d_ngay,'dd/mm/yyyy'),mabn=d_mabn,mavaovien=d_mavaovien,maql=d_maql,makp=d_makp,chandoan=d_chandoan,maicd=d_maicd,mabs=d_mabs,sothe=d_sothe,maphu=d_maphu,mabv=d_mabv,congkham=d_congkham,thuoc=d_thuoc,cls=d_cls,bntra=d_bntra,bhyttra=d_bhyttra,userid=d_userid,loaiba=d_loaiba,traituyen=d_traituyen where id=d_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".bhytkb(id,nhom,quyenso,sobienlai,ngay,mabn,mavaovien,maql,makp,chandoan,maicd,mabs,sothe,maphu,mabv,congkham,thuoc,cls,bntra,bhyttra,userid,sotoa,loaiba,traituyen) values (d_id,d_nhom,d_quyenso,d_sobienlai,to_timestamp(d_ngay,'dd/mm/yyyy'),d_mabn,d_mavaovien,d_maql,d_makp,d_chandoan,d_maicd,d_mabs,d_sothe,d_maphu,d_mabv,d_congkham,d_thuoc,d_cls,d_bntra,d_bhyttra,d_userid,0,d_loaiba,d_traituyen);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE; \n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_bhytkb(d_id numeric,d_nhom numeric,d_ngay varchar,d_mabn varchar,d_mavaovien numeric,d_maql numeric,d_makp varchar,d_chandoan text,d_maicd varchar,d_mabs varchar,d_sothe varchar,d_maphu numeric,d_mabv varchar,d_userid numeric,d_loaiba numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".bhytkb set nhom=d_nhom,ngay=to_timestamp(d_ngay,'dd/mm/yyyy'),mabn=d_mabn,mavaovien=d_mavaovien,maql=d_maql,makp=d_makp,chandoan=d_chandoan,maicd=d_maicd,mabs=d_mabs,sothe=d_sothe,maphu=d_maphu,mabv=d_mabv,userid=d_userid,loaiba=d_loaiba where id=d_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".bhytkb(id,nhom,quyenso,sobienlai,ngay,mabn,mavaovien,maql,makp,chandoan,maicd,mabs,sothe,maphu,mabv,congkham,thuoc,cls,bntra,bhyttra,userid,sotoa,loaiba) values (d_id,d_nhom,0,0,to_timestamp(d_ngay,'dd/mm/yyyy'),d_mabn,d_mavaovien,d_maql,d_makp,d_chandoan,d_maicd,d_mabs,d_sothe,d_maphu,d_mabv,0,0,0,0,0,d_userid,0,d_loaiba);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE; \n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_bhytkb(d_id numeric,d_nhom numeric,d_ngay varchar,d_mabn varchar,d_mavaovien numeric,d_maql numeric,d_makp varchar,d_chandoan text,d_maicd varchar,d_mabs varchar,d_sothe varchar,d_maphu numeric,d_mabv varchar,d_userid numeric,d_loaiba numeric,d_traituyen numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".bhytkb set nhom=d_nhom,ngay=to_timestamp(d_ngay,'dd/mm/yyyy'),mabn=d_mabn,mavaovien=d_mavaovien,maql=d_maql,makp=d_makp,chandoan=d_chandoan,maicd=d_maicd,mabs=d_mabs,sothe=d_sothe,maphu=d_maphu,mabv=d_mabv,userid=d_userid,loaiba=d_loaiba,traituyen=d_traituyen where id=d_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".bhytkb(id,nhom,quyenso,sobienlai,ngay,mabn,mavaovien,maql,makp,chandoan,maicd,mabs,sothe,maphu,mabv,congkham,thuoc,cls,bntra,bhyttra,userid,sotoa,loaiba,traituyen) values (d_id,d_nhom,0,0,to_timestamp(d_ngay,'dd/mm/yyyy'),d_mabn,d_mavaovien,d_maql,d_makp,d_chandoan,d_maicd,d_mabs,d_sothe,d_maphu,d_mabv,0,0,0,0,0,d_userid,0,d_loaiba,d_traituyen);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE; \n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_bhytds(d_mabn varchar,d_hoten text,d_namsinh varchar,d_diachi text)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".bhytds set hoten=d_hoten,namsinh=d_namsinh,diachi=d_diachi where mabn=d_mabn;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".bhytds(mabn,hoten,namsinh,diachi) values (d_mabn,d_hoten,d_namsinh,d_diachi);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE; \n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_bhytthuoc(d_id numeric,d_stt numeric,d_sttt numeric,d_makho numeric,d_mabd numeric,d_soluong numeric,d_cachdung text,d_giaban numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".bhytthuoc set sttt=d_sttt,makho=d_makho,mabd=d_mabd,soluong=d_soluong,cachdung=d_cachdung,giaban=d_giaban where id=d_id and stt=d_stt;\n";
                sql += "    if found=false then	\n";
                sql += "        insert into " + schema + ".bhytthuoc(id,stt,sttt,makho,mabd,soluong,cachdung,giaban) values (d_id,d_stt,d_sttt,d_makho,d_mabd,d_soluong,d_cachdung,d_giaban);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE; \n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_bhytthuoc(d_id numeric,d_stt numeric,d_sttt numeric,d_makho numeric,d_mabd numeric,d_soluong numeric,d_cachdung text,d_giaban numeric,d_gia_bh numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".bhytthuoc set sttt=d_sttt,makho=d_makho,mabd=d_mabd,soluong=d_soluong,cachdung=d_cachdung,giaban=d_giaban,gia_bh=d_gia_bh where id=d_id and stt=d_stt;\n";
                sql += "    if found=false then	\n";
                sql += "        insert into " + schema + ".bhytthuoc(id,stt,sttt,makho,mabd,soluong,cachdung,giaban,gia_bh) values (d_id,d_stt,d_sttt,d_makho,d_mabd,d_soluong,d_cachdung,d_giaban,d_gia_bh);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE; \n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_bhytcls(d_id numeric,d_stt numeric,d_mavp numeric,d_soluong numeric,d_dongia numeric,d_idchidinh numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".bhytcls set mavp=d_mavp,soluong=d_soluong,dongia=d_dongia,idchidinh=d_idchidinh where id=d_id and stt=d_stt;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".bhytcls(id,stt,mavp,soluong,dongia,idchidinh) values (d_id,d_stt,d_mavp,d_soluong,d_dongia,d_idchidinh);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE; \n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_toathuocll(d_id numeric,d_sophieu numeric,d_mabn varchar,d_maql numeric,d_ngay varchar,d_makp varchar,d_chandoan text,d_maicd varchar,d_mabs varchar,d_ghichu text,d_userid numeric,d_songay numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_toathuocll set sophieu=d_sophieu,mabn=d_mabn,maql=d_maql,ngay=to_timestamp(d_ngay,'dd/mm/yyyy hh24:mi'),makp=d_makp,chandoan=d_chandoan,maicd=d_maicd,mabs=d_mabs,ghichu=d_ghichu,userid=d_userid,songay=d_songay where id=d_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_toathuocll(id,sophieu,mabn,maql,ngay,makp,chandoan,maicd,mabs,ghichu,userid,songay) values (d_id,d_sophieu,d_mabn,d_maql,to_timestamp(d_ngay,'dd/mm/yyyy hh24:mi'),d_makp,d_chandoan,d_maicd,d_mabs,d_ghichu,d_userid,d_songay);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE; \n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_toathuocct(d_id numeric,d_stt numeric,d_mabd numeric,d_soluong numeric,d_cachdung text,d_solan numeric,d_lan numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_toathuocct set mabd=d_mabd,soluong=d_soluong,cachdung=d_cachdung,solan=d_solan,lan=d_lan where id=d_id and stt=d_stt;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_toathuocct(id,stt,mabd,soluong,cachdung,solan,lan) values (d_id,d_stt,d_mabd,d_soluong,d_cachdung,d_solan,d_lan);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE; \n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_thuocbhytll(d_id numeric,d_nhom numeric,d_ngay varchar,d_mabn varchar,d_mavaovien numeric,d_maql numeric,d_userid numeric,d_madoituong numeric,d_ghichu text,d_songay numeric,d_makp varchar,d_mabs varchar,d_chandoan text,d_maicd varchar,d_loaiba numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_thuocbhytll set nhom=d_nhom,ngay=to_timestamp(d_ngay,'dd/mm/yyyy'),mabn=d_mabn,mavaovien=d_mavaovien,maql=d_maql,userid=d_userid,madoituong=d_madoituong,ghichu=d_ghichu,songay=d_songay,makp=d_makp,mabs=d_mabs,chandoan=d_chandoan,maicd=d_maicd,loaiba=d_loaiba where id=d_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_thuocbhytll(id,nhom,ngay,mabn,mavaovien,maql,userid,madoituong,ghichu,songay,makp,mabs,chandoan,maicd,loaiba) values (d_id,d_nhom,to_timestamp(d_ngay,'dd/mm/yyyy'),d_mabn,d_mavaovien,d_maql,d_userid,d_madoituong,d_ghichu,d_songay,d_makp,d_mabs,d_chandoan,d_maicd,d_loaiba);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE; \n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_thuocbhytct(d_id numeric,d_stt numeric,d_makho numeric,d_mabd numeric,d_slyeucau numeric,d_cachdung text,d_manguon numeric,d_solan numeric,d_lan numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_thuocbhytct set makho=d_makho,mabd=d_mabd,slyeucau=d_slyeucau,cachdung=d_cachdung,manguon=d_manguon,solan=d_solan,lan=d_lan where id=d_id and stt=d_stt;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_thuocbhytct(id,stt,makho,mabd,slyeucau,slthuc,cachdung,manguon,solan,lan) values (d_id,d_stt,d_makho,d_mabd,d_slyeucau,0,d_cachdung,d_manguon,d_solan,d_lan);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE; \n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_thuocbhytct(d_id numeric,d_stt numeric,d_makho numeric,d_mabd numeric,d_slyeucau numeric,d_cachdung text,d_manguon numeric,d_solan numeric,d_lan numeric,d_madoituong numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_thuocbhytct set makho=d_makho,mabd=d_mabd,slyeucau=d_slyeucau,cachdung=d_cachdung,manguon=d_manguon,solan=d_solan,lan=d_lan,madoituong=d_madoituong where id=d_id and stt=d_stt;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_thuocbhytct(id,stt,makho,mabd,slyeucau,slthuc,cachdung,manguon,solan,lan,madoituong) values (d_id,d_stt,d_makho,d_mabd,d_slyeucau,0,d_cachdung,d_manguon,d_solan,d_lan,d_madoituong);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE; \n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_benhanpk(m_mabn varchar,m_mavaovien numeric,m_maql numeric,m_makp varchar,m_ngay varchar,m_dentu numeric,m_nhantu numeric,m_madoituong numeric,m_chandoan text,m_maicd varchar,m_ttlucrv numeric,m_mabs varchar,m_sovaovien varchar,m_bienchung numeric,m_taibien numeric,m_giaiphau numeric,m_mangtr numeric,m_userid numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".benhanpk set mabn=m_mabn,mavaovien=m_mavaovien,makp=m_makp,ngay=to_timestamp(m_ngay,'dd/mm/yyyy hh24:mi'),dentu=m_dentu,nhantu=m_nhantu,madoituong=m_madoituong,chandoan=m_chandoan,maicd=m_maicd,ttlucrv=m_ttlucrv,mabs=m_mabs,sovaovien=m_sovaovien,bienchung=m_bienchung,taibien=m_taibien,giaiphau=m_giaiphau,mangtr=m_mangtr,userid=m_userid where maql=m_maql;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".benhanpk(mabn,mavaovien,maql,makp,ngay,dentu,nhantu,madoituong,chandoan,maicd,ttlucrv,mabs,sovaovien,bienchung,taibien,giaiphau,mangtr,userid) values (m_mabn,m_mavaovien,m_maql,m_makp,to_timestamp(m_ngay,'dd/mm/yyyy hh24:mi'),m_dentu,m_nhantu,m_madoituong,m_chandoan,m_maicd,m_ttlucrv,m_mabs,m_sovaovien,m_bienchung,m_taibien,m_giaiphau,m_mangtr,m_userid);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_xutrikbct(m_maql numeric,m_xutri text,m_makp varchar)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".xutrikbct set xutri=m_xutri,makp=m_makp where maql=m_maql;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".xutrikbct(maql,xutri,makp) values (m_maql,m_xutri,m_makp);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_vpkhoa(v_id numeric,v_mabn varchar,v_mavaovien numeric,v_maql numeric,v_idkhoa numeric,v_ngay varchar,v_makp varchar,v_madoituong numeric,v_mavp numeric,v_soluong numeric,v_dongia numeric,v_vattu numeric,v_userid numeric,v_buoi numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".v_vpkhoa set mabn=v_mabn,mavaovien=v_mavaovien,maql=v_maql,idkhoa=v_idkhoa,ngay=to_timestamp(v_ngay,'dd/mm/yyyy hh24:mi'),makp=v_makp,madoituong=v_madoituong,mavp=v_mavp,soluong=v_soluong,dongia=v_dongia,vattu=v_vattu,userid=v_userid,buoi=v_buoi where id=v_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".v_vpkhoa(id,mabn,mavaovien,maql,idkhoa,ngay,makp,madoituong,mavp,soluong,dongia,vattu,done,userid,buoi) values (v_id,v_mabn,v_mavaovien,v_maql,v_idkhoa,to_timestamp(v_ngay,'dd/mm/yyyy hh24:mi'),v_makp,v_madoituong,v_mavp,v_soluong,v_dongia,v_vattu,0,v_userid,v_buoi);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_tienthuoc(d_id numeric,d_mabn varchar,d_mavaovien numeric,d_maql numeric,d_idkhoa numeric,d_ngay varchar,d_makp numeric,d_madoituong numeric,d_mabd numeric,d_soluong numeric,d_giaban numeric,d_giamua numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_tienthuoc set giaban=d_giaban,soluong=soluong+d_soluong where mabn=d_mabn and mavaovien=d_mavaovien and maql=d_maql and idkhoa=d_idkhoa and to_char(ngay,'dd/mm/yyyy')=d_ngay and makp=d_makp and mabd=d_mabd and giamua=d_giamua and madoituong=d_madoituong and done=0 and id=d_id;\n";//
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_tienthuoc(id,mabn,mavaovien,maql,idkhoa,ngay,makp,madoituong,mabd,soluong,giaban,done,giamua) values (d_id,d_mabn,d_mavaovien,d_maql,d_idkhoa,to_timestamp(d_ngay,'dd/mm/yyyy'),d_makp,d_madoituong,d_mabd,d_soluong,d_giaban,0,d_giamua);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_tienthuoc(d_id numeric,d_mabn varchar,d_mavaovien numeric,d_maql numeric,d_idkhoa numeric,d_ngay varchar,d_makp numeric,d_madoituong numeric,d_mabd numeric,d_soluong numeric,d_giaban numeric,d_giamua numeric,d_gianovat numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_tienthuoc set giaban=d_giaban,gianovat=d_gianovat,soluong=soluong+d_soluong where mabn=d_mabn and mavaovien=d_mavaovien and maql=d_maql and idkhoa=d_idkhoa and to_char(ngay,'dd/mm/yyyy')=d_ngay and makp=d_makp and mabd=d_mabd and giamua=d_giamua and madoituong=d_madoituong and done=0 and id=d_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_tienthuoc(id,mabn,mavaovien,maql,idkhoa,ngay,makp,madoituong,mabd,soluong,giaban,done,giamua,gianovat) values (d_id,d_mabn,d_mavaovien,d_maql,d_idkhoa,to_timestamp(d_ngay,'dd/mm/yyyy'),d_makp,d_madoituong,d_mabd,d_soluong,d_giaban,0,d_giamua,d_gianovat);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_dutrull(d_id numeric,d_idduyet numeric,d_mabn varchar,d_mavaovien numeric,d_maql numeric,d_idkhoa numeric,d_ngayvv varchar,d_songay numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_dutrull set idduyet=d_idduyet,mabn=d_mabn,mavaovien=d_mavaovien,maql=d_maql,idkhoa=d_idkhoa,ngayvv=to_timestamp(d_ngayvv,'dd/mm/yyyy hh24:mi'),songay=d_songay where id=d_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_dutrull(id,idduyet,mabn,mavaovien,maql,idkhoa,ngayvv,songay) values (d_id,d_idduyet,d_mabn,d_mavaovien,d_maql,d_idkhoa,to_timestamp(d_ngayvv,'dd/mm/yyyy hh24:mi'),d_songay);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_duyet(d_id numeric,d_nhom numeric,d_ngay varchar,d_loai numeric,d_phieu numeric,d_makp numeric,d_done numeric,d_userid numeric,d_makhoa numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_duyet set nhom=d_nhom,ngay=to_timestamp(d_ngay,'dd/mm/yyyy'),loai=d_loai,phieu=d_phieu,makp=d_makp,userid=d_userid,makhoa=d_makhoa where id=d_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_duyet(id,nhom,ngay,loai,phieu,makp,done,userid,makhoa) values (d_id,d_nhom,to_timestamp(d_ngay,'dd/mm/yyyy'),d_loai,d_phieu,d_makp,d_done,d_userid,d_makhoa);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_dausinhton(d_id numeric,d_idkhoa numeric,d_iddutru numeric,d_ngay varchar,d_mabs varchar,d_manv varchar,d_mach numeric,d_nhietdo numeric,d_huyetap varchar,d_nhiptho numeric,d_cannang numeric,d_phong varchar,d_giuong varchar,d_ghichu text)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_dausinhton set idkhoa=d_idkhoa,iddutru=d_iddutru,ngay=to_timestamp(d_ngay,'dd/mm/yyyy hh24:mi'),mabs=d_mabs,manv=d_manv,mach=d_mach,nhietdo=d_nhietdo,huyetap=d_huyetap,nhiptho=d_nhiptho,cannang=d_cannang,phong=d_phong,giuong=d_giuong,ghichu=d_ghichu where id=d_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_dausinhton(id,idkhoa,iddutru,ngay,mabs,manv,mach,nhietdo,huyetap,nhiptho,cannang,phong,giuong,ghichu) values (d_id,d_idkhoa,d_iddutru,to_timestamp(d_ngay,'dd/mm/yyyy hh24:mi'),d_mabs,d_manv,d_mach,d_nhietdo,d_huyetap,d_nhiptho,d_cannang,d_phong,d_giuong,d_ghichu);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_dutruct(d_id numeric,d_stt numeric,d_madoituong numeric,d_makho numeric,d_mabd numeric,d_slyeucau numeric,d_slthuc numeric,d_cachdung text,d_manguon numeric,d_tutruc numeric,d_solan numeric,d_lan numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_dutruct set madoituong=d_madoituong,makho=d_makho,mabd=d_mabd,slyeucau=d_slyeucau,cachdung=d_cachdung,manguon=d_manguon,tutruc=d_tutruc,solan=d_solan,lan=d_lan where id=d_id and stt=d_stt;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_dutruct(id,stt,madoituong,makho,mabd,slyeucau,slthuc,cachdung,manguon,tutruc,solan,lan) values (d_id,d_stt,d_madoituong,d_makho,d_mabd,d_slyeucau,d_slthuc,d_cachdung,d_manguon,d_tutruc,d_solan,d_lan);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_dutruct(d_id numeric,d_stt numeric,d_madoituong numeric,d_makho numeric,d_mabd numeric,d_slyeucau numeric,d_slthuc numeric,d_cachdung text,d_manguon numeric,d_tutruc numeric,d_solan numeric,d_lan numeric,d_choduyet numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_dutruct set madoituong=d_madoituong,makho=d_makho,mabd=d_mabd,slyeucau=d_slyeucau,cachdung=d_cachdung,manguon=d_manguon,tutruc=d_tutruc,solan=d_solan,lan=d_lan,choduyet=d_choduyet where id=d_id and stt=d_stt;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_dutruct(id,stt,madoituong,makho,mabd,slyeucau,slthuc,cachdung,manguon,tutruc,solan,lan,choduyet) values (d_id,d_stt,d_madoituong,d_makho,d_mabd,d_slyeucau,d_slthuc,d_cachdung,d_manguon,d_tutruc,d_solan,d_lan,d_choduyet);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_hoantrall(d_id numeric,d_idduyet numeric,d_mabn varchar,d_mavaovien numeric,d_maql numeric,d_idkhoa numeric,d_ngayvv varchar,d_lydo numeric,d_thuoc numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_hoantrall set idduyet=d_idduyet,mabn=d_mabn,mavaovien=d_mavaovien,maql=d_maql,idkhoa=d_idkhoa,ngayvv=to_timestamp(d_ngayvv,'dd/mm/yyyy hh24:mi'),lydo=d_lydo,thuoc=d_thuoc where id=d_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_hoantrall(id,idduyet,mabn,mavaovien,maql,idkhoa,ngayvv,lydo,thuoc) values (d_id,d_idduyet,d_mabn,d_mavaovien,d_maql,d_idkhoa,to_timestamp(d_ngayvv,'dd/mm/yyyy hh24:mi'),d_lydo,d_thuoc);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_hoantract(d_id numeric,d_stt numeric,d_ngay varchar,d_madoituong numeric,d_makho numeric,d_mabd numeric,d_slyeucau numeric,d_slthuc numeric,d_manguon numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_hoantract set ngay=to_timestamp(d_ngay,'dd/mm/yyyy'),madoituong=d_madoituong,makho=d_makho,mabd=d_mabd,slyeucau=d_slyeucau,manguon=d_manguon where id=d_id and stt=d_stt;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_hoantract(id,stt,ngay,madoituong,makho,mabd,slyeucau,slthuc,manguon) values (d_id,d_stt,to_timestamp(d_ngay,'dd/mm/yyyy'),d_madoituong,d_makho,d_mabd,d_slyeucau,d_slthuc,d_manguon);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_hoantract(d_id numeric,d_stt numeric,d_ngay varchar,d_madoituong numeric,d_makho numeric,d_mabd numeric,d_slyeucau numeric,d_slthuc numeric,d_manguon numeric,d_sttt numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_hoantract set ngay=to_timestamp(d_ngay,'dd/mm/yyyy'),madoituong=d_madoituong,makho=d_makho,mabd=d_mabd,slyeucau=d_slyeucau,manguon=d_manguon,sttt=d_sttt where id=d_id and stt=d_stt;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_hoantract(id,stt,ngay,madoituong,makho,mabd,slyeucau,slthuc,manguon,sttt) values (d_id,d_stt,to_timestamp(d_ngay,'dd/mm/yyyy'),d_madoituong,d_makho,d_mabd,d_slyeucau,d_slthuc,d_manguon,d_sttt);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_haophill(d_id numeric,d_idduyet numeric,d_sophieu varchar)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_haophill set idduyet=d_idduyet,sophieu=d_sophieu where id=d_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_haophill(id,idduyet,sophieu) values (d_id,d_idduyet,d_sophieu);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_haophict(d_id numeric,d_stt numeric,d_madoituong numeric,d_makho numeric,d_mabd numeric,d_slyeucau numeric,d_slthuc numeric,d_manguon numeric,d_tutruc numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_haophict set madoituong=d_madoituong,makho=d_makho,mabd=d_mabd,slyeucau=d_slyeucau,manguon=d_manguon,tutruc=d_tutruc where id=d_id and stt=d_stt;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_haophict(id,stt,madoituong,makho,mabd,slyeucau,slthuc,manguon,tutruc) values (d_id,d_stt,d_madoituong,d_makho,d_mabd,d_slyeucau,d_slthuc,d_manguon,d_tutruc);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_xtutrucll(d_id numeric,d_idduyet numeric,d_mabn varchar,d_mavaovien numeric,d_maql numeric,d_idkhoa numeric,d_ngayvv varchar,d_songay numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_xtutrucll set idduyet=d_idduyet,mabn=d_mabn,mavaovien=d_mavaovien,maql=d_maql,idkhoa=d_idkhoa,ngayvv=to_timestamp(d_ngayvv,'dd/mm/yyyy hh24:mi'),songay=d_songay where id=d_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_xtutrucll(id,idduyet,mabn,mavaovien,maql,idkhoa,ngayvv,songay) values (d_id,d_idduyet,d_mabn,d_mavaovien,d_maql,d_idkhoa,to_timestamp(d_ngayvv,'dd/mm/yyyy hh24:mi'),d_songay);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_xtutrucct(d_id numeric,d_stt numeric,d_madoituong numeric,d_makho numeric,d_mabd numeric,d_slyeucau numeric,d_slthuc numeric,d_cachdung text,d_manguon numeric,d_idvpkhoa numeric,d_solan numeric,d_lan numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_xtutrucct set madoituong=d_madoituong,makho=d_makho,mabd=d_mabd,slyeucau=d_slyeucau,cachdung=d_cachdung,manguon=d_manguon,idvpkhoa=d_idvpkhoa,solan=d_solan,lan=d_lan where id=d_id and stt=d_stt;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_xtutrucct(id,stt,madoituong,makho,mabd,slyeucau,slthuc,cachdung,manguon,idvpkhoa,solan,lan) values (d_id,d_stt,d_madoituong,d_makho,d_mabd,d_slyeucau,d_slthuc,d_cachdung,d_manguon,d_idvpkhoa,d_solan,d_lan);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                //Thuy 22.08.2012
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_xtutrucct_cdha(d_id numeric,d_stt numeric,d_madoituong numeric,d_makho numeric,d_mabd numeric,d_slyeucau numeric,d_slthuc numeric,d_cachdung text,d_manguon numeric,d_idvpkhoa numeric,d_solan numeric,d_lan numeric,d_hu numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_xtutrucct set madoituong=d_madoituong,makho=d_makho,mabd=d_mabd,slyeucau=d_slyeucau,cachdung=d_cachdung,manguon=d_manguon,idvpkhoa=d_idvpkhoa,solan=d_solan,lan=d_lan,hu=d_hu where id=d_id and stt=d_stt;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_xtutrucct(id,stt,madoituong,makho,mabd,slyeucau,slthuc,cachdung,manguon,idvpkhoa,solan,lan,hu) values (d_id,d_stt,d_madoituong,d_makho,d_mabd,d_slyeucau,d_slthuc,d_cachdung,d_manguon,d_idvpkhoa,d_solan,d_lan,d_hu);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                //end Thuy 22.08.2012
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_ngayduyet(d_nhom numeric,d_loai numeric,d_phieu numeric,d_makp numeric,d_ngay varchar,d_idduyet numeric,d_makho text,d_sttduyet text)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_ngayduyet set idduyet=d_idduyet,sttduyet=d_sttduyet where nhom=d_nhom and loai=d_loai and phieu=d_phieu and makp=d_makp and to_char(ngay,'dd/mm/yyyy')=d_ngay and idduyet=d_idduyet and makho=d_makho;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_ngayduyet(nhom,loai,phieu,makp,ngay,idduyet,makho,sttduyet) values (d_nhom,d_loai,d_phieu,d_makp,to_timestamp(d_ngay,'dd/mm/yyyy'),d_idduyet,d_makho,d_sttduyet);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_phieuxuat(d_id numeric,d_soct varchar,d_ngay varchar,d_makp numeric,d_nhom numeric,d_loai varchar,d_phieu varchar,d_kho varchar,d_sotien numeric,d_no varchar,d_co varchar,d_diengiai text,d_userid numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_phieuxuat set soct=d_soct,ngay=to_timestamp(d_ngay,'dd/mm/yyyy'),makp=d_makp,nhom=d_nhom,loai=d_loai,phieu=d_phieu,kho=d_kho,sotien=d_sotien,no=d_no,co=d_co,diengiai=d_diengiai,userid=d_userid where id=d_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_phieuxuat(id,soct,ngay,makp,nhom,loai,phieu,kho,sotien,no,co,diengiai,userid) values (d_id,d_soct,to_timestamp(d_ngay,'dd/mm/yyyy'),d_makp,d_nhom,d_loai,d_phieu,d_kho,d_sotien,d_no,d_co,d_diengiai,d_userid);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_phieuxuat(d_id numeric,d_ngay varchar,d_makp numeric,d_nhom numeric,d_loai varchar,d_phieu varchar,d_kho varchar,d_sotien numeric,d_userid numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_phieuxuat set ngay=to_timestamp(d_ngay,'dd/mm/yyyy'),makp=d_makp,nhom=d_nhom,loai=d_loai,phieu=d_phieu,kho=d_kho,sotien=d_sotien,userid=d_userid where id=d_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_phieuxuat(id,soct,ngay,makp,nhom,loai,phieu,kho,sotien,no,co,diengiai,userid) values (d_id,'',to_timestamp(d_ngay,'dd/mm/yyyy'),d_makp,d_nhom,d_loai,d_phieu,d_kho,d_sotien,'','','',d_userid);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;	\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_thucbucstt(d_id numeric,d_sttt numeric,d_makho numeric,d_mabd numeric,d_soluong numeric,d_giaban numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_thucbucstt set mabd=d_mabd,soluong=soluong+d_soluong,giaban=d_giaban where id=d_id and sttt=d_sttt and makho=d_makho;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_thucbucstt(id,sttt,makho,mabd,soluong,giaban) values (d_id,d_sttt,d_makho,d_mabd,d_soluong,d_giaban);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;	\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_thucbucstt_stt(d_id numeric,d_sttt numeric,d_makho numeric,d_mabd numeric,d_soluong numeric,d_stt numeric,d_giaban numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_thucbucstt set mabd=d_mabd,soluong=d_soluong,sttt=d_sttt,makho=d_makho,giaban=d_giaban where id=d_id and stt=d_stt;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_thucbucstt(id,sttt,makho,mabd,soluong,stt,giaban) values (d_id,d_sttt,d_makho,d_mabd,d_soluong,d_stt,d_giaban);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;	\n";
                sql += "CREATE OR REPLACE FUNCTION  " + schema + ".upd_tienthuoc(d_mabn varchar, d_maql numeric)\n";
                sql += " RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "DECLARE\n";
                sql += "    t_id numeric;t_mabn varchar;t_mavaovien numeric;t_maql numeric;t_idkhoa numeric;t_ngay varchar;t_makp numeric;t_madoituong numeric;t_mabd numeric;t_soluong numeric;t_giaban numeric;t_giamua numeric;t_gianovat numeric;t_done numeric;t_idttrv numeric;t_datra numeric;t_traituyen numeric;\n";
                if (bUpdtienthuoc) sql += "    tienthuocs cursor (p_mabn varchar,p_maql numeric) is select id,mabn,maql, idkhoa, to_char(ngay,'dd/mm/yyyy') as ngay, makp, madoituong, mabd, giamua, done,idttrv,datra,gianovat from " + schema + ".d_tienthuoc where  mabn=p_mabn and maql=p_maql and done=1;\n";
                if (bGiaban) sql += "    thuocsd cursor  (p_mabn varchar, p_maql numeric) is select a.id,a.mabn,a.mavaovien,a.maql,a.idkhoa,to_char(a.ngayylenh,'dd/mm/yyyy') as ngay, a.makp,b.madoituong, b.mabd, case when a.loai=3 then -1*b.soluong else b.soluong end as soluong,c.giaban,t.giamua,t.gianovat, a.traituyen from " + schema + ".d_xuatsdll a, " + schema + ".d_xuatsdct b," + schema + ".d_theodoi t," + usr + ".d_dmbd c where a.id=b.id and b.sttt=t.id and b.mabd=c.id and a.mabn=p_mabn and a.maql=p_maql;\n";
                else sql += "    thuocsd cursor  (p_mabn varchar, p_maql numeric) is select a.id,a.mabn,a.mavaovien,a.maql,a.idkhoa,to_char(a.ngayylenh,'dd/mm/yyyy') as ngay, a.makhoa as makp,b.madoituong, b.mabd, case when a.loai=3 then -1*b.soluong else b.soluong end as soluong,t.giaban,t.giamua,t.gianovat, a.traituyen from " + schema + ".d_xuatsdll a, " + schema + ".d_xuatsdct b," + schema + ".d_theodoi t where a.id=b.id and b.sttt=t.id and a.mabn=p_mabn and a.maql=p_maql;\n";
                sql += "begin\n";
                if (bUpdtienthuoc) sql += "    open tienthuocs(d_mabn,d_maql);\n";
                sql += "    open thuocsd(d_mabn,d_maql);\n";
                sql += "    delete from " + schema + ".d_tienthuoc where mabn=d_mabn and maql=d_maql and done=0;\n";
                sql += "    loop\n";
                sql += "        fetch thuocsd into t_id,t_mabn,t_mavaovien,t_maql,t_idkhoa,t_ngay,t_makp,t_madoituong,t_mabd,t_soluong,t_giaban,t_giamua,t_gianovat,t_traituyen;\n";
                sql += "        if found=false then\n";
                sql += "            exit;\n";
                sql += "        end if;\n";
                sql += "        update " + schema + ".d_tienthuoc set soluong=soluong+t_soluong,giaban=t_giaban,traituyen=t_traituyen where mabn=t_mabn and maql=t_maql and makp=t_makp and idkhoa=t_idkhoa and mabd=t_mabd and to_char(ngay,'dd/mm/yyyy')=t_ngay and madoituong=t_madoituong and giamua=t_giamua and done=0 and id=t_id;\n";
                sql += "        if found=false then\n";
                sql += "            insert into " + schema + ".d_tienthuoc (id,mabn,mavaovien,maql,makp,idkhoa,ngay, madoituong,mabd,soluong,giaban,done,giamua,gianovat,traituyen)	values (t_id,t_mabn,t_mavaovien,t_maql, t_makp,t_idkhoa,to_timestamp(t_ngay,'dd/mm/yyyy'), t_madoituong, t_mabd, t_soluong,t_giaban,0,t_giamua,t_gianovat,t_traituyen);\n";
                sql += "        end if;\n";
                sql += "    end loop;\n";
                sql += "    close thuocsd;\n";
                if (bUpdtienthuoc)
                {
                    sql += "    loop\n";
                    sql += "        fetch tienthuocs into t_id,t_mabn,t_maql,t_idkhoa,t_ngay,t_makp,t_madoituong,t_mabd,t_giamua,t_done,t_idttrv,t_datra,t_gianovat;\n";
                    sql += "        if found=false then\n";
                    sql += "            exit;\n";
                    sql += "        end if;\n";
                    sql += "        update " + schema + ".d_tienthuoc set done=t_done,idttrv=t_idttrv,datra=t_datra where id=t_id and mabn=t_mabn and maql=t_maql and idkhoa=t_idkhoa and to_char(ngay,'dd/mm/yyyy')=t_ngay and makp=t_makp and madoituong=t_madoituong and mabd=t_mabd and giamua=t_giamua and done=0;\n";
                    sql += "    end loop;\n";
                    sql += "    close tienthuocs;\n";
                }
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;	\n";
                sql += "CREATE OR REPLACE FUNCTION  " + schema + ".upd_tienthuoc1(d_mabn varchar, d_maql numeric)\n";
                sql += " RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "DECLARE\n";
                sql += "    t_id numeric;t_mabn varchar;t_mavaovien numeric;t_maql numeric;t_idkhoa numeric;t_ngay varchar;t_makp numeric;t_madoituong numeric;t_mabd numeric;t_soluong numeric;t_giaban numeric;t_giamua numeric;t_gianovat numeric;t_gia_bh numeric;t_done numeric;t_idttrv numeric;t_datra numeric;t_traituyen numeric;\n";
                if (bUpdtienthuoc) sql += "    tienthuocs cursor (p_mabn varchar,p_maql numeric) is select id,mabn,maql, idkhoa, to_char(ngay,'dd/mm/yyyy') as ngay, makp, madoituong, mabd, giamua, done,idttrv,datra,gianovat,gia_bh from " + schema + ".d_tienthuoc where  mabn=p_mabn and maql=p_maql and done=1;\n";//gam 30/08/2011
                if (bGiaban) sql += "    thuocsd cursor  (p_mabn varchar, p_maql numeric) is select a.id,a.mabn,a.mavaovien,a.maql,a.idkhoa,to_char(b.ngayylenh,'dd/mm/yyyy') as ngay, a.makp,b.madoituong, b.mabd, case when a.loai=3 then -1*b.soluong else b.soluong end as soluong,c.giaban,t.giamua,t.gianovat, a.traituyen,b.gia_bh from " + schema + ".d_xuatsdll a, " + schema + ".d_xuatsdct b," + schema + ".d_theodoi t," + usr + ".d_dmbd c where a.id=b.id and b.sttt=t.id and b.mabd=c.id and a.mabn=p_mabn and a.maql=p_maql;\n";//gam 30/08/2011
                else sql += "    thuocsd cursor  (p_mabn varchar, p_maql numeric) is select a.id,a.mabn,a.mavaovien,a.maql,a.idkhoa,to_char(b.ngayylenh,'dd/mm/yyyy') as ngay, a.makhoa as makp,b.madoituong, b.mabd, case when a.loai=3 then -1*b.soluong else b.soluong end as soluong,t.giaban,t.giamua,t.gianovat, a.traituyen,b.gia_bh from " + schema + ".d_xuatsdll a, " + schema + ".d_xuatsdct b," + schema + ".d_theodoi t where a.id=b.id and b.sttt=t.id and a.mabn=p_mabn and a.maql=p_maql;\n";//gam 30/08/2011
                sql += "begin\n";
                if (bUpdtienthuoc) sql += "    open tienthuocs(d_mabn,d_maql);\n";
                sql += "    open thuocsd(d_mabn,d_maql);\n";
                sql += "    delete from " + schema + ".d_tienthuoc where mabn=d_mabn and maql=d_maql and done=0;\n";
                sql += "    loop\n";
                sql += "        fetch thuocsd into t_id,t_mabn,t_mavaovien,t_maql,t_idkhoa,t_ngay,t_makp,t_madoituong,t_mabd,t_soluong,t_giaban,t_giamua,t_gianovat,t_traituyen,t_gia_bh;\n";//gam 30/08/2011
                sql += "        if found=false then\n";
                sql += "            exit;\n";
                sql += "        end if;\n";
                sql += "        update " + schema + ".d_tienthuoc set soluong=soluong+t_soluong,giaban=t_giaban,traituyen=t_traituyen,gia_bh=t_gia_bh where mabn=t_mabn and maql=t_maql and makp=t_makp and idkhoa=t_idkhoa and mabd=t_mabd and to_char(ngay,'dd/mm/yyyy')=t_ngay and madoituong=t_madoituong and giamua=t_giamua and done=0 and id=t_id;\n";
                sql += "        if found=false then\n";
                sql += "            insert into " + schema + ".d_tienthuoc (id,mabn,mavaovien,maql,makp,idkhoa,ngay, madoituong,mabd,soluong,giaban,done,giamua,gianovat,traituyen,gia_bh)	values (t_id,t_mabn,t_mavaovien,t_maql, t_makp,t_idkhoa,to_timestamp(t_ngay,'dd/mm/yyyy'), t_madoituong, t_mabd, t_soluong,t_giaban,0,t_giamua,t_gianovat,t_traituyen,t_gia_bh);\n";
                sql += "        end if;\n";
                sql += "    end loop;\n";
                sql += "    close thuocsd;\n";
                if (bUpdtienthuoc)
                {
                    sql += "    loop\n";
                    sql += "        fetch tienthuocs into t_id,t_mabn,t_maql,t_idkhoa,t_ngay,t_makp,t_madoituong,t_mabd,t_giamua,t_done,t_idttrv,t_datra,t_gianovat,t_gia_bh;\n";
                    sql += "        if found=false then\n";
                    sql += "            exit;\n";
                    sql += "        end if;\n";
                    sql += "        update " + schema + ".d_tienthuoc set done=t_done,idttrv=t_idttrv,datra=t_datra,gia_bh=t_gia_bh where id=t_id and mabn=t_mabn and maql=t_maql and idkhoa=t_idkhoa and to_char(ngay,'dd/mm/yyyy')=t_ngay and makp=t_makp and madoituong=t_madoituong and mabd=t_mabd and giamua=t_giamua and done=0;\n";
                    sql += "    end loop;\n";
                    sql += "    close tienthuocs;\n";
                }
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;	\n";
                sql += "CREATE OR REPLACE FUNCTION  " + schema + ".upd_tienthuoc_ktcao(d_mabn varchar, d_maql numeric)\n";
                sql += " RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "DECLARE\n";
                sql += "    t_id numeric;t_mabn varchar;t_mavaovien numeric;t_maql numeric;t_idkhoa numeric;t_ngay varchar;t_makp numeric;t_madoituong numeric;t_mabd numeric;t_soluong numeric;t_giaban numeric;t_giamua numeric;t_gianovat numeric;t_gia_bh numeric;t_done numeric;t_idttrv numeric;t_datra numeric;t_traituyen numeric;t_id_ktcao numeric;\n";
                if (bUpdtienthuoc) sql += "    tienthuocs cursor (p_mabn varchar,p_maql numeric) is select id,mabn,maql, idkhoa, to_char(ngay,'dd/mm/yyyy') as ngay, makp, madoituong, mabd, giamua, done,idttrv,datra,gianovat,gia_bh,id_ktcao from " + schema + ".d_tienthuoc where  mabn=p_mabn and maql=p_maql and done=1;\n";//gam 30/08/2011
                if (bGiaban) sql += "    thuocsd cursor  (p_mabn varchar, p_maql numeric) is select a.id,a.mabn,a.mavaovien,a.maql,a.idkhoa,to_char(b.ngayylenh,'dd/mm/yyyy') as ngay, a.makp,b.madoituong, b.mabd, case when a.loai=3 then -1*b.soluong else b.soluong end as soluong,b.giaban,t.giamua,t.gianovat, a.traituyen,b.gia_bh,b.id_ktcao from " + schema + ".d_xuatsdll a, " + schema + ".d_xuatsdct b," + schema + ".d_theodoi t," + usr + ".d_dmbd c where a.id=b.id and b.sttt=t.id and b.mabd=c.id and a.mabn=p_mabn and a.maql=p_maql;\n";//Thuy 17.11.2012 sua c.giaban => b.giaban
                else sql += "    thuocsd cursor  (p_mabn varchar, p_maql numeric) is select a.id,a.mabn,a.mavaovien,a.maql,a.idkhoa,to_char(b.ngayylenh,'dd/mm/yyyy') as ngay, a.makhoa as makp,b.madoituong, b.mabd, case when a.loai=3 then -1*b.soluong else b.soluong end as soluong,t.giaban,t.giamua,t.gianovat, a.traituyen,b.gia_bh,b.id_ktcao from " + schema + ".d_xuatsdll a, " + schema + ".d_xuatsdct b," + schema + ".d_theodoi t where a.id=b.id and b.sttt=t.id and a.mabn=p_mabn and a.maql=p_maql;\n";//gam 30/08/2011
                sql += "begin\n";
                if (bUpdtienthuoc) sql += "    open tienthuocs(d_mabn,d_maql);\n";
                sql += "    open thuocsd(d_mabn,d_maql);\n";
                sql += "    delete from " + schema + ".d_tienthuoc where mabn=d_mabn and maql=d_maql and done=0;\n";
                //sql += "    update from " + schema + ".d_tienthuoc set soluong=0 where mabn=d_mabn and maql=d_maql and done=0;\n";
                sql += "    loop\n";
                sql += "        fetch thuocsd into t_id,t_mabn,t_mavaovien,t_maql,t_idkhoa,t_ngay,t_makp,t_madoituong,t_mabd,t_soluong,t_giaban,t_giamua,t_gianovat,t_traituyen,t_gia_bh,t_id_ktcao;\n";//gam 30/08/2011
                sql += "        if found=false then\n";
                sql += "            exit;\n";
                sql += "        end if;\n";
                sql += "        update " + schema + ".d_tienthuoc set soluong=soluong+t_soluong,giaban=t_giaban,traituyen=t_traituyen,gia_bh=t_gia_bh where mabn=t_mabn and maql=t_maql and makp=t_makp and idkhoa=t_idkhoa and mabd=t_mabd and to_char(ngay,'dd/mm/yyyy')=t_ngay and madoituong=t_madoituong and giamua=t_giamua and done=0 and id=t_id and id_ktcao=t_id_ktcao;\n";
                sql += "        if found=false then\n";
                sql += "            insert into " + schema + ".d_tienthuoc (id,mabn,mavaovien,maql,makp,idkhoa,ngay, madoituong,mabd,soluong,giaban,done,giamua,gianovat,traituyen,gia_bh,id_ktcao)	values (t_id,t_mabn,t_mavaovien,t_maql, t_makp,t_idkhoa,to_timestamp(t_ngay,'dd/mm/yyyy'), t_madoituong, t_mabd, t_soluong,t_giaban,0,t_giamua,t_gianovat,t_traituyen,t_gia_bh,t_id_ktcao);\n";
                sql += "        end if;\n";
                sql += "    end loop;\n";
                sql += "    close thuocsd;\n";
                if (bUpdtienthuoc)
                {
                    sql += "    loop\n";
                    sql += "        fetch tienthuocs into t_id,t_mabn,t_maql,t_idkhoa,t_ngay,t_makp,t_madoituong,t_mabd,t_giamua,t_done,t_idttrv,t_datra,t_gianovat,t_gia_bh,t_id_ktcao;\n";
                    sql += "        if found=false then\n";
                    sql += "            exit;\n";
                    sql += "        end if;\n";
                    sql += "        update " + schema + ".d_tienthuoc set done=t_done,idttrv=t_idttrv,datra=t_datra,gia_bh=t_gia_bh where id=t_id and mabn=t_mabn and maql=t_maql and idkhoa=t_idkhoa and to_char(ngay,'dd/mm/yyyy')=t_ngay and makp=t_makp and madoituong=t_madoituong and mabd=t_mabd and giamua=t_giamua and done=0 and id_ktcao=t_id_ktcao;\n";
                    sql += "    end loop;\n";
                    sql += "    close tienthuocs;\n";
                }
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;	\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_tontutruc(d_nhom numeric,d_makp numeric)\n";
                sql += " RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "DECLARE\n";
                sql += " d_makho numeric;d_mabd numeric;d_tondau numeric;d_slnhap numeric;d_slxuat numeric;d_manguon numeric;\n";
                sql += " cur_tutruc cursor (p_nhom numeric,p_makp numeric) is select a.makho,a.mabd,sum(a.tondau) as tondau,sum(a.slnhap) as slnhap,sum(a.slxuat) as slxuat,t.manguon from " + schema + ".d_tutrucct a," + schema + ".d_theodoi t where a.stt=t.id and a.makp=p_makp and a.makho in (select id from " + user + ".d_dmkho where nhom=p_nhom) group by a.makho,a.mabd,t.manguon;\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_tutructh set tondau=0,slnhap=0,slxuat=0 where makp=d_makp and makho in (select id from " + user + ".d_dmkho where nhom=d_nhom);\n";
                sql += "    open cur_tutruc(d_nhom,d_makp);\n";
                sql += "    loop\n";
                sql += "        fetch cur_tutruc into d_makho,d_mabd,d_tondau,d_slnhap,d_slxuat,d_manguon;\n";
                sql += "        if found=false then\n";
                sql += "            exit;\n";
                sql += "        end if;\n";
                sql += "        update " + schema + ".d_tutructh set tondau=tondau+d_tondau,slnhap=slnhap+d_slnhap,slxuat=slxuat+d_slxuat where makp=d_makp and makho=d_makho and mabd=d_mabd and manguon=d_manguon;\n";
                sql += "        if found=false then\n";
                sql += "            insert into " + schema + ".d_tutructh(makp,makho,mabd,tondau,slnhap,slxuat,manguon) values (d_makp,d_makho,d_mabd,d_tondau,d_slnhap,d_slxuat,d_manguon);\n";
                sql += "        end if;\n";
                sql += "    end loop;\n";
                sql += "    close cur_tutruc;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_slnhap(d_nhom numeric)\n";
                sql += " RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "DECLARE\n";
                sql += "    d_id numeric;d_makho numeric;d_stt numeric;d_sttn numeric;d_mabd numeric;d_soluong numeric;\n";
                sql += "    cur_ll cursor (p_nhom numeric) is select id,makho from " + schema + ".d_nhapll where nhom=p_nhom;\n";
                sql += "    cur_ct cursor (p_id numeric) is select stt,mabd,soluong from " + schema + ".d_nhapct where id=p_id;\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_tonkhoct set slnhap=0 where idn<>0 and makho in (select id from " + user + ".d_dmkho where nhom=d_nhom);\n";
                sql += "    open cur_ll(d_nhom);\n";
                sql += "    loop\n";
                sql += "        fetch cur_ll into d_id,d_makho;\n";
                sql += "        if found=false then\n";
                sql += "            exit;\n";
                sql += "        end if;\n";
                sql += "        open cur_ct(d_id);\n";
                sql += "        loop\n";
                sql += "            fetch cur_ct into d_sttn,d_mabd,d_soluong;\n";
                sql += "            if found=false then\n";
                sql += "                exit;\n";
                sql += "            end if;\n";
                sql += "            update " + schema + ".d_tonkhoct set slnhap=slnhap+d_soluong,mabd=d_mabd where idn=d_id and sttn=d_sttn and makho=d_makho;\n";
                sql += "            if found=false then\n";
                sql += "                update " + user + ".d_capid set id=id+1 where ma=9;\n";
                sql += "                select id into d_stt from " + user + ".d_capid where ma=9;\n";
                sql += "                insert into " + schema + ".d_tonkhoct(makho,stt,idn,sttn,mabd,tondau,slnhap,slxuat) values (d_makho,d_stt,d_id,d_sttn,d_mabd,0,d_soluong,0);\n";
                sql += "            end if;	\n";
                sql += "        end loop;\n";
                sql += "        close cur_ct;\n";
                sql += "    end loop;\n";
                sql += "    close cur_ll;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_benhancc(m_mabn varchar,m_mavaovien numeric,m_maql numeric,m_makp varchar,m_ngay varchar,m_dentu numeric,m_nhantu numeric,m_madoituong numeric,m_chandoan text,m_maicd varchar,m_sovaovien varchar,m_userid numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".benhancc set mabn=m_mabn,mavaovien=m_mavaovien,makp=m_makp,ngay=to_timestamp(m_ngay,'dd/mm/yyyy hh24:mi'),dentu=m_dentu,nhantu=m_nhantu,madoituong=m_madoituong,chandoan=m_chandoan,maicd=m_maicd,sovaovien=m_sovaovien,userid=m_userid where maql=m_maql;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".benhancc(mabn,mavaovien,maql,makp,ngay,dentu,nhantu,madoituong,chandoan,maicd,sovaovien,userid) values (m_mabn,m_mavaovien,m_maql,m_makp,to_timestamp(m_ngay,'dd/mm/yyyy hh24:mi'),m_dentu,m_nhantu,m_madoituong,m_chandoan,m_maicd,m_sovaovien,m_userid);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_benhancc(m_mabn varchar,m_mavaovien numeric,m_maql numeric,m_makp varchar,m_ngay varchar,m_dentu numeric,m_nhantu numeric,m_madoituong numeric,m_mabsnb varchar,m_chandoan text,m_maicd varchar,m_sovaovien varchar,m_userid numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".benhancc set mabn=m_mabn,mavaovien=m_mavaovien,makp=m_makp,ngay=to_timestamp(m_ngay,'dd/mm/yyyy hh24:mi'),dentu=m_dentu,nhantu=m_nhantu,madoituong=m_madoituong,mabsnb=m_mabsnb,chandoan=m_chandoan,maicd=m_maicd,sovaovien=m_sovaovien,userid=m_userid where maql=m_maql;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".benhancc(mabn,mavaovien,maql,makp,ngay,dentu,nhantu,madoituong,mabsnb,chandoan,maicd,sovaovien,userid) values (m_mabn,m_mavaovien,m_maql,m_makp,to_timestamp(m_ngay,'dd/mm/yyyy hh24:mi'),m_dentu,m_nhantu,m_madoituong,m_mabsnb,m_chandoan,m_maicd,m_sovaovien,m_userid);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_benhancc(m_maql numeric,m_ngayrv varchar,m_ketqua numeric,m_ttlucrv numeric,m_chandoanrv text,m_maicdrv varchar,m_mabs varchar,m_bienchung numeric,m_taibien numeric,m_giaiphau numeric,m_soluutru varchar,m_giuong varchar)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".benhancc set ngayrv=to_timestamp(m_ngayrv,'dd/mm/yyyy hh24:mi'),ketqua=m_ketqua,ttlucrv=m_ttlucrv,chandoanrv=m_chandoanrv,maicdrv=m_maicdrv,mabs=m_mabs,bienchung=m_bienchung,taibien=m_taibien,giaiphau=m_giaiphau,soluutru=m_soluutru,giuong=m_giuong where maql=m_maql;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_huybienlai(v_id numeric,v_tables varchar,v_loai numeric,v_mabn varchar,v_hoten text,v_makp varchar,v_ngay varchar,v_quyenso numeric,v_sobienlai numeric,v_lydo text,v_userid numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".v_huybienlai set loai=v_loai,mabn=v_mabn,hoten=v_hoten,makp=v_makp,ngay=to_timestamp(v_ngay,'dd/mm/yyyy'),quyenso=v_quyenso,sobienlai=v_sobienlai,lydo=v_lydo,userid=v_userid where id=v_id and tables=v_tables;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".v_huybienlai(id,tables,loai,mabn,hoten,makp,ngay,quyenso,sobienlai,lydo,userid) values (v_id,v_tables,v_loai,v_mabn,v_hoten,v_makp,to_timestamp(v_ngay,'dd/mm/yyyy'),v_quyenso,v_sobienlai,v_lydo,v_userid);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_nhom(v_id numeric,v_ma numeric,v_sotien numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".v_nhom set sotien=v_sotien where id=v_id and ma=v_ma;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".v_nhom(id,ma,sotien) values (v_id,v_ma,v_sotien);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_trongoi(v_id numeric,v_sotien numeric,v_tamung numeric,v_hoantra numeric,v_pm numeric,v_yc numeric,v_ghichu text)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".v_trongoi set sotien=v_sotien,tamung=v_tamung,hoantra=v_hoantra,pm=v_pm,yc=v_yc,ghichu=v_ghichu where id=v_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".v_trongoi(id,sotien,tamung,hoantra,pm,yc,ghichu) values (v_id,v_sotien,v_tamung,v_hoantra,v_pm,v_yc,v_ghichu);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_hoantra(v_id numeric,v_quyenso numeric,v_sobienlai numeric,v_ngay varchar,v_mabn varchar,v_hoten text,v_makp varchar,v_sotien numeric,v_ghichu text,v_userid numeric,v_loai numeric,v_loaibn numeric,v_ngaythu varchar)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".v_hoantra set quyenso=v_quyenso,sobienlai=v_sobienlai,ngay=to_timestamp(v_ngay,'dd/mm/yyyy hh24:mi'),mabn=v_mabn,hoten=v_hoten,makp=v_makp,sotien=v_sotien,ghichu=v_ghichu,userid=v_userid,loai=v_loai,loaibn=v_loaibn,ngayud=to_timestamp(v_ngaythu,'dd/mm/yyyy hh24:mi') where id=v_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".v_hoantra(id,quyenso,sobienlai,ngay,mabn,hoten,makp,sotien,ghichu,userid,loai,loaibn,ngayud) values (v_id,v_quyenso,v_sobienlai,to_timestamp(v_ngay,'dd/mm/yyyy hh24:mi'),v_mabn,v_hoten,v_makp,v_sotien,v_ghichu,v_userid,v_loai,v_loaibn,to_timestamp(v_ngaythu,'dd/mm/yyyy hh24:mi'));\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_tamung(v_id numeric,v_mabn varchar,v_mavaovien numeric,v_maql numeric,v_idkhoa numeric,v_quyenso numeric,v_sobienlai numeric,v_ngay varchar,v_loai numeric,v_loaibn numeric,v_makp varchar,v_madoituong numeric,v_sotien numeric,v_userid numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".v_tamung set mabn=v_mabn,mavaovien=v_mavaovien,maql=v_maql,idkhoa=v_idkhoa,quyenso=v_quyenso,sobienlai=v_sobienlai,ngay=to_timestamp(v_ngay,'dd/mm/yyyy hh24:mi'),loai=v_loai,loaibn=v_loaibn,makp=v_makp,madoituong=v_madoituong,sotien=v_sotien,userid=v_userid where id=v_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".v_tamung(id,mabn,mavaovien,maql,idkhoa,quyenso,sobienlai,ngay,loai,loaibn,makp,madoituong,sotien,userid) values (v_id,v_mabn,v_mavaovien,v_maql,v_idkhoa,v_quyenso,v_sobienlai,to_timestamp(v_ngay,'dd/mm/yyyy hh24:mi'),v_loai,v_loaibn,v_makp,v_madoituong,v_sotien,v_userid);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_tamungcd(v_id numeric,v_mabn varchar,v_mavaovien numeric,v_maql numeric,v_idkhoa numeric,v_makp varchar,v_ngay varchar,v_madoituong numeric,v_loai numeric,v_loaibn numeric,v_ten text,v_sotien numeric,v_userid numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".v_tamungcd set mabn=v_mabn,mavaovien=v_mavaovien,maql=v_maql,idkhoa=v_idkhoa,ngay=to_timestamp(v_ngay,'dd/mm/yyyy hh24:mi'),loai=v_loai,loaibn=v_loaibn,makp=v_makp,madoituong=v_madoituong,ten=v_ten,sotien=v_sotien,userid=v_userid where id=v_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".v_tamungcd(id,mabn,mavaovien,maql,idkhoa,ngay,loai,loaibn,makp,madoituong,ten,sotien,userid) values (v_id,v_mabn,v_mavaovien,v_maql,v_idkhoa,to_timestamp(v_ngay,'dd/mm/yyyy hh24:mi'),v_loai,v_loaibn,v_makp,v_madoituong,v_ten,v_sotien,v_userid);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_ttrvll(v_id numeric,v_loaibn numeric,v_loai numeric,v_quyenso numeric,v_sobienlai numeric,v_ngay varchar,v_makp varchar,v_sotien numeric,v_tamung numeric,v_mien numeric,v_bhyt numeric,v_nopthem numeric,v_thieu numeric,v_vattu numeric,v_chenhlech numeric,v_userid numeric,v_idtonghop numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".v_ttrvll set loaibn=v_loaibn,loai=v_loai,quyenso=v_quyenso,sobienlai=v_sobienlai,ngay=to_timestamp(v_ngay,'dd/mm/yyyy hh24:mi'),makp=v_makp,sotien=v_sotien,tamung=v_tamung,mien=v_mien,bhyt=v_bhyt,nopthem=v_nopthem,thieu=v_thieu,vattu=v_vattu,chenhlech=v_chenhlech,userid=v_userid,idtonghop=v_idtonghop where id=v_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".v_ttrvll(id,loaibn,loai,quyenso,sobienlai,ngay,makp,sotien,tamung,mien,bhyt,nopthem,thieu,vattu,chenhlech,userid,idtonghop) values (v_id,v_loaibn,v_loai,v_quyenso,v_sobienlai,to_timestamp(v_ngay,'dd/mm/yyyy hh24:mi'),v_makp,v_sotien,v_tamung,v_mien,v_bhyt,v_nopthem,v_thieu,v_vattu,v_chenhlech,v_userid,v_idtonghop);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_ttrvct(v_id numeric,v_stt numeric,v_ngay varchar,v_makp varchar,v_madoituong numeric,v_mavp numeric,v_soluong numeric,v_dongia numeric,v_vat numeric,v_vattu numeric,v_sotien numeric,v_sothe varchar)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".v_ttrvct set ngay=to_timestamp(v_ngay,'dd/mm/yyyy'),makp=v_makp,madoituong=v_madoituong,mavp=v_mavp,soluong=v_soluong,dongia=v_dongia,vat=v_vat,vattu=v_vattu,sotien=v_sotien,sothe=v_sothe where id=v_id and stt=v_stt;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".v_ttrvct(id,stt,ngay,makp,madoituong,mavp,soluong,dongia,vat,vattu,sotien,sothe) values (v_id,v_stt,to_timestamp(v_ngay,'dd/mm/yyyy'),v_makp,v_madoituong,v_mavp,v_soluong,v_dongia,v_vat,v_vattu,v_sotien,v_sothe);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_ttrvds(v_id numeric,v_mabn varchar,v_mavaovien numeric,v_maql numeric,v_idkhoa numeric,v_giuong varchar,v_ngayvao varchar,v_ngayra varchar,v_chandoan text,v_maicd varchar)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".v_ttrvds set mabn=v_mabn,mavaovien=v_mavaovien,maql=v_maql,idkhoa=v_idkhoa,giuong=v_giuong,ngayvao=to_timestamp(v_ngayvao,'dd/mm/yyyy hh24:mi'),ngayra=to_timestamp(v_ngayra,'dd/mm/yyyy hh24:mi'),chandoan=v_chandoan,maicd=v_maicd where id=v_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".v_ttrvds(id,mabn,mavaovien,maql,idkhoa,giuong,ngayvao,ngayra,chandoan,maicd) values (v_id,v_mabn,v_mavaovien,v_maql,v_idkhoa,v_giuong,to_timestamp(v_ngayvao,'dd/mm/yyyy hh24:mi'),to_timestamp(v_ngayra,'dd/mm/yyyy hh24:mi'),v_chandoan,v_maicd);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_ttrvbhyt(v_id numeric,v_sothe varchar,v_maphu numeric,v_tungay varchar,v_ngay varchar,v_mabv varchar,v_noigioithieu varchar)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".v_ttrvbhyt set sothe=v_sothe,maphu=v_maphu,tungay=to_timestamp(v_tungay,'dd/mm/yyyy'),ngay=to_timestamp(v_ngay,'dd/mm/yyyy'),mabv=v_mabv,noigioithieu=v_noigioithieu where id=v_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".v_ttrvbhyt(id,sothe,maphu,tungay,ngay,mabv,noigioithieu) values (v_id,v_sothe,v_maphu,to_timestamp(v_tungay,'dd/mm/yyyy'),to_timestamp(v_ngay,'dd/mm/yyyy'),v_mabv,v_noigioithieu);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_ttrvbhyt(v_id numeric,v_sothe varchar,v_maphu numeric,v_tungay varchar,v_ngay varchar,v_mabv varchar,v_noigioithieu varchar,v_traituyen numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".v_ttrvbhyt set sothe=v_sothe,maphu=v_maphu,tungay=to_timestamp(v_tungay,'dd/mm/yyyy'),ngay=to_timestamp(v_ngay,'dd/mm/yyyy'),mabv=v_mabv,noigioithieu=v_noigioithieu,traituyen=v_traituyen where id=v_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".v_ttrvbhyt(id,sothe,maphu,tungay,ngay,mabv,noigioithieu,traituyen) values (v_id,v_sothe,v_maphu,to_timestamp(v_tungay,'dd/mm/yyyy'),to_timestamp(v_ngay,'dd/mm/yyyy'),v_mabv,v_noigioithieu,v_traituyen);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_phieuchill(v_id numeric,v_quyenso numeric,v_sobienlai numeric,v_ngay varchar,v_mabn varchar,v_maql numeric,v_idkhoa numeric,v_makp varchar,v_hoten text,v_loai numeric,v_loaibn numeric,v_userid numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".v_phieuchill set quyenso=v_quyenso,sobienlai=v_sobienlai,ngay=to_timestamp(v_ngay,'dd/mm/yyyy hh24:mi'),mabn=v_mabn,maql=v_maql,idkhoa=v_idkhoa,makp=v_makp,hoten=v_hoten,loai=v_loai,loaibn=v_loaibn,userid=v_userid where id=v_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".v_phieuchill(id,quyenso,sobienlai,ngay,mabn,maql,idkhoa,makp,hoten,loai,loaibn,userid) values (v_id,v_quyenso,v_sobienlai,to_timestamp(v_ngay,'dd/mm/yyyy hh24:mi'),v_mabn,v_maql,v_idkhoa,v_makp,v_hoten,v_loai,v_loaibn,v_userid);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_phieuchict(v_id numeric,v_stt numeric,v_mavp numeric,v_sotien numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".v_phieuchict set mavp=v_mavp,sotien=v_sotien where id=v_id and stt=v_stt;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".v_phieuchict(id,stt,mavp,sotien) values (v_id,v_stt,v_mavp,v_sotien);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_tamungct(v_id numeric,v_loaivp numeric,v_sotien numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".v_tamungct set sotien=v_sotien where id=v_id and loaivp=v_loaivp;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".v_tamungct(id,loaivp,sotien) values (v_id,v_loaivp,v_sotien);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_hoantract(v_id numeric,v_loaivp numeric,v_sotien numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".v_hoantract set sotien=v_sotien where id=v_id and loaivp=v_loaivp;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".v_hoantract(id,loaivp,sotien) values (v_id,v_loaivp,v_sotien);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_thvpll(v_id numeric,v_mabn varchar,v_mavaovien numeric,v_maql numeric,v_idkhoa numeric,v_ngayvao varchar,v_ngayra varchar,v_giuong varchar,v_makp varchar,v_chandoan text,v_maicd varchar,v_sotien numeric,v_tamung numeric,v_bhyt numeric,v_mien numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".v_thvpll set mabn=v_mabn,mavaovien=v_mavaovien,maql=v_maql,idkhoa=v_idkhoa,ngayvao=to_timestamp(v_ngayvao,'dd/mm/yyyy hh24:mi'),ngayra=to_timestamp(v_ngayra,'dd/mm/yyyy hh24:mi'),giuong=v_giuong,makp=v_makp,chandoan=v_chandoan,maicd=v_maicd,sotien=v_sotien,tamung=v_tamung,bhyt=v_bhyt,mien=v_mien where id=v_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".v_thvpll(id,mabn,mavaovien,maql,idkhoa,ngayvao,ngayra,giuong,makp,chandoan,maicd,sotien,tamung,bhyt,mien,done) values (v_id,v_mabn,v_mavaovien,v_maql,v_idkhoa,to_timestamp(v_ngayvao,'dd/mm/yyyy hh24:mi'),to_timestamp(v_ngayra,'dd/mm/yyyy hh24:mi'),v_giuong,v_makp,v_chandoan,v_maicd,v_sotien,v_tamung,v_bhyt,v_mien,0);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_thvpct(v_id numeric,v_ngay varchar,v_makp varchar,v_madoituong numeric,v_mavp numeric,v_soluong numeric,v_dongia numeric,v_sotien numeric,v_vattu numeric,v_sothe varchar)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".v_thvpct set soluong=soluong+v_soluong,sotien=sotien+v_sotien,vattu=v_vattu where id=v_id and to_char(ngay,'dd/mm/yyyy')=v_ngay and makp=v_makp and madoituong=v_madoituong and mavp=v_mavp and dongia=v_dongia;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".v_thvpct(id,ngay,makp,madoituong,mavp,soluong,dongia,sotien,vattu,sothe) values (v_id,to_timestamp(v_ngay,'dd/mm/yyyy'),v_makp,v_madoituong,v_mavp,v_soluong,v_dongia,v_sotien,v_vattu,v_sothe);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_thvpct(v_id numeric,v_ngay varchar,v_makp varchar,v_madoituong numeric,v_mavp numeric,v_soluong numeric,v_dongia numeric,v_sotien numeric,v_vattu numeric,v_sothe varchar, v_traituyen numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".v_thvpct set soluong=soluong+v_soluong,sotien=sotien+v_sotien,vattu=v_vattu, traituyen=v_traituyen where id=v_id and to_char(ngay,'dd/mm/yyyy')=v_ngay and makp=v_makp and madoituong=v_madoituong and mavp=v_mavp and dongia=v_dongia;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".v_thvpct(id,ngay,makp,madoituong,mavp,soluong,dongia,sotien,vattu,sothe, traituyen) values (v_id,to_timestamp(v_ngay,'dd/mm/yyyy'),v_makp,v_madoituong,v_mavp,v_soluong,v_dongia,v_sotien,v_vattu,v_sothe,v_traituyen);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_thvpbhyt(v_id numeric,v_sothe varchar,v_maphu numeric,v_noigioithieu varchar,v_noicap varchar)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".v_thvpbhyt set sothe=v_sothe,maphu=v_maphu,noigioithieu=v_noigioithieu,noicap=v_noicap where id=v_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".v_thvpbhyt(id,sothe,maphu,noigioithieu,noicap) values (v_id,v_sothe,v_maphu,v_noigioithieu,v_noicap);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_thvpbhyt(v_id numeric,v_sothe varchar,v_maphu numeric,v_noigioithieu varchar,v_noicap varchar,v_traituyen numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".v_thvpbhyt set sothe=v_sothe,maphu=v_maphu,noigioithieu=v_noigioithieu,noicap=v_noicap,traituyen=v_traituyen where id=v_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".v_thvpbhyt(id,sothe,maphu,noigioithieu,noicap,traituyen) values (v_id,v_sothe,v_maphu,v_noigioithieu,v_noicap,v_traituyen);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_ttrvnhom(v_id numeric,v_ma numeric,v_sotien numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".v_ttrvnhom set sotien=v_sotien where id=v_id and ma=v_ma;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".v_ttrvnhom(id,ma,sotien) values (v_id,v_ma,v_sotien);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_ttrvpttt(v_id numeric,v_ngay varchar,v_songay_tpt numeric,v_songay_spt numeric,v_mavp numeric,v_tenpt text,v_so numeric,v_loaipt numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".v_ttrvpttt set ngay=to_timestamp(v_ngay,'dd/mm/yyyy'),songay_tpt=v_songay_tpt,songay_spt=v_songay_spt,mavp=v_mavp,tenpt=v_tenpt,so=v_so,loaipt=v_loaipt where id=v_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".v_ttrvpttt(id,ngay,songay_tpt,songay_spt,mavp,tenpt,so,loaipt) values (v_id,to_timestamp(v_ngay,'dd/mm/yyyy'),v_songay_tpt,v_songay_spt,v_mavp,v_tenpt,v_so,v_loaipt);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_ttrvptttct(v_id numeric,v_stt numeric,v_loaipt numeric,v_songay numeric,v_dongia numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".v_ttrvptttct set loaipt=v_loaipt,songay=v_songay,dongia=v_dongia where id=v_id and stt=v_stt;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".v_ttrvptttct(id,stt,loaipt,songay,dongia) values (v_id,v_stt,v_loaipt,v_songay,v_dongia);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_giuong(v_id numeric,v_mavp numeric,v_ngay varchar,v_dongia numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".v_giuong set dongia=v_dongia where id=v_id and mavp=v_mavp and to_char(ngay,'dd/mm/yyyy')=v_ngay;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".v_giuong(id,mavp,ngay,dongia) values (v_id,v_mavp,to_timestamp(v_ngay,'dd/mm/yyyy'),v_dongia);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_thngayll(v_id numeric,v_madoituong numeric,v_mabn varchar,v_maql numeric,v_ngayvao varchar,v_tu varchar,v_den varchar,v_giuong varchar,v_makp varchar)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".v_thngayll set madoituong=v_madoituong,mabn=v_mabn,maql=v_maql,ngayvao=to_timestamp(v_ngayvao,'dd/mm/yyyy'),tu=to_timestamp(v_tu,'dd/mm/yyyy'),den=to_timestamp(v_den,'dd/mm/yyyy'),giuong=v_giuong,makp=v_makp where id=v_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".v_thngayll(id,madoituong,mabn,maql,ngayvao,tu,den,giuong,makp,done) values (v_id,v_madoituong,v_mabn,v_maql,to_timestamp(v_ngayvao,'dd/mm/yyyy'),to_timestamp(v_tu,'dd/mm/yyyy'),to_timestamp(v_den,'dd/mm/yyyy'),v_giuong,v_makp,0);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_thngayct(v_id numeric,v_ngay varchar,v_mavp numeric,v_soluong numeric,v_dongia numeric,v_sotien numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".v_thngayct set soluong=soluong+v_soluong,sotien=sotien+v_sotien where id=v_id and to_char(ngay,'dd/mm/yyyy')=v_ngay and mavp=v_mavp and dongia=v_dongia;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".v_thngayct(id,ngay,mavp,soluong,dongia,sotien) values (v_id,to_timestamp(v_ngay,'dd/mm/yyyy'),v_mavp,v_soluong,v_dongia,v_sotien);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_daduyet(d_nhom numeric,d_ngay varchar,d_makp numeric,d_loai numeric,d_phieu numeric,d_makho numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_daduyet set nhom=d_nhom where nhom=d_nhom and to_char(ngay,'dd/mm/yyyy')=d_ngay and makp=d_makp and loai=d_loai and phieu=d_phieu and makho=d_makho;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_daduyet(nhom,ngay,makp,loai,phieu,makho) values (d_nhom,to_timestamp(d_ngay,'dd/mm/yyyy'),d_makp,d_loai,d_phieu,d_makho);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_daduyet(d_nhom numeric,d_ngay varchar,d_makp numeric,d_loai numeric,d_phieu numeric,d_makho numeric,d_duyettreole numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_daduyet set duyettreole=d_duyettreole where nhom=d_nhom and to_char(ngay,'dd/mm/yyyy')=d_ngay and makp=d_makp and loai=d_loai and phieu=d_phieu and makho=d_makho;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_daduyet(nhom,ngay,makp,loai,phieu,makho,duyettreole) values (d_nhom,to_timestamp(d_ngay,'dd/mm/yyyy'),d_makp,d_loai,d_phieu,d_makho,d_duyettreole);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_sophieu(d_nhom numeric,d_ngay varchar,d_makp numeric,d_loai numeric,d_phieu numeric,d_loaiin numeric,d_makho numeric,d_madoituong varchar,d_manguon varchar,d_nguoilinh text)\n";
                sql += " RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "DECLARE\n";
                sql += "    d_so numeric;\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_sophieu set lanin=lanin+1,nguoilinh=d_nguoilinh where nhom=d_nhom and to_char(ngay,'dd/mm/yyyy')=d_ngay and makp=d_makp and loai=d_loai and phieu=d_phieu and loaiin=d_loaiin and makho=d_makho and madoituong=d_madoituong and manguon=d_manguon;\n";
                sql += "    if found=false then	\n";
                sql += "        select max(so) into d_so from " + schema + ".d_sophieu where nhom=d_nhom and makp=d_makp and loai=d_loai and loaiin=d_loaiin and makho=d_makho and madoituong=d_madoituong and manguon=d_manguon;\n";
                sql += "        if d_so is null then\n";
                sql += "            d_so:=0;\n";
                sql += "        end if;\n";
                sql += "        d_so:=d_so+1;\n";
                sql += "        insert into " + schema + ".d_sophieu(nhom,ngay,makp,loai,phieu,loaiin,makho,madoituong,so,manguon,nguoilinh) values (d_nhom,to_timestamp(d_ngay,'dd/mm/yyyy'),d_makp,d_loai,d_phieu,d_loaiin,d_makho,d_madoituong,d_so,d_manguon,d_nguoilinh);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_ng_vienphill(v_id numeric,v_loai numeric,v_quyenso numeric,v_sobienlai numeric,v_ngay varchar,v_mabn varchar,v_hoten text,v_masothue in varchar,v_userid numeric)\n";
                sql += "    RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".ng_vienphill set loai=v_loai,quyenso=v_quyenso,sobienlai=v_sobienlai,ngay=to_timestamp(v_ngay,'dd/mm/yyyy hh24:mi'),mabn=v_mabn,hoten=v_hoten,masothue=v_masothue,userid=v_userid where id=v_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".ng_vienphill(id,loai,quyenso,sobienlai,ngay,mabn,hoten,masothue,userid) values (v_id,v_loai,v_quyenso,v_sobienlai,to_timestamp(v_ngay,'dd/mm/yyyy hh24:mi'),v_mabn,v_hoten,v_masothue,v_userid);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_ng_vienphict(v_id numeric,v_idll numeric,v_mavp numeric,v_ten text,v_soluong numeric,v_dongia numeric,v_sotiennop numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".ng_vienphict set mavp=v_mavp,ten=v_ten,soluong=v_soluong,dongia=v_dongia,sotiennop=v_sotiennop  where id=v_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".ng_vienphict(id,idll,mavp,ten,soluong,dongia,sotiennop) values (v_id,v_idll,v_mavp,v_ten,v_soluong,v_dongia,v_sotiennop);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_ng_chia(v_id numeric,v_manv numeric,v_sotien numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".ng_chia set sotien=v_sotien  where id=v_id and manv=v_manv;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".ng_chia(id,manv,sotien) values (v_id,v_manv,v_sotien);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_ng_huybienlai(v_id numeric,v_tables varchar,v_loai numeric,v_mabn varchar,v_hoten text,v_makp varchar,v_ngay varchar,v_quyenso numeric,v_sobienlai numeric,v_lydo text,v_userid numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".ng_huybienlai set loai=v_loai,mabn=v_mabn,hoten=v_hoten,makp=v_makp,ngay=to_timestamp(v_ngay,'dd/mm/yyyy'),quyenso=v_quyenso,sobienlai=v_sobienlai,lydo=v_lydo,userid=v_userid where id=v_id and tables=v_tables;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".ng_huybienlai(id,tables,loai,mabn,hoten,makp,ngay,quyenso,sobienlai,lydo,userid) values (v_id,v_tables,v_loai,v_mabn,v_hoten,v_makp,to_timestamp(v_ngay,'dd/mm/yyyy'),v_quyenso,v_sobienlai,v_lydo,v_userid);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_ng_hoantra(v_id numeric,v_quyenso numeric,v_sobienlai numeric,v_ngay varchar,v_mabn varchar,v_hoten text,v_makp varchar,v_sotien numeric,v_ghichu text,v_userid numeric,v_loai numeric,v_loaibn numeric,v_ngaythu varchar)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".ng_hoantra set quyenso=v_quyenso,sobienlai=v_sobienlai,ngay=to_timestamp(v_ngay,'dd/mm/yyyy hh24:mi'),mabn=v_mabn,hoten=v_hoten,makp=v_makp,sotien=v_sotien,ghichu=v_ghichu,userid=v_userid,loai=v_loai,loaibn=v_loaibn,ngayud=to_timestamp(v_ngaythu,'dd/mm/yyyy hh24:mi') where id=v_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".ng_hoantra(id,quyenso,sobienlai,ngay,mabn,hoten,makp,sotien,ghichu,userid,loai,loaibn,ngayud) values (v_id,v_quyenso,v_sobienlai,to_timestamp(v_ngay,'dd/mm/yyyy hh24:mi'),v_mabn,v_hoten,v_makp,v_sotien,v_ghichu,v_userid,v_loai,v_loaibn,to_timestamp(v_ngaythu,'dd/mm/yyyy hh24:mi'));\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_ng_hoantract(v_id numeric,v_loaivp numeric,v_sotien numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".ng_hoantract set sotien=v_sotien where id=v_id and loaivp=v_loaivp;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".ng_hoantract(id,loaivp,sotien) values (v_id,v_loaivp,v_sotien);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_ng_tiencong(v_ngay varchar,v_idct numeric,v_mavp numeric,v_idnv numeric,v_soluong numeric,v_phan numeric,v_sotien numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".ng_tiencong set soluong=v_soluong,phan=v_phan,sotien=v_sotien  where to_char(ngay,'dd/mm/yyyy')=v_ngay and idct=v_idct and mavp=v_mavp and idnv=v_idnv;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".ng_tiencong(ngay,idct,mavp,idnv,soluong,phan,sotien) values (to_timestamp(v_ngay,'dd/mm/yyyy'),v_idct,v_mavp,v_idnv,v_soluong,v_phan,v_sotien);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_eve_tables(m_tableid numeric,m_ngay varchar,m_userid numeric,m_computerid numeric,m_ins numeric,m_upd numeric,m_del numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".eve_tables set ins=ins+m_ins,upd=upd+m_upd,del=del+m_del where tableid=m_tableid and to_char(ngay,'dd/mm/yyyy')=m_ngay and userid=m_userid and computerid=m_computerid;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".eve_tables(tableid,ngay,userid,computerid,ins,upd,del) values (m_tableid,to_timestamp(m_ngay,'dd/mm/yyyy'),m_userid,m_computerid,m_ins,m_upd,m_del);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_eve_upd_del(m_tableid numeric,m_userid numeric,m_computerid numeric,m_command varchar,m_noidung text)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    insert into " + schema + ".eve_upd_del(tableid,userid,computerid,command,noidung) values (m_tableid,m_userid,m_computerid,m_command,m_noidung);\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_ng_khamll(v_id numeric,v_ngay varchar, v_userid numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".ng_khamll set ngay=to_timestamp(v_ngay,'dd/mm/yyyy hh24:mi'),userid=v_userid where id=v_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".ng_khamll(id,ngay,userid) values (v_id,to_timestamp(v_ngay,'dd/mm/yyyy hh24:mi'),v_userid);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_ng_khamct(v_id numeric,v_kyhieu varchar,v_tu numeric,v_den numeric,v_mavp numeric,v_soluong numeric,v_dongia numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".ng_khamct set kyhieu=v_kyhieu,tu=v_tu,den=v_den,soluong=v_soluong,dongia=v_dongia where id=v_id and mavp=v_mavp;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".ng_khamct(id,kyhieu,tu,den,mavp,soluong,dongia) values (v_id,v_kyhieu,v_tu,v_den,v_mavp,v_soluong,v_dongia);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_inchiphipk(m_mabn varchar,m_mavaovien numeric,m_ngay varchar,m_makp varchar)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".inchiphipk set mabn=m_mabn,ngay=to_timestamp(m_ngay,'dd/mm/yyyy hh24:mi'),makp=m_makp,lan=lan+1 where mavaovien=m_mavaovien;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".inchiphipk(mabn,mavaovien,ngay,makp,lan) values (m_mabn,m_mavaovien,to_timestamp(m_ngay,'dd/mm/yyyy hh24:mi'),m_makp,1);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE;\n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_htrathuocll(d_id numeric,d_nhom numeric,d_ngay varchar,d_mabn varchar,d_mavaovien numeric,d_maql numeric,d_madoituong numeric,d_makp varchar,d_mabs varchar,d_loaiba numeric,d_ghichu text,d_userid numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_htrathuocll set nhom=d_nhom,ngay=to_timestamp(d_ngay,'dd/mm/yyyy'),mabn=d_mabn,mavaovien=d_mavaovien,maql=d_maql,userid=d_userid,madoituong=d_madoituong,ghichu=d_ghichu,makp=d_makp,mabs=d_mabs,loaiba=d_loaiba where id=d_id;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_htrathuocll(id,nhom,ngay,mabn,mavaovien,maql,madoituong,makp,mabs,loaiba,ghichu,userid) values (d_id,d_nhom,to_timestamp(d_ngay,'dd/mm/yyyy'),d_mabn,d_mavaovien,d_maql,d_madoituong,d_ghichu,d_songay,d_makp,d_mabs,d_loaiba,d_ghichu,d_userid);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE; \n";
                sql += "CREATE OR REPLACE FUNCTION " + schema + ".upd_htrathuocct(d_id numeric,d_stt numeric,d_sttt numeric,d_ngay varchar,d_makho numeric,d_mabd numeric,d_soluong numeric,d_giaban numeric)\n";
                sql += "  RETURNS void AS\n";
                sql += "$BODY$\n";
                sql += "begin\n";
                sql += "    update " + schema + ".d_htrathuocct set sttt=d_sttt,ngay=to_timestamp(d_ngay,'dd/mm/yyyy'),makho=d_makho,mabd=d_mabd,soluong=d_soluong,giaban=d_giaban where id=d_id and stt=d_stt;\n";
                sql += "    if found=false then\n";
                sql += "        insert into " + schema + ".d_htrathuocct(id,stt,sttt,ngay,makho,mabd,soluong,giaban) values (d_id,d_stt,d_sttt,to_timestamp(d_ngay,'dd/mm/yyyy'),d_makho,d_mabd,d_soluong,d_giaban);\n";
                sql += "    end if;\n";
                sql += "end;\n";
                sql += "$BODY$\n";
                sql += "  LANGUAGE 'plpgsql' VOLATILE; \n";
                execute_data(sql);
                string tenfile = "..\\..\\..\\xml\\tao_func.sql";
                if (File.Exists(tenfile)) File.Delete(tenfile);
                FileStream file = new FileStream(tenfile, FileMode.CreateNew, FileAccess.Write);
                StreamWriter sw = new StreamWriter(file);
                sw.Write(sql);
                sw.Close();
            }
        }

        public string mmyy(string ngay)
        {
            return ngay.Substring(3, 2) + ngay.Substring(8, 2);
        }
        //linh
        public bool upd_tiepdon(string m_mabn, decimal m_mavaovien, decimal m_maql, string m_makp, string m_ngay, int m_madoituong, string m_sovaovien,
            string m_tuoivao, int m_userid, int m_bnmoi, int m_noitiepdon, int m_loai)
        {
            //schema = user + mmyy(m_ngay) + ".upd_tiepdon";
            dblink = dblink.Trim('@');
            dblink = dblink == "" ? "" : "@" + dblink;
            string _mmyy = mmyy(m_ngay);
            if (bMmyy(_mmyy))
            {
                string s_schema = user + _mmyy;
                string s_sql = "update " + s_schema + ".tiepdon" + dblink + " set mabn='" + m_mabn + "',mavaovien=" + m_mavaovien.ToString() + ",makp='" + m_makp + "'," +
                    "ngay=to_timestamp('" + m_ngay + "','dd/mm/yyyy hh24:mi'),madoituong=" + m_madoituong.ToString() + ",sovaovien='" + m_sovaovien + "'," +
                    "tuoivao='" + m_tuoivao + "',userid=" + m_userid.ToString() + ",bnmoi=" + m_bnmoi.ToString() + ",noitiepdon=" + m_noitiepdon.ToString() + "," +
                    "loai=" + m_loai.ToString() + " where maql=" + m_maql.ToString();
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                try
                {
                    con.Open();
                    cmd = new NpgsqlCommand(s_sql, con);//cmd = new NpgsqlCommand(schema, con);
                    cmd.CommandType = CommandType.Text;//.StoredProcedure;
                    int i = cmd.ExecuteNonQuery();
                    if (i == 0)
                    {
                        cmd.Dispose();
                        s_sql = "insert into " + s_schema + ".tiepdon" + dblink + "(mabn,mavaovien,maql,makp,ngay,madoituong,sovaovien,tuoivao,userid,bnmoi,noitiepdon,loai)" +
                            "values ('" + m_mabn + "'," + m_mavaovien.ToString() + "," + m_maql.ToString() + ",'" + m_makp + "',to_timestamp('" + m_ngay + "','dd/mm/yyyy hh24:mi')," +
                            m_madoituong.ToString() + ",'" + m_sovaovien + "','" + m_tuoivao + "'," + m_userid.ToString() + "," + m_bnmoi.ToString() + "," +
                            m_noitiepdon.ToString() + "," + m_loai.ToString() + ")";
                        cmd = new NpgsqlCommand(s_sql, con);
                        cmd.CommandType = CommandType.Text;
                        cmd.ExecuteNonQuery();
                    }
                }
                catch (NpgsqlException ex)
                {
                    upd_error(m_ngay, ex.Message, sComputer, "tiepdon");
                    return false;
                }
                finally
                {
                    cmd.Dispose();
                    con.Close(); con.Dispose();
                }
                return true;
            }
            return false;
        }
        public bool upd_btdbn(string m_mabn, string m_hoten, string m_ngaysinh, string m_namsinh, int m_phai, string m_mann, string m_madantoc, string m_sonha, string m_thon, string m_cholam, string m_matt, string m_maqu, string m_maphuongxa, int m_userid, string m_nam)
        {
            //if (bVantay)
            //{
            //    if (get_data("select * from " + user + ".btdbn where mabn='" + m_mabn + "'").Tables[0].Rows.Count == 0)
            //        if (get_mabn(int.Parse(m_mabn.Substring(0, 2)), 0, 0, true) < int.Parse(m_mabn.Substring(2))) upd_capmabn(int.Parse(m_mabn.Substring(0, 2)), 0, 0, int.Parse(m_mabn.Substring(2)));
            //}
            //        update medibv.btdbn set hoten=m_hoten,ngaysinh=null,namsinh=m_namsinh,phai=m_phai,mann=m_mann,madantoc=m_madantoc,sonha=m_sonha,thon=m_thon,cholam=m_cholam,matt=m_matt,maqu=m_maqu,maphuongxa=m_maphuongxa,userid=m_userid,hotenkdau=m_hotenkdau,nam=m_nam where mabn=m_mabn;
            //if found=false then
            //    insert into medibv.btdbn(mabn,hoten,ngaysinh,namsinh,phai,mann,madantoc,sonha,thon,cholam,matt,maqu,maphuongxa,userid,hotenkdau,nam) values (m_mabn,m_hoten,null,m_namsinh,m_phai,m_mann,m_madantoc,m_sonha,m_thon,m_cholam,m_matt,m_maqu,m_maphuongxa,m_userid,m_hotenkdau,m_nam);
            //linh
            m_hotenkdau = Hoten_khongdau(m_hoten);//gam 07/09/2011
            dblink = dblink.Trim('@');
            dblink = dblink == "" ? "" : "@" + dblink;
            string s_sql = "update " + userid + ".btdbn" + dblink + " set hoten=:m_hoten,ngaysinh=to_date(:m_ngaysinh,'dd/mm/yyyy'),namsinh='" + m_namsinh + "',phai=" + m_phai.ToString() + "," +
                "mann='" + m_mann + "',madantoc='" + m_madantoc + "',sonha=:m_sonha,thon=:m_thon,cholam=:m_cholam,matt='" + m_matt + "',maqu='" + m_maqu + "',maphuongxa='" + m_maphuongxa + "'," +
                "userid=" + m_userid.ToString() + ",hotenkdau=:m_hotenkdau,nam='" + m_nam + "' where mabn='" + m_mabn + "'";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(s_sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_hoten", NpgsqlDbType.Text).Value = m_hoten;
                cmd.Parameters.Add("m_ngaysinh", NpgsqlDbType.Varchar, 10).Value = m_ngaysinh == "" ? null : m_ngaysinh; ;
                cmd.Parameters.Add("m_sonha", NpgsqlDbType.Text).Value = m_sonha;
                cmd.Parameters.Add("m_thon", NpgsqlDbType.Text).Value = m_thon;
                cmd.Parameters.Add("m_cholam", NpgsqlDbType.Text).Value = m_cholam;
                cmd.Parameters.Add("m_hotenkdau", NpgsqlDbType.Text).Value = m_hotenkdau;
                int i = cmd.ExecuteNonQuery();
                if (i == 0)
                {
                    s_sql = "insert into " + userid + ".btdbn" + dblink + "(mabn,hoten,ngaysinh,namsinh,phai,mann,madantoc,sonha,thon,cholam,matt,maqu,maphuongxa,userid,hotenkdau,nam) " +
                        "values ('" + m_mabn + "',:m_hoten,to_date(:m_ngaysinh,'dd/mm/yyyy'),'" + m_namsinh + "'," + m_phai.ToString() + ",'" + m_mann + "','" + m_madantoc + "',:m_sonha,:m_thon," +
                        ":m_cholam,'" + m_matt + "','" + m_maqu + "','" + m_maphuongxa + "'," + m_userid.ToString() + ",:m_hotenkdau,'" + m_nam + "')";
                    cmd = new NpgsqlCommand(s_sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_hoten", NpgsqlDbType.Text).Value = m_hoten;
                    cmd.Parameters.Add("m_ngaysinh", NpgsqlDbType.Varchar, 10).Value = (m_ngaysinh == "" ? null : m_ngaysinh);
                    cmd.Parameters.Add("m_sonha", NpgsqlDbType.Text).Value = m_sonha;
                    cmd.Parameters.Add("m_thon", NpgsqlDbType.Text).Value = m_thon;
                    cmd.Parameters.Add("m_cholam", NpgsqlDbType.Text).Value = m_cholam;
                    cmd.Parameters.Add("m_hotenkdau", NpgsqlDbType.Text).Value = m_hotenkdau;
                    i = cmd.ExecuteNonQuery();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "btdbn");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_lienhe(string m_ngay, decimal m_maql, string m_sonha, string m_thon, string m_cholam, string m_matt, string m_maqu, string m_maphuongxa, string m_tuoivao, int m_loai, int m_bnmoi)
        {
            //schema = user + mmyy(m_ngay) + ".upd_lienhe";
            string _mmyy = mmyy(m_ngay);
            if (bMmyy(_mmyy))
            {
                dblink = dblink.Trim('@');
                dblink = dblink == "" ? "" : "@" + dblink;
                string s_chema = userid + _mmyy;
                string s_sql = "update " + s_chema + ".lienhe" + dblink + " set  sonha=:m_sonha,thon=:m_thon,cholam=:m_cholam,matt='" + m_matt + "',maqu='" + m_maqu + "'," +
                    "maphuongxa='" + m_maphuongxa + "',tuoivao='" + m_tuoivao + "',loai=" + m_loai.ToString() + ",bnmoi=" + m_bnmoi.ToString() + " where maql=" + m_maql.ToString();
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                try
                {
                    con.Open();
                    cmd = new NpgsqlCommand(s_sql, con);//(schema, con);
                    cmd.CommandType = CommandType.Text;//.StoredProcedure;
                    //cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_sonha", NpgsqlDbType.Text).Value = m_sonha;
                    cmd.Parameters.Add("m_thon", NpgsqlDbType.Text).Value = m_thon;
                    cmd.Parameters.Add("m_cholam", NpgsqlDbType.Text).Value = m_cholam;
                    //cmd.Parameters.Add("m_matt", NpgsqlDbType.Varchar, 3).Value = m_matt;
                    //cmd.Parameters.Add("m_maqu", NpgsqlDbType.Varchar, 5).Value = m_maqu;
                    //cmd.Parameters.Add("m_maphuongxa", NpgsqlDbType.Varchar, 7).Value = m_maphuongxa;
                    //cmd.Parameters.Add("m_tuoivao", NpgsqlDbType.Varchar, 4).Value = m_tuoivao;
                    //cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                    //cmd.Parameters.Add("m_bnmoi", NpgsqlDbType.Numeric).Value = m_bnmoi;
                    int i = cmd.ExecuteNonQuery();
                    if (i == 0)
                    {
                        s_sql = "insert into " + s_chema + ".lienhe" + dblink + "(maql,sonha,thon,cholam,matt,maqu,maphuongxa,tuoivao,loai,bnmoi";
                        s_sql += ") values (" + m_maql.ToString() + ",:m_sonha,:m_thon,:m_cholam,'" + m_matt + "','" + m_maqu + "','" + m_maphuongxa + "'," +
                            "'" + m_tuoivao + "'," + m_loai.ToString() + "," + m_bnmoi.ToString();
                        s_sql += ")";
                        cmd.Dispose();
                        cmd = new NpgsqlCommand(s_sql, con);
                        cmd.CommandType = CommandType.Text;
                        cmd.Parameters.Add("m_sonha", NpgsqlDbType.Text).Value = m_sonha;
                        cmd.Parameters.Add("m_thon", NpgsqlDbType.Text).Value = m_thon;
                        cmd.Parameters.Add("m_cholam", NpgsqlDbType.Text).Value = m_cholam;
                        cmd.ExecuteNonQuery();
                    }
                }
                catch (NpgsqlException ex)
                {
                    upd_error(m_ngay, ex.Message, sComputer, "lienhe");
                    return false;
                }
                finally
                {
                    cmd.Dispose();
                    con.Close(); con.Dispose();
                }
                return true;
            }
            return false;
        }
        //end linh
        public bool upd_quanhe(string m_ngay, decimal m_maql, string m_quanhe, string m_hoten, string m_diachi, string m_dienthoai)
        {
            schema = user + mmyy(m_ngay) + ".upd_quanhe";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(schema, con);
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                cmd.Parameters.Add("m_quanhe", NpgsqlDbType.Text, 20).Value = m_quanhe;
                cmd.Parameters.Add("m_hoten", NpgsqlDbType.Text).Value = m_hoten;
                cmd.Parameters.Add("m_diachi", NpgsqlDbType.Text).Value = m_diachi;
                cmd.Parameters.Add("m_dienthoai", NpgsqlDbType.Text, 20).Value = m_dienthoai;
                cmd.ExecuteNonQuery();
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message, sComputer, "lienhe");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_quanhe(string m_ngay, decimal m_maql, string m_quanhe, string m_hoten, string m_diachi, string m_dienthoai, string m_phuongtien)
        {
            schema = user + mmyy(m_ngay) + ".upd_quanhe";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(schema, con);
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                cmd.Parameters.Add("m_quanhe", NpgsqlDbType.Text, 20).Value = m_quanhe;
                cmd.Parameters.Add("m_hoten", NpgsqlDbType.Text).Value = m_hoten;
                cmd.Parameters.Add("m_diachi", NpgsqlDbType.Text).Value = m_diachi;
                cmd.Parameters.Add("m_dienthoai", NpgsqlDbType.Text, 20).Value = m_dienthoai;
                cmd.Parameters.Add("m_phuongtien", NpgsqlDbType.Text).Value = m_phuongtien;
                cmd.ExecuteNonQuery();
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message, sComputer, "quanhe");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_sukien(string m_ngay, string m_mabn, decimal m_matiepdon, int m_noitiepdon, decimal m_macap)
        {
            schema = user + mmyy(m_ngay) + ".upd_sukien";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(schema, con);
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_matiepdon", NpgsqlDbType.Numeric).Value = m_matiepdon;
                cmd.Parameters.Add("m_noitiepdon", NpgsqlDbType.Numeric).Value = m_noitiepdon;
                cmd.Parameters.Add("m_macap", NpgsqlDbType.Numeric).Value = m_macap;

                cmd.ExecuteNonQuery();
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message, sComputer, "sukien");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_sukien(string m_mabn, decimal m_matiepdon, int m_noitiepdon, decimal m_macap)
        {
            schema = user + ".upd_sukien";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(schema, con);
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_matiepdon", NpgsqlDbType.Numeric).Value = m_matiepdon;
                cmd.Parameters.Add("m_noitiepdon", NpgsqlDbType.Numeric).Value = m_noitiepdon;
                cmd.Parameters.Add("m_macap", NpgsqlDbType.Numeric).Value = m_macap;
                cmd.ExecuteNonQuery();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "sukien");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool get_count(string nam, string str)
        {
            int i = 0;
            bool bFound = false;
            string mmyy = "";
            while (i < nam.Trim().Length && !bFound)
            {
                mmyy = nam.Substring(i, 4);
                if (bMmyy(mmyy))
                {
                    sql = str.Replace("xxx", user + mmyy);
                    bFound = get_data(sql).Tables[0].Rows.Count > 0;
                }
                i += 5;
            }
            return bFound;
        }

        public DataSet get_data_nam_dec(string nam, string str)
        {
            if (nam == null) return null;
            try
            {
                if (ds != null)
                {
                    ds.Dispose();
                    ds = null;
                }
                ds = new DataSet();
                int i = nam.Trim().Length;
                bool bFound = false;
                string mmyy = "";
                while (i > 0 && !bFound)
                {
                    mmyy = nam.Substring(i - 5, 4);
                    if (bMmyy(mmyy))
                    {
                        sql = str.Replace("xxx", user + mmyy);
                        ds = get_data(sql);
                        if (ds == null || ds.Tables.Count <= 0) bFound = false;
                        else bFound = ds.Tables[0].Rows.Count > 0;
                    }
                    i -= 5;
                }
            }
            catch (Exception ex) { ds = null; }
            if (ds.Tables.Count == 0) { ds = null; }
            return ds;
        }

        public DataSet get_data_nam_all_dec(string nam, string str)
        {
            DataSet tmp = new DataSet();
            int i = nam.Trim().Length;
            bool be = true;
            string mmyy = "";
            while (i > 0)
            {
                mmyy = nam.Substring(i - 5, 4);
                if (bMmyy(mmyy))
                {
                    sql = str.Replace("xxx", user + mmyy);
                    if (be)
                    {
                        tmp = get_data(sql);
                        be = false;
                    }
                    else tmp.Merge(get_data(sql));
                }
                i -= 5;
            }
            return tmp;
        }

        public DataSet get_data_nam(string nam, string str)
        {
            DataSet tmp = new DataSet();
            int i = 0;
            bool be = true;
            string mmyy = "";
            while (i < nam.Trim().Length)
            {
                mmyy = nam.Substring(i, 4);
                if (bMmyy(mmyy))
                {
                    sql = str.Replace("xxx", user + mmyy);
                    if (be)
                    {
                        tmp = get_data(sql);
                        be = false;
                    }
                    else tmp.Merge(get_data(sql));
                }
                i += 5;
            }
            return tmp;
        }
        public List<string> get_listSchemaName()
        {
            List<string> rs = new List<string>();
            using(Npgsql.NpgsqlCommand comm = new NpgsqlCommand("select schema_name from information_schema.schemata",new NpgsqlConnection(this.ConStr)))
            {
                comm.Connection.Open();
                NpgsqlDataReader drd = comm.ExecuteReader();
                while (drd.Read())
                {
                    rs.Add(drd[0].ToString());
                }
                comm.Connection.Close();
            }
            return rs;
        }
        public DataSet get_data_mmyy(string str, string tu, string den, bool khoangcach)
        {
            
            DataSet tmp = new DataSet();
            d = new LibDuoc.AccessData();
            DateTime dt1 = (khoangcach) ? StringToDate(tu).AddDays(-d.iNgaykiemke) : StringToDate(tu);
            DateTime dt2 = (khoangcach) ? StringToDate(den).AddDays(d.iNgaykiemke) : StringToDate(den);
            int y1 = dt1.Year, m1 = dt1.Month;
            int y2 = dt2.Year, m2 = dt2.Month;
            int itu, iden;
            string mmyy = "";
            bool be = true;
            List<string> danhsachshema = get_listSchemaName();
            for (int i = y1; i <= y2; i++)
            {
                itu = (i == y1) ? m1 : 1;
                iden = (i == y2) ? m2 : 12;
                for (int j = itu; j <= iden; j++)
                {
                    mmyy = j.ToString().PadLeft(2, '0') + i.ToString().Substring(2, 2);
                    if (bMmyy(mmyy))
                    {
                        sql = str.Replace("xxx.", user + mmyy + ".");
                        sql = sql.Replace("medibvmmyy.", user + mmyy + ".");
                        sql = sql.Replace("medibv.", user + ".");
                        if (be || tmp == null)
                        {
                            tmp = get_data(sql);
                            be = false;
                        }
                        else tmp.Merge(get_data(sql));
                    }
                }
            }
            if (be || tmp == null || tmp.Tables.Count <= 0) upd_error(sql, "?", "?");
            return tmp;
        }

        public void execute_data_mmyy(string str, string tu, string den, bool khoangcach)
        {
            d = new LibDuoc.AccessData();
            DateTime dt1 = (khoangcach) ? StringToDate(tu).AddDays(-d.iNgaykiemke) : StringToDate(tu);
            DateTime dt2 = (khoangcach) ? StringToDate(den).AddDays(d.iNgaykiemke) : StringToDate(den);
            int y1 = dt1.Year, m1 = dt1.Month;
            int y2 = dt2.Year, m2 = dt2.Month;
            int itu, iden;
            string mmyy = "";
            for (int i = y1; i <= y2; i++)
            {
                itu = (i == y1) ? m1 : 1;
                iden = (i == y2) ? m2 : 12;
                for (int j = itu; j <= iden; j++)
                {
                    mmyy = j.ToString().PadLeft(2, '0') + i.ToString().Substring(2, 2);
                    if (bMmyy(mmyy))
                    {
                        sql = str.Replace("xxx", user + mmyy);
                        execute_data(sql);
                    }
                }
            }
        }

        public string get_mabn_nam(string mabn)
        {
            ds = get_data("select nam from " + user + ".btdbn where mabn='" + mabn + "'");
            if (ds.Tables[0].Rows.Count > 0) return ds.Tables[0].Rows[0]["nam"].ToString().Trim();
            else return "";
        }

        public void upd_mabn_nam(string mabn, string nam)
        {
            execute_data("update " + user + ".btdbn set nam='" + nam + "' where mabn='" + mabn + "'");
        }

        public bool upd_benhanpk(string m_mabn, decimal m_mavaovien, decimal m_maql, string m_makp, string m_ngay, int m_dentu, int m_nhantu, int m_madoituong, string m_chandoan, string m_maicd, int m_ttlucrv, string m_mabs, string m_sovaovien, int m_bienchung, int m_taibien, int m_giaiphau, decimal m_mangtr, int m_userid)
        {
            schema = user + mmyy(m_ngay) + ".upd_benhanpk";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(schema, con);
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                cmd.Parameters.Add("m_dentu", NpgsqlDbType.Numeric).Value = m_dentu;
                cmd.Parameters.Add("m_nhantu", NpgsqlDbType.Numeric).Value = m_nhantu;
                cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                cmd.Parameters.Add("m_ttlucrv", NpgsqlDbType.Numeric).Value = m_ttlucrv;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_sovaovien", NpgsqlDbType.Varchar, 10).Value = m_sovaovien;
                cmd.Parameters.Add("m_bienchung", NpgsqlDbType.Numeric).Value = m_bienchung;
                cmd.Parameters.Add("m_taibien", NpgsqlDbType.Numeric).Value = m_taibien;
                cmd.Parameters.Add("m_giaiphau", NpgsqlDbType.Numeric).Value = m_giaiphau;
                cmd.Parameters.Add("m_mangtr", NpgsqlDbType.Numeric).Value = m_mangtr;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.ExecuteNonQuery();
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message, sComputer, "benhanpk");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_xutrikbct(string m_ngay, decimal m_maql, string m_xutri, string m_makp)
        {
            schema = user + mmyy(m_ngay) + ".upd_xutrikbct";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(schema, con);
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                cmd.Parameters.Add("m_xutri", NpgsqlDbType.Text).Value = m_xutri;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                cmd.ExecuteNonQuery();
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message, sComputer, "xutrikbct");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_benhancc(string m_mabn, decimal m_mavaovien, decimal m_maql, string m_makp, string m_ngay, int m_dentu, int m_nhantu, int m_madoituong, string m_mabsnb, string m_chandoan, string m_maicd, string m_sovaovien, int m_userid)
        {
            schema = user + mmyy(m_ngay) + ".upd_benhancc";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(schema, con);
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                cmd.Parameters.Add("m_dentu", NpgsqlDbType.Numeric).Value = m_dentu;
                cmd.Parameters.Add("m_nhantu", NpgsqlDbType.Numeric).Value = m_nhantu;
                cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                cmd.Parameters.Add("m_mabsnb", NpgsqlDbType.Varchar, 4).Value = m_mabsnb;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                cmd.Parameters.Add("m_sovaovien", NpgsqlDbType.Varchar, 10).Value = m_sovaovien;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.ExecuteNonQuery();
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message, sComputer, "benhancc");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_benhancc(string m_ngay, decimal m_maql, string m_ngayrv, int m_ketqua, int m_ttlucrv, string m_chandoanrv, string m_maicdrv, string m_mabs, int m_bienchung, int m_taibien, int m_giaiphau, string m_soluutru, string m_giuong)
        {
            schema = user + mmyy(m_ngay) + ".upd_benhancc";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(schema, con);
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                cmd.Parameters.Add("m_ngayrv", NpgsqlDbType.Varchar, 16).Value = m_ngayrv;
                cmd.Parameters.Add("m_ketqua", NpgsqlDbType.Numeric).Value = m_ketqua;
                cmd.Parameters.Add("m_ttlucrv", NpgsqlDbType.Numeric).Value = m_ttlucrv;
                cmd.Parameters.Add("m_chandoanrv", NpgsqlDbType.Text).Value = m_chandoanrv;
                cmd.Parameters.Add("m_maicdrv", NpgsqlDbType.Varchar, 9).Value = m_maicdrv;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_bienchung", NpgsqlDbType.Numeric).Value = m_bienchung;
                cmd.Parameters.Add("m_taibien", NpgsqlDbType.Numeric).Value = m_taibien;
                cmd.Parameters.Add("m_giaiphau", NpgsqlDbType.Numeric).Value = m_giaiphau;
                cmd.Parameters.Add("m_soluutru", NpgsqlDbType.Varchar, 10).Value = m_soluutru;
                cmd.Parameters.Add("m_giuong", NpgsqlDbType.Varchar, 20).Value = m_giuong;
                cmd.ExecuteNonQuery();
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message, sComputer, "benhancc");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_benhanngtr(string m_mabn, decimal m_mavaovien, decimal m_maql, string m_makp, string m_ngay, int m_dentu, int m_nhantu, int m_madoituong, string m_chandoan, string m_maicd, string m_sovaovien, int m_userid)
        {
            schema = user + ".upd_benhanngtr";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(schema, con);
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                cmd.Parameters.Add("m_dentu", NpgsqlDbType.Numeric).Value = m_dentu;
                cmd.Parameters.Add("m_nhantu", NpgsqlDbType.Numeric).Value = m_nhantu;
                cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                cmd.Parameters.Add("m_sovaovien", NpgsqlDbType.Varchar, 10).Value = m_sovaovien;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.ExecuteNonQuery();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "benhanngtr");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
            if (m_sovaovien == "" && (bSovaovien_ngoaitru_tang_chungNoitru || bSovaovien_ngoaitru_tang_rieng))
            {
                if (bSovaovien_ngoaitru_tang_chungNoitru)
                {
                    upd_sovaovien_ngtru(m_maql, get_capid(5, m_ngay.Substring(8, 2)).ToString().PadLeft(7, '0') + "/" + m_ngay.Substring(8, 2));
                }
                else if (bSovaovien_ngoaitru_tang_rieng) upd_sovaovien_ngtru(m_maql, get_capid(-5, m_ngay.Substring(8, 2)).ToString().PadLeft(7, '0') + "/" + m_ngay.Substring(8, 2));
            }
            return true;
        }

        public bool upd_benhanngtr(decimal m_maql, string m_ngayrv, int m_ketqua, int m_ttlucrv, string m_chandoanrv, string m_maicdrv, string m_mabs, int m_bienchung, int m_taibien, int m_giaiphau, string m_soluutru)
        {
            schema = user + ".upd_benhanngtr";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(schema, con);
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                cmd.Parameters.Add("m_ngayrv", NpgsqlDbType.Varchar, 16).Value = m_ngayrv;
                cmd.Parameters.Add("m_ketqua", NpgsqlDbType.Numeric).Value = m_ketqua;
                cmd.Parameters.Add("m_ttlucrv", NpgsqlDbType.Numeric).Value = m_ttlucrv;
                cmd.Parameters.Add("m_chandoanrv", NpgsqlDbType.Text).Value = m_chandoanrv;
                cmd.Parameters.Add("m_maicdrv", NpgsqlDbType.Varchar, 9).Value = m_maicdrv;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_bienchung", NpgsqlDbType.Numeric).Value = m_bienchung;
                cmd.Parameters.Add("m_taibien", NpgsqlDbType.Numeric).Value = m_taibien;
                cmd.Parameters.Add("m_giaiphau", NpgsqlDbType.Numeric).Value = m_giaiphau;
                cmd.Parameters.Add("m_soluutru", NpgsqlDbType.Varchar, 10).Value = m_soluutru;
                cmd.ExecuteNonQuery();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "benhanngtr");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
            return true;
        }

        public DataSet get_hiendien(string makp, string ngay)
        {
            string stime = "'" + f_ngay + "'";
            DataSet dsr = new DataSet();
            if (makp == "99")//phong luu
            {
                sql = "select a.mabn,b.hoten,a.mavaovien,a.maql as id,a.maql,a.giuong,a.mabsnb as mabs,a.maicd,b.nam,";
                sql += "to_char(a.ngay,'dd/mm/yyyy hh24:mi') as ngay,a.madoituong,a.chandoan,c.sothe,";
                //sql += " coalesce(to_char(c.ngaygiahan,'dd/mm/yyyy'),to_char(c.denngay,'dd/mm/yyyy')) as denngay,b.namsinh,";//Thuy 04.01.2012
                sql += " to_char(c.denngay,'dd/mm/yyyy') as denngay,b.namsinh,";//gam 29032012 --> bệnh nhân phòng lưu không có ngày gia hạn thẻ
                sql += " to_char(c.tungay,'dd/mm/yyyy') as tungay,to_char(c.ngay1,'dd/mm/yyyy') as ngay1,";
                sql += " to_char(c.ngay2,'dd/mm/yyyy') as ngay2,to_char(c.ngay3,'dd/mm/yyyy') as ngay3,c.traituyen,c.mabv ";
                sql += " from xxx.benhancc a inner join " + user + ".btdbn b on a.mabn=b.mabn ";
                sql += " left join xxx.bhyt c on a.maql=c.maql ";
                sql += " where a.ngayrv is null and a.makp='" + makp + "'";
                sql += " and " + for_ngay("a.ngay", stime) + " <= to_date('" + ngay.Substring(0, 10) + "'," + stime + ")";
                sql += " order by a.maql desc";
                dsr = get_data_mmyy(sql, DateToString("dd/MM/yyyy", StringToDate(ngay.Substring(0, 10)).AddYears(-1)), ngay.Substring(0, 10), false);
            }
            else
            {
                sql = "select a.mabn,b.hoten,a.mavaovien,a.id,a.maql,a.giuong,a.mabs,a.maicd,b.nam,";
                sql += " to_char(a.ngayvv,'dd/mm/yyyy hh24:mi') as ngay,c.madoituong,c.chandoan,d.sothe,";
                sql += " coalesce(to_char(d.ngaygiahan,'dd/mm/yyyy'),to_char(d.denngay,'dd/mm/yyyy')) as denngay,b.namsinh, ";//Thuy 04.01.2012
                sql += " to_char(d.tungay,'dd/mm/yyyy') as tungay,to_char(d.ngay1,'dd/mm/yyyy') as ngay1,";
                sql += " to_char(d.ngay2,'dd/mm/yyyy') as ngay2,to_char(d.ngay3,'dd/mm/yyyy') as ngay3,d.traituyen,d.mabv";
                sql += " from " + user + ".hiendien a inner join " + user + ".btdbn b on a.mabn=b.mabn ";
                sql += " inner join " + user + ".benhandt c on a.maql=c.maql ";
                sql += " left join " + user + ".bhyt d on a.maql=d.maql ";
                sql += " where a.nhapkhoa=1 and a.xuatkhoa=0 ";
                if (!ma_phongmo(makp)) sql += " and a.makp='" + makp + "'";
                sql += " and " + for_ngay("a.ngay", stime) + " <= to_date('" + ngay.Substring(0, 10) + "'," + stime + ")";
                sql += " and (d.sudung is null or d.sudung=1)";
                sql += " order by a.id desc";
                dsr = get_data(sql);
                sql = "select a.mabn,b.hoten,a.mavaovien,a.maql as id,a.maql,'' as giuong,a.mabs,a.maicd,b.nam,";
                sql += " to_char(a.ngay,'dd/mm/yyyy hh24:mi') as ngay,a.madoituong,a.chandoan,d.sothe,";
                sql += " coalesce(to_char(d.ngaygiahan,'dd/mm/yyyy'),to_char(d.denngay,'dd/mm/yyyy')) as denngay,b.namsinh,";//Thuy 04.01.2012
                sql += " to_char(d.tungay,'dd/mm/yyyy') as tungay,to_char(d.ngay1,'dd/mm/yyyy') as ngay1,";
                sql += " to_char(d.ngay2,'dd/mm/yyyy') as ngay2,to_char(d.ngay3,'dd/mm/yyyy') as ngay3,d.traituyen,d.mabv";
                sql += " from " + user + ".benhanngtr a inner join " + user + ".btdbn b on a.mabn=b.mabn ";
                sql += " left join " + user + ".bhyt d on a.maql=d.maql ";
                sql += " where a.ngayrv is null and a.makp='" + makp + "'";
                sql += " and " + for_ngay("a.ngay", stime) + " <= to_date('" + ngay.Substring(0, 10) + "'," + stime + ")";
                sql += " and (d.sudung is null or d.sudung=1)";
                sql += " order by a.maql desc";
                dsr.Merge(get_data(sql));
                if (ma_phongmo(makp))
                {
                    sql = "select a.mabn,b.hoten,a.mavaovien,a.maql as id,a.maql,'' as giuong,a.mabs,a.maicd,b.nam,";
                    sql += "to_char(a.ngay,'dd/mm/yyyy hh24:mi') as ngay,a.madoituong,a.chandoan,c.sothe,";
                    sql += " to_char(c.denngay,'dd/mm/yyyy') as denngay,b.namsinh,";
                    sql += " to_char(c.tungay,'dd/mm/yyyy') as tungay,to_char(c.ngay1,'dd/mm/yyyy') as ngay1,";
                    sql += " to_char(c.ngay2,'dd/mm/yyyy') as ngay2,to_char(c.ngay3,'dd/mm/yyyy') as ngay3,c.traituyen,c.mabv , to_number('3') as loaiba";
                    sql += " from xxx.benhanpk a inner join " + user + ".btdbn b on a.mabn=b.mabn ";
                    sql += " left join xxx.bhyt c on a.maql=c.maql ";
                    //sql += " where a.makp='" + makp + "'";
                    sql += " and " + for_ngay("a.ngay", stime) + " <= to_date('" + ngay.Substring(0, 10) + "'," + stime + ")";
                    sql += " order by a.maql desc";
                    dsr.Merge(get_data_mmyy(sql, DateToString("dd/MM/yyyy", StringToDate(ngay.Substring(0, 10)).AddMonths(-1)), ngay.Substring(0, 10), false));
                    //
                    sql = " select a.mabn,b.hoten,a.mavaovien,a.maql as id,a.maql,'' as giuong,'' as mabs,'' as maicd,b.nam,";
                    sql += "to_char(a.ngay,'dd/mm/yyyy hh24:mi') as ngay,a.madoituong,'' as chandoan,c.sothe,";
                    sql += " to_char(c.denngay,'dd/mm/yyyy') as denngay,b.namsinh,";
                    sql += " to_char(c.tungay,'dd/mm/yyyy') as tungay,to_char(c.ngay1,'dd/mm/yyyy') as ngay1,";
                    sql += " to_char(c.ngay2,'dd/mm/yyyy') as ngay2,to_char(c.ngay3,'dd/mm/yyyy') as ngay3,c.traituyen,c.mabv, to_number('0') as loaiba ";
                    sql += " from xxx.tiepdon a inner join " + user + ".btdbn b on a.mabn=b.mabn ";
                    sql += " left join xxx.bhyt c on a.maql=c.maql ";
                    //sql += " where a.makp='" + makp + "'";
                    sql += " and " + for_ngay("a.ngay", stime) + " <= to_date('" + ngay.Substring(0, 10) + "'," + stime + ")";
                    sql += " order by a.maql desc";
                    dsr.Merge(get_data_mmyy(sql, DateToString("dd/MM/yyyy", StringToDate(ngay.Substring(0, 10)).AddMonths(-1)), ngay.Substring(0, 10), false));
                }
            }
            return dsr;
        }
        public DataSet get_hiendien(string makp, string ngay, int loaiba)
        {
            string stime = "'" + f_ngay + "'";
            DataSet dsr = new DataSet();
            if (makp == "99" || loaiba == 4)//phong luu
            {
                sql = "select a.mabn,b.hoten,a.mavaovien,a.maql as id,a.maql,a.giuong,a.mabs,a.maicd,b.nam,";
                sql += "to_char(a.ngay,'dd/mm/yyyy hh24:mi') as ngay,a.madoituong,a.chandoan,c.sothe,";
                sql += " to_char(c.denngay,'dd/mm/yyyy') as denngay,b.namsinh,";
                sql += " to_char(c.tungay,'dd/mm/yyyy') as tungay,to_char(c.ngay1,'dd/mm/yyyy') as ngay1,";
                sql += " to_char(c.ngay2,'dd/mm/yyyy') as ngay2,to_char(c.ngay3,'dd/mm/yyyy') as ngay3,c.traituyen,c.mabv, 4 as loaiba ";
                sql += " from xxx.benhancc a inner join " + user + ".btdbn b on a.mabn=b.mabn ";
                sql += " left join xxx.bhyt c on a.maql=c.maql ";
                sql += " where a.ngayrv is null and a.makp='" + makp + "'";
                sql += " and " + for_ngay("a.ngay", stime) + " <= to_date('" + ngay.Substring(0, 10) + "'," + stime + ")";
                sql += " order by a.maql desc";
                dsr = get_data_mmyy(sql, DateToString("dd/MM/yyyy", StringToDate(ngay.Substring(0, 10)).AddYears(-1)), ngay.Substring(0, 10), false);
            }
            else if (loaiba == 3 || loaiba == 5)
            {
                sql = "select a.mabn,b.hoten,a.mavaovien,a.maql as id,a.maql,'' as giuong,a.mabs,a.maicd,b.nam,";
                sql += "to_char(a.ngay,'dd/mm/yyyy hh24:mi') as ngay,a.madoituong,a.chandoan,c.sothe,";
                sql += " to_char(c.denngay,'dd/mm/yyyy') as denngay,b.namsinh,";
                sql += " to_char(c.tungay,'dd/mm/yyyy') as tungay,to_char(c.ngay1,'dd/mm/yyyy') as ngay1,";
                sql += " to_char(c.ngay2,'dd/mm/yyyy') as ngay2,to_char(c.ngay3,'dd/mm/yyyy') as ngay3,c.traituyen,c.mabv , to_number('3') as loaiba";
                sql += " from xxx.benhanpk a inner join " + user + ".btdbn b on a.mabn=b.mabn ";
                sql += " left join xxx.bhyt c on a.maql=c.maql ";
                sql += " where a.makp='" + makp + "'";
                sql += " and " + for_ngay("a.ngay", stime) + " = to_date('" + ngay.Substring(0, 10) + "'," + stime + ")";
                sql += " order by a.maql desc";
                dsr = get_data_mmyy(sql, DateToString("dd/MM/yyyy", StringToDate(ngay.Substring(0, 10)).AddMonths(-1)), ngay.Substring(0, 10), false);
                //
                sql = " select a.mabn,b.hoten,a.mavaovien,a.maql as id,a.maql,'' as giuong,'' as mabs,'' as maicd,b.nam,";
                sql += "to_char(a.ngay,'dd/mm/yyyy hh24:mi') as ngay,a.madoituong,'' as chandoan,c.sothe,";
                sql += " to_char(c.denngay,'dd/mm/yyyy') as denngay,b.namsinh,";
                sql += " to_char(c.tungay,'dd/mm/yyyy') as tungay,to_char(c.ngay1,'dd/mm/yyyy') as ngay1,";
                sql += " to_char(c.ngay2,'dd/mm/yyyy') as ngay2,to_char(c.ngay3,'dd/mm/yyyy') as ngay3,c.traituyen,c.mabv, to_number('0') as loaiba ";
                sql += " from xxx.tiepdon a inner join " + user + ".btdbn b on a.mabn=b.mabn ";
                sql += " left join xxx.bhyt c on a.maql=c.maql ";
                sql += " where a.makp='" + makp + "'";
                sql += " and " + for_ngay("a.ngay", stime) + " = to_date('" + ngay.Substring(0, 10) + "'," + stime + ")";
                sql += " order by a.maql desc";
                dsr.Merge(get_data_mmyy(sql, DateToString("dd/MM/yyyy", StringToDate(ngay.Substring(0, 10)).AddMonths(-1)), ngay.Substring(0, 10), false));
            }
            else if (loaiba == 2)
            {
                sql = "select  a.mabn,b.hoten,a.mavaovien,a.maql as id,a.maql,'' as giuong,a.mabs,a.maicd,b.nam,";
                sql += " to_char(a.ngay,'dd/mm/yyyy hh24:mi') as ngay,a.madoituong,a.chandoan,d.sothe,";
                sql += " to_char(d.denngay,'dd/mm/yyyy') as denngay,b.namsinh,";
                sql += " to_char(d.tungay,'dd/mm/yyyy') as tungay,to_char(d.ngay1,'dd/mm/yyyy') as ngay1,";
                sql += " to_char(d.ngay2,'dd/mm/yyyy') as ngay2,to_char(d.ngay3,'dd/mm/yyyy') as ngay3,d.traituyen,d.mabv, to_number('2') as loaiba";
                sql += " from " + user + ".benhanngtr a inner join " + user + ".btdbn b on a.mabn=b.mabn ";
                sql += " left join " + user + ".bhyt d on a.maql=d.maql ";
                sql += " where a.ngayrv is null and a.makp='" + makp + "'";
                sql += " and " + for_ngay("a.ngay", stime) + " <= to_date('" + ngay.Substring(0, 10) + "'," + stime + ")";
                sql += " and (d.sudung is null or d.sudung=1)";
                sql += " order by a.maql desc";
                dsr = get_data(sql);
            }
            else
            {
                sql = "select a.mabn,b.hoten,a.mavaovien,a.id,a.maql,a.giuong,a.mabs,a.maicd,b.nam,";
                sql += " to_char(a.ngayvv,'dd/mm/yyyy hh24:mi') as ngay,c.madoituong,c.chandoan,d.sothe,";
                sql += " to_char(d.denngay,'dd/mm/yyyy') as denngay,b.namsinh, ";
                sql += " to_char(d.tungay,'dd/mm/yyyy') as tungay,to_char(d.ngay1,'dd/mm/yyyy') as ngay1,";
                sql += " to_char(d.ngay2,'dd/mm/yyyy') as ngay2,to_char(d.ngay3,'dd/mm/yyyy') as ngay3,d.traituyen,d.mabv, c.loaiba ";
                sql += " from " + user + ".hiendien a inner join " + user + ".btdbn b on a.mabn=b.mabn ";
                sql += " inner join " + user + ".benhandt c on a.maql=c.maql ";
                sql += " left join " + user + ".bhyt d on a.maql=d.maql ";
                sql += " where a.nhapkhoa=1 and a.xuatkhoa=0 ";
                if (!ma_phongmo(makp)) sql += " and a.makp='" + makp + "'";
                sql += " and " + for_ngay("a.ngay", stime) + " <= to_date('" + ngay.Substring(0, 10) + "'," + stime + ")";
                sql += " and (d.sudung is null or d.sudung=1)";
                sql += " order by a.id desc";
                dsr = get_data(sql);
            }
            return dsr;
        }

        public DataSet get_hiendien(string ngay)
        {
            string stime = "'" + f_ngay + "'";
            DataSet dsr = new DataSet();
            sql = "select a.mabn,b.hoten,a.mavaovien,a.id,a.maql,a.giuong,a.mabs,a.maicd,b.nam,to_char(a.ngayvv,'dd/mm/yyyy hh24:mi') as ngay,c.madoituong,c.chandoan,d.sothe,to_char(d.denngay,'dd/mm/yyyy') as denngay ";
            sql += " from " + user + ".hiendien a inner join " + user + ".btdbn b on a.mabn=b.mabn ";
            sql += " inner join " + user + ".benhandt c on a.maql=c.maql ";
            sql += " left join " + user + ".bhyt d on a.maql=d.maql ";
            sql += " where a.nhapkhoa=1 and a.xuatkhoa=0";
            sql += " and " + for_ngay("a.ngay", stime) + " <= to_date('" + ngay.Substring(0, 10) + "'," + stime + ")";
            sql += " and (d.sudung is null or d.sudung=1)";
            sql += " order by a.id desc";
            dsr = get_data(sql);
            sql = "select a.mabn,b.hoten,a.mavaovien,a.maql as id,a.maql,'' as giuong,a.mabs,a.maicd,b.nam,to_char(a.ngay,'dd/mm/yyyy hh24:mi') as ngay,a.madoituong,a.chandoan,d.sothe,to_char(d.denngay,'dd/mm/yyyy') as denngay ";
            sql += " from " + user + ".benhanngtr a inner join " + user + ".btdbn b on a.mabn=b.mabn ";
            sql += " left join " + user + ".bhyt d on a.maql=d.maql ";
            sql += " where a.ngayrv is null";
            sql += " and " + for_ngay("a.ngay", stime) + " <= to_date('" + ngay.Substring(0, 10) + "'," + stime + ")";
            sql += " and (d.sudung is null or d.sudung=1)";
            sql += " order by a.maql desc";
            dsr.Merge(get_data(sql));
            return dsr;
        }

        public DataSet get_hiendien_all(string ngay, string mabn)
        {
            string stime = "'" + f_ngay + "'";
            DataSet dsr = new DataSet();
            sql = "select a.mabn,b.hoten,a.mavaovien,a.id,a.maql,a.giuong,a.mabs,a.maicd,b.nam,to_char(a.ngayvv,'dd/mm/yyyy hh24:mi') as ngay,c.madoituong,c.chandoan,d.sothe,to_char(d.denngay,'dd/mm/yyyy') as denngay ";
            sql += " from " + user + ".hiendien a inner join " + user + ".btdbn b on a.mabn=b.mabn ";
            sql += " inner join " + user + ".benhandt c on a.maql=c.maql ";
            sql += " left join " + user + ".bhyt d on a.maql=d.maql ";
            sql += " where a.nhapkhoa=1 and a.xuatkhoa=0";
            sql += " and " + for_ngay("a.ngay", stime) + " <= to_date('" + ngay.Substring(0, 10) + "'," + stime + ")";
            sql += " and (d.sudung is null or d.sudung=1)";
            if (mabn != "") sql += " and a.mabn='" + mabn + "'";
            sql += " order by a.id desc";
            dsr = get_data(sql);
            sql = "select a.mabn,b.hoten,a.mavaovien,a.maql as id,a.maql,'' as giuong,a.mabs,a.maicd,b.nam,to_char(a.ngay,'dd/mm/yyyy hh24:mi') as ngay,a.madoituong,a.chandoan,d.sothe,to_char(d.denngay,'dd/mm/yyyy') as denngay ";
            sql += " from " + user + ".benhanngtr a inner join " + user + ".btdbn b on a.mabn=b.mabn ";
            sql += " left join " + user + ".bhyt d on a.maql=d.maql ";
            sql += " where a.ngayrv is null";
            sql += " and " + for_ngay("a.ngay", stime) + " <= to_date('" + ngay.Substring(0, 10) + "'," + stime + ")";
            sql += " and (d.sudung is null or d.sudung=1)";
            if (mabn != "") sql += " and a.mabn='" + mabn + "'";
            sql += " order by a.maql desc";
            dsr.Merge(get_data(sql));
            sql = "select a.mabn,b.hoten,a.mavaovien,a.maql as id,a.maql,a.giuong,a.mabs,a.maicd,b.nam,to_char(a.ngay,'dd/mm/yyyy hh24:mi') as ngay,a.madoituong,a.chandoan,c.sothe,to_char(c.denngay,'dd/mm/yyyy') as denngay ";
            sql += " from xxx.benhancc a inner join " + user + ".btdbn b on a.mabn=b.mabn ";
            sql += " left join xxx.bhyt c on a.maql=c.maql ";
            sql += " where a.ngayrv is null ";
            sql += " and " + for_ngay("a.ngay", stime) + " <= to_date('" + ngay.Substring(0, 10) + "'," + stime + ")";
            if (mabn != "") sql += " and a.mabn='" + mabn + "'";
            sql += " order by a.maql desc";
            dsr.Merge(get_data_mmyy(sql, DateToString("dd/MM/yyyy", StringToDate(ngay.Substring(0, 10)).AddYears(-1)), ngay.Substring(0, 10), false));
            return dsr;
        }

        public string for_ngay(string ngay, string time)
        {
            return "to_date(to_char(" + ngay + ", " + time + "), " + time + ")";
        }

        public bool upd_eve_tables(int m_tableid, int m_userid, string m_command)
        {
            string ngay = Ngaygio_hienhanh.Substring(0, 10);
            int icomputerid = get_dmcomputer(), m_ins = 0, m_upd = 0, m_del = 0;
            switch (m_command)
            {
                case "upd": m_upd = 1; break;
                case "del": m_del = 1; break;
                default: m_ins = 1; break;
            }
            schema = user + ".upd_eve_tables";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(schema, con);
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.Add("m_tableid", NpgsqlDbType.Numeric).Value = m_tableid;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 10).Value = ngay;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_computerid", NpgsqlDbType.Numeric).Value = icomputerid;
                cmd.Parameters.Add("m_ins", NpgsqlDbType.Numeric).Value = m_ins;
                cmd.Parameters.Add("m_upd", NpgsqlDbType.Numeric).Value = m_upd;
                cmd.Parameters.Add("m_del", NpgsqlDbType.Numeric).Value = m_del;
                cmd.ExecuteNonQuery();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "eve_tables");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_eve_upd_del(int m_tableid, int m_userid, string m_command, string m_noidung)
        {
            int icomputerid = get_dmcomputer();
            schema = user + ".upd_eve_upd_del";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(schema, con);
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.Add("m_tableid", NpgsqlDbType.Numeric).Value = m_tableid;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_computerid", NpgsqlDbType.Numeric).Value = icomputerid;
                cmd.Parameters.Add("m_command", NpgsqlDbType.Varchar, 3).Value = m_command;
                cmd.Parameters.Add("m_noidung", NpgsqlDbType.Text).Value = m_noidung;
                cmd.ExecuteNonQuery();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "eve_upd_del");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_eve_tables(string m_ngay, int m_tableid, int m_userid, string m_command)
        {
            string ngay = Ngaygio_hienhanh.Substring(0, 10);
            int icomputerid = get_dmcomputer(), m_ins = 0, m_upd = 0, m_del = 0;
            switch (m_command)
            {
                case "upd": m_upd = 1; break;
                case "del": m_del = 1; break;
                default: m_ins = 1; break;
            }
            if (m_ngay.Trim() == "") m_ngay = ngay;
            schema = user + mmyy(m_ngay) + ".upd_eve_tables";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(schema, con);
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.Add("m_tableid", NpgsqlDbType.Numeric).Value = m_tableid;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 10).Value = ngay;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_computerid", NpgsqlDbType.Numeric).Value = icomputerid;
                cmd.Parameters.Add("m_ins", NpgsqlDbType.Numeric).Value = m_ins;
                cmd.Parameters.Add("m_upd", NpgsqlDbType.Numeric).Value = m_upd;
                cmd.Parameters.Add("m_del", NpgsqlDbType.Numeric).Value = m_del;
                cmd.ExecuteNonQuery();
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message, sComputer, "eve_tables");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_eve_upd_del(string m_ngay, int m_tableid, int m_userid, string m_command, string m_noidung)
        {
            int icomputerid = get_dmcomputer();
            schema = user + mmyy(m_ngay) + ".upd_eve_upd_del";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(schema, con);
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.Add("m_tableid", NpgsqlDbType.Numeric).Value = m_tableid;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_computerid", NpgsqlDbType.Numeric).Value = icomputerid;
                cmd.Parameters.Add("m_command", NpgsqlDbType.Varchar, 3).Value = m_command;
                cmd.Parameters.Add("m_noidung", NpgsqlDbType.Text).Value = m_noidung;
                cmd.ExecuteNonQuery();
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message, sComputer, "eve_upd_del");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
            return true;
        }

        private int tableid()
        {
            ds = get_data("select max(id) as id from " + user + ".dmtables");
            if (ds.Tables[0].Rows[0]["id"].ToString() == "") return 1;
            else return int.Parse(ds.Tables[0].Rows[0]["id"].ToString()) + 1;
        }

        public int tableid(string mmyy, string tables)
        {
            int ret = 1;
            DataSet dstmp = new DataSet();// Khuong 09/11/2011
            ds = get_data("select * from " + user + ".dmtables where tables='" + tables + "'");
            if (ds.Tables[0].Rows.Count > 0) ret = int.Parse(ds.Tables[0].Rows[0]["id"].ToString());
            else
            {
                ret = tableid();
                string fie = "";
                dstmp = get_data("select * from " + user + mmyy + "." + tables + " where 1=2");// Khuong 09/11/2011
                for (int i = 0; i < dstmp.Tables[0].Columns.Count; i++) fie += dstmp.Tables[0].Columns[i].ColumnName.ToString().Trim() + "^";
                execute_data("insert into " + user + ".dmtables(id,tables,fields) values (" + ret + ",'" + tables + "','" + fie.Substring(0, fie.Length - 1) + "')");
            }
            return ret;
        }

        public string fields(string table, string dk)
        {
            string ret = "";
            DataTable dt = get_data("select * from " + table + " where " + dk).Tables[0];
            if (dt.Rows.Count > 0) for (int i = 0; i < dt.Columns.Count; i++) ret += dt.Rows[0][i].ToString().Trim() + "^";
            return (ret != "") ? ret.Substring(0, ret.Length - 1) : ret;
        }

        public int stt(string mabs, string maicd, decimal id)
        {
            int ret = 0;
            ds = get_data("select * from " + user + ".d_theodonll where mabs='" + mabs + "' and maicd='" + maicd + "'");
            if (ds.Tables[0].Rows.Count > 0)
                foreach (DataRow r in ds.Tables[0].Select("id=" + id))
                {
                    ret = int.Parse(r["stt"].ToString());
                    break;
                }
            return (ret == 0) ? ds.Tables[0].Rows.Count + 1 : ret;
        }

        public bool upd_lydokham(decimal m_maql, string m_lydo)
        {
            sql = "update " + user + ".lydokham set lydo=:m_lydo where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_lydo", NpgsqlDbType.Text).Value = m_lydo;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".lydokham(maql,lydo) values ";
                    sql += "(:m_maql,:m_lydo)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_lydo", NpgsqlDbType.Text).Value = m_lydo;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "lydokham");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public string get_lydokham(decimal maql)
        {
            ds = get_data("select lydo from " + user + ".lydokham where maql=" + maql);
            if (ds.Tables[0].Rows.Count > 0) return ds.Tables[0].Rows[0]["lydo"].ToString();
            else return "";
        }

        public bool upd_khoacdkham(string m_mabn, decimal m_mavaovien, decimal m_maql, string m_makp, string m_ngay, int m_userid)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".khoacdkham set makp=:m_makp,ngay=to_timestamp(:m_ngay,'dd/mm/yyyy hh24:mi'),userid=:m_userid where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".khoacdkham (mabn,mavaovien,maql,makp,ngay,userid) values (:m_mabn,:m_mavaovien,:m_maql,:m_makp,to_timestamp(:m_ngay,'dd/mm/yyyy hh24:mi'),:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message.ToString().Trim(), sComputer, "khoacdkham");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public DataSet merge(DataSet ds1, DataSet ds2)
        {
            if (ds2 == null) return ds1;
            else if (ds2.Tables.Count <= 0) return ds1;
            else if (ds2.Tables[0].Columns.Count <= 0) return ds1;
            DataRow r1;
            foreach (DataRow r in ds2.Tables[0].Rows)
            {
                r1 = ds1.Tables[0].NewRow();
                for (int i = 0; i < ds2.Tables[0].Columns.Count; i++) r1[i] = r[i].ToString();
                ds1.Tables[0].Rows.Add(r1);
            }
            return ds1;
        }

        public DataSet merge(DataSet ds1, DataRow[] dr)
        {
            DataRow r1;
            r1 = ds1.Tables[0].NewRow();
            for (int i = 0; i < dr.Length; i++) r1[i] = dr[0][i].ToString();
            ds1.Tables[0].Rows.Add(r1);
            return ds1;
        }

        public DataTable merge(DataTable dt1, DataRow[] dr)
        {
            DataRow r1;
            r1 = dt1.NewRow();
            for (int i = 0; i < dr.Length; i++) r1[i] = dr[0][i].ToString();
            dt1.Rows.Add(r1);
            return dt1;
        }

        public string for_num_ngay(string ngay)
        {
            if (ngay.IndexOf("/") >= 0) return for_num_ngay_yyyymmdd(ngay);
            //return "to_number(to_char(" + ngay + ", '" + f_ngay_yyyymmdd + "'))";
            return "date(to_char(" + ngay + ", '" + f_ngay_yyyymmdd + "'))";
        }
        public string for_num_ngay_yyyymmdd(string ngay)
        {
            return "date('" + for_ngay_yyyymmdd(ngay) + "')";
            //return "date(to_char(" + ngay + ", '" + f_ngay_yyyymmdd + "'))";

        }
        private string for_ngay_yyyymmdd(string ngay)
        {
            return ngay.Substring(6, 4) + ngay.Substring(3, 2) + ngay.Substring(0, 2);
        }
        public DataSet get_sum(DataSet m_ds, string[] m_id, string[] m_col)
        {
            DataSet ds = m_ds.Clone();
            try
            {
                foreach (DataColumn c in ds.Tables[0].Columns) c.DefaultValue = 0;
                foreach (DataColumn c in m_ds.Tables[0].Columns) c.DefaultValue = 0;
            }
            catch { }
            DataRow r1;
            string sql = "";
            foreach (DataRow r in m_ds.Tables[0].Rows)
            {
                sql = "";
                foreach (string s_col in m_id)
                {
                    if (sql == "")
                        sql += (s_col + "='" + r[s_col].ToString() + "'");
                    else
                        sql += (" and " + (s_col + "='" + r[s_col].ToString() + "'"));
                }
                r1 = getrowbyid(ds.Tables[0], sql);
                if (r1 != null)
                {
                    foreach (string col in m_col)
                    {
                        r1[col] = decimal.Parse(r1[col].ToString()) + decimal.Parse(r[col].ToString());
                    }
                }
                else
                {
                    r1 = ds.Tables[0].NewRow();
                    foreach (DataColumn c in ds.Tables[0].Columns) r1[c.ColumnName] = r[c.ColumnName];
                    ds.Tables[0].Rows.Add(r1);
                }
            }
            return ds;
        }
        public string replace(string m_sql_mmyy)
        {
            return m_sql_mmyy.Replace("medibvmmyy", "xxx").Replace("medibv", user);
        }
        public string f_ngay_yyyymmdd = "yyyymmdd";

        public DataSet get_data_yy(string nam, string str)
        {
            DataSet tmp = new DataSet();
            string m_user = user;
            bool be = true;
            foreach (DataRow dr in get_data("select mmyy from " + m_user + ".table where substr(mmyy,3,2)='" + nam.Substring(2, 2) + "' order by mmyy").Tables[0].Rows)
            {
                if (bMmyy(dr["mmyy"].ToString()))
                {
                    sql = str.Replace("xxx", m_user + dr["mmyy"].ToString().Trim());
                    if (be)
                    {
                        tmp = get_data(sql);
                        be = false;
                    }
                    else tmp.Merge(get_data(sql));
                }
            }
            return tmp;
        }
        public bool bNgayrv(string m_sql)
        {
            return (m_sql.IndexOf("benhanngtr") > 0 || m_sql.IndexOf("benhancc") > 0) ? true : false;
        }

        public bool upd_dmbschidinh(string m_ten, string m_benhvien, string m_khoa)
        {
            sql = "update " + user + ".dmbschidinh set khoa=:m_khoa";
            sql += " where ten=:m_ten and benhvien=:m_benhvien";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_khoa", NpgsqlDbType.Text).Value = m_khoa;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_benhvien", NpgsqlDbType.Text).Value = m_benhvien;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dmbschidinh(ten,benhvien,khoa) values (:m_ten,:m_benhvien,:m_khoa)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    cmd.Parameters.Add("m_benhvien", NpgsqlDbType.Text).Value = m_benhvien;
                    cmd.Parameters.Add("m_khoa", NpgsqlDbType.Text).Value = m_khoa;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dmbschidinh");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        #region cao vu 13/03/2013
        public bool upd_dmbschidinh(long id, string mabs, string m_tenbs, string m_benhvien
            , string m_khoa, string mabv, string manv, string ngaysinh, string diachi, string dienthoainha
            , string dienthoaididong, string email)
        {
            sql = "update " + user + ".dmbschidinh set mabs='" + mabs + "',manv='" + manv + "',mabv='" + mabv + "'"
                + ",ten=:ten,noilamviec=:benhvien,khoa='" + m_khoa + "',ngaysinh='" + ngaysinh + "',diachi=:diachi"
                + ",dienthoainha='" + dienthoainha + "',dtdd='" + dienthoaididong + "',email='" + email + "'"
                + " where id=" + id + " ";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                //cmd.Parameters.Add("m_khoa", NpgsqlDbType.Text).Value = m_khoa;
                cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = m_tenbs;
                cmd.Parameters.Add("benhvien", NpgsqlDbType.Text).Value = m_benhvien;
                cmd.Parameters.Add("diachi", NpgsqlDbType.Text).Value = diachi;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dmbschidinh(ten,noilamviec,khoa,manv,mabs,mabv"
                    + ",diachi,ngaysinh,dienthoainha,dtdd,email) "
                    + " values (:ten,:benhvien,'" + m_khoa + "','" + manv + "','" + mabs + "','" + mabv + "'"
                    + ",:diachi,'" + ngaysinh + "','" + dienthoainha + "','" + dienthoaididong + "','" + email + "')";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = m_tenbs;
                    cmd.Parameters.Add("benhvien", NpgsqlDbType.Text).Value = m_benhvien;
                    cmd.Parameters.Add("diachi", NpgsqlDbType.Text).Value = diachi;
                    //cmd.Parameters.Add("m_khoa", NpgsqlDbType.Text).Value = m_khoa;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dmbschidinh");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        #endregion
        public bool upd_dmbschidinh(string m_ten, string m_benhvien)
        {
            sql = "update " + user + ".dmbschidinh set ten=:m_ten,benhvien=:m_benhvien";
            sql += " where ten=:m_ten and benhvien=:m_benhvien";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_benhvien", NpgsqlDbType.Text).Value = m_benhvien;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_benhvien", NpgsqlDbType.Text).Value = m_benhvien;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dmbschidinh(ten,benhvien) values (:m_ten,:m_benhvien)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    cmd.Parameters.Add("m_benhvien", NpgsqlDbType.Text).Value = m_benhvien;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dmbschidinh");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_dmbvchidinh(string m_ten)
        {
            sql = "update " + user + ".dmbvchidinh set ten=:m_ten";
            sql += " where ten=:m_ten";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dmbvchidinh(ten) values (:m_ten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dmbvchidinh");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_dmkhoachidinh(string m_ten)
        {
            sql = "update " + user + ".dmkhoachidinh set ten=:m_ten";
            sql += " where ten=:m_ten";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dmkhoachidinh(ten) values (:m_ten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dmkhoachidinh");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_dmkythuat(string m_ten)
        {
            sql = "update " + user + ".dmkythuat set ten=:m_ten";
            sql += " where ten=:m_ten";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dmkythuat(ten) values (:m_ten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dmkythuat");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_tttiepdon(string m_ngay, decimal m_maql, string m_manv, string m_bacsy, string m_benhvien, string m_kythuat, string m_dienthoai,string m_mabschidinh,string m_manvsale,string m_mavung)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".tttiepdon set manv=:m_manv,bacsy=:m_bacsy,benhvien=:m_benhvien,kythuat=:m_kythuat,dienthoai=:m_dienthoai,mabsgioithieu=:m_mabschidinh,manvsale=:m_manvsale,idvung=:m_mavung";
            sql += " where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_manv", NpgsqlDbType.Varchar, 4).Value = m_manv;
                cmd.Parameters.Add("m_bacsy", NpgsqlDbType.Text).Value = m_bacsy;
                cmd.Parameters.Add("m_benhvien", NpgsqlDbType.Text).Value = m_benhvien;
                cmd.Parameters.Add("m_kythuat", NpgsqlDbType.Text).Value = m_kythuat;
                cmd.Parameters.Add("m_dienthoai", NpgsqlDbType.Text).Value = m_dienthoai;
                cmd.Parameters.Add("m_mabschidinh", NpgsqlDbType.Text).Value = m_mabschidinh;
                cmd.Parameters.Add("m_manvsale", NpgsqlDbType.Text).Value = m_manvsale;
                cmd.Parameters.Add("m_mavung", NpgsqlDbType.Numeric).Value = m_mavung;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".tttiepdon(maql,manv,bacsy,benhvien,kythuat,dienthoai,mabsgioithieu,manvsale,idvung) values (:m_maql,:m_manv,:m_bacsy,:m_benhvien,:m_kythuat,:m_dienthoai,:m_mabschidinh,:m_manvsale,:m_mavung)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_manv", NpgsqlDbType.Varchar, 4).Value = m_manv;
                    cmd.Parameters.Add("m_bacsy", NpgsqlDbType.Text).Value = m_bacsy;
                    cmd.Parameters.Add("m_benhvien", NpgsqlDbType.Text).Value = m_benhvien;
                    cmd.Parameters.Add("m_kythuat", NpgsqlDbType.Text).Value = m_kythuat;
                    cmd.Parameters.Add("m_dienthoai", NpgsqlDbType.Text).Value = m_dienthoai;
                    cmd.Parameters.Add("m_mabschidinh", NpgsqlDbType.Text).Value = m_mabschidinh;
                    cmd.Parameters.Add("m_manvsale", NpgsqlDbType.Text).Value = m_manvsale;
                    cmd.Parameters.Add("m_mavung", NpgsqlDbType.Numeric).Value = m_mavung;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message, sComputer, "tttiepdon");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_cls_ketqua(decimal m_id, int m_loai, string m_mabn, decimal m_mavaovien, decimal m_maql, string m_ngay, int m_madoituong, string m_idcls, string m_idvp, string m_bscd, string m_makpcd, string m_bvcd, decimal m_cp, decimal m_lt, decimal m_bh, string m_chandoan, string m_ketqua, string m_mabs, string m_maktv, int m_idmay, int m_idvung, int m_idvungdg, int m_idloai, int m_kqcuoi, string m_madia, int m_soluongphim, string m_nhankq, int m_userid)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".cls_ketqua set loai=:m_loai,mabn=:m_mabn,mavaovien=:m_mavaovien,";
            sql += " maql=:m_maql,ngay=to_timestamp(:m_ngay,'dd/mm/yyyy hh24:mi'),madoituong=:m_madoituong,";
            sql += " idcls=:m_idcls,idvp=:m_idvp,bscd=:m_bscd,makpcd=:m_makpcd,bvcd=:m_bvcd,cp=:m_cp,lt=:m_lt,bh=:m_bh,";
            sql += " chandoan=:m_chandoan,";
            if (m_ketqua != "") sql += "ketqua=:m_ketqua,";
            sql += " mabs=:m_mabs,maktv=:m_maktv,idmay=:m_idmay,idvung=:m_idvung,idvungdg=:m_idvungdg,";
            sql += " idloai=:m_idloai,kqcuoi=:m_kqcuoi,madia=:m_madia,soluongphim=:m_soluongphim,nhankq=:m_nhankq,userid=:m_userid";
            sql += " where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                cmd.Parameters.Add("m_idcls", NpgsqlDbType.Varchar, 11).Value = m_idcls;
                cmd.Parameters.Add("m_idvp", NpgsqlDbType.Varchar, 12).Value = m_idvp;
                cmd.Parameters.Add("m_bscd", NpgsqlDbType.Text).Value = m_bscd;
                cmd.Parameters.Add("m_makpcd", NpgsqlDbType.Text).Value = m_makpcd;
                cmd.Parameters.Add("m_bvcd", NpgsqlDbType.Text).Value = m_bvcd;
                cmd.Parameters.Add("m_cp", NpgsqlDbType.Numeric).Value = m_cp;
                cmd.Parameters.Add("m_lt", NpgsqlDbType.Numeric).Value = m_lt;
                cmd.Parameters.Add("m_bh", NpgsqlDbType.Numeric).Value = m_bh;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                if (m_ketqua != "") cmd.Parameters.Add("m_ketqua", NpgsqlDbType.Text).Value = m_ketqua;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_maktv", NpgsqlDbType.Varchar, 4).Value = m_maktv;
                cmd.Parameters.Add("m_idmay", NpgsqlDbType.Numeric).Value = m_idmay;
                cmd.Parameters.Add("m_idvung", NpgsqlDbType.Numeric).Value = m_idvung;
                cmd.Parameters.Add("m_idvungdg", NpgsqlDbType.Numeric).Value = m_idvungdg;
                cmd.Parameters.Add("m_idloai", NpgsqlDbType.Numeric).Value = m_idloai;
                cmd.Parameters.Add("m_kqcuoi", NpgsqlDbType.Numeric).Value = m_kqcuoi;
                cmd.Parameters.Add("m_madia", NpgsqlDbType.Varchar, 20).Value = m_madia;
                cmd.Parameters.Add("m_soluongphim", NpgsqlDbType.Numeric).Value = m_soluongphim;
                cmd.Parameters.Add("m_nhankq", NpgsqlDbType.Text).Value = m_nhankq;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".cls_ketqua (id,loai,mabn,mavaovien,maql,ngay,madoituong,idcls,idvp,bscd,makpcd,bvcd,cp,lt,bh,chandoan,";
                    if (m_ketqua != "") sql += "ketqua,";
                    sql += "mabs,maktv,idmay,idvung,idvungdg,idloai,kqcuoi,madia,soluongphim,nhankq,userid) values (:m_id,:m_loai,:m_mabn,:m_mavaovien,:m_maql,to_timestamp(:m_ngay,'dd/mm/yyyy hh24:mi'),:m_madoituong,:m_idcls,:m_idvp,:m_bscd,:m_makpcd,:m_bvcd,:m_cp,:m_lt,:m_bh,:m_chandoan,";
                    if (m_ketqua != "") sql += ":m_ketqua,";
                    sql += ":m_mabs,:m_maktv,:m_idmay,:m_idvung,:m_idvungdg,:m_idloai,:m_kqcuoi,:m_madia,:m_soluongphim,:m_nhankq,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                    cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                    cmd.Parameters.Add("m_idcls", NpgsqlDbType.Varchar, 11).Value = m_idcls;
                    cmd.Parameters.Add("m_idvp", NpgsqlDbType.Varchar, 12).Value = m_idvp;
                    cmd.Parameters.Add("m_bscd", NpgsqlDbType.Text).Value = m_bscd;
                    cmd.Parameters.Add("m_makpcd", NpgsqlDbType.Text).Value = m_makpcd;
                    cmd.Parameters.Add("m_bvcd", NpgsqlDbType.Text).Value = m_bvcd;
                    cmd.Parameters.Add("m_cp", NpgsqlDbType.Numeric).Value = m_cp;
                    cmd.Parameters.Add("m_lt", NpgsqlDbType.Numeric).Value = m_lt;
                    cmd.Parameters.Add("m_bh", NpgsqlDbType.Numeric).Value = m_bh;
                    cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                    if (m_ketqua != "") cmd.Parameters.Add("m_ketqua", NpgsqlDbType.Text).Value = m_ketqua;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    cmd.Parameters.Add("m_maktv", NpgsqlDbType.Varchar, 4).Value = m_maktv;
                    cmd.Parameters.Add("m_idmay", NpgsqlDbType.Numeric).Value = m_idmay;
                    cmd.Parameters.Add("m_idvung", NpgsqlDbType.Numeric).Value = m_idvung;
                    cmd.Parameters.Add("m_idvungdg", NpgsqlDbType.Numeric).Value = m_idvungdg;
                    cmd.Parameters.Add("m_idloai", NpgsqlDbType.Numeric).Value = m_idloai;
                    cmd.Parameters.Add("m_kqcuoi", NpgsqlDbType.Numeric).Value = m_kqcuoi;
                    cmd.Parameters.Add("m_madia", NpgsqlDbType.Varchar, 20).Value = m_madia;
                    cmd.Parameters.Add("m_soluongphim", NpgsqlDbType.Numeric).Value = m_soluongphim;
                    cmd.Parameters.Add("m_nhankq", NpgsqlDbType.Text).Value = m_nhankq;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message.ToString().Trim(), sComputer, "cls_ketqua");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_cls_ketqua_cd(decimal m_id, int m_loai, string m_mabn, decimal m_mavaovien, decimal m_maql, string m_ngay, int m_madoituong, string m_idcls, string m_idvp, string m_bscd, string m_makpcd, string m_bvcd, decimal m_cp, decimal m_lt, decimal m_bh, string m_chandoan, int m_idmay, int m_idvung, int m_kqcuoi, string m_nhankq, int m_userid)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".cls_ketqua set loai=:m_loai,mabn=:m_mabn,mavaovien=:m_mavaovien,";
            sql += " maql=:m_maql,ngay=to_timestamp(:m_ngay,'dd/mm/yyyy hh24:mi'),madoituong=:m_madoituong,";
            sql += " idcls=:m_idcls,idvp=:m_idvp,bscd=:m_bscd,makpcd=:m_makpcd,bvcd=:m_bvcd,cp=:m_cp,lt=:m_lt,bh=:m_bh,";
            if (m_chandoan != "") sql += "chandoan=:m_chandoan,";
            sql += " idmay=:m_idmay,idvung=:m_idvung,";
            sql += " kqcuoi=:m_kqcuoi,nhankq=:m_nhankq,userid=:m_userid";
            sql += " where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                cmd.Parameters.Add("m_idcls", NpgsqlDbType.Varchar, 11).Value = m_idcls;
                cmd.Parameters.Add("m_idvp", NpgsqlDbType.Varchar, 12).Value = m_idvp;
                cmd.Parameters.Add("m_bscd", NpgsqlDbType.Text).Value = m_bscd;
                cmd.Parameters.Add("m_makpcd", NpgsqlDbType.Text).Value = m_makpcd;
                cmd.Parameters.Add("m_bvcd", NpgsqlDbType.Text).Value = m_bvcd;
                cmd.Parameters.Add("m_cp", NpgsqlDbType.Numeric).Value = m_cp;
                cmd.Parameters.Add("m_lt", NpgsqlDbType.Numeric).Value = m_lt;
                cmd.Parameters.Add("m_bh", NpgsqlDbType.Numeric).Value = m_bh;
                if (m_chandoan != "") cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_idmay", NpgsqlDbType.Numeric).Value = m_idmay;
                cmd.Parameters.Add("m_idvung", NpgsqlDbType.Numeric).Value = m_idvung;
                cmd.Parameters.Add("m_kqcuoi", NpgsqlDbType.Numeric).Value = m_kqcuoi;
                cmd.Parameters.Add("m_nhankq", NpgsqlDbType.Text).Value = m_nhankq;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".cls_ketqua (id,loai,mabn,mavaovien,maql,ngay,madoituong,idcls,idvp,bscd,makpcd,bvcd,cp,lt,bh,";
                    if (m_chandoan != "") sql += "chandoan,";
                    sql += "idmay,idvung,kqcuoi,nhankq,userid) ";
                    sql += "values (:m_id,:m_loai,:m_mabn,:m_mavaovien,:m_maql,to_timestamp(:m_ngay,'dd/mm/yyyy hh24:mi'),:m_madoituong,:m_idcls,:m_idvp,:m_bscd,:m_makpcd,:m_bvcd,:m_cp,:m_lt,:m_bh,";
                    if (m_chandoan != "") sql += ":m_chandoan,";
                    sql += ":m_idmay,:m_idvung,:m_kqcuoi,:m_nhankq,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                    cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                    cmd.Parameters.Add("m_idcls", NpgsqlDbType.Varchar, 11).Value = m_idcls;
                    cmd.Parameters.Add("m_idvp", NpgsqlDbType.Varchar, 12).Value = m_idvp;
                    cmd.Parameters.Add("m_bscd", NpgsqlDbType.Text).Value = m_bscd;
                    cmd.Parameters.Add("m_makpcd", NpgsqlDbType.Text).Value = m_makpcd;
                    cmd.Parameters.Add("m_bvcd", NpgsqlDbType.Text).Value = m_bvcd;
                    cmd.Parameters.Add("m_cp", NpgsqlDbType.Numeric).Value = m_cp;
                    cmd.Parameters.Add("m_lt", NpgsqlDbType.Numeric).Value = m_lt;
                    cmd.Parameters.Add("m_bh", NpgsqlDbType.Numeric).Value = m_bh;
                    if (m_chandoan != "") cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                    cmd.Parameters.Add("m_idmay", NpgsqlDbType.Numeric).Value = m_idmay;
                    cmd.Parameters.Add("m_idvung", NpgsqlDbType.Numeric).Value = m_idvung;
                    cmd.Parameters.Add("m_kqcuoi", NpgsqlDbType.Numeric).Value = m_kqcuoi;
                    cmd.Parameters.Add("m_nhankq", NpgsqlDbType.Text).Value = m_nhankq;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message.ToString().Trim(), sComputer, "cls_ketqua");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_cls_ketqua_kq(decimal m_id, string m_ngay, string m_bscd, string m_makpcd, string m_bvcd, string m_chandoan, string m_ketqua, string m_mabs, string m_maktv, int m_idmay, int m_idvung, int m_idvungdg, int m_idloai, int m_kqcuoi, string m_madia, int m_soluongphim)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".cls_ketqua set bscd=:m_bscd,makpcd=:m_makpcd,bvcd=:m_bvcd,chandoan=:m_chandoan,ketqua=:m_ketqua,mabs=:m_mabs,maktv=:m_maktv,idmay=:m_idmay,idvung=:m_idvung,idvungdg=:m_idvungdg,";
            sql += " idloai=:m_idloai,kqcuoi=:m_kqcuoi,madia=:m_madia,soluongphim=:m_soluongphim where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_bscd", NpgsqlDbType.Text).Value = m_bscd;
                cmd.Parameters.Add("m_makpcd", NpgsqlDbType.Text).Value = m_makpcd;
                cmd.Parameters.Add("m_bvcd", NpgsqlDbType.Text).Value = m_bvcd;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_ketqua", NpgsqlDbType.Text).Value = m_ketqua;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_maktv", NpgsqlDbType.Varchar, 4).Value = m_maktv;
                cmd.Parameters.Add("m_idmay", NpgsqlDbType.Numeric).Value = m_idmay;
                cmd.Parameters.Add("m_idvung", NpgsqlDbType.Numeric).Value = m_idvung;
                cmd.Parameters.Add("m_idvungdg", NpgsqlDbType.Numeric).Value = m_idvungdg;
                cmd.Parameters.Add("m_idloai", NpgsqlDbType.Numeric).Value = m_idloai;
                cmd.Parameters.Add("m_kqcuoi", NpgsqlDbType.Numeric).Value = m_kqcuoi;
                cmd.Parameters.Add("m_madia", NpgsqlDbType.Varchar, 20).Value = m_madia;
                cmd.Parameters.Add("m_soluongphim", NpgsqlDbType.Numeric).Value = m_soluongphim;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message.ToString().Trim(), sComputer, "cls_ketqua");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_cls_ketqua(string m_ngay, string m_idcls, int m_loai, string m_ketqua, string m_mabs)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".cls_ketqua set ketqua=:m_ketqua";
            if (m_mabs != "") sql += ",mabs=:m_mabs ";
            sql += " where idcls=:m_idcls and loai=:m_loai";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ketqua", NpgsqlDbType.Text).Value = m_ketqua;
                if (m_mabs != "") cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_idcls", NpgsqlDbType.Varchar).Value = m_idcls;
                cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message.ToString().Trim(), sComputer, "cls_ketqua");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_cls_motact(string m_ngay, decimal m_id, int m_canquang)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".cls_motact set canquang=:m_canquang where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_canquang", NpgsqlDbType.Numeric).Value = m_canquang;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".cls_motact (id,canquang,gayme,phanung,sa) values (:m_id,:m_canquang,0,0,0)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_canquang", NpgsqlDbType.Numeric).Value = m_canquang;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message.ToString().Trim(), sComputer, "cls_motact");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_ketqua_ct(string m_mdb, string m_id, string m_ten, string m_tuoi, string m_tele, string m_diachi, int m_phai, string m_bscd, string m_kpcd, string m_bvcd,
            string m_vungct, string m_canquang, string m_ngaygio_bd, string m_ngaygio_kt, string m_ketqua, string m_lamsang, string m_miengiam, string m_bskham,
            string m_ktv_kham1, string m_ktv_kham2, decimal m_cp, string m_ngaydk, string m_ngayhen, string m_madia, int m_slphim, string m_film_id, string m_ngaykham,
            int n_cq, string m_maba, int n_sa, int m_pu, int m_cokq, string m_idtp, decimal m_thlt)
        {
            OleDbConnection acon;
            OleDbCommand acmd;
            sql = "update BNHAN set ten='" + m_ten + "',tuoi='" + m_tuoi + "',";
            sql += " tele='" + m_tele + "',diachi='" + m_diachi + "',sex=" + m_phai.ToString() + ",";
            sql += " BS_CD='" + m_bscd + "',KHOA_CD='" + m_kpcd + "',bv_cd='" + m_bvcd + "',VUNG_CT='" + m_vungct + "',canquang='" + m_canquang + "',";
            sql += " TIMESTART=#" + m_ngaygio_bd + "#,TIMEEND=#" + m_ngaygio_kt + "#,ketqua='" + m_ketqua + "',lamsang='" + m_lamsang + "',";
            sql += " MIENGIAM='" + m_miengiam + "',BS_KHAM='" + m_bskham + "',KTV_KHAM1='" + m_ktv_kham1 + "',KTV_KHAM2='" + m_ktv_kham2 + "',";
            sql += " CHIPHI=" + m_cp.ToString() + ",NGAYDK='" + m_ngaydk + "',NGAYHEN='" + m_ngayhen + "',MADIAluu='" + m_madia + "',slphim=" + m_slphim.ToString() + ",";
            sql += " FILM_ID='" + m_film_id + "',ngaykham='" + m_ngaykham + "',CQUANG=" + n_cq.ToString() + ",MA_BENH_AN='" + m_maba + "',SIEU_AM=" + n_sa.ToString() + ",P_UNG=" + m_pu.ToString() + ",";
            sql += " CO_KQUA=" + m_cokq.ToString() + ",idtp='" + m_idtp + "',THLT=" + m_thlt.ToString() + " where id='" + m_id + "'";
            acon = new OleDbConnection("Provider=Microsoft.Jet.OLEDB.4.0;User Id=;Password=;Jet OLEDB:Database Password=;Data Source=" + m_mdb);
            try
            {
                acon.Open();
                acmd = new OleDbCommand(sql, acon);
                acmd.CommandType = CommandType.Text;
                int irec = acmd.ExecuteNonQuery();
                acmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into BNHAN(ID,ten,tuoi,tele,diachi,sex,bs_cd,khoa_cd,bv_cd,vung_ct, ";
                    sql += " CANQUANG,TIMESTART,TIMEend,ketqua,LAMSANG,MIENGIAM,BS_KHAM,KTV_KHAM1,";
                    sql += " KTV_KHAM2,CHIPHI,NGAYDK,NGAYHEN,MADIALUU,SLPHIM,FILM_ID,NGAYKHAM,CQUANG,";
                    sql += " MA_BENH_AN,SIEU_AM,P_UNG,CO_KQUA,IDTP,THLT )";
                    sql += " values ('" + m_id + "','" + m_ten + "','" + m_tuoi + "','" + m_tele + "','" + m_diachi;
                    sql += "'," + m_phai.ToString() + ",'" + m_bscd + "','" + m_kpcd + "','" + m_bvcd + "','" + m_vungct + "','" + m_canquang + "',";
                    sql += " #" + m_ngaygio_bd + "#,#" + m_ngaygio_kt + "#,'" + m_ketqua + "','" + m_lamsang + "','";
                    sql += m_miengiam + "','" + m_bskham + "','" + m_ktv_kham1 + "','" + m_ktv_kham2 + "',";
                    sql += m_cp.ToString() + ",'" + m_ngaydk + "','" + m_ngayhen + "','" + m_madia + "'," + m_slphim.ToString() + ",";
                    sql += "'" + m_film_id + "','" + m_ngaykham + "'," + n_cq.ToString() + ",'" + m_maba + "'," + n_sa.ToString() + "," + m_pu.ToString() + ",";
                    sql += m_cokq.ToString() + ",'" + m_idtp + "'," + m_thlt.ToString() + ")";
                    acmd = new OleDbCommand(sql, acon);
                    acmd.CommandType = CommandType.Text;
                    irec = acmd.ExecuteNonQuery();
                    acmd.Dispose();
                }
            }
            catch (OleDbException ex)
            {
                upd_error(ex.Message, sComputer, "bnhan");
                return false;
            }
            finally
            {
                acon.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_ketqua_ct(string m_mdb, string m_id, string m_ten, string m_tuoi, string m_diachi, int m_phai, string m_bscd, string m_kpcd, string m_bvcd,
        string m_vungct, string m_canquang, string m_ngaygio_bd, string m_ngaygio_kt, string m_lamsang, string m_miengiam, string m_bskham,
        string m_ktv_kham1, string m_ktv_kham2, decimal m_cp, string m_ngaydk, string m_ngayhen, string m_madia, int m_slphim, string m_film_id, string m_ngaykham,
        int n_cq, string m_maba, int n_sa, int m_pu, int m_cokq)
        {
            OleDbConnection acon;
            OleDbCommand acmd;
            sql = "update BNHAN set ten='" + m_ten + "',tuoi='" + m_tuoi + "',";
            sql += " diachi='" + m_diachi + "',sex=" + m_phai.ToString() + ",";
            sql += " BS_CD='" + m_bscd + "',KHOA_CD='" + m_kpcd + "',bv_cd='" + m_bvcd + "',VUNG_CT='" + m_vungct + "',canquang='" + m_canquang + "',";
            sql += " TIMESTART=#" + m_ngaygio_bd + "#,TIMEEND=#" + m_ngaygio_kt + "#,lamsang='" + m_lamsang + "',";
            sql += " MIENGIAM='" + m_miengiam + "',BS_KHAM='" + m_bskham + "',KTV_KHAM1='" + m_ktv_kham1 + "',KTV_KHAM2='" + m_ktv_kham2 + "',";
            sql += " CHIPHI=" + m_cp.ToString() + ",NGAYDK='" + m_ngaydk + "',NGAYHEN='" + m_ngayhen + "',MADIAluu='" + m_madia + "',slphim=" + m_slphim.ToString() + ",";
            sql += " FILM_ID='" + m_film_id + "',ngaykham='" + m_ngaykham + "',CQUANG=" + n_cq.ToString() + ",MA_BENH_AN='" + m_maba + "',SIEU_AM=" + n_sa.ToString() + ",P_UNG=" + m_pu.ToString() + ",";
            sql += " CO_KQUA=" + m_cokq.ToString() + " where id='" + m_id + "'";
            acon = new OleDbConnection("Provider=Microsoft.Jet.OLEDB.4.0;User Id=;Password=;Jet OLEDB:Database Password=;Data Source=" + m_mdb);
            try
            {
                acon.Open();
                acmd = new OleDbCommand(sql, acon);
                acmd.CommandType = CommandType.Text;
                int irec = acmd.ExecuteNonQuery();
                acmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into BNHAN(ID,ten,tuoi,diachi,sex,bs_cd,khoa_cd,bv_cd,vung_ct, ";
                    sql += " CANQUANG,TIMESTART,TIMEend,LAMSANG,MIENGIAM,BS_KHAM,KTV_KHAM1,";
                    sql += " KTV_KHAM2,CHIPHI,NGAYDK,NGAYHEN,MADIALUU,SLPHIM,FILM_ID,NGAYKHAM,CQUANG,";
                    sql += " MA_BENH_AN,SIEU_AM,P_UNG,CO_KQUA)";
                    sql += " values ('" + m_id + "','" + m_ten + "','" + m_tuoi + "','" + m_diachi;
                    sql += "'," + m_phai.ToString() + ",'" + m_bscd + "','" + m_kpcd + "','" + m_bvcd + "','" + m_vungct + "','" + m_canquang + "',";
                    sql += " #" + m_ngaygio_bd + "#,#" + m_ngaygio_kt + "#,'" + m_lamsang + "','";
                    sql += m_miengiam + "','" + m_bskham + "','" + m_ktv_kham1 + "','" + m_ktv_kham2 + "',";
                    sql += m_cp.ToString() + ",'" + m_ngaydk + "','" + m_ngayhen + "','" + m_madia + "'," + m_slphim.ToString() + ",";
                    sql += "'" + m_film_id + "','" + m_ngaykham + "'," + n_cq.ToString() + ",'" + m_maba + "'," + n_sa.ToString() + "," + m_pu.ToString() + ",";
                    sql += m_cokq.ToString() + ")";
                    acmd = new OleDbCommand(sql, acon);
                    acmd.CommandType = CommandType.Text;
                    irec = acmd.ExecuteNonQuery();
                    acmd.Dispose();
                }
            }
            catch (OleDbException ex)
            {
                upd_error(ex.Message, sComputer, "bnhan");
                return false;
            }
            finally
            {
                acon.Close(); con.Dispose();
            }
            return true;
        }

        public string get_ket_qua_cls(string m_mdb, string m_id)
        {
            sql = "select ketqua from bnhan where trim(id)='" + m_id.Trim() + "'";
            ds = get_data_acc(sql, m_mdb);
            if (ds.Tables[0].Rows.Count > 0) return ds.Tables[0].Rows[0]["ketqua"].ToString();
            else return "";
        }

        public bool upd_ct_nhomvp(decimal v_ma, string v_matat, string v_ten, int v_stt)
        {
            sql = "update " + user + ".ct_nhomvp set matat=:v_matat,ten=:v_ten,stt=:v_stt where ma=:v_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("v_matat", NpgsqlDbType.Varchar, 20).Value = v_matat;
                cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
                cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
                cmd.Parameters.Add("v_ma", NpgsqlDbType.Numeric).Value = v_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".ct_nhomvp (ma,matat,ten,stt) values (:v_ma,:v_matat,:v_ten,:v_stt)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_ma", NpgsqlDbType.Numeric).Value = v_ma;
                    cmd.Parameters.Add("v_matat", NpgsqlDbType.Varchar, 20).Value = v_matat;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
                    cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ct_nhomvp");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_ct_loaivp(decimal v_id, int v_id_nhom, int v_stt, string v_ma, string v_ten, int v_userid, string v_computer)
        {
            sql = "update " + user + ".ct_loaivp set id_nhom=:v_id_nhom,stt=:v_stt,ma=:v_ma,ten=:v_ten,userid=:v_userid,computer=:v_computer where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("v_id_nhom", NpgsqlDbType.Numeric).Value = v_id_nhom;
                cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
                cmd.Parameters.Add("v_ma", NpgsqlDbType.Text).Value = v_ma;
                cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
                cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                cmd.Parameters.Add("v_computer", NpgsqlDbType.Varchar, 20).Value = v_computer;
                cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".ct_loaivp(id,id_nhom,stt,ma,ten,userid,computer) values (:v_id,:v_id_nhom,:v_stt,:v_ma,:v_ten,:v_userid,:v_computer)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_id_nhom", NpgsqlDbType.Numeric).Value = v_id_nhom;
                    cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
                    cmd.Parameters.Add("v_ma", NpgsqlDbType.Text).Value = v_ma;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                    cmd.Parameters.Add("v_computer", NpgsqlDbType.Varchar, 20).Value = v_computer;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ct_loaivp");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_ct_giavp(decimal v_id, decimal v_id_loai, int v_stt, string v_ma, string v_ten, string v_dvt, string v_makp, decimal v_gia_nv, decimal v_gia_ngv, string v_ghichu, int v_userid)
        {
            sql = "update " + user + ".ct_giavp set id_loai=:v_id_loai,stt=:v_stt,ma=:v_ma,ten=:v_ten,dvt=:v_dvt,makp=:v_makp,gia_nv=:v_gia_nv,gia_ngv=:v_gia_ngv,";
            sql += "ghichu=:v_ghichu,userid=:v_userid where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("v_id_loai", NpgsqlDbType.Numeric).Value = v_id_loai;
                cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
                cmd.Parameters.Add("v_ma", NpgsqlDbType.Text).Value = v_ma;
                cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
                cmd.Parameters.Add("v_dvt", NpgsqlDbType.Text, 20).Value = v_dvt;
                cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = v_makp;
                cmd.Parameters.Add("v_gia_nv", NpgsqlDbType.Numeric).Value = v_gia_nv;
                cmd.Parameters.Add("v_gia_ngv", NpgsqlDbType.Numeric).Value = v_gia_ngv;
                cmd.Parameters.Add("v_ghichu", NpgsqlDbType.Text).Value = v_ghichu;
                cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".ct_giavp(id,id_loai,stt,ma,ten,dvt,makp,gia_nv,gia_ngv,ghichu,userid) values (:v_id,:v_id_loai,:v_stt,:v_ma,:v_ten,:v_dvt,:v_makp,:v_gia_nv,:v_gia_ngv,:v_ghichu,:v_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_id_loai", NpgsqlDbType.Numeric).Value = v_id_loai;
                    cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
                    cmd.Parameters.Add("v_ma", NpgsqlDbType.Text).Value = v_ma;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
                    cmd.Parameters.Add("v_dvt", NpgsqlDbType.Text, 20).Value = v_dvt;
                    cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = v_makp;
                    cmd.Parameters.Add("v_gia_nv", NpgsqlDbType.Numeric).Value = v_gia_nv;
                    cmd.Parameters.Add("v_gia_ngv", NpgsqlDbType.Numeric).Value = v_gia_ngv;
                    cmd.Parameters.Add("v_ghichu", NpgsqlDbType.Text).Value = v_ghichu;
                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ct_giavp");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_ct_doan(decimal id, string sohd, string ngay, int loai, string ma, string ten, string diachi,
            string dienthoai, string fax, string email, string masothue, string nguoilienhe, string ghichu, int userid)
        {
            sql = "update " + user + ".ct_doan set sohd=:sohd,ngay=to_timestamp(:ngay,'dd/mm/yyyy'),loai=:loai,";
            sql += "ma=:ma,ten=:ten,diachi=:diachi,dienthoai=:dienthoai,fax=:fax,email=:email,";
            sql += " masothue=:masothue,nguoilienhe=:nguoilienhe,ghichu=:ghichu,";
            sql += " userid=:userid where id=:id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("sohd", NpgsqlDbType.Text).Value = sohd;
                cmd.Parameters.Add("ngay", NpgsqlDbType.Varchar, 10).Value = ngay;
                cmd.Parameters.Add("loai", NpgsqlDbType.Numeric).Value = loai;
                cmd.Parameters.Add("ma", NpgsqlDbType.Varchar, 3).Value = ma;
                cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                cmd.Parameters.Add("diachi", NpgsqlDbType.Text).Value = diachi;
                cmd.Parameters.Add("dienthoai", NpgsqlDbType.Text).Value = dienthoai;
                cmd.Parameters.Add("fax", NpgsqlDbType.Text).Value = fax;
                cmd.Parameters.Add("email", NpgsqlDbType.Text).Value = email;
                cmd.Parameters.Add("masothue", NpgsqlDbType.Text).Value = masothue;
                cmd.Parameters.Add("nguoilienhe", NpgsqlDbType.Text).Value = nguoilienhe;
                cmd.Parameters.Add("ghichu", NpgsqlDbType.Text).Value = ghichu;
                cmd.Parameters.Add("userid", NpgsqlDbType.Numeric).Value = userid;
                cmd.Parameters.Add("id", NpgsqlDbType.Numeric).Value = id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".ct_doan (id,sohd,ngay,loai,ma,ten,diachi,dienthoai,fax,email,masothue,nguoilienhe,ghichu,userid) values (:id,:sohd,to_timestamp(:ngay,'dd/mm/yyyy'),:loai,:ma,:ten,:diachi,:dienthoai,:fax,:email,:masothue,:nguoilienhe,:ghichu,:userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("id", NpgsqlDbType.Numeric).Value = id;
                    cmd.Parameters.Add("sohd", NpgsqlDbType.Text).Value = sohd;
                    cmd.Parameters.Add("ngay", NpgsqlDbType.Varchar, 10).Value = ngay;
                    cmd.Parameters.Add("loai", NpgsqlDbType.Numeric).Value = loai;
                    cmd.Parameters.Add("ma", NpgsqlDbType.Varchar, 3).Value = ma;
                    cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                    cmd.Parameters.Add("diachi", NpgsqlDbType.Text).Value = diachi;
                    cmd.Parameters.Add("dienthoai", NpgsqlDbType.Text).Value = dienthoai;
                    cmd.Parameters.Add("fax", NpgsqlDbType.Text).Value = fax;
                    cmd.Parameters.Add("email", NpgsqlDbType.Text).Value = email;
                    cmd.Parameters.Add("masothue", NpgsqlDbType.Text).Value = masothue;
                    cmd.Parameters.Add("nguoilienhe", NpgsqlDbType.Text).Value = nguoilienhe;
                    cmd.Parameters.Add("ghichu", NpgsqlDbType.Text).Value = ghichu;
                    cmd.Parameters.Add("userid", NpgsqlDbType.Numeric).Value = userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ct_doan");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_ct_donvi(decimal id, decimal iddoan, decimal stt, string ma, string ten, string tu, string den, int userid)
        {
            sql = "update " + user + ".ct_donvi set iddoan=:iddoan,stt=:stt,";
            sql += "ma=:ma,ten=:ten,tu=to_timestamp(:tu,'dd/mm/yyyy'),den=to_timestamp(:den,'dd/mm/yyyy'),userid=:userid";
            sql += " where id=:id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("iddoan", NpgsqlDbType.Numeric).Value = iddoan;
                cmd.Parameters.Add("stt", NpgsqlDbType.Numeric).Value = stt;
                cmd.Parameters.Add("ma", NpgsqlDbType.Varchar, 2).Value = ma;
                cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                cmd.Parameters.Add("tu", NpgsqlDbType.Varchar, 10).Value = tu;
                cmd.Parameters.Add("den", NpgsqlDbType.Varchar, 10).Value = den;
                cmd.Parameters.Add("userid", NpgsqlDbType.Numeric).Value = userid;
                cmd.Parameters.Add("id", NpgsqlDbType.Numeric).Value = id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".ct_donvi (id,iddoan,stt,ma,ten,tu,den,userid) values (:id,:iddoan,:stt,:ma,:ten,to_timestamp(:tu,'dd/mm/yyyy'),to_timestamp(:den,'dd/mm/yyyy'),:userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("id", NpgsqlDbType.Numeric).Value = id;
                    cmd.Parameters.Add("iddoan", NpgsqlDbType.Numeric).Value = iddoan;
                    cmd.Parameters.Add("stt", NpgsqlDbType.Numeric).Value = stt;
                    cmd.Parameters.Add("ma", NpgsqlDbType.Varchar, 2).Value = ma;
                    cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                    cmd.Parameters.Add("tu", NpgsqlDbType.Varchar, 10).Value = tu;
                    cmd.Parameters.Add("den", NpgsqlDbType.Varchar, 10).Value = den;
                    cmd.Parameters.Add("userid", NpgsqlDbType.Numeric).Value = userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ct_donvi");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_ct_muc(decimal id, decimal iddoan, decimal stt, int phai, string tt, string namsinh, string ghichu)
        {
            sql = "update " + user + ".ct_muc set iddoan=:iddoan,stt=:stt,phai=:phai,tt=:tt,namsinh=:namsinh,ghichu=:ghichu where id=:id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("iddoan", NpgsqlDbType.Numeric).Value = iddoan;
                cmd.Parameters.Add("stt", NpgsqlDbType.Numeric).Value = stt;
                cmd.Parameters.Add("phai", NpgsqlDbType.Numeric).Value = phai;
                cmd.Parameters.Add("tt", NpgsqlDbType.Varchar, 2).Value = tt;
                cmd.Parameters.Add("namsinh", NpgsqlDbType.Varchar, 4).Value = namsinh;
                cmd.Parameters.Add("ghichu", NpgsqlDbType.Text).Value = ghichu;
                cmd.Parameters.Add("id", NpgsqlDbType.Numeric).Value = id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".ct_muc (id,iddoan,stt,phai,tt,namsinh,ghichu) values (:id,:iddoan,:stt,:phai,:tt,:namsinh,:ghichu)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("id", NpgsqlDbType.Numeric).Value = id;
                    cmd.Parameters.Add("iddoan", NpgsqlDbType.Numeric).Value = iddoan;
                    cmd.Parameters.Add("stt", NpgsqlDbType.Numeric).Value = stt;
                    cmd.Parameters.Add("phai", NpgsqlDbType.Numeric).Value = phai;
                    cmd.Parameters.Add("tt", NpgsqlDbType.Varchar, 2).Value = tt;
                    cmd.Parameters.Add("namsinh", NpgsqlDbType.Varchar, 4).Value = namsinh;
                    cmd.Parameters.Add("ghichu", NpgsqlDbType.Text).Value = ghichu;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ct_muc");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_ct_mucct(decimal id, decimal mavp, decimal stt, decimal gia_nv, decimal gia_ngv, string ghichu)
        {
            sql = "update " + user + ".ct_mucct set stt=:stt,gia_nv=:gia_nv,gia_ngv=:gia_ngv,ghichu=:ghichu where id=:id and mavp=:mavp";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("stt", NpgsqlDbType.Numeric).Value = stt;
                cmd.Parameters.Add("gia_nv", NpgsqlDbType.Numeric).Value = gia_nv;
                cmd.Parameters.Add("gia_ngv", NpgsqlDbType.Numeric).Value = gia_ngv;
                cmd.Parameters.Add("ghichu", NpgsqlDbType.Text).Value = ghichu;
                cmd.Parameters.Add("id", NpgsqlDbType.Numeric).Value = id;
                cmd.Parameters.Add("mavp", NpgsqlDbType.Numeric).Value = mavp;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".ct_mucct (id,stt,mavp,gia_nv,gia_ngv,ghichu) values (:id,:stt,:mavp,:gia_nv,:gia_ngv,:ghichu)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("id", NpgsqlDbType.Numeric).Value = id;
                    cmd.Parameters.Add("stt", NpgsqlDbType.Numeric).Value = stt;
                    cmd.Parameters.Add("mavp", NpgsqlDbType.Numeric).Value = mavp;
                    cmd.Parameters.Add("gia_nv", NpgsqlDbType.Numeric).Value = gia_nv;
                    cmd.Parameters.Add("gia_ngv", NpgsqlDbType.Numeric).Value = gia_ngv;
                    cmd.Parameters.Add("ghichu", NpgsqlDbType.Text).Value = ghichu;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ct_mucct");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        private decimal get_ct_capid(int m_ma)
        {
            sql = "update " + user + ".ct_capid set id=id+1 where ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            con.Open();
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;
            cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
            int irec = cmd.ExecuteNonQuery();
            cmd.Dispose();
            if (irec == 0)
            {
                sql = "insert into " + user + ".ct_capid(ma,ten,id) values (:m_ma,:m_ten,1)";
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Varchar, 20).Value = sComputer;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            sql = "select id from " + user + ".ct_capid where ma=" + m_ma;
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;
            dest = new NpgsqlDataAdapter(cmd);
            ds = new DataSet();
            dest.Fill(ds);
            cmd.Dispose();
            con.Close(); con.Dispose();
            return decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
        }

        public decimal get_id_ct_doan { get { return get_ct_capid(1); } }
        public decimal get_id_ct_donvi { get { return get_ct_capid(2); } }
        public decimal get_id_ct_muc { get { return get_ct_capid(3); } }
        public decimal get_id_ct_mucct { get { return get_ct_capid(4); } }
        public decimal get_id_ct_ketqua { get { return get_ct_capid(5); } }

        public string get_ma_ctdoan(string ngay)
        {
            int ma = 1;
            sql = "select max(ma) as ma from " + user + ".ct_doan where to_char(ngay,'yyyy')='" + ngay.Substring(6, 4) + "'";
            ds = get_data(sql);
            if (ds.Tables[0].Rows[0]["ma"].ToString() != "")
            {
                ma = int.Parse(ds.Tables[0].Rows[0]["ma"].ToString()) + 1;
            }
            return ma.ToString().PadLeft(3, '0');
        }

        public string get_ma_ctdonvi(decimal iddoan)
        {
            int ma = 1;
            sql = "select max(ma) as ma from " + user + ".ct_donvi where iddoan=" + iddoan;
            ds = get_data(sql);
            if (ds.Tables[0].Rows[0]["ma"].ToString() != "")
            {
                ma = int.Parse(ds.Tables[0].Rows[0]["ma"].ToString()) + 1;
            }
            return ma.ToString().PadLeft(2, '0');
        }

        public bool upd_ct_btdbn(string mmyy, decimal iddonvi, decimal stt, string mabn, string hoten, string namsinh, int phai, int userid)
        {
            string xxx = user + mmyy, hotenkdau = Hoten_khongdau(hoten);
            sql = "update " + xxx + ".ct_btdbn set iddonvi=:iddonvi,stt=:stt,hoten=:hoten,namsinh=:namsinh,phai=:phai,hotenkdau=:hotenkdau,userid=:userid where mabn=:mabn";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("iddonvi", NpgsqlDbType.Numeric).Value = iddonvi;
                cmd.Parameters.Add("stt", NpgsqlDbType.Numeric).Value = stt;
                cmd.Parameters.Add("hoten", NpgsqlDbType.Text).Value = hoten;
                cmd.Parameters.Add("namsinh", NpgsqlDbType.Varchar, 4).Value = namsinh;
                cmd.Parameters.Add("phai", NpgsqlDbType.Numeric).Value = phai;
                cmd.Parameters.Add("hotenkdau", NpgsqlDbType.Text).Value = hotenkdau;
                cmd.Parameters.Add("userid", NpgsqlDbType.Numeric).Value = userid;
                cmd.Parameters.Add("mabn", NpgsqlDbType.Varchar).Value = mabn;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ct_btdbn (iddonvi,stt,mabn,hoten,namsinh,phai,hotenkdau,userid) values (:iddonvi,:stt,:mabn,:hoten,:namsinh,:phai,:hotenkdau,:userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("iddonvi", NpgsqlDbType.Numeric).Value = iddonvi;
                    cmd.Parameters.Add("stt", NpgsqlDbType.Numeric).Value = stt;
                    cmd.Parameters.Add("mabn", NpgsqlDbType.Varchar).Value = mabn;
                    cmd.Parameters.Add("hoten", NpgsqlDbType.Text).Value = hoten;
                    cmd.Parameters.Add("namsinh", NpgsqlDbType.Varchar, 4).Value = namsinh;
                    cmd.Parameters.Add("phai", NpgsqlDbType.Numeric).Value = phai;
                    cmd.Parameters.Add("hotenkdau", NpgsqlDbType.Text).Value = hotenkdau;
                    cmd.Parameters.Add("userid", NpgsqlDbType.Numeric).Value = userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error("01/" + mmyy.Substring(0, 2) + "/20" + mmyy.Substring(2, 2), ex.Message, sComputer, "ct_btdbn");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public string get_ma_btdbn(string mmyy, decimal iddonvi)
        {
            string xxx = user + mmyy;
            int ma = 1;
            sql = "select max(substr(mabn,6,3)) as ma from " + xxx + ".ct_btdbn where iddonvi=" + iddonvi;
            ds = get_data(sql);
            if (ds.Tables[0].Rows[0]["ma"].ToString() != "")
            {
                ma = int.Parse(ds.Tables[0].Rows[0]["ma"].ToString()) + 1;
            }
            return ma.ToString().PadLeft(3, '0');
        }

        public bool upd_ct_ketqua(string mmyy, decimal id, decimal iddonvi, string mabn, string ngay, string mabs, int loai, string ketluan, int userid)
        {
            string xxx = user + mmyy;
            sql = "update " + xxx + ".ct_ketqua set iddonvi=:iddonvi,mabn=:mabn,ngay=to_timestamp(:ngay,'dd/mm/yyyy hh24:mi'),mabs=:mabs,loai=:loai,ketluan=:ketluan,userid=:userid where id=:id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("iddonvi", NpgsqlDbType.Numeric).Value = iddonvi;
                cmd.Parameters.Add("mabn", NpgsqlDbType.Varchar).Value = mabn;
                cmd.Parameters.Add("ngay", NpgsqlDbType.Varchar).Value = ngay;
                cmd.Parameters.Add("mabs", NpgsqlDbType.Text).Value = mabs;
                cmd.Parameters.Add("loai", NpgsqlDbType.Numeric).Value = loai;
                cmd.Parameters.Add("ketluan", NpgsqlDbType.Text).Value = ketluan;
                cmd.Parameters.Add("userid", NpgsqlDbType.Numeric).Value = userid;
                cmd.Parameters.Add("id", NpgsqlDbType.Numeric).Value = id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ct_ketqua (id,iddonvi,mabn,ngay,mabs,loai,ketluan,userid) values (:id,:iddonvi,:mabn,to_timestamp(:ngay,'dd/mm/yyyy hh24:mi'),:mabs,:loai,:ketluan,:userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("id", NpgsqlDbType.Numeric).Value = id;
                    cmd.Parameters.Add("iddonvi", NpgsqlDbType.Numeric).Value = iddonvi;
                    cmd.Parameters.Add("mabn", NpgsqlDbType.Varchar).Value = mabn;
                    cmd.Parameters.Add("ngay", NpgsqlDbType.Varchar).Value = ngay;
                    cmd.Parameters.Add("mabs", NpgsqlDbType.Text).Value = mabs;
                    cmd.Parameters.Add("loai", NpgsqlDbType.Numeric).Value = loai;
                    cmd.Parameters.Add("ketluan", NpgsqlDbType.Text).Value = ketluan;
                    cmd.Parameters.Add("userid", NpgsqlDbType.Numeric).Value = userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error("01/" + mmyy.Substring(0, 2) + "/20" + mmyy.Substring(2, 2), ex.Message, sComputer, "ct_ketqua");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_ct_chitiet(string mmyy, decimal id, int stt, decimal mavp, string ten, decimal dongia, int ngoaihd, string lamthem, string ketqua, string ghichu)
        {
            string xxx = user + mmyy;
            sql = "update " + xxx + ".ct_chitiet set mavp=:mavp,ten=:ten,dongia=:dongia,ngoaihd=:ngoaihd,lamthem=:lamthem,ketqua=:ketqua,ghichu=:ghichu where id=:id and stt=:stt";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("mavp", NpgsqlDbType.Numeric).Value = mavp;
                cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                cmd.Parameters.Add("dongia", NpgsqlDbType.Numeric).Value = dongia;
                cmd.Parameters.Add("ngoaihd", NpgsqlDbType.Numeric).Value = ngoaihd;
                cmd.Parameters.Add("lamthem", NpgsqlDbType.Text).Value = lamthem;
                cmd.Parameters.Add("ketqua", NpgsqlDbType.Text).Value = ketqua;
                cmd.Parameters.Add("ghichu", NpgsqlDbType.Text).Value = ghichu;
                cmd.Parameters.Add("id", NpgsqlDbType.Numeric).Value = id;
                cmd.Parameters.Add("stt", NpgsqlDbType.Numeric).Value = stt;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ct_chitiet (id,stt,mavp,ten,dongia,ngoaihd,lamthem,ketqua,ghichu) values (:id,:stt,:mavp,:ten,:dongia,:ngoaihd,:lamthem,:ketqua,:ghichu)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("id", NpgsqlDbType.Numeric).Value = id;
                    cmd.Parameters.Add("stt", NpgsqlDbType.Numeric).Value = stt;
                    cmd.Parameters.Add("mavp", NpgsqlDbType.Numeric).Value = mavp;
                    cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                    cmd.Parameters.Add("dongia", NpgsqlDbType.Numeric).Value = dongia;
                    cmd.Parameters.Add("ngoaihd", NpgsqlDbType.Numeric).Value = ngoaihd;
                    cmd.Parameters.Add("lamthem", NpgsqlDbType.Text).Value = lamthem;
                    cmd.Parameters.Add("ketqua", NpgsqlDbType.Text).Value = ketqua;
                    cmd.Parameters.Add("ghichu", NpgsqlDbType.Text).Value = ghichu;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error("01/" + mmyy.Substring(0, 2) + "/20" + mmyy.Substring(2, 2), ex.Message, sComputer, "ct_chitiet");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public string Kiemtra_idcls(string ngay, int loai, string mabn, string idcls)
        {
            string _mmyy = mmyy(ngay);
            if (!bMmyy(_mmyy)) return "";
            ds = get_data("select a.mabn||' '||b.hoten as hoten from " + user + _mmyy + ".cls_ketqua a," + user + ".btdbn b where a.mabn=b.mabn and a.loai=" + loai + " and a.mabn<>'" + mabn + "' and a.idcls='" + idcls + "'");
            if (ds.Tables[0].Rows.Count > 0) return ds.Tables[0].Rows[0]["hoten"].ToString();
            else return "";
        }

        public decimal get_id_cls_mau(int m_loai, string m_mabs, decimal m_vung, string m_chandoan)
        {
            ds = get_data("select id from " + user + ".cls_mau where mabs='" + m_mabs + "' and chandoan='" + m_chandoan + "' and loai=" + m_loai + " and vung=" + m_vung);
            decimal l_id = (ds.Tables[0].Rows.Count == 0) ? 0 : decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            if (l_id == 0) l_id = getidyymmddhhmiss_stt_computer;// get_capid(-100);
            return l_id;
        }

        public bool upd_cls_mau(decimal m_id, int m_loai, string m_mabs, decimal m_vung, string m_chandoan, string m_ten)
        {
            sql = "update " + user + ".cls_mau set ten=:m_ten where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".cls_mau (id,loai,mabs,vung,chandoan,ten) values (:m_id,:m_loai,:m_mabs,:m_vung,:m_chandoan,:m_ten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    cmd.Parameters.Add("m_vung", NpgsqlDbType.Numeric).Value = m_vung;
                    cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message.ToString().Trim(), sComputer, "cls_mau");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public DataSet get_data_postgresql(string sql, string Connectstring)
        {
            try
            {
                if (ds != null)
                {
                    ds.Dispose();
                    ds = null;
                }
                ds = new DataSet();
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(Connectstring);
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                dest = new NpgsqlDataAdapter(cmd);
                dest.Fill(ds);
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message.ToString().Trim() + "-SQL: " + sql, sComputer, "?");
            }
            return ds;
        }

        public bool ma_phongmo(string makp)
        {
            if (!bPttt_Konhapkhoa) return false;
            else return get_data("select * from " + user + ".btdkp_bv where makp='" + makp + "' and makpbo='19'").Tables[0].Rows.Count > 0;
        }

        public bool bTuvong(string mabn)
        {
            return get_data("select a.mabn from " + user + ".xuatvien a," + user + ".benhandt b where a.maql=b.maql and a.ttlucrv=7 and b.loaiba in (1,2) and a.mabn='" + mabn + "'").Tables[0].Rows.Count > 0;
        }

        public string get_soluutru(decimal maql, string maicd, string ngay)
        {
            sql = "select max(substr(soluutru,4,4)) as so from " + user + ".xuatvien where substr(soluutru,1,3)='" + maicd.Substring(0, 3) + "' and to_char(ngay,'yy')='" + ngay.Substring(8, 2) + "' and maql<>" + maql + " and length(trim(soluutru))=10";
            ds = get_data(sql);
            if (ds.Tables[0].Rows[0]["so"].ToString() == "") return maicd.Substring(0, 3) + "0001/" + ngay.Substring(8, 2);
            else
            {
                int stt = int.Parse(ds.Tables[0].Rows[0]["so"].ToString()) + 1;
                return maicd.Substring(0, 3) + stt.ToString().PadLeft(4, '0') + "/" + ngay.Substring(8, 2);
            }
        }

        public bool upd_tuchoi(string m_mabn, decimal m_maql, string m_makp, string m_ngay,
            int m_dentu, int m_nhantu, int m_lanthu, int m_madoituong, string m_chandoan,
            string m_maicd, string m_mabs, string m_sovaovien, int m_loaiba, int m_lydo, int m_userid)
        {
            sql = "update " + user + ".tuchoi set ";
            sql += "makp=:m_makp,";
            sql += "ngay=to_timestamp(:m_ngay,'dd/mm/yyyy hh24:mi'),dentu=:m_dentu,nhantu=:m_nhantu,";
            sql += "lanthu=:m_lanthu,madoituong=:m_madoituong,chandoan=:m_chandoan,maicd=:m_maicd,mabs=:m_mabs,";
            sql += "sovaovien=:m_sovaovien,";
            sql += "loaiba=:m_loaiba,lydo=:m_lydo,userid=:m_userid where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar).Value = m_ngay;
                cmd.Parameters.Add("m_dentu", NpgsqlDbType.Numeric).Value = m_dentu;
                cmd.Parameters.Add("m_nhantu", NpgsqlDbType.Numeric).Value = m_nhantu;
                cmd.Parameters.Add("m_lanthu", NpgsqlDbType.Numeric).Value = m_lanthu;
                cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_sovaovien", NpgsqlDbType.Varchar, 10).Value = m_sovaovien;
                cmd.Parameters.Add("m_loaiba", NpgsqlDbType.Numeric).Value = m_loaiba;
                cmd.Parameters.Add("m_lydo", NpgsqlDbType.Numeric).Value = m_lydo;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".tuchoi(mabn,maql,makp,ngay,dentu,nhantu,lanthu,madoituong,chandoan,maicd,mabs,sovaovien,loaiba,lydo,userid,ngayud)";
                    sql += " values (:m_mabn,:m_maql,:m_makp,to_timestamp(:m_ngay,'dd/mm/yyyy hh24:mi'),:m_dentu,:m_nhantu,:m_lanthu,:m_madoituong,:m_chandoan,:m_maicd,:m_mabs,:m_sovaovien,:m_loaiba,:m_lydo,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar).Value = m_ngay;
                    cmd.Parameters.Add("m_dentu", NpgsqlDbType.Numeric).Value = m_dentu;
                    cmd.Parameters.Add("m_nhantu", NpgsqlDbType.Numeric).Value = m_nhantu;
                    cmd.Parameters.Add("m_lanthu", NpgsqlDbType.Numeric).Value = m_lanthu;
                    cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                    cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                    cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    cmd.Parameters.Add("m_sovaovien", NpgsqlDbType.Varchar, 10).Value = m_sovaovien;
                    cmd.Parameters.Add("m_loaiba", NpgsqlDbType.Numeric).Value = m_loaiba;
                    cmd.Parameters.Add("m_lydo", NpgsqlDbType.Numeric).Value = m_lydo;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "tuchoi");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public string mabn_bhyt(string mabn, string sothe)
        {
            sql = "select mabn from " + user + ".bhyt where sothe='" + sothe + "' and mabn<>'" + mabn + "'";
            ds = get_data(sql);
            if (ds.Tables[0].Rows.Count > 0) return ds.Tables[0].Rows[0]["mabn"].ToString();
            else return "";
        }
        public string mabn_bhyt_ngayhethan(string mabn, string sothe,string ngayhethan)
        {
            sql = "select mabn from " + user + ".bhyt where sothe='" + sothe + "' and mabn<>'" + mabn + "' and to_char(denngay,'dd/mm/yyyy')= '" + ngayhethan + "'";
            ds = get_data(sql);
            if (ds.Tables[0].Rows.Count > 0) return ds.Tables[0].Rows[0]["mabn"].ToString();
            else return "";
        }

        public string mabn_bhyt(string nam, string mabn, string sothe)
        {
            //nam = "";
            //foreach (DataRow r in get_data("select mmyy from " + user + ".table order by substr(mmyy,3,2) desc,substr(mmyy,1,2) desc ").Tables[0].Rows) nam += r["mmyy"].ToString() + "+";
            //sql = "select * from xxx.bhyt where sothe='" + sothe + "' and mabn<>'" + mabn + "'";
            //ds = get_data_nam_dec(nam, sql);
            //if (ds.Tables[0].Rows.Count > 0) return ds.Tables[0].Rows[0]["mabn"].ToString();
            //else return "";
            nam = "";
            sql = "select distinct mabn from medibv.bhyt where sothe='" + sothe + "' and mabn<>'" + mabn + "'";
            ds = get_data(sql);
            if (ds == null || ds.Tables.Count <= 0 || ds.Tables[0].Rows.Count <= 0)
            {
                foreach (DataRow r in get_data("select mmyy from " + user + ".table order by substr(mmyy,3,2) desc,substr(mmyy,1,2) desc ").Tables[0].Rows) nam += r["mmyy"].ToString() + "+";
                sql = "select distinct mabn from xxx.bhyt where sothe='" + sothe + "' and mabn<>'" + mabn + "'";
                ds = get_data_nam_dec(nam, sql);
            }
            if (ds.Tables[0].Rows.Count > 0) return ds.Tables[0].Rows[0]["mabn"].ToString();
            else return "";
        }

          public string mabn_bhyt_ngayhethan(string nam, string mabn, string sothe,string ngayhethan)
        {
            //nam = "";
            //foreach (DataRow r in get_data("select mmyy from " + user + ".table order by substr(mmyy,3,2) desc,substr(mmyy,1,2) desc ").Tables[0].Rows) nam += r["mmyy"].ToString() + "+";
            //sql = "select * from xxx.bhyt where sothe='" + sothe + "' and mabn<>'" + mabn + "'";
            //ds = get_data_nam_dec(nam, sql);
            //if (ds.Tables[0].Rows.Count > 0) return ds.Tables[0].Rows[0]["mabn"].ToString();
            //else return "";
            nam = "";
            sql = "select distinct mabn from medibv.bhyt where sothe='" + sothe + "' and mabn<>'" + mabn + "' and to_char(denngay,'dd/mm/yyyy')= '"+ngayhethan+"'";
            ds = get_data(sql);
            if (ds == null || ds.Tables.Count <= 0 || ds.Tables[0].Rows.Count <= 0)
            {
                foreach (DataRow r in get_data("select mmyy from " + user + ".table order by substr(mmyy,3,2) desc,substr(mmyy,1,2) desc ").Tables[0].Rows) nam += r["mmyy"].ToString() + "+";
                sql = "select distinct mabn from xxx.bhyt where sothe='" + sothe + "' and mabn<>'" + mabn + "' and to_char(denngay,'dd/mm/yyyy')= '"+ngayhethan+"'";
                ds = get_data_nam_dec(nam, sql);
            }
            if (ds.Tables[0].Rows.Count > 0) return ds.Tables[0].Rows[0]["mabn"].ToString();
            else return "";
        }
        public string mabn_bhyt(string nam, string mabn, string sothe, string ngayvao)
        {
            nam = "";
            foreach (DataRow r in get_data("select mmyy from " + user + ".table order by substr(mmyy,3,2) desc,substr(mmyy,1,2) desc ").Tables[0].Rows) nam += r["mmyy"].ToString() + "+";
            sql = "select * from xxx.bhyt where sothe='" + sothe + "' and mabn<>'" + mabn + "' and to_date(to_char(denngay,'dd/mm/yyyy'),'dd/mm/yyyy')>to_date('" + ngayvao.Substring(0, 10) + "','dd/mm/yyyy')";
            ds = get_data_nam_dec(nam, sql);
            if (ds.Tables[0].Rows.Count > 0) return ds.Tables[0].Rows[0]["mabn"].ToString();
            else return "";
        }

        public bool upd_ttxk(int m_ma, string m_ten, int m_rakhoa)
        {
            sql = "update " + user + ".ttxk set ten=:m_ten,rakhoa=:m_rakhoa where ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_rakhoa", NpgsqlDbType.Numeric).Value = m_rakhoa;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".ttxk (ma,ten,rakhoa) values (:m_ma,:m_ten,:m_rakhoa)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    cmd.Parameters.Add("m_rakhoa", NpgsqlDbType.Numeric).Value = m_rakhoa;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ttxk");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool get_thvpll(string ngay, decimal maql, string ngayvao)
        {
            d = new LibDuoc.AccessData();
            DateTime dt1 = StringToDate(ngay).AddDays(-d.iNgaykiemke);
            DateTime dt2 = StringToDate(ngay).AddDays(d.iNgaykiemke);
            int y1 = dt1.Year, m1 = dt1.Month;
            int y2 = dt2.Year, m2 = dt2.Month;
            int itu, iden;
            string mmyy = "";
            bool bFound = false;
            for (int i = y1; i <= y2; i++)
            {
                itu = (i == y1) ? m1 : 1;
                iden = (i == y2) ? m2 : 12;
                for (int j = itu; j <= iden; j++)
                {
                    mmyy = j.ToString().PadLeft(2, '0') + i.ToString().Substring(2, 2);
                    if (bMmyy(mmyy))
                    {
                        sql = "select mabn from " + user + mmyy + ".v_thvpll where maql=" + maql;
                        if (ngayvao != "") sql += " and to_char(ngayvao,'dd/mm/yyyy hh24:mi')='" + ngayvao + "'";
                        bFound = get_data(sql).Tables[0].Rows.Count > 0;
                        if (bFound) break;
                    }
                }
            }
            return bFound;
        }

        public bool bKetqua_cls(string ngay, decimal id)
        {
            sql = "select * from " + user + mmyy(ngay) + ".cls_ketqua where id=" + id + " and ketqua is not null";
            return get_data(sql).Tables[0].Rows.Count > 0;
        }

        public string get_soluutru_nam(string m_ngay)
        {
            return get_capid(-50, m_ngay.Substring(8, 2)).ToString().PadLeft(7, '0') + "/" + m_ngay.Substring(8, 2);
        }
        //Thuy 04.01.2012
        public string get_soluutru_khoa(string m_ngay, string m_makp)
        {
            string kp_viettat = get_data("select viettat from medibv.btdkp_bv where makp = '" + m_makp + "'").Tables[0].Rows[0][0].ToString();
            if (kp_viettat.Trim() == "")
                kp_viettat = m_makp;
            string s = get_capid_theokhoa(-50, m_makp, m_ngay.Substring(8, 2)).ToString() + "/" + m_ngay.Substring(8, 2) + "/" + kp_viettat;
            return s;
        }
        //end 04.01.2012
        public string file_modify(string tenfile)
        {
            string ret = "";
            ret = System.IO.File.GetLastWriteTime(tenfile).ToString("dd/MM/yyyy HH:mm");
            System.IO.FileInfo fi = new System.IO.FileInfo(tenfile);
            ret += " " + (fi.Length / 1024).ToString();
            return ret;
        }

        public string f_modify(string tenfile)
        {
            return System.IO.File.GetLastWriteTime(tenfile).ToString("dd/MM/yyyy HH:mm");
        }

        public string f_size(string tenfile)
        {
            System.IO.FileInfo fi = new System.IO.FileInfo(tenfile);
            return (fi.Length / 1024).ToString();
        }

        public string tenfile_goc(string tenfile)
        {
            if (tenfile.Substring(0, 1) == "//")
            {
                string s = tenfile.Substring(tenfile.LastIndexOf("//") + 1);
                return s.Substring(0, s.IndexOf(".")).ToLower();
            }
            else
            {
                try
                {
                    System.Reflection.Assembly asm = null;
                    asm = System.Reflection.Assembly.LoadFrom(tenfile);
                    return asm.GetName().Name.ToString().ToLower();
                }
                catch { return ""; }
            }
        }

        public bool bUpdate(string p_localhost, string p_server, string file)
        {
            bool modify = f_modify(file_exe(p_localhost, file)) == f_modify(file_exe_update(p_server, file));
            bool size = f_size(file_exe(p_localhost, file)) == f_size(file_exe_update(p_server, file));
            return modify && size;
        }

        public string tenfile(string tenfile)
        {
            string s = tenfile.Substring(tenfile.LastIndexOf("//") + 1);
            return s.Substring(0, s.LastIndexOf(".")).ToLower();
        }

        public string file_exe_update(string path, string tenfilegoc)
        {
            string ret = "";
            string[] files = System.IO.Directory.GetFiles(path);
            for (int i = 0; i < files.GetLength(0); i++)
            {
                if (files[i].ToString().ToUpper().IndexOf(".EXE") != -1
                    && tenfile(files[i].ToString()) == tenfilegoc.ToLower())
                {
                    ret = files[i].ToString();
                    break;
                }
            }
            return ret;
        }

        public string path_medisofthis()
        {
            string path = System.IO.Directory.GetCurrentDirectory();
            string p_localhost = "";
            int j = 0, i = path.Length;
            for (; i > 0; i--)
            {
                if (path.Substring(i - 1, 1) == "//") j++;
                if (j == 3) break;
            }
            p_localhost = path.Substring(0, i - 1);
            return p_localhost;
        }

        public void xcopy(string source, string dist)
        {
            string filerun = @path_medisofthis() + "//version//bin//debug//xcopy.exe";
            string arg = source + " " + dist + " /yes";
            run f = new run(filerun, arg, true);
            f.Launch();
        }

        public string file_exe(string path, string tenfilegoc)
        {
            string ret = System.IO.Directory.GetCurrentDirectory() + "//medisoft.exe";
            string[] files = System.IO.Directory.GetFiles(path);
            for (int i = 0; i < files.GetLength(0); i++)
            {
                if (files[i].ToString().ToUpper().IndexOf(".EXE") != -1 && tenfile_goc(files[i].ToString()) == tenfilegoc.ToLower())
                {
                    ret = files[i].ToString();
                    break;
                }
            }
            return ret;
        }

        public string file_exe(string tenfilegoc)
        {
            string ret = "";
            string[] files = System.IO.Directory.GetFiles(System.IO.Directory.GetCurrentDirectory());
            for (int i = 0; i < files.GetLength(0); i++)
            {
                if (files[i].ToString().ToUpper().IndexOf(".EXE") != -1 && tenfile_goc(files[i].ToString()) == tenfilegoc.ToLower())
                {
                    ret = files[i].ToString();
                    break;
                }
            }
            return ret;
        }

        public string file_exe_goc
        {
            get
            {
                string ret = "";
                string[] files = System.IO.Directory.GetFiles(System.IO.Directory.GetCurrentDirectory());
                for (int i = 0; i < files.GetLength(0); i++)
                {
                    if (files[i].ToString().ToUpper().IndexOf(".EXE") != -1)
                    {
                        ret = tenfile_goc(files[i].ToString());
                        break;
                    }
                }
                return ret;
            }
        }
        #region LICENSE
        private LinksLicense.LibLicense m_license = new LinksLicense.LibLicense();
        public bool upd_md_license(string v_computer_key, string v_license_key)
        {
            if (v_computer_key == "" || v_license_key == "") return false;
            sql = "update " + user + ".license set license_key=:v_license_key,computer='" + sComputer + "' where computer_key=:v_computer_key";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_computer_key", NpgsqlDbType.Text).Value = v_computer_key;
            cmd.Parameters.Add("v_license_key", NpgsqlDbType.Text).Value = v_license_key;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".license(computer_key,license_key,computer) values(:v_computer_key,:v_license_key,'" + sComputer + "')";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_computer_key", NpgsqlDbType.Text).Value = v_computer_key;
                    cmd.Parameters.Add("v_license_key", NpgsqlDbType.Text).Value = v_license_key;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_error(ex.Message, sComputer, "m_license");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool is_licensed
        {
            get
            {
                bool ar = false;
                try
                {
                    ar = f_get_md_license(m_license.f_generate_computer_key(), m_license.f_generate_license_key()).Tables[0].Rows.Count > 0;
                }
                catch
                {
                    ar = false;
                }
                return ar;
            }
        }
        public DataSet f_get_md_license(string v_computer_key, string v_license_key)
        {
            DataSet ads = null;
            try
            {
                string asql = "", aexp = "";
                asql = "select * from " + user + ".license";

                if (v_computer_key != "")
                {
                    if (aexp.Length > 0)
                    {
                        aexp += " and";
                    }
                    aexp += " computer_key=:v_computer_key";
                }
                if (v_license_key != "")
                {
                    if (aexp.Length > 0)
                    {
                        aexp += " and";
                    }
                    aexp += " license_key=:v_license_key";
                }

                if (aexp.Length > 0)
                {
                    asql += " where" + aexp;
                }
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }

                con = new NpgsqlConnection(sConn);
                con.Open();
                cmd = new NpgsqlCommand(asql, con);
                cmd.CommandType = CommandType.Text;

                if (v_computer_key != "")
                {
                    cmd.Parameters.Add("v_computer_key", NpgsqlDbType.Text).Value = v_computer_key;
                }

                if (v_license_key != "")
                {
                    cmd.Parameters.Add("v_license_key", NpgsqlDbType.Text).Value = v_license_key;
                }

                dest = new NpgsqlDataAdapter(cmd);
                ads = new DataSet();
                dest.Fill(ads);
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
            catch (NpgsqlException ex)
            {
                f_create_md_license();
                upd_error(ex.Message.ToString().Trim(), sComputer, "license");
            }
            return ads;
        }
        public void f_set_licensed(string v_password_)
        {
            try
            {
                if (v_password_ == m_license.f_generate_password_key())
                {
                    string acomputer_key = "", alicence_key = "";
                    acomputer_key = m_license.f_generate_computer_key();
                    alicence_key = m_license.f_generate_license_key();
                    if (acomputer_key != "" && alicence_key != "")
                    {
                        upd_md_license(acomputer_key, alicence_key);
                    }
                }
            }
            catch
            {
            }
        }
        public string s_computer_key
        {
            get
            {
                return m_license.f_generate_computer_key();
            }
        }
        public void f_create_md_license()
        {
            try
            {
                int n = get_data("select * from license where 1=-1").Tables[0].Rows.Count;
            }
            catch
            {
                sql = "CREATE TABLE medibv.license(computer_key text, license_key text,computer text,ngayud timestamp default now(),CONSTRAINT pk_license PRIMARY KEY (computer_key) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;";
                execute_data(sql);
            }
        }
        #endregion

        public bool upd_inchiphipk(string m_mabn, decimal m_mavaovien, string m_ngay, string m_makp)
        {
            schema = user + mmyy(m_ngay) + ".upd_inchiphipk";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(schema, con);
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                cmd.ExecuteNonQuery();
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message, sComputer, "inchiphipk");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
            return true;
        }

        public string inchiphipk(string m_ngay, decimal m_mavaovien)
        {
            if (!bMmyy(mmyy(m_ngay))) return "";
            else
            {
                sql = "select b.tenkp from " + user + mmyy(m_ngay) + ".inchiphipk a," + user + ".btdkp_bv b ";
                sql += " where a.makp=b.makp and a.mavaovien=" + m_mavaovien;
                if (bTaikham_chiphi_inrieng) sql += " and to_char(ngay,'dd/mm/yyyy')='" + m_ngay.Substring(0, 10) + "'";
                DataTable tmp = get_data(sql).Tables[0];
                if (tmp.Rows.Count > 0) return tmp.Rows[0]["tenkp"].ToString().Trim();
                else return "";
            }
        }
        public bool bMau38pk_dain(string m_ngay, decimal m_mavaovien)
        {

            sql = "select mavaovien from xxx.bhytkb a ";
            sql += " where a.mavaovien=" + m_mavaovien;
            //if (bTaikham_chiphi_inrieng) sql += " and to_char(ngay,'dd/mm/yyyy')='" + m_ngay.Substring(0, 10) + "'";
            DataSet tmp = get_data_mmyy(sql, m_ngay, m_ngay, true);
            if (tmp != null && tmp.Tables.Count > 0 && tmp.Tables[0].Rows.Count > 0) return tmp.Tables[0].Rows.Count > 0;
            else return false;
        }

        public bool upd_dmloaiphong(decimal m_id, decimal m_stt, string m_ma, string m_ten, int m_userid)
        {
            sql = "update " + user + ".dmloaiphong set stt=:m_stt,ma=:m_ma,ten=:m_ten,userid=:m_userid where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 10).Value = m_ma;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dmloaiphong (id,stt,ma,ten,userid) values (:m_id,:m_stt,:m_ma,:m_ten,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 10).Value = m_ma;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dmloaiphong");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_dmphong(string m_makp, decimal m_id, decimal m_stt, string m_ma, string m_ten, int m_loai, int m_loaivp, int m_userid)
        {
            sql = "update " + user + ".dmphong set makp=:m_makp,stt=:m_stt,ma=:m_ma,ten=:m_ten,loai=:m_loai,loaivp=:m_loaivp,userid=:m_userid where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 10).Value = m_ma;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                cmd.Parameters.Add("m_loaivp", NpgsqlDbType.Numeric).Value = m_loaivp;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dmphong (makp,id,stt,ma,ten,loai,loaivp,userid) values (:m_makp,:m_id,:m_stt,:m_ma,:m_ten,:m_loai,:m_loaivp,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 10).Value = m_ma;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                    cmd.Parameters.Add("m_loaivp", NpgsqlDbType.Numeric).Value = m_loaivp;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dmphong");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_dmgiuong(decimal m_idphong, decimal m_id, decimal m_stt, string m_ma, string m_ten, decimal m_bhyt, decimal m_gia_th, decimal m_gia_bh, decimal m_gia_cs, decimal m_gia_dv, decimal m_gia_nn, int m_userid)
        {
            sql = "update " + user + ".dmgiuong set idphong=:m_idphong,stt=:m_stt,ma=:m_ma,ten=:m_ten,bhyt=:m_bhyt,gia_th=:m_gia_th,gia_bh=:m_gia_bh,gia_cs=:m_gia_cs,gia_dv=:m_gia_dv,gia_nn=:m_gia_nn,userid=:m_userid where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_idphong", NpgsqlDbType.Numeric).Value = m_idphong;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 10).Value = m_ma;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_bhyt", NpgsqlDbType.Numeric).Value = m_bhyt;
                cmd.Parameters.Add("m_gia_th", NpgsqlDbType.Numeric).Value = m_gia_th;
                cmd.Parameters.Add("m_gia_bh", NpgsqlDbType.Numeric).Value = m_gia_bh;
                cmd.Parameters.Add("m_gia_cs", NpgsqlDbType.Numeric).Value = m_gia_cs;
                cmd.Parameters.Add("m_gia_dv", NpgsqlDbType.Numeric).Value = m_gia_dv;
                cmd.Parameters.Add("m_gia_nn", NpgsqlDbType.Numeric).Value = m_gia_nn;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dmgiuong (idphong,id,stt,ma,ten,bhyt,gia_th,gia_bh,gia_cs,gia_dv,gia_nn,userid) values (:m_idphong,:m_id,:m_stt,:m_ma,:m_ten,:m_bhyt,:m_gia_th,:m_gia_bh,:m_gia_cs,:m_gia_dv,:m_gia_nn,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_idphong", NpgsqlDbType.Numeric).Value = m_idphong;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 10).Value = m_ma;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    cmd.Parameters.Add("m_bhyt", NpgsqlDbType.Numeric).Value = m_bhyt;
                    cmd.Parameters.Add("m_gia_th", NpgsqlDbType.Numeric).Value = m_gia_th;
                    cmd.Parameters.Add("m_gia_bh", NpgsqlDbType.Numeric).Value = m_gia_bh;
                    cmd.Parameters.Add("m_gia_cs", NpgsqlDbType.Numeric).Value = m_gia_cs;
                    cmd.Parameters.Add("m_gia_dv", NpgsqlDbType.Numeric).Value = m_gia_dv;
                    cmd.Parameters.Add("m_gia_nn", NpgsqlDbType.Numeric).Value = m_gia_nn;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dmgiuong");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_theodoigiuong(decimal m_id, string m_makp, string m_mabn, decimal m_mavaovien, decimal m_maql, decimal m_idkhoa, int m_madoituong, int m_idgiuong, string m_tu, decimal m_dongia, int m_userid)
        {
            sql = "update " + user + ".theodoigiuong set makp=:m_makp,mabn=:m_mabn,mavaovien=:m_mavaovien,maql=:m_maql,idkhoa=:m_idkhoa,madoituong=:m_madoituong,idgiuong=:m_idgiuong,tu=to_timestamp(:m_tu,'dd/mm/yyyy hh24:mi'),dongia=:m_dongia,userid=:m_userid where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                cmd.Parameters.Add("m_idkhoa", NpgsqlDbType.Numeric).Value = m_idkhoa;
                cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                cmd.Parameters.Add("m_idgiuong", NpgsqlDbType.Numeric).Value = m_idgiuong;
                cmd.Parameters.Add("m_tu", NpgsqlDbType.Varchar, 16).Value = m_tu;
                cmd.Parameters.Add("m_dongia", NpgsqlDbType.Numeric).Value = m_dongia;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".theodoigiuong (id,makp,mabn,mavaovien,maql,idkhoa,madoituong,idgiuong,tu,dongia,userid) values (:m_id,:m_makp,:m_mabn,:m_mavaovien,:m_maql,:m_idkhoa,:m_madoituong,:m_idgiuong,to_timestamp(:m_tu,'dd/mm/yyyy hh24:mi'),:m_dongia,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_idkhoa", NpgsqlDbType.Numeric).Value = m_idkhoa;
                    cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                    cmd.Parameters.Add("m_idgiuong", NpgsqlDbType.Numeric).Value = m_idgiuong;
                    cmd.Parameters.Add("m_tu", NpgsqlDbType.Varchar, 16).Value = m_tu;
                    cmd.Parameters.Add("m_dongia", NpgsqlDbType.Numeric).Value = m_dongia;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "theodoigiuong");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_theodoigiuong(decimal m_id, string m_den, int m_madoituong, decimal m_soluong)
        {
            sql = "update " + user + ".theodoigiuong set den=to_timestamp(:m_den,'dd/mm/yyyy hh24:mi'),madoituong=:m_madoituong,soluong=:m_soluong where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_den", NpgsqlDbType.Varchar, 16).Value = m_den;
                cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                cmd.Parameters.Add("m_soluong", NpgsqlDbType.Numeric).Value = m_soluong;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "theodoigiuong");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool bMagiuong(decimal id, string ma)
        {
            return get_data("select * from " + user + ".dmgiuong where ma='" + ma + "' and id<>" + id).Tables[0].Rows.Count > 0;
        }

        public bool bMien(int madoituong)
        {
            return get_data("select * from " + user + ".doituong where madoituong=" + madoituong + " and mien=1").Tables[0].Rows.Count > 0;
        }

        public bool upd_pttt_bs(decimal m_id, int m_loai, string m_mabs)
        {
            sql = "update " + user + ".pttt_bs set loai=:m_loai where id=:m_id and mabs=:m_mabs";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".pttt_bs(id,loai,mabs) values (:m_id,:m_loai,:m_mabs)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "pttt_bs");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_khongdau(string m_codau, string m_khongdau)
        {
            sql = "update " + user + ".khongdau set khongdau=:m_khongdau where codau=:m_codau";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_khongdau", NpgsqlDbType.Text).Value = m_khongdau;
                cmd.Parameters.Add("m_codau", NpgsqlDbType.Text).Value = m_codau;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".khongdau(codau,khongdau) values (:m_codau,:m_khongdau)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_codau", NpgsqlDbType.Text).Value = m_codau;
                    cmd.Parameters.Add("m_khongdau", NpgsqlDbType.Text).Value = m_khongdau;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "khongdau");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_hen(string m_ngay, decimal m_maql, decimal m_songay, string m_ghichu, int m_loai, int m_tiepdon)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".hen set songay=:m_songay,ghichu=:m_ghichu,loai=:m_loai,tiepdon=:m_tiepdon where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_songay", NpgsqlDbType.Numeric).Value = m_songay;
                cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text).Value = m_ghichu;
                cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                cmd.Parameters.Add("m_tiepdon", NpgsqlDbType.Numeric).Value = m_tiepdon;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".hen (maql,songay,ghichu,loai,tiepdon) values (:m_maql,:m_songay,:m_ghichu,:m_loai,:m_tiepdon)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_songay", NpgsqlDbType.Numeric).Value = m_songay;
                    cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text).Value = m_ghichu;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                    cmd.Parameters.Add("m_tiepdon", NpgsqlDbType.Numeric).Value = m_tiepdon;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message.ToString().Trim(), sComputer, "hen");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        #region dinhduong

        public void upd_di_error(string di_message, string di_computer, string di_table)
        {

            con.Close(); con.Dispose();
            sql = "insert into " + user + ".di_error(message,computer,tables,ngayud) values (:di_message,:di_computer,:di_table,now())";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("di_message", NpgsqlDbType.Text).Value = di_message;
                cmd.Parameters.Add("di_computer", NpgsqlDbType.Varchar, 20).Value = di_computer;
                cmd.Parameters.Add("di_table", NpgsqlDbType.Varchar, 20).Value = di_table;
                cmd.ExecuteNonQuery();
            }
            catch { }
            finally
            {
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
        }

        public bool upd_di_danhmuc(string di_table, decimal di_id, decimal di_stt, string di_ma, string di_ten, int di_userid)
        {
            sql = "update " + user + "." + di_table + " set stt=:di_stt,ma=:di_ma,ten=:di_ten,userid=:di_userid where id=:di_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("di_stt", NpgsqlDbType.Numeric).Value = di_stt;
                cmd.Parameters.Add("di_ma", NpgsqlDbType.Varchar, 10).Value = di_ma;
                cmd.Parameters.Add("di_ten", NpgsqlDbType.Text).Value = di_ten;
                cmd.Parameters.Add("di_userid", NpgsqlDbType.Numeric).Value = di_userid;
                cmd.Parameters.Add("di_id", NpgsqlDbType.Numeric).Value = di_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + "." + di_table + " (id,stt,ma,ten,userid) values (:di_id,:di_stt,:di_ma,:di_ten,:di_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("di_id", NpgsqlDbType.Numeric).Value = di_id;
                    cmd.Parameters.Add("di_stt", NpgsqlDbType.Numeric).Value = di_stt;
                    cmd.Parameters.Add("di_ma", NpgsqlDbType.Varchar, 10).Value = di_ma;
                    cmd.Parameters.Add("di_ten", NpgsqlDbType.Text).Value = di_ten;
                    cmd.Parameters.Add("di_userid", NpgsqlDbType.Numeric).Value = di_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_di_error(ex.Message, sComputer, di_table);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_di_dmnhom(decimal di_id, decimal di_stt, string di_ma, string di_ten, int di_anlong, int di_userid)
        {
            sql = "update " + user + ".di_dmnhom set stt=:di_stt,ma=:di_ma,ten=:di_ten,anlong=:di_anlong,userid=:di_userid where id=:di_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("di_stt", NpgsqlDbType.Numeric).Value = di_stt;
                cmd.Parameters.Add("di_ma", NpgsqlDbType.Varchar, 10).Value = di_ma;
                cmd.Parameters.Add("di_ten", NpgsqlDbType.Text).Value = di_ten;
                cmd.Parameters.Add("di_anlong", NpgsqlDbType.Numeric).Value = di_anlong;
                cmd.Parameters.Add("di_userid", NpgsqlDbType.Numeric).Value = di_userid;
                cmd.Parameters.Add("di_id", NpgsqlDbType.Numeric).Value = di_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".di_dmnhom (id,stt,ma,ten,anlong,userid) values (:di_id,:di_stt,:di_ma,:di_ten,:di_anlong,:di_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("di_id", NpgsqlDbType.Numeric).Value = di_id;
                    cmd.Parameters.Add("di_stt", NpgsqlDbType.Numeric).Value = di_stt;
                    cmd.Parameters.Add("di_ma", NpgsqlDbType.Varchar, 10).Value = di_ma;
                    cmd.Parameters.Add("di_ten", NpgsqlDbType.Text).Value = di_ten;
                    cmd.Parameters.Add("di_anlong", NpgsqlDbType.Numeric).Value = di_anlong;
                    cmd.Parameters.Add("di_userid", NpgsqlDbType.Numeric).Value = di_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_di_error(ex.Message, sComputer, "di_dmnhom");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_di_dmchedoan(decimal di_id, decimal di_stt, int di_idnhom, string di_ma, string di_ten, int di_tuan, int di_thu, decimal di_p, decimal di_l, decimal di_g, decimal di_e, decimal di_dongia, int di_userid)
        {
            sql = "update " + user + ".di_dmchedoan set stt=:di_stt,idnhom=:di_idnhom,ma=:di_ma,ten=:di_ten,tuan=:di_tuan,thu=:di_thu,p=:di_p,l=:di_l,g=:di_g,e=:di_e,dongia=:di_dongia,userid=:di_userid where id=:di_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("di_stt", NpgsqlDbType.Numeric).Value = di_stt;
                cmd.Parameters.Add("di_idnhom", NpgsqlDbType.Numeric).Value = di_idnhom;
                cmd.Parameters.Add("di_ma", NpgsqlDbType.Varchar, 10).Value = di_ma;
                cmd.Parameters.Add("di_ten", NpgsqlDbType.Text).Value = di_ten;
                cmd.Parameters.Add("di_tuan", NpgsqlDbType.Numeric).Value = di_tuan;
                cmd.Parameters.Add("di_thu", NpgsqlDbType.Numeric).Value = di_thu;
                cmd.Parameters.Add("di_p", NpgsqlDbType.Numeric).Value = di_p;
                cmd.Parameters.Add("di_l", NpgsqlDbType.Numeric).Value = di_l;
                cmd.Parameters.Add("di_g", NpgsqlDbType.Numeric).Value = di_g;
                cmd.Parameters.Add("di_e", NpgsqlDbType.Numeric).Value = di_e;
                cmd.Parameters.Add("di_dongia", NpgsqlDbType.Numeric).Value = di_dongia;
                cmd.Parameters.Add("di_userid", NpgsqlDbType.Numeric).Value = di_userid;
                cmd.Parameters.Add("di_id", NpgsqlDbType.Numeric).Value = di_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".di_dmchedoan (id,stt,idnhom,ma,ten,tuan,thu,p,l,g,e,dongia,userid) values (:di_id,:di_stt,:di_idnhom,:di_ma,:di_ten,:di_tuan,:di_thu,:di_p,:di_l,:di_g,:di_e,:di_dongia,:di_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("di_id", NpgsqlDbType.Numeric).Value = di_id;
                    cmd.Parameters.Add("di_stt", NpgsqlDbType.Numeric).Value = di_stt;
                    cmd.Parameters.Add("di_idnhom", NpgsqlDbType.Numeric).Value = di_idnhom;
                    cmd.Parameters.Add("di_ma", NpgsqlDbType.Varchar, 10).Value = di_ma;
                    cmd.Parameters.Add("di_ten", NpgsqlDbType.Text).Value = di_ten;
                    cmd.Parameters.Add("di_tuan", NpgsqlDbType.Numeric).Value = di_tuan;
                    cmd.Parameters.Add("di_thu", NpgsqlDbType.Numeric).Value = di_thu;
                    cmd.Parameters.Add("di_p", NpgsqlDbType.Numeric).Value = di_p;
                    cmd.Parameters.Add("di_l", NpgsqlDbType.Numeric).Value = di_l;
                    cmd.Parameters.Add("di_g", NpgsqlDbType.Numeric).Value = di_g;
                    cmd.Parameters.Add("di_e", NpgsqlDbType.Numeric).Value = di_e;
                    cmd.Parameters.Add("di_dongia", NpgsqlDbType.Numeric).Value = di_dongia;
                    cmd.Parameters.Add("di_userid", NpgsqlDbType.Numeric).Value = di_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_di_error(ex.Message, sComputer, "di_dmchedoan");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_di_dmthu(decimal di_id, string di_anh, string di_viet)
        {
            sql = "update " + user + ".di_dmthu set anh=:di_anh,viet=:di_viet where id=:di_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("di_anh", NpgsqlDbType.Varchar, 3).Value = di_anh;
                cmd.Parameters.Add("di_viet", NpgsqlDbType.Text, 20).Value = di_viet;
                cmd.Parameters.Add("di_id", NpgsqlDbType.Numeric).Value = di_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".di_dmthu (id,anh,viet) values (:di_id,:di_anh,:di_viet)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("di_id", NpgsqlDbType.Numeric).Value = di_id;
                    cmd.Parameters.Add("di_anh", NpgsqlDbType.Varchar, 3).Value = di_anh;
                    cmd.Parameters.Add("di_viet", NpgsqlDbType.Text, 20).Value = di_viet;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_di_error(ex.Message, sComputer, "di_dmthu");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_di_dmcu(decimal di_id, decimal di_stt, string di_idgioan, string di_ma, string di_ten, int di_userid)
        {
            sql = "update " + user + ".di_dmcu set stt=:di_stt,idgioan=:di_idgioan,ma=:di_ma,ten=:di_ten,userid=:di_userid where id=:di_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("di_stt", NpgsqlDbType.Numeric).Value = di_stt;
                cmd.Parameters.Add("di_idgioan", NpgsqlDbType.Varchar, 50).Value = di_idgioan;
                cmd.Parameters.Add("di_ma", NpgsqlDbType.Varchar, 10).Value = di_ma;
                cmd.Parameters.Add("di_ten", NpgsqlDbType.Text).Value = di_ten;
                cmd.Parameters.Add("di_userid", NpgsqlDbType.Numeric).Value = di_userid;
                cmd.Parameters.Add("di_id", NpgsqlDbType.Numeric).Value = di_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".di_dmcu (id,stt,idgioan,ma,ten,userid) values (:di_id,:di_stt,:di_idgioan,:di_ma,:di_ten,:di_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("di_id", NpgsqlDbType.Numeric).Value = di_id;
                    cmd.Parameters.Add("di_stt", NpgsqlDbType.Numeric).Value = di_stt;
                    cmd.Parameters.Add("di_idgioan", NpgsqlDbType.Varchar, 50).Value = di_idgioan;
                    cmd.Parameters.Add("di_ma", NpgsqlDbType.Varchar, 10).Value = di_ma;
                    cmd.Parameters.Add("di_ten", NpgsqlDbType.Text).Value = di_ten;
                    cmd.Parameters.Add("di_userid", NpgsqlDbType.Numeric).Value = di_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_di_error(ex.Message, sComputer, "di_dmcu");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_di_dmthucpham(decimal di_id, decimal di_stt, int di_idloai, string di_ma, string di_ten, string di_dvt, decimal di_protein, decimal di_lipid, decimal di_glucid, decimal di_nangluong, decimal di_kali, decimal di_natri, decimal di_dongia, int di_thietyeu, decimal di_soluong, int di_userid)
        {
            sql = "update " + user + ".di_dmthucpham set stt=:di_stt,idloai=:di_idloai,ma=:di_ma,ten=:di_ten,dvt=:di_dvt,protein=:di_protein,lipid=:di_lipid,glucid=:di_glucid,nangluong=:di_nangluong,kali=:di_kali,natri=:di_natri,dongia=:di_dongia,thietyeu=:di_thietyeu,soluong=:di_soluong,userid=:di_userid where id=:di_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("di_stt", NpgsqlDbType.Numeric).Value = di_stt;
                cmd.Parameters.Add("di_idloai", NpgsqlDbType.Numeric).Value = di_idloai;
                cmd.Parameters.Add("di_ma", NpgsqlDbType.Varchar, 10).Value = di_ma;
                cmd.Parameters.Add("di_ten", NpgsqlDbType.Text).Value = di_ten;
                cmd.Parameters.Add("di_dvt", NpgsqlDbType.Text, 20).Value = di_dvt;
                cmd.Parameters.Add("di_protein", NpgsqlDbType.Numeric).Value = di_protein;
                cmd.Parameters.Add("di_lipid", NpgsqlDbType.Numeric).Value = di_lipid;
                cmd.Parameters.Add("di_glucid", NpgsqlDbType.Numeric).Value = di_glucid;
                cmd.Parameters.Add("di_nangluong", NpgsqlDbType.Numeric).Value = di_nangluong;
                cmd.Parameters.Add("di_kali", NpgsqlDbType.Numeric).Value = di_kali;
                cmd.Parameters.Add("di_natri", NpgsqlDbType.Numeric).Value = di_natri;
                cmd.Parameters.Add("di_dongia", NpgsqlDbType.Numeric).Value = di_dongia;
                cmd.Parameters.Add("di_thietyeu", NpgsqlDbType.Numeric).Value = di_thietyeu;
                cmd.Parameters.Add("di_soluong", NpgsqlDbType.Numeric).Value = di_soluong;
                cmd.Parameters.Add("di_userid", NpgsqlDbType.Numeric).Value = di_userid;
                cmd.Parameters.Add("di_id", NpgsqlDbType.Numeric).Value = di_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".di_dmthucpham (id,stt,idloai,ma,ten,dvt,protein,lipid,glucid,nangluong,kali,natri,dongia,thietyeu,soluong,userid) values (:di_id,:di_stt,:di_idloai,:di_ma,:di_ten,:di_dvt,:di_protein,:di_lipid,:di_glucid,:di_nangluong,:di_kali,:di_natri,:di_dongia,:di_thietyeu,:di_soluong,:di_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("di_id", NpgsqlDbType.Numeric).Value = di_id;
                    cmd.Parameters.Add("di_stt", NpgsqlDbType.Numeric).Value = di_stt;
                    cmd.Parameters.Add("di_idloai", NpgsqlDbType.Numeric).Value = di_idloai;
                    cmd.Parameters.Add("di_ma", NpgsqlDbType.Varchar, 10).Value = di_ma;
                    cmd.Parameters.Add("di_ten", NpgsqlDbType.Text).Value = di_ten;
                    cmd.Parameters.Add("di_dvt", NpgsqlDbType.Text, 20).Value = di_dvt;
                    cmd.Parameters.Add("di_protein", NpgsqlDbType.Numeric).Value = di_protein;
                    cmd.Parameters.Add("di_lipid", NpgsqlDbType.Numeric).Value = di_lipid;
                    cmd.Parameters.Add("di_glucid", NpgsqlDbType.Numeric).Value = di_glucid;
                    cmd.Parameters.Add("di_nangluong", NpgsqlDbType.Numeric).Value = di_nangluong;
                    cmd.Parameters.Add("di_kali", NpgsqlDbType.Numeric).Value = di_kali;
                    cmd.Parameters.Add("di_natri", NpgsqlDbType.Numeric).Value = di_natri;
                    cmd.Parameters.Add("di_dongia", NpgsqlDbType.Numeric).Value = di_dongia;
                    cmd.Parameters.Add("di_thietyeu", NpgsqlDbType.Numeric).Value = di_thietyeu;
                    cmd.Parameters.Add("di_soluong", NpgsqlDbType.Numeric).Value = di_soluong;
                    cmd.Parameters.Add("di_userid", NpgsqlDbType.Numeric).Value = di_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_di_error(ex.Message, sComputer, "di_dmthucpham");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_di_dmtpngay(decimal di_id, string di_ngay, decimal di_dongia, int di_thietyeu, int di_userid)
        {
            sql = "update " + user + ".di_dmtpngay set dongia=:di_dongia,thietyeu=:di_thietyeu,userid=:di_userid where id=:di_id and to_char(ngay,'dd/mm/yyyy')=:di_ngay";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("di_dongia", NpgsqlDbType.Numeric).Value = di_dongia;
                cmd.Parameters.Add("di_thietyeu", NpgsqlDbType.Numeric).Value = di_thietyeu;
                cmd.Parameters.Add("di_userid", NpgsqlDbType.Numeric).Value = di_userid;
                cmd.Parameters.Add("di_id", NpgsqlDbType.Numeric).Value = di_id;
                cmd.Parameters.Add("di_ngay", NpgsqlDbType.Varchar, 10).Value = di_ngay;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".di_dmtpngay (id,ngay,dongia,thietyeu,userid) values (:di_id,to_timestamp(:di_ngay,'dd/mm/yyyy'),:di_dongia,:di_thietyeu,:di_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("di_id", NpgsqlDbType.Numeric).Value = di_id;
                    cmd.Parameters.Add("di_ngay", NpgsqlDbType.Varchar, 10).Value = di_ngay;
                    cmd.Parameters.Add("di_dongia", NpgsqlDbType.Numeric).Value = di_dongia;
                    cmd.Parameters.Add("di_thietyeu", NpgsqlDbType.Numeric).Value = di_thietyeu;
                    cmd.Parameters.Add("di_userid", NpgsqlDbType.Numeric).Value = di_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_di_error(ex.Message, sComputer, "di_dmtpngay");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_di_dmtdngay(decimal di_id, string di_ngay, decimal di_dongia, int di_userid)
        {
            sql = "update " + user + ".di_dmtdngay set dongia=:di_dongia,userid=:di_userid where id=:di_id and to_char(ngay,'dd/mm/yyyy')=:di_ngay";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("di_dongia", NpgsqlDbType.Numeric).Value = di_dongia;
                cmd.Parameters.Add("di_userid", NpgsqlDbType.Numeric).Value = di_userid;
                cmd.Parameters.Add("di_id", NpgsqlDbType.Numeric).Value = di_id;
                cmd.Parameters.Add("di_ngay", NpgsqlDbType.Varchar, 10).Value = di_ngay;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".di_dmtdngay (id,ngay,dongia,userid) values (:di_id,to_timestamp(:di_ngay,'dd/mm/yyyy'),:di_dongia,:di_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("di_id", NpgsqlDbType.Numeric).Value = di_id;
                    cmd.Parameters.Add("di_ngay", NpgsqlDbType.Varchar, 10).Value = di_ngay;
                    cmd.Parameters.Add("di_dongia", NpgsqlDbType.Numeric).Value = di_dongia;
                    cmd.Parameters.Add("di_userid", NpgsqlDbType.Numeric).Value = di_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_di_error(ex.Message, sComputer, "di_dmtdngay");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_di_dmthucdon(decimal di_id, decimal di_stt, decimal di_idchedoan, string di_idgioan, string di_ma, string di_ten, decimal di_dongia, decimal di_e, decimal di_p, decimal di_l, decimal di_g, int di_benhly, int di_hide, int di_userid)
        {
            sql = "update " + user + ".di_dmthucdon set stt=:di_stt,idchedoan=:di_idchedoan,idgioan=:di_idgioan,";
            sql += "ma=:di_ma,ten=:di_ten,dongia=:di_dongia,e=:di_e,p=:di_p,l=:di_l,g=:di_g,benhly=:di_benhly,hide=" + di_hide + ",userid=:di_userid ";
            sql += " where id=:di_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("di_stt", NpgsqlDbType.Numeric).Value = di_stt;
                cmd.Parameters.Add("di_idchedoan", NpgsqlDbType.Numeric).Value = di_idchedoan;
                cmd.Parameters.Add("di_idgioan", NpgsqlDbType.Varchar, 20).Value = di_idgioan;
                cmd.Parameters.Add("di_ma", NpgsqlDbType.Varchar, 10).Value = di_ma;
                cmd.Parameters.Add("di_ten", NpgsqlDbType.Text).Value = di_ten;
                cmd.Parameters.Add("di_dongia", NpgsqlDbType.Numeric).Value = di_dongia;
                cmd.Parameters.Add("di_e", NpgsqlDbType.Numeric).Value = di_e;
                cmd.Parameters.Add("di_p", NpgsqlDbType.Numeric).Value = di_p;
                cmd.Parameters.Add("di_l", NpgsqlDbType.Numeric).Value = di_l;
                cmd.Parameters.Add("di_g", NpgsqlDbType.Numeric).Value = di_g;
                cmd.Parameters.Add("di_benhly", NpgsqlDbType.Numeric).Value = di_benhly;
                cmd.Parameters.Add("di_userid", NpgsqlDbType.Numeric).Value = di_userid;
                cmd.Parameters.Add("di_id", NpgsqlDbType.Numeric).Value = di_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".di_dmthucdon (id,stt,idchedoan,idgioan,ma,ten,dongia,e,p,l,g,benhly,hide,userid) values (:di_id,:di_stt,:di_idchedoan,:di_idgioan,:di_ma,:di_ten,:di_dongia,:di_e,:di_p,:di_l,:di_g,:di_benhly," + di_hide + ",:di_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("di_id", NpgsqlDbType.Numeric).Value = di_id;
                    cmd.Parameters.Add("di_stt", NpgsqlDbType.Numeric).Value = di_stt;
                    cmd.Parameters.Add("di_idchedoan", NpgsqlDbType.Numeric).Value = di_idchedoan;
                    cmd.Parameters.Add("di_idgioan", NpgsqlDbType.Varchar, 20).Value = di_idgioan;
                    cmd.Parameters.Add("di_ma", NpgsqlDbType.Varchar, 10).Value = di_ma;
                    cmd.Parameters.Add("di_ten", NpgsqlDbType.Text).Value = di_ten;
                    cmd.Parameters.Add("di_dongia", NpgsqlDbType.Numeric).Value = di_dongia;
                    cmd.Parameters.Add("di_e", NpgsqlDbType.Numeric).Value = di_e;
                    cmd.Parameters.Add("di_p", NpgsqlDbType.Numeric).Value = di_p;
                    cmd.Parameters.Add("di_l", NpgsqlDbType.Numeric).Value = di_l;
                    cmd.Parameters.Add("di_g", NpgsqlDbType.Numeric).Value = di_g;
                    cmd.Parameters.Add("di_benhly", NpgsqlDbType.Numeric).Value = di_benhly;
                    cmd.Parameters.Add("di_userid", NpgsqlDbType.Numeric).Value = di_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_di_error(ex.Message, sComputer, "di_dmthucdon");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_di_dmthucdonct(decimal di_id, decimal di_stt, decimal di_idthucdon, string di_tuan, string di_thu, decimal di_dongia)
        {
            sql = "update " + user + ".di_dmthucdonct set stt=:di_stt,idthucdon=:di_idthucdon,tuan=:di_tuan,thu=:di_thu,dongia=:di_dongia where id=:di_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("di_stt", NpgsqlDbType.Numeric).Value = di_stt;
                cmd.Parameters.Add("di_idthucdon", NpgsqlDbType.Numeric).Value = di_idthucdon;
                cmd.Parameters.Add("di_tuan", NpgsqlDbType.Varchar, 2).Value = di_tuan;
                cmd.Parameters.Add("di_thu", NpgsqlDbType.Varchar, 3).Value = di_thu;
                cmd.Parameters.Add("di_dongia", NpgsqlDbType.Numeric).Value = di_dongia;
                cmd.Parameters.Add("di_id", NpgsqlDbType.Numeric).Value = di_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".di_dmthucdonct (id,stt,idthucdon,tuan,thu,dongia) values (:di_id,:di_stt,:di_idthucdon,:di_tuan,:di_thu,:di_dongia)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("di_id", NpgsqlDbType.Numeric).Value = di_id;
                    cmd.Parameters.Add("di_stt", NpgsqlDbType.Numeric).Value = di_stt;
                    cmd.Parameters.Add("di_idthucdon", NpgsqlDbType.Numeric).Value = di_idthucdon;
                    cmd.Parameters.Add("di_tuan", NpgsqlDbType.Varchar, 2).Value = di_tuan;
                    cmd.Parameters.Add("di_thu", NpgsqlDbType.Varchar, 3).Value = di_thu;
                    cmd.Parameters.Add("di_dongia", NpgsqlDbType.Numeric).Value = di_dongia;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_di_error(ex.Message, sComputer, "di_dmthucdonct");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_di_dmthucdontp(decimal di_id, decimal di_stt, decimal di_idthucdonct, decimal di_idthucpham, decimal di_soluong, int di_tt, decimal di_e, decimal di_p, decimal di_l, decimal di_g)
        {
            sql = "update " + user + ".di_dmthucdontp set stt=:di_stt,idthucdonct=:di_idthucdonct,idthucpham=:di_idthucpham,soluong=:di_soluong,tt=:di_tt,e=:di_e,p=:di_p,l=:di_l,g=:di_g where id=:di_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("di_stt", NpgsqlDbType.Numeric).Value = di_stt;
                cmd.Parameters.Add("di_idthucdonct", NpgsqlDbType.Numeric).Value = di_idthucdonct;
                cmd.Parameters.Add("di_idthucpham", NpgsqlDbType.Numeric).Value = di_idthucpham;
                cmd.Parameters.Add("di_soluong", NpgsqlDbType.Numeric).Value = di_soluong;
                cmd.Parameters.Add("di_tt", NpgsqlDbType.Numeric).Value = di_tt;
                cmd.Parameters.Add("di_e", NpgsqlDbType.Numeric).Value = di_e;
                cmd.Parameters.Add("di_p", NpgsqlDbType.Numeric).Value = di_p;
                cmd.Parameters.Add("di_l", NpgsqlDbType.Numeric).Value = di_l;
                cmd.Parameters.Add("di_g", NpgsqlDbType.Numeric).Value = di_g;
                cmd.Parameters.Add("di_id", NpgsqlDbType.Numeric).Value = di_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".di_dmthucdontp (id,stt,idthucdonct,idthucpham,soluong,tt,e,p,l,g) values (:di_id,:di_stt,:di_idthucdonct,:di_idthucpham,:di_soluong,:di_tt,:di_e,:di_p,:di_l,:di_g)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("di_id", NpgsqlDbType.Numeric).Value = di_id;
                    cmd.Parameters.Add("di_stt", NpgsqlDbType.Numeric).Value = di_stt;
                    cmd.Parameters.Add("di_idthucdonct", NpgsqlDbType.Numeric).Value = di_idthucdonct;
                    cmd.Parameters.Add("di_idthucpham", NpgsqlDbType.Numeric).Value = di_idthucpham;
                    cmd.Parameters.Add("di_soluong", NpgsqlDbType.Numeric).Value = di_soluong;
                    cmd.Parameters.Add("di_tt", NpgsqlDbType.Numeric).Value = di_tt;
                    cmd.Parameters.Add("di_e", NpgsqlDbType.Numeric).Value = di_e;
                    cmd.Parameters.Add("di_p", NpgsqlDbType.Numeric).Value = di_p;
                    cmd.Parameters.Add("di_l", NpgsqlDbType.Numeric).Value = di_l;
                    cmd.Parameters.Add("di_g", NpgsqlDbType.Numeric).Value = di_g;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_di_error(ex.Message, sComputer, "di_dmthucdontp");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_di_thongso(decimal di_id, string di_loai, string di_ten)
        {
            sql = "update " + user + ".di_thongso set loai=:di_loai,ten=:di_ten where id=:di_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("di_loai", NpgsqlDbType.Varchar, 50).Value = di_loai;
                cmd.Parameters.Add("di_ten", NpgsqlDbType.Text).Value = di_ten;
                cmd.Parameters.Add("di_id", NpgsqlDbType.Numeric).Value = di_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".di_thongso (id,loai,ten) values (:di_id,:di_loai,:di_ten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("di_id", NpgsqlDbType.Numeric).Value = di_id;
                    cmd.Parameters.Add("di_loai", NpgsqlDbType.Varchar, 50).Value = di_loai;
                    cmd.Parameters.Add("di_ten", NpgsqlDbType.Text).Value = di_ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_di_error(ex.Message, sComputer, "di_thongso");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_di_dlogin(decimal di_id, string di_hoten, string di_userid, string di_password_, string di_right_, int di_tao, int di_admin)
        {
            sql = "update " + user + ".di_dlogin set hoten=:di_hoten,userid=:di_userid,password_=:di_password_,right_=:di_right_,tao=:di_tao,admin=:di_admin where id=:di_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("di_hoten", NpgsqlDbType.Text).Value = di_hoten;
                cmd.Parameters.Add("di_userid", NpgsqlDbType.Varchar, 20).Value = di_userid;
                cmd.Parameters.Add("di_password_", NpgsqlDbType.Varchar, 20).Value = di_password_;
                cmd.Parameters.Add("di_right_", NpgsqlDbType.Text).Value = di_right_;
                cmd.Parameters.Add("di_tao", NpgsqlDbType.Numeric).Value = di_tao;
                cmd.Parameters.Add("di_admin", NpgsqlDbType.Numeric).Value = di_admin;
                cmd.Parameters.Add("di_id", NpgsqlDbType.Numeric).Value = di_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".di_dlogin (id,hoten,userid,password_,right_,tao,admin) values (:di_id,:di_hoten,:di_userid,:di_password_,:di_right_,:di_tao,:di_admin)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("di_id", NpgsqlDbType.Numeric).Value = di_id;
                    cmd.Parameters.Add("di_hoten", NpgsqlDbType.Text).Value = di_hoten;
                    cmd.Parameters.Add("di_userid", NpgsqlDbType.Varchar, 20).Value = di_userid;
                    cmd.Parameters.Add("di_password_", NpgsqlDbType.Varchar, 20).Value = di_password_;
                    cmd.Parameters.Add("di_right_", NpgsqlDbType.Text).Value = di_right_;
                    cmd.Parameters.Add("di_tao", NpgsqlDbType.Numeric).Value = di_tao;
                    cmd.Parameters.Add("di_admin", NpgsqlDbType.Numeric).Value = di_admin;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_di_error(ex.Message, sComputer, "di_dlogin");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_di_dlogin_right(decimal di_id, string di_right_)
        {
            sql = "update " + user + ".di_dlogin set right_=:di_right_ where id=:di_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("di_right_", NpgsqlDbType.Text).Value = di_right_;
                cmd.Parameters.Add("di_id", NpgsqlDbType.Numeric).Value = di_id;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            catch (Exception ex)
            {
                upd_di_error(ex.Message, sComputer, "di_dlogin");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public void updrec(DataTable dt, decimal id, string userid, string password, string right)
        {
            string exp = "id=" + id;
            DataRow r = getrowbyid(dt, exp);
            if (r == null)
            {
                DataRow nrow = dt.NewRow();
                nrow["id"] = id;
                nrow["userid"] = userid;
                nrow["password_"] = password;
                nrow["right_"] = right;
                dt.Rows.Add(nrow);
            }
            else
            {
                DataRow[] dr = dt.Select(exp);
                dr[0]["right_"] = right;
            }
        }

        public void updrec_right(DataTable dt, decimal id, string right)
        {
            string exp = "id=" + id;
            DataRow r = getrowbyid(dt, exp);
            if (r == null)
            {
                DataRow nrow = dt.NewRow();
                nrow["id"] = id;
                nrow["right_"] = right;
                dt.Rows.Add(nrow);
            }
            else
            {
                DataRow[] dr = dt.Select(exp);
                dr[0]["right_"] = right;
            }
        }

        public int di_loaivp
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".di_thongso where id=1");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 0; }
            }
        }

        public bool bdi_vpkhoa
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".di_thongso where id=2");
                    return ds.Tables[0].Rows[0][0].ToString() == "1";
                }
                catch { return false; }
            }
        }

        public decimal get_id_di_duyet
        {
            get
            {
                return decimal.Parse(iRownum.ToString().PadLeft(3, '0') + get_capid_may(-999, sComputer).ToString().PadLeft(9, '0'));
            }
        }
        public decimal get_id_di_kthucdonll
        {
            get
            {
                return decimal.Parse(iRownum.ToString().PadLeft(3, '0') + get_capid_may(-998, sComputer).ToString().PadLeft(9, '0'));
            }
        }
        public decimal get_id_di_thucdonll
        {
            get
            {
                return decimal.Parse(iRownum.ToString().PadLeft(3, '0') + get_capid_may(-997, sComputer).ToString().PadLeft(9, '0'));
            }
        }
        public decimal get_id_di_nauan
        {
            get
            {
                return decimal.Parse(iRownum.ToString().PadLeft(3, '0') + get_capid_may(-996, sComputer).ToString().PadLeft(9, '0'));
            }
        }
        public decimal get_id_di_dmthucdon
        {
            get
            {
                return get_capid(-995);
            }
        }

        public bool upd_di_duyet(string mmyy, decimal id, string ngay, string makp, int phieu, int sobn, int hienco, int vao, int ra, int cat, int bao, int userid)
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }

            con = new NpgsqlConnection(sConn);
            con.Open();
            string sql = "update " + user + mmyy + ".di_duyet set sobn=" + sobn + ",hienco=" + hienco + ",vao=" + vao + ",ra=" + ra + ",cat=" + cat + ",bao=" + bao + " where id=" + id;
            cmd = new NpgsqlCommand(sql, con);
            try
            {
                if (cmd.ExecuteNonQuery() == 0)
                {
                    sql = "insert into " + user + mmyy + ".di_duyet(id,ngay,makp,phieu,sobn,hienco,vao,ra,cat,bao,done,userid) values(" + id + ",to_date('" + ngay + "','dd/mm/yyyy'),'" + makp + "'," + phieu + "," + sobn + "," + hienco + "," + vao + "," + ra + "," + cat + "," + bao + ",0," + userid + ")";
                    cmd.CommandText = sql;
                    cmd.ExecuteNonQuery();
                }
            }
            catch (Exception ex) { upd_di_error(ex.Message, sComputer, "di_duyet"); return false; }
            finally { cmd.Dispose(); con.Close(); con.Dispose(); }
            return true;
        }
        public bool upd_di_kthucdonll(string mmyy, decimal id, decimal idduyet, string mabn, decimal maql, decimal idkhoa, int madoituong, int idcu, int moi, int dacbiet, string giuong, string maicd, string chandoan, string mabs, string yta)
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }

            con = new NpgsqlConnection(sConn);
            con.Open();
            string sql = "update " + user + mmyy + ".di_kthucdonll set mabn='" + mabn + "',maql=" + maql + ",idkhoa=" + idkhoa + ",madoituong=" + madoituong + ",idcu=" + idcu + ",moi=" + moi + ",dacbiet=" + dacbiet + ",giuong='" + giuong + "',maicd='" + maicd + "',chandoan='" + chandoan + "',mabs='" + mabs + "',yta='" + yta + "' where id=" + id;
            cmd = new NpgsqlCommand(sql, con);
            try
            {
                if (cmd.ExecuteNonQuery() == 0)
                {
                    sql = "insert into " + user + mmyy + ".di_kthucdonll(id,idduyet,mabn,maql,idkhoa,madoituong,idcu,moi,dacbiet,giuong,maicd,chandoan,mabs,yta)";
                    sql += " values(" + id + "," + idduyet + ",'" + mabn + "'," + maql + "," + idkhoa + "," + madoituong + "," + idcu + "," + moi + "," + dacbiet + ",'" + giuong + "','" + maicd + "','" + chandoan + "','" + mabs + "','" + yta + "')";
                    cmd.CommandText = sql;
                    cmd.ExecuteNonQuery();
                }
            }
            catch (Exception ex) { upd_di_error(ex.Message, sComputer, "di_kthucdonll"); return false; }
            finally { cmd.Dispose(); con.Close(); con.Dispose(); }
            return true;
        }
        public bool upd_di_kthucdonct(string mmyy, decimal id, int stt, int idgioan, int idthucdon, int soluong, decimal e, decimal p, decimal l, decimal g, int idchedoan, decimal dongia)
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }

            con = new NpgsqlConnection(sConn);
            con.Open();
            string sql = "update " + user + mmyy + ".di_kthucdonct set idgioan=" + idgioan + ",idthucdon=" + idthucdon + ",dongia=" + dongia + ",soluong=" + soluong + ",e=" + e + ",p=" + p + ",l=" + l + ",g=" + g + ",idchedoan=" + idchedoan + " where id=" + id + " and stt=" + stt;
            cmd = new NpgsqlCommand(sql, con);
            try
            {
                if (cmd.ExecuteNonQuery() == 0)
                {
                    sql = "insert into " + user + mmyy + ".di_kthucdonct(id,stt,idgioan,idthucdon,soluong,e,p,l,g,idchedoan,dongia)";
                    sql += " values(" + id + "," + stt + "," + idgioan + "," + idthucdon + "," + soluong + "," + e + "," + p + "," + l + "," + g + "," + idchedoan + "," + dongia + ")";
                    cmd.CommandText = sql;
                    cmd.ExecuteNonQuery();
                }
            }
            catch (Exception ex) { upd_di_error(ex.Message, sComputer, "di_kthucdonct"); return false; }
            finally { cmd.Dispose(); con.Close(); con.Dispose(); }
            return true;
        }
        public bool upd_di_anlong(string mmyy, decimal id, int idchedoan, string sang, string chieu)
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }

            con = new NpgsqlConnection(sConn);
            con.Open();
            string sql = "update " + user + mmyy + ".di_anlong set sang='" + sang + "',chieu='" + chieu + "' where id=" + id;
            cmd = new NpgsqlCommand(sql, con);
            try
            {
                if (cmd.ExecuteNonQuery() == 0)
                {
                    sql = "insert into " + user + mmyy + ".di_anlong(id,idchedoan,sang,chieu)";
                    sql += " values(" + id + "," + idchedoan + ",'" + sang + "','" + chieu + "')";
                    cmd.CommandText = sql;
                    cmd.ExecuteNonQuery();
                }
            }
            catch (Exception ex) { upd_di_error(ex.Message, sComputer, "di_anlong"); return false; }
            finally { cmd.Dispose(); con.Close(); con.Dispose(); }
            return true;
        }
        public bool upd_di_thucdonll(string mmyy, decimal id, decimal idduyet, string mabn, decimal maql, decimal idkhoa, string makp, string ngay, int phieu, int madoituong, int idcu, int moi, int dacbiet, string giuong, string mabs, string yta, int userid)
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }

            con = new NpgsqlConnection(sConn);
            con.Open();
            string sql = "update " + user + mmyy + ".di_thucdonll set mabn='" + mabn + "',maql=" + maql + ",idkhoa=" + idkhoa + ",makp='" + makp + "',ngay=to_timestamp('" + ngay + "','dd/mm/yyyy'),phieu=" + phieu + ",madoituong=" + madoituong + ",idcu=" + idcu + ",moi=" + moi + ",dacbiet=" + dacbiet + ",giuong='" + giuong + "',mabs='" + mabs + "',yta='" + yta + "' where id=" + id;
            cmd = new NpgsqlCommand(sql, con);
            try
            {
                if (cmd.ExecuteNonQuery() == 0)
                {
                    sql = "insert into " + user + mmyy + ".di_thucdonll(id,idduyet,mabn,maql,idkhoa,makp,ngay,phieu,madoituong,idcu,moi,dacbiet,giuong,mabs,yta,userid)";
                    sql += " values(" + id + "," + idduyet + ",'" + mabn + "'," + maql + "," + idkhoa + ",'" + makp + "',to_timestamp('" + ngay + "','dd/mm/yyyy')," + phieu + "," + madoituong + "," + idcu + "," + moi + "," + dacbiet + ",'" + giuong + "','" + mabs + "','" + yta + "'," + userid + ")";
                    cmd.CommandText = sql;
                    cmd.ExecuteNonQuery();
                }
            }
            catch (Exception ex) { upd_di_error(ex.Message, sComputer, "di_thucdonll"); return false; }
            finally { cmd.Dispose(); con.Close(); con.Dispose(); }
            return true;
        }
        public bool upd_di_thucdonct(string mmyy, decimal id, int stt, int idgioan, decimal idthucdon, int soluong, decimal e, decimal p, decimal l, decimal g, decimal idchedoan, decimal dongia, decimal vpkhoa)
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }

            con = new NpgsqlConnection(sConn);
            con.Open();
            string sql = "update " + user + mmyy + ".di_thucdonct set idgioan=" + idgioan + ",idthucdon=" + idthucdon + ",soluong=" + soluong + ",e=" + e + ",p=" + p + ",l=" + l + ",g=" + g + ",idchedoan=" + idchedoan + ",vpkhoa=" + vpkhoa + " where id=" + id + " and stt=" + stt;
            cmd = new NpgsqlCommand(sql, con);
            try
            {
                if (cmd.ExecuteNonQuery() == 0)
                {
                    sql = "insert into " + user + mmyy + ".di_thucdonct(id,stt,idgioan,idthucdon,soluong,e,p,l,g,idchedoan,dongia,vpkhoa)";
                    sql += " values(" + id + "," + stt + "," + idgioan + "," + idthucdon + "," + soluong + "," + e + "," + p + "," + l + "," + g + "," + idchedoan + "," + dongia + "," + vpkhoa + ")";
                    cmd.CommandText = sql;
                    cmd.ExecuteNonQuery();
                }
            }
            catch (Exception ex) { upd_di_error(ex.Message, sComputer, "di_thucdonct"); return false; }
            finally { cmd.Dispose(); con.Close(); con.Dispose(); }
            return true;
        }
        public bool upd_di_nauan(string mmyy, decimal id, string ngay, string ghichu1, string ghichu2, int userid)
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }

            con = new NpgsqlConnection(sConn);
            con.Open();
            string sql = "update " + user + mmyy + ".di_nauan set ghichu1=:ghichu1,ghichu2=:ghichu2,ngayud=now() where id=" + id;
            cmd = new NpgsqlCommand(sql, con);
            cmd.Parameters.Add("ghichu1", NpgsqlDbType.Text).Value = ghichu1;
            cmd.Parameters.Add("ghichu2", NpgsqlDbType.Text).Value = ghichu2;
            try
            {
                if (cmd.ExecuteNonQuery() == 0)
                {
                    sql = "insert into " + user + mmyy + ".di_nauan(id,ngay,ghichu1,ghichu2,userid,ngayud)";
                    sql += " values(" + id + ",to_date('" + ngay + "','dd/mm/yyyy'),:ghichu1,:ghichu2," + userid + ",now())";
                    cmd.CommandText = sql;
                    cmd.ExecuteNonQuery();
                }
            }
            catch (Exception ex) { upd_di_error(ex.Message, sComputer, "di_nauan"); return false; }
            finally { cmd.Dispose(); con.Close(); con.Dispose(); }
            return true;
        }
        public bool upd_di_nauanct(string mmyy, decimal id, int idgioan, string chedoan, string thucpham)
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }

            con = new NpgsqlConnection(sConn);
            con.Open();
            string sql = "update " + user + mmyy + ".di_nauanct set chedoan=:chedoan,thucpham=:thucpham where id=" + id;
            cmd = new NpgsqlCommand(sql, con);
            cmd.Parameters.Add("chedoan", NpgsqlDbType.Text).Value = chedoan;
            cmd.Parameters.Add("thucpham", NpgsqlDbType.Text).Value = thucpham;
            try
            {
                if (cmd.ExecuteNonQuery() == 0)
                {
                    sql = "insert into " + user + mmyy + ".di_nauanct(id,idgioan,chedoan,thucpham)";
                    sql += " values(" + id + "," + idgioan + ",:chedoan,:thucpham)";
                    cmd.CommandText = sql;
                    cmd.ExecuteNonQuery();
                }
            }
            catch (Exception ex) { upd_di_error(ex.Message, sComputer, "di_nauanct"); return false; }
            finally { cmd.Dispose(); con.Close(); con.Dispose(); }
            return true;
        }

        public bool upd_di_giabenhly(decimal tu, decimal den, decimal dongia, int userid)
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }

            con = new NpgsqlConnection(sConn);
            con.Open();
            string sql = "update " + user + ".di_giabenhly set dongia=:dongia,userid=:userid where tu=" + tu + " and den=" + den;
            cmd = new NpgsqlCommand(sql, con);
            cmd.Parameters.Add("dongia", NpgsqlDbType.Numeric).Value = dongia;
            cmd.Parameters.Add("userid", NpgsqlDbType.Numeric).Value = userid;
            try
            {
                if (cmd.ExecuteNonQuery() == 0)
                {
                    sql = "insert into " + user + ".di_giabenhly(tu,den,dongia,userid)";
                    sql += " values(" + tu + "," + den + "," + dongia + "," + userid + ")";
                    cmd.CommandText = sql;
                    cmd.ExecuteNonQuery();
                }
            }
            catch (Exception ex) { upd_di_error(ex.Message, sComputer, "di_giabenhly"); return false; }
            finally { cmd.Dispose(); con.Close(); con.Dispose(); }
            return true;
        }

        public bool upd_di_dmtdche(decimal id, string ngay, string mabn, decimal idkthucdonct, int stt, decimal idchedoan, int idgioan, decimal e, decimal p, decimal l, decimal g, decimal soluong)
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }

            con = new NpgsqlConnection(sConn);
            con.Open();
            string sql = "update " + user + ".di_dmtdche set ngay=to_timestamp('" + ngay + "','dd/mm/yyyy'),mabn='" + mabn + "',idkthucdonct=" + idkthucdonct + ",stt=" + stt + ",idchedoan=" + idchedoan + ",idgioan=" + idgioan + ",e=" + e + ",p=" + p + ",l=" + l + ",g=" + g + ",soluong=" + soluong + " where id=" + id;
            cmd = new NpgsqlCommand(sql, con);
            try
            {
                if (cmd.ExecuteNonQuery() == 0)
                {
                    sql = "insert into " + user + ".di_dmtdche(id,ngay,mabn,idkthucdonct,stt,idchedoan,idgioan,e,p,l,g,soluong)";
                    sql += " values(" + id + ",to_timestamp('" + ngay + "','dd/mm/yyyy'),'" + mabn + "'," + idkthucdonct + "," + stt + "," + idchedoan + "," + idgioan + "," + e + "," + p + "," + l + "," + g + "," + soluong + ")";
                    cmd.CommandText = sql;
                    cmd.ExecuteNonQuery();
                }
            }
            catch (Exception ex) { upd_di_error(ex.Message, sComputer, "di_dmtdche"); return false; }
            finally { cmd.Dispose(); con.Close(); con.Dispose(); }
            return true;
        }

        public bool upd_di_dmtdicd(decimal id, string maicd, string chandoan, decimal idchedoan, decimal e, decimal p, decimal l, decimal g)
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }

            con = new NpgsqlConnection(sConn);
            con.Open();
            string sql = "update " + user + ".di_dmtdicd set maicd='" + maicd + "',chandoan='" + chandoan + "',e=" + e + ",p=" + p + ",l=" + l + ",g=" + g + " where id=" + id;
            cmd = new NpgsqlCommand(sql, con);
            try
            {
                if (cmd.ExecuteNonQuery() == 0)
                {
                    sql = "insert into " + user + ".di_dmtdicd(id,maicd,chandoan,idchedoan,e,p,l,g)";
                    sql += " values(" + id + ",'" + maicd + "','" + chandoan + "'," + idchedoan + "," + e + "," + p + "," + l + "," + g + ")";
                    cmd.CommandText = sql;
                    cmd.ExecuteNonQuery();
                }
            }
            catch (Exception ex) { upd_di_error(ex.Message, sComputer, "di_dmtdicd"); return false; }
            finally { cmd.Dispose(); con.Close(); con.Dispose(); }
            return true;
        }

        public bool upd_di_ngayduyet(string mmyy, string makp, string ngay, decimal idduyet, int phieu)
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }

            con = new NpgsqlConnection(sConn);
            con.Open();
            string sql = "update " + user + mmyy + ".di_ngayduyet set makp='" + makp + "' where makp='" + makp + "' and to_char(ngay,'dd/mm/yyyy')='" + ngay + "' and idduyet=" + idduyet + " and phieu=" + phieu;
            cmd = new NpgsqlCommand(sql, con);
            try
            {
                if (cmd.ExecuteNonQuery() == 0)
                {
                    sql = "insert into " + user + mmyy + ".di_ngayduyet(makp,ngay,idduyet,phieu)";
                    sql += " values('" + makp + "',to_timestamp('" + ngay + "','dd/mm/yyyy')," + idduyet + "," + phieu + ")";
                    cmd.CommandText = sql;
                    cmd.ExecuteNonQuery();
                }
            }
            catch (Exception ex) { upd_di_error(ex.Message, sComputer, "di_ngayduyet"); return false; }
            finally { cmd.Dispose(); con.Close(); con.Dispose(); }
            return true;
        }

        public void del_di_ngayduyet(string mmyy, string makp, string ngay, int phieu)
        {
            execute_data("delete from " + user + mmyy + ".di_ngayduyet where makp='" + makp + "' and to_char(ngay,'dd/mm/yyyy')='" + ngay + "' and phieu=" + phieu);
        }

        public bool get_di_ngayduyet(string s_mmyy, string makp, string ngay, int phieu)
        {
            sql = "select * from " + user + s_mmyy + ".di_ngayduyet where makp='" + makp + "' and to_char(ngay,'dd/mm/yyyy')='" + ngay + "' and phieu=" + phieu;
            return get_data(sql).Tables[0].Rows.Count > 0;
        }

        public DataSet getinbaoan(string tu, string den, string cont, bool khoa)
        {
            string usr = user;
            sql = "select '' as mainkey,b.dacbiet,g.ten as nhom,k.ten as gioan,e.ten as thucdon,";
            sql += "case when b.dacbiet=1 then f.ten else e.ten end as chedoan,e.ma as mathucdon,";
            sql += "case when b.dacbiet=1 then f.ma else e.ma end as machedoan,";
            sql += "to_char(a.ngay,'dd/mm/yyyy') as ngay,b.moi,b.giuong,";
            if (khoa) sql += "b.chandoan,";
            else sql += "j.chandoan,";
            sql += "h.hoten as tenbs,i.hoten as tenyta,d.mabn,d.hoten,d.hoten as ten,";
            sql += "to_number(to_char(now(),'yyyy'),'9999')-to_number(d.namsinh,'9999') as tuoi,d.namsinh,d.phai,";
            sql += "c.e,c.p,c.l,c.g,c.soluong,c.dongia,c.soluong*c.dongia as sotien,a.sobn,a.hienco,a.vao,a.ra,a.cat,a.bao,";
            sql += "g.stt as tt1,k.stt as tt2,f.stt as tt3";
            if (khoa)
            {
                sql += " from xxx.di_duyet a inner join xxx.di_kthucdonll b on a.id=b.idduyet ";
                sql += " inner join xxx.di_kthucdonct c on b.id=c.id ";
            }
            else
            {
                sql += " from xxx.di_duyet a inner join xxx.di_thucdonll b on a.id=b.idduyet ";
                sql += " inner join xxx.di_thucdonct c on b.id=c.id ";
            }
            sql += " inner join " + usr + ".btdbn d on b.mabn=d.mabn ";
            sql += " left join " + usr + ".di_dmthucdon e on c.idthucdon=e.id ";
            sql += " inner join " + usr + ".di_dmchedoan f on c.idchedoan=f.id ";
            sql += " inner join " + usr + ".di_dmnhom g on f.idnhom=g.id ";
            sql += " left join " + usr + ".dmbs h on b.mabs=h.ma";
            sql += " left join " + usr + ".dmbs i on b.yta=h.ma ";
            if (!khoa) sql += " inner join xxx.di_kthucdonll j on b.id=j.id ";
            sql += " inner join " + usr + ".di_dmgioan k on c.idgioan=k.id ";
            sql += cont;
            sql += " order by b.dacbiet,g.stt,k.stt,f.stt";
            DataSet tmp = get_data_mmyy(sql, tu, den, false);
            ds = new DataSet();
            ds = tmp.Copy();
            ds.Clear();
            string s = "";
            DataRow[] dr;
            DataRow r1, r2;
            foreach (DataRow r in tmp.Tables[0].Rows)
            {
                sql = "nhom='" + r["nhom"].ToString() + "' and gioan='" + r["gioan"].ToString() + "' and chedoan='" + r["chedoan"].ToString() + "'";
                sql += " and dacbiet=" + int.Parse(r["dacbiet"].ToString());
                if (r["dacbiet"].ToString() == "1") sql += " and mabn='" + r["mabn"].ToString() + "'";
                r1 = getrowbyid(ds.Tables[0], sql);
                if (r1 == null)
                {
                    r2 = ds.Tables[0].NewRow();
                    r2["mainkey"] = r["dacbiet"].ToString() + r["tt1"].ToString().PadLeft(10, '0') + r["tt2"].ToString().PadLeft(10, '0') + r["tt3"].ToString().PadLeft(10, '0');
                    r2["tt1"] = r["tt1"].ToString();
                    r2["tt2"] = r["tt2"].ToString();
                    r2["tt3"] = r["tt3"].ToString();
                    r2["nhom"] = r["nhom"].ToString();
                    r2["gioan"] = r["gioan"].ToString();
                    r2["thucdon"] = r["thucdon"].ToString();
                    r2["chedoan"] = r["chedoan"].ToString();
                    r2["mathucdon"] = r["mathucdon"].ToString();
                    r2["machedoan"] = r["machedoan"].ToString();
                    r2["ngay"] = r["ngay"].ToString();
                    r2["moi"] = r["moi"].ToString();
                    r2["dacbiet"] = r["dacbiet"].ToString();
                    r2["giuong"] = r["giuong"].ToString();
                    r2["chandoan"] = r["chandoan"].ToString();
                    r2["tenbs"] = r["tenbs"].ToString();
                    r2["tenyta"] = r["tenyta"].ToString();
                    r2["mabn"] = r["mabn"].ToString();
                    r2["hoten"] = r["hoten"].ToString();
                    r2["ten"] = holot_ten(r["ten"].ToString().Trim()) + ((r["giuong"].ToString() != "") ? "(" + r["giuong"].ToString().Trim() + ")" : "");
                    r2["tuoi"] = r["tuoi"].ToString();
                    r2["namsinh"] = r["namsinh"].ToString();
                    r2["phai"] = r["phai"].ToString();
                    r2["e"] = r["e"].ToString();
                    r2["p"] = r["p"].ToString();
                    r2["l"] = r["l"].ToString();
                    r2["g"] = r["g"].ToString();
                    r2["soluong"] = r["soluong"].ToString();
                    r2["dongia"] = r["dongia"].ToString();
                    r2["sotien"] = r["sotien"].ToString();
                    r2["sobn"] = r["sobn"].ToString();
                    r2["hienco"] = r["hienco"].ToString();
                    r2["vao"] = r["vao"].ToString();
                    r2["ra"] = r["ra"].ToString();
                    r2["cat"] = r["cat"].ToString();
                    r2["bao"] = r["bao"].ToString();
                    ds.Tables[0].Rows.Add(r2);
                }
                else
                {
                    dr = ds.Tables[0].Select(sql);
                    if (dr.Length > 0)
                    {
                        s = dr[0]["ten"].ToString().Trim() + "," + holot_ten(r["ten"].ToString().Trim()) + ((r["giuong"].ToString() != "") ? "(" + r["giuong"].ToString().Trim() + ")" : "");
                        dr[0]["soluong"] = decimal.Parse(dr[0]["soluong"].ToString()) + decimal.Parse(r["soluong"].ToString());
                        dr[0]["sotien"] = decimal.Parse(dr[0]["sotien"].ToString()) + decimal.Parse(r["sotien"].ToString());
                        dr[0]["ten"] = s;
                    }
                }
            }
            return ds;
        }

        public DataSet getinnauan1(string tu, string den, string cont)
        {
            string usr = user;
            sql = "select to_char(b.ngay,'dd/mm/yyyy') as ngay,to_char(b.ngay,'dd/mm/yyyy')||to_char(g.stt,'0000000000')||to_char(k.stt,'0000000000')||to_char(f.stt,'0000000000')||to_char(l.stt,'0000000000')||to_char(i.stt,'0000000000') as mainkey,";
            sql += "g.ten as nhom,k.ten as gioan,e.ten as chedoan,";
            sql += "i.ten as tenthucpham,i.dvt,sum(h.soluong) as soluong";
            sql += " from xxx.di_duyet a inner join xxx.di_thucdonll b on a.id=b.idduyet ";
            sql += " inner join xxx.di_thucdonct c on b.id=c.id ";
            sql += " left join " + usr + ".di_dmthucdon e on c.idthucdon=e.id ";
            sql += " inner join " + usr + ".di_dmchedoan f on c.idchedoan=f.id ";
            sql += " inner join " + usr + ".di_dmnhom g on f.idnhom=g.id ";
            sql += " left join " + usr + ".di_dmthucdontp h on e.id=h.idthucdonct";
            sql += " left join " + usr + ".di_dmthucpham i on h.idthucpham=i.id ";
            sql += " inner join " + usr + ".di_dmgioan k on c.idgioan=k.id ";
            sql += " left join " + usr + ".di_dmloaitp l on i.idloai=l.id";
            sql += cont;
            sql += " group by to_char(b.ngay,'dd/mm/yyyy'),to_char(b.ngay,'dd/mm/yyyy')||to_char(g.stt,'0000000000')||to_char(k.stt,'0000000000')||to_char(f.stt,'0000000000')||to_char(l.stt,'0000000000')||to_char(i.stt,'0000000000'),";
            sql += "g.ten,k.ten,e.ten,i.ten,i.dvt";
            return get_data_mmyy(sql, tu, den, false);
        }

        public DataSet getinnauan2(string tu, string den, string cont)
        {
            string usr = user;
            sql = "select to_char(b.ngay,'dd/mm/yyyy') as ngay,";
            sql += "l.ten as loaithucpham,i.ten as tenthucpham,i.dvt,sum(h.soluong) as soluong";
            sql += " from xxx.di_duyet a inner join xxx.di_thucdonll b on a.id=b.idduyet ";
            sql += " inner join xxx.di_thucdonct c on b.id=c.id ";
            sql += " left join " + usr + ".di_dmthucdon e on c.idthucdon=e.id ";
            sql += " left join " + usr + ".di_dmthucdontp h on e.id=h.idthucdonct";
            sql += " left join " + usr + ".di_dmthucpham i on h.idthucpham=i.id ";
            sql += " left join " + usr + ".di_dmloaitp l on i.idloai=l.id";
            sql += cont;
            sql += " group by to_char(b.ngay,'dd/mm/yyyy'),l.ten,i.ten,i.dvt";
            return get_data_mmyy(sql, tu, den, false);
        }

        public int get_duyetnhaan(string mmyy, decimal id)
        {
            try
            {
                ds = get_data("select done from " + user + mmyy + ".di_duyet where id=" + id);
                if (ds.Tables[0].Rows.Count == 0) return 0;
                else return int.Parse(ds.Tables[0].Rows[0][0].ToString());
            }
            catch { return 0; }
        }

        public void updrec_kthucdonll(DataTable dt, decimal id, string mabn, string hoten, decimal maql, decimal idkhoa,
            string ngayvv, int madoituong, int idcu, int moi, int dacbiet, string maicd, string chandoan, string giuong, string mabs, string yta)
        {
            string exp = "id=" + id;
            DataRow r = getrowbyid(dt, exp);
            if (r == null)
            {
                DataRow nrow = dt.NewRow();
                nrow["id"] = id;
                nrow["mabn"] = mabn;
                nrow["hoten"] = hoten;
                nrow["maql"] = maql;
                nrow["idkhoa"] = idkhoa;
                nrow["ngayvv"] = ngayvv;
                nrow["madoituong"] = madoituong;
                nrow["idcu"] = idcu;
                nrow["moi"] = moi;
                nrow["dacbiet"] = dacbiet;
                nrow["maicd"] = maicd;
                nrow["chandoan"] = chandoan;
                nrow["giuong"] = giuong;
                nrow["mabs"] = mabs;
                nrow["yta"] = yta;
                dt.Rows.Add(nrow);
            }
            else
            {
                DataRow[] dr = dt.Select(exp);
                dr[0]["mabn"] = mabn;
                dr[0]["hoten"] = hoten;
                dr[0]["maql"] = maql;
                dr[0]["idkhoa"] = idkhoa;
                dr[0]["ngayvv"] = ngayvv;
                dr[0]["madoituong"] = madoituong;
                dr[0]["idcu"] = idcu;
                dr[0]["moi"] = moi;
                dr[0]["dacbiet"] = dacbiet;
                dr[0]["maicd"] = maicd;
                dr[0]["chandoan"] = chandoan;
                dr[0]["giuong"] = giuong;
                dr[0]["mabs"] = mabs;
                dr[0]["yta"] = yta;
            }
        }

        public void updrec_kthucdonct(DataTable dt, int stt, int idgioan, int idthucdon, string gioan, string ma, string tenthucdon, decimal e, decimal p, decimal l, decimal g, int idchedoan, decimal soluong, decimal dongia, decimal sotien)
        {
            string exp = "stt=" + stt;
            DataRow r = getrowbyid(dt, exp);
            if (r == null)
            {
                DataRow nrow = dt.NewRow();
                nrow["stt"] = stt;
                nrow["idgioan"] = idgioan;
                nrow["idthucdon"] = idthucdon;
                nrow["gioan"] = gioan;
                nrow["ma"] = ma;
                nrow["tenthucdon"] = tenthucdon;
                nrow["e"] = e;
                nrow["p"] = p;
                nrow["l"] = l;
                nrow["g"] = g;
                nrow["idchedoan"] = idchedoan;
                nrow["soluong"] = soluong;
                nrow["dongia"] = dongia;
                nrow["sotien"] = sotien;
                dt.Rows.Add(nrow);
            }
            else
            {
                DataRow[] dr = dt.Select(exp);
                dr[0]["idgioan"] = idgioan;
                dr[0]["idthucdon"] = idthucdon;
                dr[0]["gioan"] = gioan;
                dr[0]["ma"] = ma;
                dr[0]["tenthucdon"] = tenthucdon;
                dr[0]["e"] = e;
                dr[0]["p"] = p;
                dr[0]["l"] = l;
                dr[0]["g"] = g;
                dr[0]["idchedoan"] = idchedoan;
                dr[0]["soluong"] = soluong;
                dr[0]["dongia"] = dongia;
                dr[0]["sotien"] = sotien;
            }
        }
        public decimal get_cholai(string d_tu, string d_den, string d_mabn, int d_phieu, string d_table)
        {
            decimal ret = 0;
            ds = get_data_mmyy("select a.id,to_char(b.ngay,'yyyymmdd') as ngay from xxx." + d_table + " a,xxx.di_duyet b where a.idduyet=b.id and b.phieu=" + d_phieu + " and a.mabn='" + d_mabn + "'", d_tu, d_den, false);
            if (ds.Tables[0].Rows.Count > 0)
                foreach (DataRow r in ds.Tables[0].Select("true", "ngay desc"))
                {
                    ret = decimal.Parse(r["id"].ToString());
                    break;
                }
            return ret;
        }

        public DataTable getdmthucdon(string ngay)
        {
            string usr = user;
            string stime = "'" + f_ngay + "'";
            sql = "select to_char(ngay,'dd/mm/yyyy') as ngay,to_char(ngay,'yyyymmdd') as yyyymmdd from " + usr + ".di_dmtdngay ";
            sql += " where " + for_ngay("ngay", stime) + "<= to_date('" + ngay + "'," + stime + ")";
            sql += " order by yyyymmdd desc";
            DataTable tmp = get_data(sql).Tables[0];
            if (tmp.Rows.Count > 0)
            {
                ngay = tmp.Rows[0]["ngay"].ToString();
                sql = "select a.id,a.idgioan,a.ma,a.ten,c.ten as chedoan,d.dongia,a.stt,a.idchedoan,";
                sql += "a.e,a.p,a.l,a.g";
                sql += " from " + usr + ".di_dmthucdon a," + usr + ".di_dmchedoan c," + usr + ".di_dmtdngay d";
                sql += " where a.id=d.id and a.idchedoan=c.id and to_char(d.ngay,'dd/mm/yyyy')='" + ngay + "' order by a.stt";
            }
            else
            {
                sql = "select a.id,a.idgioan,a.ma,a.ten,c.ten as chedoan,a.dongia,a.stt,a.idchedoan,";
                sql += "a.e,a.p,a.l,a.g";
                sql += " from " + usr + ".di_dmthucdon a," + usr + ".di_dmchedoan c";
                sql += " where a.idchedoan=c.id and a.benhly=0 order by a.stt";
            }
            return get_data(sql).Tables[0];
        }

        private void sumeplg(DataTable dt)
        {
            _e = 0; _p = 0; _l = 0; _g = 0;
            foreach (DataRow r in dt.Select("soluong>0"))
            {
                _e += decimal.Parse(r["e"].ToString());
                _p += decimal.Parse(r["p"].ToString());
                _l += decimal.Parse(r["l"].ToString());
                _g += decimal.Parse(r["g"].ToString());
            }
        }
        public DataTable getsoluong(DataTable dt, decimal e, decimal p, decimal l, decimal g)
        {
            decimal pg = e * p / 100 / 4, lg = e * l / 100 / 9, gg = e * g / 100 / 4;
            decimal sl = 0, x = 0, p1, l1, g1;
            foreach (DataRow r in dt.Select("soluong=0", "g desc,p desc ,l desc ,stt"))
            {
                sumeplg(dt);
                g = decimal.Parse(r["g"].ToString());
                sl = decimal.Parse(r["sl"].ToString());
                l = decimal.Parse(r["l"].ToString());
                p = decimal.Parse(r["p"].ToString());
                if (g > 0)
                {
                    g1 = gg - _g;
                    if (g1 > 0)
                    {
                        x = g1 * sl / g;
                        r["soluong"] = x;
                        r["p"] = x / sl * p;
                        r["l"] = x / sl * l;
                        r["g"] = g1;
                        r["e"] = decimal.Parse(r["p"].ToString()) * 4 + decimal.Parse(r["l"].ToString()) * 9 + decimal.Parse(r["g"].ToString()) * 4;
                        r["tt"] = 1;
                    }
                }
                else if (p > 0)
                {
                    p1 = pg - _p;
                    if (p1 > 0)
                    {
                        x = p1 * sl / p;
                        l1 = x / sl * l;
                        r["soluong"] = x;
                        r["p"] = p1;
                        r["l"] = l1;
                        r["e"] = decimal.Parse(r["p"].ToString()) * 4 + decimal.Parse(r["l"].ToString()) * 9 + decimal.Parse(r["g"].ToString()) * 4;
                        r["tt"] = 1;
                    }
                }
                else if (l > 0)
                {
                    l1 = lg - _l;
                    x = l1 / sl;
                    r["l"] = l1;
                    r["soluong"] = x;
                    r["e"] = decimal.Parse(r["p"].ToString()) * 4 + decimal.Parse(r["l"].ToString()) * 9 + decimal.Parse(r["g"].ToString()) * 4;
                    r["tt"] = 1;
                }
            }
            return dt;
        }
        #endregion

        public bool upd_stttiepdon(int m_id, string m_ngay, decimal m_stt)
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }

            con = new NpgsqlConnection(sConn);
            con.Open();
            string sql = "update " + user + mmyy(m_ngay) + ".stttiepdon set stt=" + m_stt + " where id=" + m_id + " and to_char(ngay,'dd/mm/yyyy')='" + m_ngay + "'";
            cmd = new NpgsqlCommand(sql, con);
            try
            {
                if (cmd.ExecuteNonQuery() == 0)
                {
                    sql = "insert into " + user + mmyy(m_ngay) + ".stttiepdon(id,ngay,stt)";
                    sql += " values(" + m_id + ",to_timestamp('" + m_ngay + "','dd/mm/yyyy')," + m_stt + ")";
                    cmd.CommandText = sql;
                    cmd.ExecuteNonQuery();
                }
            }
            catch (Exception ex) { upd_error(m_ngay, ex.Message, sComputer, "stttiepdon"); return false; }
            finally { cmd.Dispose(); con.Close(); con.Dispose(); }
            return true;
        }
        public bool upd_sttkham(string m_makp, string m_ngay, decimal m_stt)
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }

            con = new NpgsqlConnection(sConn);
            con.Open();
            string sql = "update " + user + mmyy(m_ngay) + ".sttkham set stt=" + m_stt + " where makp='" + m_makp + "' and to_char(ngay,'dd/mm/yyyy')='" + m_ngay + "'";
            cmd = new NpgsqlCommand(sql, con);
            try
            {
                if (cmd.ExecuteNonQuery() == 0)
                {
                    sql = "insert into " + user + mmyy(m_ngay) + ".sttkham(makp,ngay,stt)";
                    sql += " values('" + m_makp + "',to_timestamp('" + m_ngay + "','dd/mm/yyyy')," + m_stt + ")";
                    cmd.CommandText = sql;
                    cmd.ExecuteNonQuery();
                }
            }
            catch (Exception ex) { upd_error(m_ngay, ex.Message, sComputer, "sttkham"); return false; }
            finally { cmd.Dispose(); con.Close(); con.Dispose(); }
            return true;
        }

        private void Play(string num)
        {
            ArrayList m_afile = new ArrayList();
            char num0 = '0', num1 = '0', num2 = '0', num3 = '0';
            //linh
            string[] so ={ "0", "1", "2", "3", "4", "5", "6", "7", "8", "9" };
            //num = num.TrimStart("0".ToCharArray());
            //end
            bool bChucngantram = bDocchucngantram;
            m_afile.Clear();
           // int delay = delay5;
            if (num.Length == 4) { num0 = num[0]; num1 = num[1]; num2 = num[2]; num3 = num[3]; }
            if (num.Length == 3) { num0 = '0'; num1 = num[0]; num2 = num[1]; num3 = num[2]; }
            if (num.Length == 2) { num0 = '0'; num1 = '0'; num2 = num[0]; num3 = num[1]; }
            if (num.Length == 1) { num0 = '0'; num1 = '0'; num2 = '0'; num3 = num[0]; }

            if (!bChucngantram)
            {
                for (int i = 0; i < num.Length; i++)
                {
                    m_afile.Add("..//..//..//data//num//s" + so[int.Parse(num[i].ToString())] + ".wav");
                }
                //if (num.Length == 4) m_afile.Add("..//..//..//data//num//s" + num0.ToString() + ".wav");
                //if (num.Length >= 3) m_afile.Add("..//..//..//data//num//s" + num1.ToString() + ".wav");
                //if (num.Length >= 2) m_afile.Add("..//..//..//data//num//s" + num2.ToString() + ".wav");
                //if (num.Length >= 1) m_afile.Add("..//..//..//data//num//s" + num3.ToString() + ".wav");
            }
            //end linh
            else
            {
                if (num.Length == 4)
                {
                    m_afile.Add("..//..//..//data//num//s" + num0.ToString() + ".wav");
                    m_afile.Add("..//..//..//data//num//sg.wav");
                }
                if (num.Length >= 3)
                {
                    if (num1 != '0' || num2 != '0' || num3 != '0')
                    {
                        m_afile.Add("..//..//..//data//num//s" + num1.ToString() + ".wav");
                        m_afile.Add("..//..//..//data//num//sa.wav");
                    }
                }
                if (num.Length >= 2)
                {
                    if (num2 != '0')
                    {
                        if (num2 == '1')
                        {
                            m_afile.Add("..//..//..//data//num//sb.wav");
                        }
                        else
                        {
                            m_afile.Add("..//..//..//data//num//s" + num2.ToString() + ".wav");
                            m_afile.Add("..//..//..//data//num//sc.wav");
                        }
                    }
                    else
                    {
                        if (num3 != '0')
                        {
                            m_afile.Add("..//..//..//data//num//sf.wav");
                        }
                    }
                }
                if (num.Length >= 1)
                {
                    if (num3 != '0')
                    {
                        if (num3 == '1' && num2 > '1')
                        {
                            m_afile.Add("..//..//..//data//num//sd.wav");
                        }
                        else if (num3 == '5' && num2 != '0')
                        {
                            m_afile.Add("..//..//..//data//num//se.wav");
                        }
                        else
                        {
                            m_afile.Add("..//..//..//data//num//s" + num3.ToString() + ".wav");
                        }
                    }
                }
            }
            if (m_afile.Count > 0)
            {
                foreach (string t in m_afile.ToArray())
                {
                    //System.Threading.Thread.Sleep(delay);
                    PlaySound(t, IntPtr.Zero, SoundFlags.SND_FILENAME | SoundFlags.SND_NOWAIT);
                }
            }
        }

        [DllImport("winmm.dll", SetLastError = true, CallingConvention = CallingConvention.Winapi)]
        static extern bool PlaySound(string pszSound,
            IntPtr hMod, SoundFlags sf);
         [Flags]
        public enum SoundFlags : int
        {
            SND_SYNC = 0x0000,  /* play synchronously (default) */
            SND_ASYNC = 0x0001,  /* play asynchronously */
            SND_NODEFAULT = 0x0002,  /* silence (!default) if sound not found */
            SND_MEMORY = 0x0004,  /* pszSound points to a memory file */
            SND_LOOP = 0x0008,  /* loop the sound until next sndPlaySound */
            SND_NOSTOP = 0x0010,  /* don't stop any currently playing sound */
            SND_NOWAIT = 0x00002000, /* don't wait if the driver is busy */
            SND_ALIAS = 0x00010000, /* name is a registry alias */
            SND_ALIAS_ID = 0x00110000, /* alias is a predefined ID */
            SND_FILENAME = 0x00020000, /* name is file name */
            SND_RESOURCE = 0x00040004  /* name is resource name or atom */
        }

 ////PlaySound(@t, IntPtr.Zero,
                   //SoundFlags.SND_FILENAME | SoundFlags.SND_NOWAIT);
        public void goi_dangky(string ngay, int id, string s1, string s2, bool update)
        {
            //int d1 = delay1, d2 = delay2, d3 = delay3, d4 = delay4,d5=delay5;
            if (s1 == s2)
            {
                PlaySound("..//..//..//data//lyric//m4.wav", IntPtr.Zero, SoundFlags.SND_FILENAME | SoundFlags.SND_NOWAIT);
                //System.Threading.Thread.Sleep(d2);
                Play(s1);
                //System.Threading.Thread.Sleep(d4);
                PlaySound("..//..//..//data//lyric//m3.wav", IntPtr.Zero, SoundFlags.SND_FILENAME | SoundFlags.SND_NOWAIT);
            }
            else
            {
                PlaySound("..//..//..//data//lyric//m1.wav", IntPtr.Zero, SoundFlags.SND_FILENAME | SoundFlags.SND_NOWAIT);
                //System.Threading.Thread.Sleep(d1);
                Play(s1);
                //System.Threading.Thread.Sleep(d2);
                PlaySound("..//..//..//data//lyric//m2.wav", IntPtr.Zero, SoundFlags.SND_FILENAME | SoundFlags.SND_NOWAIT);
               // System.Threading.Thread.Sleep(d3);
                Play(s2);
                //System.Threading.Thread.Sleep(d4);
                PlaySound("..//..//..//data//lyric//m3.wav", IntPtr.Zero, SoundFlags.SND_FILENAME | SoundFlags.SND_NOWAIT);
            }
            if (update) upd_stttiepdon(id, ngay, decimal.Parse(s2));
        }

        public void goi_kham(string ngay, string makp, string s1, string s2, bool update)
        {
            int d1 = delay1_pk, d2 = delay2_pk, d3 = delay3_pk, d4 = delay4_pk, d6 = delay6_pk;
            if (s1 == s2)
            {
                PlaySound("..//..//..//data//lyric//m4.wav", IntPtr.Zero, SoundFlags.SND_FILENAME | SoundFlags.SND_NOWAIT);
                //System.Threading.Thread.Sleep(d2);
                Play(s1);
                //System.Threading.Thread.Sleep(d4);
                PlaySound("..//..//..//data//lyric//m5.wav", IntPtr.Zero, SoundFlags.SND_FILENAME | SoundFlags.SND_NOWAIT);
                if (System.IO.File.Exists("..//..//..//data//pk//" + makp + ".wav"))
                {
                    //System.Threading.Thread.Sleep(d6);
                    PlaySound("..//..//..//data//pk//" + makp + ".wav", IntPtr.Zero, SoundFlags.SND_FILENAME | SoundFlags.SND_NOWAIT);
                }
            }
            else
            {
                PlaySound("..//..//..//data//lyric//m1.wav", IntPtr.Zero, SoundFlags.SND_FILENAME | SoundFlags.SND_NOWAIT);
                //System.Threading.Thread.Sleep(d1);
                Play(s1);
                //System.Threading.Thread.Sleep(d2);
                PlaySound("..//..//..//data//lyric//m2.wav", IntPtr.Zero, SoundFlags.SND_FILENAME | SoundFlags.SND_NOWAIT);
                //System.Threading.Thread.Sleep(d3);
                Play(s2);
                //System.Threading.Thread.Sleep(d4);
                PlaySound("..//..//..//data//lyric//m5.wav", IntPtr.Zero, SoundFlags.SND_FILENAME | SoundFlags.SND_NOWAIT);
                if (System.IO.File.Exists("..//..//..//data//pk//" + makp + ".wav"))
                {
                    //System.Threading.Thread.Sleep(d6);
                    PlaySound("..//..//..//data//pk//" + makp + ".wav", IntPtr.Zero, SoundFlags.SND_FILENAME | SoundFlags.SND_NOWAIT);
                }
            }
            if (update) upd_sttkham(makp, ngay, decimal.Parse(s2));
        }
        public decimal goidangky(string ngay, int id)
        {
            string _mmyy = mmyy(ngay);
            if (!bMmyy(_mmyy)) return 0;
            DataTable tmp = get_data("select stt from " + user + _mmyy + ".stttiepdon where to_char(ngay,'dd/mm/yyyy')='" + ngay + "' and id=" + id).Tables[0];
            if (tmp.Rows.Count > 0) return decimal.Parse(tmp.Rows[0]["stt"].ToString());
            else return 0;
        }
        public decimal goikham(string ngay, string makp)
        {
            DataTable tmp = get_data("select stt from " + user + mmyy(ngay) + ".sttkham where to_char(ngay,'dd/mm/yyyy')='" + ngay + "' and makp='" + makp + "'").Tables[0];
            if (tmp.Rows.Count > 0) return decimal.Parse(tmp.Rows[0]["stt"].ToString());
            else return 0;
        }

        public bool upd_trieuchungl(int m_id, int m_stt, string m_ten, int m_userid)
        {
            sql = "update " + user + ".trieuchungl set stt=:m_stt,ten=:m_ten,userid=:m_userid where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".trieuchungl (id,stt,ten,userid) values (:m_id,:m_stt,:m_ten,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "trieuchungl");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_trieuchungct(int m_id, int m_idloai, int m_stt, string m_ten, int m_userid)
        {
            sql = "update " + user + ".trieuchungct set idloai=:m_idloai,stt=:m_stt,ten=:m_ten,userid=:m_userid where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_idloai", NpgsqlDbType.Numeric).Value = m_idloai;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".trieuchungct (id,idloai,stt,ten,userid) values (:m_id,:m_idloai,:m_stt,:m_ten,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_idloai", NpgsqlDbType.Numeric).Value = m_idloai;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "trieuchungct");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public int getRandom()
        {
            System.Threading.Thread.Sleep(10);
            Random r = new Random();
            return r.Next(999);
        }

        public string getyymmddhhmiss()
        {
            return get_data("select to_char(now(),'yymmddhh24miss')").Tables[0].Rows[0][0].ToString();
        }

        public decimal getidyymmddhhmiss_stt_computer
        {
            get
            {
                //kieu du lieu: 'decimal' chi cho phep dai toi da 19 ky tu so
                return decimal.Parse(getyymmddhhmiss() + getRandom().ToString().PadLeft(3, '0') + iRownum.ToString().PadLeft(3, '0'));
            }
        }

        public decimal getidyymmddhhmiss_stt_computer_khudt(int i_khudt)
        {
            if (i_khudt == 0)
            {
                //kieu decimal cho phep lon hon kieu 'decimal' --> luu tru hon 20 ky tu so
                return decimal.Parse(getyymmddhhmiss() + getRandom().ToString().PadLeft(3, '0') + iRownum.ToString().PadLeft(3, '0'));
            }
            else
            {
                return decimal.Parse(getyymmddhhmiss() + getRandom().ToString().PadLeft(3, '0') + iRownum.ToString().PadLeft(3, '0') + i_khudt.ToString().PadLeft(1, '0'));
            }
        }

        public string getPathTemp
        {
            get
            {
                return System.IO.Path.GetTempPath();
            }
        }

        public void delFileTemp()
        {
            string[] files = System.IO.Directory.GetFiles(getPathTemp);
            for (int i = 0; i < files.GetLength(0); i++)
            {
                if (files[i].ToString().ToLower().IndexOf(".rpt") != -1 || files[i].ToString().ToLower().IndexOf(".tmp") != -1)
                {
                    try
                    {
                        System.IO.File.Delete(files[i].ToString());
                    }
                    catch { }
                }
            }
        }

        public string get_maql_ngoaitru(string ngayvao, string ngayra, decimal mavaovien)
        {
            string s = "";
            //if (bMmyy(ngay))
            //{
            //tai kham
            DataSet lds = get_data_mmyy("select maql from xxx.benhanpk where (mangtr=" + mavaovien + " or mavaovien=" + mavaovien + ")", ngayvao.Substring(0, 10), ngayra.Substring(0, 10), true);
            if (lds != null && lds.Tables.Count > 0)
            {
                foreach (DataRow r in lds.Tables[0].Rows)
                    s += r["maql"].ToString() + ",";
            }
            //ngoai tru kham lan dau
            foreach (DataRow r in get_data("select maql from " + user + ".benhanngtr where mavaovien=" + mavaovien).Tables[0].Rows)
                s += r["maql"].ToString() + ",";
            //
            lds = get_data_mmyy("select maql from xxx.tiepdon where mavaovien=" + mavaovien, ngayvao.Substring(0, 10), ngayra.Substring(0, 10), true);
            if (lds != null && lds.Tables.Count > 0)
            {
                foreach (DataRow r in lds.Tables[0].Rows)
                    s += r["maql"].ToString() + ",";
            }

            //}
            return s;
        }
        public string get_maql_Capve_noitru(string ngay, decimal mavaovien)
        {
            string s = "";
            if (bMmyy(ngay) && (bCapve_noitru || bChiphikp_noingoai))
            {
                if (bChiphikp_noingoai_khongbhyt)//chi tinh BN BHYT, mien: co check G54.1
                {
                    sql = "select maql from " + user + mmyy(ngay) + ".benhanpk a, " + user + ".doituong b where a.madoituong=b.madoituong and a.mavaovien=" + mavaovien + " and a.mangtr=0 and b.mien!=0 ";
                    sql += " union all ";
                    sql += "select maql from " + user + mmyy(ngay) + ".tiepdon a, " + user + ".doituong b where a.madoituong=b.madoituong and a.mavaovien=" + mavaovien + " and b.mien!=0 ";
                }
                else
                {
                    sql = "select maql from " + user + mmyy(ngay) + ".benhanpk where mavaovien=" + mavaovien + " and mangtr=0";
                    sql += " union all ";
                    sql += "select maql from " + user + mmyy(ngay) + ".tiepdon where mavaovien=" + mavaovien;
                }
                foreach (DataRow r in get_data(sql).Tables[0].Rows)
                    s += r["maql"].ToString() + ",";
            }
            return s;
        }
        public string get_maql_Capcuu_noitru(string ngay, decimal mavaovien)
        {
            string s = "";
            if (bMmyy(ngay) && bCapcuu_noitru)
            {
                DataTable dt = get_data_mmyy("select maql from xxx.benhancc where mavaovien=" + mavaovien, ngay.Substring(0, 10), ngay.Substring(0, 10), true).Tables[0];
                foreach (DataRow r in dt.Rows)
                    s += r["maql"].ToString() + ",";
            }
            return s;
        }

        public string get_ngay_Capcuu_noitru(string ngay, decimal mavaovien)
        {
            string s = ngay;
            if (bMmyy(ngay) && bCapcuu_noitru)
            {
                DataTable dt = get_data_mmyy("select to_char(ngay,'dd/mm/yyyy hh24:mi') as ngay from xxx.benhancc where mavaovien=" + mavaovien, ngay.Substring(0, 10), ngay.Substring(0, 10), true).Tables[0];
                foreach (DataRow r in dt.Rows)
                    s = r["ngay"].ToString();
            }
            return s;
        }
        public string get_ngay_Capcuu_noitru(string ngay, decimal maql, int loaiba)
        {
            string s = ngay;
            if (bMmyy(ngay) && bCapcuu_noitru && loaiba == 1)
            {
                DataTable dt = get_data_mmyy("select to_char(ngay,'dd/mm/yyyy hh24:mi') as ngay from xxx.benhancc where mavaovien in(select mavaovien from " + user + ".benhandt where maql=" + maql + ")", ngay.Substring(0, 10), ngay.Substring(0, 10), true).Tables[0];
                foreach (DataRow r in dt.Rows)
                    s = r["ngay"].ToString();
            }
            return s;
        }
        public string get_tamung(string mabn, decimal mavaovien, string ngay, int madoituong)
        {
            string _mmyy = mmyy(ngay), xxx = user + _mmyy, sql, s = " ";
            decimal st = 0;
            if (bMmyy(_mmyy))
            {
                sql = "select c.sohieu,a.sobienlai,b.hoten,sum(a.sotien) as sotien from " + xxx + ".v_tamung a," + user + ".v_dlogin b," + user + ".v_quyenso c";
                sql += " where a.userid=b.id and a.quyenso=c.id and a.mabn='" + mabn + "'";
                sql += " and to_char(a.ngay,'dd/mm/yyyy')='" + ngay + "' and a.loaibn in (0,3) and a.done=0";//3,4
                if (madoituong != 0) sql += " and a.madoituong=" + madoituong;
                if (mavaovien != 0) sql += " and mavaovien=" + mavaovien;
                sql += " group by c.sohieu,a.sobienlai,b.hoten";
                foreach (DataRow r in get_data(sql).Tables[0].Rows)
                {
                    s += r["sohieu"].ToString().Trim() + "-" + r["sobienlai"].ToString().Trim() + " Người thu :" + r["hoten"].ToString().Trim() + ";";
                    st += decimal.Parse(r["sotien"].ToString());
                }
            }
            return st.ToString() + "^" + s;
        }
        public string get_tamung(string mabn, decimal mavaovien, string ngay, int madoituong, int i_songay)
        {
            string _mmyy = mmyy(ngay), xxx = user + _mmyy, sql, s = " ";
            decimal st = 0;
            string s_tu = DateToString("dd/MM/yyyy", StringToDate(ngay).AddDays(-1 * i_songay));
            string s_den = ngay;
            if (bMmyy(_mmyy))
            {
                sql = "select c.sohieu,a.sobienlai,b.hoten,sum(a.sotien) as sotien from xxx.v_tamung a," + user + ".v_dlogin b," + user + ".v_quyenso c";
                sql += " where a.userid=b.id and a.quyenso=c.id and a.mabn='" + mabn + "'";
                sql += "  and a.loaibn in (0,3) and a.done=0";//3,4
                if (i_songay <= 0) sql += " and to_char(a.ngay,'dd/mm/yyyy')='" + ngay + "'";
                else sql += " and to_date(to_char(a.ngay,'dd/mm/yyyy'),'dd/mm/yyyy') between to_date('" + s_tu + "','dd/mm/yyyy') and to_date('" + s_den + "','dd/mm/yyyy')";
                if (madoituong != 0) sql += " and a.madoituong=" + madoituong;
                if (mavaovien != 0) sql += " and (mavaovien=" + mavaovien + " or mavaovien=0 )";
                sql += " group by c.sohieu,a.sobienlai,b.hoten";
                foreach (DataRow r in get_data_mmyy(sql, ngay, ngay, true).Tables[0].Rows)
                {
                    s += r["sohieu"].ToString().Trim() + "-" + r["sobienlai"].ToString().Trim() + " Người thu :" + r["hoten"].ToString().Trim() + ";";
                    st += decimal.Parse(r["sotien"].ToString());
                }
            }
            return st.ToString() + "^" + s;
        }
        public DataSet getTaikham(string mabn, decimal mangtr, decimal maql, string tu, string den)
        {
            sql = "select to_char(ngay,'dd/mm/yyyy hh24:mi') as ngay from xxx.benhanpk where mabn='" + mabn + "' and mangtr=" + mangtr + " and maql<>" + maql + " order by ngay";
            return get_data_mmyy(sql, tu, den, false);
        }

        public bool upd_sokhamthai(string m_ngay, string m_mabn, decimal m_mavaovien, decimal m_cao, string m_para, string m_dacdiem, decimal m_chuky,
            int m_tinhchat, int m_luongkinh, decimal m_songay, string m_vat1, string m_vat2, string m_tiensu, string m_ngaykc, string m_ngaydd, int m_userid)
        {
            sql = "update " + user + mmyy(m_ngay) + ".sokhamthai set mabn=:m_mabn,cao=:m_cao,para=:m_para,dacdiem=:m_dacdiem,";
            sql += "chuky=:m_chuky,tinhchat=:m_tinhchat,luongkinh=:m_luongkinh,songay=:m_songay,vat1=:m_vat1,vat2=:m_vat2,";
            sql += "tiensu=:m_tiensu,";
            if (m_ngaykc != "") sql += "ngaykc=to_timestamp(:m_ngaykc,'dd/mm/yyyy'),";
            if (m_ngaydd != "") sql += "ngaydd=to_timestamp(:m_ngaydd,'dd/mm/yyyy'),";
            sql += " userid=:m_userid ";
            sql += " where mavaovien=:m_mavaovien";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Text).Value = m_mabn;
                cmd.Parameters.Add("m_cao", NpgsqlDbType.Numeric).Value = m_cao;
                cmd.Parameters.Add("m_para", NpgsqlDbType.Varchar, 8).Value = m_para;
                cmd.Parameters.Add("m_dacdiem", NpgsqlDbType.Text).Value = m_dacdiem;
                cmd.Parameters.Add("m_chuky", NpgsqlDbType.Numeric).Value = m_chuky;
                cmd.Parameters.Add("m_tinhchat", NpgsqlDbType.Numeric).Value = m_tinhchat;
                cmd.Parameters.Add("m_luongkinh", NpgsqlDbType.Numeric).Value = m_luongkinh;
                cmd.Parameters.Add("m_songay", NpgsqlDbType.Numeric).Value = m_songay;
                cmd.Parameters.Add("m_vat1", NpgsqlDbType.Text).Value = m_vat1;
                cmd.Parameters.Add("m_vat2", NpgsqlDbType.Text).Value = m_vat2;
                cmd.Parameters.Add("m_tiensu", NpgsqlDbType.Text).Value = m_tiensu;
                if (m_ngaykc != "") cmd.Parameters.Add("m_ngaykc", NpgsqlDbType.Text).Value = m_ngaykc;
                if (m_ngaydd != "") cmd.Parameters.Add("m_ngaydd", NpgsqlDbType.Text).Value = m_ngaydd;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + mmyy(m_ngay) + ".sokhamthai(mabn,mavaovien,cao,para,dacdiem,chuky,tinhchat,";
                    sql += "luongkinh,songay,vat1,vat2,tiensu,";
                    if (m_ngaykc != "") sql += "ngaykc,";
                    if (m_ngaydd != "") sql += "ngaydd,";
                    sql += "userid) values ";
                    sql += "(:m_mabn,:m_mavaovien,:m_cao,:m_para,:m_dacdiem,:m_chuky,:m_tinhchat,";
                    sql += ":m_luongkinh,:m_songay,:m_vat1,:m_vat2,:m_tiensu,";
                    if (m_ngaykc != "") sql += "to_timestamp(:m_ngaykc,'dd/mm/yyyy'),";
                    if (m_ngaydd != "") sql += "to_timestamp(:m_ngaydd,'dd/mm/yyyy'),";
                    sql += ":m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Text).Value = m_mabn;
                    cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                    cmd.Parameters.Add("m_cao", NpgsqlDbType.Numeric).Value = m_cao;
                    cmd.Parameters.Add("m_para", NpgsqlDbType.Varchar, 8).Value = m_para;
                    cmd.Parameters.Add("m_dacdiem", NpgsqlDbType.Text).Value = m_dacdiem;
                    cmd.Parameters.Add("m_chuky", NpgsqlDbType.Numeric).Value = m_chuky;
                    cmd.Parameters.Add("m_tinhchat", NpgsqlDbType.Numeric).Value = m_tinhchat;
                    cmd.Parameters.Add("m_luongkinh", NpgsqlDbType.Numeric).Value = m_luongkinh;
                    cmd.Parameters.Add("m_songay", NpgsqlDbType.Numeric).Value = m_songay;
                    cmd.Parameters.Add("m_vat1", NpgsqlDbType.Text).Value = m_vat1;
                    cmd.Parameters.Add("m_vat2", NpgsqlDbType.Text).Value = m_vat2;
                    cmd.Parameters.Add("m_tiensu", NpgsqlDbType.Text).Value = m_tiensu;
                    if (m_ngaykc != "") cmd.Parameters.Add("m_ngaykc", NpgsqlDbType.Text).Value = m_ngaykc;
                    if (m_ngaydd != "") cmd.Parameters.Add("m_ngaydd", NpgsqlDbType.Text).Value = m_ngaydd;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message, sComputer, "sokhamthai");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_sokhamthaict(string m_ngaykham, decimal m_mavaovien, decimal m_maql, string m_ngay, decimal m_cannang, string m_huyetap,
            decimal m_mach, int m_phu, string m_bctc, string m_timthai, int m_ngoi, string m_ketluan)
        {
            sql = "update " + user + mmyy(m_ngaykham) + ".sokhamthaict set mavaovien=:m_mavaovien,ngay=to_timestamp(:m_ngay,'dd/mm/yyyy hh24:mi'),";
            sql += "cannang=:m_cannang,huyetap=:m_huyetap,mach=:m_mach,phu=:m_phu,bctc=:m_bctc,timthai=:m_timthai,ngoi=:m_ngoi,";
            sql += "ketluan=:m_ketluan where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                cmd.Parameters.Add("m_cannang", NpgsqlDbType.Numeric).Value = m_cannang;
                cmd.Parameters.Add("m_huyetap", NpgsqlDbType.Varchar, 7).Value = m_huyetap;
                cmd.Parameters.Add("m_mach", NpgsqlDbType.Numeric).Value = m_mach;
                cmd.Parameters.Add("m_phu", NpgsqlDbType.Numeric).Value = m_phu;
                cmd.Parameters.Add("m_bctc", NpgsqlDbType.Text).Value = m_bctc;
                cmd.Parameters.Add("m_timthai", NpgsqlDbType.Text).Value = m_timthai;
                cmd.Parameters.Add("m_ngoi", NpgsqlDbType.Numeric).Value = m_ngoi;
                cmd.Parameters.Add("m_ketluan", NpgsqlDbType.Text).Value = m_ketluan;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + mmyy(m_ngaykham) + ".sokhamthaict(maql,mavaovien,ngay,cannang,huyetap,mach,phu,bctc,timthai,ngoi,ketluan)";
                    sql += " values (:m_maql,:m_mavaovien,to_timestamp(:m_ngay,'dd/mm/yyyy hh24:mi'),:m_cannang,:m_huyetap,:m_mach,:m_phu,:m_bctc,:m_timthai,:m_ngoi,:m_ketluan)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                    cmd.Parameters.Add("m_cannang", NpgsqlDbType.Numeric).Value = m_cannang;
                    cmd.Parameters.Add("m_huyetap", NpgsqlDbType.Varchar, 7).Value = m_huyetap;
                    cmd.Parameters.Add("m_mach", NpgsqlDbType.Numeric).Value = m_mach;
                    cmd.Parameters.Add("m_phu", NpgsqlDbType.Numeric).Value = m_phu;
                    cmd.Parameters.Add("m_bctc", NpgsqlDbType.Text).Value = m_bctc;
                    cmd.Parameters.Add("m_timthai", NpgsqlDbType.Text).Value = m_timthai;
                    cmd.Parameters.Add("m_ngoi", NpgsqlDbType.Numeric).Value = m_ngoi;
                    cmd.Parameters.Add("m_ketluan", NpgsqlDbType.Text).Value = m_ketluan;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngaykham, ex.Message, sComputer, "sokhamthaict");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_bbtuvong(string m_mabn, decimal m_maql, string m_ngay, string m_lydo, string m_benhsu, string m_chandoan, string m_ngoaichan, string m_lamsang, string m_sinhthiet, string m_dieutri, string m_dienbien, string m_tinhthan, string m_chetngay, string m_comat, string m_nguyennhan, string m_chandoant, string m_chandoangpb, string m_kiemdiem, string m_chutoa, string m_thuky, string m_khth, int m_userid)
        {
            sql = "update " + user + ".bbtuvong set ngay=to_timestamp(:m_ngay,'dd/mm/yyyy hh24:mi'),lydo=:m_lydo,benhsu=:m_benhsu,chandoan=:m_chandoan,ngoaichan=:m_ngoaichan,lamsang=:m_lamsang,sinhthiet=:m_sinhthiet,";
            sql += " dieutri=:m_dieutri,dienbien=:m_dienbien,tinhthan=:m_tinhthan,chetngay=to_timestamp(:m_chetngay,'dd/mm/yyyy hh24:mi'),comat=:m_comat,nguyennhan=:m_nguyennhan,";
            sql += " chandoant=:m_chandoant,chandoangpb=:m_chandoangpb,kiemdiem=:m_kiemdiem,chutoa=:m_chutoa,thuky=:m_thuky ,khth=:m_khth,userid=:m_userid";
            sql += " where mabn=:m_mabn and maql=:m_maql";

            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                cmd.Parameters.Add("m_lydo", NpgsqlDbType.Text).Value = m_lydo;
                cmd.Parameters.Add("m_benhsu", NpgsqlDbType.Text).Value = m_benhsu;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_ngoaichan", NpgsqlDbType.Text).Value = m_ngoaichan;
                cmd.Parameters.Add("m_lamsang", NpgsqlDbType.Text).Value = m_lamsang;
                cmd.Parameters.Add("m_sinhthiet", NpgsqlDbType.Text).Value = m_sinhthiet;
                cmd.Parameters.Add("m_dieutri", NpgsqlDbType.Text).Value = m_dieutri;
                cmd.Parameters.Add("m_dienbien", NpgsqlDbType.Text).Value = m_dienbien;
                cmd.Parameters.Add("m_tinhthan", NpgsqlDbType.Text).Value = m_tinhthan;
                cmd.Parameters.Add("m_chetngay", NpgsqlDbType.Varchar, 16).Value = m_chetngay;
                cmd.Parameters.Add("m_comat", NpgsqlDbType.Text).Value = m_comat;
                cmd.Parameters.Add("m_nguyennhan", NpgsqlDbType.Text).Value = m_nguyennhan;
                cmd.Parameters.Add("m_chandoant", NpgsqlDbType.Text).Value = m_chandoant;
                cmd.Parameters.Add("m_chandoangpb", NpgsqlDbType.Text).Value = m_chandoangpb;
                cmd.Parameters.Add("m_kiemdiem", NpgsqlDbType.Text).Value = m_kiemdiem;
                cmd.Parameters.Add("m_chutoa", NpgsqlDbType.Text).Value = m_chutoa;
                cmd.Parameters.Add("m_thuky", NpgsqlDbType.Text).Value = m_thuky;
                cmd.Parameters.Add("m_khth", NpgsqlDbType.Text).Value = m_khth;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".bbtuvong(mabn,maql,ngay,lydo,benhsu,chandoan,ngoaichan,lamsang,sinhthiet,dieutri,dienbien,tinhthan,chetngay,comat,nguyennhan,chandoant,chandoangpb,kiemdiem,chutoa,thuky,khth,userid,ngayud)";
                    sql += " values (:m_mabn,:m_maql,to_timestamp(:m_ngay,'dd/mm/yyyy hh24:mi'),:m_lydo,:m_benhsu,:m_chandoan,:m_ngoaichan,:m_lamsang,:m_sinhthiet,:m_dieutri,:m_dienbien,:m_tinhthan,to_timestamp(:m_chetngay,'dd/mm/yyyy hh24:mi'),:m_comat,:m_nguyennhan,:m_chandoant,:m_chandoangpb,:m_kiemdiem,:m_chutoa,:m_thuky,:m_khth,:m_userid,now())";

                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                    cmd.Parameters.Add("m_lydo", NpgsqlDbType.Text).Value = m_lydo;
                    cmd.Parameters.Add("m_benhsu", NpgsqlDbType.Text).Value = m_benhsu;
                    cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                    cmd.Parameters.Add("m_ngoaichan", NpgsqlDbType.Text).Value = m_ngoaichan;
                    cmd.Parameters.Add("m_lamsang", NpgsqlDbType.Text).Value = m_lamsang;
                    cmd.Parameters.Add("m_sinhthiet", NpgsqlDbType.Text).Value = m_sinhthiet;
                    cmd.Parameters.Add("m_dieutri", NpgsqlDbType.Text).Value = m_dieutri;
                    cmd.Parameters.Add("m_dienbien", NpgsqlDbType.Text).Value = m_dienbien;
                    cmd.Parameters.Add("m_tinhthan", NpgsqlDbType.Text).Value = m_tinhthan;
                    cmd.Parameters.Add("m_chetngay", NpgsqlDbType.Varchar, 16).Value = m_chetngay;
                    cmd.Parameters.Add("m_comat", NpgsqlDbType.Text).Value = m_comat;
                    cmd.Parameters.Add("m_nguyennhan", NpgsqlDbType.Text).Value = m_nguyennhan;
                    cmd.Parameters.Add("m_chandoant", NpgsqlDbType.Text).Value = m_chandoant;
                    cmd.Parameters.Add("m_chandoangpb", NpgsqlDbType.Text).Value = m_chandoangpb;
                    cmd.Parameters.Add("m_kiemdiem", NpgsqlDbType.Text).Value = m_kiemdiem;
                    cmd.Parameters.Add("m_chutoa", NpgsqlDbType.Varchar, 4).Value = m_chutoa;
                    cmd.Parameters.Add("m_thuky", NpgsqlDbType.Varchar, 4).Value = m_thuky;
                    cmd.Parameters.Add("m_khth", NpgsqlDbType.Varchar, 4).Value = m_khth;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "bbtuvong");
                return false;
            }
            finally
            {

                con.Close();
                con.Dispose();
            }
            return true;
        }
        public void upd_bbtuvongnv(decimal m_maql, int m_stt, string m_manv, string m_chucvu)
        {
            sql = "update " + user + ".bbtuvongnv set manv=:m_manv,chucvu=:m_chucvu where maql=:m_maql and stt=:m_stt";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                cmd.Parameters.Add("m_manv", NpgsqlDbType.Varchar, 4).Value = m_manv;
                cmd.Parameters.Add("m_chucvu", NpgsqlDbType.Text).Value = m_chucvu;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".bbtuvongnv(maql,stt,manv,chucvu)";
                    sql += " values (:m_maql,:m_stt,:m_manv,:m_chucvu)";

                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_manv", NpgsqlDbType.Varchar, 4).Value = m_manv;
                    cmd.Parameters.Add("m_chucvu", NpgsqlDbType.Text).Value = m_chucvu;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "bbtuvongvn");
            }
            finally
            {

                con.Close();
                con.Dispose();
            }
        }
        public void upd_tusat(string m_mabn, decimal m_mavaovien, decimal m_maql, string m_ngay, decimal m_nguyennhan, decimal m_hinhthuc, decimal m_tinhtrang, string m_ghichu, decimal m_userid)
        {
            sql = "update " + user + ".tusat set ngay=to_timestamp(:m_ngay,'dd/mm/yyyy hh24:mi'),nguyennhan=:m_nguyennhan,hinhthuc=:m_hinhthuc,tinhtrang=:m_tinhtrang,ghichu=:m_ghichu,userid=:m_userid where mabn=:m_mabn and mavaovien=:m_mavaovien and maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_nguyennhan", NpgsqlDbType.Numeric).Value = m_nguyennhan;
                cmd.Parameters.Add("m_hinhthuc", NpgsqlDbType.Numeric).Value = m_hinhthuc;
                cmd.Parameters.Add("m_tinhtrang", NpgsqlDbType.Numeric).Value = m_tinhtrang;
                cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text).Value = m_ghichu;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".tusat(mabn,mavaovien,maql,ngay,nguyennhan,hinhthuc,tinhtrang,ghichu,userid)";
                    sql += " values (:m_mabn,:m_mavaovien,:m_maql,to_timestamp(:m_ngay,'dd/mm/yyyy hh24:mi'),:m_nguyennhan,:m_hinhthuc,:m_tinhtrang,:m_ghichu,:m_userid)";

                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_nguyennhan", NpgsqlDbType.Numeric).Value = m_nguyennhan;
                    cmd.Parameters.Add("m_hinhthuc", NpgsqlDbType.Numeric).Value = m_hinhthuc;
                    cmd.Parameters.Add("m_tinhtrang", NpgsqlDbType.Numeric).Value = m_tinhtrang;
                    cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text).Value = m_ghichu;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "tusat");
            }
            finally
            {

                con.Close();
                con.Dispose();
            }
        }
        public bool upd_kskdoan(decimal id, string sohd, string ngay, int loai, string ma, string ten, string diachi,
            string dienthoai, string fax, string email, string masothue, string nguoilienhe, string ghichu, int userid)
        {
            sql = "update " + user + ".kskdoan set sohd=:sohd,ngay=to_timestamp(:ngay,'dd/mm/yyyy'),loai=:loai,";
            sql += "ma=:ma,ten=:ten,diachi=:diachi,dienthoai=:dienthoai,fax=:fax,email=:email,";
            sql += " masothue=:masothue,nguoilienhe=:nguoilienhe,ghichu=:ghichu,";
            sql += " userid=:userid where id=:id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("sohd", NpgsqlDbType.Varchar, 20).Value = sohd;
                cmd.Parameters.Add("ngay", NpgsqlDbType.Varchar, 10).Value = ngay;
                cmd.Parameters.Add("loai", NpgsqlDbType.Numeric).Value = loai;
                cmd.Parameters.Add("ma", NpgsqlDbType.Varchar, 3).Value = ma;
                cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                cmd.Parameters.Add("diachi", NpgsqlDbType.Text).Value = diachi;
                cmd.Parameters.Add("dienthoai", NpgsqlDbType.Varchar, 50).Value = dienthoai;
                cmd.Parameters.Add("fax", NpgsqlDbType.Varchar, 50).Value = fax;
                cmd.Parameters.Add("email", NpgsqlDbType.Text).Value = email;
                cmd.Parameters.Add("masothue", NpgsqlDbType.Varchar, 20).Value = masothue;
                cmd.Parameters.Add("nguoilienhe", NpgsqlDbType.Text).Value = nguoilienhe;
                cmd.Parameters.Add("ghichu", NpgsqlDbType.Text).Value = ghichu;
                cmd.Parameters.Add("userid", NpgsqlDbType.Numeric).Value = userid;
                cmd.Parameters.Add("id", NpgsqlDbType.Numeric).Value = id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".kskdoan (id,sohd,ngay,loai,ma,ten,diachi,dienthoai,fax,email,masothue,nguoilienhe,ghichu,userid) values (:id,:sohd,to_timestamp(:ngay,'dd/mm/yyyy'),:loai,:ma,:ten,:diachi,:dienthoai,:fax,:email,:masothue,:nguoilienhe,:ghichu,:userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("id", NpgsqlDbType.Numeric).Value = id;
                    cmd.Parameters.Add("sohd", NpgsqlDbType.Varchar, 20).Value = sohd;
                    cmd.Parameters.Add("ngay", NpgsqlDbType.Varchar, 10).Value = ngay;
                    cmd.Parameters.Add("loai", NpgsqlDbType.Numeric).Value = loai;
                    cmd.Parameters.Add("ma", NpgsqlDbType.Varchar, 3).Value = ma;
                    cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                    cmd.Parameters.Add("diachi", NpgsqlDbType.Text).Value = diachi;
                    cmd.Parameters.Add("dienthoai", NpgsqlDbType.Varchar, 50).Value = dienthoai;
                    cmd.Parameters.Add("fax", NpgsqlDbType.Varchar, 50).Value = fax;
                    cmd.Parameters.Add("email", NpgsqlDbType.Text).Value = email;
                    cmd.Parameters.Add("masothue", NpgsqlDbType.Varchar, 20).Value = masothue;
                    cmd.Parameters.Add("nguoilienhe", NpgsqlDbType.Text).Value = nguoilienhe;
                    cmd.Parameters.Add("ghichu", NpgsqlDbType.Text).Value = ghichu;
                    cmd.Parameters.Add("userid", NpgsqlDbType.Numeric).Value = userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "kskdoan");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_kskdonvi(decimal id, decimal iddoan, decimal stt, string ma, string ten, string tu, string den, int userid)
        {
            sql = "update " + user + ".kskdonvi set iddoan=:iddoan,stt=:stt,";
            sql += "ma=:ma,ten=:ten,tu=to_timestamp(:tu,'dd/mm/yyyy'),den=to_timestamp(:den,'dd/mm/yyyy'),userid=:userid";
            sql += " where id=:id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("iddoan", NpgsqlDbType.Numeric).Value = iddoan;
                cmd.Parameters.Add("stt", NpgsqlDbType.Numeric).Value = stt;
                cmd.Parameters.Add("ma", NpgsqlDbType.Varchar, 2).Value = ma;
                cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                cmd.Parameters.Add("tu", NpgsqlDbType.Varchar, 10).Value = tu;
                cmd.Parameters.Add("den", NpgsqlDbType.Varchar, 10).Value = den;
                cmd.Parameters.Add("userid", NpgsqlDbType.Numeric).Value = userid;
                cmd.Parameters.Add("id", NpgsqlDbType.Numeric).Value = id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".kskdonvi (id,iddoan,stt,ma,ten,tu,den,userid) values (:id,:iddoan,:stt,:ma,:ten,to_timestamp(:tu,'dd/mm/yyyy'),to_timestamp(:den,'dd/mm/yyyy'),:userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("id", NpgsqlDbType.Numeric).Value = id;
                    cmd.Parameters.Add("iddoan", NpgsqlDbType.Numeric).Value = iddoan;
                    cmd.Parameters.Add("stt", NpgsqlDbType.Numeric).Value = stt;
                    cmd.Parameters.Add("ma", NpgsqlDbType.Varchar, 2).Value = ma;
                    cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                    cmd.Parameters.Add("tu", NpgsqlDbType.Varchar, 10).Value = tu;
                    cmd.Parameters.Add("den", NpgsqlDbType.Varchar, 10).Value = den;
                    cmd.Parameters.Add("userid", NpgsqlDbType.Numeric).Value = userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "kskdonvi");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_kskmuc(decimal id, decimal iddoan, decimal stt, int phai, string tt, string namsinh, string ghichu)
        {
            sql = "update " + user + ".kskmuc set iddoan=:iddoan,stt=:stt,phai=:phai,tt=:tt,namsinh=:namsinh,ghichu=:ghichu where id=:id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("iddoan", NpgsqlDbType.Numeric).Value = iddoan;
                cmd.Parameters.Add("stt", NpgsqlDbType.Numeric).Value = stt;
                cmd.Parameters.Add("phai", NpgsqlDbType.Numeric).Value = phai;
                cmd.Parameters.Add("tt", NpgsqlDbType.Varchar, 2).Value = tt;
                cmd.Parameters.Add("namsinh", NpgsqlDbType.Varchar, 4).Value = namsinh;
                cmd.Parameters.Add("ghichu", NpgsqlDbType.Text).Value = ghichu;
                cmd.Parameters.Add("id", NpgsqlDbType.Numeric).Value = id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".kskmuc (id,iddoan,stt,phai,tt,namsinh,ghichu) values (:id,:iddoan,:stt,:phai,:tt,:namsinh,:ghichu)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("id", NpgsqlDbType.Numeric).Value = id;
                    cmd.Parameters.Add("iddoan", NpgsqlDbType.Numeric).Value = iddoan;
                    cmd.Parameters.Add("stt", NpgsqlDbType.Numeric).Value = stt;
                    cmd.Parameters.Add("phai", NpgsqlDbType.Numeric).Value = phai;
                    cmd.Parameters.Add("tt", NpgsqlDbType.Varchar, 2).Value = tt;
                    cmd.Parameters.Add("namsinh", NpgsqlDbType.Varchar, 4).Value = namsinh;
                    cmd.Parameters.Add("ghichu", NpgsqlDbType.Text).Value = ghichu;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "kskmuc");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_kskmucct(decimal id, decimal mavp, decimal stt, decimal gia_nv, decimal gia_ngv, string ghichu)
        {
            sql = "update " + user + ".kskmucct set stt=:stt,gia_nv=:gia_nv,gia_ngv=:gia_ngv,ghichu=:ghichu where id=:id and mavp=:mavp";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("stt", NpgsqlDbType.Numeric).Value = stt;
                cmd.Parameters.Add("gia_nv", NpgsqlDbType.Numeric).Value = gia_nv;
                cmd.Parameters.Add("gia_ngv", NpgsqlDbType.Numeric).Value = gia_ngv;
                cmd.Parameters.Add("ghichu", NpgsqlDbType.Text).Value = ghichu;
                cmd.Parameters.Add("id", NpgsqlDbType.Numeric).Value = id;
                cmd.Parameters.Add("mavp", NpgsqlDbType.Numeric).Value = mavp;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".kskmucct (id,stt,mavp,gia_nv,gia_ngv,ghichu) values (:id,:stt,:mavp,:gia_nv,:gia_ngv,:ghichu)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("id", NpgsqlDbType.Numeric).Value = id;
                    cmd.Parameters.Add("stt", NpgsqlDbType.Numeric).Value = stt;
                    cmd.Parameters.Add("mavp", NpgsqlDbType.Numeric).Value = mavp;
                    cmd.Parameters.Add("gia_nv", NpgsqlDbType.Numeric).Value = gia_nv;
                    cmd.Parameters.Add("gia_ngv", NpgsqlDbType.Numeric).Value = gia_ngv;
                    cmd.Parameters.Add("ghichu", NpgsqlDbType.Text).Value = ghichu;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "kskmucct");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public string get_ma_kskdoan(string ngay)
        {
            int ma = 1;
            sql = "select max(ma) as ma from " + user + ".kskdoan where to_char(ngay,'yyyy')='" + ngay.Substring(6, 4) + "'";
            ds = get_data(sql);
            if (ds.Tables[0].Rows[0]["ma"].ToString() != "")
            {
                ma = int.Parse(ds.Tables[0].Rows[0]["ma"].ToString()) + 1;
            }
            return ma.ToString().PadLeft(3, '0');
        }

        public string get_ma_kskdonvi(decimal iddoan)
        {
            int ma = 1;
            sql = "select max(ma) as ma from " + user + ".kskdonvi where iddoan=" + iddoan;
            ds = get_data(sql);
            if (ds.Tables[0].Rows[0]["ma"].ToString() != "")
            {
                ma = int.Parse(ds.Tables[0].Rows[0]["ma"].ToString()) + 1;
            }
            return ma.ToString().PadLeft(2, '0');
        }

        public bool upd_kskbtdbn(decimal iddonvi, decimal stt, string mabn, string hoten, string namsinh, int phai, string mann, string dienthoai, string diachi, int userid)
        {
            string hotenkdau = Hoten_khongdau(hoten);
            sql = "update " + user + ".kskbtdbn set stt=:stt,hoten=:hoten,namsinh=:namsinh,phai=:phai,mann=:mann,dienthoai=:dienthoai,diachi=:diachi,hotenkdau=:hotenkdau,userid=:userid where mabn=:mabn and iddonvi=:iddonvi";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("stt", NpgsqlDbType.Numeric).Value = stt;
                cmd.Parameters.Add("hoten", NpgsqlDbType.Text).Value = hoten;
                cmd.Parameters.Add("namsinh", NpgsqlDbType.Varchar, 4).Value = namsinh;
                cmd.Parameters.Add("phai", NpgsqlDbType.Numeric).Value = phai;
                cmd.Parameters.Add("mann", NpgsqlDbType.Varchar, 2).Value = mann;
                cmd.Parameters.Add("dienthoai", NpgsqlDbType.Varchar, 50).Value = dienthoai;
                cmd.Parameters.Add("diachi", NpgsqlDbType.Text).Value = diachi;
                cmd.Parameters.Add("hotenkdau", NpgsqlDbType.Varchar, 100).Value = hotenkdau;
                cmd.Parameters.Add("userid", NpgsqlDbType.Numeric).Value = userid;
                cmd.Parameters.Add("mabn", NpgsqlDbType.Varchar).Value = mabn;
                cmd.Parameters.Add("iddonvi", NpgsqlDbType.Numeric).Value = iddonvi;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".kskbtdbn (iddonvi,stt,mabn,hoten,namsinh,phai,mann,dienthoai,diachi,hotenkdau,userid) values (:iddonvi,:stt,:mabn,:hoten,:namsinh,:phai,:mann,:dienthoai,:diachi,:hotenkdau,:userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("iddonvi", NpgsqlDbType.Numeric).Value = iddonvi;
                    cmd.Parameters.Add("stt", NpgsqlDbType.Numeric).Value = stt;
                    cmd.Parameters.Add("mabn", NpgsqlDbType.Varchar).Value = mabn;
                    cmd.Parameters.Add("hoten", NpgsqlDbType.Text).Value = hoten;
                    cmd.Parameters.Add("namsinh", NpgsqlDbType.Varchar, 4).Value = namsinh;
                    cmd.Parameters.Add("phai", NpgsqlDbType.Numeric).Value = phai;
                    cmd.Parameters.Add("mann", NpgsqlDbType.Varchar, 2).Value = mann;
                    cmd.Parameters.Add("dienthoai", NpgsqlDbType.Varchar, 50).Value = dienthoai;
                    cmd.Parameters.Add("diachi", NpgsqlDbType.Text).Value = diachi;
                    cmd.Parameters.Add("hotenkdau", NpgsqlDbType.Varchar, 100).Value = hotenkdau;
                    cmd.Parameters.Add("userid", NpgsqlDbType.Numeric).Value = userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "kskbtdbn");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public void ksk_chidinh(string mabn, string ngay, decimal maql, string makp, int madoituong, int _userid, decimal doan, string namsinh, int phai, int loaiksk)
        {
            DataTable dtmuc = get_data("select * from " + user + ".kskmuc where iddoan=" + doan + " order by stt").Tables[0];
            DataTable dtmucct = get_data("select b.*,c.ten from " + user + ".kskmuc a," + user + ".kskmucct b,v_giavp c where a.id=b.id and b.mavp=c.id and a.iddoan=" + doan + " order by b.stt").Tables[0];
            updrec(dtmuc, dtmucct, ngay, mabn, maql, makp, madoituong, _userid, namsinh, phai, loaiksk);
        }
        private void updrec(DataTable dtmuc, DataTable dtmucct, string ngay, string mabn, decimal maql, string makp, int madoituong, int _userid, string namsinh, int phai, int loaiksk)
        {
            DataRow[] dr;
            bool bFound = false;
            sql = "true";
            if (phai != -1) sql += " and phai=" + phai;
            foreach (DataRow r2 in dtmuc.Select(sql, "stt"))
            {
                sql = "true";
                if (phai != -1) sql += " and phai=" + phai;
                if (namsinh != "") sql += " and namsinh<>'' and namsinh" + r2["tt"].ToString().Trim() + "'" + namsinh + "'";
                foreach (DataRow r in dtmuc.Select(sql, "stt"))
                {
                    sql = "true";
                    if (phai != -1) sql += " and phai=" + phai;
                    if (namsinh != "" && r["namsinh"].ToString() != "") sql += " and namsinh" + r["tt"].ToString().Trim() + "'" + namsinh + "'";
                    dr = dtmuc.Select(sql);
                    if (dr.Length > 0)
                    {
                        ins_items(dtmucct, ngay, mabn, maql, makp, madoituong, _userid, decimal.Parse(r["id"].ToString()), loaiksk);
                        bFound = true;
                        break;
                    }
                }
                if (bFound) break;
            }
            if (!bFound)
            {
                sql = "true";
                if (phai != -1) sql += " and phai=" + phai;
                foreach (DataRow r in dtmuc.Select(sql, "phai,namsinh,stt"))
                {
                    sql = "true";
                    if (phai != -1 && r["phai"].ToString() != "-1") sql += " and phai=" + phai;
                    if (namsinh != "" && r["namsinh"].ToString() != "") sql += " and namsinh" + r["tt"].ToString().Trim() + "'" + namsinh + "'";
                    dr = dtmuc.Select(sql);
                    if (dr.Length > 0)
                    {
                        ins_items(dtmucct, ngay, mabn, maql, makp, madoituong, _userid, decimal.Parse(r["id"].ToString()), loaiksk);
                        break;
                    }
                }
            }
        }

        private void ins_items(DataTable dtmucct, string ngay, string mabn, decimal maql, string makp, int madoituong, int _userid, decimal id, int loaiksk)
        {
            v = new LibVienphi.AccessData();
            decimal _id = 0;
            foreach (DataRow r1 in dtmucct.Select("id=" + id, "stt"))
            {
                _id = v.get_id_chidinh;
                v.upd_chidinh(_id, mabn, maql, maql, 0, ngay, v.iNgoaitru, makp, madoituong, int.Parse(r1["mavp"].ToString()), 1, (loaiksk == 0) ? decimal.Parse(r1["gia_nv"].ToString()) : decimal.Parse(r1["gia_ngv"].ToString()), 0, _userid, 0, 0, _id, "", "", "", 3, "");
            }
        }
        public bool upd_ba_danhmuc(string m_table, decimal m_id, decimal m_stt, string m_ten, int m_userid)
        {
            sql = "update " + m_table + " set stt=:m_stt,ten=:m_ten,userid=:m_userid where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + m_table + " (id,stt,ten,userid) values (:m_id,:m_stt,:m_ten,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, m_table);
                return false;
            }
            finally
            {

                con.Close();
            }
            return true;
        }

        public bool upd_ba_danhmuc(decimal m_id, int m_loai, decimal m_stt, string m_ten)
        {
            sql = "update " + user + ".ba_danhmuc set loai=:m_loai,stt=:m_stt,ten=:m_ten where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".ba_danhmuc (id,loai,stt,ten) values (:m_id,:m_loai,:m_stt,:m_ten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_danhmuc");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public string get_khambhyt(string mabn, string ngay, decimal maql)
        {
            string s = "";
            if (bMmyy(mmyy(ngay)))
            {
                sql = "select b.tenkp,to_char(a.ngay,'dd/mm/yyyy hh24:mi') as ngay ";
                sql += " from " + user + mmyy(ngay) + ".tiepdon a," + user + ".btdkp_bv b where a.makp=b.makp and a.mabn='" + mabn + "' and to_char(a.ngay,'dd/mm/yyyy')='" + ngay.Substring(0, 10) + "'";
                sql += " and a.maql<>" + maql + " and a.madoituong=1 and a.noitiepdon in (0,1,5,16)";
                foreach (DataRow r in get_data(sql).Tables[0].Rows)
                {
                    s = "Người bệnh BHYT ngày " + r["ngay"].ToString() + " đã khám tại " + r["tenkp"].ToString();
                    break;
                }
            }
            return s;
        }

        public bool upd_bask_chiso(string mabn, decimal maql, string ngay, string socmnd, string capngay, string tai, string lydo,
            string tiensu)
        {
            string xxx = user + mmyy(ngay);
            sql = "update " + xxx + ".bask_chiso set mabn=:mabn,ngay=to_timestamp(:ngay,'dd/mm/yyyy hh24:mi'),";
            sql += "socmnd=:socmnd,";
            if (capngay != "") sql += "capngay=to_timestamp(:capngay,'dd/mm/yyyy'),";
            sql += "tai=:tai,lydo=:lydo,tiensu=:tiensu where maql=:maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("mabn", NpgsqlDbType.Varchar).Value = mabn;
                cmd.Parameters.Add("ngay", NpgsqlDbType.Varchar, 16).Value = ngay;
                cmd.Parameters.Add("socmnd", NpgsqlDbType.Varchar, 20).Value = socmnd;
                if (capngay != "") cmd.Parameters.Add("capngay", NpgsqlDbType.Varchar, 10).Value = capngay;
                cmd.Parameters.Add("tai", NpgsqlDbType.Varchar, 3).Value = tai;
                cmd.Parameters.Add("lydo", NpgsqlDbType.Text).Value = lydo;
                cmd.Parameters.Add("tiensu", NpgsqlDbType.Text).Value = tiensu;
                cmd.Parameters.Add("maql", NpgsqlDbType.Numeric).Value = maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".bask_chiso (mabn,maql,ngay,socmnd,";
                    if (capngay != "") sql += "capngay,";
                    sql += "tai,lydo,tiensu)";
                    sql += " values (:mabn,:maql,to_timestamp(:ngay,'dd/mm/yyyy hh24:mi'),:socmnd,";
                    if (capngay != "") sql += ":capngay,";
                    sql += ":tai,:lydo,:tiensu)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("mabn", NpgsqlDbType.Varchar).Value = mabn;
                    cmd.Parameters.Add("maql", NpgsqlDbType.Numeric).Value = maql;
                    cmd.Parameters.Add("ngay", NpgsqlDbType.Varchar, 16).Value = ngay;
                    cmd.Parameters.Add("socmnd", NpgsqlDbType.Varchar, 20).Value = socmnd;
                    if (capngay != "") cmd.Parameters.Add("capngay", NpgsqlDbType.Varchar, 10).Value = capngay;
                    cmd.Parameters.Add("tai", NpgsqlDbType.Varchar, 3).Value = tai;
                    cmd.Parameters.Add("lydo", NpgsqlDbType.Text).Value = lydo;
                    cmd.Parameters.Add("tiensu", NpgsqlDbType.Text).Value = tiensu;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ngay, ex.Message, sComputer, "bask_chiso");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_bask_cls(string ngay, decimal maql, decimal mavaovien, int stt, decimal idchidinh, int loai, string ketluan)
        {
            string xxx = user + mmyy(ngay);
            sql = "update " + xxx + ".bask_cls set maql=:maql,mavaovien=:mavaovien,stt=:stt,loai=:loai,ketluan=:ketluan";
            sql += " where idchidinh=:idchidinh";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("maql", NpgsqlDbType.Numeric).Value = maql;
                cmd.Parameters.Add("mavaovien", NpgsqlDbType.Numeric).Value = mavaovien;
                cmd.Parameters.Add("stt", NpgsqlDbType.Numeric).Value = stt;
                cmd.Parameters.Add("loai", NpgsqlDbType.Numeric).Value = loai;
                cmd.Parameters.Add("ketluan", NpgsqlDbType.Text).Value = ketluan;
                cmd.Parameters.Add("idchidinh", NpgsqlDbType.Numeric).Value = idchidinh;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".bask_cls (maql,mavaovien,stt,idchidinh,loai,ketluan)";
                    sql += " values (:maql,:mavaovien,:stt,:idchidinh,:loai,:ketluan)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("maql", NpgsqlDbType.Numeric).Value = maql;
                    cmd.Parameters.Add("mavaovien", NpgsqlDbType.Numeric).Value = mavaovien;
                    cmd.Parameters.Add("stt", NpgsqlDbType.Numeric).Value = stt;
                    cmd.Parameters.Add("idchidinh", NpgsqlDbType.Numeric).Value = idchidinh;
                    cmd.Parameters.Add("loai", NpgsqlDbType.Numeric).Value = loai;
                    cmd.Parameters.Add("ketluan", NpgsqlDbType.Text).Value = ketluan;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ngay, ex.Message, sComputer, "bask_cls");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_bask_donvi(string ngay, string mabn, decimal maql, decimal madonvi, decimal mach, decimal chieucao, decimal nhietdo,
            decimal cannang, string huyetap, decimal nhiptho)
        {
            string xxx = user + mmyy(ngay);
            sql = "update " + xxx + ".bask_donvi set mabn=:mabn,madonvi=:madonvi,mach=:mach,chieucao=:chieucao,";
            sql += "nhietdo=:nhietdo,cannang=:cannang,huyetap=:huyetap,nhiptho=:nhiptho";
            sql += " where maql=:maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("mabn", NpgsqlDbType.Varchar).Value = mabn;
                cmd.Parameters.Add("madonvi", NpgsqlDbType.Numeric).Value = madonvi;
                cmd.Parameters.Add("mach", NpgsqlDbType.Numeric).Value = mach;
                cmd.Parameters.Add("chieucao", NpgsqlDbType.Numeric).Value = chieucao;
                cmd.Parameters.Add("nhietdo", NpgsqlDbType.Numeric).Value = nhietdo;
                cmd.Parameters.Add("cannang", NpgsqlDbType.Numeric).Value = cannang;
                cmd.Parameters.Add("huyetap", NpgsqlDbType.Varchar, 7).Value = huyetap;
                cmd.Parameters.Add("nhiptho", NpgsqlDbType.Numeric).Value = nhiptho;
                cmd.Parameters.Add("maql", NpgsqlDbType.Numeric).Value = maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".bask_donvi (mabn,maql,madonvi,mach,chieucao,nhietdo,cannang,huyetap,nhiptho)";
                    sql += " values (:mabn,:maql,:madonvi,:mach,:chieucao,:nhietdo,:cannang,:huyetap,:nhiptho)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("mabn", NpgsqlDbType.Varchar).Value = mabn;
                    cmd.Parameters.Add("maql", NpgsqlDbType.Numeric).Value = maql;
                    cmd.Parameters.Add("madonvi", NpgsqlDbType.Numeric).Value = madonvi;
                    cmd.Parameters.Add("mach", NpgsqlDbType.Numeric).Value = mach;
                    cmd.Parameters.Add("chieucao", NpgsqlDbType.Numeric).Value = chieucao;
                    cmd.Parameters.Add("nhietdo", NpgsqlDbType.Numeric).Value = nhietdo;
                    cmd.Parameters.Add("cannang", NpgsqlDbType.Numeric).Value = cannang;
                    cmd.Parameters.Add("huyetap", NpgsqlDbType.Varchar, 7).Value = huyetap;
                    cmd.Parameters.Add("nhiptho", NpgsqlDbType.Numeric).Value = nhiptho;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ngay, ex.Message, sComputer, "bask_donvi");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_bask_mat(decimal maql, decimal mavaovien, string ngay, string makp, string mat, string thiluc, string tlcp,
            string tlct, string tlkp, string tlkt, string sop, string sot, string sacgiac, string khac, string mabs, int userid)
        {
            return true;
        }
        public bool upd_bask_ngkhoa(decimal maql, decimal mavaovien, string ngay, string makp, string ngoai, string dalieu,
            string khac, string mabs, int userid)
        {
            return true;
        }
        public bool upd_bask_noikhoa(decimal maql, decimal mavaovien, string ngay, string makp, string toanthan,
            string tonghop, string timmach, string tamthan, string thankinh, string khac, string mabs, int userid)
        {
            return true;
        }
        public bool upd_bask_rmh(decimal maql, decimal mavaovien, string ngay, string makp, string rhm, string saurang,
            string nhanhu, string matrang, string hammat, string khac, string mabs, int userid)
        {
            return true;
        }
        public bool upd_bask_sanphu(decimal maql, decimal mavaovien, string ngay, string makp, string san, string phu,
            string khac, string mabs, int userid)
        {
            return true;
        }
        public bool upd_bask_tmh(decimal maql, decimal mavaovien, string ngay, string makp, string tmh, string thuongt,
            string thamt, string thuongp, string thamp, string khac, string mabs, int userid)
        {
            return true;
        }
        public bool upd_bask_tongket(decimal maql, decimal mavaovien, string ngay, string makp, int phanloai, string ketluan,
            string khac, string mabs, int userid)
        {
            string xxx = user + mmyy(ngay);
            sql = "update " + xxx + ".bask_tongket set mavaovien=:mavaovien,ngay=to_timestamp(:ngay,'dd/mm/yyyy hh24:mi'),";
            sql += "makp=:makp,phanloai=:phanloai,ketluan=:ketluan,khac=:khac,mabs=:mabs,userid=:userid";
            sql += " where maql=:maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("mavaovien", NpgsqlDbType.Numeric).Value = mavaovien;
                cmd.Parameters.Add("ngay", NpgsqlDbType.Varchar, 16).Value = ngay;
                cmd.Parameters.Add("makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = makp;
                cmd.Parameters.Add("phanloai", NpgsqlDbType.Numeric).Value = phanloai;
                cmd.Parameters.Add("ketluan", NpgsqlDbType.Text).Value = ketluan;
                cmd.Parameters.Add("khac", NpgsqlDbType.Text).Value = khac;
                cmd.Parameters.Add("mabs", NpgsqlDbType.Varchar, 4).Value = mabs;
                cmd.Parameters.Add("userid", NpgsqlDbType.Numeric).Value = userid;
                cmd.Parameters.Add("maql", NpgsqlDbType.Numeric).Value = maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".bask_tongket (maql,mavaovien,ngay,makp,phanloai,ketluan,khac,mabs,userid)";
                    sql += " values (:maql,to_timestamp(:mavaovien,'dd/mm/yyyy hh24:mi'),:ngay,:makp,:phanloai,:ketluan,:khac,:mabs,:userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("maql", NpgsqlDbType.Numeric).Value = maql;
                    cmd.Parameters.Add("mavaovien", NpgsqlDbType.Numeric).Value = mavaovien;
                    cmd.Parameters.Add("ngay", NpgsqlDbType.Varchar, 16).Value = ngay;
                    cmd.Parameters.Add("makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = makp;
                    cmd.Parameters.Add("phanloai", NpgsqlDbType.Numeric).Value = phanloai;
                    cmd.Parameters.Add("ketluan", NpgsqlDbType.Text).Value = ketluan;
                    cmd.Parameters.Add("khac", NpgsqlDbType.Text).Value = khac;
                    cmd.Parameters.Add("mabs", NpgsqlDbType.Varchar, 4).Value = mabs;
                    cmd.Parameters.Add("userid", NpgsqlDbType.Numeric).Value = userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ngay, ex.Message, sComputer, "bask_tongket");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        // em dung lib VNConvert
        public string FieldDelimiter()
        {
            try
            {
                sql = "select giatri from " + user + ".links_histhongso where id=1 ";
                return get_data(sql).Tables[0].Rows[0][0].ToString();
            }
            catch
            {
                return "";
            }
        }
        public string RecordDelimiter()
        {
            try
            {
                sql = "select giatri from " + user + ".links_histhongso where id=2 ";
                return get_data(sql).Tables[0].Rows[0][0].ToString();
            }
            catch
            {
                return "";
            }
        }
        public string DataTag()
        {
            try
            {
                sql = "select giatri from " + user + ".links_histhongso where id=3 ";
                return get_data(sql).Tables[0].Rows[0][0].ToString();
            }
            catch
            {
                return "";
            }
        }
        public bool GetActive()
        {
            try
            {
                sql = "select giatri from " + user + ".links_histhongso where id=4 ";
                return get_data(sql).Tables[0].Rows[0][0].ToString() == "1";
            }
            catch
            {
                return false;
            }
        }

        public string exp_laymau_txt_xml(string v_mmyy, string v_id, string v_tra)
        {
            DataSet ads;
            DataTable dtpath = new DataTable();
            bool bWriteXML = false;
            string asql = "", apath = "", afield = "", arecord = "", aid_loai = "", aactive = "", adatatag = "", adatatag1 = "";
            sql = "select 0 as id,'' as hoten,'' as mabn,'' as ngaygio,'' as gioitinh,'' as tuoi,'' as mabs,'' as chandoan,'' as makp,'' as mavp,'' as ten,0 as sotien,'' as khan,0 as stt,0 as id_chitiet,0 as id_ten,'' as ten_chitiet,'' as ketqua,'' as tra,'' as diachi";
            DataSet ds_write = get_data(sql);
            try
            {
                afield = FieldDelimiter();
                arecord = RecordDelimiter();
                adatatag = DataTag();
                aactive = (GetActive() ? "1" : "0");
                //
                sql = "select * from " + user + ".links_histhongso where id=5 order by id_code";
                aid_loai = "";
                dtpath = get_data(sql).Tables[0];
                foreach (DataRow r in dtpath.Rows)
                {
                    if (r["id_code"].ToString() != "0")
                    {
                        aid_loai += r["id_code"].ToString() + ",";
                    }
                }
                if (aid_loai != "") aid_loai = aid_loai.TrimEnd(',');
            }
            catch
            {
                apath = "";
                afield = "";
                arecord = "";
                aid_loai = "";
                aactive = "";
                adatatag = "";
            }

            try
            {
                if (afield == "" || arecord == "" || aid_loai == "")// || aactive != "1")
                {
                    return "0";
                }

                string atenfile = "";//yyyymmdd.txtstring
                string s_ngayserver = "", usr = user, xxx = usr + v_mmyy;
                s_ngayserver = ngayhienhanh_server;
                DateTime dt = StringToDate(s_ngayserver);
                atenfile = dt.Year.ToString() + dt.Month.ToString().PadLeft(2, '0') + dt.Day.ToString().PadLeft(2, '0');
                atenfile = v_id + "_" + atenfile;
                asql = " select a.id,d.hoten,a.mabn,to_char(a.ngay,'yyyymmdd')|| to_char(a.ngay,'hh24:mi') as ngaygio,d.phai as gioitinh,";
                asql += " to_number(to_char(a.ngay,'yyyy'),9999) as tuoi1,d.namsinh as tuoi,aa.madoituong,e.doituong,cd.mabs,";
                asql += " coalesce(cd.chandoan,'') as chandoan,cd.makp,aa.mavp as id_giavp,b.ma as mavp,c.ten,";
                asql += " aa.soluong*aa.dongia as sotien,case when a.id_tinhtrang=1 then 'N' else 'CC' end as khan,";
                asql += " f.stt,f.id_chitiet,f.id_ten,f.ten as ten_chitiet,'' ketqua,f.id_bv_so as soxn,";
                asql += " case when d.sonha is null then '' else d.sonha end ||', '||case when d.thon is null then '' else d.thon end ||', '|| k.tenpxa||', '||h.tenquan||', '||g.tentt as diachi ";
                asql += " from " + xxx + ".v_chidinh cd," + usr + ".xn_laymau a," + usr + ".xn_laymau_ct aa,";
                asql += usr + ".v_giavp b," + usr + ".v_loaivp c," + usr + ".btdbn d," + usr + ".doituong e,";
                asql += "( select a.id_vienphi,b.id id_chitiet,b.id_ten,d.ten,a.id_bv_so,b.stt ";
                asql += " from " + usr + ".xn_bv_ten a ," + usr + ".xn_bv_chitiet b," + usr + ".xn_bv_so c," + usr + ".xn_ten d ";
                asql += " where a.id_bv_so=c.id and b.id_bv_ten=a.id and b.id_ten=d.id ) f,";
                asql += usr + ".btdtt g," + usr + ".btdquan h," + usr + ".btdpxa k ";
                asql += " where a.id=aa.id and aa.idchidinh=cd.id and aa.mavp=b.id and b.id_loai=c.id and a.mabn=d.mabn ";
                asql += " and aa.mavp=f.id_vienphi  and aa.madoituong=e.madoituong and d.matt=g.matt and d.maqu=h.maqu ";
                asql += " and d.maphuongxa=k.maphuongxa ";
                asql += " and a.id= " + v_id;
                asql += " and f.id_bv_so in (" + aid_loai + ")";
                asql += " order by f.stt  ";
                //
                ads = get_data(asql);
                if (ads.Tables[0].Rows.Count <= 0)
                {
                    return "0";
                }
                string stmp = "", exp = "";
                exp = "id_code=" + ads.Tables[0].Rows[0]["soxn"].ToString();
                DataRow r1 = getrowbyid(dtpath, exp);
                if (r1 == null) return "0";
                else
                {
                    stmp = r1["giatri"].ToString();
                    bWriteXML = (r1["xml"].ToString() == "1") ? true : false;
                    if (stmp != "") apath = stmp;
                    else
                    {
                        if (!System.IO.Directory.Exists("..//..//data_send"))
                        {
                            System.IO.Directory.CreateDirectory("..//..//data_send");
                            apath = "..//..//data_send//";
                        }
                        else
                        {
                            apath = "..//..//data_send//";
                        }
                    }
                }
                if (!bWriteXML)
                {
                    try
                    {
                        apath = apath + "" + atenfile + ".txt";
                        System.IO.StreamWriter sw = new System.IO.StreamWriter(apath, false, System.Text.Encoding.UTF8);
                        string astr = "", s1 = "";
                        decimal atuoi = 1;
                        foreach (DataRow r in ads.Tables[0].Rows)
                        {
                            //id(sobl)^^hoten^^mabn^^ngaygio(yyyymmdd hhmmss)^^gioitinh(0:nam,1:nu)^^tuoi^^Bacsi^^chandoan^^chuyenkhoa^^madanhmuc^^giatien^^khan(Y,N)^^canhbao(0: binhthuong,1:calcel)||

                            astr = decimal.Parse(r["id"].ToString()).ToString() + afield;
                            s1 = r["hoten"].ToString().Trim();						//
                            convert_font.Convert(ref s1, SCreenReader.FontIndex.iUNI, SCreenReader.FontIndex.iVNI);
                            astr += s1 + afield;
                            //
                            astr += r["mabn"].ToString() + afield;
                            astr += r["ngaygio"].ToString() + afield;
                            astr += (r["gioitinh"].ToString().Trim() == "1" ? "0" : "1") + afield;
                            try
                            {
                                atuoi = decimal.Parse(r["tuoi1"].ToString().Trim()) - decimal.Parse(r["tuoi"].ToString().Trim());
                            }
                            catch
                            {
                                atuoi = 1;
                            }
                            astr += atuoi.ToString() + afield;
                            astr += r["mabs"].ToString() + afield;
                            //		astr += r["chandoan"].ToString() + afield;
                            s1 = r["chandoan"].ToString();
                            convert_font.Convert(ref s1, SCreenReader.FontIndex.iUNI, SCreenReader.FontIndex.iVNI);
                            astr += s1 + afield;
                            astr += r["makp"].ToString() + afield;
                            astr += r["mavp"].ToString() + afield;
                            astr += decimal.Parse(r["sotien"].ToString()).ToString("###") + afield;
                            astr += r["khan"].ToString() + afield;
                            s1 = r["ten"].ToString();
                            convert_font.Convert(ref s1, SCreenReader.FontIndex.iUNI, SCreenReader.FontIndex.iVNI);
                            astr += s1 + afield;
                            //		astr += r["ten"].ToString()+afield;
                            astr += r["stt"].ToString() + afield;
                            astr += r["id_chitiet"].ToString() + afield;
                            astr += r["id_chitiet"].ToString() + "_" + r["id_ten"].ToString() + afield;
                            //		astr += r["ten_chitiet"].ToString()+afield;
                            s1 = r["ten_chitiet"].ToString();
                            convert_font.Convert(ref s1, SCreenReader.FontIndex.iUNI, SCreenReader.FontIndex.iVNI);
                            astr += s1 + afield;
                            astr += "ketqua" + afield;
                            astr += v_tra + afield;
                            astr += r["madoituong"].ToString() + afield;
                            s1 = r["doituong"].ToString();
                            convert_font.Convert(ref s1, SCreenReader.FontIndex.iUNI, SCreenReader.FontIndex.iVNI);
                            astr += s1 + afield;
                            astr += arecord;
                            //
                            if (adatatag.Trim() != "")
                            {
                                adatatag1 = adatatag.Substring(0, 1) + "/" + adatatag.Substring(1);
                                astr = adatatag + astr + adatatag1;
                            }
                            sw.WriteLine(astr);
                        }
                        sw.Close();
                    }
                    catch
                    {
                        System.Windows.Forms.MessageBox.Show("Lỗi khi gửi file chỉ định " + v_id + " với đường dẫn : " + apath + " \n Chưa có kết nối !");
                    }
                }
                else
                {
                    try
                    {
                        apath = apath + "" + atenfile + ".xml";
                        decimal atuoi = 1;
                        DataRow r2;
                        ds_write.Tables[0].Clear();
                        foreach (DataRow r in ads.Tables[0].Rows)
                        {
                            //id(sobl)^^hoten^^mabn^^ngaygio(yyyymmdd hhmmss)^^gioitinh(0:nam,1:nu)^^tuoi^^Bacsi^^chandoan^^chuyenkhoa^^madanhmuc^^giatien^^khan(Y,N)^^canhbao(0: binhthuong,1:calcel)||
                            r2 = ds_write.Tables[0].NewRow();
                            r2["id"] = decimal.Parse(r["id"].ToString());
                            r2["hoten"] = r["hoten"].ToString().Trim();
                            r2["mabn"] = r["mabn"].ToString();
                            r2["diachi"] = r["diachi"].ToString();
                            r2["ngaygio"] = r["ngaygio"].ToString();
                            r2["gioitinh"] = (r["gioitinh"].ToString().Trim() == "1" ? "0" : "1");
                            try
                            {
                                atuoi = decimal.Parse(r["tuoi1"].ToString().Trim()) - decimal.Parse(r["tuoi"].ToString().Trim());
                            }
                            catch
                            {
                                atuoi = 1;
                            }
                            r2["tuoi"] = atuoi.ToString();
                            r2["mabs"] = r["mabs"].ToString();
                            r2["chandoan"] = r["chandoan"].ToString();
                            r2["makp"] = r["makp"].ToString();
                            r2["mavp"] = r["mavp"].ToString();
                            r2["sotien"] = decimal.Parse(r["sotien"].ToString()).ToString("###");
                            r2["khan"] = r["khan"].ToString();
                            r2["ten"] = r["ten"].ToString();
                            r2["stt"] = int.Parse(r["stt"].ToString());
                            r2["id_chitiet"] = int.Parse(r["id_chitiet"].ToString());
                            r2["id_ten"] = int.Parse(r["id_ten"].ToString());
                            r2["ten_chitiet"] = r["ten_chitiet"].ToString();
                            r2["ketqua"] = "";
                            r2["tra"] = v_tra;
                            ds_write.Tables[0].Rows.Add(r2);
                            ds_write.Tables[0].AcceptChanges();
                        }
                        ds_write.AcceptChanges();
                        ds_write.WriteXml(@apath, XmlWriteMode.WriteSchema);
                    }
                    catch
                    {
                        System.Windows.Forms.MessageBox.Show("Lỗi khi gửi file chỉ định " + v_id + " với đường dẫn : " + apath + " \n Chưa có kết nối !");
                    }

                }
                return "1";
            }
            catch (Exception ex)
            {
                System.Windows.Forms.MessageBox.Show(ex.ToString());
                return "0";
            }
        }

        public string exp_chidinh(string v_mmyy, string v_id, string v_tra)
        {
            DataSet ads;
            string asql = "", apath = "", afield = "", arecord = "", aid_loai = "", aactive = "", adatatag = "", adatatag1 = "";
            try
            {
                foreach (DataRow r in get_data("select * from " + user + ".links_histhongso where id in (1,2,3,4,5,6)").Tables[0].Rows)
                {
                    if (r["id"].ToString() == "1")
                    {
                        apath = r["giatri"].ToString();
                    }
                    if (r["id"].ToString() == "2")
                    {
                        afield = r["giatri"].ToString().Trim();
                    }
                    if (r["id"].ToString() == "3")
                    {
                        arecord = r["giatri"].ToString().Trim();
                    }
                    if (r["id"].ToString() == "4")
                    {
                        aactive = r["giatri"].ToString().Trim();
                    }
                    if (r["id"].ToString() == "5")
                    {
                        aid_loai = r["giatri"].ToString().Trim();
                    }
                    if (r["id"].ToString() == "6")
                    {
                        adatatag = r["giatri"].ToString().Trim();
                    }
                }
            }
            catch
            {
                apath = "";
                afield = "";
                arecord = "";
                aid_loai = "";
                aactive = "";
                adatatag = "";
            }

            try
            {
                if (apath == "" || afield == "" || arecord == "" || aid_loai == "")// || aactive != "1")
                {
                    return "0";
                }

                string atenfile = "", usr = user;//yymmddhhmmssxxxx.txt
                atenfile = get_data("select to_char(now(),'yymmddhh24miss') as ngay").Tables[0].Rows[0]["ngay"].ToString();

                atenfile += "_" + v_id;
                asql = " select a.id,e.hoten,a.mabn,to_char(a.ngay,'yyyymmdd')||to_char(now(),'hhmmss') as ngaygio,";
                asql += "e.phai as gioitinh,to_number(to_char(a.ngay,'yyyy'),9999) as tuoi1, e.namsinh as tuoi,a.mabs,";
                asql += "a.chandoan,a.makp,a.mavp as id_giavp,b.ma as mavp, c.ten, a.soluong*a.dongia as sotien,'N' as khan,";
                asql += "f.doituong,trim(e.sonha)||' '||trim(e.thon)||' '||trim(i.tenpxa)||' '||trim(h.tenquan)||' '||g.tentt as diachi";
                asql += " from " + user + v_mmyy + ".v_chidinh a inner join " + usr + ".v_giavp b on a.mavp=b.id ";
                asql += " inner join " + usr + ".v_loaivp c on b.id_loai=c.id ";
                asql += " inner join " + usr + ".btdbn e on a.mabn=e.mabn ";
                asql += " inner join " + usr + ".doituong f on a.madoituong=f.madoituong ";
                asql += " left join " + usr + ".btdtt g on e.matt=g.matt ";
                asql += " left join " + usr + ".btdquan h on e.maqu=h.maqu ";
                asql += " left join " + usr + ".btdpxa i on e.maphuongxa=i.maphuongxa ";
                asql += " where a.id=" + v_id + " and c.id in (" + aid_loai + ")";
                ads = get_data(asql);
                if (ads.Tables[0].Rows.Count <= 0)
                {
                    return "0";
                }
                string apath_save = apath.Substring(0, apath.LastIndexOf("//")) + "_save";
                if (!System.IO.Directory.Exists(apath_save)) System.IO.Directory.CreateDirectory(apath_save);
                apath_save = apath_save + "//xn" + atenfile + ".txt";
                apath = apath + "" + atenfile + ".txt";
                System.IO.StreamWriter sw = new System.IO.StreamWriter(apath, false, System.Text.Encoding.UTF8);
                string astr = "", s1 = "";
                decimal atuoi = 1;
                foreach (DataRow r in ads.Tables[0].Rows)
                {
                    astr += decimal.Parse(r["id"].ToString()).ToString() + afield;
                    s1 = r["hoten"].ToString().Trim();
                    convert_font.Convert(ref s1, SCreenReader.FontIndex.iUNI, SCreenReader.FontIndex.iVNI);
                    astr += s1 + afield;
                    astr += r["mabn"].ToString() + afield;
                    astr += r["ngaygio"].ToString() + afield;
                    astr += (r["gioitinh"].ToString().Trim() == "1" ? "0" : "1") + afield;
                    try
                    {
                        atuoi = decimal.Parse(r["tuoi1"].ToString().Trim()) - decimal.Parse(r["tuoi"].ToString().Trim());
                    }
                    catch
                    {
                        atuoi = 1;
                    }
                    astr += atuoi.ToString() + afield;
                    s1 = r["diachi"].ToString().Trim();
                    convert_font.Convert(ref s1, SCreenReader.FontIndex.iUNI, SCreenReader.FontIndex.iVNI);
                    astr += s1 + afield;
                    astr += r["mabs"].ToString() + afield;
                    s1 = r["chandoan"].ToString().Trim();
                    convert_font.Convert(ref s1, SCreenReader.FontIndex.iUNI, SCreenReader.FontIndex.iVNI);
                    astr += s1 + afield;
                    astr += r["makp"].ToString() + afield;

                    s1 = r["doituong"].ToString().Trim();
                    convert_font.Convert(ref s1, SCreenReader.FontIndex.iUNI, SCreenReader.FontIndex.iVNI);
                    astr += s1 + afield;

                    astr += r["mavp"].ToString() + afield;
                    astr += decimal.Parse(r["sotien"].ToString()).ToString("###") + afield;
                    astr += r["khan"].ToString() + afield;
                    astr += v_tra + afield;
                    s1 = r["ten"].ToString().Trim();
                    convert_font.Convert(ref s1, SCreenReader.FontIndex.iUNI, SCreenReader.FontIndex.iVNI);
                    astr += s1 + afield;
                    astr += arecord;
                }
                if (adatatag.Trim() != "")
                {
                    adatatag1 = adatatag.Substring(0, 1) + "/" + adatatag.Substring(1);
                    astr = adatatag + astr + adatatag1;
                }
                sw.Write(astr);
                sw.Close();
                System.IO.File.Copy(apath, apath_save, true);
                return "1";
            }
            catch
            {
                return "0";
            }
        }

        #region haison
        public void upd_ct_thongso(int m_id, string m_ten)
        {
            sql = "update " + user + ".ct_thongso set ten=:m_ten where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".ct_thongso(id,ten) values (:m_id,:m_ten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message.ToString().Trim(), sComputer, "ct_Thongso");
            }
            finally
            {

                con.Close(); con.Dispose();
            }
        }
        public bool upd_ct_mucct(decimal id, decimal mavp, decimal stt, decimal gia_nv, decimal gia_ngv, string ghichu, decimal tyle)
        {
            sql = "update " + user + ".ct_mucct set stt=:stt,gia_nv=:gia_nv,gia_ngv=:gia_ngv,ghichu=:ghichu,tyle=:tyle where id=:id and mavp=:mavp";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("stt", NpgsqlDbType.Numeric).Value = stt;
                cmd.Parameters.Add("gia_nv", NpgsqlDbType.Numeric).Value = gia_nv;
                cmd.Parameters.Add("gia_ngv", NpgsqlDbType.Numeric).Value = gia_ngv;
                cmd.Parameters.Add("ghichu", NpgsqlDbType.Text).Value = ghichu;
                cmd.Parameters.Add("id", NpgsqlDbType.Numeric).Value = id;
                cmd.Parameters.Add("mavp", NpgsqlDbType.Numeric).Value = mavp;
                cmd.Parameters.Add("tyle", NpgsqlDbType.Numeric).Value = tyle;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".ct_mucct (id,stt,mavp,gia_nv,gia_ngv,ghichu,tyle) values (:id,:stt,:mavp,:gia_nv,:gia_ngv,:ghichu,:tyle)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("id", NpgsqlDbType.Numeric).Value = id;
                    cmd.Parameters.Add("stt", NpgsqlDbType.Numeric).Value = stt;
                    cmd.Parameters.Add("mavp", NpgsqlDbType.Numeric).Value = mavp;
                    cmd.Parameters.Add("gia_nv", NpgsqlDbType.Numeric).Value = gia_nv;
                    cmd.Parameters.Add("gia_ngv", NpgsqlDbType.Numeric).Value = gia_ngv;
                    cmd.Parameters.Add("ghichu", NpgsqlDbType.Text).Value = ghichu;
                    cmd.Parameters.Add("tyle", NpgsqlDbType.Numeric).Value = tyle;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ct_mucct");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        public string get_ma_doan(string ngay)
        {
            int ma = 1;
            sql = "select max(ma) as ma from " + user + ".ct_doan where to_char(ngay,'yyyy')='" + ngay.Substring(6, 4) + "'";
            ds = get_data(sql);
            if (ds.Tables[0].Rows[0]["ma"].ToString() != "")
            {
                ma = int.Parse(ds.Tables[0].Rows[0]["ma"].ToString()) + 1;
            }
            return ma.ToString().PadLeft(3, '0');
        }
        public string get_ma_donvi(decimal iddoan)
        {
            int ma = 1;
            sql = "select max(ma) as ma from " + user + ".ct_donvi where iddoan=" + iddoan;
            ds = get_data(sql);
            if (ds.Tables[0].Rows[0]["ma"].ToString() != "")
            {
                ma = int.Parse(ds.Tables[0].Rows[0]["ma"].ToString()) + 1;
            }
            return ma.ToString().PadLeft(2, '0');
        }
        #endregion

        #region vs Report

        public bool upd_r_tenobject(decimal id, decimal stt, string ten, string tt)
        {
            sql = "update " + user + ".r_tenobject set stt=:stt,ten=:ten,tt=:tt where id=:id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("stt", NpgsqlDbType.Numeric).Value = stt;
                cmd.Parameters.Add("ten", NpgsqlDbType.Text, 50).Value = ten;
                cmd.Parameters.Add("tt", NpgsqlDbType.Text, 20).Value = tt;
                cmd.Parameters.Add("id", NpgsqlDbType.Numeric).Value = id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".r_tenobject(id,stt,ten,tt) values (:id,:stt,:ten,:tt)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("id", NpgsqlDbType.Numeric).Value = id;
                    cmd.Parameters.Add("stt", NpgsqlDbType.Numeric).Value = stt;
                    cmd.Parameters.Add("ten", NpgsqlDbType.Text, 50).Value = ten;
                    cmd.Parameters.Add("tt", NpgsqlDbType.Text, 20).Value = tt;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "r_tenobject");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_phanhe(decimal id, decimal stt, string ten, string sql1)
        {
            sql = "update " + user + ".phanhe set stt=:stt,ten=:ten,sql=:sql1 where id=:id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("stt", NpgsqlDbType.Numeric).Value = stt;
                cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                cmd.Parameters.Add("sql1", NpgsqlDbType.Text).Value = sql1;
                cmd.Parameters.Add("id", NpgsqlDbType.Numeric).Value = id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".phanhe(id,stt,ten,sql) values (:id,:stt,:ten,:sql1)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("id", NpgsqlDbType.Numeric).Value = id;
                    cmd.Parameters.Add("stt", NpgsqlDbType.Numeric).Value = stt;
                    cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                    cmd.Parameters.Add("sql1", NpgsqlDbType.Text).Value = sql1;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "phanhe");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_r_nhom(decimal id, decimal phanhe, decimal stt, string ten)
        {
            sql = "update " + user + ".r_nhom set phanhe=" + phanhe + ",stt=:stt,ten=:ten where id=:id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("stt", NpgsqlDbType.Numeric).Value = stt;
                cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                cmd.Parameters.Add("id", NpgsqlDbType.Numeric).Value = id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".r_nhom(id,phanhe,stt,ten) values (:id," + phanhe + ",:stt,:ten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("id", NpgsqlDbType.Numeric).Value = id;
                    cmd.Parameters.Add("stt", NpgsqlDbType.Numeric).Value = stt;
                    cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "r_nhom");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_r_listinput(decimal id, decimal stt, string ten, string diengiai, string caulenh, string format, int tenobj,
            decimal h, decimal w, int kieu, decimal sql2)
        {
            sql = "update " + user + ".r_listinput set stt=:stt,ten=:ten,diengiai=:diengiai,sql=:caulenh,format=:format,tenobj=:tenobj,h=" + h + ",w=" + w + ",kieu=" + kieu + ",sql2=" + sql2 + " where id=:id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("stt", NpgsqlDbType.Numeric).Value = stt;
                cmd.Parameters.Add("ten", NpgsqlDbType.Text, 50).Value = ten;
                cmd.Parameters.Add("diengiai", NpgsqlDbType.Text).Value = diengiai;
                cmd.Parameters.Add("caulenh", NpgsqlDbType.Text).Value = caulenh;
                cmd.Parameters.Add("format", NpgsqlDbType.Text).Value = format;
                cmd.Parameters.Add("tenobj", NpgsqlDbType.Numeric).Value = tenobj;
                cmd.Parameters.Add("id", NpgsqlDbType.Numeric).Value = id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".r_listinput(id,stt,ten,diengiai,sql,format,tenobj,h,w,kieu,sql2) values (:id,:stt,:ten,:diengiai,:caulenh,:format,:tenobj," + h + "," + w + "," + kieu + "," + sql2 + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("id", NpgsqlDbType.Numeric).Value = id;
                    cmd.Parameters.Add("stt", NpgsqlDbType.Numeric).Value = stt;
                    cmd.Parameters.Add("ten", NpgsqlDbType.Text, 50).Value = ten;
                    cmd.Parameters.Add("diengiai", NpgsqlDbType.Text).Value = diengiai;
                    cmd.Parameters.Add("caulenh", NpgsqlDbType.Text).Value = caulenh;
                    cmd.Parameters.Add("format", NpgsqlDbType.Text).Value = format;
                    cmd.Parameters.Add("tenobj", NpgsqlDbType.Numeric).Value = tenobj;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "r_listinput");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_r_dateinput(decimal id, decimal stt, string ten, string diengiai, string format, int tenobj, decimal h, decimal w)
        {
            sql = "update " + user + ".r_dateinput set stt=:stt,ten=:ten,diengiai=:diengiai,format=:format,tenobj=:tenobj,h=" + h + ",w=" + w + " where id=:id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("stt", NpgsqlDbType.Numeric).Value = stt;
                cmd.Parameters.Add("ten", NpgsqlDbType.Text, 50).Value = ten;
                cmd.Parameters.Add("diengiai", NpgsqlDbType.Text).Value = diengiai;
                cmd.Parameters.Add("format", NpgsqlDbType.Text).Value = format;
                cmd.Parameters.Add("tenobj", NpgsqlDbType.Numeric).Value = tenobj;
                cmd.Parameters.Add("id", NpgsqlDbType.Numeric).Value = id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".r_dateinput(id,stt,ten,diengiai,format,tenobj,h,w) values (:id,:stt,:ten,:diengiai,:format,:tenobj," + h + "," + w + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("id", NpgsqlDbType.Numeric).Value = id;
                    cmd.Parameters.Add("stt", NpgsqlDbType.Numeric).Value = stt;
                    cmd.Parameters.Add("ten", NpgsqlDbType.Text, 50).Value = ten;
                    cmd.Parameters.Add("diengiai", NpgsqlDbType.Text).Value = diengiai;
                    cmd.Parameters.Add("format", NpgsqlDbType.Text).Value = format;
                    cmd.Parameters.Add("tenobj", NpgsqlDbType.Numeric).Value = tenobj;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "r_dateinput");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_r_function(decimal id, decimal stt, string ma, string ten, string diengiai, string tenfile, int phanhe, int loai, int kieu, string s,
            string f, string w, string caulenh, string g, string o, string dong, string cot, string ailam, int hide, int ketxuat, string sort,
            string sum, string sngay)
        {
            sql = "update " + user + ".r_function set stt=" + stt + ",ma=:ma,ten=:ten,diengiai=:diengiai,tenfile=:tenfile,phanhe=" + phanhe + ",loai=" + loai + ",kieu=" + kieu;
            sql += ",s=:s,f=:f,w=:w,sql=:caulenh,g=:g,o=:o,dong=:dong,cot=:cot,ailam=:ailam,hide=" + hide + ",ketxuat=" + ketxuat + ",sort=:sort,sum=:sum,sngay=:sngay where id=" + id;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("ma", NpgsqlDbType.Text, 20).Value = ma;
                cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                cmd.Parameters.Add("diengiai", NpgsqlDbType.Text).Value = diengiai;
                cmd.Parameters.Add("tenfile", NpgsqlDbType.Text, 50).Value = tenfile;
                cmd.Parameters.Add("s", NpgsqlDbType.Text).Value = s;
                cmd.Parameters.Add("f", NpgsqlDbType.Text).Value = f;
                cmd.Parameters.Add("w", NpgsqlDbType.Text).Value = w;
                cmd.Parameters.Add("caulenh", NpgsqlDbType.Text).Value = caulenh;
                cmd.Parameters.Add("g", NpgsqlDbType.Text).Value = g;
                cmd.Parameters.Add("o", NpgsqlDbType.Text).Value = o;
                cmd.Parameters.Add("dong", NpgsqlDbType.Text).Value = dong;
                cmd.Parameters.Add("cot", NpgsqlDbType.Text).Value = cot;
                cmd.Parameters.Add("ailam", NpgsqlDbType.Text).Value = ailam;
                cmd.Parameters.Add("sort", NpgsqlDbType.Text).Value = sort;
                cmd.Parameters.Add("sum", NpgsqlDbType.Text).Value = sum;
                cmd.Parameters.Add("sngay", NpgsqlDbType.Text).Value = sngay;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".r_function(id,stt,ma,ten,diengiai,tenfile,phanhe,loai,kieu,s,f,w,sql,g,o,dong,cot,ailam,hide,ketxuat,sort,sum,sngay) values (" + id + "," + stt + ",:ma,:ten,:diengiai,:tenfile," + phanhe + "," + loai + "," + kieu + ",:s,:f,:w,:caulenh,:g,:o,:dong,:cot,:ailam," + hide + "," + ketxuat + ",:sort,:sum,:sngay)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("ma", NpgsqlDbType.Text, 20).Value = ma;
                    cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                    cmd.Parameters.Add("diengiai", NpgsqlDbType.Text).Value = diengiai;
                    cmd.Parameters.Add("tenfile", NpgsqlDbType.Text, 50).Value = tenfile;
                    cmd.Parameters.Add("s", NpgsqlDbType.Text).Value = s;
                    cmd.Parameters.Add("f", NpgsqlDbType.Text).Value = f;
                    cmd.Parameters.Add("w", NpgsqlDbType.Text).Value = w;
                    cmd.Parameters.Add("caulenh", NpgsqlDbType.Text).Value = caulenh;
                    cmd.Parameters.Add("g", NpgsqlDbType.Text).Value = g;
                    cmd.Parameters.Add("o", NpgsqlDbType.Text).Value = o;
                    cmd.Parameters.Add("dong", NpgsqlDbType.Text).Value = dong;
                    cmd.Parameters.Add("cot", NpgsqlDbType.Text).Value = cot;
                    cmd.Parameters.Add("ailam", NpgsqlDbType.Text).Value = ailam;
                    cmd.Parameters.Add("sort", NpgsqlDbType.Text).Value = sort;
                    cmd.Parameters.Add("sum", NpgsqlDbType.Text).Value = sum;
                    cmd.Parameters.Add("sngay", NpgsqlDbType.Text).Value = sngay;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "r_function");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_r_ftables(decimal id, decimal idr, decimal stt, string ten, string viettat)
        {
            sql = "update " + user + ".r_ftables set idr=" + idr + ",stt=" + stt + ",ten='" + ten + "',viettat='" + viettat + "' where id=" + id;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".r_ftables(id,idr,stt,ten,viettat) values (" + id + "," + idr + "," + stt + ",'" + ten + "','" + viettat + "')";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "r_ftables");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_r_ffields(decimal id, decimal idr, decimal stt, string fie, string ten, string diengiai, decimal idf)
        {
            sql = "update " + user + ".r_ffields set idr=" + idr + ",stt=" + stt + ",fie='" + fie + "',ten=:ten,diengiai=:diengiai,idf=" + idf + " where id=" + id;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                cmd.Parameters.Add("diengiai", NpgsqlDbType.Text).Value = diengiai;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".r_ffields(id,idr,stt,fie,ten,diengiai,idf) values (" + id + "," + idr + "," + stt + ",'" + fie + "',:ten,:diengiai," + idf + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                    cmd.Parameters.Add("diengiai", NpgsqlDbType.Text).Value = diengiai;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "r_ffields");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_r_finputs(decimal id, decimal idr, decimal stt, string fie, string ten, string diengiai, decimal loai, string tenobject)
        {
            sql = "update " + user + ".r_finputs set idr=" + idr + ",stt=" + stt + ",fie='" + fie + "',ten=:ten,diengiai=:diengiai,loai=" + loai + ",tenobject='" + tenobject + "' where id=" + id;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                cmd.Parameters.Add("diengiai", NpgsqlDbType.Text).Value = diengiai;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".r_finputs(id,idr,stt,fie,ten,diengiai,loai,tenobject) values (" + id + "," + idr + "," + stt + ",'" + fie + "',:ten,:diengiai," + loai + ",'" + tenobject + "')";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                    cmd.Parameters.Add("diengiai", NpgsqlDbType.Text).Value = diengiai;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "r_finputs");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_r_diengiai(string ma, string ten)
        {
            sql = "update " + user + ".r_diengiai set ten=:ten where ma=:ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                cmd.Parameters.Add("ma", NpgsqlDbType.Text).Value = ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".r_diengiai(ma,ten) values (:ma,:ten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("ma", NpgsqlDbType.Text).Value = ma;
                    cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "r_diengiai");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_r_diengiai(string ma, string ten, decimal w)
        {
            sql = "update " + user + ".r_diengiai set ten=:ten,w=" + w + " where ma=:ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                cmd.Parameters.Add("ma", NpgsqlDbType.Text).Value = ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".r_diengiai(ma,ten,w) values (:ma,:ten," + w + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("ma", NpgsqlDbType.Text).Value = ma;
                    cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "r_diengiai");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_r_format(string ma, string ten)
        {
            sql = "update " + user + ".r_format set ten=:ten where ma=:ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                cmd.Parameters.Add("ma", NpgsqlDbType.Text).Value = ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".r_format(ma,ten) values (:ma,:ten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("ma", NpgsqlDbType.Text).Value = ma;
                    cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "r_format");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_r_report(decimal id, decimal idf, decimal stt, string ma, string ten, string diengiai, string tenfile,
            int phanhe, int loai, int kieu, string s, string f, string w, string caulenh, string g, string o, string dong, string cot,
            string ailam, int hide, int ketxuat, string sort, string sum, string sngay)
        {
            sql = "update " + user + ".r_report set idf=" + idf + ",stt=" + stt + ",ma=:ma,ten=:ten,diengiai=:diengiai,tenfile=:tenfile,phanhe=" + phanhe + ",loai=" + loai + ",kieu=" + kieu;
            sql += ",s=:s,f=:f,w=:w,sql=:caulenh,g=:g,o=:o,dong=:dong,cot=:cot,ailam=:ailam,hide=" + hide + ",ketxuat=" + ketxuat + ",sort=:sort,sum=:sum,sngay=:sngay where id=" + id;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("ma", NpgsqlDbType.Text, 50).Value = ma;
                cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                cmd.Parameters.Add("diengiai", NpgsqlDbType.Text).Value = diengiai;
                cmd.Parameters.Add("tenfile", NpgsqlDbType.Text, 50).Value = tenfile;
                cmd.Parameters.Add("s", NpgsqlDbType.Text).Value = s;
                cmd.Parameters.Add("f", NpgsqlDbType.Text).Value = f;
                cmd.Parameters.Add("w", NpgsqlDbType.Text).Value = w;
                cmd.Parameters.Add("caulenh", NpgsqlDbType.Text).Value = caulenh;
                cmd.Parameters.Add("g", NpgsqlDbType.Text).Value = g;
                cmd.Parameters.Add("o", NpgsqlDbType.Text).Value = o;
                cmd.Parameters.Add("dong", NpgsqlDbType.Text).Value = dong;
                cmd.Parameters.Add("cot", NpgsqlDbType.Text).Value = cot;
                cmd.Parameters.Add("ailam", NpgsqlDbType.Text).Value = ailam;
                cmd.Parameters.Add("sort", NpgsqlDbType.Text).Value = sort;
                cmd.Parameters.Add("sum", NpgsqlDbType.Text).Value = sum;
                cmd.Parameters.Add("sngay", NpgsqlDbType.Text).Value = sngay;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".r_report(id,idf,stt,ma,ten,diengiai,tenfile,phanhe,loai,kieu,s,f,w,sql,g,o,dong,cot,ailam,computer,hide,ketxuat,sort,sum,sngay) values (" + id + "," + idf + "," + stt + ",:ma,:ten,:diengiai,:tenfile," + phanhe + "," + loai + "," + kieu + ",:s,:f,:w,:caulenh,:g,:o,:dong,:cot,:ailam,'" + sComputer + "'," + hide + "," + ketxuat + ",:sort,:sum,:sngay)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("ma", NpgsqlDbType.Text, 50).Value = ma;
                    cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                    cmd.Parameters.Add("diengiai", NpgsqlDbType.Text).Value = diengiai;
                    cmd.Parameters.Add("tenfile", NpgsqlDbType.Text, 50).Value = tenfile;
                    cmd.Parameters.Add("s", NpgsqlDbType.Text).Value = s;
                    cmd.Parameters.Add("f", NpgsqlDbType.Text).Value = f;
                    cmd.Parameters.Add("w", NpgsqlDbType.Text).Value = w;
                    cmd.Parameters.Add("caulenh", NpgsqlDbType.Text).Value = caulenh;
                    cmd.Parameters.Add("g", NpgsqlDbType.Text).Value = g;
                    cmd.Parameters.Add("o", NpgsqlDbType.Text).Value = o;
                    cmd.Parameters.Add("dong", NpgsqlDbType.Text).Value = dong;
                    cmd.Parameters.Add("cot", NpgsqlDbType.Text).Value = cot;
                    cmd.Parameters.Add("ailam", NpgsqlDbType.Text).Value = ailam;
                    cmd.Parameters.Add("sort", NpgsqlDbType.Text).Value = sort;
                    cmd.Parameters.Add("sum", NpgsqlDbType.Text).Value = sum;
                    cmd.Parameters.Add("sngay", NpgsqlDbType.Text).Value = sngay;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "r_report");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_r_tables(decimal id, decimal idr, decimal stt, string ten, string viettat)
        {
            sql = "update " + user + ".r_tables set idr=" + idr + ",stt=" + stt + ",ten='" + ten + "',viettat='" + viettat + "' where id=" + id;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".r_tables(id,idr,stt,ten,viettat) values (" + id + "," + idr + "," + stt + ",'" + ten + "','" + viettat + "')";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "r_tables");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_r_fields(decimal id, decimal idr, decimal stt, string fie, string ten, string diengiai, decimal idf)
        {
            sql = "update " + user + ".r_fields set idr=" + idr + ",stt=" + stt + ",fie='" + fie + "',ten=:ten,diengiai=:diengiai,idf=" + idf + " where id=" + id;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                cmd.Parameters.Add("diengiai", NpgsqlDbType.Text).Value = diengiai;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".r_fields(id,idr,stt,fie,ten,diengiai,idf) values (" + id + "," + idr + "," + stt + ",'" + fie + "',:ten,:diengiai," + idf + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                    cmd.Parameters.Add("diengiai", NpgsqlDbType.Text).Value = diengiai;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "r_fields");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_r_inputs(decimal id, decimal idr, decimal stt, string fie, string ten, string diengiai, decimal loai, string tenobject)
        {
            sql = "update " + user + ".r_inputs set idr=" + idr + ",stt=" + stt + ",fie='" + fie + "',ten=:ten,diengiai=:diengiai,loai=" + loai + ",tenobject='" + tenobject + "' where id=" + id;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                cmd.Parameters.Add("diengiai", NpgsqlDbType.Text).Value = diengiai;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".r_inputs(id,idr,stt,fie,ten,diengiai,loai,tenobject) values (" + id + "," + idr + "," + stt + ",'" + fie + "',:ten,:diengiai," + loai + ",'" + tenobject + "')";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                    cmd.Parameters.Add("diengiai", NpgsqlDbType.Text).Value = diengiai;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "r_inputs");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_login(decimal id, string hoten, string userid, string password_, string nhom, string makho,
            string madoituong, string makp, string loai, int admin, int tao, int thuhoi)
        {
            sql = "update " + user + ".login set hoten=:hoten,userid=:userid,password_=:password_,nhom=:nhom,makho=:makho,";
            sql += "madoituong=:madoituong,makp=:makp,loai=:loai,admin=" + admin + ",tao=" + tao + ",thuhoi=" + thuhoi;
            sql += " where id=" + id;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("hoten", NpgsqlDbType.Text).Value = hoten;
                cmd.Parameters.Add("userid", NpgsqlDbType.Text, 20).Value = userid;
                cmd.Parameters.Add("password_", NpgsqlDbType.Text, 20).Value = password_;
                cmd.Parameters.Add("nhom", NpgsqlDbType.Text).Value = nhom;
                cmd.Parameters.Add("makho", NpgsqlDbType.Text).Value = makho;
                cmd.Parameters.Add("madoituong", NpgsqlDbType.Text).Value = madoituong;
                cmd.Parameters.Add("makp", NpgsqlDbType.Text).Value = makp;
                cmd.Parameters.Add("loai", NpgsqlDbType.Text).Value = loai;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".login(id,hoten,userid,password_,nhom,makho,madoituong,makp,loai,admin,tao,thuhoi) values (" + id + ",:hoten,:userid,:password_,:nhom,:makho,:madoituong,:makp,:loai," + admin + "," + tao + "," + thuhoi + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("hoten", NpgsqlDbType.Text).Value = hoten;
                    cmd.Parameters.Add("userid", NpgsqlDbType.Text, 20).Value = userid;
                    cmd.Parameters.Add("password_", NpgsqlDbType.Text, 20).Value = password_;
                    cmd.Parameters.Add("nhom", NpgsqlDbType.Text).Value = nhom;
                    cmd.Parameters.Add("makho", NpgsqlDbType.Text).Value = makho;
                    cmd.Parameters.Add("madoituong", NpgsqlDbType.Text).Value = madoituong;
                    cmd.Parameters.Add("makp", NpgsqlDbType.Text).Value = makp;
                    cmd.Parameters.Add("loai", NpgsqlDbType.Text).Value = loai;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "login");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_right(decimal id, decimal phanhe, string right_)
        {
            sql = "update " + user + ".right set right_=:right_ where id=" + id + " and phanhe=" + phanhe;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("right_", NpgsqlDbType.Text).Value = right_;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".right(id,phanhe,right_) values (" + id + "," + phanhe + ",:right_)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("right_", NpgsqlDbType.Text).Value = right_;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "right");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_menubar(decimal id, int phanhe, decimal stt, int loai, string ten)
        {
            sql = "update " + user + ".menubar set phanhe=" + phanhe + ",stt=" + stt + ",loai=" + loai + ",ten=:ten where id=" + id;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".menubar(id,phanhe,stt,loai,ten) values (" + id + "," + phanhe + "," + stt + "," + loai + ",:ten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "menubar");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_menuloai(decimal id, int phanhe, decimal stt, string ten)
        {
            sql = "update " + user + ".menuloai set phanhe=" + phanhe + ",stt=" + stt + ",ten=:ten where id=" + id;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".menuloai(id,phanhe,stt,ten) values (" + id + "," + phanhe + "," + stt + ",:ten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "menuloai");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public string getyymmddhhmisslocalhost()
        {
            return DateTime.Now.Year.ToString().PadLeft(4, '0').Substring(2, 2) + DateTime.Now.Month.ToString().PadLeft(2, '0') + DateTime.Now.Day.ToString().PadLeft(2, '0') + DateTime.Now.Hour.ToString().PadLeft(2, '0') + DateTime.Now.Minute.ToString().PadLeft(2, '0') + DateTime.Now.Second.ToString().PadLeft(2, '0');
        }

        public decimal getidyymmddhhmiss_stt_computer_localhost_mabv
        {
            get
            {
                return decimal.Parse(getyymmddhhmisslocalhost() + getRandom().ToString().PadLeft(3, '0') + iRownum.ToString().PadLeft(3, '0') + Mabv_so.ToString().PadLeft(6, '0'));
            }
        }

        public decimal getidyymmddhhmiss_stt_computer_localhost
        {
            get
            {
                return decimal.Parse(getyymmddhhmisslocalhost() + getRandom().ToString().PadLeft(3, '0') + iRownum.ToString().PadLeft(3, '0'));
            }
        }
        #endregion

        public string getkho(int i_thuoc, int i_nhom, bool bThua, DataTable dtmakp, int i_makp, int i_loai, string ngay, DataTable dtletet)
        {
            string s_makho = "", s_kho = "", s_ngay = ngay, s_khong = "", s_khong1 = "";//, s_nguon_khoa = "";
            DataRow r;
            bool bPhatthuoc_kho = bPhatthuoc_kho_khoa;
            string sPhatthuoc_kho = sPhatthuoc_kho_khoa, s_khophat = iPhatthuoc_kho_khoa.ToString() + ",";
            string s_khophat2 = iPhatthuoc_kho_khoa2.ToString().ToString() + ",";
            string s_khoa_tua = sPhatthuoc_k_tua, s_kho_tua = iPhatthuoc_k_tua.ToString() + ",";

            sql = "select * from " + user + ".d_dmkho where nhom=" + i_nhom;
            if (i_thuoc == 1) sql += " and loai=" + i_thuoc;
            if (bThua) sql += " and thua=1";
            else
            {
                r = getrowbyid(dtmakp, "id=" + i_makp);
                if (r != null)
                {
                    s_kho = r["makho"].ToString();//kho trong khai bao khoa phong
                    s_khong = "," + s_kho;
                    //s_nguon_khoa = r["nguon"].ToString();
                }
                s_makho = get_data("select kho from " + user + ".d_dmphieu where id=" + i_loai).Tables[0].Rows[0][0].ToString();
                s_khong1 = "," + s_makho;
                int hh1, hh2, hh3, mm1, mm2, mm3, hh4, hh5, hh6, mm4, mm5, mm6;
                string kho = "";
                s_ngay = ngay;
                r = getrowbyid(dtletet, "ngay='" + s_ngay.Substring(0, 5) + "'");
                bool bLetet = r != null;
                hh3 = int.Parse(sGiobaocao.Substring(0, 2));
                mm3 = int.Parse(sGiobaocao.Substring(3, 2));
                hh4 = int.Parse(sGiotrua_tu.Substring(0, 2));
                mm4 = int.Parse(sGiotrua_tu.Substring(3, 2));
                hh5 = int.Parse(sGiotrua_den.Substring(0, 2));
                mm5 = int.Parse(sGiotrua_den.Substring(3, 2));
                hh6 = int.Parse(sGiochunhat.Substring(0, 2));
                mm6 = int.Parse(sGiochunhat.Substring(3, 2));
                DateTime dt = (bNgoaigio_ylenh) ? StringToDate(s_ngay.Substring(0, 10)) : StringToDate(ngayhienhanh_server.Substring(0, 10));
                string ddd = dt.DayOfWeek.ToString().Substring(0, 3);
                if (i_loai == 1 && i_nhom == nhom_duoc && s_makho != "" && (gio_linh != "00:00" || sGiochunhat != "00:00") && (sGiotrua_tu != sGiotrua_den))
                {
                    hh1 = int.Parse(s_ngay.Substring(11, 2));
                    mm1 = int.Parse(s_ngay.Substring(14, 2));
                    hh2 = int.Parse(gio_linh.Substring(0, 2));
                    mm2 = int.Parse(gio_linh.Substring(3, 2));
                    kho = kho_linh.Trim().Trim(',');//lay ma kho ngoai trong khai bao he thong
                    if (kho != "") kho += ",";
                    if (gio_linh != "00:00")
                    {
                        if (hh6 != 0 || mm6 != 0)
                        {
                            if (bLetet
                                || ((ddd == "Sat") && (hh1 > hh6 || (hh1 == hh6 && mm1 > mm6)))
                                || ((ddd == "Sun") && (hh1 > hh6 || (hh1 == hh6 && mm1 > mm6)))
                                || hh1 > hh2 || (hh1 == hh2 && mm1 > mm2) || hh1 < hh3 || (hh1 == hh3 && mm1 < mm3)
                                || ((ddd != "Sat" || ddd != "Sun") && (hh1 > hh4 || (hh1 == hh4 && mm1 > mm4)) && (hh1 < hh5 || (hh1 == hh5 && mm1 < mm5))))
                            {
                                s_makho = kho;//s_makho: kho duoc tinh trong khai bao nhom phieu; ngoai gio: lay kho ngoai gio trong khai bao he thong
                                s_kho = kho;// "";
                            }
                            else
                            {
                                if (kho != "" && s_makho != "") s_makho = remove_text(s_makho, kho);//s_makho = s_makho.Remove(s_makho.IndexOf(kho), kho.Length);// && s_makho.IndexOf(kho) != -1
                                if (kho != "" && s_kho != "") s_kho = remove_text(s_kho, kho); // s_kho = s_kho.Remove(s_kho.IndexOf(kho), kho.Length);//&& s_kho.IndexOf(kho) != -1
                            }
                        }
                        else if (bLetet || ddd == "Sat" || ddd == "Sun" || hh1 > hh2 || (hh1 == hh2 && mm1 > mm2) || hh1 < hh3 || (hh1 == hh3 && mm1 < mm3)
                            || ((ddd != "Sat" || ddd != "Sun") && (hh1 > hh4 || (hh1 == hh4 && mm1 > mm4)) && (hh1 < hh5 || (hh1 == hh5 && mm1 < mm5))))
                        {
                            s_makho = kho;
                            s_kho = kho;// "";
                        }
                        else
                        {
                            if (kho != "" && s_makho != "") s_makho = remove_text(s_makho, kho);// s_makho = s_makho.Remove(s_makho.IndexOf(kho), kho.Length);//&& s_makho.IndexOf(kho) != -1
                            if (kho != "" && s_kho != "") s_kho = remove_text(s_kho, kho); //s_kho = s_kho.Remove(s_kho.IndexOf(kho), kho.Length);// && s_kho.IndexOf(kho) != -1
                        }
                    }
                    else
                    {
                        if (bLetet || ddd == "Sat" || ddd == "Sun"
                            || ((ddd == "Fri") && (hh1 > hh6 || (hh1 == hh6 && mm1 > mm6)))
                            || ((ddd == "Mon") && (hh1 < hh3 || (hh1 == hh3 && mm1 < mm3))))
                        {
                            s_makho = kho;
                            s_kho = kho;// "";
                        }
                        else
                        {
                            if (kho != "" && s_makho != "") s_makho = remove_text(s_makho, kho); //s_makho = s_makho.Remove(s_makho.IndexOf(kho), kho.Length);//&& s_makho.IndexOf(kho) != -1
                            if (kho != "" && s_kho != "") s_kho = remove_text(s_kho, kho); //s_kho = s_kho.Remove(s_kho.IndexOf(kho), kho.Length);// && s_kho.IndexOf(kho) != -1
                        }
                    }
                }
                /*else if (i_loai == 1 && bPhieulinh_chanle)
                {
                    int ngaycl = (bNgoaigio_ylenh) ? int.Parse(s_ngay.Substring(0, 2)) : int.Parse(ngayhienhanh_server.Substring(0, 2));
                    s_makho = (ngaycl % 2 == 0) ? Kho_ngaychan : Kho_ngayle;
                    s_kho = "";
                }*/
                else if (i_loai != 2 && bPhatthuoc_kho)
                {
                    /*if (s_khoa_tua.IndexOf(i_makp.ToString().PadLeft(3, '0')) == -1) s_kho = "";
                    else s_makho = "";*/
                    //19042009
                    int khon = 0;
                    string sql1;
                    string stime = (ngay.Length == 10) ? "'dd/mm/yyyy'" : "'dd/mm/yyyy hh24:mi'";
                    sql1 = "select * from " + user + ".d_khonghi where " + for_ngay("tu", stime) + "<=to_date('" + ngay + "'," + stime + ")";
                    sql1 += " and " + for_ngay("den", stime) + ">=to_date('" + ngay + "'," + stime + ")";
                    if (s_makho != "") sql1 += " and makho in (" + s_makho.Substring(0, s_makho.Length - 1) + ")";
                    foreach (DataRow r1 in get_data(sql1).Tables[0].Rows)
                    {
                        khon = int.Parse(r1["makho"].ToString());
                        break;
                    }
                    //s_kho = "";
                    if (khon != 0) sql += " and id not in (" + khon.ToString().Substring(0, khon.ToString().Length) + ")";
                    else
                    {
                        if (sPhatthuoc_kho.IndexOf(i_makp.ToString().PadLeft(3, '0')) != -1)
                            sql += " and id not in (" + s_khophat2.Substring(0, s_khophat2.Length - 1) + ")";//s_makho = s_khophat;
                        else if (s_khophat.Length > 1)
                            sql += " and id not in (" + s_khophat.Substring(0, s_khophat.Length - 1) + ")";
                    }
                }
                //add them kho khong loc theo gio
                foreach (DataRow r1 in get_data("select * from " + user + ".d_dmkho where ngoaigio=0 and nhom=" + i_nhom).Tables[0].Rows)
                    if (s_khong.IndexOf("," + r1["id"].ToString() + ",") != -1 && s_khong1.IndexOf("," + r1["id"].ToString() + ",") != -1) { s_makho += r1["id"].ToString() + ","; s_kho += r1["id"].ToString() + ","; }
                //
                if (s_makho.Trim().Trim(',') != "") sql += " and id in (" + s_makho.Trim().Trim(',') + ")"; //s_makho.Substring(0, s_makho.Length - 1) + ")";
                if (s_kho.Trim().Trim(',') != "") sql += " and id in (" + s_kho.Trim().Trim(',') + ")";//s_kho.Substring(0, s_kho.Length - 1) + ")";
            }
            sql += " order by stt";
            return sql;
        }

        public bool upd_ba_khambenh(string ngay, decimal maql, string benhsu, string tiensu, string toanthan, string bophan)
        {
            string xxx = user + mmyy(ngay);
            sql = "update " + xxx + ".ba_khambenh set benhsu='" + benhsu + "',tiensu='" + tiensu + "',toanthan='" + toanthan + "',bophan='" + bophan + "' where maql=" + maql;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_khambenh(maql,benhsu,tiensu,toanthan,bophan) values (" + maql + ",'" + benhsu + "','" + tiensu + "','" + toanthan + "','" + bophan + "')";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ngay, ex.Message, sComputer, "ba_khambenh");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_tiepdon_hen(string m_mabn, decimal m_mavaovien, decimal m_maql, string m_makp, string m_ngay,
            int m_madoituong, string m_sovaovien, string m_tuoivao, int m_userid, int m_bnmoi, int m_noitiepdon,
            int m_loai, string m_ngayhen)
        {
            sql = "update " + user + ".tiepdon set mabn='" + m_mabn + "',mavaovien=" + m_mavaovien + ",maql=" + m_maql + ",makp='" + m_makp + "',";
            sql += " ngay=to_timestamp('" + m_ngay + "','dd/mm/yyyy hh24:mi'),madoituong=" + m_madoituong + ",sovaovien='" + m_sovaovien + "',";
            sql += " tuoivao='" + m_tuoivao + "',userid=" + m_userid + ",bnmoi=" + m_bnmoi + ",noitiepdon=" + m_noitiepdon + ",loai=" + m_loai + ",";
            sql += " ngayhen=to_timestamp('" + m_ngayhen + "','dd/mm/yyyy hh24:mi') where maql=" + m_maql;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".tiepdon(mabn,mavaovien,maql,makp,ngay,madoituong,sovaovien,tuoivao,userid,";
                    sql += "bnmoi,noitiepdon,loai,ngayhen) values ('" + m_mabn + "'," + m_mavaovien + "," + m_maql + ",'" + m_makp + "',";
                    sql += "to_timestamp('" + m_ngay + "','dd/mm/yyyy hh24:mi')," + m_madoituong + ",'" + m_sovaovien + "','" + m_tuoivao + "'," + m_userid + ",";
                    sql += m_bnmoi + "," + m_noitiepdon + "," + m_loai + ",to_timestamp('" + m_ngayhen + "','dd/mm/yyyy hh24:mi'))";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "tiepdon");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public void upd_hen(string ngay)
        {
            string usr = user;
            bool btaikham_v_chidinh = bTaikham_v_chidinh;
            DataTable dtkpfull = new DataTable();
            DataTable dtgia = new DataTable();
            DataTable dtdt = new DataTable();
            if (btaikham_v_chidinh)
            {
                dtkpfull = get_data("select * from " + user + ".btdkp_bv").Tables[0];
                dtgia = get_data("select * from " + user + ".v_giavp").Tables[0];
                dtdt = get_data("select * from " + user + ".doituong ").Tables[0];
            }
            sql = "select a.*,to_char(a.ngay,'dd/mm/yyyy hh24:mi') as ngayvao,coalesce(b.sothe,' ') as sothe,";
            sql += "to_char(b.tungay,'dd/mm/yyyy') as tungay,to_char(b.denngay,'dd/mm/yyyy') as denngay,b.mabv,";
            sql += " coalesce(b.maphu,0) as maphu,c.sonha,c.thon,c.cholam,c.matt,c.maqu,c.maphuongxa,c.soluutru,c.honnhan,c.mabs, ";
            sql += "to_char(b.ngay1,'dd/mm/yyyy') as ngay1,to_char(b.ngay2,'dd/mm/yyyy') as ngay2,to_char(b.ngay3,'dd/mm/yyyy') as ngay3,b.traituyen";
            sql += " from " + usr + ".tiepdon a left join " + usr + ".bhyt b on a.maql=b.maql ";
            sql += " left join " + usr + ".lienhe c on a.maql=c.maql ";
            sql += " where to_char(a.ngay,'dd/mm/yyyy')='" + ngay.Substring(0, 10) + "' order by a.maql";
            try
            {
                foreach (DataRow r in get_data(sql).Tables[0].Rows)
                {
                    upd_tiepdon(r["mabn"].ToString(), decimal.Parse(r["mavaovien"].ToString()), decimal.Parse(r["maql"].ToString()),
                        r["makp"].ToString(), r["ngayvao"].ToString(), int.Parse(r["madoituong"].ToString()), r["sovaovien"].ToString(),
                        r["tuoivao"].ToString(), int.Parse(r["userid"].ToString()), int.Parse(r["bnmoi"].ToString()), int.Parse(r["noitiepdon"].ToString()), int.Parse(r["loai"].ToString()));
                    if (r["sothe"].ToString().Trim() != "")
                        upd_bhyt(r["ngayvao"].ToString(), r["mabn"].ToString(), decimal.Parse(r["maql"].ToString()), r["sothe"].ToString(), r["denngay"].ToString(), r["mabv"].ToString(), int.Parse(r["maphu"].ToString()), r["tungay"].ToString(), r["ngay1"].ToString(), r["ngay2"].ToString(), r["ngay3"].ToString(), int.Parse(r["traituyen"].ToString()));
                    upd_lienhe(r["ngayvao"].ToString(), decimal.Parse(r["maql"].ToString()), r["sonha"].ToString(), r["thon"].ToString(), r["cholam"].ToString(),
                        r["matt"].ToString(), r["maqu"].ToString(), r["maphuongxa"].ToString(), r["tuoivao"].ToString(), int.Parse(r["loai"].ToString()), int.Parse(r["bnmoi"].ToString()));
                    if (btaikham_v_chidinh) upd_data(dtkpfull, dtgia, dtdt, r["mabn"].ToString(), decimal.Parse(r["maql"].ToString()), decimal.Parse(r["mavaovien"].ToString()), int.Parse(r["madoituong"].ToString()), r["makp"].ToString(), r["ngayvao"].ToString(), int.Parse(r["userid"].ToString()));
                    execute_data("delete from " + usr + ".tiepdon where maql=" + decimal.Parse(r["maql"].ToString()));
                    if (r["sothe"].ToString().Trim() != "")
                        execute_data("delete from " + usr + ".bhyt where maql=" + decimal.Parse(r["maql"].ToString()));
                    execute_data("delete from " + usr + ".lienhe where maql=" + decimal.Parse(r["maql"].ToString()));
                }
            }
            catch { }
        }

        private void upd_data(DataTable dtkpfull, DataTable dtgia, DataTable dtdt, string mabn, decimal maql, decimal matd, int madoituong, string makhoa, string ngay, int i_userid)
        {
            LibVienphi.AccessData v = new LibVienphi.AccessData();
            DataRow r = getrowbyid(dtkpfull, "makp='" + makhoa + "'");
            if (r != null)
            {
                int _mavp = int.Parse(r["mavp"].ToString());
                decimal d_dongia = 0, d_vattu = 0;
                r = getrowbyid(dtgia, "id=" + _mavp);
                if (r != null)
                {
                    decimal l_id = get_id_chidinh(ngay, maql, _mavp, v.iNgoaitru);
                    if (l_id == 0) l_id = v.get_id_chidinh;
                    if (bNuocngoai(mabn))
                    {
                        d_dongia = decimal.Parse(r["gia_nn"].ToString()) * dTygia;
                        d_vattu = decimal.Parse(r["vattu_nn"].ToString()) * dTygia;
                    }
                    else
                    {
                        string gia = field_gia(madoituong.ToString());
                        string giavt = "vattu_" + gia.Substring(4).Trim();
                        d_dongia = decimal.Parse(r[gia].ToString());
                        d_vattu = decimal.Parse(r[giavt].ToString());
                    }
                    v.upd_chidinh(l_id, mabn, matd, maql, 0, ngay, v.iNgoaitru, makhoa, madoituong, _mavp, 1, d_dongia, d_vattu, i_userid, 0, 0, l_id, "", "", "", 3, "");
                    r = getrowbyid(dtdt, "mien=0 and trasau=0 and madoituong=" + madoituong);
                    if (bThuphi_kham && r != null)
                        execute_data("update " + user + mmyy(ngay) + ".tiepdon set done='x' where maql=" + maql);
                }
            }
        }

        public DataTable getChidinh(string ngay, decimal id)
        {
            if (!bMmyy(mmyy(ngay))) return null;
            else return get_data("select * from " + user + mmyy(ngay) + ".v_chidinh where id=" + id).Tables[0];
        }

        public DataTable getChidinh_chenhlech_dathanhtoan(string ngay, decimal maql, int mavp, decimal m_id)
        {
            if (!bMmyy(mmyy(ngay))) return null;
            else
            {
                sql = "select * from " + user + mmyy(ngay) + ".v_chidinh where to_char(ngay,'dd/mm/yyyy')='" + ngay.Substring(0, 10) + "' and paid=1 and mavp=" + mavp + " and maql=" + maql + " and madoituong=" + iTunguyen;
                if (m_id != 0) sql += " and id=" + m_id;
                return get_data(sql).Tables[0];
            }
        }
        public DataTable getChidinh_chenhlech_dathanhtoan(string ngay, decimal maql, int mavp)
        {
            if (!bMmyy(mmyy(ngay))) return null;
            else
            {
                sql = "select * from " + user + mmyy(ngay) + ".v_chidinh where to_char(ngay,'dd/mm/yyyy')='" + ngay.Substring(0, 10) + "' and paid=1 and mavp=" + mavp + " and maql=" + maql + " and madoituong=" + iTunguyen;
                return get_data(sql).Tables[0];
            }
        }
        public bool upd_tinnhan(string ten, string phanhe, int trangthai)
        {
            return execute_data("update " + user + ".dmcomputer set " + phanhe + "=" + trangthai + " where computer='" + ten + "'");
        }

        public void get_tinnhan(string ten, string phanhe)
        {
            string file = "";
            DataTable tmp = get_data("select * from " + user + ".dmcomputer where computer='" + ten + "' and " + phanhe + "=1").Tables[0];
            if (tmp.Rows.Count > 0)
            {
                file = "..//..//..//data//mes//" + tmp.Rows[0]["f" + phanhe].ToString() + ".wav";
                if (System.IO.File.Exists(file))
                {
                    upd_tinnhan(ten, phanhe, 0);
                    PlaySound(file, 0, 1);
                }
            }
        }

        public bool upd_benhmantinh(string m_mabn, string m_chandoan, string m_maicd, string m_ghichu, int m_userid)
        {
            sql = "update " + user + ".benhmantinh set chandoan='" + m_chandoan + "',ghichu='" + m_ghichu + "'";
            sql += " where mabn='" + m_mabn + "' and maicd='" + m_maicd + "'";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".benhmantinh(mabn,chandoan,maicd,ghichu,userid) ";
                    sql += " values ('" + m_mabn + "','" + m_chandoan + "','" + m_maicd + "','" + m_ghichu + "'," + m_userid + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "benhmantinh");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        //Tu :23/06/2011
        public bool upd_benhmantinh(string m_mabn, string m_chandoan, string m_maicd, string m_ghichu, int m_userid,
            string m_ngay)
        {
            sql = "update " + user + ".benhmantinh set chandoan='" + m_chandoan + "',ghichu='" + m_ghichu + "'";
            sql += ",ngay=to_date(:m_ngay,'dd/mm/yyyy') ";
            sql += " where mabn='" + m_mabn + "' and maicd='" + m_maicd + "'";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".benhmantinh(mabn,chandoan,maicd,ghichu,userid,ngay) ";
                    sql += " values ('" + m_mabn + "','" + m_chandoan + "','" + m_maicd + "','" + m_ghichu + "'," + m_userid + ",to_date(" + m_ngay + ",'dd/mm/yyyy'))";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "benhmantinh");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        //end Tu

        public bool upd_dmtheodoi(decimal m_id, decimal m_stt, string m_ten)
        {
            sql = "update " + user + ".dmtheodoi set stt=:m_stt,ten=:m_ten where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dmtheodoi (id,stt,ten) values (:m_id,:m_stt,:m_ten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dmtheodoi");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_theodoitsu(string m_mabn, string m_noidung, string m_ngay, string m_maicd, int m_stt)
        {
            sql = "update " + user + ".theodoitsu set noidung=:m_noidung,ngay=to_date(:m_ngay,'dd/mm/yyyy'),stt=:m_stt ";
            sql += "where mabn=:m_mabn and maicd=:m_maicd";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_noidung", NpgsqlDbType.Text).Value = m_noidung;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar).Value = m_ngay;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar).Value = m_maicd;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".theodoitsu (mabn,noidung,stt,ngay,maicd) values (:m_mabn,:m_noidung,:m_stt,to_date(:m_ngay,'dd/mm/yyyy'),:m_maicd)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_noidung", NpgsqlDbType.Text).Value = m_noidung;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar).Value = m_ngay;
                    cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar).Value = m_maicd;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "theodoitsu");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public string Ngaydemo(string tenfile)
        {
            try
            {
                DataSet ds = get_data("select ten from " + user + ".thongso where id=-3");
                if (ds.Tables[0].Rows.Count > 0)
                {
                    if (ds.Tables[0].Rows[0]["ten"].ToString() != "") return ds.Tables[0].Rows[0]["ten"].ToString();
                    else return f_modify(file_exe(tenfile)).ToString().Substring(0, 10);
                }
                else return "";
            }
            catch { return ""; }
        }

        public int Songaydemo
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=-4");
                    if (ds.Tables[0].Rows.Count > 0)
                    {
                        if (ds.Tables[0].Rows[0]["ten"].ToString() != "") return int.Parse(ds.Tables[0].Rows[0]["ten"].ToString());
                        else return 30;
                    }
                    else return 0;
                }
                catch { return 0; }
            }
        }
        //Lấy giá trị hiện tại của hệ thống ngày giờ
        private void get_current()
        {
            try
            {
                //
                DataSet lds = new DataSet();
                if (File.Exists("..//..//..//xml//date_format.xml") == false)
                {
                    DataTable ldt = new DataTable();
                    ldt.TableName = "t_date";
                    ldt.Columns.Add("sShortDate");
                    ldt.Columns.Add("sLongDate");
                    ldt.Columns.Add("sDecimal");
                    ldt.Columns.Add("sThousand");
                    ldt.Columns.Add("sNegativeSign");
                    ldt.Columns.Add("iLZero");
                    ldt.Columns.Add("sTime");
                    ldt.Columns.Add("sDate");
                    ldt.Columns.Add("sTimeFormat");
                    ldt.Columns.Add("s1159");
                    ldt.Columns.Add("s2359");
                    //
                    DataRow dr = ldt.NewRow();
                    dr[0] = " ";
                    dr[1] = " ";
                    dr[2] = " ";
                    dr[3] = " ";
                    dr[4] = " ";
                    dr[5] = " ";
                    dr[6] = " ";
                    dr[7] = " ";
                    dr[8] = " ";
                    dr[9] = " ";
                    dr[10] = " ";
                    ldt.Rows.Add(dr);
                    ldt.AcceptChanges();
                    //
                    lds.Tables.Add(ldt);
                    lds.AcceptChanges();
                    lds.WriteXml("..//..//..//xml//date_format.xml");
                    lds.Dispose();
                }
                lds.ReadXml("..//..//..//xml//date_format.xml");
                lds.Tables[0].Clear();
                //
                string path = "Control Panel//International";
                RegistryKey k = Registry.CurrentUser;//chỉ ảnh hưởng user hiện tại
                k = k.OpenSubKey(path, true);
                DataRow r = lds.Tables[0].NewRow();

                r["sShortDate"] = k.GetValue("sShortDate").ToString();//ngày kiểu shortdate
                r["sLongDate"] = k.GetValue("sLongDate").ToString();//, "dddd, MMMM dd, yyyy");//ngày kiểu longdate
                r["sDecimal"] = k.GetValue("sDecimal").ToString();//, ".");//giá trị thập phân
                r["sThousand"] = k.GetValue("sThousand").ToString();//, ",");//dấu nhóm chữ số 1,000,000
                r["sNegativeSign"] = k.GetValue("sNegativeSign").ToString();//, "-");//ký hiệu âm
                r["iLZero"] = k.GetValue("iLZero").ToString();//, "0");// 1:có '0' đứng trước 0.7; 0 ngược lại

                r["sTime"] = k.GetValue("sTime").ToString();//, ":");//dấu cách giữ hh:mm:ss
                r["sDate"] = k.GetValue("sDate").ToString();//, "/");//dấu cách giữ MM/dd/yyyy
                r["sTimeFormat"] = k.GetValue("sTimeFormat").ToString();//, "hh:mm:ss tt");//định định dạng thời gian
                r["s1159"] = k.GetValue("s1159").ToString();//, "AM");//buổi sáng
                r["s2359"] = k.GetValue("s2359").ToString();//, "PM");//buổi chiều				

                lds.Tables[0].Rows.Add(r);
                lds.AcceptChanges();
                lds.WriteXml("..//..//..//xml//date_format.xml");

                k.Flush();

                lds.Dispose();
            }
            catch
            { }
        }

        //set hệ thống ngày giờ theo quy định của chương trình
        public void setStandar()
        {
            get_current();
            try
            {
                string path = "Control Panel//International";
                RegistryKey k = Registry.CurrentUser;//chỉ ảnh hưởng user hiện tại
                k = k.OpenSubKey(path, true);
                k.SetValue("sShortDate", "MM/dd/yyyy");//ngày kiểu shortdate
                k.SetValue("sLongDate", "dddd, MMMM dd, yyyy");//ngày kiểu longdate
                k.SetValue("sDecimal", ".");//giá trị thập phân
                k.SetValue("sThousand", ",");//dấu nhóm chữ số 1,000,000
                k.SetValue("sNegativeSign", "-");//ký hiệu âm
                k.SetValue("iLZero", "0");// 1:có '0' đứng trước 0.7; 0 ngược lại

                k.SetValue("sTime", ":");//dấu cách giữ hh:mm:ss
                k.SetValue("sDate", "/");//dấu cách giữ MM/dd/yyyy
                k.SetValue("sTimeFormat", "hh:mm:ss tt");//định định dạng thời gian
                k.SetValue("s1159", "AM");//buổi sáng
                k.SetValue("s2359", "PM");//buổi chiều

                k.Flush();
            }
            catch
            { }
        }

        //trả lại ngày giờ hệ thống của máy lúc đầu.
        public void set_current()
        {
            try
            {
                string path = "Control Panel//International";
                RegistryKey k = Registry.CurrentUser;//chỉ ảnh hưởng user hiện tại
                k = k.OpenSubKey(path, true);
                //
                //
                DataSet lds = new DataSet();
                lds.ReadXml("..//..//..//xml//date_format.xml");
                foreach (DataRow r in lds.Tables[0].Rows)
                {
                    //
                    k.SetValue("sShortDate", (r["sShortDate"].ToString() != "") ? r["sShortDate"].ToString() : "MM/dd/yyyy");//ngày kiểu shortdate
                    k.SetValue("sLongDate", (r["sLongDate"].ToString() != "") ? r["sLongDate"].ToString() : "dddd, MMMM dd, yyyy");//ngày kiểu longdate
                    k.SetValue("sDecimal", (r["sDecimal"].ToString() != "") ? r["sDecimal"].ToString() : ".");//giá trị thập phân
                    k.SetValue("sThousand", (r["sThousand"].ToString() != "") ? r["sThousand"].ToString() : ",");//dấu nhóm chữ số 1,000,000
                    k.SetValue("sNegativeSign", (r["sNegativeSign"].ToString() != "") ? r["sNegativeSign"].ToString() : "-");//ký hiệu âm
                    k.SetValue("iLZero", (r["iLZero"].ToString() != "") ? r["iLZero"].ToString() : "0");// 1:có '0' đứng trước 0.7; 0 ngược lại

                    k.SetValue("sTime", (r["sTime"].ToString() != "") ? r["sTime"].ToString() : ":");//dấu cách giữ hh:mm:ss
                    k.SetValue("sDate", (r["sDate"].ToString() != "") ? r["sDate"].ToString() : "/");//dấu cách giữ MM/dd/yyyy
                    k.SetValue("sTimeFormat", (r["sTimeFormat"].ToString() != "") ? r["sTimeFormat"].ToString() : "hh:mm:ss tt");//định định dạng thời gian
                    k.SetValue("s1159", (r["s1159"].ToString() != "") ? r["s1159"].ToString() : "AM");//buổi sáng
                    k.SetValue("s2359", (r["s2359"].ToString() != "") ? r["s2359"].ToString() : "PM");//buổi chiều

                    k.Flush();
                    break;
                }
            }
            catch
            { }
        }

        public bool upd_dmthe(string sothe, string mathe, string madt, string makcb, string hoten, string namsinh,
            int gioitinh, string diachi, string matt, string maqu, string maphuongxa, string cholam, string tungay, string denngay, string mabv)
        {
            string usr = user;
            sql = "update " + usr + ".dmthe set mathe=:mathe,madt=:madt,makcb=:makcb,hoten=:hoten,namsinh=:namsinh,";
            sql += "gioitinh=" + gioitinh + ",diachi=:diachi,matt=:matt,maqu=:maqu,maphuongxa=:maphuongxa,cholam=:cholam";
            if (tungay != "") sql += ",tungay=to_date(:tungay,'dd/mm/yyyy')";
            if (denngay != "") sql += ",denngay=to_date(:denngay,'dd/mm/yyyy')";
            sql += ",mabv=:mabv ";
            sql += " where sothe=:sothe";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("mathe", NpgsqlDbType.Varchar, 13).Value = mathe;
                cmd.Parameters.Add("madt", NpgsqlDbType.Varchar, 2).Value = madt;
                cmd.Parameters.Add("makcb", NpgsqlDbType.Varchar, 5).Value = makcb;
                cmd.Parameters.Add("hoten", NpgsqlDbType.Text, 70).Value = hoten;
                cmd.Parameters.Add("namsinh", NpgsqlDbType.Varchar, 4).Value = namsinh;
                cmd.Parameters.Add("diachi", NpgsqlDbType.Text, 150).Value = diachi;
                cmd.Parameters.Add("matt", NpgsqlDbType.Varchar, 3).Value = matt;
                cmd.Parameters.Add("maqu", NpgsqlDbType.Varchar, 5).Value = maqu;
                cmd.Parameters.Add("maphuongxa", NpgsqlDbType.Varchar, 7).Value = maphuongxa;
                cmd.Parameters.Add("cholam", NpgsqlDbType.Text, 150).Value = cholam;
                if (tungay != "") cmd.Parameters.Add("tungay", NpgsqlDbType.Varchar, 10).Value = tungay;
                if (denngay != "") cmd.Parameters.Add("denngay", NpgsqlDbType.Varchar, 10).Value = denngay;
                cmd.Parameters.Add("mabv", NpgsqlDbType.Varchar, 10).Value = mabv;
                cmd.Parameters.Add("sothe", NpgsqlDbType.Varchar, 20).Value = sothe;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + usr + ".dmthe(sothe,mathe,madt,makcb,hoten,namsinh,gioitinh,diachi,matt,maqu,maphuongxa,cholam";
                    if (tungay != "") sql += ",tungay";
                    if (denngay != "") sql += ",denngay";
                    sql += ",mabv) values (:sothe,:mathe,:madt,:makcb,:hoten,:namsinh," + gioitinh + ",:diachi,:matt,:maqu,:maphuongxa,:cholam";
                    if (tungay != "") sql += ",to_date(:tungay,'dd/mm/yyyy')";
                    if (denngay != "") sql += ",to_date(:denngay,'dd/mm/yyyy')";
                    sql += ",:mabv)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("sothe", NpgsqlDbType.Varchar, 20).Value = sothe;
                    cmd.Parameters.Add("mathe", NpgsqlDbType.Varchar, 13).Value = mathe;
                    cmd.Parameters.Add("madt", NpgsqlDbType.Varchar, 2).Value = madt;
                    cmd.Parameters.Add("makcb", NpgsqlDbType.Varchar, 5).Value = makcb;
                    cmd.Parameters.Add("hoten", NpgsqlDbType.Text, 70).Value = hoten;
                    cmd.Parameters.Add("namsinh", NpgsqlDbType.Varchar, 4).Value = namsinh;
                    cmd.Parameters.Add("diachi", NpgsqlDbType.Text, 150).Value = diachi;
                    cmd.Parameters.Add("matt", NpgsqlDbType.Varchar, 3).Value = matt;
                    cmd.Parameters.Add("maqu", NpgsqlDbType.Varchar, 5).Value = maqu;
                    cmd.Parameters.Add("maphuongxa", NpgsqlDbType.Varchar, 7).Value = maphuongxa;
                    cmd.Parameters.Add("cholam", NpgsqlDbType.Text, 150).Value = cholam;
                    if (tungay != "") cmd.Parameters.Add("tungay", NpgsqlDbType.Varchar, 10).Value = tungay;
                    if (denngay != "") cmd.Parameters.Add("denngay", NpgsqlDbType.Varchar, 10).Value = denngay;
                    cmd.Parameters.Add("mabv", NpgsqlDbType.Varchar, 10).Value = mabv;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, sothe);
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_dmthe(string mabn, string sothe, string hoten, string namsinh,
            int gioitinh, string diachi, string matt, string maqu, string maphuongxa, string cholam, string tungay, string denngay, string mabv)
        {
            string usr = user;
            sql = "update " + usr + ".dmthe set mabn=:mabn,hoten=:hoten,namsinh=:namsinh,";
            sql += "gioitinh=" + gioitinh + ",diachi=:diachi,matt=:matt,maqu=:maqu,maphuongxa=:maphuongxa,cholam=:cholam";
            if (tungay != "") sql += ",tungay=to_date(:tungay,'dd/mm/yyyy')";
            if (denngay != "") sql += ",denngay=to_date(:denngay,'dd/mm/yyyy')";
            sql += " ,mabv=:mabv where sothe=:sothe";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("mabn", NpgsqlDbType.Varchar).Value = mabn;
                cmd.Parameters.Add("hoten", NpgsqlDbType.Text, 70).Value = hoten;
                cmd.Parameters.Add("namsinh", NpgsqlDbType.Varchar, 4).Value = namsinh;
                cmd.Parameters.Add("diachi", NpgsqlDbType.Text, 150).Value = diachi;
                cmd.Parameters.Add("matt", NpgsqlDbType.Varchar, 3).Value = matt;
                cmd.Parameters.Add("maqu", NpgsqlDbType.Varchar, 5).Value = maqu;
                cmd.Parameters.Add("maphuongxa", NpgsqlDbType.Varchar, 7).Value = maphuongxa;
                cmd.Parameters.Add("cholam", NpgsqlDbType.Text, 150).Value = cholam;
                if (tungay != "") cmd.Parameters.Add("tungay", NpgsqlDbType.Varchar, 10).Value = tungay;
                if (denngay != "") cmd.Parameters.Add("denngay", NpgsqlDbType.Varchar, 10).Value = denngay;
                cmd.Parameters.Add("mabv", NpgsqlDbType.Varchar, 10).Value = mabv;
                cmd.Parameters.Add("sothe", NpgsqlDbType.Varchar, 20).Value = sothe;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + usr + ".dmthe(mabn,sothe,hoten,namsinh,gioitinh,diachi,matt,maqu,maphuongxa,cholam";
                    if (tungay != "") sql += ",tungay";
                    if (denngay != "") sql += ",denngay";
                    sql += ",mabv) values (:mabn,:sothe,:hoten,:namsinh," + gioitinh + ",:diachi,:matt,:maqu,:maphuongxa,:cholam";
                    if (tungay != "") sql += ",to_date(:tungay,'dd/mm/yyyy')";
                    if (denngay != "") sql += ",to_date(:denngay,'dd/mm/yyyy')";
                    sql += ",:mabv)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("mabn", NpgsqlDbType.Varchar).Value = mabn;
                    cmd.Parameters.Add("sothe", NpgsqlDbType.Varchar, 20).Value = sothe;
                    cmd.Parameters.Add("hoten", NpgsqlDbType.Text, 70).Value = hoten;
                    cmd.Parameters.Add("namsinh", NpgsqlDbType.Varchar, 4).Value = namsinh;
                    cmd.Parameters.Add("diachi", NpgsqlDbType.Text, 150).Value = diachi;
                    cmd.Parameters.Add("matt", NpgsqlDbType.Varchar, 3).Value = matt;
                    cmd.Parameters.Add("maqu", NpgsqlDbType.Varchar, 5).Value = maqu;
                    cmd.Parameters.Add("maphuongxa", NpgsqlDbType.Varchar, 7).Value = maphuongxa;
                    cmd.Parameters.Add("cholam", NpgsqlDbType.Text, 150).Value = cholam;
                    if (tungay != "") cmd.Parameters.Add("tungay", NpgsqlDbType.Varchar, 10).Value = tungay;
                    if (denngay != "") cmd.Parameters.Add("denngay", NpgsqlDbType.Varchar, 10).Value = denngay;
                    cmd.Parameters.Add("mabv", NpgsqlDbType.Varchar, 10).Value = mabv;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dmthe");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_dmloaithe(string ma, string ten, int nhom, int thu20)
        {
            string usr = user;
            sql = "update " + usr + ".dmloaithe set ten=:ten,nhom=" + nhom + ",thu20=" + thu20 + " where ma=:ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("ten", NpgsqlDbType.Text, 254).Value = ten;
                cmd.Parameters.Add("ma", NpgsqlDbType.Varchar, 2).Value = ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + usr + ".dmloaithe(ma,ten,nhom,thu20) values (:ma,:ten," + nhom + "," + thu20 + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("ma", NpgsqlDbType.Varchar, 2).Value = ma;
                    cmd.Parameters.Add("ten", NpgsqlDbType.Text, 254).Value = ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dmloaithe");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public DataSet getdmthe(string mabn, string sothe, string ngayvao)
        {
            sql = "select a.mabn,a.sothe,a.hoten,a.namsinh,a.gioitinh,a.diachi,a.matt,a.maqu,a.maphuongxa,a.cholam,to_char(a.tungay,'dd/mm/yyyy') as tungay,to_char(a.denngay,'dd/mm/yyyy') as denngay,a.mabv,b.tenbv ";
            sql += " from " + user + ".dmthe a left join " + user + ".dmnoicapbhyt b on a.mabv=b.mabv where a.sudung=1";
            sql += " and a.denngay>=to_timestamp('" + ngayvao.Substring(0, 10) + "','" + f_ngay + "')";
            if (mabn != "") sql += " and a.mabn='" + mabn + "'";
            if (sothe != "") sql += " and a.sothe like '%" + sothe + "%'";
            return get_data(sql);
        }
        #region luong
        public void upd_lg_error(string m_message, string m_computer, string m_table)
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            sql = "insert into " + user + ".lg_error(message,computer,tables) values (:m_message,:m_computer,:m_table)";
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_message", NpgsqlDbType.Text).Value = m_message;
                cmd.Parameters.Add("m_computer", NpgsqlDbType.Text).Value = m_computer;
                cmd.Parameters.Add("m_table", NpgsqlDbType.Text).Value = m_table;
                cmd.ExecuteNonQuery();
            }
            catch { }
            finally
            {
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
        }

        public void upd_lg_thongso(int id, string ten)
        {
            sql = "update " + user + ".lg_thongso set ten=:ten ";
            sql += " where id=" + id;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".lg_thongso(id,ten) values (" + id + ",:ten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_lg_error(ex.Message.ToString().Trim(), sComputer, "lg_thongso");
            }
            finally
            {

                con.Close(); con.Dispose();
            }
        }

        public decimal get_lg_capid(int m_ma)
        {
            sql = "update " + user + ".lg_capid set id=id+1 where ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            con.Open();
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;
            cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
            int irec = cmd.ExecuteNonQuery();
            cmd.Dispose();
            if (irec == 0)
            {
                sql = "insert into " + user + ".lg_capid(ma,loai,id) values (:m_ma,:m_loai,1)";
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                cmd.Parameters.Add("m_loai", NpgsqlDbType.Varchar, 20).Value = sComputer;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            sql = "select id from " + user + ".lg_capid where ma=" + m_ma;
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;
            dest = new NpgsqlDataAdapter(cmd);
            ds = new DataSet();
            dest.Fill(ds);
            cmd.Dispose();
            con.Close(); con.Dispose();
            return decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
        }

        public bool upd_lg_dmnv(decimal id, decimal stt, string ma, string ten, decimal idbp, decimal idcv, decimal heso, decimal lcb, string malink,
            int userid)
        {
            string xxx = user + ".lg_dmnv";
            sql = "update " + xxx + " set stt=" + stt + ",ma=:ma,ten=:ten,idbp=" + idbp + ",idcv=" + idcv + ",heso=" + heso + ",lcb=" + lcb;
            sql += ",malink=:malink,userid=" + userid;
            sql += " where id=" + id;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("ma", NpgsqlDbType.Text, 10).Value = ma;
                cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                cmd.Parameters.Add("malink", NpgsqlDbType.Text, 5).Value = malink;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + "(id,stt,ma,ten,idbp,idcv,heso,lcb,malink,userid) ";
                    sql += " values (" + id + "," + stt + ",:ma,:ten," + idbp + "," + idcv + "," + heso + "," + lcb + ",:malink," + userid + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("ma", NpgsqlDbType.Text, 10).Value = ma;
                    cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                    cmd.Parameters.Add("malink", NpgsqlDbType.Text, 5).Value = malink;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_lg_error(ex.Message.ToString().Trim(), sComputer, xxx);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_lg_dmhspc(decimal id, decimal stt, string ma, string ten, int userid)
        {
            string xxx = user + ".lg_dmhspc";
            sql = "update " + xxx + " set stt=" + stt + ",ma=:ma,ten=:ten,userid=" + userid;
            sql += " where id=" + id;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("ma", NpgsqlDbType.Text, 10).Value = ma;
                cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + "(id,stt,ma,ten,userid) ";
                    sql += " values (" + id + "," + stt + ",:ma,:ten," + userid + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("ma", NpgsqlDbType.Text, 10).Value = ma;
                    cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_lg_error(ex.Message.ToString().Trim(), sComputer, xxx);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_lg_dmpc(decimal id, decimal idnv, decimal idhspc, decimal heso)
        {
            string xxx = user + ".lg_dmpc";
            sql = "update " + xxx + " set idnv=" + idnv + ",idhspc=" + idhspc + ",heso=" + heso;
            sql += " where id=" + id;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + "(id,idnv,idhspc,heso) ";
                    sql += " values (" + id + "," + idnv + "," + idhspc + "," + heso + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_lg_error(ex.Message.ToString().Trim(), sComputer, xxx);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_lg_dmbp(decimal id, decimal stt, string ma, string ten, decimal hsthu, decimal hschi, string idlink,
            string idloaivp, int tong, int userid)
        {
            string xxx = user + ".lg_dmbp";
            sql = "update " + xxx + " set stt=" + stt + ",ma=:ma,ten=:ten,hsthu=" + hsthu + ",hschi=" + hschi;
            sql += ",idlink='" + idlink + "',idloaivp=:idloaivp,tong=" + tong + ",userid=" + userid;
            sql += " where id=" + id;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("ma", NpgsqlDbType.Text, 10).Value = ma;
                cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                cmd.Parameters.Add("idloaivp", NpgsqlDbType.Text).Value = idloaivp;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + "(id,stt,ma,ten,hsthu,hschi,idlink,idloaivp,tong,userid) ";
                    sql += " values (" + id + "," + stt + ",:ma,:ten," + hsthu + "," + hschi + ",'" + idlink + "',:idloaivp," + tong + "," + userid + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("ma", NpgsqlDbType.Text, 10).Value = ma;
                    cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                    cmd.Parameters.Add("idloaivp", NpgsqlDbType.Text).Value = idloaivp;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_lg_error(ex.Message.ToString().Trim(), sComputer, xxx);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_lg_dmcv(decimal id, decimal stt, string ma, string ten, int userid)
        {
            string xxx = user + ".lg_dmcv";
            sql = "update " + xxx + " set stt=" + stt + ",ma=:ma,ten=:ten,userid=" + userid;
            sql += " where id=" + id;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("ma", NpgsqlDbType.Text, 10).Value = ma;
                cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + "(id,stt,ma,ten,userid) ";
                    sql += " values (" + id + "," + stt + ",:ma,:ten," + userid + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("ma", NpgsqlDbType.Text, 10).Value = ma;
                    cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_lg_error(ex.Message.ToString().Trim(), sComputer, xxx);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_lg_codong(decimal id, decimal idnv, decimal stt, decimal idbp, decimal tyle, int userid)
        {
            string xxx = user + ".lg_codong";
            sql = "update " + xxx + " set idnv=" + idnv + ",stt=" + stt + ",idbp=" + idbp + ",tyle=" + tyle + ",userid=" + userid;
            sql += " where id=" + id;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + "(id,idnv,stt,idbp,tyle,userid) ";
                    sql += " values (" + id + "," + idnv + "," + stt + "," + idbp + "," + tyle + "," + userid + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_lg_error(ex.Message.ToString().Trim(), sComputer, xxx);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_lg_dmloai(decimal id, decimal stt, int loai, string ma, string ten, int codong, int chitra, int doanhthu,
            int chung, int userid)
        {
            string xxx = user + ".lg_dmloai";
            sql = "update " + xxx + " set stt=" + stt + ",loai=" + loai + ",ma=:ma,ten=:ten,codong=" + codong;
            sql += ",chitra=" + chitra + ",doanhthu=" + doanhthu + ",chung=" + chung + ",userid=" + userid;
            sql += " where id=" + id;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("ma", NpgsqlDbType.Text, 10).Value = ma;
                cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + "(id,stt,loai,ma,ten,codong,chitra,doanhthu,chung,userid) ";
                    sql += " values (" + id + "," + stt + "," + loai + ",:ma,:ten," + codong + "," + chitra + "," + doanhthu + "," + chung + "," + userid + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("ma", NpgsqlDbType.Text, 10).Value = ma;
                    cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_lg_error(ex.Message.ToString().Trim(), sComputer, xxx);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_lg_dmloaict(decimal id, decimal idnv, decimal stt, decimal idloai, decimal tyle, decimal sotien)
        {
            string xxx = user + ".lg_dmloaict";
            sql = "update " + xxx + " set stt=" + stt + ",idloai=" + idloai + ",idnv=" + idnv;
            sql += ",tyle=" + tyle + ",sotien=" + sotien;
            sql += " where id=" + id;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + "(id,stt,idloai,idnv,tyle,sotien) ";
                    sql += " values (" + id + "," + stt + "," + idloai + "," + idnv + "," + tyle + "," + sotien + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_lg_error(ex.Message.ToString().Trim(), sComputer, xxx);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_lg_dmloaich(decimal id, decimal idbp, decimal stt, decimal idloai, decimal tyle, decimal sotien)
        {
            string xxx = user + ".lg_dmloaich";
            sql = "update " + xxx + " set stt=" + stt + ",idloai=" + idloai + ",idbp=" + idbp;
            sql += ",tyle=" + tyle + ",sotien=" + sotien;
            sql += " where id=" + id;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + "(id,stt,idloai,idbp,tyle,sotien) ";
                    sql += " values (" + id + "," + stt + "," + idloai + "," + idbp + "," + tyle + "," + sotien + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_lg_error(ex.Message.ToString().Trim(), sComputer, xxx);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_lg_thu(decimal id, decimal stt, string ngay, string mmyy, decimal idbp, decimal idloai, string ghichu, decimal sotien, int userid)
        {
            string xxx = user + ".lg_thu";
            sql = "update " + xxx + " set stt=" + stt + ",ngay=to_date('" + ngay + "','dd/mm/yyyy'),mmyy='" + mmyy + "',idbp=" + idbp + ",idloai=" + idloai;
            sql += ",ghichu='" + ghichu + "',sotien=" + sotien + ",userid=" + userid;
            sql += " where id=" + id;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + "(id,stt,ngay,mmyy,idbp,idloai,ghichu,sotien,userid) ";
                    sql += " values (" + id + "," + stt + ",to_date('" + ngay + "','dd/mm/yyyy'),'" + mmyy + "'," + idbp + "," + idloai + ",'" + ghichu + "'," + sotien + "," + userid + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_lg_error(ex.Message.ToString().Trim(), sComputer, xxx);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_lg_chi(decimal id, decimal stt, string ngay, string mmyy, decimal idbp, decimal idloai, string ghichu, decimal sotien, int userid)
        {
            string xxx = user + ".lg_chi";
            sql = "update " + xxx + " set stt=" + stt + ",ngay=to_date('" + ngay + "','dd/mm/yyyy'),mmyy='" + mmyy + "',idbp=" + idbp + ",idloai=" + idloai;
            sql += ",ghichu='" + ghichu + "',sotien=" + sotien + ",userid=" + userid;
            sql += " where id=" + id;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + "(id,stt,ngay,mmyy,idbp,idloai,ghichu,sotien,userid) ";
                    sql += " values (" + id + "," + stt + ",to_date('" + ngay + "','dd/mm/yyyy'),'" + mmyy + "'," + idbp + "," + idloai + ",'" + ghichu + "'," + sotien + "," + userid + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_lg_error(ex.Message.ToString().Trim(), sComputer, xxx);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_lg_chict(decimal id, decimal stt, decimal idnv, decimal idchi, decimal tyle, decimal sotien)
        {
            string xxx = user + ".lg_chict";
            sql = "update " + xxx + " set stt=" + stt + ",idchi=" + idchi + ",idnv=" + idnv + ",tyle=" + tyle + ",sotien=" + sotien;
            sql += " where id=" + id;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + "(id,stt,idchi,idnv,tyle,sotien) ";
                    sql += " values (" + id + "," + stt + "," + idchi + "," + idnv + "," + tyle + "," + sotien + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_lg_error(ex.Message.ToString().Trim(), sComputer, xxx);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_lg_chich(decimal id, decimal stt, decimal idbp, decimal idchi, decimal tyle, decimal sotien)
        {
            string xxx = user + ".lg_chich";
            sql = "update " + xxx + " set stt=" + stt + ",idchi=" + idchi + ",idbp=" + idbp + ",tyle=" + tyle + ",sotien=" + sotien;
            sql += " where id=" + id;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + "(id,stt,idchi,idbp,tyle,sotien) ";
                    sql += " values (" + id + "," + stt + "," + idchi + "," + idbp + "," + tyle + "," + sotien + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_lg_error(ex.Message.ToString().Trim(), sComputer, xxx);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_lg_tinhcong(decimal id, string mmyy, decimal idbp, decimal soluong, decimal hsthu, decimal hschi,
            decimal thu, decimal chi, decimal tinhcong)
        {
            string xxx = user + ".lg_tinhcong";
            sql = "update " + xxx + " set mmyy='" + mmyy + "',idbp=" + idbp + ",soluong=" + soluong + ",hsthu=" + hsthu;
            sql += ",hschi=" + hschi + ",thu=" + thu + ",chi=" + chi + ",tinhcong=" + tinhcong;
            sql += " where id=" + id;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + "(id,mmyy,idbp,soluong,hsthu,hschi,thu,chi,tinhcong) ";
                    sql += " values (" + id + ",'" + mmyy + "'," + idbp + "," + soluong + "," + hsthu + "," + hschi + "," + thu + "," + chi + "," + tinhcong + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_lg_error(ex.Message.ToString().Trim(), sComputer, xxx);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_lg_bangluong(decimal id, string ngay, string mmyy, decimal idbp, decimal idnv, decimal heso,
            decimal soluong, int userid)
        {
            string xxx = user + ".lg_bangluong";
            sql = "update " + xxx + " set ngay=to_date('" + ngay + "','dd/mm/yyyy'),mmyy='" + mmyy + "',idbp=" + idbp + ",idnv=" + idnv + ",heso=" + heso;
            sql += ",soluong=" + soluong + ",userid=" + userid;
            sql += " where id=" + id;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + "(id,ngay,mmyy,idbp,idnv,heso,soluong,userid) ";
                    sql += " values (" + id + ",to_date('" + ngay + "','dd/mm/yyyy'),'" + mmyy + "'," + idbp + "," + idnv + "," + heso + "," + soluong + "," + userid + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_lg_error(ex.Message.ToString().Trim(), sComputer, xxx);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_lg_dlogin(decimal id, string hoten, string userid, string password_, int admin)
        {
            sql = "update " + user + ".lg_dlogin set hoten=:hoten,userid=:userid,password_=:password_,";
            sql += "admin=" + admin;
            sql += " where id=" + id;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("hoten", NpgsqlDbType.Text).Value = hoten;
                cmd.Parameters.Add("userid", NpgsqlDbType.Text).Value = userid;
                cmd.Parameters.Add("password_", NpgsqlDbType.Text).Value = password_;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".lg_dlogin(id,hoten,userid,password_,admin) values (" + id + ",:hoten,:userid,:password_," + admin + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("hoten", NpgsqlDbType.Text).Value = hoten;
                    cmd.Parameters.Add("userid", NpgsqlDbType.Text).Value = userid;
                    cmd.Parameters.Add("password_", NpgsqlDbType.Text).Value = password_;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "lg_dlogin");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_lg_dlogin(decimal id, string right_)
        {
            sql = "update " + user + ".lg_dlogin set right_=:right_ where id=" + id;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("right_", NpgsqlDbType.Text).Value = right_;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "lg_dlogin");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_lg_danhmuc(string table, decimal id, decimal stt, string ma, string ten, int userid)
        {
            string xxx = user + "." + table;
            sql = "update " + xxx + " set stt=" + stt + ",ma=:ma,ten=:ten,userid=" + userid;
            sql += " where id=" + id;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("ma", NpgsqlDbType.Text, 10).Value = ma;
                cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + "(id,stt,ma,ten,userid) ";
                    sql += " values (" + id + "," + stt + ",:ma,:ten," + userid + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("ma", NpgsqlDbType.Text, 10).Value = ma;
                    cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_lg_error(ex.Message.ToString().Trim(), sComputer, xxx);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_lg_table(string mmyy, int userid)
        {
            string xxx = user + ".lg_table";
            sql = "update " + xxx + " set userid=" + userid;
            sql += " where mmyy='" + mmyy + "'";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + "(mmyy,userid) ";
                    sql += " values ('" + mmyy + "'," + userid + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_lg_error(ex.Message.ToString().Trim(), sComputer, xxx);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool bLgmmyy(string mmyy)
        {
            return get_data("select * from " + user + ".lg_table where mmyy='" + mmyy + "'").Tables[0].Rows.Count > 0;
        }

        public bool blg_auto_list
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".lg_thongso where id=1");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool upd_lg_khoaso(string mmyy, int userid)
        {
            string xxx = user + ".lg_khoaso";
            sql = "update " + xxx + " set userid=" + userid;
            sql += " where mmyy='" + mmyy + "'";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + "(mmyy,userid) ";
                    sql += " values ('" + mmyy + "'," + userid + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_lg_error(ex.Message.ToString().Trim(), sComputer, xxx);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool blg_khoaso(string mmyy)
        {
            return get_data("select * from " + user + ".lg_khoaso where mmyy='" + mmyy + "'").Tables[0].Rows.Count > 0;
        }
        private decimal get_lg_capid_may(int m_ma, string m_computer)
        {
            sql = "update " + user + ".lg_capid set id=id+1 where ma=" + m_ma + " and loai='" + m_computer + "'";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            con.Open();
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;
            int irec = cmd.ExecuteNonQuery();
            cmd.Dispose();
            if (irec == 0)
            {
                sql = "insert into " + user + ".lg_capid(ma,loai,id) values (" + m_ma + ",'" + m_computer + "',1)";
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            sql = "select id from " + user + ".lg_capid where ma=" + m_ma + " and loai='" + m_computer + "'";
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;
            dest = new NpgsqlDataAdapter(cmd);
            ds = new DataSet();
            dest.Fill(ds);
            cmd.Dispose();
            con.Close(); con.Dispose();
            return decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
        }
        /// <summary>
        /// Them bool upd_dmgiatribt ////dong
        /// </summary>
        /// <returns></returns>
        public int get_capid_table(string s_table)
        {
            s_table = s_table.ToLower();
            try
            {
                return int.Parse(get_data("select nvl(max(id),0)+ 1 as id from medibv." + s_table + "").Tables[0].Rows[0][0].ToString());
            }
            catch
            {
                return 1;
            }
        }
        /// <summary>
        /// Begen dong
        /// </summary>
        /// <param name="d_id"></param>
        /// <param name="s_mach"></param>
        /// <param name="s_nhietdo"></param>
        /// <param name="s_huyetap"></param>
        /// <param name="s_nhiptho"></param>
        /// <param name="s_cannang"></param>
        /// <param name="s_chieucao"></param>
        /// <returns></returns>
        public bool upd_dmgiatribt(decimal d_id, string s_mach, string s_nhietdo, string s_huyetap, string s_nhiptho, string s_cannang, string s_chieucao)
        {
            sql = "update " + user + ".dmgiatribt set mach=:s_mach,nhietdo=:s_nhietdo,huyetap=:s_huyetap,nhiptho=:s_nhiptho,cannang=:s_cannang,chieucao=:s_chieucao where id=:d_id ";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("s_mach", NpgsqlDbType.Varchar, 15).Value = s_mach;
                cmd.Parameters.Add("s_nhietdo", NpgsqlDbType.Varchar, 15).Value = s_nhietdo;
                cmd.Parameters.Add("s_huyetap", NpgsqlDbType.Varchar, 15).Value = s_huyetap;
                cmd.Parameters.Add("s_nhiptho", NpgsqlDbType.Varchar, 15).Value = s_nhiptho;
                cmd.Parameters.Add("s_cannang", NpgsqlDbType.Varchar, 15).Value = s_cannang;
                cmd.Parameters.Add("s_chieucao", NpgsqlDbType.Varchar, 15).Value = s_chieucao;
                cmd.Parameters.Add("d_id", NpgsqlDbType.Numeric).Value = d_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dmgiatribt(id,mach,nhietdo,huyetap,nhiptho,cannang,chieucao) values (:d_id,:s_mach,:s_nhietdo,:s_huyetap,:s_nhiptho,:s_cannang,:s_chieucao)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("s_mach", NpgsqlDbType.Varchar, 15).Value = s_mach;
                    cmd.Parameters.Add("s_nhietdo", NpgsqlDbType.Varchar, 15).Value = s_nhietdo;
                    cmd.Parameters.Add("s_huyetap", NpgsqlDbType.Varchar, 15).Value = s_huyetap;
                    cmd.Parameters.Add("s_nhiptho", NpgsqlDbType.Varchar, 15).Value = s_nhiptho;
                    cmd.Parameters.Add("s_cannang", NpgsqlDbType.Varchar, 15).Value = s_cannang;
                    cmd.Parameters.Add("s_chieucao", NpgsqlDbType.Varchar, 15).Value = s_chieucao;
                    cmd.Parameters.Add("d_id", NpgsqlDbType.Numeric).Value = d_id;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dmgiatribt");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_hoichan_cdha(decimal d_id, string s_mabn, decimal d_mavaovien, decimal d_maql, DateTime s_ngayhoichan, string s_lamsang, string s_chandoan, string s_xquang, string s_sieuam, string s_xetnghiem, int i_sdthuoccanquangco, int i_sdthuoccanquangkhong, int i_userid)
        {
            sql = "update " + user + ".hoichan_cdha set mabn=:s_mabn,mavaovien=:d_mavaovien,maql=:d_maql,ngayhoichan=:s_ngayhoichan,lamsang=:s_lamsang,chandoan=:s_chandoan,xquang=:s_xquang,sieuam=:s_sieuam,xetnghiem=:s_xetnghiem,sdthuoccanquangco=:i_sdthuoccanquangco,sdthuoccanquangkhong=:i_sdthuoccanquangkhong,userid=:i_userid where id=:d_id ";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("s_mabn", NpgsqlDbType.Varchar, i_maxlength_mabn).Value = s_mabn;
                cmd.Parameters.Add("d_mavaovien", NpgsqlDbType.Numeric).Value = d_mavaovien;
                cmd.Parameters.Add("d_maql", NpgsqlDbType.Numeric).Value = d_maql;
                cmd.Parameters.Add("s_ngayhoichan", NpgsqlDbType.Timestamp).Value = s_ngayhoichan;
                cmd.Parameters.Add("s_lamsang", NpgsqlDbType.Text).Value = s_lamsang;
                cmd.Parameters.Add("s_chandoan", NpgsqlDbType.Text).Value = s_chandoan;
                cmd.Parameters.Add("s_xquang", NpgsqlDbType.Text).Value = s_xquang;
                cmd.Parameters.Add("s_sieuam", NpgsqlDbType.Text).Value = s_sieuam;
                cmd.Parameters.Add("s_xetnghiem", NpgsqlDbType.Text).Value = s_xetnghiem;
                cmd.Parameters.Add("i_sdthuoccanquangco", NpgsqlDbType.Numeric).Value = i_sdthuoccanquangco;
                cmd.Parameters.Add("i_sdthuoccanquangkhong", NpgsqlDbType.Numeric).Value = i_sdthuoccanquangkhong;
                cmd.Parameters.Add("i_userid", NpgsqlDbType.Numeric).Value = i_userid;
                cmd.Parameters.Add("d_id", NpgsqlDbType.Numeric).Value = d_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".hoichan_cdha(id,mabn,mavaovien,maql,ngayhoichan,lamsang,chandoan,xquang,sieuam,xetnghiem,sdthuoccanquangco,sdthuoccanquangkhong,userid) values (:d_id,:s_mabn,:d_mavaovien,:d_maql,:s_ngayhoichan,:s_lamsang,:s_chandoan,:s_xquang,:s_sieuam,:s_xetnghiem,:i_sdthuoccanquangco,:i_sdthuoccanquangkhong,:i_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("s_mabn", NpgsqlDbType.Varchar, i_maxlength_mabn).Value = s_mabn;
                    cmd.Parameters.Add("d_mavaovien", NpgsqlDbType.Numeric).Value = d_mavaovien;
                    cmd.Parameters.Add("d_maql", NpgsqlDbType.Numeric).Value = d_maql;
                    cmd.Parameters.Add("s_ngayhoichan", NpgsqlDbType.Timestamp).Value = s_ngayhoichan;
                    cmd.Parameters.Add("s_lamsang", NpgsqlDbType.Text).Value = s_lamsang;
                    cmd.Parameters.Add("s_chandoan", NpgsqlDbType.Text).Value = s_chandoan;
                    cmd.Parameters.Add("s_xquang", NpgsqlDbType.Text).Value = s_xquang;
                    cmd.Parameters.Add("s_sieuam", NpgsqlDbType.Text).Value = s_sieuam;
                    cmd.Parameters.Add("s_xetnghiem", NpgsqlDbType.Text).Value = s_xetnghiem;
                    cmd.Parameters.Add("i_sdthuoccanquangco", NpgsqlDbType.Numeric).Value = i_sdthuoccanquangco;
                    cmd.Parameters.Add("i_sdthuoccanquangkhong", NpgsqlDbType.Numeric).Value = i_sdthuoccanquangkhong;
                    cmd.Parameters.Add("i_userid", NpgsqlDbType.Numeric).Value = i_userid;
                    cmd.Parameters.Add("d_id", NpgsqlDbType.Numeric).Value = d_id;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "hoichan_cdha");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_hoichan_cdha_ct(decimal d_id, int d_iddmbophan)
        {
            sql = "update " + user + ".hoichan_cdha_ct set iddmbophan=:d_iddmbophan where id=:d_id and iddmbophan=:d_iddmbophan";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("d_iddmbophan", NpgsqlDbType.Numeric).Value = d_iddmbophan;
                cmd.Parameters.Add("d_id", NpgsqlDbType.Numeric).Value = d_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".hoichan_cdha_ct(id,iddmbophan) values (:d_id,:d_iddmbophan)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("d_iddmbophan", NpgsqlDbType.Numeric).Value = d_iddmbophan;
                    cmd.Parameters.Add("d_id", NpgsqlDbType.Numeric).Value = d_id;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "hoichan_cdha_ct");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        /// Ngay 27/06/2011 
        public bool upd_kbct_canquangll(decimal d_id, string s_mabn, decimal d_mavaovien, decimal d_maql, DateTime s_ngay, string s_chandoan, string s_icd10, int i_tv_canthietchupct, int i_tv_tacdungphu, int i_hb_tiensudiung, int i_hb_tinhtrangmatnuoc, int i_hb_roiloanhd, int i_hb_suythan, int i_hb_thaiky, int i_hb_dautuy, int i_hb_benhlytm, int i_hb_tinhtrangntr, int i_mach, decimal d_nhietdo, string s_huyetap, int i_nhiptho, string s_ketquabun, string s_ketquacreatinin, int i_userid)
        {
            sql = " update " + user + ".kbct_canquangll set mabn=:s_mabn,mavaovien=:d_mavaovien,maql=:d_maql, ngay=:s_ngay, chandoan=:s_chandoan,icd10=:s_icd10,tv_canthietchupct=:i_tv_canthietchupct,tv_tacdungphu=:i_tv_tacdungphu,hb_tiensudiung=:i_hb_tiensudiung,hb_tinhtrangmatnuoc=:i_hb_tinhtrangmatnuoc,hb_roiloanhd=:i_hb_roiloanhd,hb_suythan=:i_hb_suythan,hb_thaiky=:i_hb_thaiky,hb_dautuy=:i_hb_dautuy,hb_benhlytm=:i_hb_benhlytm,hb_tinhtrangntr=:i_hb_tinhtrangntr,mach=:i_mach,nhietdo=:d_nhietdo,huyetap=:s_huyetap,nhiptho=:i_nhiptho,ketquabun=:s_ketquabun,ketquacreatinin=:s_ketquacreatinin,userid=:i_userid where id=:d_id ";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("s_mabn", NpgsqlDbType.Varchar, i_maxlength_mabn).Value = s_mabn;
                cmd.Parameters.Add("d_mavaovien", NpgsqlDbType.Numeric).Value = d_mavaovien;
                cmd.Parameters.Add("d_maql", NpgsqlDbType.Numeric).Value = d_maql;
                cmd.Parameters.Add("s_ngay", NpgsqlDbType.Timestamp).Value = s_ngay;
                cmd.Parameters.Add("s_chandoan", NpgsqlDbType.Text).Value = s_chandoan;
                cmd.Parameters.Add("s_icd10", NpgsqlDbType.Text).Value = s_icd10;
                //cmd.Parameters.Add("d_idvp", NpgsqlDbType.Numeric).Value = d_idvp;
                cmd.Parameters.Add("i_tv_canthietchupct", NpgsqlDbType.Numeric).Value = i_tv_canthietchupct;
                cmd.Parameters.Add("i_tv_tacdungphu", NpgsqlDbType.Numeric).Value = i_tv_tacdungphu;
                cmd.Parameters.Add("i_hb_tiensudiung", NpgsqlDbType.Numeric).Value = i_hb_tiensudiung;
                cmd.Parameters.Add("i_hb_tinhtrangmatnuoc", NpgsqlDbType.Numeric).Value = i_hb_tinhtrangmatnuoc;
                cmd.Parameters.Add("i_hb_roiloanhd", NpgsqlDbType.Numeric).Value = i_hb_roiloanhd;
                cmd.Parameters.Add("i_hb_suythan", NpgsqlDbType.Numeric).Value = i_hb_suythan;
                cmd.Parameters.Add("i_hb_thaiky", NpgsqlDbType.Numeric).Value = i_hb_thaiky;
                cmd.Parameters.Add("i_hb_dautuy", NpgsqlDbType.Numeric).Value = i_hb_dautuy;
                cmd.Parameters.Add("i_hb_benhlytm", NpgsqlDbType.Numeric).Value = i_hb_benhlytm;
                cmd.Parameters.Add("i_hb_tinhtrangntr", NpgsqlDbType.Numeric).Value = i_hb_tinhtrangntr;
                cmd.Parameters.Add("i_mach", NpgsqlDbType.Numeric).Value = i_mach;
                cmd.Parameters.Add("d_nhietdo", NpgsqlDbType.Numeric).Value = d_nhietdo;
                cmd.Parameters.Add("s_huyetap", NpgsqlDbType.Text).Value = s_huyetap;
                cmd.Parameters.Add("i_nhiptho", NpgsqlDbType.Numeric).Value = i_nhiptho;
                cmd.Parameters.Add("s_ketquabun", NpgsqlDbType.Text).Value = s_ketquabun;
                cmd.Parameters.Add("s_ketquacreatinin", NpgsqlDbType.Text).Value = s_ketquacreatinin;
                cmd.Parameters.Add("i_userid", NpgsqlDbType.Numeric).Value = i_userid;
                cmd.Parameters.Add("d_id", NpgsqlDbType.Numeric).Value = d_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".kbct_canquangll(id,mabn,mavaovien,maql,ngay,chandoan,icd10,tv_canthietchupct,tv_tacdungphu,hb_tiensudiung,hb_tinhtrangmatnuoc,hb_roiloanhd,hb_suythan,hb_thaiky,hb_dautuy,hb_benhlytm,hb_tinhtrangntr,mach,nhietdo,huyetap,nhiptho,ketquabun,ketquacreatinin,userid) values (:d_id,:s_mabn,:d_mavaovien,:d_maql,:s_ngay,:s_chandoan,:s_icd10,:i_tv_canthietchupct,:i_tv_tacdungphu,:i_hb_tiensudiung,:i_hb_tinhtrangmatnuoc,:i_hb_roiloanhd,:i_hb_suythan,:i_hb_thaiky,:i_hb_dautuy,:i_hb_benhlytm,:i_hb_tinhtrangntr,:i_mach,:d_nhietdo,:s_huyetap,:i_nhiptho,:s_ketquabun,:s_ketquacreatinin,:i_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("d_id", NpgsqlDbType.Numeric).Value = d_id;
                    cmd.Parameters.Add("s_mabn", NpgsqlDbType.Varchar, i_maxlength_mabn).Value = s_mabn;
                    cmd.Parameters.Add("d_mavaovien", NpgsqlDbType.Numeric).Value = d_mavaovien;
                    cmd.Parameters.Add("d_maql", NpgsqlDbType.Numeric).Value = d_maql;
                    cmd.Parameters.Add("s_ngay", NpgsqlDbType.Timestamp).Value = s_ngay;
                    cmd.Parameters.Add("s_chandoan", NpgsqlDbType.Text).Value = s_chandoan;
                    cmd.Parameters.Add("s_icd10", NpgsqlDbType.Text).Value = s_icd10;
                    //cmd.Parameters.Add("d_idvp", NpgsqlDbType.Numeric).Value = d_idvp;
                    cmd.Parameters.Add("i_tv_canthietchupct", NpgsqlDbType.Numeric).Value = i_tv_canthietchupct;
                    cmd.Parameters.Add("i_tv_tacdungphu", NpgsqlDbType.Numeric).Value = i_tv_tacdungphu;
                    cmd.Parameters.Add("i_hb_tiensudiung", NpgsqlDbType.Numeric).Value = i_hb_tiensudiung;
                    cmd.Parameters.Add("i_hb_tinhtrangmatnuoc", NpgsqlDbType.Numeric).Value = i_hb_tinhtrangmatnuoc;
                    cmd.Parameters.Add("i_hb_roiloanhd", NpgsqlDbType.Numeric).Value = i_hb_roiloanhd;
                    cmd.Parameters.Add("i_hb_suythan", NpgsqlDbType.Numeric).Value = i_hb_suythan;
                    cmd.Parameters.Add("i_hb_thaiky", NpgsqlDbType.Numeric).Value = i_hb_thaiky;
                    cmd.Parameters.Add("i_hb_dautuy", NpgsqlDbType.Numeric).Value = i_hb_dautuy;
                    cmd.Parameters.Add("i_hb_benhlytm", NpgsqlDbType.Numeric).Value = i_hb_benhlytm;
                    cmd.Parameters.Add("i_hb_tinhtrangntr", NpgsqlDbType.Numeric).Value = i_hb_tinhtrangntr;
                    cmd.Parameters.Add("i_mach", NpgsqlDbType.Numeric).Value = i_mach;
                    cmd.Parameters.Add("d_nhietdo", NpgsqlDbType.Numeric).Value = d_nhietdo;
                    cmd.Parameters.Add("s_huyetap", NpgsqlDbType.Text).Value = s_huyetap;
                    cmd.Parameters.Add("i_nhiptho", NpgsqlDbType.Numeric).Value = i_nhiptho;
                    cmd.Parameters.Add("s_ketquabun", NpgsqlDbType.Text).Value = s_ketquabun;
                    cmd.Parameters.Add("s_ketquacreatinin", NpgsqlDbType.Text).Value = s_ketquacreatinin;
                    cmd.Parameters.Add("i_userid", NpgsqlDbType.Numeric).Value = i_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "kbct_canquangll");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_kbct_canquangct(decimal d_id, int d_iddmbophan)
        {
            sql = "update " + user + ".kbct_canquangct set iddmbophan=:d_iddmbophan where id=:d_id and iddmbophan=:d_iddmbophan";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("d_iddmbophan", NpgsqlDbType.Numeric).Value = d_iddmbophan;
                cmd.Parameters.Add("d_id", NpgsqlDbType.Numeric).Value = d_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".kbct_canquangct(id,iddmbophan) values (:d_id,:d_iddmbophan)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("d_iddmbophan", NpgsqlDbType.Numeric).Value = d_iddmbophan;
                    cmd.Parameters.Add("d_id", NpgsqlDbType.Numeric).Value = d_id;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "kbct_canquangct");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        /// <summary>
        /// End Dong
        /// </summary>
        /// <returns></returns>
        public string getyymmdd()
        {
            return get_data("select to_char(now(),'yymmdd')").Tables[0].Rows[0][0].ToString();
        }
        public decimal get_lg_idyymmdd(int id)
        {
            return decimal.Parse(getyymmdd() + get_lg_capid_may(id, sComputer).ToString().PadLeft(9, '0') + iRownum.ToString().PadLeft(3, '0'));
        }
        public void upd_dmnv_bangluong(string mmyy, string ngay, int userid)
        {
            string f1 = user + ".lg_dmnv", f2 = user + ".lg_bangluong";
            DataTable dt1 = get_data("select * from " + f1 + " order by stt").Tables[0];
            DataTable dt2 = get_data("select * from " + f2 + " where mmyy='" + mmyy + "'").Tables[0];
            DataRow r1;
            decimal id = 0;
            foreach (DataRow r in dt1.Rows)
            {
                r1 = getrowbyid(dt2, "idnv=" + decimal.Parse(r["id"].ToString()));
                if (r1 == null)
                {
                    id = get_lg_idyymmdd(6);
                    upd_lg_bangluong(id, ngay, mmyy, decimal.Parse(r["idbp"].ToString()), decimal.Parse(r["id"].ToString()), decimal.Parse(r["heso"].ToString()), 0, userid);
                    r1 = dt2.NewRow();
                    r1["idnv"] = r["id"].ToString();
                    dt2.Rows.Add(r1);
                }
                else execute_data("update " + f2 + " set idbp=" + decimal.Parse(r["idbp"].ToString()) + ",heso=" + decimal.Parse(r["heso"].ToString()) + " where idnv=" + decimal.Parse(r["id"].ToString()) + " and mmyy='" + mmyy + "'");
            }
            foreach (DataRow r in dt2.Rows)
            {
                r1 = getrowbyid(dt1, "id=" + decimal.Parse(r["idnv"].ToString()));
                if (r1 == null) execute_data("delete from " + f2 + " where mmyy='" + mmyy + "' and idnv=" + decimal.Parse(r["idnv"].ToString()));
            }
        }
        public void upd_dmbp_tinhcong(string mmyy)
        {
            string f1 = user + ".lg_dmbp", f2 = user + ".lg_tinhcong";
            DataTable dt1 = get_data("select * from " + f1 + " order by stt").Tables[0];
            DataTable dt2 = get_data("select * from " + f2 + " where mmyy='" + mmyy + "'").Tables[0];
            DataRow r1;
            decimal id = 0;
            foreach (DataRow r in dt1.Rows)
            {
                r1 = getrowbyid(dt2, "idbp=" + decimal.Parse(r["id"].ToString()));
                if (r1 == null)
                {
                    id = get_lg_idyymmdd(5);
                    upd_lg_tinhcong(id, mmyy, decimal.Parse(r["id"].ToString()), 0, decimal.Parse(r["hsthu"].ToString()), decimal.Parse(r["hschi"].ToString()), 0, 0, 0);
                    r1 = dt2.NewRow();
                    r1["idbp"] = r["id"].ToString();
                    dt2.Rows.Add(r1);
                }
                else execute_data("update " + f2 + " set hsthu=" + decimal.Parse(r["hsthu"].ToString()) + ",hschi=" + decimal.Parse(r["hschi"].ToString()) + " where idbp=" + decimal.Parse(r["id"].ToString()) + " and mmyy='" + mmyy + "'");
            }
            foreach (DataRow r in dt2.Rows)
            {
                r1 = getrowbyid(dt1, "id=" + decimal.Parse(r["idbp"].ToString()));
                if (r1 == null) execute_data("delete from " + f2 + " where mmyy='" + mmyy + "' and idbp=" + decimal.Parse(r["idbp"].ToString()));
            }
        }
        public void upd_lg_tinhcong(string mmyy, string tt, int loai, decimal idbp, decimal stold, decimal stnew)
        {
            string f1 = user + ".lg_tinhcong";
            string fie = (loai == 0) ? "thu" : "chi";
            if (tt == "ins")
            {
                if (get_data("select * from " + f1 + " where mmyy='" + mmyy + "' and idbp=" + idbp).Tables[0].Rows.Count == 0)
                {
                    decimal id = 0;
                    foreach (DataRow r in get_data("select * from " + user + ".lg_dmbp where id=" + idbp).Tables[0].Rows)
                    {
                        id = get_lg_idyymmdd(5);
                        upd_lg_tinhcong(id, mmyy, decimal.Parse(r["id"].ToString()), 0, decimal.Parse(r["hsthu"].ToString()), decimal.Parse(r["hschi"].ToString()), 0, 0, 0);
                    }
                }
                execute_data("update " + f1 + " set " + fie + "=" + fie + "+" + (stnew - stold) + " where idbp=" + idbp + " and mmyy='" + mmyy + "'");
            }
            else
                execute_data("update " + f1 + " set " + fie + "=" + fie + "-" + (stnew - stold) + " where idbp=" + idbp + " and mmyy='" + mmyy + "'");
            execute_data("update " + f1 + " set tinhcong=(thu-chi)*hschi/100 where mmyy='" + mmyy + "'");
        }
        public void upd_lg_bangluong(string mmyy)
        {
            string f1 = user + ".lg_tinhcong", f2 = user + ".lg_bangluong";
            decimal ztc = 0, zdt = 0, zsoca = 0, zhslanh = 0, zthu = 0, hsthu = 0, hslanh = 0;
            foreach (DataRow r in get_data("select * from " + f1 + " where mmyy='" + mmyy + "'").Tables[0].Rows)
            {
                ztc = decimal.Parse(r["tinhcong"].ToString());
                zdt = decimal.Parse(r["thu"].ToString());
                zthu = zhslanh = zsoca = 0;
                foreach (DataRow r1 in get_data("select * from " + f2 + " where mmyy='" + mmyy + "' and idbp=" + decimal.Parse(r["idbp"].ToString())).Tables[0].Rows)
                    zsoca += decimal.Parse(r1["soluong"].ToString());
                foreach (DataRow r1 in get_data("select * from " + f2 + " where mmyy='" + mmyy + "' and idbp=" + decimal.Parse(r["idbp"].ToString())).Tables[0].Rows)
                {
                    zthu = ((zsoca == 0) ? 0 : (zdt / zsoca)) * decimal.Parse(r1["soluong"].ToString());
                    hsthu = (zdt == 0) ? 0 : zthu / zdt * 100;
                    hslanh = decimal.Parse(r1["heso"].ToString()) * hsthu;
                    sql = "update " + f2 + " set thu=" + zthu + ",hsthu=" + hsthu + ",hslanh=" + hslanh + " where id=" + decimal.Parse(r1["id"].ToString());
                    execute_data(sql);
                }
                foreach (DataRow r1 in get_data("select * from " + f2 + " where mmyy='" + mmyy + "' and idbp=" + decimal.Parse(r["idbp"].ToString())).Tables[0].Rows)
                    zhslanh += decimal.Parse(r1["hslanh"].ToString());
                sql = "update " + f2 + " set cong=" + ((zhslanh == 0) ? 0 : (ztc / zhslanh)) + "*hslanh where mmyy='" + mmyy + "' and idbp=" + decimal.Parse(r["idbp"].ToString());
                execute_data(sql);
            }
        }
        public void upd_lg_tinhcong(string mmyy)
        {
            decimal id = 0;
            foreach (DataRow r in get_data("select * from " + user + ".lg_dmbp order by stt").Tables[0].Rows)
            {
                id = 0;
                foreach (DataRow r1 in get_data("select * from " + user + ".lg_tinhcong where mmyy='" + mmyy + "' and idbp=" + decimal.Parse(r["id"].ToString())).Tables[0].Rows)
                    id = decimal.Parse(r1["id"].ToString());
                if (id == 0) id = get_lg_idyymmdd(5);
                upd_lg_tinhcong(id, mmyy, decimal.Parse(r["id"].ToString()), 0, decimal.Parse(r["hsthu"].ToString()), decimal.Parse(r["hschi"].ToString()), 0, 0, 0);
            }
            execute_data("update " + user + ".lg_tinhcong set thu=0,chi=0,soluong=0 where mmyy='" + mmyy + "'");
            foreach (DataRow r in get_data("select idbp,sum(sotien) as sotien from " + user + ".lg_thu where mmyy='" + mmyy + "' group by idbp").Tables[0].Rows)
                execute_data("update " + user + ".lg_tinhcong set thu=" + decimal.Parse(r["sotien"].ToString()) + " where mmyy='" + mmyy + "' and idbp=" + decimal.Parse(r["idbp"].ToString()));

            sql = "select a.idbp,sum(a.sotien) as sotien from " + user + ".lg_chi a," + user + ".lg_dmloai b where a.idloai=b.id and b.chung=0 and a.mmyy='" + mmyy + "' group by a.idbp";
            foreach (DataRow r in get_data(sql).Tables[0].Rows)
                execute_data("update " + user + ".lg_tinhcong set chi=" + decimal.Parse(r["sotien"].ToString()) + " where mmyy='" + mmyy + "' and idbp=" + decimal.Parse(r["idbp"].ToString()));

            sql = "select b.idbp,sum(b.sotien) as sotien from " + user + ".lg_chi a," + user + ".lg_chich b where a.id=b.idchi and a.mmyy='" + mmyy + "' group by b.idbp";
            foreach (DataRow r in get_data(sql).Tables[0].Rows)
                execute_data("update " + user + ".lg_tinhcong set chi=chi+" + decimal.Parse(r["sotien"].ToString()) + " where mmyy='" + mmyy + "' and idbp=" + decimal.Parse(r["idbp"].ToString()));

            foreach (DataRow r in get_data("select idbp,sum(soluong) as soluong from " + user + ".lg_bangluong where mmyy='" + mmyy + "' group by idbp").Tables[0].Rows)
                execute_data("update " + user + ".lg_tinhcong set soluong=" + decimal.Parse(r["soluong"].ToString()) + " where mmyy='" + mmyy + "' and idbp=" + decimal.Parse(r["idbp"].ToString()));
            execute_data("update " + user + ".lg_tinhcong set tinhcong=(thu-chi)*hschi/100 where mmyy='" + mmyy + "'");
        }

        public DataSet f_getSocaXN_NV(string s_tungay, string s_denngay, bool khoangcach)
        {
            string sql = "";
            DataSet ads = null;
            try
            {

                sql = "select id_loai,ktv as ma, count(*) soca from (select distinct e.ten tencd, a.mabn, a.ngay, a.id,cd.soluong*cd.dongia as sotien,g.id_loai,h.ten,ktv ";

                sql += " from xxx.v_chidinh cd,medibv.btdbn aa, xxx.xn_phieu a, xxx.xn_ketqua b, medibv.xn_bv_chitiet c,  medibv.xn_bv_ten e, medibv.xn_bv_so f,medibv.v_giavp g,medibv.v_loaivp h";

                sql += " where cd.maql=a.maql and cd.mavp=e.id_vienphi and aa.mabn=a.mabn and a.id=b.id and cd.mavp=g.id and g.id_loai=h.id and b.id_ten=c.id and c.id_bv_ten=e.id and e.id_bv_so=f.id";

                sql += " and to_date(to_char(a.ngay,'dd/mm/yyyy'),'dd/mm/yyyy') between to_date('" + s_tungay.Substring(0, 10) + "','dd/mm/yyyy') and to_date('" + s_denngay.Substring(0, 10) + "','dd/mm/yyyy') ";

                sql += "  group by  e.ten, a.mabn, a.ngay, a.id,cd.soluong*cd.dongia,g.id_loai,h.ten,ktv) tmp group by id_loai,ktv";

                ads = get_data_mmyy(sql, s_tungay.Substring(0, 10), s_denngay.Substring(0, 10), khoangcach);
            }
            catch
            {
                return null;
            }
            return ads;
        }
        public DataSet f_getSoTienXN_LoaiVP(string s_tungay, string s_denngay, bool khoangcach)
        {
            string sql = "";
            DataSet ads = null;
            try
            {

                sql = "select id_loai,sum(sotien) as sotien from (select distinct e.ten tencd, a.mabn, a.ngay, a.id,cd.soluong*cd.dongia as sotien,g.id_loai,h.ten,ktv ";

                sql += " from xxx.v_chidinh cd,medibv.btdbn aa, xxx.xn_phieu a, xxx.xn_ketqua b, medibv.xn_bv_chitiet c,  medibv.xn_bv_ten e, medibv.xn_bv_so f,medibv.v_giavp g,medibv.v_loaivp h";

                sql += " where cd.maql=a.maql and cd.mavp=e.id_vienphi and aa.mabn=a.mabn and a.id=b.id and cd.mavp=g.id and g.id_loai=h.id and b.id_ten=c.id and c.id_bv_ten=e.id and e.id_bv_so=f.id";

                sql += " and to_date(to_char(a.ngay,'dd/mm/yyyy'),'dd/mm/yyyy') between to_date('" + s_tungay.Substring(0, 10) + "','dd/mm/yyyy') and to_date('" + s_denngay.Substring(0, 10) + "','dd/mm/yyyy') ";

                sql += "  group by  e.ten, a.mabn, a.ngay, a.id,cd.soluong*cd.dongia,g.id_loai,h.ten,ktv) tmp group by id_loai";
                ads = get_data_mmyy(sql, s_tungay.Substring(0, 10), s_denngay.Substring(0, 10), khoangcach);
            }
            catch
            {
                return null;
            }
            return ads;
        }

        public DataSet f_getSocaCDHA_NV(string s_tungay, string s_denngay, bool khoangcach)
        {
            string sql = "";
            DataSet ads = null;
            try
            {

                sql = "  select h.id_loai,case when a.id_loai<>'01' then a.bsdoc else case when a.id_loai='01' then a.bsdoc else '' end  end as ma1,case when a.id_loai<>'01' then a.ktv else '' end as ma2,sum(solan) soca ";
                sql += " from xxx.cdha_bnll a inner join xxx.cdha_bnct b on a.id=b.id  inner join  medibv.cdha_loai c on a.id_loai=c.id inner join medibv.cdha_kythuat d on b.makt=d.makt and to_number(a.id_loai)=d.id_loaicdha and to_number(c.id)=d.id_loaicdha left join medibv.v_giavp h on d.id_vp=h.id  left join xxx.cdha_kqvp g on a.id=g.id and d.id_vp=g.mavp and b.id=g.id and a.id_loai=g.id_loaicdha ";
                sql += " where  to_date(to_char(a.ngay,'dd/mm/yyyy'),'dd/mm/yyyy') between to_date('" + s_tungay.Substring(0, 10) + "','dd/mm/yyyy') and to_date('" + s_denngay.Substring(0, 10) + "','dd/mm/yyyy') ";
                sql += " group by h.id_loai,case when a.id_loai<>'01' then a.bsdoc else case when a.id_loai='01' then a.bsdoc else '' end  end,case when a.id_loai<>'01' then a.ktv else '' end ";

                ads = get_data_mmyy(sql, s_tungay.Substring(0, 10), s_denngay.Substring(0, 10), khoangcach);
            }
            catch
            {
                return null;
            }
            return ads;
        }
        public DataSet f_getSoTienCDHA_LoaiVP(string s_tungay, string s_denngay, bool khoangcach)
        {
            string sql = "";
            DataSet ads = null;
            try
            {

                sql = "   select h.id_loai,sum(case when g.gia is null then h.gia_th else g.gia end) as sotien  ";
                sql += " from xxx.cdha_bnll a inner join xxx.cdha_bnct b on a.id=b.id  inner join  medibv.cdha_loai c on a.id_loai=c.id  inner join medibv.cdha_kythuat d on b.makt=d.makt and  ";
                sql += " to_number(a.id_loai)=d.id_loaicdha and to_number(c.id)=d.id_loaicdha  left join medibv.cdha_dsktv e on a.ktv=e.maktv left join medibv.cdha_dsktv f on a.bsdoc=f.maktv ";
                sql += " left join medibv.v_giavp h on d.id_vp=h.id  left join xxx.cdha_kqvp g on a.id=g.id and d.id_vp=g.mavp and b.id=g.id and a.id_loai=g.id_loaicdha";

                sql += " where  to_date(to_char(a.ngay,'dd/mm/yyyy'),'dd/mm/yyyy') between to_date('" + s_tungay.Substring(0, 10) + "','dd/mm/yyyy') and to_date('" + s_denngay.Substring(0, 10) + "','dd/mm/yyyy')  group by h.id_loai ";
                ads = get_data_mmyy(sql, s_tungay.Substring(0, 10), s_denngay.Substring(0, 10), khoangcach);
            }
            catch
            {
                return null;
            }
            return ads;
        }

        #endregion
        public bool upd_m_menuitem(string id, string id_menu, string id_goc, decimal stt, string ten)
        {
            sql = "update " + user + ".m_menuitem set id_menu=:id_menu,id_goc=:id_goc, stt=:stt,ten=:ten where id=:id ";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                try
                {
                    con.Open();
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("id", NpgsqlDbType.Varchar).Value = id;
                    cmd.Parameters.Add("id_menu", NpgsqlDbType.Varchar).Value = id_menu;
                    cmd.Parameters.Add("id_goc", NpgsqlDbType.Varchar).Value = id_goc;
                    cmd.Parameters.Add("stt", NpgsqlDbType.Numeric).Value = stt;
                    cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                    int num = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                    if (num == 0)
                    {
                        sql = "insert into " + user + ".m_menuitem(id,id_menu,id_goc,stt,ten) values (:id,:id_menu,:id_goc,:stt,:ten)";
                        cmd = new NpgsqlCommand(sql, con);
                        cmd.CommandType = CommandType.Text;
                        cmd.Parameters.Add("id", NpgsqlDbType.Varchar).Value = id;
                        cmd.Parameters.Add("id_menu", NpgsqlDbType.Varchar).Value = id_menu;
                        cmd.Parameters.Add("id_goc", NpgsqlDbType.Varchar).Value = id_goc;
                        cmd.Parameters.Add("stt", NpgsqlDbType.Numeric).Value = stt;
                        cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                        num = cmd.ExecuteNonQuery();
                        cmd.Dispose();
                    }
                }
                catch (NpgsqlException exception)
                {
                    upd_error(exception.Message, sComputer, "m_menuitem");
                    return false;
                }
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool bMahoamatkhau
        {
            get
            {
                return get_data("select ten from " + user + ".thongso where id=-13").Tables[0].Rows.Count > 0;
            }
        }

        /// <summary>
        /// Cùi bắp
        /// </summary>
        /// <param name="s"></param>
        /// <returns></returns>
        public string encode(string s)
        {
            string s1 = "";
            char c;
            byte b;
            s = s.Trim();
            for (int i = 0; i < s.Length; i++)
            {
                c = Convert.ToChar(s.Substring(i, 1).ToUpper());
                b = (byte)(c);
                s1 = s1 + Convert.ToChar((b % 2 == 0) ? b + 128 : b + 96);
            }
            return s1;
        }

        /// <summary>
        /// Cùi bắp
        /// </summary>
        /// <param name="s"></param>
        /// <returns></returns>
        public string decode(string s)
        {
            string s1 = "";
            char c;
            byte b;
            s = s.Trim();
            for (int i = 0; i < s.Length; i++)
            {
                c = Convert.ToChar(s.Substring(i, 1));
                b = (byte)(c);
                s1 = s1 + Convert.ToChar((b % 2 == 0) ? b - 128 : b - 96);
            }
            return s1;
        }

        public bool upd_dmdvchitra(decimal id, string ten)
        {
            sql = "update " + user + ".dmdvchitra set ten=:ten where id=" + id;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dmdvchitra(id,ten) values (" + id + ",:ten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dmdvchitra");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_ttptttkhoa(decimal id, string mabn, decimal maql, decimal idkhoa, string noidung, int userid)
        {
            sql = "update " + user + ".ttptttkhoa set mabn='" + mabn + "',maql=" + maql + ",idkhoa=" + idkhoa + ",noidung=:noidung,userid=" + userid + " where id=" + id;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("noidung", NpgsqlDbType.Text).Value = noidung;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".ttptttkhoa(id,mabn,maql,idkhoa,noidung,userid) values ";
                    sql += " (" + id + ",'" + mabn + "'," + maql + "," + idkhoa + ",:noidung," + userid + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("noidung", NpgsqlDbType.Text).Value = noidung;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ttptttkhoa");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public void close()
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
        }


        #region Bệnh án điện tử -- 10/02/2008
        public string normal(int loai)
        {
            ds = get_data("select ten from " + user + ".ba_danhmuc where loai=" + loai);
            if (ds.Tables[0].Rows.Count > 0) return ds.Tables[0].Rows[0]["ten"].ToString().Trim();
            else return "";
        }

        public string nor_toanthan
        {
            get { return normal(500); }
        }
        public string nor_tuanhoan
        {
            get { return normal(501); }
        }
        public string nor_hohap
        {
            get { return normal(502); }
        }
        public string nor_tieuhoa
        {
            get { return normal(503); }
        }
        public string nor_than
        {
            get { return normal(504); }
        }
        public string nor_thankinh
        {
            get { return normal(505); }
        }
        public string nor_co
        {
            get { return normal(506); }
        }
        public string nor_tmh
        {
            get { return normal(507); }
        }
        public string nor_rhm
        {
            get { return normal(508); }
        }
        public string nor_mat
        {
            get { return normal(509); }
        }
        public string nor_noitiet
        {
            get { return normal(510); }
        }
        public string nor_da
        {
            get { return normal(511); }
        }
        public string nor_hach
        {
            get { return normal(512); }
        }
        public string nor_vu
        {
            get { return normal(513); }
        }
        public string nor_da_mo
        {
            get { return normal(514); }
        }
        public bool bGiuong_plylenh
        {
            get { return false; }
        }

        public bool bPttt_makp_user
        {
            get { return false; }
        }
        public decimal get_idthuchien(string ngay, decimal idkhoa)
        {
            if (!bMmyy(mmyy(ngay))) return 0;
            ds = get_data("select id from " + user + mmyy(ngay) + ".ba_thuchien where idkhoa=" + idkhoa + " order by id desc");
            if (ds.Tables[0].Rows.Count == 0) return 0;
            else return decimal.Parse(ds.Tables[0].Rows[0]["id"].ToString());
        }
        public decimal get_idchung(string ngay, decimal idthuchien)
        {
            if (!bMmyy(mmyy(ngay))) return 0;
            ds = get_data("select id from " + user + mmyy(ngay) + ".ba_chung where idthuchien=" + idthuchien + " order by id");
            if (ds.Tables[0].Rows.Count == 0) return 0;
            else return decimal.Parse(ds.Tables[0].Rows[0]["id"].ToString());
        }

        public decimal get_idgayme(string ngay, decimal idthuchien)
        {
            if (!bMmyy(mmyy(ngay))) return 0;
            ds = get_data("select id from " + user + mmyy(ngay) + ".ba_gayme where idthuchien=" + idthuchien + " order by id");
            if (ds.Tables[0].Rows.Count == 0) return 0;
            else return decimal.Parse(ds.Tables[0].Rows[0]["id"].ToString());
        }

        public decimal get_idgayme(string ngay, decimal id, int stt)
        {
            if (!bMmyy(mmyy(ngay))) return 0;
            ds = get_data("select id from " + user + mmyy(ngay) + ".ba_gaymehinh where idgayme=" + id + " and stt=" + stt);
            if (ds.Tables[0].Rows.Count == 0) return 0;
            else return decimal.Parse(ds.Tables[0].Rows[0]["id"].ToString());
        }

        public bool upd_ba_vanchuyen(string m_mabn, decimal m_id, decimal m_idthuchien, string m_ngay,
            string m_khoaden, string m_ngayvv, string m_ngayrk, string m_ngayvk, decimal m_m_cc, string m_ha_cc,
            decimal m_nt_cc, decimal m_t_cc, int m_tg_cc, decimal m_m_vc, string m_ha_vc, decimal m_nt_vc, decimal m_t_vc,
            int m_tg_vc, decimal m_m_kd, string m_ha_kd, decimal m_nt_kd, decimal m_t_kd, int m_tg_kd,
            string m_bs_cc, string m_dd_cc, string m_bs_vc, string m_dd_vc, string m_bs_kd, string m_dd_kd, string m_khac,
            string m_luc, string m_vedenkhoa, decimal m_thangmay, decimal m_phongmo, decimal m_nhanbenh, int m_userid)
        {
            string xxx = user + mmyy(m_ngayvv);
            sql = "update " + xxx + ".ba_vanchuyen set mabn=:m_mabn,idthuchien=:m_idthuchien,ngay=to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),";
            sql += "khoaden=:m_khoaden,ngayvv=to_date(:m_ngayvv,'dd/mm/yyyy hh24:mi'),ngayrk=to_date(:m_ngayrk,'dd/mm/yyyy hh24:mi'),";
            sql += "ngayvk=to_date(:m_ngayvk,'dd/mm/yyyy hh24:mi'),";
            sql += "m_cc=:m_m_cc,ha_cc=:m_ha_cc,nt_cc=:m_nt_cc,t_cc=:m_t_cc,tg_cc=:m_tg_cc,";
            sql += "m_vc=:m_m_vc,ha_vc=:m_ha_vc,nt_vc=:m_nt_vc,t_vc=:m_t_vc,tg_vc=:m_tg_vc,";
            sql += "m_kd=:m_m_kd,ha_kd=:m_ha_kd,nt_kd=:m_nt_kd,t_kd=:m_t_kd,tg_kd=:m_tg_kd,";
            sql += "bs_cc=:m_bs_cc,dd_cc=:m_dd_cc,bs_vc=:m_bs_vc,dd_vc=:m_dd_vc,bs_kd=:m_bs_kd,dd_kd=:m_dd_kd,";
            sql += "khac=:m_khac,luc=to_date(:m_luc,'dd/mm/yyyy hh24:mi'),vedenkhoa=to_date(:m_vedenkhoa,'dd/mm/yyyy hh24:mi'),";
            sql += "thangmay=:m_thangmay,phongmo=:m_phongmo,nhanbenh=:m_nhanbenh,";
            sql += "userid=:m_userid where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                cmd.Parameters.Add("m_khoaden", NpgsqlDbType.Text).Value = m_khoaden;
                cmd.Parameters.Add("m_ngayvv", NpgsqlDbType.Varchar, 16).Value = m_ngayvv;
                cmd.Parameters.Add("m_ngayrk", NpgsqlDbType.Varchar, 16).Value = m_ngayrk;
                cmd.Parameters.Add("m_ngayvk", NpgsqlDbType.Varchar, 16).Value = m_ngayvk;
                cmd.Parameters.Add("m_m_cc", NpgsqlDbType.Numeric).Value = m_m_cc;
                cmd.Parameters.Add("m_ha_cc", NpgsqlDbType.Varchar, 7).Value = m_ha_cc;
                cmd.Parameters.Add("m_nt_cc", NpgsqlDbType.Numeric).Value = m_nt_cc;
                cmd.Parameters.Add("m_t_cc", NpgsqlDbType.Numeric).Value = m_t_cc;
                cmd.Parameters.Add("m_tg_cc", NpgsqlDbType.Numeric).Value = m_tg_cc;
                cmd.Parameters.Add("m_m_vc", NpgsqlDbType.Numeric).Value = m_m_vc;
                cmd.Parameters.Add("m_ha_vc", NpgsqlDbType.Varchar, 7).Value = m_ha_vc;
                cmd.Parameters.Add("m_nt_vc", NpgsqlDbType.Numeric).Value = m_nt_vc;
                cmd.Parameters.Add("m_t_vc", NpgsqlDbType.Numeric).Value = m_t_vc;
                cmd.Parameters.Add("m_tg_vc", NpgsqlDbType.Numeric).Value = m_tg_vc;
                cmd.Parameters.Add("m_m_kd", NpgsqlDbType.Numeric).Value = m_m_kd;
                cmd.Parameters.Add("m_ha_kd", NpgsqlDbType.Varchar, 7).Value = m_ha_kd;
                cmd.Parameters.Add("m_nt_kd", NpgsqlDbType.Numeric).Value = m_nt_kd;
                cmd.Parameters.Add("m_t_kd", NpgsqlDbType.Numeric).Value = m_t_kd;
                cmd.Parameters.Add("m_tg_kd", NpgsqlDbType.Numeric).Value = m_tg_kd;
                cmd.Parameters.Add("m_bs_cc", NpgsqlDbType.Varchar, 4).Value = m_bs_cc;
                cmd.Parameters.Add("m_dd_cc", NpgsqlDbType.Varchar, 4).Value = m_dd_cc;
                cmd.Parameters.Add("m_bs_vc", NpgsqlDbType.Varchar, 4).Value = m_bs_vc;
                cmd.Parameters.Add("m_dd_vc", NpgsqlDbType.Varchar, 4).Value = m_dd_vc;
                cmd.Parameters.Add("m_bs_kd", NpgsqlDbType.Varchar, 4).Value = m_bs_kd;
                cmd.Parameters.Add("m_dd_kd", NpgsqlDbType.Varchar, 4).Value = m_dd_kd;
                cmd.Parameters.Add("m_khac", NpgsqlDbType.Text).Value = m_khac;
                cmd.Parameters.Add("m_luc", NpgsqlDbType.Varchar, 16).Value = m_luc;
                cmd.Parameters.Add("m_vedenkhoa", NpgsqlDbType.Varchar, 16).Value = m_vedenkhoa;
                cmd.Parameters.Add("m_thangmay", NpgsqlDbType.Numeric).Value = m_thangmay;
                cmd.Parameters.Add("m_phongmo", NpgsqlDbType.Numeric).Value = m_phongmo;
                cmd.Parameters.Add("m_nhanbenh", NpgsqlDbType.Numeric).Value = m_nhanbenh;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_vanchuyen (mabn,id,idthuchien,ngay,khoaden,ngayvv,ngayrk,ngayvk,m_cc,ha_cc,nt_cc,t_cc,tg_cc,";
                    sql += "m_vc,ha_vc,nt_vc,t_vc,tg_vc,m_kd,ha_kd,nt_kd,t_kd,tg_kd,bs_cc,dd_cc,bs_vc,dd_vc,bs_kd,dd_kd,khac,";
                    sql += "luc,vedenkhoa,thangmay,phongmo,nhanbenh,userid) values";
                    sql += " (:m_id,:m_idthuchien,to_date(:m_mabn,:m_ngay,'dd/mm/yyyy hh24:mi'),:m_khoaden,to_date(:m_ngayvv,'dd/mm/yyyy hh24:mi'),to_date(:m_ngayrk,'dd/mm/yyyy hh24:mi'),to_date(:m_ngayvk,'dd/mm/yyyy hh24:mi'),:m_m_cc,:m_ha_cc,:m_nt_cc,:m_t_cc,:m_tg_cc,";
                    sql += ":m_m_vc,:m_ha_vc,:m_nt_vc,:m_t_vc,:m_tg_vc,:m_m_kd,:m_ha_kd,:m_nt_kd,:m_t_kd,:m_tg_kd,:m_bs_cc,:m_dd_cc,:m_bs_vc,:m_dd_vc,:m_bs_kd,:m_dd_kd,:m_khac,";
                    sql += "to_date(:m_luc,'dd/mm/yyyy hh24:mi'),to_date(:m_vedenkhoa,'dd/mm/yyyy hh24:mi'),:m_thangmay,:m_phongmo,:m_nhanbenh,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                    cmd.Parameters.Add("m_khoaden", NpgsqlDbType.Text).Value = m_khoaden;
                    cmd.Parameters.Add("m_ngayvv", NpgsqlDbType.Varchar, 16).Value = m_ngayvv;
                    cmd.Parameters.Add("m_ngayrk", NpgsqlDbType.Varchar, 16).Value = m_ngayrk;
                    cmd.Parameters.Add("m_ngayvk", NpgsqlDbType.Varchar, 16).Value = m_ngayvk;
                    cmd.Parameters.Add("m_m_cc", NpgsqlDbType.Numeric).Value = m_m_cc;
                    cmd.Parameters.Add("m_ha_cc", NpgsqlDbType.Varchar, 7).Value = m_ha_cc;
                    cmd.Parameters.Add("m_nt_cc", NpgsqlDbType.Numeric).Value = m_nt_cc;
                    cmd.Parameters.Add("m_t_cc", NpgsqlDbType.Numeric).Value = m_t_cc;
                    cmd.Parameters.Add("m_tg_cc", NpgsqlDbType.Numeric).Value = m_tg_cc;
                    cmd.Parameters.Add("m_m_vc", NpgsqlDbType.Numeric).Value = m_m_vc;
                    cmd.Parameters.Add("m_ha_vc", NpgsqlDbType.Varchar, 7).Value = m_ha_vc;
                    cmd.Parameters.Add("m_nt_vc", NpgsqlDbType.Numeric).Value = m_nt_vc;
                    cmd.Parameters.Add("m_t_vc", NpgsqlDbType.Numeric).Value = m_t_vc;
                    cmd.Parameters.Add("m_tg_vc", NpgsqlDbType.Numeric).Value = m_tg_vc;
                    cmd.Parameters.Add("m_m_kd", NpgsqlDbType.Numeric).Value = m_m_kd;
                    cmd.Parameters.Add("m_ha_kd", NpgsqlDbType.Varchar, 7).Value = m_ha_kd;
                    cmd.Parameters.Add("m_nt_kd", NpgsqlDbType.Numeric).Value = m_nt_kd;
                    cmd.Parameters.Add("m_t_kd", NpgsqlDbType.Numeric).Value = m_t_kd;
                    cmd.Parameters.Add("m_tg_kd", NpgsqlDbType.Numeric).Value = m_tg_kd;
                    cmd.Parameters.Add("m_bs_cc", NpgsqlDbType.Varchar, 4).Value = m_bs_cc;
                    cmd.Parameters.Add("m_dd_cc", NpgsqlDbType.Varchar, 4).Value = m_dd_cc;
                    cmd.Parameters.Add("m_bs_vc", NpgsqlDbType.Varchar, 4).Value = m_bs_vc;
                    cmd.Parameters.Add("m_dd_vc", NpgsqlDbType.Varchar, 4).Value = m_dd_vc;
                    cmd.Parameters.Add("m_bs_kd", NpgsqlDbType.Varchar, 4).Value = m_bs_kd;
                    cmd.Parameters.Add("m_dd_kd", NpgsqlDbType.Varchar, 4).Value = m_dd_kd;
                    cmd.Parameters.Add("m_khac", NpgsqlDbType.Text).Value = m_khac;
                    cmd.Parameters.Add("m_luc", NpgsqlDbType.Varchar, 16).Value = m_luc;
                    cmd.Parameters.Add("m_vedenkhoa", NpgsqlDbType.Varchar, 16).Value = m_vedenkhoa;
                    cmd.Parameters.Add("m_thangmay", NpgsqlDbType.Numeric).Value = m_thangmay;
                    cmd.Parameters.Add("m_phongmo", NpgsqlDbType.Numeric).Value = m_phongmo;
                    cmd.Parameters.Add("m_nhanbenh", NpgsqlDbType.Numeric).Value = m_nhanbenh;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_vanchuyen");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_vanchuyenct(string m_ngayvv, decimal m_id, decimal m_stt, int m_cc, int m_vc, int m_kd)
        {
            string xxx = user + mmyy(m_ngayvv);
            sql = "update " + xxx + ".ba_vanchuyenct set cc=:m_cc,vc=:m_vc,kd=:m_kd where id=:m_id and stt=:m_stt";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_cc", NpgsqlDbType.Numeric).Value = m_cc;
                cmd.Parameters.Add("m_vc", NpgsqlDbType.Numeric).Value = m_vc;
                cmd.Parameters.Add("m_kd", NpgsqlDbType.Numeric).Value = m_kd;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_vanchuyenct (id,stt,cc,vc,kd) values (:m_id,:m_stt,:m_cc,:m_vc,:m_kd)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_cc", NpgsqlDbType.Numeric).Value = m_cc;
                    cmd.Parameters.Add("m_vc", NpgsqlDbType.Numeric).Value = m_vc;
                    cmd.Parameters.Add("m_kd", NpgsqlDbType.Numeric).Value = m_kd;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_vanchuyenct");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_chuyenbenh(decimal m_id, decimal m_idthuchien, string m_ngay,
            string m_thannhan, string m_taisan, string m_ngayvv, string m_ngaycv, string m_tu, string m_den,
            string m_mabs, string m_lydo, string m_cd_noikhoa, string m_cd_ngoaikhoa, string m_cd_khac,
            string m_tongtrang, string m_giaotiep, string m_chedoan, string m_vesinh, string m_baitiet,
            string m_vandong, string m_trilieu, string m_cachly, string m_oxy, string m_luuthong,
            string m_loai, string m_khidung, string m_vetthuong, decimal m_thaybang, int m_ngoaibien,
            string m_ngoaibien_vt, int m_trungtam, string m_trungtam_vt, int m_thongtieu,
            string m_thongtieu_vt, string m_vanmach, string m_khangdong, string m_anthan,
            string m_dichtruyen, string m_mau, string m_khac, string m_bangiaokhac, string m_yta, int m_userid)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_chuyenbenh set idthuchien=:m_idthuchien,ngay=to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),";
            sql += "thannhan=:m_thannhan,taisan=:m_taisan,ngayvv=to_date(:m_ngayvv,'dd/mm/yyyy hh24:mi'),";
            sql += "ngaycv=to_date(:m_ngaycv,'dd/mm/yyyy hh24:mi'),tu=:m_tu,den=:m_den,mabs=:m_mabs,lydo=:m_lydo,";
            sql += "cd_noikhoa=:m_cd_noikhoa,cd_ngoaikhoa=:m_cd_ngoaikhoa,cd_khac=:m_cd_khac,";
            sql += "tongtrang=:m_tongtrang,giaotiep=:m_giaotiep,chedoan=:m_chedoan,vesinh=:m_vesinh,baitiet=:m_baitiet,";
            sql += "vandong=:m_vandong,trilieu=:m_trilieu,cachly=:m_cachly,oxy=:m_oxy,luuthong=:m_luuthong,";
            sql += "loai=:m_loai,khidung=:m_khidung,vetthuong=:m_vetthuong,thaybang=:m_thaybang,ngoaibien=:m_ngoaibien,";
            sql += "ngoaibien_vt=:m_ngoaibien_vt,trungtam=:m_trungtam,trungtam_vt=:m_trungtam_vt,thongtieu=:m_thongtieu,";
            sql += "thongtieu_vt=:m_thongtieu_vt,vanmach=:m_vanmach,khangdong=:m_khangdong,anthan=:m_anthan,";
            sql += "dichtruyen=:m_dichtruyen,mau=:m_mau,khac=:m_khac,bangiaokhac=:m_bangiaokhac,yta=:m_yta,";
            sql += "userid=:m_userid where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                cmd.Parameters.Add("m_thannhan", NpgsqlDbType.Text).Value = m_thannhan;
                cmd.Parameters.Add("m_taisan", NpgsqlDbType.Text).Value = m_taisan;
                cmd.Parameters.Add("m_ngayvv", NpgsqlDbType.Varchar, 16).Value = m_ngayvv;
                cmd.Parameters.Add("m_ngaycv", NpgsqlDbType.Varchar, 16).Value = m_ngaycv;
                cmd.Parameters.Add("m_tu", NpgsqlDbType.Text).Value = m_tu;
                cmd.Parameters.Add("m_den", NpgsqlDbType.Text).Value = m_den;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_lydo", NpgsqlDbType.Text).Value = m_lydo;
                cmd.Parameters.Add("m_cd_noikhoa", NpgsqlDbType.Text).Value = m_cd_noikhoa;
                cmd.Parameters.Add("m_cd_ngoaikhoa", NpgsqlDbType.Text).Value = m_cd_ngoaikhoa;
                cmd.Parameters.Add("m_cd_khac", NpgsqlDbType.Text).Value = m_cd_khac;
                cmd.Parameters.Add("m_tongtrang", NpgsqlDbType.Text).Value = m_tongtrang;
                cmd.Parameters.Add("m_giaotiep", NpgsqlDbType.Text).Value = m_giaotiep;
                cmd.Parameters.Add("m_chedoan", NpgsqlDbType.Text).Value = m_chedoan;
                cmd.Parameters.Add("m_vesinh", NpgsqlDbType.Text).Value = m_vesinh;
                cmd.Parameters.Add("m_baitiet", NpgsqlDbType.Text).Value = m_baitiet;
                cmd.Parameters.Add("m_vandong", NpgsqlDbType.Text).Value = m_vandong;
                cmd.Parameters.Add("m_trilieu", NpgsqlDbType.Text).Value = m_trilieu;
                cmd.Parameters.Add("m_cachly", NpgsqlDbType.Text).Value = m_cachly;
                cmd.Parameters.Add("m_oxy", NpgsqlDbType.Text).Value = m_oxy;
                cmd.Parameters.Add("m_luuthong", NpgsqlDbType.Text).Value = m_luuthong;
                cmd.Parameters.Add("m_loai", NpgsqlDbType.Text).Value = m_loai;
                cmd.Parameters.Add("m_khidung", NpgsqlDbType.Text).Value = m_khidung;
                cmd.Parameters.Add("m_vetthuong", NpgsqlDbType.Text).Value = m_vetthuong;
                cmd.Parameters.Add("m_thaybang", NpgsqlDbType.Numeric).Value = m_thaybang;
                cmd.Parameters.Add("m_ngoaibien", NpgsqlDbType.Numeric).Value = m_ngoaibien;
                cmd.Parameters.Add("m_ngoaibien_vt", NpgsqlDbType.Text).Value = m_ngoaibien_vt;
                cmd.Parameters.Add("m_trungtam", NpgsqlDbType.Numeric).Value = m_trungtam;
                cmd.Parameters.Add("m_trungtam_vt", NpgsqlDbType.Text).Value = m_trungtam_vt;
                cmd.Parameters.Add("m_thongtieu", NpgsqlDbType.Numeric).Value = m_thongtieu;
                cmd.Parameters.Add("m_thongtieu_vt", NpgsqlDbType.Text).Value = m_thongtieu_vt;
                cmd.Parameters.Add("m_vanmach", NpgsqlDbType.Text).Value = m_vanmach;
                cmd.Parameters.Add("m_khangdong", NpgsqlDbType.Text).Value = m_khangdong;
                cmd.Parameters.Add("m_anthan", NpgsqlDbType.Text).Value = m_anthan;
                cmd.Parameters.Add("m_dichtruyen", NpgsqlDbType.Text).Value = m_dichtruyen;
                cmd.Parameters.Add("m_mau", NpgsqlDbType.Text).Value = m_mau;
                cmd.Parameters.Add("m_khac", NpgsqlDbType.Text).Value = m_khac;
                cmd.Parameters.Add("m_bangiaokhac", NpgsqlDbType.Text).Value = m_bangiaokhac;
                cmd.Parameters.Add("m_yta", NpgsqlDbType.Varchar, 4).Value = m_yta;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_chuyenbenh (id,idthuchien,ngay,thannhan,taisan,ngayvv,ngaycv,";
                    sql += "tu,den,mabs,lydo,cd_noikhoa,cd_ngoaikhoa,cd_khac,tongtrang,giaotiep,chedoan,vesinh,baitiet,";
                    sql += "vandong,trilieu,cachly,oxy,luuthong,loai,khidung,vetthuong,thaybang,ngoaibien,";
                    sql += "ngoaibien_vt,trungtam,trungtam_vt,thongtieu,thongtieu_vt,vanmach,khangdong,anthan,";
                    sql += "dichtruyen,mau,khac,bangiaokhac,yta,userid) values";
                    sql += " (:m_id,:m_idthuchien,to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),:m_thannhan,:m_taisan,to_date(:m_ngayvv,'dd/mm/yyyy hh24:mi'),to_date(:m_ngaycv,'dd/mm/yyyy hh24:mi'),";
                    sql += ":m_tu,:m_den,:m_mabs,:m_lydo,:m_cd_noikhoa,:m_cd_ngoaikhoa,:m_cd_khac,:m_tongtrang,:m_giaotiep,:m_chedoan,:m_vesinh,:m_baitiet,";
                    sql += ":m_vandong,:m_trilieu,:m_cachly,:m_oxy,:m_luuthong,:m_loai,:m_khidung,:m_vetthuong,:m_thaybang,:m_ngoaibien,";
                    sql += ":m_ngoaibien_vt,:m_trungtam,:m_trungtam_vt,:m_thongtieu,:m_thongtieu_vt,:m_vanmach,:m_khangdong,:m_anthan,";
                    sql += ":m_dichtruyen,:m_mau,:m_khac,:m_bangiaokhac,:m_yta,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                    cmd.Parameters.Add("m_thannhan", NpgsqlDbType.Text).Value = m_thannhan;
                    cmd.Parameters.Add("m_taisan", NpgsqlDbType.Text).Value = m_taisan;
                    cmd.Parameters.Add("m_ngayvv", NpgsqlDbType.Varchar, 16).Value = m_ngayvv;
                    cmd.Parameters.Add("m_ngaycv", NpgsqlDbType.Varchar, 16).Value = m_ngaycv;
                    cmd.Parameters.Add("m_tu", NpgsqlDbType.Text).Value = m_tu;
                    cmd.Parameters.Add("m_den", NpgsqlDbType.Text).Value = m_den;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    cmd.Parameters.Add("m_lydo", NpgsqlDbType.Text).Value = m_lydo;
                    cmd.Parameters.Add("m_cd_noikhoa", NpgsqlDbType.Text).Value = m_cd_noikhoa;
                    cmd.Parameters.Add("m_cd_ngoaikhoa", NpgsqlDbType.Text).Value = m_cd_ngoaikhoa;
                    cmd.Parameters.Add("m_cd_khac", NpgsqlDbType.Text).Value = m_cd_khac;
                    cmd.Parameters.Add("m_tongtrang", NpgsqlDbType.Text).Value = m_tongtrang;
                    cmd.Parameters.Add("m_giaotiep", NpgsqlDbType.Text).Value = m_giaotiep;
                    cmd.Parameters.Add("m_chedoan", NpgsqlDbType.Text).Value = m_chedoan;
                    cmd.Parameters.Add("m_vesinh", NpgsqlDbType.Text).Value = m_vesinh;
                    cmd.Parameters.Add("m_baitiet", NpgsqlDbType.Text).Value = m_baitiet;
                    cmd.Parameters.Add("m_vandong", NpgsqlDbType.Text).Value = m_vandong;
                    cmd.Parameters.Add("m_trilieu", NpgsqlDbType.Text).Value = m_trilieu;
                    cmd.Parameters.Add("m_cachly", NpgsqlDbType.Text).Value = m_cachly;
                    cmd.Parameters.Add("m_oxy", NpgsqlDbType.Text).Value = m_oxy;
                    cmd.Parameters.Add("m_luuthong", NpgsqlDbType.Text).Value = m_luuthong;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Text).Value = m_loai;
                    cmd.Parameters.Add("m_khidung", NpgsqlDbType.Text).Value = m_khidung;
                    cmd.Parameters.Add("m_vetthuong", NpgsqlDbType.Text).Value = m_vetthuong;
                    cmd.Parameters.Add("m_thaybang", NpgsqlDbType.Numeric).Value = m_thaybang;
                    cmd.Parameters.Add("m_ngoaibien", NpgsqlDbType.Numeric).Value = m_ngoaibien;
                    cmd.Parameters.Add("m_ngoaibien_vt", NpgsqlDbType.Text).Value = m_ngoaibien_vt;
                    cmd.Parameters.Add("m_trungtam", NpgsqlDbType.Numeric).Value = m_trungtam;
                    cmd.Parameters.Add("m_trungtam_vt", NpgsqlDbType.Text).Value = m_trungtam_vt;
                    cmd.Parameters.Add("m_thongtieu", NpgsqlDbType.Numeric).Value = m_thongtieu;
                    cmd.Parameters.Add("m_thongtieu_vt", NpgsqlDbType.Text).Value = m_thongtieu_vt;
                    cmd.Parameters.Add("m_vanmach", NpgsqlDbType.Text).Value = m_vanmach;
                    cmd.Parameters.Add("m_khangdong", NpgsqlDbType.Text).Value = m_khangdong;
                    cmd.Parameters.Add("m_anthan", NpgsqlDbType.Text).Value = m_anthan;
                    cmd.Parameters.Add("m_dichtruyen", NpgsqlDbType.Text).Value = m_dichtruyen;
                    cmd.Parameters.Add("m_mau", NpgsqlDbType.Text).Value = m_mau;
                    cmd.Parameters.Add("m_khac", NpgsqlDbType.Text).Value = m_khac;
                    cmd.Parameters.Add("m_bangiaokhac", NpgsqlDbType.Text).Value = m_bangiaokhac;
                    cmd.Parameters.Add("m_yta", NpgsqlDbType.Varchar, 4).Value = m_yta;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_chuyenbenh");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_chuyenbenhct(string m_ngay, decimal m_id, decimal m_stt, string m_ten, string m_vitri)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_chuyenbenhct set ten=:m_ten,vitri=:m_vitri where id=:m_id and stt=:m_stt";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_vitri", NpgsqlDbType.Text).Value = m_vitri;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_chuyenbenhct (id,stt,ten,vitri) values (:m_id,:m_stt,:m_ten,:m_vitri)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    cmd.Parameters.Add("m_vitri", NpgsqlDbType.Text).Value = m_vitri;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_chuyenbenhct");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_giaonhan(string m_mabn, decimal m_id, decimal m_idthuchien, string m_ngay, string m_trigiac, decimal m_mach, decimal m_nhietdo, string m_huyetap, decimal m_nhiptho, decimal m_cannang, decimal m_spo2, string m_camtay, string m_yta, int m_userid)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_giaonhan set mabn=:m_mabn,idthuchien=:m_idthuchien,ngay=to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),trigiac=:m_trigiac,mach=:m_mach,nhietdo=:m_nhietdo,huyetap=:m_huyetap,nhiptho=:m_nhiptho,cannang=:m_cannang,spo2=:m_spo2,camtay=:m_camtay,yta=:m_yta,userid=:m_userid where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                cmd.Parameters.Add("m_trigiac", NpgsqlDbType.Text).Value = m_trigiac;
                cmd.Parameters.Add("m_mach", NpgsqlDbType.Numeric).Value = m_mach;
                cmd.Parameters.Add("m_nhietdo", NpgsqlDbType.Numeric).Value = m_nhietdo;
                cmd.Parameters.Add("m_huyetap", NpgsqlDbType.Varchar, 7).Value = m_huyetap;
                cmd.Parameters.Add("m_nhiptho", NpgsqlDbType.Numeric).Value = m_nhiptho;
                cmd.Parameters.Add("m_cannang", NpgsqlDbType.Numeric).Value = m_cannang;
                cmd.Parameters.Add("m_spo2", NpgsqlDbType.Numeric).Value = m_spo2;
                cmd.Parameters.Add("m_camtay", NpgsqlDbType.Text).Value = m_camtay;
                cmd.Parameters.Add("m_yta", NpgsqlDbType.Varchar, 4).Value = m_yta;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_giaonhan (mabn,id,idthuchien,ngay,trigiac,mach,nhietdo,huyetap,nhiptho,cannang,spo2,camtay,yta,userid) values (:m_mabn,:m_id,:m_idthuchien,to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),:m_trigiac,:m_mach,:m_nhietdo,:m_huyetap,:m_nhiptho,:m_cannang,:m_spo2,:m_camtay,:m_yta,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                    cmd.Parameters.Add("m_trigiac", NpgsqlDbType.Text).Value = m_trigiac;
                    cmd.Parameters.Add("m_mach", NpgsqlDbType.Numeric).Value = m_mach;
                    cmd.Parameters.Add("m_nhietdo", NpgsqlDbType.Numeric).Value = m_nhietdo;
                    cmd.Parameters.Add("m_huyetap", NpgsqlDbType.Varchar, 7).Value = m_huyetap;
                    cmd.Parameters.Add("m_nhiptho", NpgsqlDbType.Numeric).Value = m_nhiptho;
                    cmd.Parameters.Add("m_cannang", NpgsqlDbType.Numeric).Value = m_cannang;
                    cmd.Parameters.Add("m_spo2", NpgsqlDbType.Numeric).Value = m_spo2;
                    cmd.Parameters.Add("m_camtay", NpgsqlDbType.Text).Value = m_camtay;
                    cmd.Parameters.Add("m_yta", NpgsqlDbType.Varchar, 4).Value = m_yta;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_giaonhan");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_giaonhanct(string m_ngay, decimal m_id, decimal m_stt, decimal m_soluong, string m_loai)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_giaonhanct set soluong=:m_soluong,loai=:m_loai where id=:m_id and stt=:m_stt";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_soluong", NpgsqlDbType.Numeric).Value = m_soluong;
                cmd.Parameters.Add("m_loai", NpgsqlDbType.Text).Value = m_loai;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_giaonhanct (id,stt,soluong,loai) values (:m_id,:m_stt,:m_soluong,:m_loai)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_soluong", NpgsqlDbType.Numeric).Value = m_soluong;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Text).Value = m_loai;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_giaonhanct");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_scan(string m_ngayvv, string m_mabn, decimal m_id, int m_stt, string m_ngay, int m_nhom, int m_loai, string m_ten, byte[] m_image)
        {
            string xxx = user + mmyy(m_ngayvv);
            sql = "update " + xxx + ".ba_scan set mabn=:m_mabn,ngay=to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),nhom=:m_nhom,loai=:m_loai,ten=:m_ten,image=:m_image where id=:m_id and stt=:m_stt";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                cmd.Parameters.Add("m_nhom", NpgsqlDbType.Numeric).Value = m_nhom;
                cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_image", NpgsqlDbType.Bytea, m_image.Length).Value = m_image;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_scan (mabn,id,stt,ngay,nhom,loai,ten,image) values (:m_mabn,:m_id,:m_stt,to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),:m_nhom,:m_loai,:m_ten,:m_image)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                    cmd.Parameters.Add("m_nhom", NpgsqlDbType.Numeric).Value = m_nhom;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    cmd.Parameters.Add("m_image", NpgsqlDbType.Bytea, m_image.Length).Value = m_image;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_scan");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_loaiphieu(decimal m_id, decimal m_stt, string m_report, string m_ten, string m_noidung, string m_ketqua, int m_thuchien, int m_tinhtrang, int m_lanthu, string m_hen, int m_cannang, int m_chieucao)
        {
            sql = "update ba_loaiphieu set stt=:m_stt,report=:m_report,ten=:m_ten,noidung=:m_noidung,ketqua=:m_ketqua,";
            sql += "thuchien=:m_thuchien,tinhtrang=:m_tinhtrang,lanthu=:m_lanthu,hen=:m_hen,cannang=:m_cannang,chieucao=:m_chieucao";
            sql += " where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                cmd.Parameters.Add("m_report", NpgsqlDbType.Varchar, 30).Value = m_report;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_noidung", NpgsqlDbType.Text).Value = m_noidung;
                cmd.Parameters.Add("m_ketqua", NpgsqlDbType.Text).Value = m_ketqua;
                cmd.Parameters.Add("m_thuchien", NpgsqlDbType.Numeric).Value = m_thuchien;
                cmd.Parameters.Add("m_tinhtrang", NpgsqlDbType.Numeric).Value = m_tinhtrang;
                cmd.Parameters.Add("m_lanthu", NpgsqlDbType.Numeric).Value = m_lanthu;
                cmd.Parameters.Add("m_hen", NpgsqlDbType.Text).Value = m_hen;
                cmd.Parameters.Add("m_cannang", NpgsqlDbType.Numeric).Value = m_cannang;
                cmd.Parameters.Add("m_chieucao", NpgsqlDbType.Numeric).Value = m_chieucao;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into ba_loaiphieu (id,stt,report,ten,noidung,ketqua,thuchien,tinhtrang,lanthu,hen,cannang,chieucao) values (:m_id,:m_stt,:m_report,:m_ten,:m_noidung,:m_ketqua,:m_thuchien,:m_tinhtrang,:m_lanthu,:m_hen,:m_cannang,:m_chieucao)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_report", NpgsqlDbType.Varchar, 30).Value = m_report;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    cmd.Parameters.Add("m_noidung", NpgsqlDbType.Text).Value = m_noidung;
                    cmd.Parameters.Add("m_ketqua", NpgsqlDbType.Text).Value = m_ketqua;
                    cmd.Parameters.Add("m_thuchien", NpgsqlDbType.Numeric).Value = m_thuchien;
                    cmd.Parameters.Add("m_tinhtrang", NpgsqlDbType.Numeric).Value = m_tinhtrang;
                    cmd.Parameters.Add("m_lanthu", NpgsqlDbType.Numeric).Value = m_lanthu;
                    cmd.Parameters.Add("m_hen", NpgsqlDbType.Text).Value = m_hen;
                    cmd.Parameters.Add("m_cannang", NpgsqlDbType.Numeric).Value = m_cannang;
                    cmd.Parameters.Add("m_chieucao", NpgsqlDbType.Numeric).Value = m_chieucao;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_loaiphieu");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_soket(string m_ngayvv, string m_mabn, decimal m_id, decimal m_idthuchien, string m_ngay, string m_dienbien, string m_cls, string m_dieutri, string m_ketqua, string m_tienluong, string m_bstruong, string m_mabs, int m_userid)
        {
            string xxx = user + mmyy(m_ngayvv);
            sql = "update " + xxx + ".ba_soket set mabn=:m_mabn,idthuchien=:m_idthuchien,ngay=to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),";
            sql += "dienbien=:m_dienbien,cls=:m_cls,dieutri=:m_dieutri,ketqua=:m_ketqua,tienluong=:m_tienluong,";
            sql += "bstruong=:m_bstruong,mabs=:m_mabs,userid=:m_userid where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                cmd.Parameters.Add("m_dienbien", NpgsqlDbType.Text).Value = m_dienbien;
                cmd.Parameters.Add("m_cls", NpgsqlDbType.Text).Value = m_cls;
                cmd.Parameters.Add("m_dieutri", NpgsqlDbType.Text).Value = m_dieutri;
                cmd.Parameters.Add("m_ketqua", NpgsqlDbType.Text).Value = m_ketqua;
                cmd.Parameters.Add("m_tienluong", NpgsqlDbType.Text).Value = m_tienluong;
                cmd.Parameters.Add("m_bstruong", NpgsqlDbType.Varchar, 4).Value = m_bstruong;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_soket (mabn,id,idthuchien,ngay,dienbien,cls,dieutri,ketqua,tienluong,bstruong,mabs,userid) values (:m_mabn,:m_id,:m_idthuchien,to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),:m_dienbien,:m_cls,:m_dieutri,:m_ketqua,:m_tienluong,:m_bstruong,:m_mabs,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                    cmd.Parameters.Add("m_dienbien", NpgsqlDbType.Text).Value = m_dienbien;
                    cmd.Parameters.Add("m_cls", NpgsqlDbType.Text).Value = m_cls;
                    cmd.Parameters.Add("m_dieutri", NpgsqlDbType.Text).Value = m_dieutri;
                    cmd.Parameters.Add("m_ketqua", NpgsqlDbType.Text).Value = m_ketqua;
                    cmd.Parameters.Add("m_tienluong", NpgsqlDbType.Text).Value = m_tienluong;
                    cmd.Parameters.Add("m_bstruong", NpgsqlDbType.Varchar, 4).Value = m_bstruong;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_soket");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_tiensusk(string m_ngayvv, decimal m_id, decimal m_stt, string m_nam, int m_duthieu, int m_sayhutnao, int m_covac, int m_ngoaitrung, int m_chetsong, decimal m_cannang, int m_ppde, int m_taibien)
        {
            string xxx = user + mmyy(m_ngayvv);
            sql = "update " + xxx + ".ba_tiensusk set nam=:m_nam,duthieu=:m_duthieu,sayhutnao=:m_sayhutnao,covac=:m_covac,";
            sql += "ngoaitrung=:m_ngoaitrung,chetsong=:m_chetsong,cannang=:m_cannang,ppde=:m_ppde,taibien=:m_taibien ";
            sql += " where id=:m_id and stt=:m_stt";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_nam", NpgsqlDbType.Varchar, 4).Value = m_nam;
                cmd.Parameters.Add("m_duthieu", NpgsqlDbType.Numeric).Value = m_duthieu;
                cmd.Parameters.Add("m_sayhutnao", NpgsqlDbType.Numeric).Value = m_sayhutnao;
                cmd.Parameters.Add("m_covac", NpgsqlDbType.Numeric).Value = m_covac;
                cmd.Parameters.Add("m_ngoaitrung", NpgsqlDbType.Numeric).Value = m_ngoaitrung;
                cmd.Parameters.Add("m_chetsong", NpgsqlDbType.Numeric).Value = m_chetsong;
                cmd.Parameters.Add("m_cannang", NpgsqlDbType.Numeric).Value = m_cannang;
                cmd.Parameters.Add("m_ppde", NpgsqlDbType.Numeric).Value = m_ppde;
                cmd.Parameters.Add("m_taibien", NpgsqlDbType.Numeric).Value = m_taibien;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_tiensusk (id,stt,nam,duthieu,sayhutnao,covac,ngoaitrung,chetsong,cannang,ppde,taibien) values (:m_id,:m_stt,:m_nam,:m_duthieu,:m_sayhutnao,:m_covac,:m_ngoaitrung,:m_chetsong,:m_cannang,:m_ppde,:m_taibien)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_nam", NpgsqlDbType.Varchar, 4).Value = m_nam;
                    cmd.Parameters.Add("m_duthieu", NpgsqlDbType.Numeric).Value = m_duthieu;
                    cmd.Parameters.Add("m_sayhutnao", NpgsqlDbType.Numeric).Value = m_sayhutnao;
                    cmd.Parameters.Add("m_covac", NpgsqlDbType.Numeric).Value = m_covac;
                    cmd.Parameters.Add("m_ngoaitrung", NpgsqlDbType.Numeric).Value = m_ngoaitrung;
                    cmd.Parameters.Add("m_chetsong", NpgsqlDbType.Numeric).Value = m_chetsong;
                    cmd.Parameters.Add("m_cannang", NpgsqlDbType.Numeric).Value = m_cannang;
                    cmd.Parameters.Add("m_ppde", NpgsqlDbType.Numeric).Value = m_ppde;
                    cmd.Parameters.Add("m_taibien", NpgsqlDbType.Numeric).Value = m_taibien;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_tiensk");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_sankhoa(string m_ngayvv, decimal m_id, string m_tungay, string m_denngay, decimal m_tuoithai,
            string m_khamthai, int m_uonvan, decimal m_tiem, string m_chuyenda, string m_dauhieu, string m_bienchuyen,
            string m_kinhnam, string m_tinhchat, int m_chuky, string m_luongkinh, string m_chongnam, string m_dieutri,
            int m_phu, int m_ptcu, string m_dangtc, string m_tuthe, decimal m_caotc, decimal m_vongbung, string m_cotc,
            decimal m_timthai, string m_vu, decimal m_bishop, string m_amho, string m_amdao, string m_sinhmon,
            string m_tucung, string m_phanphu, int m_tinhtrangoi, string m_voluc, int m_oivo, string m_mausac,
            string m_nuocoi, string m_ngoi, string m_the, string m_kieu, int m_dolot, string m_have, string m_deluc,
            string m_theodoi, string m_chucdanh, int m_rau, string m_rauluc, string m_cachso, string m_mang, string m_mui, string m_banhrau,
            decimal m_raucannang, int m_raucuon, decimal m_raudai, int m_chaymau, decimal m_maumat, int m_kiemsoattc,
            string m_xuly, string m_ngaysaude, string m_da, int m_ppde, decimal m_mach, decimal m_nhietdo, string m_huyetap, decimal m_nhiptho,
            string m_canthiep, int m_tangsinhmon, string m_loaichi, decimal m_somui, int m_cotucung, decimal m_cao)
        {
            string xxx = user + mmyy(m_ngayvv);
            sql = "update " + xxx + ".ba_sankhoa set tungay=to_date(:m_tungay,'dd/mm/yyyy'),denngay=to_date(:m_denngay,'dd/mm/yyyy'),";
            sql += "tuoithai=:m_tuoithai,khamthai=:m_khamthai,uonvan=:m_uonvan,tiem=:m_tiem,chuyenda=to_date(:m_chuyenda,'dd/mm/yyyy hh24:mi'),";
            sql += "dauhieu=:m_dauhieu,bienchuyen=:m_bienchuyen,kinhnam=:m_kinhnam,tinhchat=:m_tinhchat,chuky=:m_chuky,";
            sql += "luongkinh=:m_luongkinh,chongnam=:m_chongnam,dieutri=:m_dieutri,phu=:m_phu,ptcu=:m_ptcu,dangtc=:m_dangtc,";
            sql += "tuthe=:m_tuthe,caotc=:m_caotc,vongbung=:m_vongbung,cotc=:m_cotc,timthai=:m_timthai,vu=:m_vu,bishop=:m_bishop,";
            sql += "amho=:m_amho,amdao=:m_amdao,sinhmon=:m_sinhmon,tucung=:m_tucung,phanphu=:m_phanphu,tinhtrangoi=:m_tinhtrangoi,";
            sql += "voluc=to_date(:m_voluc,'dd/mm/yyyy hh24:mi'),oivo=:m_oivo,mausac=:m_mausac,nuocoi=:m_nuocoi,ngoi=:m_ngoi,";
            sql += "the=:m_the,kieu=:m_kieu,dolot=:m_dolot,have=:m_have,deluc=to_date(:m_deluc,'dd/mm/yyyy hh24:mi'),";
            sql += "theodoi=:m_theodoi,chucdanh=:m_chucdanh,rau=:m_rau,rauluc=to_date(:m_rauluc,'dd/mm/yyyy hh24:mi'),";
            sql += "cachso=:m_cachso,mang=:m_mang,mui=:m_mui,banhrau=:m_banhrau,raucannang=:m_raucannang,raucuon=:m_raucuon,";
            sql += "raudai=:m_raudai,chaymau=:m_chaymau,maumat=:m_maumat,kiemsoattc=:m_kiemsoattc,xuly=:m_xuly,";
            sql += "ngaysaude=to_date(:m_ngaysaude,'dd/mm/yyyy hh24:mi'),da=:m_da,ppde=:m_ppde,mach=:m_mach,nhietdo=:m_nhietdo,huyetap=:m_huyetap,nhiptho=:m_nhiptho,";
            sql += "canthiep=:m_canthiep,tangsinhmon=:m_tangsinhmon,loaichi=:m_loaichi,somui=:m_somui,cotucung=:m_cotucung,cao=:m_cao ";
            sql += " where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_tungay", NpgsqlDbType.Varchar, 16).Value = m_tungay.Trim();
                cmd.Parameters.Add("m_denngay", NpgsqlDbType.Varchar, 16).Value = m_denngay.Trim();
                cmd.Parameters.Add("m_tuoithai", NpgsqlDbType.Numeric).Value = m_tuoithai;
                cmd.Parameters.Add("m_khamthai", NpgsqlDbType.Text).Value = m_khamthai;
                cmd.Parameters.Add("m_uonvan", NpgsqlDbType.Numeric).Value = m_uonvan;
                cmd.Parameters.Add("m_tiem", NpgsqlDbType.Numeric).Value = m_tiem;
                cmd.Parameters.Add("m_chuyenda", NpgsqlDbType.Varchar, 16).Value = m_chuyenda.Trim();
                cmd.Parameters.Add("m_dauhieu", NpgsqlDbType.Text).Value = m_dauhieu;
                cmd.Parameters.Add("m_bienchuyen", NpgsqlDbType.Text).Value = m_bienchuyen;
                cmd.Parameters.Add("m_kinhnam", NpgsqlDbType.Varchar, 4).Value = m_kinhnam;
                cmd.Parameters.Add("m_tinhchat", NpgsqlDbType.Text).Value = m_tinhchat;
                cmd.Parameters.Add("m_chuky", NpgsqlDbType.Numeric).Value = m_chuky;
                cmd.Parameters.Add("m_luongkinh", NpgsqlDbType.Text).Value = m_luongkinh;
                cmd.Parameters.Add("m_chongnam", NpgsqlDbType.Varchar, 4).Value = m_chongnam;
                cmd.Parameters.Add("m_dieutri", NpgsqlDbType.Text).Value = m_dieutri;
                cmd.Parameters.Add("m_phu", NpgsqlDbType.Numeric).Value = m_phu;
                cmd.Parameters.Add("m_ptcu", NpgsqlDbType.Numeric).Value = m_ptcu;
                cmd.Parameters.Add("m_dangtc", NpgsqlDbType.Text).Value = m_dangtc;
                cmd.Parameters.Add("m_tuthe", NpgsqlDbType.Text).Value = m_tuthe;
                cmd.Parameters.Add("m_caotc", NpgsqlDbType.Numeric).Value = m_caotc;
                cmd.Parameters.Add("m_vongbung", NpgsqlDbType.Numeric).Value = m_vongbung;
                cmd.Parameters.Add("m_cotc", NpgsqlDbType.Text).Value = m_cotc;
                cmd.Parameters.Add("m_timthai", NpgsqlDbType.Numeric).Value = m_timthai;
                cmd.Parameters.Add("m_vu", NpgsqlDbType.Text).Value = m_vu;
                cmd.Parameters.Add("m_bishop", NpgsqlDbType.Numeric).Value = m_bishop;
                cmd.Parameters.Add("m_amho", NpgsqlDbType.Text).Value = m_amho;
                cmd.Parameters.Add("m_amdao", NpgsqlDbType.Text).Value = m_amdao;
                cmd.Parameters.Add("m_sinhmon", NpgsqlDbType.Text).Value = m_sinhmon;
                cmd.Parameters.Add("m_tucung", NpgsqlDbType.Text).Value = m_tucung;
                cmd.Parameters.Add("m_phanphu", NpgsqlDbType.Text).Value = m_phanphu;
                cmd.Parameters.Add("m_tinhtrangoi", NpgsqlDbType.Numeric).Value = m_tinhtrangoi;
                cmd.Parameters.Add("m_voluc", NpgsqlDbType.Varchar, 16).Value = m_voluc.Trim();
                cmd.Parameters.Add("m_oivo", NpgsqlDbType.Numeric).Value = m_oivo;
                cmd.Parameters.Add("m_mausac", NpgsqlDbType.Text).Value = m_mausac;
                cmd.Parameters.Add("m_nuocoi", NpgsqlDbType.Text).Value = m_nuocoi;
                cmd.Parameters.Add("m_ngoi", NpgsqlDbType.Text).Value = m_ngoi;
                cmd.Parameters.Add("m_the", NpgsqlDbType.Text).Value = m_the;
                cmd.Parameters.Add("m_kieu", NpgsqlDbType.Text).Value = m_kieu;
                cmd.Parameters.Add("m_dolot", NpgsqlDbType.Numeric).Value = m_dolot;
                cmd.Parameters.Add("m_have", NpgsqlDbType.Text).Value = m_have;
                cmd.Parameters.Add("m_deluc", NpgsqlDbType.Varchar, 16).Value = m_deluc.Trim();
                cmd.Parameters.Add("m_theodoi", NpgsqlDbType.Varchar, 4).Value = m_theodoi;
                cmd.Parameters.Add("m_chucdanh", NpgsqlDbType.Text).Value = m_chucdanh;
                cmd.Parameters.Add("m_rau", NpgsqlDbType.Numeric).Value = m_rau;
                cmd.Parameters.Add("m_rauluc", NpgsqlDbType.Varchar, 16).Value = m_rauluc.Trim();
                cmd.Parameters.Add("m_cachso", NpgsqlDbType.Text).Value = m_cachso;
                cmd.Parameters.Add("m_mang", NpgsqlDbType.Text).Value = m_mang;
                cmd.Parameters.Add("m_mui", NpgsqlDbType.Text).Value = m_mui;
                cmd.Parameters.Add("m_banhrau", NpgsqlDbType.Text).Value = m_banhrau;
                cmd.Parameters.Add("m_raucannang", NpgsqlDbType.Numeric).Value = m_raucannang;
                cmd.Parameters.Add("m_raucuon", NpgsqlDbType.Numeric).Value = m_raucuon;
                cmd.Parameters.Add("m_raudai", NpgsqlDbType.Numeric).Value = m_raudai;
                cmd.Parameters.Add("m_chaymau", NpgsqlDbType.Numeric).Value = m_chaymau;
                cmd.Parameters.Add("m_maumat", NpgsqlDbType.Numeric).Value = m_maumat;
                cmd.Parameters.Add("m_kiemsoattc", NpgsqlDbType.Numeric).Value = m_kiemsoattc;
                cmd.Parameters.Add("m_xuly", NpgsqlDbType.Text).Value = m_xuly;
                cmd.Parameters.Add("m_ngaysaude", NpgsqlDbType.Varchar, 16).Value = m_ngaysaude.Trim();
                cmd.Parameters.Add("m_da", NpgsqlDbType.Text).Value = m_da;
                cmd.Parameters.Add("m_ppde", NpgsqlDbType.Numeric).Value = m_ppde;
                cmd.Parameters.Add("m_mach", NpgsqlDbType.Numeric).Value = m_mach;
                cmd.Parameters.Add("m_nhietdo", NpgsqlDbType.Numeric).Value = m_nhietdo;
                cmd.Parameters.Add("m_huyetap", NpgsqlDbType.Varchar, 7).Value = m_huyetap;
                cmd.Parameters.Add("m_nhiptho", NpgsqlDbType.Numeric).Value = m_nhiptho;
                cmd.Parameters.Add("m_canthiep", NpgsqlDbType.Text).Value = m_canthiep;
                cmd.Parameters.Add("m_tangsinhmon", NpgsqlDbType.Numeric).Value = m_tangsinhmon;
                cmd.Parameters.Add("m_loaichi", NpgsqlDbType.Text).Value = m_loaichi;
                cmd.Parameters.Add("m_somui", NpgsqlDbType.Numeric).Value = m_somui;
                cmd.Parameters.Add("m_cotucung", NpgsqlDbType.Numeric).Value = m_cotucung;
                cmd.Parameters.Add("m_cao", NpgsqlDbType.Numeric).Value = m_cao;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_sankhoa (id,tungay,denngay,tuoithai,khamthai,uonvan,tiem,chuyenda,dauhieu,bienchuyen,kinhnam,tinhchat,chuky,luongkinh,chongnam,dieutri,phu,ptcu,dangtc,tuthe,caotc,vongbung,cotc,timthai,vu,bishop,amho,amdao,sinhmon,tucung,phanphu,tinhtrangoi,voluc,oivo,mausac,nuocoi,ngoi,the,kieu,dolot,have,deluc,theodoi,chucdanh,rau,rauluc,cachso,mang,mui,banhrau,raucannang,raucuon,raudai,chaymau,maumat,kiemsoattc,xuly,ngaysaude,da,ppde,mach,nhietdo,huyetap,nhiptho,canthiep,tangsinhmon,loaichi,somui,cotucung,cao) values ";
                    sql += "(:m_id,to_date(:m_tungay,'dd/mm/yyyy hh24:mi'),to_date(:m_denngay,'dd/mm/yyyy hh24:mi'),:m_tuoithai,:m_khamthai,:m_uonvan,:m_tiem,to_date(:m_chuyenda,'dd/mm/yyyy hh24:mi'),:m_dauhieu,:m_bienchuyen,:m_kinhnam,:m_tinhchat,:m_chuky,:m_luongkinh,:m_chongnam,:m_dieutri,:m_phu,:m_ptcu,:m_dangtc,:m_tuthe,:m_caotc,:m_vongbung,:m_cotc,:m_timthai,:m_vu,:m_bishop,:m_amho,:m_amdao,:m_sinhmon,:m_tucung,:m_phanphu,:m_tinhtrangoi,to_date(:m_voluc,'dd/mm/yyyy hh24:mi'),:m_oivo,:m_mausac,:m_nuocoi,:m_ngoi,:m_the,:m_kieu,:m_dolot,:m_have,to_date(:m_deluc,'dd/mm/yyyy hh24:mi'),:m_theodoi,:m_chucdanh,:m_rau,to_date(:m_rauluc,'dd/mm/yyyy hh24:mi'),:m_cachso,:m_mang,:m_mui,:m_banhrau,:m_raucannang,:m_raucuon,:m_raudai,:m_chaymau,:m_maumat,:m_kiemsoattc,:m_xuly,to_date(:m_ngaysaude,'dd/mm/yyyy hh24:mi'),:m_da,:m_ppde,:m_mach,:m_nhietdo,:m_huyetap,:m_nhiptho,:m_canthiep,:m_tangsinhmon,:m_loaichi,:m_somui,:m_cotucung,:m_cao)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_tungay", NpgsqlDbType.Varchar, 16).Value = m_tungay.Trim();
                    cmd.Parameters.Add("m_denngay", NpgsqlDbType.Varchar, 16).Value = m_denngay.Trim();
                    cmd.Parameters.Add("m_tuoithai", NpgsqlDbType.Numeric).Value = m_tuoithai;
                    cmd.Parameters.Add("m_khamthai", NpgsqlDbType.Text).Value = m_khamthai;
                    cmd.Parameters.Add("m_uonvan", NpgsqlDbType.Numeric).Value = m_uonvan;
                    cmd.Parameters.Add("m_tiem", NpgsqlDbType.Numeric).Value = m_tiem;
                    cmd.Parameters.Add("m_chuyenda", NpgsqlDbType.Varchar, 16).Value = m_chuyenda.Trim();
                    cmd.Parameters.Add("m_dauhieu", NpgsqlDbType.Text).Value = m_dauhieu;
                    cmd.Parameters.Add("m_bienchuyen", NpgsqlDbType.Text).Value = m_bienchuyen;
                    cmd.Parameters.Add("m_kinhnam", NpgsqlDbType.Varchar, 4).Value = m_kinhnam;
                    cmd.Parameters.Add("m_tinhchat", NpgsqlDbType.Text).Value = m_tinhchat;
                    cmd.Parameters.Add("m_chuky", NpgsqlDbType.Numeric).Value = m_chuky;
                    cmd.Parameters.Add("m_luongkinh", NpgsqlDbType.Text).Value = m_luongkinh;
                    cmd.Parameters.Add("m_chongnam", NpgsqlDbType.Varchar, 4).Value = m_chongnam;
                    cmd.Parameters.Add("m_dieutri", NpgsqlDbType.Text).Value = m_dieutri;
                    cmd.Parameters.Add("m_phu", NpgsqlDbType.Numeric).Value = m_phu;
                    cmd.Parameters.Add("m_ptcu", NpgsqlDbType.Numeric).Value = m_ptcu;
                    cmd.Parameters.Add("m_dangtc", NpgsqlDbType.Text).Value = m_dangtc;
                    cmd.Parameters.Add("m_tuthe", NpgsqlDbType.Text).Value = m_tuthe;
                    cmd.Parameters.Add("m_caotc", NpgsqlDbType.Numeric).Value = m_caotc;
                    cmd.Parameters.Add("m_vongbung", NpgsqlDbType.Numeric).Value = m_vongbung;
                    cmd.Parameters.Add("m_cotc", NpgsqlDbType.Text).Value = m_cotc;
                    cmd.Parameters.Add("m_timthai", NpgsqlDbType.Numeric).Value = m_timthai;
                    cmd.Parameters.Add("m_vu", NpgsqlDbType.Text).Value = m_vu;
                    cmd.Parameters.Add("m_bishop", NpgsqlDbType.Numeric).Value = m_bishop;
                    cmd.Parameters.Add("m_amho", NpgsqlDbType.Text).Value = m_amho;
                    cmd.Parameters.Add("m_amdao", NpgsqlDbType.Text).Value = m_amdao;
                    cmd.Parameters.Add("m_sinhmon", NpgsqlDbType.Text).Value = m_sinhmon;
                    cmd.Parameters.Add("m_tucung", NpgsqlDbType.Text).Value = m_tucung;
                    cmd.Parameters.Add("m_phanphu", NpgsqlDbType.Text).Value = m_phanphu;
                    cmd.Parameters.Add("m_tinhtrangoi", NpgsqlDbType.Numeric).Value = m_tinhtrangoi;
                    cmd.Parameters.Add("m_voluc", NpgsqlDbType.Varchar, 16).Value = m_voluc.Trim();
                    cmd.Parameters.Add("m_oivo", NpgsqlDbType.Numeric).Value = m_oivo;
                    cmd.Parameters.Add("m_mausac", NpgsqlDbType.Text).Value = m_mausac;
                    cmd.Parameters.Add("m_nuocoi", NpgsqlDbType.Text).Value = m_nuocoi;
                    cmd.Parameters.Add("m_ngoi", NpgsqlDbType.Text).Value = m_ngoi;
                    cmd.Parameters.Add("m_the", NpgsqlDbType.Text).Value = m_the;
                    cmd.Parameters.Add("m_kieu", NpgsqlDbType.Text).Value = m_kieu;
                    cmd.Parameters.Add("m_dolot", NpgsqlDbType.Numeric).Value = m_dolot;
                    cmd.Parameters.Add("m_have", NpgsqlDbType.Text).Value = m_have;
                    cmd.Parameters.Add("m_deluc", NpgsqlDbType.Varchar, 16).Value = m_deluc.Trim();
                    cmd.Parameters.Add("m_theodoi", NpgsqlDbType.Varchar, 4).Value = m_theodoi;
                    cmd.Parameters.Add("m_chucdanh", NpgsqlDbType.Text).Value = m_chucdanh;
                    cmd.Parameters.Add("m_rau", NpgsqlDbType.Numeric).Value = m_rau;
                    cmd.Parameters.Add("m_rauluc", NpgsqlDbType.Varchar, 16).Value = m_rauluc.Trim();
                    cmd.Parameters.Add("m_cachso", NpgsqlDbType.Text).Value = m_cachso;
                    cmd.Parameters.Add("m_mang", NpgsqlDbType.Text).Value = m_mang;
                    cmd.Parameters.Add("m_mui", NpgsqlDbType.Text).Value = m_mui;
                    cmd.Parameters.Add("m_banhrau", NpgsqlDbType.Text).Value = m_banhrau;
                    cmd.Parameters.Add("m_raucannang", NpgsqlDbType.Numeric).Value = m_raucannang;
                    cmd.Parameters.Add("m_raucuon", NpgsqlDbType.Numeric).Value = m_raucuon;
                    cmd.Parameters.Add("m_raudai", NpgsqlDbType.Numeric).Value = m_raudai;
                    cmd.Parameters.Add("m_chaymau", NpgsqlDbType.Numeric).Value = m_chaymau;
                    cmd.Parameters.Add("m_maumat", NpgsqlDbType.Numeric).Value = m_maumat;
                    cmd.Parameters.Add("m_kiemsoattc", NpgsqlDbType.Numeric).Value = m_kiemsoattc;
                    cmd.Parameters.Add("m_xuly", NpgsqlDbType.Text).Value = m_xuly;
                    cmd.Parameters.Add("m_ngaysaude", NpgsqlDbType.Varchar, 16).Value = m_ngaysaude.Trim();
                    cmd.Parameters.Add("m_da", NpgsqlDbType.Text).Value = m_da;
                    cmd.Parameters.Add("m_ppde", NpgsqlDbType.Numeric).Value = m_ppde;
                    cmd.Parameters.Add("m_mach", NpgsqlDbType.Numeric).Value = m_mach;
                    cmd.Parameters.Add("m_nhietdo", NpgsqlDbType.Numeric).Value = m_nhietdo;
                    cmd.Parameters.Add("m_huyetap", NpgsqlDbType.Varchar, 7).Value = m_huyetap;
                    cmd.Parameters.Add("m_nhiptho", NpgsqlDbType.Numeric).Value = m_nhiptho;
                    cmd.Parameters.Add("m_canthiep", NpgsqlDbType.Text).Value = m_canthiep;
                    cmd.Parameters.Add("m_tangsinhmon", NpgsqlDbType.Numeric).Value = m_tangsinhmon;
                    cmd.Parameters.Add("m_loaichi", NpgsqlDbType.Text).Value = m_loaichi;
                    cmd.Parameters.Add("m_somui", NpgsqlDbType.Numeric).Value = m_somui;
                    cmd.Parameters.Add("m_cotucung", NpgsqlDbType.Numeric).Value = m_cotucung;
                    cmd.Parameters.Add("m_cao", NpgsqlDbType.Numeric).Value = m_cao;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_sankhoa");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }


        public bool upd_ba_sankhoa(string m_ngayvv, decimal m_id, decimal m_bishop, string m_amho, string m_amdao, string m_sinhmon,
            string m_tucung, string m_phanphu, int m_tinhtrangoi, string m_voluc, int m_oivo, string m_mausac,
            string m_nuocoi, string m_ngoi, string m_the, string m_kieu, int m_dolot, string m_have, string m_deluc,
            string m_theodoi, string m_chucdanh, int m_rau, string m_rauluc, string m_cachso, string m_mang, string m_mui, string m_banhrau,
            decimal m_raucannang, int m_raucuon, decimal m_raudai, int m_chaymau, decimal m_maumat, int m_kiemsoattc,
            string m_xuly, string m_ngaysaude, string m_da, int m_ppde, decimal m_mach, decimal m_nhietdo, string m_huyetap, decimal m_nhiptho,
            string m_canthiep, int m_tangsinhmon, string m_loaichi, decimal m_somui, int m_cotucung)
        {
            string xxx = user + mmyy(m_ngayvv);
            sql = "update " + xxx + ".ba_sankhoa set bishop=:m_bishop,";
            sql += "amho=:m_amho,amdao=:m_amdao,sinhmon=:m_sinhmon,tucung=:m_tucung,phanphu=:m_phanphu,tinhtrangoi=:m_tinhtrangoi,";
            sql += "voluc=to_date(:m_voluc,'dd/mm/yyyy hh24:mi'),oivo=:m_oivo,mausac=:m_mausac,nuocoi=:m_nuocoi,ngoi=:m_ngoi,";
            sql += "the=:m_the,kieu=:m_kieu,dolot=:m_dolot,have=:m_have,deluc=to_date(:m_deluc,'dd/mm/yyyy hh24:mi'),";
            sql += "theodoi=:m_theodoi,chucdanh=:m_chucdanh,rau=:m_rau,rauluc=to_date(:m_rauluc,'dd/mm/yyyy hh24:mi'),";
            sql += "cachso=:m_cachso,mang=:m_mang,mui=:m_mui,banhrau=:m_banhrau,raucannang=:m_raucannang,raucuon=:m_raucuon,";
            sql += "raudai=:m_raudai,chaymau=:m_chaymau,maumat=:m_maumat,kiemsoattc=:m_kiemsoattc,xuly=:m_xuly,";
            sql += "ngaysaude=to_date(:m_ngaysaude,'dd/mm/yyyy hh24:mi'),da=:m_da,ppde=:m_ppde,mach=:m_mach,nhietdo=:m_nhietdo,huyetap=:m_huyetap,nhiptho=:m_nhiptho,";
            sql += "canthiep=:m_canthiep,tangsinhmon=:m_tangsinhmon,loaichi=:m_loaichi,somui=:m_somui,cotucung=:m_cotucung ";
            sql += " where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_bishop", NpgsqlDbType.Numeric).Value = m_bishop;
                cmd.Parameters.Add("m_amho", NpgsqlDbType.Text).Value = m_amho;
                cmd.Parameters.Add("m_amdao", NpgsqlDbType.Text).Value = m_amdao;
                cmd.Parameters.Add("m_sinhmon", NpgsqlDbType.Text).Value = m_sinhmon;
                cmd.Parameters.Add("m_tucung", NpgsqlDbType.Text).Value = m_tucung;
                cmd.Parameters.Add("m_phanphu", NpgsqlDbType.Text).Value = m_phanphu;
                cmd.Parameters.Add("m_tinhtrangoi", NpgsqlDbType.Numeric).Value = m_tinhtrangoi;
                cmd.Parameters.Add("m_voluc", NpgsqlDbType.Varchar, 16).Value = m_voluc.Trim();
                cmd.Parameters.Add("m_oivo", NpgsqlDbType.Numeric).Value = m_oivo;
                cmd.Parameters.Add("m_mausac", NpgsqlDbType.Text).Value = m_mausac;
                cmd.Parameters.Add("m_nuocoi", NpgsqlDbType.Text).Value = m_nuocoi;
                cmd.Parameters.Add("m_ngoi", NpgsqlDbType.Text).Value = m_ngoi;
                cmd.Parameters.Add("m_the", NpgsqlDbType.Text).Value = m_the;
                cmd.Parameters.Add("m_kieu", NpgsqlDbType.Text).Value = m_kieu;
                cmd.Parameters.Add("m_dolot", NpgsqlDbType.Numeric).Value = m_dolot;
                cmd.Parameters.Add("m_have", NpgsqlDbType.Text).Value = m_have;
                cmd.Parameters.Add("m_deluc", NpgsqlDbType.Varchar, 16).Value = m_deluc.Trim();
                cmd.Parameters.Add("m_theodoi", NpgsqlDbType.Varchar, 4).Value = m_theodoi;
                cmd.Parameters.Add("m_chucdanh", NpgsqlDbType.Text).Value = m_chucdanh;
                cmd.Parameters.Add("m_rau", NpgsqlDbType.Numeric).Value = m_rau;
                cmd.Parameters.Add("m_rauluc", NpgsqlDbType.Varchar, 16).Value = m_rauluc.Trim();
                cmd.Parameters.Add("m_cachso", NpgsqlDbType.Text).Value = m_cachso;
                cmd.Parameters.Add("m_mang", NpgsqlDbType.Text).Value = m_mang;
                cmd.Parameters.Add("m_mui", NpgsqlDbType.Text).Value = m_mui;
                cmd.Parameters.Add("m_banhrau", NpgsqlDbType.Text).Value = m_banhrau;
                cmd.Parameters.Add("m_raucannang", NpgsqlDbType.Numeric).Value = m_raucannang;
                cmd.Parameters.Add("m_raucuon", NpgsqlDbType.Numeric).Value = m_raucuon;
                cmd.Parameters.Add("m_raudai", NpgsqlDbType.Numeric).Value = m_raudai;
                cmd.Parameters.Add("m_chaymau", NpgsqlDbType.Numeric).Value = m_chaymau;
                cmd.Parameters.Add("m_maumat", NpgsqlDbType.Numeric).Value = m_maumat;
                cmd.Parameters.Add("m_kiemsoattc", NpgsqlDbType.Numeric).Value = m_kiemsoattc;
                cmd.Parameters.Add("m_xuly", NpgsqlDbType.Text).Value = m_xuly;
                cmd.Parameters.Add("m_ngaysaude", NpgsqlDbType.Varchar, 16).Value = m_ngaysaude.Trim();
                cmd.Parameters.Add("m_da", NpgsqlDbType.Text).Value = m_da;
                cmd.Parameters.Add("m_ppde", NpgsqlDbType.Numeric).Value = m_ppde;
                cmd.Parameters.Add("m_mach", NpgsqlDbType.Numeric).Value = m_mach;
                cmd.Parameters.Add("m_nhietdo", NpgsqlDbType.Numeric).Value = m_nhietdo;
                cmd.Parameters.Add("m_huyetap", NpgsqlDbType.Varchar, 7).Value = m_huyetap;
                cmd.Parameters.Add("m_nhiptho", NpgsqlDbType.Numeric).Value = m_nhiptho;
                cmd.Parameters.Add("m_canthiep", NpgsqlDbType.Text).Value = m_canthiep;
                cmd.Parameters.Add("m_tangsinhmon", NpgsqlDbType.Numeric).Value = m_tangsinhmon;
                cmd.Parameters.Add("m_loaichi", NpgsqlDbType.Text).Value = m_loaichi;
                cmd.Parameters.Add("m_somui", NpgsqlDbType.Numeric).Value = m_somui;
                cmd.Parameters.Add("m_cotucung", NpgsqlDbType.Numeric).Value = m_cotucung;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_sankhoa");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }


        public bool upd_ba_dbchuyenda(decimal m_id, decimal m_idthuchien, string m_ngay,
            decimal m_mach, string m_huyetap, decimal m_nhietdo, decimal m_nhiptho, decimal m_timthai, string m_tucung,
            decimal m_mo, decimal m_xoa, int m_tinhtrangoi, string m_ngoithai, string m_dolot, string m_tienluong,
            string m_xutri, string m_theodoi, int m_userid)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_dbchuyenda set idthuchien=:m_idthuchien,ngay=to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),";
            sql += "mach=:m_mach,huyetap=:m_huyetap,nhietdo=:m_nhietdo,nhiptho=:m_nhiptho,timthai=:m_timthai,";
            sql += "tucung=:m_tucung,mo=:m_mo,xoa=:m_xoa,tinhtrangoi=:m_tinhtrangoi,ngoithai=:m_ngoithai,";
            sql += "dolot=:m_dolot,tienluong=:m_tienluong,xutri=:m_xutri,theodoi=:m_theodoi,userid=:m_userid ";
            sql += " where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                cmd.Parameters.Add("m_mach", NpgsqlDbType.Numeric).Value = m_mach;
                cmd.Parameters.Add("m_huyetap", NpgsqlDbType.Varchar, 7).Value = m_huyetap;
                cmd.Parameters.Add("m_nhietdo", NpgsqlDbType.Numeric).Value = m_nhietdo;
                cmd.Parameters.Add("m_nhiptho", NpgsqlDbType.Numeric).Value = m_nhiptho;
                cmd.Parameters.Add("m_timthai", NpgsqlDbType.Numeric).Value = m_timthai;
                cmd.Parameters.Add("m_tucung", NpgsqlDbType.Text).Value = m_tucung;
                cmd.Parameters.Add("m_mo", NpgsqlDbType.Numeric).Value = m_mo;
                cmd.Parameters.Add("m_xoa", NpgsqlDbType.Numeric).Value = m_xoa;
                cmd.Parameters.Add("m_tinhtrangoi", NpgsqlDbType.Numeric).Value = m_tinhtrangoi;
                cmd.Parameters.Add("m_ngoithai", NpgsqlDbType.Varchar, 10).Value = m_ngoithai;
                cmd.Parameters.Add("m_dolot", NpgsqlDbType.Text).Value = m_dolot;
                cmd.Parameters.Add("m_tienluong", NpgsqlDbType.Text).Value = m_tienluong;
                cmd.Parameters.Add("m_xutri", NpgsqlDbType.Text).Value = m_xutri;
                cmd.Parameters.Add("m_theodoi", NpgsqlDbType.Varchar, 4).Value = m_theodoi;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_dbchuyenda (id,idthuchien,ngay,mach,huyetap,nhietdo,nhiptho,timthai,tucung,mo,xoa,tinhtrangoi,ngoithai,dolot,tienluong,xutri,theodoi,userid) values (:m_id,:m_idthuchien,to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),:m_mach,:m_huyetap,:m_nhietdo,:m_nhiptho,:m_timthai,:m_tucung,:m_mo,:m_xoa,:m_tinhtrangoi,:m_ngoithai,:m_dolot,:m_tienluong,:m_xutri,:m_theodoi,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                    cmd.Parameters.Add("m_mach", NpgsqlDbType.Numeric).Value = m_mach;
                    cmd.Parameters.Add("m_huyetap", NpgsqlDbType.Varchar, 7).Value = m_huyetap;
                    cmd.Parameters.Add("m_nhietdo", NpgsqlDbType.Numeric).Value = m_nhietdo;
                    cmd.Parameters.Add("m_nhiptho", NpgsqlDbType.Numeric).Value = m_nhiptho;
                    cmd.Parameters.Add("m_timthai", NpgsqlDbType.Numeric).Value = m_timthai;
                    cmd.Parameters.Add("m_tucung", NpgsqlDbType.Text).Value = m_tucung;
                    cmd.Parameters.Add("m_mo", NpgsqlDbType.Numeric).Value = m_mo;
                    cmd.Parameters.Add("m_xoa", NpgsqlDbType.Numeric).Value = m_xoa;
                    cmd.Parameters.Add("m_tinhtrangoi", NpgsqlDbType.Numeric).Value = m_tinhtrangoi;
                    cmd.Parameters.Add("m_ngoithai", NpgsqlDbType.Varchar, 10).Value = m_ngoithai;
                    cmd.Parameters.Add("m_dolot", NpgsqlDbType.Text).Value = m_dolot;
                    cmd.Parameters.Add("m_tienluong", NpgsqlDbType.Text).Value = m_tienluong;
                    cmd.Parameters.Add("m_xutri", NpgsqlDbType.Text).Value = m_xutri;
                    cmd.Parameters.Add("m_theodoi", NpgsqlDbType.Varchar, 4).Value = m_theodoi;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_dbchuyenda");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_hausangan(decimal m_id, decimal m_idthuchien, string m_ngay, string m_toantrang, decimal m_mach,
            string m_huyetap, decimal m_nhietdo, decimal m_nhiptho, string m_tim, string m_phoi, string m_tucung,
            decimal m_maumat, string m_tresosinh, string m_nuoctieu, string m_tienluong, string m_xutri, string m_theodoi,
            int m_tangsinhmon, int m_tinhchat, string m_khac, int m_userid)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_hausangan set idthuchien=:m_idthuchien,ngay=to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),toantrang=:m_toantrang,";
            sql += "mach=:m_mach,huyetap=:m_huyetap,nhietdo=:m_nhietdo,nhiptho=:m_nhiptho,tim=:m_tim,phoi=:m_phoi,";
            sql += "tucung=:m_tucung,maumat=:m_maumat,tresosinh=:m_tresosinh,nuoctieu=:m_nuoctieu,tienluong=:m_tienluong,";
            sql += "xutri=:m_xutri,theodoi=:m_theodoi,tangsinhmon=:m_tangsinhmon,tinhchat=:m_tinhchat,khac=:m_khac,userid=:m_userid ";
            sql += " where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                cmd.Parameters.Add("m_toantrang", NpgsqlDbType.Text).Value = m_toantrang;
                cmd.Parameters.Add("m_mach", NpgsqlDbType.Numeric).Value = m_mach;
                cmd.Parameters.Add("m_huyetap", NpgsqlDbType.Varchar, 7).Value = m_huyetap;
                cmd.Parameters.Add("m_nhietdo", NpgsqlDbType.Numeric).Value = m_nhietdo;
                cmd.Parameters.Add("m_nhiptho", NpgsqlDbType.Numeric).Value = m_nhiptho;
                cmd.Parameters.Add("m_tim", NpgsqlDbType.Text).Value = m_tim;
                cmd.Parameters.Add("m_phoi", NpgsqlDbType.Text).Value = m_phoi;
                cmd.Parameters.Add("m_tucung", NpgsqlDbType.Text).Value = m_tucung;
                cmd.Parameters.Add("m_maumat", NpgsqlDbType.Numeric).Value = m_maumat;
                cmd.Parameters.Add("m_tresosinh", NpgsqlDbType.Text).Value = m_tresosinh;
                cmd.Parameters.Add("m_nuoctieu", NpgsqlDbType.Text).Value = m_nuoctieu;
                cmd.Parameters.Add("m_tienluong", NpgsqlDbType.Text).Value = m_tienluong;
                cmd.Parameters.Add("m_xutri", NpgsqlDbType.Text).Value = m_xutri;
                cmd.Parameters.Add("m_theodoi", NpgsqlDbType.Varchar, 4).Value = m_theodoi;
                cmd.Parameters.Add("m_tangsinhmon", NpgsqlDbType.Numeric).Value = m_tangsinhmon;
                cmd.Parameters.Add("m_tinhchat", NpgsqlDbType.Numeric).Value = m_tinhchat;
                cmd.Parameters.Add("m_khac", NpgsqlDbType.Text).Value = m_khac;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_hausangan (id,idthuchien,ngay,toantrang,mach,huyetap,nhietdo,nhiptho,tim,phoi,tucung,maumat,tresosinh,nuoctieu,tienluong,xutri,theodoi,tangsinhmon,tinhchat,khac,userid) values (:m_id,:m_idthuchien,to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),:m_toantrang,:m_mach,:m_huyetap,:m_nhietdo,:m_nhiptho,:m_tim,:m_phoi,:m_tucung,:m_maumat,:m_tresosinh,:m_nuoctieu,:m_tienluong,:m_xutri,:m_theodoi,:m_tangsinhmon,:m_tinhchat,:m_khac,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                    cmd.Parameters.Add("m_toantrang", NpgsqlDbType.Text).Value = m_toantrang;
                    cmd.Parameters.Add("m_mach", NpgsqlDbType.Numeric).Value = m_mach;
                    cmd.Parameters.Add("m_huyetap", NpgsqlDbType.Varchar, 7).Value = m_huyetap;
                    cmd.Parameters.Add("m_nhietdo", NpgsqlDbType.Numeric).Value = m_nhietdo;
                    cmd.Parameters.Add("m_nhiptho", NpgsqlDbType.Numeric).Value = m_nhiptho;
                    cmd.Parameters.Add("m_tim", NpgsqlDbType.Text).Value = m_tim;
                    cmd.Parameters.Add("m_phoi", NpgsqlDbType.Text).Value = m_phoi;
                    cmd.Parameters.Add("m_tucung", NpgsqlDbType.Text).Value = m_tucung;
                    cmd.Parameters.Add("m_maumat", NpgsqlDbType.Numeric).Value = m_maumat;
                    cmd.Parameters.Add("m_tresosinh", NpgsqlDbType.Text).Value = m_tresosinh;
                    cmd.Parameters.Add("m_nuoctieu", NpgsqlDbType.Text).Value = m_nuoctieu;
                    cmd.Parameters.Add("m_tienluong", NpgsqlDbType.Text).Value = m_tienluong;
                    cmd.Parameters.Add("m_xutri", NpgsqlDbType.Text).Value = m_xutri;
                    cmd.Parameters.Add("m_theodoi", NpgsqlDbType.Varchar, 4).Value = m_theodoi;
                    cmd.Parameters.Add("m_tangsinhmon", NpgsqlDbType.Numeric).Value = m_tangsinhmon;
                    cmd.Parameters.Add("m_tinhchat", NpgsqlDbType.Numeric).Value = m_tinhchat;
                    cmd.Parameters.Add("m_khac", NpgsqlDbType.Text).Value = m_khac;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_hausangan");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_hausan(decimal m_id, decimal m_idthuchien, string m_ngay, string m_toantrang, decimal m_mach,
            string m_huyetap, decimal m_nhietdo, decimal m_nhiptho, string m_tim, string m_phoi, string m_tucung,
            string m_tresosinh, string m_tienluong, string m_xutri, string m_theodoi,
            int m_tangsinhmon, int m_tinhchat, string m_khac, int m_ditieu, string m_tc_ditieu, int m_tieu, string m_tc_tieu,
            int m_sandich, int m_tc_sandich, int m_userid)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_hausan set idthuchien=:m_idthuchien,ngay=to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),toantrang=:m_toantrang,";
            sql += "mach=:m_mach,huyetap=:m_huyetap,nhietdo=:m_nhietdo,nhiptho=:m_nhiptho,tim=:m_tim,phoi=:m_phoi,";
            sql += "tucung=:m_tucung,tresosinh=:m_tresosinh,tienluong=:m_tienluong,xutri=:m_xutri,theodoi=:m_theodoi,";
            sql += "tangsinhmon=:m_tangsinhmon,tinhchat=:m_tinhchat,khac=:m_khac,ditieu=:m_ditieu,tc_ditieu=:m_tc_ditieu,";
            sql += "tieu=:m_tieu,tc_tieu=:m_tc_tieu,sandich=:m_sandich,tc_sandich=:m_tc_sandich,userid=:m_userid ";
            sql += " where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                cmd.Parameters.Add("m_toantrang", NpgsqlDbType.Text).Value = m_toantrang;
                cmd.Parameters.Add("m_mach", NpgsqlDbType.Numeric).Value = m_mach;
                cmd.Parameters.Add("m_huyetap", NpgsqlDbType.Varchar, 7).Value = m_huyetap;
                cmd.Parameters.Add("m_nhietdo", NpgsqlDbType.Numeric).Value = m_nhietdo;
                cmd.Parameters.Add("m_nhiptho", NpgsqlDbType.Numeric).Value = m_nhiptho;
                cmd.Parameters.Add("m_tim", NpgsqlDbType.Text).Value = m_tim;
                cmd.Parameters.Add("m_phoi", NpgsqlDbType.Text).Value = m_phoi;
                cmd.Parameters.Add("m_tucung", NpgsqlDbType.Text).Value = m_tucung;
                cmd.Parameters.Add("m_tresosinh", NpgsqlDbType.Text).Value = m_tresosinh;
                cmd.Parameters.Add("m_tienluong", NpgsqlDbType.Text).Value = m_tienluong;
                cmd.Parameters.Add("m_xutri", NpgsqlDbType.Text).Value = m_xutri;
                cmd.Parameters.Add("m_theodoi", NpgsqlDbType.Varchar, 4).Value = m_theodoi;
                cmd.Parameters.Add("m_tangsinhmon", NpgsqlDbType.Numeric).Value = m_tangsinhmon;
                cmd.Parameters.Add("m_tinhchat", NpgsqlDbType.Numeric).Value = m_tinhchat;
                cmd.Parameters.Add("m_khac", NpgsqlDbType.Text).Value = m_khac;
                cmd.Parameters.Add("m_ditieu", NpgsqlDbType.Numeric).Value = m_ditieu;
                cmd.Parameters.Add("m_tc_ditieu", NpgsqlDbType.Text).Value = m_tc_ditieu;
                cmd.Parameters.Add("m_tieu", NpgsqlDbType.Numeric).Value = m_tieu;
                cmd.Parameters.Add("m_tc_tieu", NpgsqlDbType.Text).Value = m_tc_tieu;
                cmd.Parameters.Add("m_sandich", NpgsqlDbType.Numeric).Value = m_sandich;
                cmd.Parameters.Add("m_tc_sandich", NpgsqlDbType.Numeric).Value = m_tc_sandich;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_hausan (id,idthuchien,ngay,toantrang,mach,huyetap,nhietdo,nhiptho,tim,phoi,tucung,tresosinh,tienluong,xutri,theodoi,tangsinhmon,tinhchat,khac,ditieu,tc_ditieu,tieu,tc_tieu,sandich,tc_sandich,userid) values (:m_id,:m_idthuchien,to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),:m_toantrang,:m_mach,:m_huyetap,:m_nhietdo,:m_nhiptho,:m_tim,:m_phoi,:m_tucung,:m_tresosinh,:m_tienluong,:m_xutri,:m_theodoi,:m_tangsinhmon,:m_tinhchat,:m_khac,:m_ditieu,:m_tc_ditieu,:m_tieu,:m_tc_tieu,:m_sandich,:m_tc_sandich,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                    cmd.Parameters.Add("m_toantrang", NpgsqlDbType.Text).Value = m_toantrang;
                    cmd.Parameters.Add("m_mach", NpgsqlDbType.Numeric).Value = m_mach;
                    cmd.Parameters.Add("m_huyetap", NpgsqlDbType.Varchar, 7).Value = m_huyetap;
                    cmd.Parameters.Add("m_nhietdo", NpgsqlDbType.Numeric).Value = m_nhietdo;
                    cmd.Parameters.Add("m_nhiptho", NpgsqlDbType.Numeric).Value = m_nhiptho;
                    cmd.Parameters.Add("m_tim", NpgsqlDbType.Text).Value = m_tim;
                    cmd.Parameters.Add("m_phoi", NpgsqlDbType.Text).Value = m_phoi;
                    cmd.Parameters.Add("m_tucung", NpgsqlDbType.Text).Value = m_tucung;
                    cmd.Parameters.Add("m_tresosinh", NpgsqlDbType.Text).Value = m_tresosinh;
                    cmd.Parameters.Add("m_tienluong", NpgsqlDbType.Text).Value = m_tienluong;
                    cmd.Parameters.Add("m_xutri", NpgsqlDbType.Text).Value = m_xutri;
                    cmd.Parameters.Add("m_theodoi", NpgsqlDbType.Varchar, 4).Value = m_theodoi;
                    cmd.Parameters.Add("m_tangsinhmon", NpgsqlDbType.Numeric).Value = m_tangsinhmon;
                    cmd.Parameters.Add("m_tinhchat", NpgsqlDbType.Numeric).Value = m_tinhchat;
                    cmd.Parameters.Add("m_khac", NpgsqlDbType.Text).Value = m_khac;
                    cmd.Parameters.Add("m_ditieu", NpgsqlDbType.Numeric).Value = m_ditieu;
                    cmd.Parameters.Add("m_tc_ditieu", NpgsqlDbType.Text).Value = m_tc_ditieu;
                    cmd.Parameters.Add("m_tieu", NpgsqlDbType.Numeric).Value = m_tieu;
                    cmd.Parameters.Add("m_tc_tieu", NpgsqlDbType.Text).Value = m_tc_tieu;
                    cmd.Parameters.Add("m_sandich", NpgsqlDbType.Numeric).Value = m_sandich;
                    cmd.Parameters.Add("m_tc_sandich", NpgsqlDbType.Numeric).Value = m_tc_sandich;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_hausan");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_phukhoa(string m_ngayvv, decimal m_id, string m_kinhnam, string m_tinhchat, string m_chuky,
            decimal m_songay, string m_luongkinh, string m_kinhcc, int m_daubung, int m_thoigian, string m_chongnam,
            string m_hetkinh, string m_dieutri, string m_para, string m_da, string m_hach, string m_vu, string m_dauhieu,
            string m_moilon, string m_moinho, string m_amvat, string m_amho, string m_mangtrinh, string m_tangsinhmon,
            string m_amdao, string m_cotucung, string m_thantucung, string m_phanphu, string m_cactui)
        {
            string xxx = user + mmyy(m_ngayvv);
            sql = "update " + xxx + ".ba_phukhoa set kinhnam=:m_kinhnam,tinhchat=:m_tinhchat,chuky=:m_chuky,songay=:m_songay,";
            sql += "luongkinh=:m_luongkinh,kinhcc=to_date(:m_kinhcc,'dd/mm/yyyy'),daubung=:m_daubung,thoigian=:m_thoigian,";
            sql += "chongnam=:m_chongnam,hetkinh=:m_hetkinh,dieutri=:m_dieutri,para=:m_para,da=:m_da,hach=:m_hach,";
            sql += "vu=:m_vu,dauhieu=:m_dauhieu,moilon=:m_moilon,moinho=:m_moinho,amvat=:m_amvat,amho=:m_amho,";
            sql += "mangtrinh=:m_mangtrinh,tangsinhmon=:m_tangsinhmon,amdao=:m_amdao,cotucung=:m_cotucung,";
            sql += "thantucung=:m_thantucung,phanphu=:m_phanphu,cactui=:m_cactui ";
            sql += " where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_kinhnam", NpgsqlDbType.Varchar, 4).Value = m_kinhnam;
                cmd.Parameters.Add("m_tinhchat", NpgsqlDbType.Text).Value = m_tinhchat;
                cmd.Parameters.Add("m_chuky", NpgsqlDbType.Varchar, 20).Value = m_chuky;
                cmd.Parameters.Add("m_songay", NpgsqlDbType.Numeric).Value = m_songay;
                cmd.Parameters.Add("m_luongkinh", NpgsqlDbType.Text).Value = m_luongkinh;
                cmd.Parameters.Add("m_kinhcc", NpgsqlDbType.Varchar, 10).Value = m_kinhcc;
                cmd.Parameters.Add("m_daubung", NpgsqlDbType.Numeric).Value = m_daubung;
                cmd.Parameters.Add("m_thoigian", NpgsqlDbType.Numeric).Value = m_thoigian;
                cmd.Parameters.Add("m_chongnam", NpgsqlDbType.Varchar, 4).Value = m_chongnam;
                cmd.Parameters.Add("m_hetkinh", NpgsqlDbType.Varchar, 4).Value = m_hetkinh;
                cmd.Parameters.Add("m_dieutri", NpgsqlDbType.Text).Value = m_dieutri;
                cmd.Parameters.Add("m_para", NpgsqlDbType.Varchar, 8).Value = m_para;
                cmd.Parameters.Add("m_da", NpgsqlDbType.Text).Value = m_da;
                cmd.Parameters.Add("m_hach", NpgsqlDbType.Text).Value = m_hach;
                cmd.Parameters.Add("m_vu", NpgsqlDbType.Text).Value = m_vu;
                cmd.Parameters.Add("m_dauhieu", NpgsqlDbType.Text).Value = m_dauhieu;
                cmd.Parameters.Add("m_moilon", NpgsqlDbType.Text).Value = m_moilon;
                cmd.Parameters.Add("m_moinho", NpgsqlDbType.Text).Value = m_moinho;
                cmd.Parameters.Add("m_amvat", NpgsqlDbType.Text).Value = m_amvat;
                cmd.Parameters.Add("m_amho", NpgsqlDbType.Text).Value = m_amho;
                cmd.Parameters.Add("m_mangtrinh", NpgsqlDbType.Text).Value = m_mangtrinh;
                cmd.Parameters.Add("m_tangsinhmon", NpgsqlDbType.Text).Value = m_tangsinhmon;
                cmd.Parameters.Add("m_amdao", NpgsqlDbType.Text).Value = m_amdao;
                cmd.Parameters.Add("m_cotucung", NpgsqlDbType.Text).Value = m_cotucung;
                cmd.Parameters.Add("m_thantucung", NpgsqlDbType.Text).Value = m_thantucung;
                cmd.Parameters.Add("m_phanphu", NpgsqlDbType.Text).Value = m_phanphu;
                cmd.Parameters.Add("m_cactui", NpgsqlDbType.Text).Value = m_cactui;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_phukhoa (id,kinhnam,tinhchat,chuky,songay,luongkinh,kinhcc,daubung,thoigian,chongnam,hetkinh,dieutri,para,da,hach,vu,dauhieu,moilon,moinho,amvat,amho,mangtrinh,tangsinhmon,amdao,cotucung,thantucung,phanphu,cactui) values (:m_id,:m_kinhnam,:m_tinhchat,:m_chuky,:m_songay,:m_luongkinh,to_date(:m_kinhcc,'dd/mm/yyyy'),:m_daubung,:m_thoigian,:m_chongnam,:m_hetkinh,:m_dieutri,:m_para,:m_da,:m_hach,:m_vu,:m_dauhieu,:m_moilon,:m_moinho,:m_amvat,:m_amho,:m_mangtrinh,:m_tangsinhmon,:m_amdao,:m_cotucung,:m_thantucung,:m_phanphu,:m_cactui)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_kinhnam", NpgsqlDbType.Varchar, 4).Value = m_kinhnam;
                    cmd.Parameters.Add("m_tinhchat", NpgsqlDbType.Text).Value = m_tinhchat;
                    cmd.Parameters.Add("m_chuky", NpgsqlDbType.Varchar, 20).Value = m_chuky;
                    cmd.Parameters.Add("m_songay", NpgsqlDbType.Numeric).Value = m_songay;
                    cmd.Parameters.Add("m_luongkinh", NpgsqlDbType.Text).Value = m_luongkinh;
                    cmd.Parameters.Add("m_kinhcc", NpgsqlDbType.Varchar, 10).Value = m_kinhcc;
                    cmd.Parameters.Add("m_daubung", NpgsqlDbType.Numeric).Value = m_daubung;
                    cmd.Parameters.Add("m_thoigian", NpgsqlDbType.Numeric).Value = m_thoigian;
                    cmd.Parameters.Add("m_chongnam", NpgsqlDbType.Varchar, 4).Value = m_chongnam;
                    cmd.Parameters.Add("m_hetkinh", NpgsqlDbType.Varchar, 4).Value = m_hetkinh;
                    cmd.Parameters.Add("m_dieutri", NpgsqlDbType.Text).Value = m_dieutri;
                    cmd.Parameters.Add("m_para", NpgsqlDbType.Varchar, 8).Value = m_para;
                    cmd.Parameters.Add("m_da", NpgsqlDbType.Text).Value = m_da;
                    cmd.Parameters.Add("m_hach", NpgsqlDbType.Text).Value = m_hach;
                    cmd.Parameters.Add("m_vu", NpgsqlDbType.Text).Value = m_vu;
                    cmd.Parameters.Add("m_dauhieu", NpgsqlDbType.Text).Value = m_dauhieu;
                    cmd.Parameters.Add("m_moilon", NpgsqlDbType.Text).Value = m_moilon;
                    cmd.Parameters.Add("m_moinho", NpgsqlDbType.Text).Value = m_moinho;
                    cmd.Parameters.Add("m_amvat", NpgsqlDbType.Text).Value = m_amvat;
                    cmd.Parameters.Add("m_amho", NpgsqlDbType.Text).Value = m_amho;
                    cmd.Parameters.Add("m_mangtrinh", NpgsqlDbType.Text).Value = m_mangtrinh;
                    cmd.Parameters.Add("m_tangsinhmon", NpgsqlDbType.Text).Value = m_tangsinhmon;
                    cmd.Parameters.Add("m_amdao", NpgsqlDbType.Text).Value = m_amdao;
                    cmd.Parameters.Add("m_cotucung", NpgsqlDbType.Text).Value = m_cotucung;
                    cmd.Parameters.Add("m_thantucung", NpgsqlDbType.Text).Value = m_thantucung;
                    cmd.Parameters.Add("m_phanphu", NpgsqlDbType.Text).Value = m_phanphu;
                    cmd.Parameters.Add("m_cactui", NpgsqlDbType.Text).Value = m_cactui;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_phukhoa");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }

            return true;
        }

        public bool upd_ba_noikhoa(string m_ngay, decimal m_id, string m_chidinh, string m_thoigian, decimal m_soluong, string m_loai, string m_thoidiem)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_noikhoa set chidinh=:m_chidinh,thoigian=to_date(:m_thoigian,'dd/mm/yyyy'),";
            sql += "soluong=:m_soluong,loai=:m_loai,thoidiem=to_date(:m_thoidiem,'dd/mm/yyyy') where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_chidinh", NpgsqlDbType.Text).Value = m_chidinh;
                cmd.Parameters.Add("m_thoigian", NpgsqlDbType.Varchar, 10).Value = m_thoigian;
                cmd.Parameters.Add("m_soluong", NpgsqlDbType.Numeric).Value = m_soluong;
                cmd.Parameters.Add("m_loai", NpgsqlDbType.Text).Value = m_loai;
                cmd.Parameters.Add("m_thoidiem", NpgsqlDbType.Varchar, 10).Value = m_thoidiem;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_noikhoa (id,chidinh,thoigian,soluong,loai,thoidiem) values (:m_id,:m_chidinh,to_date(:m_thoigian,'dd/mm/yyyy'),:m_soluong,:m_loai,to_date(:m_thoidiem,'dd/mm/yyyy'))";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_chidinh", NpgsqlDbType.Text).Value = m_chidinh;
                    cmd.Parameters.Add("m_thoigian", NpgsqlDbType.Varchar, 10).Value = m_thoigian;
                    cmd.Parameters.Add("m_soluong", NpgsqlDbType.Numeric).Value = m_soluong;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Text).Value = m_loai;
                    cmd.Parameters.Add("m_thoidiem", NpgsqlDbType.Varchar, 10).Value = m_thoidiem;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_noikhoa");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_dongmachvanh(string m_ngay, decimal m_id, decimal m_stt, decimal m_soluong, string m_vitri)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_dongmachvanh set soluong=:m_soluong,vitri=:m_vitri where id=:m_id and stt=:m_stt";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_soluong", NpgsqlDbType.Numeric).Value = m_soluong;
                cmd.Parameters.Add("m_vitri", NpgsqlDbType.Text).Value = m_vitri;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_dongmachvanh (id,stt,soluong,vitri) values (:m_id,:m_stt,:m_soluong,:m_vitri)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_soluong", NpgsqlDbType.Numeric).Value = m_soluong;
                    cmd.Parameters.Add("m_vitri", NpgsqlDbType.Text).Value = m_vitri;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_dongmachvanh");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_tomtat(string m_ngay, decimal m_id, string m_benhnhan, string m_lydo, string m_conang, string m_thucthe, string m_clsdaco)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_tomtat set benhnhan=:m_benhnhan,lydo=:m_lydo,conang=:m_conang,";
            sql += "thucthe=:m_thucthe,clsdaco=:m_clsdaco where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_benhnhan", NpgsqlDbType.Text).Value = m_benhnhan;
                cmd.Parameters.Add("m_lydo", NpgsqlDbType.Text).Value = m_lydo;
                cmd.Parameters.Add("m_conang", NpgsqlDbType.Text).Value = m_conang;
                cmd.Parameters.Add("m_thucthe", NpgsqlDbType.Text).Value = m_thucthe;
                cmd.Parameters.Add("m_clsdaco", NpgsqlDbType.Text).Value = m_clsdaco;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_tomtat (id,benhnhan,lydo,conang,thucthe,clsdaco) values (:m_id,:m_benhnhan,:m_lydo,:m_conang,:m_thucthe,:m_clsdaco)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_benhnhan", NpgsqlDbType.Text).Value = m_benhnhan;
                    cmd.Parameters.Add("m_lydo", NpgsqlDbType.Text).Value = m_lydo;
                    cmd.Parameters.Add("m_conang", NpgsqlDbType.Text).Value = m_conang;
                    cmd.Parameters.Add("m_thucthe", NpgsqlDbType.Text).Value = m_thucthe;
                    cmd.Parameters.Add("m_clsdaco", NpgsqlDbType.Text).Value = m_clsdaco;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_tomtat");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_nhi(string m_ngay, decimal m_id, decimal m_conthu, string m_para, int m_tinhtrang,
            decimal m_cannang, int m_ditat, string m_tenditat, string m_tinhthan, string m_vandong, string m_benhlykhac,
            int m_nuoiduong, decimal m_caisua, int m_vuontre, int m_tainha, int m_lao, int m_bailiet, int m_soi,
            int m_hoga, int m_uonvan, int m_bachhau, int m_tckhac, string m_cuthe, decimal m_chieucao,
            decimal m_vongnguc, decimal m_vongdau)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_nhi set conthu=:m_conthu,para=:m_para,tinhtrang=:m_tinhtrang,cannang=:m_cannang,";
            sql += "ditat=:m_ditat,tenditat=:m_tenditat,tinhthan=:m_tinhthan,vandong=:m_vandong,benhlykhac=:m_benhlykhac,";
            sql += "nuoiduong=:m_nuoiduong,caisua=:m_caisua,vuontre=:m_vuontre,tainha=:m_tainha,lao=:m_lao,bailiet=:m_bailiet,";
            sql += "soi=:m_soi,hoga=:m_hoga,uonvan=:m_uonvan,bachhau=:m_bachhau,tckhac=:m_tckhac,cuthe=:m_cuthe,";
            sql += "chieucao=:m_chieucao,vongnguc=:m_vongnguc,vongdau=:m_vongdau";
            sql += " where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_conthu", NpgsqlDbType.Numeric).Value = m_conthu;
                cmd.Parameters.Add("m_para", NpgsqlDbType.Varchar, 8).Value = m_para;
                cmd.Parameters.Add("m_tinhtrang", NpgsqlDbType.Numeric).Value = m_tinhtrang;
                cmd.Parameters.Add("m_cannang", NpgsqlDbType.Numeric).Value = m_cannang;
                cmd.Parameters.Add("m_ditat", NpgsqlDbType.Numeric).Value = m_ditat;
                cmd.Parameters.Add("m_tenditat", NpgsqlDbType.Varchar, 10).Value = m_tenditat;
                cmd.Parameters.Add("m_tinhthan", NpgsqlDbType.Text).Value = m_tinhthan;
                cmd.Parameters.Add("m_vandong", NpgsqlDbType.Text).Value = m_vandong;
                cmd.Parameters.Add("m_benhlykhac", NpgsqlDbType.Text).Value = m_benhlykhac;
                cmd.Parameters.Add("m_nuoiduong", NpgsqlDbType.Numeric).Value = m_nuoiduong;
                cmd.Parameters.Add("m_caisua", NpgsqlDbType.Numeric).Value = m_caisua;
                cmd.Parameters.Add("m_vuontre", NpgsqlDbType.Numeric).Value = m_vuontre;
                cmd.Parameters.Add("m_tainha", NpgsqlDbType.Numeric).Value = m_tainha;
                cmd.Parameters.Add("m_lao", NpgsqlDbType.Numeric).Value = m_lao;
                cmd.Parameters.Add("m_bailiet", NpgsqlDbType.Numeric).Value = m_bailiet;
                cmd.Parameters.Add("m_soi", NpgsqlDbType.Numeric).Value = m_soi;
                cmd.Parameters.Add("m_hoga", NpgsqlDbType.Numeric).Value = m_hoga;
                cmd.Parameters.Add("m_uonvan", NpgsqlDbType.Numeric).Value = m_uonvan;
                cmd.Parameters.Add("m_bachhau", NpgsqlDbType.Numeric).Value = m_bachhau;
                cmd.Parameters.Add("m_tckhac", NpgsqlDbType.Numeric).Value = m_tckhac;
                cmd.Parameters.Add("m_cuthe", NpgsqlDbType.Text).Value = m_cuthe;
                cmd.Parameters.Add("m_chieucao", NpgsqlDbType.Numeric).Value = m_chieucao;
                cmd.Parameters.Add("m_vongnguc", NpgsqlDbType.Numeric).Value = m_vongnguc;
                cmd.Parameters.Add("m_vongdau", NpgsqlDbType.Numeric).Value = m_vongdau;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_nhi (id,conthu,para,tinhtrang,cannang,ditat,tenditat,tinhthan,vandong,benhlykhac,nuoiduong,caisua,vuontre,tainha,lao,bailiet,soi,hoga,uonvan,bachhau,tckhac,cuthe,chieucao,vongnguc,vongdau) values (:m_id,:m_conthu,:m_para,:m_tinhtrang,:m_cannang,:m_ditat,:m_tenditat,:m_tinhthan,:m_vandong,:m_benhlykhac,:m_nuoiduong,:m_caisua,:m_vuontre,:m_tainha,:m_lao,:m_bailiet,:m_soi,:m_hoga,:m_uonvan,:m_bachhau,:m_tckhac,:m_cuthe,:m_chieucao,:m_vongnguc,:m_vongdau)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_conthu", NpgsqlDbType.Numeric).Value = m_conthu;
                    cmd.Parameters.Add("m_para", NpgsqlDbType.Varchar, 8).Value = m_para;
                    cmd.Parameters.Add("m_tinhtrang", NpgsqlDbType.Numeric).Value = m_tinhtrang;
                    cmd.Parameters.Add("m_cannang", NpgsqlDbType.Numeric).Value = m_cannang;
                    cmd.Parameters.Add("m_ditat", NpgsqlDbType.Numeric).Value = m_ditat;
                    cmd.Parameters.Add("m_tenditat", NpgsqlDbType.Varchar, 10).Value = m_tenditat;
                    cmd.Parameters.Add("m_tinhthan", NpgsqlDbType.Text).Value = m_tinhthan;
                    cmd.Parameters.Add("m_vandong", NpgsqlDbType.Text).Value = m_vandong;
                    cmd.Parameters.Add("m_benhlykhac", NpgsqlDbType.Text).Value = m_benhlykhac;
                    cmd.Parameters.Add("m_nuoiduong", NpgsqlDbType.Numeric).Value = m_nuoiduong;
                    cmd.Parameters.Add("m_caisua", NpgsqlDbType.Numeric).Value = m_caisua;
                    cmd.Parameters.Add("m_vuontre", NpgsqlDbType.Numeric).Value = m_vuontre;
                    cmd.Parameters.Add("m_tainha", NpgsqlDbType.Numeric).Value = m_tainha;
                    cmd.Parameters.Add("m_lao", NpgsqlDbType.Numeric).Value = m_lao;
                    cmd.Parameters.Add("m_bailiet", NpgsqlDbType.Numeric).Value = m_bailiet;
                    cmd.Parameters.Add("m_soi", NpgsqlDbType.Numeric).Value = m_soi;
                    cmd.Parameters.Add("m_hoga", NpgsqlDbType.Numeric).Value = m_hoga;
                    cmd.Parameters.Add("m_uonvan", NpgsqlDbType.Numeric).Value = m_uonvan;
                    cmd.Parameters.Add("m_bachhau", NpgsqlDbType.Numeric).Value = m_bachhau;
                    cmd.Parameters.Add("m_tckhac", NpgsqlDbType.Numeric).Value = m_tckhac;
                    cmd.Parameters.Add("m_cuthe", NpgsqlDbType.Text).Value = m_cuthe;
                    cmd.Parameters.Add("m_chieucao", NpgsqlDbType.Numeric).Value = m_chieucao;
                    cmd.Parameters.Add("m_vongnguc", NpgsqlDbType.Numeric).Value = m_vongnguc;
                    cmd.Parameters.Add("m_vongdau", NpgsqlDbType.Numeric).Value = m_vongdau;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_nhi");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_sosinh(string m_ngay, decimal m_id, string m_oivo, string m_mausac, int m_cachde, string m_luc,
            string m_lydo, int m_tinhtrang, string m_mabs, decimal m_apgar1, decimal m_apgar5, decimal m_apgar10,
            decimal m_cannang, string m_sausinh, string m_nguoichuyen, int m_ditat, int m_haumon, string m_tenditat,
            string m_tinhhinh, decimal m_can, decimal m_chieudai, decimal m_vongdau, decimal m_nhietdo,
            decimal m_nhiptho, string m_toanthan, int m_mausacda, string m_khac, string m_hohap, decimal m_nhiptho_khac,
            string m_nghephoi, decimal m_chiso, decimal m_nhiptim, string m_bung, string m_coquan, string m_xuongkhop,
            string m_phanxa, string m_lucco, string m_theodoi)
        {

            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_sosinh set oivo=to_date(:m_oivo,'dd/mm/yyyy hh24:mi'),mausac=:m_mausac,";
            sql += "cachde=:m_cachde,luc=to_date(:m_luc,'dd/mm/yyyy hh24:mi'),lydo=:m_lydo,tinhtrang=:m_tinhtrang,";
            sql += "mabs=:m_mabs,apgar1=:m_apgar1,apgar5=:m_apgar5,apgar10=:m_apgar10,cannang=:m_cannang,sausinh=:m_sausinh,";
            sql += "nguoichuyen=:m_nguoichuyen,ditat=:m_ditat,haumon=:m_haumon,tenditat=:m_tenditat,tinhhinh=:m_tinhhinh,";
            sql += "can=:m_can,chieudai=:m_chieudai,vongdau=:m_vongdau,nhietdo=:m_nhietdo,nhiptho=:m_nhiptho,";
            sql += "toanthan=:m_toanthan,mausacda=:m_mausacda,khac=:m_khac,hohap=:m_hohap,nhiptho_khac=:m_nhiptho_khac,";
            sql += "nghephoi=:m_nghephoi,chiso=:m_chiso,nhiptim=:m_nhiptim,bung=:m_bung,coquan=:m_coquan,xuongkhop=:m_xuongkhop,";
            sql += "phanxa=:m_phanxa,lucco=:m_lucco,theodoi=:m_theodoi where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_oivo", NpgsqlDbType.Varchar, 16).Value = m_oivo.Trim();
                cmd.Parameters.Add("m_mausac", NpgsqlDbType.Text).Value = m_mausac;
                cmd.Parameters.Add("m_cachde", NpgsqlDbType.Numeric).Value = m_cachde;
                cmd.Parameters.Add("m_luc", NpgsqlDbType.Varchar, 16).Value = m_luc.Trim();
                cmd.Parameters.Add("m_lydo", NpgsqlDbType.Text).Value = m_lydo;
                cmd.Parameters.Add("m_tinhtrang", NpgsqlDbType.Numeric).Value = m_tinhtrang;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_apgar1", NpgsqlDbType.Numeric).Value = m_apgar1;
                cmd.Parameters.Add("m_apgar5", NpgsqlDbType.Numeric).Value = m_apgar5;
                cmd.Parameters.Add("m_apgar10", NpgsqlDbType.Numeric).Value = m_apgar10;
                cmd.Parameters.Add("m_cannang", NpgsqlDbType.Numeric).Value = m_cannang;
                cmd.Parameters.Add("m_sausinh", NpgsqlDbType.Text).Value = m_sausinh;
                cmd.Parameters.Add("m_nguoichuyen", NpgsqlDbType.Varchar, 4).Value = m_nguoichuyen;
                cmd.Parameters.Add("m_ditat", NpgsqlDbType.Numeric).Value = m_ditat;
                cmd.Parameters.Add("m_haumon", NpgsqlDbType.Numeric).Value = m_haumon;
                cmd.Parameters.Add("m_tenditat", NpgsqlDbType.Varchar, 10).Value = m_tenditat;
                cmd.Parameters.Add("m_tinhhinh", NpgsqlDbType.Text).Value = m_tinhhinh;
                cmd.Parameters.Add("m_can", NpgsqlDbType.Numeric).Value = m_can;
                cmd.Parameters.Add("m_chieudai", NpgsqlDbType.Numeric).Value = m_chieudai;
                cmd.Parameters.Add("m_vongdau", NpgsqlDbType.Numeric).Value = m_vongdau;
                cmd.Parameters.Add("m_nhietdo", NpgsqlDbType.Numeric).Value = m_nhietdo;
                cmd.Parameters.Add("m_nhiptho", NpgsqlDbType.Numeric).Value = m_nhiptho;
                cmd.Parameters.Add("m_toanthan", NpgsqlDbType.Text).Value = m_toanthan;
                cmd.Parameters.Add("m_mausacda", NpgsqlDbType.Numeric).Value = m_mausacda;
                cmd.Parameters.Add("m_khac", NpgsqlDbType.Text).Value = m_khac;
                cmd.Parameters.Add("m_hohap", NpgsqlDbType.Text).Value = m_hohap;
                cmd.Parameters.Add("m_nhiptho_khac", NpgsqlDbType.Numeric).Value = m_nhiptho_khac;
                cmd.Parameters.Add("m_nghephoi", NpgsqlDbType.Text).Value = m_nghephoi;
                cmd.Parameters.Add("m_chiso", NpgsqlDbType.Numeric).Value = m_chiso;
                cmd.Parameters.Add("m_nhiptim", NpgsqlDbType.Numeric).Value = m_nhiptim;
                cmd.Parameters.Add("m_bung", NpgsqlDbType.Text).Value = m_bung;
                cmd.Parameters.Add("m_coquan", NpgsqlDbType.Text).Value = m_coquan;
                cmd.Parameters.Add("m_xuongkhop", NpgsqlDbType.Text).Value = m_xuongkhop;
                cmd.Parameters.Add("m_phanxa", NpgsqlDbType.Text).Value = m_phanxa;
                cmd.Parameters.Add("m_lucco", NpgsqlDbType.Text).Value = m_lucco;
                cmd.Parameters.Add("m_theodoi", NpgsqlDbType.Text).Value = m_theodoi;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_sosinh (id,oivo,mausac,cachde,luc,lydo,tinhtrang,mabs,apgar1,apgar5,apgar10,cannang,sausinh,nguoichuyen,ditat,haumon,tenditat,tinhhinh,can,chieudai,vongdau,nhietdo,nhiptho,toanthan,mausacda,khac,hohap,nhiptho_khac,nghephoi,chiso,nhiptim,bung,coquan,xuongkhop,phanxa,lucco,theodoi) values (:m_id,to_date(:m_oivo,'dd/mm/yyyy hh24:mi'),:m_mausac,:m_cachde,to_date(:m_luc,'dd/mm/yyyy hh24:mi'),:m_lydo,:m_tinhtrang,:m_mabs,:m_apgar1,:m_apgar5,:m_apgar10,:m_cannang,:m_sausinh,:m_nguoichuyen,:m_ditat,:m_haumon,:m_tenditat,:m_tinhhinh,:m_can,:m_chieudai,:m_vongdau,:m_nhietdo,:m_nhiptho,:m_toanthan,:m_mausacda,:m_khac,:m_hohap,:m_nhiptho_khac,:m_nghephoi,:m_chiso,:m_nhiptim,:m_bung,:m_coquan,:m_xuongkhop,:m_phanxa,:m_lucco,:m_theodoi)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_oivo", NpgsqlDbType.Varchar, 16).Value = m_oivo.Trim();
                    cmd.Parameters.Add("m_mausac", NpgsqlDbType.Text).Value = m_mausac;
                    cmd.Parameters.Add("m_cachde", NpgsqlDbType.Numeric).Value = m_cachde;
                    cmd.Parameters.Add("m_luc", NpgsqlDbType.Varchar, 16).Value = m_luc.Trim();
                    cmd.Parameters.Add("m_lydo", NpgsqlDbType.Text).Value = m_lydo;
                    cmd.Parameters.Add("m_tinhtrang", NpgsqlDbType.Numeric).Value = m_tinhtrang;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    cmd.Parameters.Add("m_apgar1", NpgsqlDbType.Numeric).Value = m_apgar1;
                    cmd.Parameters.Add("m_apgar5", NpgsqlDbType.Numeric).Value = m_apgar5;
                    cmd.Parameters.Add("m_apgar10", NpgsqlDbType.Numeric).Value = m_apgar10;
                    cmd.Parameters.Add("m_cannang", NpgsqlDbType.Numeric).Value = m_cannang;
                    cmd.Parameters.Add("m_sausinh", NpgsqlDbType.Text).Value = m_sausinh;
                    cmd.Parameters.Add("m_nguoichuyen", NpgsqlDbType.Varchar, 4).Value = m_nguoichuyen;
                    cmd.Parameters.Add("m_ditat", NpgsqlDbType.Numeric).Value = m_ditat;
                    cmd.Parameters.Add("m_haumon", NpgsqlDbType.Numeric).Value = m_haumon;
                    cmd.Parameters.Add("m_tenditat", NpgsqlDbType.Varchar, 10).Value = m_tenditat;
                    cmd.Parameters.Add("m_tinhhinh", NpgsqlDbType.Text).Value = m_tinhhinh;
                    cmd.Parameters.Add("m_can", NpgsqlDbType.Numeric).Value = m_can;
                    cmd.Parameters.Add("m_chieudai", NpgsqlDbType.Numeric).Value = m_chieudai;
                    cmd.Parameters.Add("m_vongdau", NpgsqlDbType.Numeric).Value = m_vongdau;
                    cmd.Parameters.Add("m_nhietdo", NpgsqlDbType.Numeric).Value = m_nhietdo;
                    cmd.Parameters.Add("m_nhiptho", NpgsqlDbType.Numeric).Value = m_nhiptho;
                    cmd.Parameters.Add("m_toanthan", NpgsqlDbType.Text).Value = m_toanthan;
                    cmd.Parameters.Add("m_mausacda", NpgsqlDbType.Numeric).Value = m_mausacda;
                    cmd.Parameters.Add("m_khac", NpgsqlDbType.Text).Value = m_khac;
                    cmd.Parameters.Add("m_hohap", NpgsqlDbType.Text).Value = m_hohap;
                    cmd.Parameters.Add("m_nhiptho_khac", NpgsqlDbType.Numeric).Value = m_nhiptho_khac;
                    cmd.Parameters.Add("m_nghephoi", NpgsqlDbType.Text).Value = m_nghephoi;
                    cmd.Parameters.Add("m_chiso", NpgsqlDbType.Numeric).Value = m_chiso;
                    cmd.Parameters.Add("m_nhiptim", NpgsqlDbType.Numeric).Value = m_nhiptim;
                    cmd.Parameters.Add("m_bung", NpgsqlDbType.Text).Value = m_bung;
                    cmd.Parameters.Add("m_coquan", NpgsqlDbType.Text).Value = m_coquan;
                    cmd.Parameters.Add("m_xuongkhop", NpgsqlDbType.Text).Value = m_xuongkhop;
                    cmd.Parameters.Add("m_phanxa", NpgsqlDbType.Text).Value = m_phanxa;
                    cmd.Parameters.Add("m_lucco", NpgsqlDbType.Text).Value = m_lucco;
                    cmd.Parameters.Add("m_theodoi", NpgsqlDbType.Text).Value = m_theodoi;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_sosinh");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_sosinh_pp(string m_ngay, decimal m_id, int m_ma)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_sosinh_pp set ma=:m_ma where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_sosinh_pp (id,ma) values (:m_id,:m_ma)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_sosinh_pp");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_dmhoso(decimal m_id, decimal m_stt, string m_ten, int m_khac, int m_userid)
        {
            sql = "update ba_dmhoso set stt=:m_stt,ten=:m_ten,khac=:m_khac,userid=:m_userid where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_khac", NpgsqlDbType.Numeric).Value = m_khac;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into ba_dmhoso (id,stt,ten,khac,userid) values (:m_id,:m_stt,:m_ten,:m_khac,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    cmd.Parameters.Add("m_khac", NpgsqlDbType.Numeric).Value = m_khac;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_dmhoso");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_dmxntienphau(decimal m_id, decimal m_stt, string m_ten, int m_mavp, int m_userid)
        {
            sql = "update ba_dmxntienphau set stt=:m_stt,ten=:m_ten,mavp=:m_mavp,userid=:m_userid where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_mavp", NpgsqlDbType.Numeric).Value = m_mavp;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into ba_dmxntienphau (id,stt,ten,mavp,userid) values (:m_id,:m_stt,:m_ten,:m_mavp,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    cmd.Parameters.Add("m_mavp", NpgsqlDbType.Numeric).Value = m_mavp;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_dmxntienphau");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_dmchepham(decimal m_id, decimal m_stt, string m_ten, decimal m_handung, int m_userid)
        {
            sql = "update ba_dmchepham set stt=:m_stt,ten=:m_ten,handung=:m_handung,userid=:m_userid where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_handung", NpgsqlDbType.Numeric).Value = m_handung;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into ba_dmchepham (id,stt,ten,handung,userid) values (:m_id,:m_stt,:m_ten,:m_handung,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    cmd.Parameters.Add("m_handung", NpgsqlDbType.Numeric).Value = m_handung;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_dmchepham");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_dmmau(decimal m_id, decimal m_stt, string m_ma, string m_ten, string m_dvt, int m_chepham, string m_thetich, int m_userid)
        {
            sql = "update ba_dmmau set stt=:m_stt,ma=:m_ma,ten=:m_ten,dvt=:m_dvt,chepham=:m_chepham,thetich=:m_thetich,userid=:m_userid where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 10).Value = m_ma;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_dvt", NpgsqlDbType.Text).Value = m_dvt;
                cmd.Parameters.Add("m_chepham", NpgsqlDbType.Numeric).Value = m_chepham;
                cmd.Parameters.Add("m_thetich", NpgsqlDbType.Text).Value = m_thetich;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into ba_dmmau (id,stt,ma,ten,dvt,chepham,thetich,userid) values (:m_id,:m_stt,:m_ma,:m_ten,:m_dvt,:m_chepham,:m_thetich,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 10).Value = m_ma;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    cmd.Parameters.Add("m_dvt", NpgsqlDbType.Text).Value = m_dvt;
                    cmd.Parameters.Add("m_chepham", NpgsqlDbType.Numeric).Value = m_chepham;
                    cmd.Parameters.Add("m_thetich", NpgsqlDbType.Text).Value = m_thetich;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_dmmau");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_thuchien(string m_ngay, decimal m_id, string m_mabn, decimal m_maql, decimal m_idkhoa, string m_makp, string m_phong, string m_giuong, string m_chandoan)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_thuchien set mabn=:m_mabn,maql=:m_maql,idkhoa=:m_idkhoa,makp=:m_makp,phong=:m_phong,giuong=:m_giuong,chandoan=:m_chandoan where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                cmd.Parameters.Add("m_idkhoa", NpgsqlDbType.Numeric).Value = m_idkhoa;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar).Value = m_makp;
                cmd.Parameters.Add("m_phong", NpgsqlDbType.Varchar, 10).Value = m_phong;
                cmd.Parameters.Add("m_giuong", NpgsqlDbType.Varchar, 20).Value = m_giuong;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_thuchien (id,mabn,maql,idkhoa,makp,phong,giuong,chandoan) values (:m_id,:m_mabn,:m_maql,:m_idkhoa,:m_makp,:m_phong,:m_giuong,:m_chandoan)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_idkhoa", NpgsqlDbType.Numeric).Value = m_idkhoa;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar).Value = m_makp;
                    cmd.Parameters.Add("m_phong", NpgsqlDbType.Varchar, 10).Value = m_phong;
                    cmd.Parameters.Add("m_giuong", NpgsqlDbType.Varchar, 20).Value = m_giuong;
                    cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_thuchien");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_chung(string m_ngay, string m_mabn, decimal m_id, decimal m_idthuchien, string m_lydo, decimal m_lanthu, string m_hb_benhly, string m_hb_banthan, string m_hb_giadinh, string m_kb_toanthan, string m_kb_ngoai, string m_kb_tuanhoan, string m_kb_hohap, string m_kb_tieuhoa, string m_kb_than, string m_kb_thankinh, string m_kb_co, string m_kb_tmh, string m_kb_rhm, string m_kb_mat, string m_kb_noitiet, string m_kb_khac, string m_kb_tomtat, string m_phanbiet, string m_tienluong, string m_dieutri, string m_bslba, string m_tk_benhly, string m_tk_tomtat, string m_tk_phuongphap, string m_tk_tinhtrang, string m_tk_dieutri, string m_nguoigiao, string m_nguoinhan, string m_mabs, int m_userid)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_chung set mabn=:m_mabn,idthuchien=:m_idthuchien,lydo=:m_lydo,lanthu=:m_lanthu,hb_benhly=:m_hb_benhly,";
            sql += "hb_banthan=:m_hb_banthan,hb_giadinh=:m_hb_giadinh,kb_toanthan=:m_kb_toanthan,kb_ngoai=:m_kb_ngoai,";
            sql += "kb_tuanhoan=:m_kb_tuanhoan,kb_hohap=:m_kb_hohap,kb_tieuhoa=:m_kb_tieuhoa,kb_than=:m_kb_than,";
            sql += "kb_thankinh=:m_kb_thankinh,kb_co=:m_kb_co,kb_tmh=:m_kb_tmh,kb_rhm=:m_kb_rhm,kb_mat=:m_kb_mat,";
            sql += "kb_noitiet=:m_kb_noitiet,kb_khac=:m_kb_khac,kb_tomtat=:m_kb_tomtat,phanbiet=:m_phanbiet,";
            sql += "tienluong=:m_tienluong,dieutri=:m_dieutri,bslban=:m_bslban,tk_benhly=:m_tk_benhly,tk_tomtat=:m_tk_tomtat,";
            sql += "tk_phuongphap=:m_tk_phuongphap,tk_tinhtrang=:m_tk_tinhtrang,tk_dieutri=:m_tk_dieutri,nguoigiao=:m_nguoigiao,nguoinhan=:m_nguoinhan,";
            sql += "mabs=:m_mabs,userid=:m_userid where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                cmd.Parameters.Add("m_lydo", NpgsqlDbType.Text).Value = m_lydo;
                cmd.Parameters.Add("m_lanthu", NpgsqlDbType.Numeric).Value = m_lanthu;
                cmd.Parameters.Add("m_hb_benhly", NpgsqlDbType.Text).Value = m_hb_benhly;
                cmd.Parameters.Add("m_hb_banthan", NpgsqlDbType.Text).Value = m_hb_banthan;
                cmd.Parameters.Add("m_hb_giadinh", NpgsqlDbType.Text).Value = m_hb_giadinh;
                cmd.Parameters.Add("m_kb_toanthan", NpgsqlDbType.Text).Value = m_kb_toanthan;
                cmd.Parameters.Add("m_kb_ngoai", NpgsqlDbType.Text).Value = m_kb_ngoai;
                cmd.Parameters.Add("m_kb_tuanhoan", NpgsqlDbType.Text).Value = m_kb_tuanhoan;
                cmd.Parameters.Add("m_kb_hohap", NpgsqlDbType.Text).Value = m_kb_hohap;
                cmd.Parameters.Add("m_kb_tieuhoa", NpgsqlDbType.Text).Value = m_kb_tieuhoa;
                cmd.Parameters.Add("m_kb_than", NpgsqlDbType.Text).Value = m_kb_than;
                cmd.Parameters.Add("m_kb_thankinh", NpgsqlDbType.Text).Value = m_kb_thankinh;
                cmd.Parameters.Add("m_kb_co", NpgsqlDbType.Text).Value = m_kb_co;
                cmd.Parameters.Add("m_kb_tmh", NpgsqlDbType.Text).Value = m_kb_tmh;
                cmd.Parameters.Add("m_kb_rhm", NpgsqlDbType.Text).Value = m_kb_rhm;
                cmd.Parameters.Add("m_kb_mat", NpgsqlDbType.Text).Value = m_kb_mat;
                cmd.Parameters.Add("m_kb_noitiet", NpgsqlDbType.Text).Value = m_kb_noitiet;
                cmd.Parameters.Add("m_kb_khac", NpgsqlDbType.Text).Value = m_kb_khac;
                cmd.Parameters.Add("m_kb_tomtat", NpgsqlDbType.Text).Value = m_kb_tomtat;
                cmd.Parameters.Add("m_phanbiet", NpgsqlDbType.Text).Value = m_phanbiet;
                cmd.Parameters.Add("m_tienluong", NpgsqlDbType.Text).Value = m_tienluong;
                cmd.Parameters.Add("m_dieutri", NpgsqlDbType.Text).Value = m_dieutri;
                cmd.Parameters.Add("m_bslban", NpgsqlDbType.Varchar, 4).Value = m_bslba;
                cmd.Parameters.Add("m_tk_benhly", NpgsqlDbType.Text).Value = m_tk_benhly;
                cmd.Parameters.Add("m_tk_tomtat", NpgsqlDbType.Text).Value = m_tk_tomtat;
                cmd.Parameters.Add("m_tk_phuongphap", NpgsqlDbType.Text).Value = m_tk_phuongphap;
                cmd.Parameters.Add("m_tk_tinhtrang", NpgsqlDbType.Text).Value = m_tk_tinhtrang;
                cmd.Parameters.Add("m_tk_dieutri", NpgsqlDbType.Text).Value = m_tk_dieutri;
                cmd.Parameters.Add("m_nguoigiao", NpgsqlDbType.Varchar, 4).Value = m_nguoigiao;
                cmd.Parameters.Add("m_nguoinhan", NpgsqlDbType.Varchar, 4).Value = m_nguoinhan;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_chung (mabn,id,idthuchien,lydo,lanthu,hb_benhly,hb_banthan,hb_giadinh,kb_toanthan,kb_ngoai,kb_tuanhoan,kb_hohap,kb_tieuhoa,kb_than,kb_thankinh,kb_co,kb_tmh,kb_rhm,kb_mat,kb_noitiet,kb_khac,kb_tomtat,phanbiet,tienluong,dieutri,bslban,tk_benhly,tk_tomtat,tk_phuongphap,tk_tinhtrang,tk_dieutri,nguoigiao,nguoinhan,mabs,userid) values (:m_mabn,:m_id,:m_idthuchien,:m_lydo,:m_lanthu,:m_hb_benhly,:m_hb_banthan,:m_hb_giadinh,:m_kb_toanthan,:m_kb_ngoai,:m_kb_tuanhoan,:m_kb_hohap,:m_kb_tieuhoa,:m_kb_than,:m_kb_thankinh,:m_kb_co,:m_kb_tmh,:m_kb_rhm,:m_kb_mat,:m_kb_noitiet,:m_kb_khac,:m_kb_tomtat,:m_phanbiet,:m_tienluong,:m_dieutri,:m_bslban,:m_tk_benhly,:m_tk_tomtat,:m_tk_phuongphap,:m_tk_tinhtrang,:m_tk_dieutri,:m_nguoigiao,:m_nguoinhan,:m_mabs,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                    cmd.Parameters.Add("m_lydo", NpgsqlDbType.Text).Value = m_lydo;
                    cmd.Parameters.Add("m_lanthu", NpgsqlDbType.Numeric).Value = m_lanthu;
                    cmd.Parameters.Add("m_hb_benhly", NpgsqlDbType.Text).Value = m_hb_benhly;
                    cmd.Parameters.Add("m_hb_banthan", NpgsqlDbType.Text).Value = m_hb_banthan;
                    cmd.Parameters.Add("m_hb_giadinh", NpgsqlDbType.Text).Value = m_hb_giadinh;
                    cmd.Parameters.Add("m_kb_toanthan", NpgsqlDbType.Text).Value = m_kb_toanthan;
                    cmd.Parameters.Add("m_kb_ngoai", NpgsqlDbType.Text).Value = m_kb_ngoai;
                    cmd.Parameters.Add("m_kb_tuanhoan", NpgsqlDbType.Text).Value = m_kb_tuanhoan;
                    cmd.Parameters.Add("m_kb_hohap", NpgsqlDbType.Text).Value = m_kb_hohap;
                    cmd.Parameters.Add("m_kb_tieuhoa", NpgsqlDbType.Text).Value = m_kb_tieuhoa;
                    cmd.Parameters.Add("m_kb_than", NpgsqlDbType.Text).Value = m_kb_than;
                    cmd.Parameters.Add("m_kb_thankinh", NpgsqlDbType.Text).Value = m_kb_thankinh;
                    cmd.Parameters.Add("m_kb_co", NpgsqlDbType.Text).Value = m_kb_co;
                    cmd.Parameters.Add("m_kb_tmh", NpgsqlDbType.Text).Value = m_kb_tmh;
                    cmd.Parameters.Add("m_kb_rhm", NpgsqlDbType.Text).Value = m_kb_rhm;
                    cmd.Parameters.Add("m_kb_mat", NpgsqlDbType.Text).Value = m_kb_mat;
                    cmd.Parameters.Add("m_kb_noitiet", NpgsqlDbType.Text).Value = m_kb_noitiet;
                    cmd.Parameters.Add("m_kb_khac", NpgsqlDbType.Text).Value = m_kb_khac;
                    cmd.Parameters.Add("m_kb_tomtat", NpgsqlDbType.Text).Value = m_kb_tomtat;
                    cmd.Parameters.Add("m_phanbiet", NpgsqlDbType.Text).Value = m_phanbiet;
                    cmd.Parameters.Add("m_tienluong", NpgsqlDbType.Text).Value = m_tienluong;
                    cmd.Parameters.Add("m_dieutri", NpgsqlDbType.Text).Value = m_dieutri;
                    cmd.Parameters.Add("m_bslban", NpgsqlDbType.Varchar, 4).Value = m_bslba;
                    cmd.Parameters.Add("m_tk_benhly", NpgsqlDbType.Text).Value = m_tk_benhly;
                    cmd.Parameters.Add("m_tk_tomtat", NpgsqlDbType.Text).Value = m_tk_tomtat;
                    cmd.Parameters.Add("m_tk_phuongphap", NpgsqlDbType.Text).Value = m_tk_phuongphap;
                    cmd.Parameters.Add("m_tk_tinhtrang", NpgsqlDbType.Text).Value = m_tk_tinhtrang;
                    cmd.Parameters.Add("m_tk_dieutri", NpgsqlDbType.Text).Value = m_tk_dieutri;
                    cmd.Parameters.Add("m_nguoigiao", NpgsqlDbType.Varchar, 4).Value = m_nguoigiao;
                    cmd.Parameters.Add("m_nguoinhan", NpgsqlDbType.Varchar, 4).Value = m_nguoinhan;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_chung");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_hinh(string m_ngay, decimal m_id, int m_stt, byte[] m_image)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_hinh set image=:m_image where id=:m_id and stt=:m_stt";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_image", NpgsqlDbType.Bytea, m_image.Length).Value = m_image;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_hinh (id,stt,image) values (:m_id,:m_stt,:m_image)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_image", NpgsqlDbType.Bytea, m_image.Length).Value = m_image;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_hinh");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_hinh(decimal m_id, int m_stt, string m_ten, byte[] m_image)
        {
            sql = "update ba_hinh set ten=:m_ten,image=:m_image where id=:m_id and stt=:m_stt";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_image", NpgsqlDbType.Bytea, m_image.Length).Value = m_image;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into ba_hinh (id,stt,ten,image) values (:m_id,:m_stt,:m_ten,:m_image)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    cmd.Parameters.Add("m_image", NpgsqlDbType.Bytea, m_image.Length).Value = m_image;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_hinh");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_hbdacdiem(string m_ngay, decimal m_id, int m_ma, string m_thoigian)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_hbdacdiem set thoigian=:m_thoigian where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_thoigian", NpgsqlDbType.Text).Value = m_thoigian;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_hbdacdiem (id,ma,thoigian) values (:m_id,:m_ma,:m_thoigian)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_thoigian", NpgsqlDbType.Text).Value = m_thoigian;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_hbdacdiem");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_kbdausinhton(string m_ngay, string m_mabn, decimal m_id, decimal m_mach, decimal m_nhietdo, string m_huyetap, decimal m_nhiptho, decimal m_cannang, decimal m_chieucao)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_kbdausinhton set mabn=:m_mabn,mach=:m_mach,nhietdo=:m_nhietdo,huyetap=:m_huyetap,nhiptho=:m_nhiptho,cannang=:m_cannang,chieucao=:m_chieucao where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_mach", NpgsqlDbType.Numeric).Value = m_mach;
                cmd.Parameters.Add("m_nhietdo", NpgsqlDbType.Numeric).Value = m_nhietdo;
                cmd.Parameters.Add("m_huyetap", NpgsqlDbType.Varchar, 7).Value = m_huyetap;
                cmd.Parameters.Add("m_nhiptho", NpgsqlDbType.Numeric).Value = m_nhiptho;
                cmd.Parameters.Add("m_cannang", NpgsqlDbType.Numeric).Value = m_cannang;
                cmd.Parameters.Add("m_chieucao", NpgsqlDbType.Numeric).Value = m_chieucao;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_kbdausinhton (mabn,id,mach,nhietdo,huyetap,nhiptho,cannang,chieucao) values (:m_mabn,:m_id,:m_mach,:m_nhietdo,:m_huyetap,:m_nhiptho,:m_cannang,:m_chieucao)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_mach", NpgsqlDbType.Numeric).Value = m_mach;
                    cmd.Parameters.Add("m_nhietdo", NpgsqlDbType.Numeric).Value = m_nhietdo;
                    cmd.Parameters.Add("m_huyetap", NpgsqlDbType.Varchar, 7).Value = m_huyetap;
                    cmd.Parameters.Add("m_nhiptho", NpgsqlDbType.Numeric).Value = m_nhiptho;
                    cmd.Parameters.Add("m_cannang", NpgsqlDbType.Numeric).Value = m_cannang;
                    cmd.Parameters.Add("m_chieucao", NpgsqlDbType.Numeric).Value = m_chieucao;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_kbdausinhton");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_tkhoso(string m_ngay, string m_mabn, decimal m_id, int m_ma, string m_khac, decimal m_so)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_tkhoso set mabn=:m_mabn,khac=:m_khac,so=:m_so where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_khac", NpgsqlDbType.Text).Value = m_khac;
                cmd.Parameters.Add("m_so", NpgsqlDbType.Numeric).Value = m_so;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_tkhoso (mabn,id,ma,khac,so) values (:m_mabn,:m_id,:m_ma,:m_khac,:m_so)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_khac", NpgsqlDbType.Text).Value = m_khac;
                    cmd.Parameters.Add("m_so", NpgsqlDbType.Numeric).Value = m_so;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_tkhoso");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_hoichancc(string m_ngayvv, string m_mabn, decimal m_id, decimal m_idthuchien, string m_ngay, string m_ngaymo, string m_mamau, string m_tenpt, int m_nhommau, int m_rh, decimal m_mau, string m_xnkhac,
            string m_ptdutru, string m_ptchinh, string m_ptphu, int m_phuongphap, string m_tuthe, string m_ykien, string m_bstruongk,
            string m_bstruong, string m_ptv, string m_tiensu, string m_tim, string m_phoi, string m_tienluong, string m_khac, string m_cotsong,
            string m_thankinh, string m_anlancuoi,
            string m_asa, string m_glodmann, string m_mallampati, string m_bsgayme, string m_bstruonggmhs, int m_userid)
        {
            string xxx = user + mmyy(m_ngayvv);
            sql = "update " + xxx + ".ba_hoichancc set mabn=:m_mabn,idthuchien=:m_idthuchien,ngay=to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),ngaymo=to_date(:m_ngaymo,'dd/mm/yyyy hh24:mi'),";
            sql += "mamau=:m_mamau,tenpt=:m_tenpt,nhommau=:m_nhommau,rh=:m_rh,mau=:m_mau,ptdutru=:m_ptdutru,ptchinh=:m_ptchinh,phuongphap=:m_phuongphap,";
            sql += "tuthe=:m_tuthe,bstruong=:m_bstruong,ptv=:m_ptv,tiensu=:m_tiensu,tim=:m_tim,phoi=:m_phoi,";
            sql += "tienluong=:m_tienluong,khac=:m_khac,cotsong=:m_cotsong,thankinh=:m_thankinh,anlancuoi=:m_anlancuoi,";
            sql += "asa=:m_asa,glodmann=:m_glodmann,mallampati=:m_mallampati,";
            sql += "bsgayme=:m_bsgayme,bstruonggmhs=:m_bstruonggmhs,userid=:m_userid where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                cmd.Parameters.Add("m_ngaymo", NpgsqlDbType.Varchar, 16).Value = m_ngaymo;
                cmd.Parameters.Add("m_mamau", NpgsqlDbType.Varchar, 10).Value = m_mamau;
                cmd.Parameters.Add("m_tenpt", NpgsqlDbType.Text).Value = m_tenpt;
                cmd.Parameters.Add("m_nhommau", NpgsqlDbType.Numeric).Value = m_nhommau;
                cmd.Parameters.Add("m_rh", NpgsqlDbType.Numeric).Value = m_rh;
                cmd.Parameters.Add("m_mau", NpgsqlDbType.Numeric).Value = m_mau;
                cmd.Parameters.Add("m_ptdutru", NpgsqlDbType.Varchar, 4).Value = m_ptdutru;
                cmd.Parameters.Add("m_ptchinh", NpgsqlDbType.Varchar, 4).Value = m_ptchinh;
                cmd.Parameters.Add("m_phuongphap", NpgsqlDbType.Numeric).Value = m_phuongphap;
                cmd.Parameters.Add("m_tuthe", NpgsqlDbType.Text).Value = m_tuthe;
                cmd.Parameters.Add("m_bstruong", NpgsqlDbType.Varchar, 4).Value = m_bstruong;
                cmd.Parameters.Add("m_ptv", NpgsqlDbType.Varchar, 4).Value = m_ptv;
                cmd.Parameters.Add("m_tiensu", NpgsqlDbType.Text).Value = m_tiensu;
                cmd.Parameters.Add("m_tim", NpgsqlDbType.Text).Value = m_tim;
                cmd.Parameters.Add("m_phoi", NpgsqlDbType.Text).Value = m_phoi;
                cmd.Parameters.Add("m_tienluong", NpgsqlDbType.Text).Value = m_tienluong;
                cmd.Parameters.Add("m_khac", NpgsqlDbType.Text).Value = m_khac;
                cmd.Parameters.Add("m_cotsong", NpgsqlDbType.Text).Value = m_cotsong;
                cmd.Parameters.Add("m_thankinh", NpgsqlDbType.Text).Value = m_thankinh;
                cmd.Parameters.Add("m_anlancuoi", NpgsqlDbType.Text).Value = m_anlancuoi;
                cmd.Parameters.Add("m_asa", NpgsqlDbType.Varchar, 3).Value = m_asa;
                cmd.Parameters.Add("m_glodmann", NpgsqlDbType.Varchar, 3).Value = m_glodmann;
                cmd.Parameters.Add("m_mallampati", NpgsqlDbType.Varchar, 3).Value = m_mallampati;
                cmd.Parameters.Add("m_bsgayme", NpgsqlDbType.Varchar, 4).Value = m_bsgayme;
                cmd.Parameters.Add("m_bstruonggmhs", NpgsqlDbType.Varchar, 4).Value = m_bstruonggmhs;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_hoichancc (mabn,id,idthuchien,ngay,ngaymo,mamau,tenpt,nhommau,rh,mau,ptdutru,ptchinh,phuongphap,tuthe,bstruong,ptv,tiensu,tim,phoi,tienluong,khac,cotsong,thankinh,anlancuoi,asa,glodmann,mallampati,bsgayme,bstruonggmhs,userid) values (:m_mabn,:m_id,:m_idthuchien,to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),to_date(:m_ngaymo,'dd/mm/yyyy hh24:mi'),:m_mamau,:m_tenpt,:m_nhommau,:m_rh,:m_mau,:m_ptdutru,:m_ptchinh,:m_phuongphap,:m_tuthe,:m_bstruong,:m_ptv,:m_tiensu,:m_tim,:m_phoi,:m_tienluong,:m_khac,:m_cotsong,:m_thankinh,:m_anlancuoi,:m_asa,:m_glodmann,:m_mallampati,:m_bsgayme,:m_bstruonggmhs,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                    cmd.Parameters.Add("m_ngaymo", NpgsqlDbType.Varchar, 16).Value = m_ngaymo;
                    cmd.Parameters.Add("m_mamau", NpgsqlDbType.Varchar, 10).Value = m_mamau;
                    cmd.Parameters.Add("m_tenpt", NpgsqlDbType.Text).Value = m_tenpt;
                    cmd.Parameters.Add("m_nhommau", NpgsqlDbType.Numeric).Value = m_nhommau;
                    cmd.Parameters.Add("m_rh", NpgsqlDbType.Numeric).Value = m_rh;
                    cmd.Parameters.Add("m_mau", NpgsqlDbType.Numeric).Value = m_mau;
                    cmd.Parameters.Add("m_ptdutru", NpgsqlDbType.Varchar, 4).Value = m_ptdutru;
                    cmd.Parameters.Add("m_ptchinh", NpgsqlDbType.Varchar, 4).Value = m_ptchinh;
                    cmd.Parameters.Add("m_phuongphap", NpgsqlDbType.Numeric).Value = m_phuongphap;
                    cmd.Parameters.Add("m_tuthe", NpgsqlDbType.Text).Value = m_tuthe;
                    cmd.Parameters.Add("m_bstruong", NpgsqlDbType.Varchar, 4).Value = m_bstruong;
                    cmd.Parameters.Add("m_ptv", NpgsqlDbType.Varchar, 4).Value = m_ptv;
                    cmd.Parameters.Add("m_tiensu", NpgsqlDbType.Text).Value = m_tiensu;
                    cmd.Parameters.Add("m_tim", NpgsqlDbType.Text).Value = m_tim;
                    cmd.Parameters.Add("m_phoi", NpgsqlDbType.Text).Value = m_phoi;
                    cmd.Parameters.Add("m_tienluong", NpgsqlDbType.Text).Value = m_tienluong;
                    cmd.Parameters.Add("m_khac", NpgsqlDbType.Text).Value = m_khac;
                    cmd.Parameters.Add("m_cotsong", NpgsqlDbType.Text).Value = m_cotsong;
                    cmd.Parameters.Add("m_thankinh", NpgsqlDbType.Text).Value = m_thankinh;
                    cmd.Parameters.Add("m_anlancuoi", NpgsqlDbType.Text).Value = m_anlancuoi;
                    cmd.Parameters.Add("m_asa", NpgsqlDbType.Varchar, 3).Value = m_asa;
                    cmd.Parameters.Add("m_glodmann", NpgsqlDbType.Varchar, 3).Value = m_glodmann;
                    cmd.Parameters.Add("m_mallampati", NpgsqlDbType.Varchar, 3).Value = m_mallampati;
                    cmd.Parameters.Add("m_bsgayme", NpgsqlDbType.Varchar, 4).Value = m_bsgayme;
                    cmd.Parameters.Add("m_bstruonggmhs", NpgsqlDbType.Varchar, 4).Value = m_bstruonggmhs;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_hoichancc");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_hoichanccxn(string m_ngay, string m_mabn, decimal m_id, int m_ma, int m_tinhtrang)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_hoichanccxn set mabn=:m_mabn,tinhtrang=:m_tinhtrang where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_tinhtrang", NpgsqlDbType.Numeric).Value = m_tinhtrang;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_hoichanccxn (mabn,id,ma,tinhtrang) values (:m_mabn,:m_id,:m_ma,:m_tinhtrang)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_tinhtrang", NpgsqlDbType.Numeric).Value = m_tinhtrang;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_hoichanccxn");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }


        public bool upd_ba_hoichan(string m_ngayvv, string m_mabn, decimal m_id, decimal m_idthuchien, string m_ngay, string m_ngaymo, string m_mamau, string m_tenpt,
            string m_thoigian, int m_sonde, int m_nhommau, int m_rh, decimal m_mau, string m_xnkhac, string m_ptdutru, string m_ptchinh,
            string m_ptphu, int m_phuongphap, string m_tuthe, int m_xq, string m_dungcu, string m_khac, string m_ykien,
            string m_giamdoc, string m_khth, string m_gayme, string m_bstruongk, string m_ptv, int m_userid)
        {
            string xxx = user + mmyy(m_ngayvv);
            sql = "update " + xxx + ".ba_hoichan set mabn=:m_mabn,idthuchien=:m_idthuchien,ngay=to_date(:m_ngay,'dd/mm/yyyy'),";
            sql += "ngaymo=to_date(:m_ngaymo,'dd/mm/yyyy hh24:mi'),mamau=:m_mamau,tenpt=:m_tenpt,thoigian=:m_thoigian,sonde=:m_sonde,nhommau=:m_nhommau,";
            sql += "rh=:m_rh,mau=:m_mau,xnkhac=:m_xnkhac,ptdutru=:m_ptdutru,ptchinh=:m_ptchinh,ptphu=:m_ptphu,";
            sql += "phuongphap=:m_phuongphap,tuthe=:m_tuthe,xq=:m_xq,dungcu=:m_dungcu,khac=:m_khac,ykien=:m_ykien,";
            sql += "giamdoc=:m_giamdoc,khth=:m_khth,gayme=:m_gayme,bstruongk=:m_bstruongk,ptv=:m_ptv,userid=:m_userid where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 10).Value = m_ngay;
                cmd.Parameters.Add("m_ngaymo", NpgsqlDbType.Varchar, 16).Value = m_ngaymo;
                cmd.Parameters.Add("m_mamau", NpgsqlDbType.Varchar, 10).Value = m_mamau;
                cmd.Parameters.Add("m_tenpt", NpgsqlDbType.Text).Value = m_tenpt;
                cmd.Parameters.Add("m_thoigian", NpgsqlDbType.Text).Value = m_thoigian;
                cmd.Parameters.Add("m_sonde", NpgsqlDbType.Numeric).Value = m_sonde;
                cmd.Parameters.Add("m_nhommau", NpgsqlDbType.Numeric).Value = m_nhommau;
                cmd.Parameters.Add("m_rh", NpgsqlDbType.Numeric).Value = m_rh;
                cmd.Parameters.Add("m_mau", NpgsqlDbType.Numeric).Value = m_mau;
                cmd.Parameters.Add("m_xnkhac", NpgsqlDbType.Text).Value = m_xnkhac;
                cmd.Parameters.Add("m_ptdutru", NpgsqlDbType.Varchar, 4).Value = m_ptdutru;
                cmd.Parameters.Add("m_ptchinh", NpgsqlDbType.Varchar, 4).Value = m_ptchinh;
                cmd.Parameters.Add("m_ptphu", NpgsqlDbType.Varchar, 4).Value = m_ptphu;
                cmd.Parameters.Add("m_phuongphap", NpgsqlDbType.Numeric).Value = m_phuongphap;
                cmd.Parameters.Add("m_tuthe", NpgsqlDbType.Text).Value = m_tuthe;
                cmd.Parameters.Add("m_xq", NpgsqlDbType.Numeric).Value = m_xq;
                cmd.Parameters.Add("m_dungcu", NpgsqlDbType.Text).Value = m_dungcu;
                cmd.Parameters.Add("m_khac", NpgsqlDbType.Text).Value = m_khac;
                cmd.Parameters.Add("m_ykien", NpgsqlDbType.Text).Value = m_ykien;
                cmd.Parameters.Add("m_giamdoc", NpgsqlDbType.Varchar, 4).Value = m_giamdoc;
                cmd.Parameters.Add("m_khth", NpgsqlDbType.Varchar, 4).Value = m_khth;
                cmd.Parameters.Add("m_gayme", NpgsqlDbType.Varchar, 4).Value = m_gayme;
                cmd.Parameters.Add("m_bstruongk", NpgsqlDbType.Varchar, 4).Value = m_bstruongk;
                cmd.Parameters.Add("m_ptv", NpgsqlDbType.Varchar, 4).Value = m_ptv;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_hoichan (mabn,id,idthuchien,ngay,ngaymo,mamau,tenpt,thoigian,sonde,nhommau,rh,mau,xnkhac,ptdutru,ptchinh,ptphu,phuongphap,tuthe,xq,dungcu,khac,ykien,giamdoc,khth,gayme,bstruongk,ptv,userid) values (:m_mabn,:m_id,:m_idthuchien,to_date(:m_ngay,'dd/mm/yyyy'),to_date(:m_ngaymo,'dd/mm/yyyy hh24:mi'),:m_mamau,:m_tenpt,:m_thoigian,:m_sonde,:m_nhommau,:m_rh,:m_mau,:m_xnkhac,:m_ptdutru,:m_ptchinh,:m_ptphu,:m_phuongphap,:m_tuthe,:m_xq,:m_dungcu,:m_khac,:m_ykien,:m_giamdoc,:m_khth,:m_gayme,:m_bstruongk,:m_ptv,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 10).Value = m_ngay;
                    cmd.Parameters.Add("m_ngaymo", NpgsqlDbType.Varchar, 16).Value = m_ngaymo;
                    cmd.Parameters.Add("m_mamau", NpgsqlDbType.Varchar, 10).Value = m_mamau;
                    cmd.Parameters.Add("m_tenpt", NpgsqlDbType.Text).Value = m_tenpt;
                    cmd.Parameters.Add("m_thoigian", NpgsqlDbType.Text).Value = m_thoigian;
                    cmd.Parameters.Add("m_sonde", NpgsqlDbType.Numeric).Value = m_sonde;
                    cmd.Parameters.Add("m_nhommau", NpgsqlDbType.Numeric).Value = m_nhommau;
                    cmd.Parameters.Add("m_rh", NpgsqlDbType.Numeric).Value = m_rh;
                    cmd.Parameters.Add("m_mau", NpgsqlDbType.Numeric).Value = m_mau;
                    cmd.Parameters.Add("m_xnkhac", NpgsqlDbType.Text).Value = m_xnkhac;
                    cmd.Parameters.Add("m_ptdutru", NpgsqlDbType.Varchar, 4).Value = m_ptdutru;
                    cmd.Parameters.Add("m_ptchinh", NpgsqlDbType.Varchar, 4).Value = m_ptchinh;
                    cmd.Parameters.Add("m_ptphu", NpgsqlDbType.Varchar, 4).Value = m_ptphu;
                    cmd.Parameters.Add("m_phuongphap", NpgsqlDbType.Numeric).Value = m_phuongphap;
                    cmd.Parameters.Add("m_tuthe", NpgsqlDbType.Text).Value = m_tuthe;
                    cmd.Parameters.Add("m_xq", NpgsqlDbType.Numeric).Value = m_xq;
                    cmd.Parameters.Add("m_dungcu", NpgsqlDbType.Text).Value = m_dungcu;
                    cmd.Parameters.Add("m_khac", NpgsqlDbType.Text).Value = m_khac;
                    cmd.Parameters.Add("m_ykien", NpgsqlDbType.Text).Value = m_ykien;
                    cmd.Parameters.Add("m_giamdoc", NpgsqlDbType.Varchar, 4).Value = m_giamdoc;
                    cmd.Parameters.Add("m_khth", NpgsqlDbType.Varchar, 4).Value = m_khth;
                    cmd.Parameters.Add("m_gayme", NpgsqlDbType.Varchar, 4).Value = m_gayme;
                    cmd.Parameters.Add("m_bstruongk", NpgsqlDbType.Varchar, 4).Value = m_bstruongk;
                    cmd.Parameters.Add("m_ptv", NpgsqlDbType.Varchar, 4).Value = m_ptv;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_hoichan");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_hoichanxn(string m_ngay, string m_mabn, decimal m_id, int m_ma, int m_tinhtrang)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_hoichanxn set mabn=:m_mabn,tinhtrang=:m_tinhtrang where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_tinhtrang", NpgsqlDbType.Numeric).Value = m_tinhtrang;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_hoichanxn (mabn,id,ma,tinhtrang) values (:m_mabn,:m_id,:m_ma,:m_tinhtrang)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_tinhtrang", NpgsqlDbType.Numeric).Value = m_tinhtrang;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_hoichanxn");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_khamtienme(string m_ngayvv, decimal m_id, string m_ngay, string m_mo, int m_mete, int m_taibien,
            int m_truyenmau, string m_diung, string m_bieuhien, int m_thuocla, int m_ruou, int m_matuy, int m_caoha,
            int m_thatnguc, int m_nmct, int m_suytim, int m_timbamsinh, int m_lao, int m_phequan, int m_horamau,
            int m_copd, int m_hh_khac, int m_tamthan, int m_dongkinh, int m_tbmmn, int m_buouco, int m_maukdong,
            int m_tieuduong, int m_hethong, int m_tk_khac, int m_cauthan, int m_suythan, int m_soithan, int m_tn_khac,
            int m_vangda, int m_viemgan, int m_tieuhoa, int m_thuongvi, int m_th_khac, string m_giadinh, string m_chitiet,
            int m_map, int m_phu, int m_hong, int m_nhot, int m_yeu, int m_khotho, decimal m_glasgow, decimal m_mach,
            string m_huyetap, decimal m_nhietdo, decimal m_nhiptho, decimal m_cannang, decimal m_chieucao, int m_hanche, int m_congan,
            int m_luoito, int m_khoiu, int m_giap, int m_cungham, int m_seo, int m_ranggia, string m_tl_khac,
            int m_timmach, int m_hohap, int m_than, int m_k_tieuhoa, int m_k_khac, int m_gu, int m_cungcotsong,
            int m_cotsongcu, string m_canlamsang, string m_dieutri, string m_denghi, string m_asa, string m_glodmann,
            string m_mallampati, string m_dukien, string m_thuthuat, string m_ketluan, string m_mabs)
        {
            string xxx = user + mmyy(m_ngayvv);
            sql = "update " + xxx + ".ba_khamtienme set ngay=to_date(:m_ngay,'dd/mm/yyyy'),mo=:m_mo,mete=:m_mete,taibien=:m_taibien,";
            sql += "truyenmau=:m_truyenmau,diung=:m_diung,bieuhien=:m_bieuhien,thuocla=:m_thuocla,ruou=:m_ruou,matuy=:m_matuy,caoha=:m_caoha,";
            sql += "thatnguc=:m_thatnguc,nmct=:m_nmct,suytim=:m_suytim,timbamsinh=:m_timbamsinh,lao=:m_lao,phequan=:m_phequan,horamau=:m_horamau,";
            sql += "copd=:m_copd,hh_khac=:m_hh_khac,tamthan=:m_tamthan,dongkinh=:m_dongkinh,tbmmn=:m_tbmmn,buouco=:m_buouco,maukdong=:m_maukdong,";
            sql += "tieuduong=:m_tieuduong,hethong=:m_hethong,tk_khac=:m_tk_khac,cauthan=:m_cauthan,suythan=:m_suythan,soithan=:m_soithan,tn_khac=:m_tn_khac,";
            sql += "vangda=:m_vangda,viemgan=:m_viemgan,tieuhoa=:m_tieuhoa,thuongvi=:m_thuongvi,th_khac=:m_th_khac,giadinh=:m_giadinh,chitiet=:m_chitiet,";
            sql += "map=:m_map,phu=:m_phu,hong=:m_hong,nhot=:m_nhot,yeu=:m_yeu,khotho=:m_khotho,glasgow=:m_glasgow,mach=:m_mach,";
            sql += "huyetap=:m_huyetap,nhietdo=:m_nhietdo,nhiptho=:m_nhiptho,cannang=:m_cannang,chieucao=:m_chieucao,hanche=:m_hanche,congan=:m_congan,";
            sql += "luoito=:m_luoito,khoiu=:m_khoiu,giap=:m_giap,cungham=:m_cungham,seo=:m_seo,ranggia=:m_ranggia,tl_khac=:m_tl_khac,";
            sql += "timmach=:m_timmach,hohap=:m_hohap,than=:m_than,k_tieuhoa=:m_k_tieuhoa,k_khac=:m_k_khac,gu=:m_gu,cungcotsong=:m_cungcotsong,cotsongcu=:m_cotsongcu,";
            sql += "canlamsang=:m_canlamsang,dieutri=:m_dieutri,denghi=:m_denghi,asa=:m_asa,glodmann=:m_glodmann,mallampati=:m_mallampati,";
            sql += "dukien=:m_dukien,thuthuat=:m_thuthuat,ketluan=:m_ketluan,mabs=:m_mabs";
            sql += " where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 10).Value = m_ngay;
                cmd.Parameters.Add("m_mo", NpgsqlDbType.Text).Value = m_mo;
                cmd.Parameters.Add("m_mete", NpgsqlDbType.Numeric).Value = m_mete;
                cmd.Parameters.Add("m_taibien", NpgsqlDbType.Numeric).Value = m_taibien;
                cmd.Parameters.Add("m_truyenmau", NpgsqlDbType.Numeric).Value = m_truyenmau;
                cmd.Parameters.Add("m_diung", NpgsqlDbType.Text).Value = m_diung;
                cmd.Parameters.Add("m_bieuhien", NpgsqlDbType.Text).Value = m_bieuhien;
                cmd.Parameters.Add("m_thuocla", NpgsqlDbType.Numeric).Value = m_thuocla;
                cmd.Parameters.Add("m_ruou", NpgsqlDbType.Numeric).Value = m_ruou;
                cmd.Parameters.Add("m_matuy", NpgsqlDbType.Numeric).Value = m_matuy;
                cmd.Parameters.Add("m_caoha", NpgsqlDbType.Numeric).Value = m_caoha;
                cmd.Parameters.Add("m_thatnguc", NpgsqlDbType.Numeric).Value = m_thatnguc;
                cmd.Parameters.Add("m_nmct", NpgsqlDbType.Numeric).Value = m_nmct;
                cmd.Parameters.Add("m_suytim", NpgsqlDbType.Numeric).Value = m_suytim;
                cmd.Parameters.Add("m_timbamsinh", NpgsqlDbType.Numeric).Value = m_timbamsinh;
                cmd.Parameters.Add("m_lao", NpgsqlDbType.Numeric).Value = m_lao;
                cmd.Parameters.Add("m_phequan", NpgsqlDbType.Numeric).Value = m_phequan;
                cmd.Parameters.Add("m_horamau", NpgsqlDbType.Numeric).Value = m_horamau;
                cmd.Parameters.Add("m_copd", NpgsqlDbType.Numeric).Value = m_copd;
                cmd.Parameters.Add("m_hh_khac", NpgsqlDbType.Numeric).Value = m_hh_khac;
                cmd.Parameters.Add("m_tamthan", NpgsqlDbType.Numeric).Value = m_tamthan;
                cmd.Parameters.Add("m_dongkinh", NpgsqlDbType.Numeric).Value = m_dongkinh;
                cmd.Parameters.Add("m_tbmmn", NpgsqlDbType.Numeric).Value = m_tbmmn;
                cmd.Parameters.Add("m_buouco", NpgsqlDbType.Numeric).Value = m_buouco;
                cmd.Parameters.Add("m_maukdong", NpgsqlDbType.Numeric).Value = m_maukdong;
                cmd.Parameters.Add("m_tieuduong", NpgsqlDbType.Numeric).Value = m_tieuduong;
                cmd.Parameters.Add("m_hethong", NpgsqlDbType.Numeric).Value = m_hethong;
                cmd.Parameters.Add("m_tk_khac", NpgsqlDbType.Numeric).Value = m_tk_khac;
                cmd.Parameters.Add("m_cauthan", NpgsqlDbType.Numeric).Value = m_cauthan;
                cmd.Parameters.Add("m_suythan", NpgsqlDbType.Numeric).Value = m_suythan;
                cmd.Parameters.Add("m_soithan", NpgsqlDbType.Numeric).Value = m_soithan;
                cmd.Parameters.Add("m_tn_khac", NpgsqlDbType.Numeric).Value = m_tn_khac;
                cmd.Parameters.Add("m_vangda", NpgsqlDbType.Numeric).Value = m_vangda;
                cmd.Parameters.Add("m_viemgan", NpgsqlDbType.Numeric).Value = m_viemgan;
                cmd.Parameters.Add("m_tieuhoa", NpgsqlDbType.Numeric).Value = m_tieuhoa;
                cmd.Parameters.Add("m_thuongvi", NpgsqlDbType.Numeric).Value = m_thuongvi;
                cmd.Parameters.Add("m_th_khac", NpgsqlDbType.Numeric).Value = m_th_khac;
                cmd.Parameters.Add("m_giadinh", NpgsqlDbType.Text).Value = m_giadinh;
                cmd.Parameters.Add("m_chitiet", NpgsqlDbType.Text).Value = m_chitiet;
                cmd.Parameters.Add("m_map", NpgsqlDbType.Numeric).Value = m_map;
                cmd.Parameters.Add("m_phu", NpgsqlDbType.Numeric).Value = m_phu;
                cmd.Parameters.Add("m_hong", NpgsqlDbType.Numeric).Value = m_hong;
                cmd.Parameters.Add("m_nhot", NpgsqlDbType.Numeric).Value = m_nhot;
                cmd.Parameters.Add("m_yeu", NpgsqlDbType.Numeric).Value = m_yeu;
                cmd.Parameters.Add("m_khotho", NpgsqlDbType.Numeric).Value = m_khotho;
                cmd.Parameters.Add("m_glasgow", NpgsqlDbType.Numeric).Value = m_glasgow;
                cmd.Parameters.Add("m_mach", NpgsqlDbType.Numeric).Value = m_mach;
                cmd.Parameters.Add("m_huyetap", NpgsqlDbType.Varchar, 7).Value = m_huyetap;
                cmd.Parameters.Add("m_nhietdo", NpgsqlDbType.Numeric).Value = m_nhietdo;
                cmd.Parameters.Add("m_nhiptho", NpgsqlDbType.Numeric).Value = m_nhiptho;
                cmd.Parameters.Add("m_cannang", NpgsqlDbType.Numeric).Value = m_cannang;
                cmd.Parameters.Add("m_chieucao", NpgsqlDbType.Numeric).Value = m_chieucao;
                cmd.Parameters.Add("m_hanche", NpgsqlDbType.Numeric).Value = m_hanche;
                cmd.Parameters.Add("m_congan", NpgsqlDbType.Numeric).Value = m_congan;
                cmd.Parameters.Add("m_luoito", NpgsqlDbType.Numeric).Value = m_luoito;
                cmd.Parameters.Add("m_khoiu", NpgsqlDbType.Numeric).Value = m_khoiu;
                cmd.Parameters.Add("m_giap", NpgsqlDbType.Numeric).Value = m_giap;
                cmd.Parameters.Add("m_cungham", NpgsqlDbType.Numeric).Value = m_cungham;
                cmd.Parameters.Add("m_seo", NpgsqlDbType.Numeric).Value = m_seo;
                cmd.Parameters.Add("m_ranggia", NpgsqlDbType.Numeric).Value = m_ranggia;
                cmd.Parameters.Add("m_tl_khac", NpgsqlDbType.Text).Value = m_tl_khac;
                cmd.Parameters.Add("m_timmach", NpgsqlDbType.Numeric).Value = m_timmach;
                cmd.Parameters.Add("m_hohap", NpgsqlDbType.Numeric).Value = m_hohap;
                cmd.Parameters.Add("m_than", NpgsqlDbType.Numeric).Value = m_than;
                cmd.Parameters.Add("m_k_tieuhoa", NpgsqlDbType.Numeric).Value = m_k_tieuhoa;
                cmd.Parameters.Add("m_k_khac", NpgsqlDbType.Numeric).Value = m_k_khac;
                cmd.Parameters.Add("m_gu", NpgsqlDbType.Numeric).Value = m_gu;
                cmd.Parameters.Add("m_cungcotsong", NpgsqlDbType.Numeric).Value = m_cungcotsong;
                cmd.Parameters.Add("m_cotsongcu", NpgsqlDbType.Numeric).Value = m_cotsongcu;
                cmd.Parameters.Add("m_canlamsang", NpgsqlDbType.Text).Value = m_canlamsang;
                cmd.Parameters.Add("m_dieutri", NpgsqlDbType.Text).Value = m_dieutri;
                cmd.Parameters.Add("m_denghi", NpgsqlDbType.Text).Value = m_denghi;
                cmd.Parameters.Add("m_asa", NpgsqlDbType.Varchar, 3).Value = m_asa;
                cmd.Parameters.Add("m_glodmann", NpgsqlDbType.Varchar, 3).Value = m_glodmann;
                cmd.Parameters.Add("m_mallampati", NpgsqlDbType.Varchar, 3).Value = m_mallampati;
                cmd.Parameters.Add("m_dukien", NpgsqlDbType.Text).Value = m_dukien;
                cmd.Parameters.Add("m_thuthuat", NpgsqlDbType.Text).Value = m_thuthuat;
                cmd.Parameters.Add("m_ketluan", NpgsqlDbType.Text).Value = m_ketluan;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_khamtienme (id,ngay,mo,mete,taibien,truyenmau,diung,bieuhien,thuocla,ruou,matuy,caoha,thatnguc,nmct,suytim,timbamsinh,lao,phequan,horamau,copd,hh_khac,tamthan,dongkinh,tbmmn,buouco,maukdong,tieuduong,hethong,tk_khac,cauthan,suythan,soithan,tn_khac,vangda,viemgan,tieuhoa,thuongvi,th_khac,giadinh,chitiet,map,phu,hong,nhot,yeu,khotho,glasgow,mach,huyetap,nhietdo,nhiptho,canang,chieucao,hanche,congan,luoito,khoiu,giap,cungham,seo,ranggia,tl_khac,timmach,hohap,than,k_tieuhoa,k_khac,gu,cungcotsong,cotsongcu,canlamsang,dieutri,denghi,asa,glodmann,mallampati,dukien,thuthuat,ketluan,mabs) values ";
                    sql += "(:m_id,to_date(:m_ngay,'dd/mm/yyyy'),:m_mo,:m_mete,:m_taibien,:m_truyenmau,:m_diung,:m_bieuhien,:m_thuocla,:m_ruou,:m_matuy,:m_caoha,:m_thatnguc,:m_nmct,:m_suytim,:m_timbamsinh,:m_lao,:m_phequan,:m_horamau,:m_copd,:m_hh_khac,:m_tamthan,:m_dongkinh,:m_tbmmn,:m_buouco,:m_maukdong,:m_tieuduong,:m_hethong,:m_tk_khac,:m_cauthan,:m_suythan,:m_soithan,:m_tn_khac,:m_vangda,:m_viemgan,:m_tieuhoa,:m_thuongvi,:m_th_khac,:m_giadinh,:m_chitiet,:m_map,:m_phu,:m_hong,:m_nhot,:m_yeu,:m_khotho,:m_glasgow,:m_mach,:m_huyetap,:m_nhietdo,:m_nhiptho,:m_canang,:m_chieucao,:m_hanche,:m_congan,:m_luoito,:m_khoiu,:m_giap,:m_cungham,:m_seo,:m_ranggia,:m_tl_khac,:m_timmach,:m_hohap,:m_than,:m_k_tieuhoa,:m_k_khac,:m_gu,:m_cungcotsong,:m_cotsongcu,:m_canlamsang,:m_dieutri,:m_denghi,:m_asa,:m_glodmann,:m_mallampati,:m_dukien,:m_thuthuat,:m_ketluan,:m_mabs)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 10).Value = m_ngay;
                    cmd.Parameters.Add("m_mo", NpgsqlDbType.Text).Value = m_mo;
                    cmd.Parameters.Add("m_mete", NpgsqlDbType.Numeric).Value = m_mete;
                    cmd.Parameters.Add("m_taibien", NpgsqlDbType.Numeric).Value = m_taibien;
                    cmd.Parameters.Add("m_truyenmau", NpgsqlDbType.Numeric).Value = m_truyenmau;
                    cmd.Parameters.Add("m_diung", NpgsqlDbType.Text).Value = m_diung;
                    cmd.Parameters.Add("m_bieuhien", NpgsqlDbType.Text).Value = m_bieuhien;
                    cmd.Parameters.Add("m_thuocla", NpgsqlDbType.Numeric).Value = m_thuocla;
                    cmd.Parameters.Add("m_ruou", NpgsqlDbType.Numeric).Value = m_ruou;
                    cmd.Parameters.Add("m_matuy", NpgsqlDbType.Numeric).Value = m_matuy;
                    cmd.Parameters.Add("m_caoha", NpgsqlDbType.Numeric).Value = m_caoha;
                    cmd.Parameters.Add("m_thatnguc", NpgsqlDbType.Numeric).Value = m_thatnguc;
                    cmd.Parameters.Add("m_nmct", NpgsqlDbType.Numeric).Value = m_nmct;
                    cmd.Parameters.Add("m_suytim", NpgsqlDbType.Numeric).Value = m_suytim;
                    cmd.Parameters.Add("m_timbamsinh", NpgsqlDbType.Numeric).Value = m_timbamsinh;
                    cmd.Parameters.Add("m_lao", NpgsqlDbType.Numeric).Value = m_lao;
                    cmd.Parameters.Add("m_phequan", NpgsqlDbType.Numeric).Value = m_phequan;
                    cmd.Parameters.Add("m_horamau", NpgsqlDbType.Numeric).Value = m_horamau;
                    cmd.Parameters.Add("m_copd", NpgsqlDbType.Numeric).Value = m_copd;
                    cmd.Parameters.Add("m_hh_khac", NpgsqlDbType.Numeric).Value = m_hh_khac;
                    cmd.Parameters.Add("m_tamthan", NpgsqlDbType.Numeric).Value = m_tamthan;
                    cmd.Parameters.Add("m_dongkinh", NpgsqlDbType.Numeric).Value = m_dongkinh;
                    cmd.Parameters.Add("m_tbmmn", NpgsqlDbType.Numeric).Value = m_tbmmn;
                    cmd.Parameters.Add("m_buouco", NpgsqlDbType.Numeric).Value = m_buouco;
                    cmd.Parameters.Add("m_maukdong", NpgsqlDbType.Numeric).Value = m_maukdong;
                    cmd.Parameters.Add("m_tieuduong", NpgsqlDbType.Numeric).Value = m_tieuduong;
                    cmd.Parameters.Add("m_hethong", NpgsqlDbType.Numeric).Value = m_hethong;
                    cmd.Parameters.Add("m_tk_khac", NpgsqlDbType.Numeric).Value = m_tk_khac;
                    cmd.Parameters.Add("m_cauthan", NpgsqlDbType.Numeric).Value = m_cauthan;
                    cmd.Parameters.Add("m_suythan", NpgsqlDbType.Numeric).Value = m_suythan;
                    cmd.Parameters.Add("m_soithan", NpgsqlDbType.Numeric).Value = m_soithan;
                    cmd.Parameters.Add("m_tn_khac", NpgsqlDbType.Numeric).Value = m_tn_khac;
                    cmd.Parameters.Add("m_vangda", NpgsqlDbType.Numeric).Value = m_vangda;
                    cmd.Parameters.Add("m_viemgan", NpgsqlDbType.Numeric).Value = m_viemgan;
                    cmd.Parameters.Add("m_tieuhoa", NpgsqlDbType.Numeric).Value = m_tieuhoa;
                    cmd.Parameters.Add("m_thuongvi", NpgsqlDbType.Numeric).Value = m_thuongvi;
                    cmd.Parameters.Add("m_th_khac", NpgsqlDbType.Numeric).Value = m_th_khac;
                    cmd.Parameters.Add("m_giadinh", NpgsqlDbType.Text).Value = m_giadinh;
                    cmd.Parameters.Add("m_chitiet", NpgsqlDbType.Text).Value = m_chitiet;
                    cmd.Parameters.Add("m_map", NpgsqlDbType.Numeric).Value = m_map;
                    cmd.Parameters.Add("m_phu", NpgsqlDbType.Numeric).Value = m_phu;
                    cmd.Parameters.Add("m_hong", NpgsqlDbType.Numeric).Value = m_hong;
                    cmd.Parameters.Add("m_nhot", NpgsqlDbType.Numeric).Value = m_nhot;
                    cmd.Parameters.Add("m_yeu", NpgsqlDbType.Numeric).Value = m_yeu;
                    cmd.Parameters.Add("m_khotho", NpgsqlDbType.Numeric).Value = m_khotho;
                    cmd.Parameters.Add("m_glasgow", NpgsqlDbType.Numeric).Value = m_glasgow;
                    cmd.Parameters.Add("m_mach", NpgsqlDbType.Numeric).Value = m_mach;
                    cmd.Parameters.Add("m_huyetap", NpgsqlDbType.Varchar, 7).Value = m_huyetap;
                    cmd.Parameters.Add("m_nhietdo", NpgsqlDbType.Numeric).Value = m_nhietdo;
                    cmd.Parameters.Add("m_nhiptho", NpgsqlDbType.Numeric).Value = m_nhiptho;
                    cmd.Parameters.Add("m_cannang", NpgsqlDbType.Numeric).Value = m_cannang;
                    cmd.Parameters.Add("m_chieucao", NpgsqlDbType.Numeric).Value = m_chieucao;
                    cmd.Parameters.Add("m_hanche", NpgsqlDbType.Numeric).Value = m_hanche;
                    cmd.Parameters.Add("m_congan", NpgsqlDbType.Numeric).Value = m_congan;
                    cmd.Parameters.Add("m_luoito", NpgsqlDbType.Numeric).Value = m_luoito;
                    cmd.Parameters.Add("m_khoiu", NpgsqlDbType.Numeric).Value = m_khoiu;
                    cmd.Parameters.Add("m_giap", NpgsqlDbType.Numeric).Value = m_giap;
                    cmd.Parameters.Add("m_cungham", NpgsqlDbType.Numeric).Value = m_cungham;
                    cmd.Parameters.Add("m_seo", NpgsqlDbType.Numeric).Value = m_seo;
                    cmd.Parameters.Add("m_ranggia", NpgsqlDbType.Numeric).Value = m_ranggia;
                    cmd.Parameters.Add("m_tl_khac", NpgsqlDbType.Text).Value = m_tl_khac;
                    cmd.Parameters.Add("m_timmach", NpgsqlDbType.Numeric).Value = m_timmach;
                    cmd.Parameters.Add("m_hohap", NpgsqlDbType.Numeric).Value = m_hohap;
                    cmd.Parameters.Add("m_than", NpgsqlDbType.Numeric).Value = m_than;
                    cmd.Parameters.Add("m_k_tieuhoa", NpgsqlDbType.Numeric).Value = m_k_tieuhoa;
                    cmd.Parameters.Add("m_k_khac", NpgsqlDbType.Numeric).Value = m_k_khac;
                    cmd.Parameters.Add("m_gu", NpgsqlDbType.Numeric).Value = m_gu;
                    cmd.Parameters.Add("m_cungcotsong", NpgsqlDbType.Numeric).Value = m_cungcotsong;
                    cmd.Parameters.Add("m_cotsongcu", NpgsqlDbType.Numeric).Value = m_cotsongcu;
                    cmd.Parameters.Add("m_canlamsang", NpgsqlDbType.Text).Value = m_canlamsang;
                    cmd.Parameters.Add("m_dieutri", NpgsqlDbType.Text).Value = m_dieutri;
                    cmd.Parameters.Add("m_denghi", NpgsqlDbType.Text).Value = m_denghi;
                    cmd.Parameters.Add("m_asa", NpgsqlDbType.Varchar, 3).Value = m_asa;
                    cmd.Parameters.Add("m_glodmann", NpgsqlDbType.Varchar, 3).Value = m_glodmann;
                    cmd.Parameters.Add("m_mallampati", NpgsqlDbType.Varchar, 3).Value = m_mallampati;
                    cmd.Parameters.Add("m_dukien", NpgsqlDbType.Text).Value = m_dukien;
                    cmd.Parameters.Add("m_thuthuat", NpgsqlDbType.Text).Value = m_thuthuat;
                    cmd.Parameters.Add("m_ketluan", NpgsqlDbType.Text).Value = m_ketluan;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_khamtienme");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_khamtienme1(string m_ngayvv, string m_mabn, decimal m_id, string m_ngay, string m_mo, int m_mete, int m_taibien,
            int m_truyenmau, string m_diung, string m_bieuhien, int m_thuocla, int m_ruou, int m_matuy, int m_caoha,
            int m_thatnguc, int m_nmct, int m_suytim, int m_timbamsinh, int m_lao, int m_phequan, int m_horamau,
            int m_copd, int m_hh_khac, int m_tamthan, int m_dongkinh, int m_tbmmn, int m_buouco, int m_maukdong,
            int m_tieuduong, int m_hethong, int m_tk_khac, int m_cauthan, int m_suythan)
        {
            string xxx = user + mmyy(m_ngayvv);
            sql = "update " + xxx + ".ba_khamtienme set mabn=:m_mabn,ngay=to_date(:m_ngay,'dd/mm/yyyy'),mo=:m_mo,mete=:m_mete,taibien=:m_taibien,";
            sql += "truyenmau=:m_truyenmau,diung=:m_diung,bieuhien=:m_bieuhien,thuocla=:m_thuocla,ruou=:m_ruou,matuy=:m_matuy,caoha=:m_caoha,";
            sql += "thatnguc=:m_thatnguc,nmct=:m_nmct,suytim=:m_suytim,timbamsinh=:m_timbamsinh,lao=:m_lao,phequan=:m_phequan,horamau=:m_horamau,";
            sql += "copd=:m_copd,hh_khac=:m_hh_khac,tamthan=:m_tamthan,dongkinh=:m_dongkinh,tbmmn=:m_tbmmn,buouco=:m_buouco,maukdong=:m_maukdong,";
            sql += "tieuduong=:m_tieuduong,hethong=:m_hethong,tk_khac=:m_tk_khac,cauthan=:m_cauthan,suythan=:m_suythan";
            sql += " where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 10).Value = m_ngay;
                cmd.Parameters.Add("m_mo", NpgsqlDbType.Text).Value = m_mo;
                cmd.Parameters.Add("m_mete", NpgsqlDbType.Numeric).Value = m_mete;
                cmd.Parameters.Add("m_taibien", NpgsqlDbType.Numeric).Value = m_taibien;
                cmd.Parameters.Add("m_truyenmau", NpgsqlDbType.Numeric).Value = m_truyenmau;
                cmd.Parameters.Add("m_diung", NpgsqlDbType.Text).Value = m_diung;
                cmd.Parameters.Add("m_bieuhien", NpgsqlDbType.Text).Value = m_bieuhien;
                cmd.Parameters.Add("m_thuocla", NpgsqlDbType.Numeric).Value = m_thuocla;
                cmd.Parameters.Add("m_ruou", NpgsqlDbType.Numeric).Value = m_ruou;
                cmd.Parameters.Add("m_matuy", NpgsqlDbType.Numeric).Value = m_matuy;
                cmd.Parameters.Add("m_caoha", NpgsqlDbType.Numeric).Value = m_caoha;
                cmd.Parameters.Add("m_thatnguc", NpgsqlDbType.Numeric).Value = m_thatnguc;
                cmd.Parameters.Add("m_nmct", NpgsqlDbType.Numeric).Value = m_nmct;
                cmd.Parameters.Add("m_suytim", NpgsqlDbType.Numeric).Value = m_suytim;
                cmd.Parameters.Add("m_timbamsinh", NpgsqlDbType.Numeric).Value = m_timbamsinh;
                cmd.Parameters.Add("m_lao", NpgsqlDbType.Numeric).Value = m_lao;
                cmd.Parameters.Add("m_phequan", NpgsqlDbType.Numeric).Value = m_phequan;
                cmd.Parameters.Add("m_horamau", NpgsqlDbType.Numeric).Value = m_horamau;
                cmd.Parameters.Add("m_copd", NpgsqlDbType.Numeric).Value = m_copd;
                cmd.Parameters.Add("m_hh_khac", NpgsqlDbType.Numeric).Value = m_hh_khac;
                cmd.Parameters.Add("m_tamthan", NpgsqlDbType.Numeric).Value = m_tamthan;
                cmd.Parameters.Add("m_dongkinh", NpgsqlDbType.Numeric).Value = m_dongkinh;
                cmd.Parameters.Add("m_tbmmn", NpgsqlDbType.Numeric).Value = m_tbmmn;
                cmd.Parameters.Add("m_buouco", NpgsqlDbType.Numeric).Value = m_buouco;
                cmd.Parameters.Add("m_maukdong", NpgsqlDbType.Numeric).Value = m_maukdong;
                cmd.Parameters.Add("m_tieuduong", NpgsqlDbType.Numeric).Value = m_tieuduong;
                cmd.Parameters.Add("m_hethong", NpgsqlDbType.Numeric).Value = m_hethong;
                cmd.Parameters.Add("m_tk_khac", NpgsqlDbType.Numeric).Value = m_tk_khac;
                cmd.Parameters.Add("m_cauthan", NpgsqlDbType.Numeric).Value = m_cauthan;
                cmd.Parameters.Add("m_suythan", NpgsqlDbType.Numeric).Value = m_suythan;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_khamtienme (mabn,id,ngay,mo,mete,taibien,truyenmau,diung,bieuhien,thuocla,ruou,matuy,caoha,thatnguc,nmct,suytim,timbamsinh,lao,phequan,horamau,copd,hh_khac,tamthan,dongkinh,tbmmn,buouco,maukdong,tieuduong,hethong,tk_khac,cauthan,suythan) values ";
                    sql += "(:m_mabn,:m_id,to_date(:m_ngay,'dd/mm/yyyy'),:m_mo,:m_mete,:m_taibien,:m_truyenmau,:m_diung,:m_bieuhien,:m_thuocla,:m_ruou,:m_matuy,:m_caoha,:m_thatnguc,:m_nmct,:m_suytim,:m_timbamsinh,:m_lao,:m_phequan,:m_horamau,:m_copd,:m_hh_khac,:m_tamthan,:m_dongkinh,:m_tbmmn,:m_buouco,:m_maukdong,:m_tieuduong,:m_hethong,:m_tk_khac,:m_cauthan,:m_suythan)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 10).Value = m_ngay;
                    cmd.Parameters.Add("m_mo", NpgsqlDbType.Text).Value = m_mo;
                    cmd.Parameters.Add("m_mete", NpgsqlDbType.Numeric).Value = m_mete;
                    cmd.Parameters.Add("m_taibien", NpgsqlDbType.Numeric).Value = m_taibien;
                    cmd.Parameters.Add("m_truyenmau", NpgsqlDbType.Numeric).Value = m_truyenmau;
                    cmd.Parameters.Add("m_diung", NpgsqlDbType.Text).Value = m_diung;
                    cmd.Parameters.Add("m_bieuhien", NpgsqlDbType.Text).Value = m_bieuhien;
                    cmd.Parameters.Add("m_thuocla", NpgsqlDbType.Numeric).Value = m_thuocla;
                    cmd.Parameters.Add("m_ruou", NpgsqlDbType.Numeric).Value = m_ruou;
                    cmd.Parameters.Add("m_matuy", NpgsqlDbType.Numeric).Value = m_matuy;
                    cmd.Parameters.Add("m_caoha", NpgsqlDbType.Numeric).Value = m_caoha;
                    cmd.Parameters.Add("m_thatnguc", NpgsqlDbType.Numeric).Value = m_thatnguc;
                    cmd.Parameters.Add("m_nmct", NpgsqlDbType.Numeric).Value = m_nmct;
                    cmd.Parameters.Add("m_suytim", NpgsqlDbType.Numeric).Value = m_suytim;
                    cmd.Parameters.Add("m_timbamsinh", NpgsqlDbType.Numeric).Value = m_timbamsinh;
                    cmd.Parameters.Add("m_lao", NpgsqlDbType.Numeric).Value = m_lao;
                    cmd.Parameters.Add("m_phequan", NpgsqlDbType.Numeric).Value = m_phequan;
                    cmd.Parameters.Add("m_horamau", NpgsqlDbType.Numeric).Value = m_horamau;
                    cmd.Parameters.Add("m_copd", NpgsqlDbType.Numeric).Value = m_copd;
                    cmd.Parameters.Add("m_hh_khac", NpgsqlDbType.Numeric).Value = m_hh_khac;
                    cmd.Parameters.Add("m_tamthan", NpgsqlDbType.Numeric).Value = m_tamthan;
                    cmd.Parameters.Add("m_dongkinh", NpgsqlDbType.Numeric).Value = m_dongkinh;
                    cmd.Parameters.Add("m_tbmmn", NpgsqlDbType.Numeric).Value = m_tbmmn;
                    cmd.Parameters.Add("m_buouco", NpgsqlDbType.Numeric).Value = m_buouco;
                    cmd.Parameters.Add("m_maukdong", NpgsqlDbType.Numeric).Value = m_maukdong;
                    cmd.Parameters.Add("m_tieuduong", NpgsqlDbType.Numeric).Value = m_tieuduong;
                    cmd.Parameters.Add("m_hethong", NpgsqlDbType.Numeric).Value = m_hethong;
                    cmd.Parameters.Add("m_tk_khac", NpgsqlDbType.Numeric).Value = m_tk_khac;
                    cmd.Parameters.Add("m_cauthan", NpgsqlDbType.Numeric).Value = m_cauthan;
                    cmd.Parameters.Add("m_suythan", NpgsqlDbType.Numeric).Value = m_suythan;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_khamtienme");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_khamtienme2(string m_ngayvv, string m_mabn, decimal m_id, int m_soithan, int m_tn_khac,
            int m_vangda, int m_viemgan, int m_tieuhoa, int m_thuongvi, int m_th_khac, string m_giadinh, string m_chitiet,
            int m_map, int m_phu, int m_hong, int m_nhot, int m_yeu, int m_khotho, decimal m_glasgow, decimal m_mach,
            string m_huyetap, decimal m_nhietdo, decimal m_nhiptho, decimal m_cannang, decimal m_chieucao, int m_hanche, int m_congan,
            int m_luoito, int m_khoiu, int m_giap, int m_cungham, int m_seo, int m_ranggia)
        {
            string xxx = user + mmyy(m_ngayvv);
            sql = "update " + xxx + ".ba_khamtienme set mabn=:m_mabn,soithan=:m_soithan,tn_khac=:m_tn_khac,";
            sql += "vangda=:m_vangda,viemgan=:m_viemgan,tieuhoa=:m_tieuhoa,thuongvi=:m_thuongvi,th_khac=:m_th_khac,giadinh=:m_giadinh,chitiet=:m_chitiet,";
            sql += "map=:m_map,phu=:m_phu,hong=:m_hong,nhot=:m_nhot,yeu=:m_yeu,khotho=:m_khotho,glasgow=:m_glasgow,mach=:m_mach,";
            sql += "huyetap=:m_huyetap,nhietdo=:m_nhietdo,nhiptho=:m_nhiptho,cannang=:m_cannang,chieucao=:m_chieucao,hanche=:m_hanche,congan=:m_congan,";
            sql += "luoito=:m_luoito,khoiu=:m_khoiu,giap=:m_giap,cungham=:m_cungham,seo=:m_seo,ranggia=:m_ranggia";
            sql += " where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_soithan", NpgsqlDbType.Numeric).Value = m_soithan;
                cmd.Parameters.Add("m_tn_khac", NpgsqlDbType.Numeric).Value = m_tn_khac;
                cmd.Parameters.Add("m_vangda", NpgsqlDbType.Numeric).Value = m_vangda;
                cmd.Parameters.Add("m_viemgan", NpgsqlDbType.Numeric).Value = m_viemgan;
                cmd.Parameters.Add("m_tieuhoa", NpgsqlDbType.Numeric).Value = m_tieuhoa;
                cmd.Parameters.Add("m_thuongvi", NpgsqlDbType.Numeric).Value = m_thuongvi;
                cmd.Parameters.Add("m_th_khac", NpgsqlDbType.Numeric).Value = m_th_khac;
                cmd.Parameters.Add("m_giadinh", NpgsqlDbType.Text).Value = m_giadinh;
                cmd.Parameters.Add("m_chitiet", NpgsqlDbType.Text).Value = m_chitiet;
                cmd.Parameters.Add("m_map", NpgsqlDbType.Numeric).Value = m_map;
                cmd.Parameters.Add("m_phu", NpgsqlDbType.Numeric).Value = m_phu;
                cmd.Parameters.Add("m_hong", NpgsqlDbType.Numeric).Value = m_hong;
                cmd.Parameters.Add("m_nhot", NpgsqlDbType.Numeric).Value = m_nhot;
                cmd.Parameters.Add("m_yeu", NpgsqlDbType.Numeric).Value = m_yeu;
                cmd.Parameters.Add("m_khotho", NpgsqlDbType.Numeric).Value = m_khotho;
                cmd.Parameters.Add("m_glasgow", NpgsqlDbType.Numeric).Value = m_glasgow;
                cmd.Parameters.Add("m_mach", NpgsqlDbType.Numeric).Value = m_mach;
                cmd.Parameters.Add("m_huyetap", NpgsqlDbType.Varchar, 7).Value = m_huyetap;
                cmd.Parameters.Add("m_nhietdo", NpgsqlDbType.Numeric).Value = m_nhietdo;
                cmd.Parameters.Add("m_nhiptho", NpgsqlDbType.Numeric).Value = m_nhiptho;
                cmd.Parameters.Add("m_cannang", NpgsqlDbType.Numeric).Value = m_cannang;
                cmd.Parameters.Add("m_chieucao", NpgsqlDbType.Numeric).Value = m_chieucao;
                cmd.Parameters.Add("m_hanche", NpgsqlDbType.Numeric).Value = m_hanche;
                cmd.Parameters.Add("m_congan", NpgsqlDbType.Numeric).Value = m_congan;
                cmd.Parameters.Add("m_luoito", NpgsqlDbType.Numeric).Value = m_luoito;
                cmd.Parameters.Add("m_khoiu", NpgsqlDbType.Numeric).Value = m_khoiu;
                cmd.Parameters.Add("m_giap", NpgsqlDbType.Numeric).Value = m_giap;
                cmd.Parameters.Add("m_cungham", NpgsqlDbType.Numeric).Value = m_cungham;
                cmd.Parameters.Add("m_seo", NpgsqlDbType.Numeric).Value = m_seo;
                cmd.Parameters.Add("m_ranggia", NpgsqlDbType.Numeric).Value = m_ranggia;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_khamtienme");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_khamtienme3(string m_ngayvv, string m_mabn, decimal m_id, string m_tl_khac, int m_timmach, int m_hohap, int m_than, int m_k_tieuhoa, int m_k_khac, int m_gu, int m_cungcotsong,
            int m_cotsongcu, string m_canlamsang, string m_dieutri, string m_denghi, string m_asa, string m_glodmann,
            string m_mallampati, string m_dukien, string m_thuthuat, string m_ketluan, string m_mabs)
        {
            string xxx = user + mmyy(m_ngayvv);
            sql = "update " + xxx + ".ba_khamtienme set mabn=:m_mabn,tl_khac=:m_tl_khac,timmach=:m_timmach,hohap=:m_hohap,than=:m_than,k_tieuhoa=:m_k_tieuhoa,";
            sql += "k_khac=:m_k_khac,gu=:m_gu,cungcotsong=:m_cungcotsong,cotsongcu=:m_cotsongcu,canlamsang=:m_canlamsang,";
            sql += "dieutri=:m_dieutri,denghi=:m_denghi,asa=:m_asa,glodmann=:m_glodmann,mallampati=:m_mallampati,";
            sql += "dukien=:m_dukien,thuthuat=:m_thuthuat,ketluan=:m_ketluan,mabs=:m_mabs";
            sql += " where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_tl_khac", NpgsqlDbType.Text).Value = m_tl_khac;
                cmd.Parameters.Add("m_timmach", NpgsqlDbType.Numeric).Value = m_timmach;
                cmd.Parameters.Add("m_hohap", NpgsqlDbType.Numeric).Value = m_hohap;
                cmd.Parameters.Add("m_than", NpgsqlDbType.Numeric).Value = m_than;
                cmd.Parameters.Add("m_k_tieuhoa", NpgsqlDbType.Numeric).Value = m_k_tieuhoa;
                cmd.Parameters.Add("m_k_khac", NpgsqlDbType.Numeric).Value = m_k_khac;
                cmd.Parameters.Add("m_gu", NpgsqlDbType.Numeric).Value = m_gu;
                cmd.Parameters.Add("m_cungcotsong", NpgsqlDbType.Numeric).Value = m_cungcotsong;
                cmd.Parameters.Add("m_cotsongcu", NpgsqlDbType.Numeric).Value = m_cotsongcu;
                cmd.Parameters.Add("m_canlamsang", NpgsqlDbType.Text).Value = m_canlamsang;
                cmd.Parameters.Add("m_dieutri", NpgsqlDbType.Text).Value = m_dieutri;
                cmd.Parameters.Add("m_denghi", NpgsqlDbType.Text).Value = m_denghi;
                cmd.Parameters.Add("m_asa", NpgsqlDbType.Varchar, 3).Value = m_asa;
                cmd.Parameters.Add("m_glodmann", NpgsqlDbType.Varchar, 3).Value = m_glodmann;
                cmd.Parameters.Add("m_mallampati", NpgsqlDbType.Varchar, 3).Value = m_mallampati;
                cmd.Parameters.Add("m_dukien", NpgsqlDbType.Text).Value = m_dukien;
                cmd.Parameters.Add("m_thuthuat", NpgsqlDbType.Text).Value = m_thuthuat;
                cmd.Parameters.Add("m_ketluan", NpgsqlDbType.Text).Value = m_ketluan;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_khamtienme");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_khamtienme4(string m_ngayvv, string m_mabn, decimal m_id,
            string m_tinhmach, int m_tm_bt, int m_tm_cha, int m_tm_dtn, int m_tm_ln, string m_tm_khac, int m_hh_bt,
            int m_hh_copd, int m_hh_suyen, string m_k_hh_khac, int m_nt_bt,
            int m_nt_bg, int m_nt_td, string m_nt_khac,
            int m_tk_bt, int m_tk_yeu, string m_k_tk_khac, int m_cs_bt, string m_cs_khac)
        {
            string xxx = user + mmyy(m_ngayvv);
            sql = "update " + xxx + ".ba_khamtienme set mabn=:m_mabn,";
            sql += "tinhmach=:m_tinhmach,tm_bt=:m_tm_bt,tm_cha=:m_tm_cha,tm_dtn=:m_tm_dtn,tm_ln=:m_tm_ln,tm_khac=:m_tm_khac,";
            sql += "hh_bt=:m_hh_bt,hh_copd=:m_hh_copd,hh_suyen=:m_hh_suyen,k_hh_khac=:m_k_hh_khac,nt_bt=:m_nt_bt,";
            sql += "nt_bg=:m_nt_bg,nt_td=:m_nt_td,nt_khac=:m_nt_khac,tk_bt=:m_tk_bt,tk_yeu=:m_tk_yeu,";
            sql += "k_tk_khac=:m_k_tk_khac,cs_bt=:m_cs_bt,cs_khac=:m_cs_khac ";
            sql += " where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_tinhmach", NpgsqlDbType.Text).Value = m_tinhmach;
                cmd.Parameters.Add("m_tm_bt", NpgsqlDbType.Numeric).Value = m_tm_bt;
                cmd.Parameters.Add("m_tm_cha", NpgsqlDbType.Numeric).Value = m_tm_cha;
                cmd.Parameters.Add("m_tm_dtn", NpgsqlDbType.Numeric).Value = m_tm_dtn;
                cmd.Parameters.Add("m_tm_ln", NpgsqlDbType.Numeric).Value = m_tm_ln;
                cmd.Parameters.Add("m_tm_khac", NpgsqlDbType.Text).Value = m_tm_khac;
                cmd.Parameters.Add("m_hh_bt", NpgsqlDbType.Numeric).Value = m_hh_bt;
                cmd.Parameters.Add("m_hh_copd", NpgsqlDbType.Numeric).Value = m_hh_copd;
                cmd.Parameters.Add("m_hh_suyen", NpgsqlDbType.Numeric).Value = m_hh_suyen;
                cmd.Parameters.Add("m_k_hh_khac", NpgsqlDbType.Text).Value = m_k_hh_khac;
                cmd.Parameters.Add("m_nt_bt", NpgsqlDbType.Numeric).Value = m_nt_bt;
                cmd.Parameters.Add("m_nt_bg", NpgsqlDbType.Numeric).Value = m_nt_bg;
                cmd.Parameters.Add("m_nt_td", NpgsqlDbType.Numeric).Value = m_nt_td;
                cmd.Parameters.Add("m_nt_khac", NpgsqlDbType.Text).Value = m_nt_khac;
                cmd.Parameters.Add("m_tk_bt", NpgsqlDbType.Numeric).Value = m_tk_bt;
                cmd.Parameters.Add("m_tk_yeu", NpgsqlDbType.Numeric).Value = m_tk_yeu;
                cmd.Parameters.Add("m_k_tk_khac", NpgsqlDbType.Text).Value = m_k_tk_khac;
                cmd.Parameters.Add("m_cs_bt", NpgsqlDbType.Numeric).Value = m_cs_bt;
                cmd.Parameters.Add("m_cs_khac", NpgsqlDbType.Text).Value = m_cs_khac;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_khamtienme");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_chamsoc(string m_mabn, decimal m_id, decimal m_idthuchien, decimal m_iddieutri, string m_ngay, decimal m_sophieu, decimal m_mach, string m_huyetap, decimal m_nhietdo, decimal m_nhiptho, string m_dienbien, string m_ylenh, string m_yta, int m_userid)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_chamsoc set mabn=:m_mabn,idthuchien=:m_idthuchien,iddieutri=:m_iddieutri,ngay=to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),";
            sql += "sophieu=:m_sophieu,mach=:m_mach,huyetap=:m_huyetap,nhietdo=:m_nhietdo,nhiptho=:m_nhiptho,dienbien=:m_dienbien,ylenh=:m_ylenh,yta=:m_yta,userid=:m_userid where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                cmd.Parameters.Add("m_iddieutri", NpgsqlDbType.Numeric).Value = m_iddieutri;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                cmd.Parameters.Add("m_sophieu", NpgsqlDbType.Numeric).Value = m_sophieu;
                cmd.Parameters.Add("m_mach", NpgsqlDbType.Numeric).Value = m_mach;
                cmd.Parameters.Add("m_huyetap", NpgsqlDbType.Varchar, 7).Value = m_huyetap;
                cmd.Parameters.Add("m_nhietdo", NpgsqlDbType.Numeric).Value = m_nhietdo;
                cmd.Parameters.Add("m_nhiptho", NpgsqlDbType.Numeric).Value = m_nhiptho;
                cmd.Parameters.Add("m_dienbien", NpgsqlDbType.Text).Value = m_dienbien;
                cmd.Parameters.Add("m_ylenh", NpgsqlDbType.Text).Value = m_ylenh;
                cmd.Parameters.Add("m_yta", NpgsqlDbType.Varchar, 4).Value = m_yta;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_chamsoc (mabn,id,idthuchien,iddieutri,ngay,sophieu,mach,huyetap,nhietdo,nhiptho,dienbien,ylenh,yta,userid) values (:m_mabn,:m_id,:m_idthuchien,:m_iddieutri,to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),:m_sophieu,:m_mach,:m_huyetap,:m_nhietdo,:m_nhiptho,:m_dienbien,:m_ylenh,:m_yta,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                    cmd.Parameters.Add("m_iddieutri", NpgsqlDbType.Numeric).Value = m_iddieutri;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                    cmd.Parameters.Add("m_sophieu", NpgsqlDbType.Numeric).Value = m_sophieu;
                    cmd.Parameters.Add("m_mach", NpgsqlDbType.Numeric).Value = m_mach;
                    cmd.Parameters.Add("m_huyetap", NpgsqlDbType.Varchar, 7).Value = m_huyetap;
                    cmd.Parameters.Add("m_nhietdo", NpgsqlDbType.Numeric).Value = m_nhietdo;
                    cmd.Parameters.Add("m_nhiptho", NpgsqlDbType.Numeric).Value = m_nhiptho;
                    cmd.Parameters.Add("m_dienbien", NpgsqlDbType.Text).Value = m_dienbien;
                    cmd.Parameters.Add("m_ylenh", NpgsqlDbType.Text).Value = m_ylenh;
                    cmd.Parameters.Add("m_yta", NpgsqlDbType.Varchar, 4).Value = m_yta;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_chamsoc");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_chamsocct(string m_ngay, decimal m_id, int m_stt, int m_loai, string m_noidung, string m_ghichu, string m_thuchien)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_chamsocct set loai=:m_loai,noidung=:m_noidung,ghichu=:m_ghichu,thuchien=:m_thuchien";
            sql += " where id=:m_id and stt=:m_stt";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                cmd.Parameters.Add("m_noidung", NpgsqlDbType.Text).Value = m_noidung;
                cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text).Value = m_ghichu;
                cmd.Parameters.Add("m_thuchien", NpgsqlDbType.Text).Value = m_thuchien;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_chamsocct (id,stt,loai,noidung,ghichu,thuchien) values (:m_id,:m_stt,:m_loai,:m_noidung,:m_ghichu,:m_thuchien)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                    cmd.Parameters.Add("m_noidung", NpgsqlDbType.Text).Value = m_noidung;
                    cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text).Value = m_ghichu;
                    cmd.Parameters.Add("m_thuchien", NpgsqlDbType.Text).Value = m_thuchien;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_chamsocct");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_dieutri(string m_mabn, decimal m_id, decimal m_idthuchien, decimal m_sophieu, string m_ngay, string m_dienbien, string m_ylenh, decimal m_idylenh, int m_chedoan, string m_mabs, int m_loai, decimal m_sankhoa, int m_userid)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_dieutri set mabn=:m_mabn,idthuchien=:m_idthuchien,sophieu=:m_sophieu,ngay=to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),";
            sql += "dienbien=:m_dienbien,ylenh=:m_ylenh,idylenh=:m_idylenh,chedoan=:m_chedoan,mabs=:m_mabs,loai=:m_loai,sankhoa=:m_sankhoa,userid=:m_userid where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                cmd.Parameters.Add("m_sophieu", NpgsqlDbType.Numeric).Value = m_sophieu;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                cmd.Parameters.Add("m_dienbien", NpgsqlDbType.Text).Value = m_dienbien;
                cmd.Parameters.Add("m_ylenh", NpgsqlDbType.Text).Value = m_ylenh;
                cmd.Parameters.Add("m_idylenh", NpgsqlDbType.Numeric).Value = m_idylenh;
                cmd.Parameters.Add("m_chedoan", NpgsqlDbType.Numeric).Value = m_chedoan;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                cmd.Parameters.Add("m_sankhoa", NpgsqlDbType.Numeric).Value = m_sankhoa;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_dieutri (mabn,id,idthuchien,sophieu,ngay,dienbien,ylenh,idylenh,chedoan,mabs,loai,sankhoa,userid) values (:m_mabn,:m_id,:m_idthuchien,:m_sophieu,to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),:m_dienbien,:m_ylenh,:m_idylenh,:m_chedoan,:m_mabs,:m_loai,:m_sankhoa,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                    cmd.Parameters.Add("m_sophieu", NpgsqlDbType.Numeric).Value = m_sophieu;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                    cmd.Parameters.Add("m_dienbien", NpgsqlDbType.Text).Value = m_dienbien;
                    cmd.Parameters.Add("m_ylenh", NpgsqlDbType.Text).Value = m_ylenh;
                    cmd.Parameters.Add("m_idylenh", NpgsqlDbType.Numeric).Value = m_idylenh;
                    cmd.Parameters.Add("m_chedoan", NpgsqlDbType.Numeric).Value = m_chedoan;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                    cmd.Parameters.Add("m_sankhoa", NpgsqlDbType.Numeric).Value = m_sankhoa;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_dieutri");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_dieutrict(string m_ngay, decimal m_id, int m_stt, int m_loai, string m_noidung, string m_ghichu)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_dieutrict set loai=:m_loai,noidung=:m_noidung,ghichu=:m_ghichu";
            sql += " where id=:m_id and stt=:m_stt";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                cmd.Parameters.Add("m_noidung", NpgsqlDbType.Text).Value = m_noidung;
                cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text).Value = m_ghichu;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_dieutrict (id,stt,loai,noidung,ghichu) values (:m_id,:m_stt,:m_loai,:m_noidung,:m_ghichu)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                    cmd.Parameters.Add("m_noidung", NpgsqlDbType.Text).Value = m_noidung;
                    cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text).Value = m_ghichu;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_dieutrict");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_dieutrict(string m_ngay, decimal m_id, int m_stt, string m_thuchien)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_dieutrict set thuchien=:m_thuchien";
            sql += " where id=:m_id and stt=:m_stt";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_thuchien", NpgsqlDbType.Text).Value = m_thuchien;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_dieutrict");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_kiemsoatcc(string m_mmyy, string m_mabn, decimal m_id, decimal m_idthuchien, string m_ngay, string m_nhanxet, string m_ddtruong, string m_ddpmo, string m_ddphutrach, int m_userid)
        {
            string xxx = user + m_mmyy;
            sql = "update " + xxx + ".ba_kiemsoatcc set mabn=:m_mabn,idthuchien=:m_idthuchien,ngay=to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),";
            sql += "nhanxet=:m_nhanxet,ddtruong=:m_ddtruong,ddpmo=:m_ddpmo,ddphutrach=:m_ddphutrach,userid=:m_userid where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                cmd.Parameters.Add("m_nhanxet", NpgsqlDbType.Text).Value = m_nhanxet;
                cmd.Parameters.Add("m_ddtruong", NpgsqlDbType.Varchar, 4).Value = m_ddtruong;
                cmd.Parameters.Add("m_ddpmo", NpgsqlDbType.Varchar, 4).Value = m_ddpmo;
                cmd.Parameters.Add("m_ddphutrach", NpgsqlDbType.Varchar, 4).Value = m_ddphutrach;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_kiemsoatcc (mabn,id,idthuchien,ngay,nhanxet,ddtruong,ddpmo,ddphutrach,userid) values (:m_mabn,:m_id,:m_idthuchien,to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),:m_nhanxet,:m_ddtruong,:m_ddpmo,:m_ddphutrach,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                    cmd.Parameters.Add("m_nhanxet", NpgsqlDbType.Text).Value = m_nhanxet;
                    cmd.Parameters.Add("m_ddtruong", NpgsqlDbType.Varchar, 4).Value = m_ddtruong;
                    cmd.Parameters.Add("m_ddpmo", NpgsqlDbType.Varchar, 4).Value = m_ddpmo;
                    cmd.Parameters.Add("m_ddphutrach", NpgsqlDbType.Varchar, 4).Value = m_ddphutrach;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_kiemsoatcc");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_kiemsoatccct(string m_ngay, decimal m_id, int m_ma, int m_cokhong, string m_ghichu)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_kiemsoatccct set cokhong=:m_cokhong,ghichu=:m_ghichu where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_cokhong", NpgsqlDbType.Numeric).Value = m_cokhong;
                cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text).Value = m_ghichu;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_kiemsoatccct (id,ma,cokhong,ghichu) values (:m_id,:m_ma,:m_cokhong,:m_ghichu)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_cokhong", NpgsqlDbType.Numeric).Value = m_cokhong;
                    cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text).Value = m_ghichu;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_kiemsoatccct");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }


        public bool upd_ba_kiemsoat(string m_mmyy, string m_mabn, decimal m_id, decimal m_idthuchien, string m_ngay, string m_thuoc,
            int m_tiembap, int m_tiemtm, decimal m_mach, decimal m_nhietdo, string m_huyetap, decimal m_nhiptho,
            string m_trigiac, string m_nhanxet, string m_ddtruong, string m_ddpmo, string m_ddphutrach, int m_userid)
        {
            string xxx = user + m_mmyy;
            sql = "update " + xxx + ".ba_kiemsoat set mabn=:m_mabn,idthuchien=:m_idthuchien,ngay=to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),";
            sql += "thuoc=:m_thuoc,tiembap=:m_tiembap,tiemtm=:m_tiemtm,mach=:m_mach,nhietdo=:m_nhietdo,huyetap=:m_huyetap,";
            sql += "nhiptho=:m_nhiptho,trigiac=:m_trigiac,nhanxet=:m_nhanxet,ddtruong=:m_ddtruong,ddpmo=:m_ddpmo,";
            sql += "ddphutrach=:m_ddphutrach,userid=:m_userid where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                cmd.Parameters.Add("m_thuoc", NpgsqlDbType.Text).Value = m_thuoc;
                cmd.Parameters.Add("m_tiembap", NpgsqlDbType.Numeric).Value = m_tiembap;
                cmd.Parameters.Add("m_tiemtm", NpgsqlDbType.Numeric).Value = m_tiemtm;
                cmd.Parameters.Add("m_mach", NpgsqlDbType.Numeric).Value = m_mach;
                cmd.Parameters.Add("m_nhietdo", NpgsqlDbType.Numeric).Value = m_nhietdo;
                cmd.Parameters.Add("m_huyetap", NpgsqlDbType.Varchar, 7).Value = m_huyetap;
                cmd.Parameters.Add("m_nhiptho", NpgsqlDbType.Numeric).Value = m_nhiptho;
                cmd.Parameters.Add("m_trigiac", NpgsqlDbType.Text).Value = m_trigiac;
                cmd.Parameters.Add("m_nhanxet", NpgsqlDbType.Text).Value = m_nhanxet;
                cmd.Parameters.Add("m_ddtruong", NpgsqlDbType.Varchar, 4).Value = m_ddtruong;
                cmd.Parameters.Add("m_ddpmo", NpgsqlDbType.Varchar, 4).Value = m_ddpmo;
                cmd.Parameters.Add("m_ddphutrach", NpgsqlDbType.Varchar, 4).Value = m_ddphutrach;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_kiemsoat (mabn,id,idthuchien,ngay,thuoc,tiembap,tiemtm,mach,nhietdo,huyetap,nhiptho,trigiac,nhanxet,ddtruong,ddpmo,ddphutrach,userid) values (:m_mabn,:m_id,:m_idthuchien,to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),:m_thuoc,:m_tiembap,:m_tiemtm,:m_mach,:m_nhietdo,:m_huyetap,:m_nhiptho,:m_trigiac,:m_nhanxet,:m_ddtruong,:m_ddpmo,:m_ddphutrach,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                    cmd.Parameters.Add("m_thuoc", NpgsqlDbType.Text).Value = m_thuoc;
                    cmd.Parameters.Add("m_tiembap", NpgsqlDbType.Numeric).Value = m_tiembap;
                    cmd.Parameters.Add("m_tiemtm", NpgsqlDbType.Numeric).Value = m_tiemtm;
                    cmd.Parameters.Add("m_mach", NpgsqlDbType.Numeric).Value = m_mach;
                    cmd.Parameters.Add("m_nhietdo", NpgsqlDbType.Numeric).Value = m_nhietdo;
                    cmd.Parameters.Add("m_huyetap", NpgsqlDbType.Varchar, 7).Value = m_huyetap;
                    cmd.Parameters.Add("m_nhiptho", NpgsqlDbType.Numeric).Value = m_nhiptho;
                    cmd.Parameters.Add("m_trigiac", NpgsqlDbType.Text).Value = m_trigiac;
                    cmd.Parameters.Add("m_nhanxet", NpgsqlDbType.Text).Value = m_nhanxet;
                    cmd.Parameters.Add("m_ddtruong", NpgsqlDbType.Varchar, 4).Value = m_ddtruong;
                    cmd.Parameters.Add("m_ddpmo", NpgsqlDbType.Varchar, 4).Value = m_ddpmo;
                    cmd.Parameters.Add("m_ddphutrach", NpgsqlDbType.Varchar, 4).Value = m_ddphutrach;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_kiemsoat");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_kiemsoatct(string m_ngay, decimal m_id, int m_ma, int m_cokhong, string m_ghichu)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_kiemsoatct set cokhong=:m_cokhong,ghichu=:m_ghichu where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_cokhong", NpgsqlDbType.Numeric).Value = m_cokhong;
                cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text).Value = m_ghichu;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_kiemsoatct (id,ma,cokhong,ghichu) values (:m_id,:m_ma,:m_cokhong,:m_ghichu)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_cokhong", NpgsqlDbType.Numeric).Value = m_cokhong;
                    cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text).Value = m_ghichu;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_kiemsoatct");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_puthuoc(decimal m_id, decimal m_idthuchien, string m_ngay, string m_ten,
            string m_phuongphap, string m_bscd, string m_nguoithu, string m_bsdoc, string m_ketqua, int m_userid)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_puthuoc set idthuchien=:m_idthuchien,ngay=to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),";
            sql += "ten=:m_ten,phuongphap=:m_phuongphap,bscd=:m_bscd,nguoithu=:m_nguoithu,bsdoc=:m_bsdoc,";
            sql += "ketqua=:m_ketqua,userid=:m_userid where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_phuongphap", NpgsqlDbType.Text).Value = m_phuongphap;
                cmd.Parameters.Add("m_bscd", NpgsqlDbType.Varchar, 4).Value = m_bscd;
                cmd.Parameters.Add("m_nguoithu", NpgsqlDbType.Varchar, 4).Value = m_nguoithu;
                cmd.Parameters.Add("m_bsdoc", NpgsqlDbType.Varchar, 4).Value = m_bsdoc;
                cmd.Parameters.Add("m_ketqua", NpgsqlDbType.Text).Value = m_ketqua;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_puthuoc (id,idthuchien,ngay,ten,phuongphap,bscd,nguoithu,bsdoc,ketqua,userid) values (:m_id,:m_idthuchien,to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),:m_ten,:m_phuongphap,:m_bscd,:m_nguoithu,:m_bsdoc,:m_ketqua,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    cmd.Parameters.Add("m_phuongphap", NpgsqlDbType.Text).Value = m_phuongphap;
                    cmd.Parameters.Add("m_bscd", NpgsqlDbType.Varchar, 4).Value = m_bscd;
                    cmd.Parameters.Add("m_nguoithu", NpgsqlDbType.Varchar, 4).Value = m_nguoithu;
                    cmd.Parameters.Add("m_bsdoc", NpgsqlDbType.Varchar, 4).Value = m_bsdoc;
                    cmd.Parameters.Add("m_ketqua", NpgsqlDbType.Text).Value = m_ketqua;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_puthuoc");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_camdoan(string m_mabn, decimal m_id, decimal m_idthuchien, string m_ngay, string m_hoten, int m_tuoi, string m_phai,
            string m_dantoc, string m_nghenghiep, string m_ngoaikieu, string m_diachi, string m_noilam,
            string m_nguoinha, int m_dongy, string m_ghichu, int m_userid)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_camdoan set mabn=:m_mabn,idthuchien=:m_idthuchien,ngay=to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),";
            sql += "hoten=:m_hoten,tuoi=:m_tuoi,phai=:m_phai,dantoc=:m_dantoc,nghenghiep=:m_nghenghiep,";
            sql += "ngoaikieu=:m_ngoaikieu,diachi=:m_diachi,noilam=:m_noilam,";
            sql += "nguoinha=:m_nguoinha,dongy=:m_dongy,ghichu=:m_ghichu,userid=:m_userid where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                cmd.Parameters.Add("m_hoten", NpgsqlDbType.Text).Value = m_hoten;
                cmd.Parameters.Add("m_tuoi", NpgsqlDbType.Numeric).Value = m_tuoi;
                cmd.Parameters.Add("m_phai", NpgsqlDbType.Text).Value = m_phai;
                cmd.Parameters.Add("m_dantoc", NpgsqlDbType.Text).Value = m_dantoc;
                cmd.Parameters.Add("m_nghenghiep", NpgsqlDbType.Text).Value = m_nghenghiep;
                cmd.Parameters.Add("m_ngoaikieu", NpgsqlDbType.Text).Value = m_ngoaikieu;
                cmd.Parameters.Add("m_diachi", NpgsqlDbType.Text).Value = m_diachi;
                cmd.Parameters.Add("m_noilam", NpgsqlDbType.Text).Value = m_noilam;
                cmd.Parameters.Add("m_nguoinha", NpgsqlDbType.Text).Value = m_nguoinha;
                cmd.Parameters.Add("m_dongy", NpgsqlDbType.Numeric).Value = m_dongy;
                cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text).Value = m_ghichu;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_camdoan (mabn,id,idthuchien,ngay,hoten,tuoi,phai,dantoc,nghenghiep,ngoaikieu,diachi,noilam,nguoinha,dongy,ghichu,userid) values (:m_mabn,:m_id,:m_idthuchien,to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),:m_hoten,:m_tuoi,:m_phai,:m_dantoc,:m_nghenghiep,:m_ngoaikieu,:m_diachi,:m_noilam,:m_nguoinha,:m_dongy,:m_ghichu,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                    cmd.Parameters.Add("m_hoten", NpgsqlDbType.Text).Value = m_hoten;
                    cmd.Parameters.Add("m_tuoi", NpgsqlDbType.Numeric).Value = m_tuoi;
                    cmd.Parameters.Add("m_phai", NpgsqlDbType.Text).Value = m_phai;
                    cmd.Parameters.Add("m_dantoc", NpgsqlDbType.Text).Value = m_dantoc;
                    cmd.Parameters.Add("m_nghenghiep", NpgsqlDbType.Text).Value = m_nghenghiep;
                    cmd.Parameters.Add("m_ngoaikieu", NpgsqlDbType.Text).Value = m_ngoaikieu;
                    cmd.Parameters.Add("m_diachi", NpgsqlDbType.Text).Value = m_diachi;
                    cmd.Parameters.Add("m_noilam", NpgsqlDbType.Text).Value = m_noilam;
                    cmd.Parameters.Add("m_nguoinha", NpgsqlDbType.Text).Value = m_nguoinha;
                    cmd.Parameters.Add("m_dongy", NpgsqlDbType.Numeric).Value = m_dongy;
                    cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text).Value = m_ghichu;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_camdoan");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_camdoan(decimal m_id, string m_ngay, byte[] m_image)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_camdoan set image=:m_image where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("m_image", NpgsqlDbType.Bytea, m_image.Length).Value = m_image;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_camdoan");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }



        public bool upd_ba_hoichanthuoc(string m_mabn, decimal m_id, decimal m_idthuchien, string m_ngay, string m_tu, string m_den, string m_mabs,
            string m_thuky, string m_thanhvien, int m_tinhtrang, string m_gan, string m_sgot, string m_sgpt, string m_ure,
            string m_creatimin, string m_ion, string m_ctm, string m_tptnt, string m_xq, string m_vikhuan, string m_ksd,
            string m_thuoc, string m_thaythe, string m_lydo, int m_userid)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_hoichanthuoc set mabn=:m_mabn,idthuchien=:m_idthuchien,ngay=to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),";
            sql += "tu=to_date(:m_tu,'dd/mm/yyyy'),den=to_date(:m_den,'dd/mm/yyyy'),mabs=:m_mabs,thuky=:m_thuky,";
            sql += "thanhvien=:m_thanhvien,tinhtrang=:m_tinhtrang,gan=:m_gan,sgot=:m_sgot,sgpt=:m_sgpt,ure=:m_ure,";
            sql += "creatimin=:m_creatimin,ion=:m_ion,ctm=:m_ctm,tptnt=:m_tptnt,xq=:m_xq,vikhuan=:m_vikhuan,ksd=:m_ksd,";
            sql += "thuoc=:m_thuoc,thaythe=:m_thaythe,lydo=:m_lydo,";
            sql += "userid=:m_userid where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Numeric).Value = m_mabn;
                cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                cmd.Parameters.Add("m_tu", NpgsqlDbType.Varchar, 10).Value = m_tu;
                cmd.Parameters.Add("m_den", NpgsqlDbType.Varchar, 10).Value = m_den;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_thuky", NpgsqlDbType.Varchar, 4).Value = m_thuky;
                cmd.Parameters.Add("m_thanhvien", NpgsqlDbType.Text).Value = m_thanhvien;
                cmd.Parameters.Add("m_tinhtrang", NpgsqlDbType.Numeric).Value = m_tinhtrang;
                cmd.Parameters.Add("m_gan", NpgsqlDbType.Text).Value = m_gan;
                cmd.Parameters.Add("m_sgot", NpgsqlDbType.Text).Value = m_sgot;
                cmd.Parameters.Add("m_sgpt", NpgsqlDbType.Text).Value = m_sgpt;
                cmd.Parameters.Add("m_ure", NpgsqlDbType.Text).Value = m_ure;
                cmd.Parameters.Add("m_creatimin", NpgsqlDbType.Text).Value = m_creatimin;
                cmd.Parameters.Add("m_ion", NpgsqlDbType.Text).Value = m_ion;
                cmd.Parameters.Add("m_ctm", NpgsqlDbType.Text).Value = m_ctm;
                cmd.Parameters.Add("m_tptnt", NpgsqlDbType.Text).Value = m_tptnt;
                cmd.Parameters.Add("m_xq", NpgsqlDbType.Text).Value = m_xq;
                cmd.Parameters.Add("m_vikhuan", NpgsqlDbType.Text).Value = m_vikhuan;
                cmd.Parameters.Add("m_ksd", NpgsqlDbType.Text).Value = m_ksd;
                cmd.Parameters.Add("m_thuoc", NpgsqlDbType.Text).Value = m_thuoc;
                cmd.Parameters.Add("m_thaythe", NpgsqlDbType.Text).Value = m_thaythe;
                cmd.Parameters.Add("m_lydo", NpgsqlDbType.Text).Value = m_lydo;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_hoichanthuoc (mabn,id,idthuchien,ngay,tu,den,mabs,thuky,thanhvien,tinhtrang,gan,sgot,sgpt,ure,creatimin,ion,ctm,tptnt,xq,vikhuan,ksd,thuoc,thaythe,lydo,userid) values (:m_mabn,:m_id,:m_idthuchien,to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),to_date(:m_tu,'dd/mm/yyyy'),to_date(:m_den,'dd/mm/yyyy'),:m_mabs,:m_thuky,:m_thanhvien,:m_tinhtrang,:m_gan,:m_sgot,:m_sgpt,:m_ure,:m_creatimin,:m_ion,:m_ctm,:m_tptnt,:m_xq,:m_vikhuan,:m_ksd,:m_thuoc,:m_thaythe,:m_lydo,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Numeric).Value = m_mabn;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                    cmd.Parameters.Add("m_tu", NpgsqlDbType.Varchar, 10).Value = m_tu;
                    cmd.Parameters.Add("m_den", NpgsqlDbType.Varchar, 10).Value = m_den;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    cmd.Parameters.Add("m_thuky", NpgsqlDbType.Varchar, 4).Value = m_thuky;
                    cmd.Parameters.Add("m_thanhvien", NpgsqlDbType.Text).Value = m_thanhvien;
                    cmd.Parameters.Add("m_tinhtrang", NpgsqlDbType.Numeric).Value = m_tinhtrang;
                    cmd.Parameters.Add("m_gan", NpgsqlDbType.Text).Value = m_gan;
                    cmd.Parameters.Add("m_sgot", NpgsqlDbType.Text).Value = m_sgot;
                    cmd.Parameters.Add("m_sgpt", NpgsqlDbType.Text).Value = m_sgpt;
                    cmd.Parameters.Add("m_ure", NpgsqlDbType.Text).Value = m_ure;
                    cmd.Parameters.Add("m_creatimin", NpgsqlDbType.Text).Value = m_creatimin;
                    cmd.Parameters.Add("m_ion", NpgsqlDbType.Text).Value = m_ion;
                    cmd.Parameters.Add("m_ctm", NpgsqlDbType.Text).Value = m_ctm;
                    cmd.Parameters.Add("m_tptnt", NpgsqlDbType.Text).Value = m_tptnt;
                    cmd.Parameters.Add("m_xq", NpgsqlDbType.Text).Value = m_xq;
                    cmd.Parameters.Add("m_vikhuan", NpgsqlDbType.Text).Value = m_vikhuan;
                    cmd.Parameters.Add("m_ksd", NpgsqlDbType.Text).Value = m_ksd;
                    cmd.Parameters.Add("m_thuoc", NpgsqlDbType.Text).Value = m_thuoc;
                    cmd.Parameters.Add("m_thaythe", NpgsqlDbType.Text).Value = m_thaythe;
                    cmd.Parameters.Add("m_lydo", NpgsqlDbType.Text).Value = m_lydo;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_hoichanthuoc");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }


        public bool upd_ba_danhgia1(string m_mabn, decimal m_id, decimal m_idthuchien, string m_ngay, string m_thuoc, int m_thuoc_k, decimal m_cannang,
            int m_chieucao, int m_mach, decimal m_nhietdo, string m_huyetap, int m_nhiptho, string m_diung, int m_diung_k,
            string m_tm, int m_tm_k, int m_tm_1, int m_tm_2, int m_tm_3, int m_tm_4, int m_tm_5, int m_tm_6, int m_tm_7,
            string m_hh, int m_hh_k, int m_hh_1, int m_hh_2, int m_hh_3, int m_hh_4, int m_hh_5, int m_hh_6, int m_hh_7,
            string m_than, int m_than_k, int m_than_1, int m_than_2, int m_than_3, int m_than_4)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_danhgia1 set mabn=:m_mabn,idthuchien=:m_idthuchien,ngay=to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),";
            sql += "thuoc=:m_thuoc,thuoc_k=:m_thuoc_k,cannang=:m_cannang,chieucao=:m_chieucao,mach=:m_mach,nhietdo=:m_nhietdo,";
            sql += "huyetap=:m_huyetap,nhiptho=:m_nhiptho,diung=:m_diung,diung_k=:m_diung_k,tm=:m_tm,tm_k=:m_tm_k,";
            sql += "tm_1=:m_tm_1,tm_2=:m_tm_2,tm_3=:m_tm_3,tm_4=:m_tm_4,tm_5=:m_tm_5,tm_6=:m_tm_6,tm_7=:m_tm_7,";
            sql += "hh=:m_hh,hh_k=:m_hh_k,hh_1=:m_hh_1,hh_2=:m_hh_2,hh_3=:m_hh_3,hh_4=:m_hh_4,hh_5=:m_hh_5,hh_6=:m_hh_6,";
            sql += "hh_7=:m_hh_7,than=:m_than,than_k=:m_than_k,than_1=:m_than_1,than_2=:m_than_2,than_3=:m_than_3,";
            sql += "than_4=:m_than_4";
            sql += " where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                cmd.Parameters.Add("m_thuoc", NpgsqlDbType.Text).Value = m_thuoc;
                cmd.Parameters.Add("m_thuoc_k", NpgsqlDbType.Numeric).Value = m_thuoc_k;
                cmd.Parameters.Add("m_cannang", NpgsqlDbType.Numeric).Value = m_cannang;
                cmd.Parameters.Add("m_chieucao", NpgsqlDbType.Numeric).Value = m_chieucao;
                cmd.Parameters.Add("m_mach", NpgsqlDbType.Numeric).Value = m_mach;
                cmd.Parameters.Add("m_nhietdo", NpgsqlDbType.Numeric).Value = m_nhietdo;
                cmd.Parameters.Add("m_huyetap", NpgsqlDbType.Varchar, 7).Value = m_huyetap;
                cmd.Parameters.Add("m_nhiptho", NpgsqlDbType.Numeric).Value = m_nhiptho;
                cmd.Parameters.Add("m_diung", NpgsqlDbType.Text).Value = m_diung;
                cmd.Parameters.Add("m_diung_k", NpgsqlDbType.Numeric).Value = m_diung_k;
                cmd.Parameters.Add("m_tm", NpgsqlDbType.Text).Value = m_tm;
                cmd.Parameters.Add("m_tm_k", NpgsqlDbType.Numeric).Value = m_tm_k;
                cmd.Parameters.Add("m_tm_1", NpgsqlDbType.Numeric).Value = m_tm_1;
                cmd.Parameters.Add("m_tm_2", NpgsqlDbType.Numeric).Value = m_tm_2;
                cmd.Parameters.Add("m_tm_3", NpgsqlDbType.Numeric).Value = m_tm_3;
                cmd.Parameters.Add("m_tm_4", NpgsqlDbType.Numeric).Value = m_tm_4;
                cmd.Parameters.Add("m_tm_5", NpgsqlDbType.Numeric).Value = m_tm_5;
                cmd.Parameters.Add("m_tm_6", NpgsqlDbType.Numeric).Value = m_tm_6;
                cmd.Parameters.Add("m_tm_7", NpgsqlDbType.Numeric).Value = m_tm_7;
                cmd.Parameters.Add("m_hh", NpgsqlDbType.Text).Value = m_hh;
                cmd.Parameters.Add("m_hh_k", NpgsqlDbType.Numeric).Value = m_hh_k;
                cmd.Parameters.Add("m_hh_1", NpgsqlDbType.Numeric).Value = m_hh_1;
                cmd.Parameters.Add("m_hh_2", NpgsqlDbType.Numeric).Value = m_hh_2;
                cmd.Parameters.Add("m_hh_3", NpgsqlDbType.Numeric).Value = m_hh_3;
                cmd.Parameters.Add("m_hh_4", NpgsqlDbType.Numeric).Value = m_hh_4;
                cmd.Parameters.Add("m_hh_5", NpgsqlDbType.Numeric).Value = m_hh_5;
                cmd.Parameters.Add("m_hh_6", NpgsqlDbType.Numeric).Value = m_hh_6;
                cmd.Parameters.Add("m_hh_7", NpgsqlDbType.Numeric).Value = m_hh_7;
                cmd.Parameters.Add("m_than", NpgsqlDbType.Text).Value = m_than;
                cmd.Parameters.Add("m_than_k", NpgsqlDbType.Numeric).Value = m_than_k;
                cmd.Parameters.Add("m_than_1", NpgsqlDbType.Numeric).Value = m_than_1;
                cmd.Parameters.Add("m_than_2", NpgsqlDbType.Numeric).Value = m_than_2;
                cmd.Parameters.Add("m_than_3", NpgsqlDbType.Numeric).Value = m_than_3;
                cmd.Parameters.Add("m_than_4", NpgsqlDbType.Numeric).Value = m_than_4;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_danhgia1 (mabn,id,idthuchien,ngay,thuoc,thuoc_k,cannang,chieucao,mach,nhietdo,huyetap,nhiptho,diung,diung_k,tm,tm_k,tm_1,tm_2,tm_3,tm_4,tm_5,tm_6,tm_7,hh,hh_k,hh_1,hh_2,hh_3,hh_4,hh_5,hh_6,hh_7,than,than_k,than_1,than_2,than_3,than_4) values (:m_mabn,:m_id,:m_idthuchien,to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),:m_thuoc,:m_thuoc_k,:m_cannang,:m_chieucao,:m_mach,:m_nhietdo,:m_huyetap,:m_nhiptho,:m_diung,:m_diung_k,:m_tm,:m_tm_k,:m_tm_1,:m_tm_2,:m_tm_3,:m_tm_4,:m_tm_5,:m_tm_6,:m_tm_7,:m_hh,:m_hh_k,:m_hh_1,:m_hh_2,:m_hh_3,:m_hh_4,:m_hh_5,:m_hh_6,:m_hh_7,:m_than,:m_than_k,:m_than_1,:m_than_2,:m_than_3,:m_than_4)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                    cmd.Parameters.Add("m_thuoc", NpgsqlDbType.Text).Value = m_thuoc;
                    cmd.Parameters.Add("m_thuoc_k", NpgsqlDbType.Numeric).Value = m_thuoc_k;
                    cmd.Parameters.Add("m_cannang", NpgsqlDbType.Numeric).Value = m_cannang;
                    cmd.Parameters.Add("m_chieucao", NpgsqlDbType.Numeric).Value = m_chieucao;
                    cmd.Parameters.Add("m_mach", NpgsqlDbType.Numeric).Value = m_mach;
                    cmd.Parameters.Add("m_nhietdo", NpgsqlDbType.Numeric).Value = m_nhietdo;
                    cmd.Parameters.Add("m_huyetap", NpgsqlDbType.Varchar, 7).Value = m_huyetap;
                    cmd.Parameters.Add("m_nhiptho", NpgsqlDbType.Numeric).Value = m_nhiptho;
                    cmd.Parameters.Add("m_diung", NpgsqlDbType.Text).Value = m_diung;
                    cmd.Parameters.Add("m_diung_k", NpgsqlDbType.Numeric).Value = m_diung_k;
                    cmd.Parameters.Add("m_tm", NpgsqlDbType.Text).Value = m_tm;
                    cmd.Parameters.Add("m_tm_k", NpgsqlDbType.Numeric).Value = m_tm_k;
                    cmd.Parameters.Add("m_tm_1", NpgsqlDbType.Numeric).Value = m_tm_1;
                    cmd.Parameters.Add("m_tm_2", NpgsqlDbType.Numeric).Value = m_tm_2;
                    cmd.Parameters.Add("m_tm_3", NpgsqlDbType.Numeric).Value = m_tm_3;
                    cmd.Parameters.Add("m_tm_4", NpgsqlDbType.Numeric).Value = m_tm_4;
                    cmd.Parameters.Add("m_tm_5", NpgsqlDbType.Numeric).Value = m_tm_5;
                    cmd.Parameters.Add("m_tm_6", NpgsqlDbType.Numeric).Value = m_tm_6;
                    cmd.Parameters.Add("m_tm_7", NpgsqlDbType.Numeric).Value = m_tm_7;
                    cmd.Parameters.Add("m_hh", NpgsqlDbType.Text).Value = m_hh;
                    cmd.Parameters.Add("m_hh_k", NpgsqlDbType.Numeric).Value = m_hh_k;
                    cmd.Parameters.Add("m_hh_1", NpgsqlDbType.Numeric).Value = m_hh_1;
                    cmd.Parameters.Add("m_hh_2", NpgsqlDbType.Numeric).Value = m_hh_2;
                    cmd.Parameters.Add("m_hh_3", NpgsqlDbType.Numeric).Value = m_hh_3;
                    cmd.Parameters.Add("m_hh_4", NpgsqlDbType.Numeric).Value = m_hh_4;
                    cmd.Parameters.Add("m_hh_5", NpgsqlDbType.Numeric).Value = m_hh_5;
                    cmd.Parameters.Add("m_hh_6", NpgsqlDbType.Numeric).Value = m_hh_6;
                    cmd.Parameters.Add("m_hh_7", NpgsqlDbType.Numeric).Value = m_hh_7;
                    cmd.Parameters.Add("m_than", NpgsqlDbType.Text).Value = m_than;
                    cmd.Parameters.Add("m_than_k", NpgsqlDbType.Numeric).Value = m_than_k;
                    cmd.Parameters.Add("m_than_1", NpgsqlDbType.Numeric).Value = m_than_1;
                    cmd.Parameters.Add("m_than_2", NpgsqlDbType.Numeric).Value = m_than_2;
                    cmd.Parameters.Add("m_than_3", NpgsqlDbType.Numeric).Value = m_than_3;
                    cmd.Parameters.Add("m_than_4", NpgsqlDbType.Numeric).Value = m_than_4;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_danhgia1");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_danhgia2(string m_mabn, decimal m_id2, string m_ngay, string m_noitiet, int m_noitiet_k, int m_noitiet_1, int m_noitiet_2,
            int m_noitiet_3, int m_noitiet_4, int m_noitiet_5, int m_noitiet_6, string m_tieuhoa, int m_tieuhoa_k, int m_tieuhoa_1,
            int m_tieuhoa_2, int m_tieuhoa_3, int m_tieuhoa_4, int m_tieuhoa_5, int m_tieuhoa_6, int m_tieuhoa_7,
            string m_thankinh, int m_thankinh_k, int m_thankinh_1, int m_thankinh_2, int m_thankinh_3, int m_thankinh_4,
            string m_huyethoc, int m_huyethoc_k, int m_huyethoc_1, int m_huyethoc_2, int m_huyethoc_3)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_danhgia2 set mabn=:m_mabn,";
            sql += "noitiet=:m_noitiet,noitiet_k=:m_noitiet_k,noitiet_1=:m_noitiet_1,noitiet_2=:m_noitiet_2,";
            sql += "noitiet_3=:m_noitiet_3,noitiet_4=:m_noitiet_4,noitiet_5=:m_noitiet_5,noitiet_6=:m_noitiet_6,";
            sql += "tieuhoa=:m_tieuhoa,tieuhoa_k=:m_tieuhoa_k,tieuhoa_1=:m_tieuhoa_1,tieuhoa_2=:m_tieuhoa_2,";
            sql += "tieuhoa_3=:m_tieuhoa_3,tieuhoa_4=:m_tieuhoa_4,tieuhoa_5=:m_tieuhoa_5,tieuhoa_6=:m_tieuhoa_6,";
            sql += "tieuhoa_7=:m_tieuhoa_7,thankinh=:m_thankinh,thankinh_k=:m_thankinh_k,thankinh_1=:m_thankinh_1,";
            sql += "thankinh_2=:m_thankinh_2,thankinh_3=:m_thankinh_3,thankinh_4=:m_thankinh_4,huyethoc=:m_huyethoc,";
            sql += "huyethoc_k=:m_huyethoc_k,huyethoc_1=:m_huyethoc_1,huyethoc_2=:m_huyethoc_2,huyethoc_3=:m_huyethoc_3";
            sql += " where id2=:m_id2";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_noitiet", NpgsqlDbType.Text).Value = m_noitiet;
                cmd.Parameters.Add("m_noitiet_k", NpgsqlDbType.Numeric).Value = m_noitiet_k;
                cmd.Parameters.Add("m_noitiet_1", NpgsqlDbType.Numeric).Value = m_noitiet_1;
                cmd.Parameters.Add("m_noitiet_2", NpgsqlDbType.Numeric).Value = m_noitiet_2;
                cmd.Parameters.Add("m_noitiet_3", NpgsqlDbType.Numeric).Value = m_noitiet_3;
                cmd.Parameters.Add("m_noitiet_4", NpgsqlDbType.Numeric).Value = m_noitiet_4;
                cmd.Parameters.Add("m_noitiet_5", NpgsqlDbType.Numeric).Value = m_noitiet_5;
                cmd.Parameters.Add("m_noitiet_6", NpgsqlDbType.Numeric).Value = m_noitiet_6;
                cmd.Parameters.Add("m_tieuhoa", NpgsqlDbType.Text).Value = m_tieuhoa;
                cmd.Parameters.Add("m_tieuhoa_k", NpgsqlDbType.Numeric).Value = m_tieuhoa_k;
                cmd.Parameters.Add("m_tieuhoa_1", NpgsqlDbType.Numeric).Value = m_tieuhoa_1;
                cmd.Parameters.Add("m_tieuhoa_2", NpgsqlDbType.Numeric).Value = m_tieuhoa_2;
                cmd.Parameters.Add("m_tieuhoa_3", NpgsqlDbType.Numeric).Value = m_tieuhoa_3;
                cmd.Parameters.Add("m_tieuhoa_4", NpgsqlDbType.Numeric).Value = m_tieuhoa_4;
                cmd.Parameters.Add("m_tieuhoa_5", NpgsqlDbType.Numeric).Value = m_tieuhoa_5;
                cmd.Parameters.Add("m_tieuhoa_6", NpgsqlDbType.Numeric).Value = m_tieuhoa_6;
                cmd.Parameters.Add("m_tieuhoa_7", NpgsqlDbType.Numeric).Value = m_tieuhoa_7;
                cmd.Parameters.Add("m_thankinh", NpgsqlDbType.Text).Value = m_thankinh;
                cmd.Parameters.Add("m_thankinh_k", NpgsqlDbType.Numeric).Value = m_thankinh_k;
                cmd.Parameters.Add("m_thankinh_1", NpgsqlDbType.Numeric).Value = m_thankinh_1;
                cmd.Parameters.Add("m_thankinh_2", NpgsqlDbType.Numeric).Value = m_thankinh_2;
                cmd.Parameters.Add("m_thankinh_3", NpgsqlDbType.Numeric).Value = m_thankinh_3;
                cmd.Parameters.Add("m_thankinh_4", NpgsqlDbType.Numeric).Value = m_thankinh_4;
                cmd.Parameters.Add("m_huyethoc", NpgsqlDbType.Text).Value = m_huyethoc;
                cmd.Parameters.Add("m_huyethoc_k", NpgsqlDbType.Numeric).Value = m_huyethoc_k;
                cmd.Parameters.Add("m_huyethoc_1", NpgsqlDbType.Numeric).Value = m_huyethoc_1;
                cmd.Parameters.Add("m_huyethoc_2", NpgsqlDbType.Numeric).Value = m_huyethoc_2;
                cmd.Parameters.Add("m_huyethoc_3", NpgsqlDbType.Numeric).Value = m_huyethoc_3;
                cmd.Parameters.Add("m_id2", NpgsqlDbType.Numeric).Value = m_id2;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_danhgia2 (mabn,id2,noitiet,noitiet_k,noitiet_1,noitiet_2,noitiet_3,noitiet_4,noitiet_5,noitiet_6,tieuhoa,tieuhoa_k,tieuhoa_1,tieuhoa_2,tieuhoa_3,tieuhoa_4,tieuhoa_5,tieuhoa_6,tieuhoa_7,thankinh,thankinh_k,thankinh_1,thankinh_2,thankinh_3,thankinh_4,huyethoc,huyethoc_k,huyethoc_1,huyethoc_2,huyethoc_3) values (:m_mabn,:m_id2,:m_noitiet,:m_noitiet_k,:m_noitiet_1,:m_noitiet_2,:m_noitiet_3,:m_noitiet_4,:m_noitiet_5,:m_noitiet_6,:m_tieuhoa,:m_tieuhoa_k,:m_tieuhoa_1,:m_tieuhoa_2,:m_tieuhoa_3,:m_tieuhoa_4,:m_tieuhoa_5,:m_tieuhoa_6,:m_tieuhoa_7,:m_thankinh,:m_thankinh_k,:m_thankinh_1,:m_thankinh_2,:m_thankinh_3,:m_thankinh_4,:m_huyethoc,:m_huyethoc_k,:m_huyethoc_1,:m_huyethoc_2,:m_huyethoc_3)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_id2", NpgsqlDbType.Numeric).Value = m_id2;
                    cmd.Parameters.Add("m_noitiet", NpgsqlDbType.Text).Value = m_noitiet;
                    cmd.Parameters.Add("m_noitiet_k", NpgsqlDbType.Numeric).Value = m_noitiet_k;
                    cmd.Parameters.Add("m_noitiet_1", NpgsqlDbType.Numeric).Value = m_noitiet_1;
                    cmd.Parameters.Add("m_noitiet_2", NpgsqlDbType.Numeric).Value = m_noitiet_2;
                    cmd.Parameters.Add("m_noitiet_3", NpgsqlDbType.Numeric).Value = m_noitiet_3;
                    cmd.Parameters.Add("m_noitiet_4", NpgsqlDbType.Numeric).Value = m_noitiet_4;
                    cmd.Parameters.Add("m_noitiet_5", NpgsqlDbType.Numeric).Value = m_noitiet_5;
                    cmd.Parameters.Add("m_noitiet_6", NpgsqlDbType.Numeric).Value = m_noitiet_6;
                    cmd.Parameters.Add("m_tieuhoa", NpgsqlDbType.Text).Value = m_tieuhoa;
                    cmd.Parameters.Add("m_tieuhoa_k", NpgsqlDbType.Numeric).Value = m_tieuhoa_k;
                    cmd.Parameters.Add("m_tieuhoa_1", NpgsqlDbType.Numeric).Value = m_tieuhoa_1;
                    cmd.Parameters.Add("m_tieuhoa_2", NpgsqlDbType.Numeric).Value = m_tieuhoa_2;
                    cmd.Parameters.Add("m_tieuhoa_3", NpgsqlDbType.Numeric).Value = m_tieuhoa_3;
                    cmd.Parameters.Add("m_tieuhoa_4", NpgsqlDbType.Numeric).Value = m_tieuhoa_4;
                    cmd.Parameters.Add("m_tieuhoa_5", NpgsqlDbType.Numeric).Value = m_tieuhoa_5;
                    cmd.Parameters.Add("m_tieuhoa_6", NpgsqlDbType.Numeric).Value = m_tieuhoa_6;
                    cmd.Parameters.Add("m_tieuhoa_7", NpgsqlDbType.Numeric).Value = m_tieuhoa_7;
                    cmd.Parameters.Add("m_thankinh", NpgsqlDbType.Text).Value = m_thankinh;
                    cmd.Parameters.Add("m_thankinh_k", NpgsqlDbType.Numeric).Value = m_thankinh_k;
                    cmd.Parameters.Add("m_thankinh_1", NpgsqlDbType.Numeric).Value = m_thankinh_1;
                    cmd.Parameters.Add("m_thankinh_2", NpgsqlDbType.Numeric).Value = m_thankinh_2;
                    cmd.Parameters.Add("m_thankinh_3", NpgsqlDbType.Numeric).Value = m_thankinh_3;
                    cmd.Parameters.Add("m_thankinh_4", NpgsqlDbType.Numeric).Value = m_thankinh_4;
                    cmd.Parameters.Add("m_huyethoc", NpgsqlDbType.Text).Value = m_huyethoc;
                    cmd.Parameters.Add("m_huyethoc_k", NpgsqlDbType.Numeric).Value = m_huyethoc_k;
                    cmd.Parameters.Add("m_huyethoc_1", NpgsqlDbType.Numeric).Value = m_huyethoc_1;
                    cmd.Parameters.Add("m_huyethoc_2", NpgsqlDbType.Numeric).Value = m_huyethoc_2;
                    cmd.Parameters.Add("m_huyethoc_3", NpgsqlDbType.Numeric).Value = m_huyethoc_3;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_danhgia2");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_danhgia3(string m_mabn, decimal m_id3, string m_ngay, string m_lamsang, string m_kham, int m_kham_1, int m_kham_2,
            int m_kham_3, int m_kham_4, int m_kham_5, string m_xn, string m_cls, string m_luuy, string m_asa, int m_thaoluan_1,
            int m_thaoluan_2, int m_thaoluan_3, int m_thaoluan_4, int m_thaoluan_5, string m_kehoach, string m_mabs, int m_userid)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_danhgia3 set mabn=:m_mabn,";
            sql += "lamsang=:m_lamsang,kham=:m_kham,kham_1=:m_kham_1,kham_2=:m_kham_2,kham_3=:m_kham_3,kham_4=:m_kham_4,";
            sql += "kham_5=:m_kham_5,xn=:m_xn,cls=:m_cls,luuy=:m_luuy,asa=:m_asa,thaoluan_1=:m_thaoluan_1,thaoluan_2=:m_thaoluan_2,";
            sql += "thaoluan_3=:m_thaoluan_3,thaoluan_4=:m_thaoluan_4,thaoluan_5=:m_thaoluan_5,kehoach=:m_kehoach,";
            sql += "mabs=:m_mabs,userid=:m_userid";
            sql += " where id3=:m_id3";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_lamsang", NpgsqlDbType.Text).Value = m_lamsang;
                cmd.Parameters.Add("m_kham", NpgsqlDbType.Text).Value = m_kham;
                cmd.Parameters.Add("m_kham_1", NpgsqlDbType.Numeric).Value = m_kham_1;
                cmd.Parameters.Add("m_kham_2", NpgsqlDbType.Numeric).Value = m_kham_2;
                cmd.Parameters.Add("m_kham_3", NpgsqlDbType.Numeric).Value = m_kham_3;
                cmd.Parameters.Add("m_kham_4", NpgsqlDbType.Numeric).Value = m_kham_4;
                cmd.Parameters.Add("m_kham_5", NpgsqlDbType.Numeric).Value = m_kham_5;
                cmd.Parameters.Add("m_xn", NpgsqlDbType.Text).Value = m_xn;
                cmd.Parameters.Add("m_cls", NpgsqlDbType.Text).Value = m_cls;
                cmd.Parameters.Add("m_luuy", NpgsqlDbType.Text).Value = m_luuy;
                cmd.Parameters.Add("m_asa", NpgsqlDbType.Varchar, 1).Value = m_asa;
                cmd.Parameters.Add("m_thaoluan_1", NpgsqlDbType.Numeric).Value = m_thaoluan_1;
                cmd.Parameters.Add("m_thaoluan_2", NpgsqlDbType.Numeric).Value = m_thaoluan_2;
                cmd.Parameters.Add("m_thaoluan_3", NpgsqlDbType.Numeric).Value = m_thaoluan_3;
                cmd.Parameters.Add("m_thaoluan_4", NpgsqlDbType.Numeric).Value = m_thaoluan_4;
                cmd.Parameters.Add("m_thaoluan_5", NpgsqlDbType.Numeric).Value = m_thaoluan_5;
                cmd.Parameters.Add("m_kehoach", NpgsqlDbType.Text).Value = m_kehoach;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id3", NpgsqlDbType.Numeric).Value = m_id3;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_danhgia3 (mabn,id3,lamsang,kham,kham_1,kham_2,kham_3,kham_4,kham_5,xn,cls,luuy,asa,thaoluan_1,thaoluan_2,thaoluan_3,thaoluan_4,thaoluan_5,kehoach,mabs,userid) values (:m_mabn,:m_id3,:m_lamsang,:m_kham,:m_kham_1,:m_kham_2,:m_kham_3,:m_kham_4,:m_kham_5,:m_xn,:m_cls,:m_luuy,:m_asa,:m_thaoluan_1,:m_thaoluan_2,:m_thaoluan_3,:m_thaoluan_4,:m_thaoluan_5,:m_kehoach,:m_mabs,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_id3", NpgsqlDbType.Numeric).Value = m_id3;
                    cmd.Parameters.Add("m_lamsang", NpgsqlDbType.Text).Value = m_lamsang;
                    cmd.Parameters.Add("m_kham", NpgsqlDbType.Text).Value = m_kham;
                    cmd.Parameters.Add("m_kham_1", NpgsqlDbType.Numeric).Value = m_kham_1;
                    cmd.Parameters.Add("m_kham_2", NpgsqlDbType.Numeric).Value = m_kham_2;
                    cmd.Parameters.Add("m_kham_3", NpgsqlDbType.Numeric).Value = m_kham_3;
                    cmd.Parameters.Add("m_kham_4", NpgsqlDbType.Numeric).Value = m_kham_4;
                    cmd.Parameters.Add("m_kham_5", NpgsqlDbType.Numeric).Value = m_kham_5;
                    cmd.Parameters.Add("m_xn", NpgsqlDbType.Text).Value = m_xn;
                    cmd.Parameters.Add("m_cls", NpgsqlDbType.Text).Value = m_cls;
                    cmd.Parameters.Add("m_luuy", NpgsqlDbType.Text).Value = m_luuy;
                    cmd.Parameters.Add("m_asa", NpgsqlDbType.Varchar, 1).Value = m_asa;
                    cmd.Parameters.Add("m_thaoluan_1", NpgsqlDbType.Numeric).Value = m_thaoluan_1;
                    cmd.Parameters.Add("m_thaoluan_2", NpgsqlDbType.Numeric).Value = m_thaoluan_2;
                    cmd.Parameters.Add("m_thaoluan_3", NpgsqlDbType.Numeric).Value = m_thaoluan_3;
                    cmd.Parameters.Add("m_thaoluan_4", NpgsqlDbType.Numeric).Value = m_thaoluan_4;
                    cmd.Parameters.Add("m_thaoluan_5", NpgsqlDbType.Numeric).Value = m_thaoluan_5;
                    cmd.Parameters.Add("m_kehoach", NpgsqlDbType.Text).Value = m_kehoach;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_danhgia3");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_theodoian(decimal m_id, decimal m_idthuchien, string m_ngay, int m_duong, int m_loai, decimal m_soluong,
            string m_truoc, string m_sau, string m_ghichu, string m_yta, int m_userid)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_theodoian set idthuchien=:m_idthuchien,ngay=to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),";
            sql += "duong=:m_duong,loai=:m_loai,soluong=:m_soluong,truoc=:m_truoc,sau=:m_sau,ghichu=:m_ghichu,";
            sql += "yta=:m_yta,userid=:m_userid where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                cmd.Parameters.Add("m_duong", NpgsqlDbType.Numeric).Value = m_duong;
                cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                cmd.Parameters.Add("m_soluong", NpgsqlDbType.Numeric).Value = m_soluong;
                cmd.Parameters.Add("m_truoc", NpgsqlDbType.Text).Value = m_truoc;
                cmd.Parameters.Add("m_sau", NpgsqlDbType.Text).Value = m_sau;
                cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text).Value = m_ghichu;
                cmd.Parameters.Add("m_yta", NpgsqlDbType.Varchar, 4).Value = m_yta;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_theodoian (id,idthuchien,ngay,duong,loai,soluong,truoc,sau,ghichu,yta,userid) values (:m_id,:m_idthuchien,to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),:m_duong,:m_loai,:m_soluong,:m_truoc,:m_sau,:m_ghichu,:m_yta,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                    cmd.Parameters.Add("m_duong", NpgsqlDbType.Numeric).Value = m_duong;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                    cmd.Parameters.Add("m_soluong", NpgsqlDbType.Numeric).Value = m_soluong;
                    cmd.Parameters.Add("m_truoc", NpgsqlDbType.Text).Value = m_truoc;
                    cmd.Parameters.Add("m_sau", NpgsqlDbType.Text).Value = m_sau;
                    cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text).Value = m_ghichu;
                    cmd.Parameters.Add("m_yta", NpgsqlDbType.Varchar, 4).Value = m_yta;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_theodoian");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_theodoicn(string m_ngay, decimal m_id, decimal m_idthuchien, int m_userid)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_theodoicn set idthuchien=:m_idthuchien,userid=:m_userid where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_theodoicn (id,idthuchien,userid) values (:m_id,:m_idthuchien,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_theodoicn");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_theodoicnct(decimal m_id, string m_ngay, decimal m_mach, decimal m_nhietdo, string m_huyetap, decimal m_nhiptho, decimal m_cannang, string m_yta, int m_userid)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_theodoicnct set mach=:m_mach,nhietdo=:m_nhietdo,";
            sql += "huyetap=:m_huyetap,nhiptho=:m_nhiptho,cannang=:m_cannang,yta=:m_yta,userid=:m_userid where id=:m_id and ngay=to_date(:m_ngay,'dd/mm/yyyy hh24:mi')";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mach", NpgsqlDbType.Numeric).Value = m_mach;
                cmd.Parameters.Add("m_nhietdo", NpgsqlDbType.Numeric).Value = m_nhietdo;
                cmd.Parameters.Add("m_huyetap", NpgsqlDbType.Varchar, 7).Value = m_huyetap;
                cmd.Parameters.Add("m_nhiptho", NpgsqlDbType.Numeric).Value = m_nhiptho;
                cmd.Parameters.Add("m_cannang", NpgsqlDbType.Numeric).Value = m_cannang;
                cmd.Parameters.Add("m_yta", NpgsqlDbType.Varchar, 4).Value = m_yta;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_theodoicnct (id,ngay,mach,nhietdo,huyetap,nhiptho,cannang,yta,userid) values (:m_id,to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),:m_mach,:m_nhietdo,:m_huyetap,:m_nhiptho,:m_cannang,:m_yta,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                    cmd.Parameters.Add("m_mach", NpgsqlDbType.Numeric).Value = m_mach;
                    cmd.Parameters.Add("m_nhietdo", NpgsqlDbType.Numeric).Value = m_nhietdo;
                    cmd.Parameters.Add("m_huyetap", NpgsqlDbType.Varchar, 7).Value = m_huyetap;
                    cmd.Parameters.Add("m_nhiptho", NpgsqlDbType.Numeric).Value = m_nhiptho;
                    cmd.Parameters.Add("m_cannang", NpgsqlDbType.Numeric).Value = m_cannang;
                    cmd.Parameters.Add("m_yta", NpgsqlDbType.Varchar, 4).Value = m_yta;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_theodoicnct");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_truyendich(string m_mabn, decimal m_id, decimal m_idthuchien, string m_ngay, int m_userid)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_truyendich set mabn=:m_mabn,idthuchien=:m_idthuchien,ngay=to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),userid=:m_userid where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_truyendich (mabn,id,idthuchien,ngay,userid) values (:m_mabn,:m_id,:m_idthuchien,to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_truyendich");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_truyendichct(string m_ngay, decimal m_id, int m_stt, string m_ten, decimal m_soluong, string m_losx, string m_tocdo,
            string m_batdau, string m_ketthuc, string m_bscd, string m_yta, string m_ghichu, int m_userid)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_truyendichct set ten=:m_ten,";
            sql += "soluong=:m_soluong,losx=:m_losx,tocdo=:m_tocdo,batdau=to_date(:m_batdau,'dd/mm/yyyy hh24:mi'),";
            if (m_ketthuc != "") sql += "ketthuc=to_date(:m_ketthuc,'dd/mm/yyyy hh24:mi'),";
            sql += "bscd=:m_bscd,yta=:m_yta,ghichu=:m_ghichu,userid=:m_userid where id=:m_id and stt=:m_stt";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_soluong", NpgsqlDbType.Numeric).Value = m_soluong;
                cmd.Parameters.Add("m_losx", NpgsqlDbType.Text).Value = m_losx;
                cmd.Parameters.Add("m_tocdo", NpgsqlDbType.Text).Value = m_tocdo;
                cmd.Parameters.Add("m_batdau", NpgsqlDbType.Varchar, 16).Value = m_batdau;
                if (m_ketthuc != "") cmd.Parameters.Add("m_ketthuc", NpgsqlDbType.Varchar, 16).Value = m_ketthuc;
                cmd.Parameters.Add("m_bscd", NpgsqlDbType.Varchar, 4).Value = m_bscd;
                cmd.Parameters.Add("m_yta", NpgsqlDbType.Varchar, 4).Value = m_yta;
                cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text).Value = m_ghichu;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_truyendichct (id,stt,ten,soluong,losx,tocdo,batdau,";
                    if (m_ketthuc != "") sql += "ketthuc,";
                    sql += "bscd,yta,ghichu,userid) values (:m_id,:m_stt,:m_ten,:m_soluong,:m_losx,:m_tocdo,to_date(:m_batdau,'dd/mm/yyyy hh24:mi'),";
                    if (m_ketthuc != "") sql += "to_date(:m_ketthuc,'dd/mm/yyyy hh24:mi'),";
                    sql += ":m_bscd,:m_yta,:m_ghichu,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    cmd.Parameters.Add("m_soluong", NpgsqlDbType.Numeric).Value = m_soluong;
                    cmd.Parameters.Add("m_losx", NpgsqlDbType.Text).Value = m_losx;
                    cmd.Parameters.Add("m_tocdo", NpgsqlDbType.Text).Value = m_tocdo;
                    cmd.Parameters.Add("m_batdau", NpgsqlDbType.Varchar, 16).Value = m_batdau;
                    if (m_ketthuc != "") cmd.Parameters.Add("m_ketthuc", NpgsqlDbType.Varchar, 16).Value = m_ketthuc;
                    cmd.Parameters.Add("m_bscd", NpgsqlDbType.Varchar, 4).Value = m_bscd;
                    cmd.Parameters.Add("m_yta", NpgsqlDbType.Varchar, 4).Value = m_yta;
                    cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text).Value = m_ghichu;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_truyendichct");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_linhmau(string m_ngay, string m_mabn, decimal m_id, decimal m_idthuchien, string m_sophieu, string m_ngaylinh, string m_donvi,
            string m_chepham, int m_nhommau, decimal m_lanthu, string m_nguoilinh, string m_bsdt, string m_phongphat,
            string m_bvphat, string m_dvphat, string m_ngayphat, string m_nguoiphat, string m_truongkhoa, int m_userid)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_linhmau set mabn=:m_mabn,idthuchien=:m_idthuchien,sophieu=:m_sophieu,";
            sql += "ngaylinh=to_date(:m_ngaylinh,'dd/mm/yyyy'),donvi=:m_donvi,";
            sql += "chepham=:m_chepham,nhommau=:m_nhommau,lanthu=:m_lanthu,nguoilinh=:m_nguoilinh,";
            sql += "bsdt=:m_bsdt,phongphat=:m_phongphat,bvphat=:m_bvphat,dvphat=:m_dvphat,";
            if (m_ngayphat != "") sql += "ngayphat=to_date(:m_ngayphat,'dd/mm/yyyy'),";
            sql += "nguoiphat=:m_nguoiphat,truongkhoa=:m_truongkhoa,";
            sql += "userid=:m_userid where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                cmd.Parameters.Add("m_sophieu", NpgsqlDbType.Varchar, 10).Value = m_sophieu;
                cmd.Parameters.Add("m_ngaylinh", NpgsqlDbType.Varchar, 10).Value = m_ngaylinh;
                cmd.Parameters.Add("m_donvi", NpgsqlDbType.Text).Value = m_donvi;
                cmd.Parameters.Add("m_chepham", NpgsqlDbType.Text).Value = m_chepham;
                cmd.Parameters.Add("m_nhommau", NpgsqlDbType.Numeric).Value = m_nhommau;
                cmd.Parameters.Add("m_lanthu", NpgsqlDbType.Numeric).Value = m_lanthu;
                cmd.Parameters.Add("m_nguoilinh", NpgsqlDbType.Varchar, 4).Value = m_nguoilinh;
                cmd.Parameters.Add("m_bsdt", NpgsqlDbType.Varchar, 4).Value = m_bsdt;
                cmd.Parameters.Add("m_phongphat", NpgsqlDbType.Text).Value = m_phongphat;
                cmd.Parameters.Add("m_bvphat", NpgsqlDbType.Text).Value = m_bvphat;
                cmd.Parameters.Add("m_dvphat", NpgsqlDbType.Text).Value = m_dvphat;
                if (m_ngayphat != "") cmd.Parameters.Add("m_ngayphat", NpgsqlDbType.Varchar, 10).Value = m_ngayphat;
                cmd.Parameters.Add("m_nguoiphat", NpgsqlDbType.Varchar, 4).Value = m_nguoiphat;
                cmd.Parameters.Add("m_truongkhoa", NpgsqlDbType.Varchar, 4).Value = m_truongkhoa;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_linhmau (mabn,id,idthuchien,sophieu,ngaylinh,donvi,chepham,nhommau,lanthu,nguoilinh,bsdt,phongphat,bvphat,dvphat,";
                    if (m_ngayphat != "") sql += "ngayphat,";
                    sql += "nguoiphat,truongkhoa,userid) values (:m_mabn,:m_id,:m_idthuchien,:m_sophieu,to_date(:m_ngaylinh,'dd/mm/yyyy'),";
                    sql += ":m_donvi,:m_chepham,:m_nhommau,:m_lanthu,:m_nguoilinh,:m_bsdt,:m_phongphat,:m_bvphat,:m_dvphat,";
                    if (m_ngayphat != "") sql += "to_date(:m_ngayphat,'dd/mm/yyyy'),";
                    sql += ":m_nguoiphat,:m_truongkhoa,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                    cmd.Parameters.Add("m_sophieu", NpgsqlDbType.Varchar, 10).Value = m_sophieu;
                    cmd.Parameters.Add("m_ngaylinh", NpgsqlDbType.Varchar, 10).Value = m_ngaylinh;
                    cmd.Parameters.Add("m_donvi", NpgsqlDbType.Text).Value = m_donvi;
                    cmd.Parameters.Add("m_chepham", NpgsqlDbType.Text).Value = m_chepham;
                    cmd.Parameters.Add("m_nhommau", NpgsqlDbType.Numeric).Value = m_nhommau;
                    cmd.Parameters.Add("m_lanthu", NpgsqlDbType.Numeric).Value = m_lanthu;
                    cmd.Parameters.Add("m_nguoilinh", NpgsqlDbType.Varchar, 4).Value = m_nguoilinh;
                    cmd.Parameters.Add("m_bsdt", NpgsqlDbType.Varchar, 4).Value = m_bsdt;
                    cmd.Parameters.Add("m_phongphat", NpgsqlDbType.Text).Value = m_phongphat;
                    cmd.Parameters.Add("m_bvphat", NpgsqlDbType.Text).Value = m_bvphat;
                    cmd.Parameters.Add("m_dvphat", NpgsqlDbType.Text).Value = m_dvphat;
                    if (m_ngayphat != "") cmd.Parameters.Add("m_ngayphat", NpgsqlDbType.Varchar, 10).Value = m_ngayphat;
                    cmd.Parameters.Add("m_nguoiphat", NpgsqlDbType.Varchar, 4).Value = m_nguoiphat;
                    cmd.Parameters.Add("m_truongkhoa", NpgsqlDbType.Varchar, 4).Value = m_truongkhoa;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_linhmau");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_linhmauct(string m_ngay, decimal m_id, int m_stt, string m_chepham, string m_maso, int m_nhommau)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_linhmauct set chepham=:m_chepham,";
            sql += "maso=:m_maso,nhommau=:m_nhommau ";
            sql += "where id=:m_id and stt=:m_stt";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_chepham", NpgsqlDbType.Text).Value = m_chepham;
                cmd.Parameters.Add("m_maso", NpgsqlDbType.Varchar, 10).Value = m_maso;
                cmd.Parameters.Add("m_nhommau", NpgsqlDbType.Numeric).Value = m_nhommau;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_linhmauct (id,stt,chepham,maso,nhommau) values (:m_id,:m_stt,:m_chepham,:m_maso,:m_nhommau)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_chepham", NpgsqlDbType.Text).Value = m_chepham;
                    cmd.Parameters.Add("m_maso", NpgsqlDbType.Varchar, 10).Value = m_maso;
                    cmd.Parameters.Add("m_nhommau", NpgsqlDbType.Numeric).Value = m_nhommau;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_linhmauct");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_truyenmau1(string m_ngayvv, string m_mabn, decimal m_id, decimal m_idthuchien, string m_ngay, string m_chepham,
            string m_maso, string m_ngaylay,
            string m_handung, string m_soluong, string m_noilam, string m_kythuat, string m_sinhpham,
            int m_hbsag, int m_hcv, int m_giangmai, int m_sotret, int m_nguoicho, int m_benhnhan,
            string m_ong1, string m_ong2, string m_truongkhoa, string m_ktv1, string m_ktv2, string m_chephamtr,
            string m_masotr, string m_handungtr, decimal m_lanthu, string m_bscd, int m_nguoichotr, int m_benhnhantr,
            string m_tai, string m_soluongtr)
        {
            string xxx = user + mmyy(m_ngayvv);
            sql = "update " + xxx + ".ba_truyenmau set mabn=:m_mabn,idthuchien=:m_idthuchien,ngay=to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),";
            sql += "chepham=:m_chepham,maso=:m_maso,ngaylay=to_date(:m_ngaylay,'dd/mm/yyyy'),";
            if (m_handung != "") sql += "handung=to_date(:m_handung,'dd/mm/yyyy'),";
            sql += "soluong=:m_soluong,noilam=:m_noilam,kythuat=:m_kythuat,sinhpham=:m_sinhpham,";
            sql += "hbsag=:m_hbsag,hcv=:m_hcv,giangmai=:m_giangmai,sotret=:m_sotret,";
            sql += "nguoicho=:m_nguoicho,benhnhan=:m_benhnhan,";
            sql += "ong1=:m_ong1,ong2=:m_ong2,truongkhoa=:m_truongkhoa,ktv1=:m_ktv1,ktv2=:m_ktv2,";
            sql += "chephamtr=:m_chephamtr,masotr=:m_masotr,";
            if (m_handungtr != "") sql += "handungtr=to_date(:m_handungtr,'dd/mm/yyyy'),";
            sql += "lanthu=:m_lanthu,bscd=:m_bscd,nguoichotr=:m_nguoichotr,benhnhantr=:m_benhnhantr,";
            sql += "tai=:m_tai,soluongtr=:m_soluongtr where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                cmd.Parameters.Add("m_chepham", NpgsqlDbType.Text).Value = m_chepham;
                cmd.Parameters.Add("m_maso", NpgsqlDbType.Varchar, 10).Value = m_maso;
                cmd.Parameters.Add("m_ngaylay", NpgsqlDbType.Varchar, 10).Value = m_ngaylay;
                if (m_handung != "") cmd.Parameters.Add("m_handung", NpgsqlDbType.Varchar, 10).Value = m_handung;
                cmd.Parameters.Add("m_soluong", NpgsqlDbType.Text).Value = m_soluong;
                cmd.Parameters.Add("m_noilam", NpgsqlDbType.Text).Value = m_noilam;
                cmd.Parameters.Add("m_kythuat", NpgsqlDbType.Text).Value = m_kythuat;
                cmd.Parameters.Add("m_sinhpham", NpgsqlDbType.Text).Value = m_sinhpham;
                cmd.Parameters.Add("m_hbsag", NpgsqlDbType.Numeric).Value = m_hbsag;
                cmd.Parameters.Add("m_hcv", NpgsqlDbType.Numeric).Value = m_hcv;
                cmd.Parameters.Add("m_giangmai", NpgsqlDbType.Numeric).Value = m_giangmai;
                cmd.Parameters.Add("m_sotret", NpgsqlDbType.Numeric).Value = m_sotret;
                cmd.Parameters.Add("m_nguoicho", NpgsqlDbType.Numeric).Value = m_nguoicho;
                cmd.Parameters.Add("m_benhnhan", NpgsqlDbType.Numeric).Value = m_benhnhan;
                cmd.Parameters.Add("m_ong1", NpgsqlDbType.Text).Value = m_ong1;
                cmd.Parameters.Add("m_ong2", NpgsqlDbType.Text).Value = m_ong2;
                cmd.Parameters.Add("m_truongkhoa", NpgsqlDbType.Varchar, 4).Value = m_truongkhoa;
                cmd.Parameters.Add("m_ktv1", NpgsqlDbType.Varchar, 4).Value = m_ktv1;
                cmd.Parameters.Add("m_ktv2", NpgsqlDbType.Varchar, 4).Value = m_ktv2;
                cmd.Parameters.Add("m_chephamtr", NpgsqlDbType.Text).Value = m_chephamtr;
                cmd.Parameters.Add("m_masotr", NpgsqlDbType.Varchar, 10).Value = m_masotr;
                if (m_handungtr != "") cmd.Parameters.Add("m_handungtr", NpgsqlDbType.Varchar, 10).Value = m_handungtr;
                cmd.Parameters.Add("m_lanthu", NpgsqlDbType.Numeric).Value = m_lanthu;
                cmd.Parameters.Add("m_bscd", NpgsqlDbType.Varchar, 4).Value = m_bscd;
                cmd.Parameters.Add("m_nguoichotr", NpgsqlDbType.Numeric).Value = m_nguoichotr;
                cmd.Parameters.Add("m_benhnhantr", NpgsqlDbType.Numeric).Value = m_benhnhantr;
                cmd.Parameters.Add("m_tai", NpgsqlDbType.Text).Value = m_tai;
                cmd.Parameters.Add("m_soluongtr", NpgsqlDbType.Text).Value = m_soluongtr;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_truyenmau (mabn,id,idthuchien,ngay,chepham,maso,ngaylay,";
                    if (m_handung != "") sql += "handung,";
                    sql += "soluong,noilam,kythuat,sinhpham,hbsag,hcv,giangmai,sotret,";
                    sql += "nguoicho,benhnhan,ong1,ong2,truongkhoa,ktv1,ktv2,chephamtr,masotr,";
                    if (m_handungtr != "") sql += "handungtr,";
                    sql += "lanthu,bscd,nguoichotr,benhnhantr,tai,soluongtr)";
                    sql += " values (:m_mabn,:m_id,:m_idthuchien,to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),:m_chepham,:m_maso,to_date(:m_ngaylay,'dd/mm/yyyy'),";
                    if (m_handung != "") sql += "to_date(:m_handung,'dd/mm/yyyy'),";
                    sql += ":m_soluong,:m_noilam,:m_kythuat,:m_sinhpham,:m_hbsag,:m_hcv,:m_giangmai,:m_sotret,";
                    sql += ":m_nguoicho,:m_benhnhan,:m_ong1,:m_ong2,:m_truongkhoa,:m_ktv1,:m_ktv2,:m_chephamtr,:m_masotr,";
                    if (m_handungtr != "") sql += "to_date(:m_handungtr,'dd/mm/yyyy'),";
                    sql += ":m_lanthu,:m_bscd,:m_nguoichotr,:m_benhnhantr,:m_tai,:m_soluongtr)";

                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                    cmd.Parameters.Add("m_chepham", NpgsqlDbType.Text).Value = m_chepham;
                    cmd.Parameters.Add("m_maso", NpgsqlDbType.Varchar, 10).Value = m_maso;
                    cmd.Parameters.Add("m_ngaylay", NpgsqlDbType.Varchar, 10).Value = m_ngaylay;
                    if (m_handung != "") cmd.Parameters.Add("m_handung", NpgsqlDbType.Varchar, 10).Value = m_handung;
                    cmd.Parameters.Add("m_soluong", NpgsqlDbType.Text).Value = m_soluong;
                    cmd.Parameters.Add("m_noilam", NpgsqlDbType.Text).Value = m_noilam;
                    cmd.Parameters.Add("m_kythuat", NpgsqlDbType.Text).Value = m_kythuat;
                    cmd.Parameters.Add("m_sinhpham", NpgsqlDbType.Text).Value = m_sinhpham;
                    cmd.Parameters.Add("m_hbsag", NpgsqlDbType.Numeric).Value = m_hbsag;
                    cmd.Parameters.Add("m_hcv", NpgsqlDbType.Numeric).Value = m_hcv;
                    cmd.Parameters.Add("m_giangmai", NpgsqlDbType.Numeric).Value = m_giangmai;
                    cmd.Parameters.Add("m_sotret", NpgsqlDbType.Numeric).Value = m_sotret;
                    cmd.Parameters.Add("m_nguoicho", NpgsqlDbType.Numeric).Value = m_nguoicho;
                    cmd.Parameters.Add("m_benhnhan", NpgsqlDbType.Numeric).Value = m_benhnhan;
                    cmd.Parameters.Add("m_ong1", NpgsqlDbType.Text).Value = m_ong1;
                    cmd.Parameters.Add("m_ong2", NpgsqlDbType.Text).Value = m_ong2;
                    cmd.Parameters.Add("m_truongkhoa", NpgsqlDbType.Varchar, 4).Value = m_truongkhoa;
                    cmd.Parameters.Add("m_ktv1", NpgsqlDbType.Varchar, 4).Value = m_ktv1;
                    cmd.Parameters.Add("m_ktv2", NpgsqlDbType.Varchar, 4).Value = m_ktv2;
                    cmd.Parameters.Add("m_chephamtr", NpgsqlDbType.Text).Value = m_chephamtr;
                    cmd.Parameters.Add("m_masotr", NpgsqlDbType.Varchar, 10).Value = m_masotr;
                    if (m_handungtr != "") cmd.Parameters.Add("m_handungtr", NpgsqlDbType.Varchar, 10).Value = m_handungtr;
                    cmd.Parameters.Add("m_lanthu", NpgsqlDbType.Numeric).Value = m_lanthu;
                    cmd.Parameters.Add("m_bscd", NpgsqlDbType.Varchar, 4).Value = m_bscd;
                    cmd.Parameters.Add("m_nguoichotr", NpgsqlDbType.Numeric).Value = m_nguoichotr;
                    cmd.Parameters.Add("m_benhnhantr", NpgsqlDbType.Numeric).Value = m_benhnhantr;
                    cmd.Parameters.Add("m_tai", NpgsqlDbType.Text).Value = m_tai;
                    cmd.Parameters.Add("m_soluongtr", NpgsqlDbType.Text).Value = m_soluongtr;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_truyenmau1");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_truyenmau2(string m_ngayvv, string m_mabn, decimal m_id, string m_batdau, string m_ketthuc, string m_soluongthuc,
            string m_sacmat, decimal m_nhiptho, decimal m_nhietdo, string m_huyetap, decimal m_mach,
            string m_dienbien, string m_bsth, string m_yta, decimal m_idlinh, int m_userid)
        {
            string xxx = user + mmyy(m_ngayvv);
            sql = "update " + xxx + ".ba_truyenmau set mabn=:m_mabn,batdau=to_date(:m_batdau,'dd/mm/yyyy hh24:mi'),";
            if (m_ketthuc.Trim() != "") sql += "ketthuc=to_date(:m_ketthuc,'dd/mm/yyyy hh24:mi'),";
            sql += "soluongthuc=:m_soluongthuc,sacmat=:m_sacmat,nhiptho=:m_nhiptho,nhietdo=:m_nhietdo,";
            sql += "huyetap=:m_huyetap,mach=:m_mach,dienbien=:m_dienbien,bsth=:m_bsth,yta=:m_yta,";
            sql += "idlinh=:m_idlinh,userid=:m_userid where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_batdau", NpgsqlDbType.Varchar, 16).Value = m_batdau;
                if (m_ketthuc.Trim() != "") cmd.Parameters.Add("m_ketthuc", NpgsqlDbType.Varchar, 16).Value = m_ketthuc;
                cmd.Parameters.Add("m_soluongthuc", NpgsqlDbType.Text).Value = m_soluongthuc;
                cmd.Parameters.Add("m_sacmat", NpgsqlDbType.Text).Value = m_sacmat;
                cmd.Parameters.Add("m_nhiptho", NpgsqlDbType.Numeric).Value = m_nhiptho;
                cmd.Parameters.Add("m_nhietdo", NpgsqlDbType.Numeric).Value = m_nhietdo;
                cmd.Parameters.Add("m_huyetap", NpgsqlDbType.Varchar, 7).Value = m_huyetap;
                cmd.Parameters.Add("m_mach", NpgsqlDbType.Numeric).Value = m_mach;
                cmd.Parameters.Add("m_dienbien", NpgsqlDbType.Text).Value = m_dienbien;
                cmd.Parameters.Add("m_bsth", NpgsqlDbType.Varchar, 4).Value = m_bsth;
                cmd.Parameters.Add("m_yta", NpgsqlDbType.Varchar, 4).Value = m_yta;
                cmd.Parameters.Add("m_idlinh", NpgsqlDbType.Numeric).Value = m_idlinh;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.ExecuteNonQuery();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_truyenmau2");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_ba_truyenmauct(string m_ngayvv, decimal m_id, int m_stt, string m_ngay, string m_sacmat, decimal m_nhiptho, decimal m_nhietdo, string m_huyetap, decimal m_mach, string m_dienbien)
        {
            string xxx = user + mmyy(m_ngayvv);
            sql = "update " + xxx + ".ba_truyenmauct set ngay=to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),sacmat=:m_sacmat,nhiptho=:m_nhiptho,";
            sql += "nhietdo=:m_nhietdo,huyetap=:m_huyetap,mach=:m_mach,dienbien=:m_dienbien ";
            sql += "where id=:m_id and stt=:m_stt";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                cmd.Parameters.Add("m_sacmat", NpgsqlDbType.Text).Value = m_sacmat;
                cmd.Parameters.Add("m_nhiptho", NpgsqlDbType.Numeric).Value = m_nhiptho;
                cmd.Parameters.Add("m_nhietdo", NpgsqlDbType.Numeric).Value = m_nhietdo;
                cmd.Parameters.Add("m_huyetap", NpgsqlDbType.Varchar, 7).Value = m_huyetap;
                cmd.Parameters.Add("m_mach", NpgsqlDbType.Numeric).Value = m_mach;
                cmd.Parameters.Add("m_dienbien", NpgsqlDbType.Text).Value = m_dienbien;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;

                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_truyenmauct (id,stt,ngay,sacmat,nhiptho,nhietdo,huyetap,mach,dienbien) ";
                    sql += "values (:m_id,:m_stt,to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),:m_sacmat,:m_nhiptho,:m_nhietdo,:m_huyetap,:m_mach,:m_dienbien)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                    cmd.Parameters.Add("m_sacmat", NpgsqlDbType.Text).Value = m_sacmat;
                    cmd.Parameters.Add("m_nhiptho", NpgsqlDbType.Numeric).Value = m_nhiptho;
                    cmd.Parameters.Add("m_nhietdo", NpgsqlDbType.Numeric).Value = m_nhietdo;
                    cmd.Parameters.Add("m_huyetap", NpgsqlDbType.Varchar, 7).Value = m_huyetap;
                    cmd.Parameters.Add("m_mach", NpgsqlDbType.Numeric).Value = m_mach;
                    cmd.Parameters.Add("m_dienbien", NpgsqlDbType.Text).Value = m_dienbien;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_truyenmauct");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_dmchidinh(decimal m_id, decimal m_idloaivp, decimal m_stt, string m_ten, string m_report, int m_tinhtrang, int m_lanthu, string m_hen, string m_noidung, string m_ketqua, int m_cannang, int m_chieucao, int m_thuchien)
        {
            sql = "update dmchidinh set idloaivp=:m_idloaivp,stt=:m_stt,ten=:m_ten,report=:m_report,";
            sql += "tinhtrang=:m_tinhtrang,lanthu=:m_lanthu,hen=:m_hen,noidung=:m_noidung,ketqua=:m_ketqua,";
            sql += "cannang=:m_cannang,chieucao=:m_chieucao,thuchien=:m_thuchien where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_idloaivp", NpgsqlDbType.Numeric).Value = m_idloaivp;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_report", NpgsqlDbType.Varchar, 50).Value = m_report;
                cmd.Parameters.Add("m_tinhtrang", NpgsqlDbType.Numeric).Value = m_tinhtrang;
                cmd.Parameters.Add("m_lanthu", NpgsqlDbType.Numeric).Value = m_lanthu;
                cmd.Parameters.Add("m_hen", NpgsqlDbType.Text).Value = m_hen;
                cmd.Parameters.Add("m_noidung", NpgsqlDbType.Text).Value = m_noidung;
                cmd.Parameters.Add("m_ketqua", NpgsqlDbType.Text).Value = m_ketqua;
                cmd.Parameters.Add("m_cannang", NpgsqlDbType.Numeric).Value = m_cannang;
                cmd.Parameters.Add("m_chieucao", NpgsqlDbType.Numeric).Value = m_chieucao;
                cmd.Parameters.Add("m_thuchien", NpgsqlDbType.Numeric).Value = m_thuchien;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into dmchidinh (id,idloaivp,stt,ten,report,tinhtrang,lanthu,hen,noidung,ketqua,cannang,chieucao,thuchien) values (:m_id,:m_idloaivp,:m_stt,:m_ten,:m_report,:m_tinhtrang,:m_lanthu,:m_hen,:m_noidung,:m_ketqua,:m_cannang,:m_chieucao,:m_thuchien)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_idloaivp", NpgsqlDbType.Numeric).Value = m_idloaivp;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    cmd.Parameters.Add("m_report", NpgsqlDbType.Varchar, 50).Value = m_report;
                    cmd.Parameters.Add("m_tinhtrang", NpgsqlDbType.Numeric).Value = m_tinhtrang;
                    cmd.Parameters.Add("m_lanthu", NpgsqlDbType.Numeric).Value = m_lanthu;
                    cmd.Parameters.Add("m_hen", NpgsqlDbType.Text).Value = m_hen;
                    cmd.Parameters.Add("m_noidung", NpgsqlDbType.Text).Value = m_noidung;
                    cmd.Parameters.Add("m_ketqua", NpgsqlDbType.Text).Value = m_ketqua;
                    cmd.Parameters.Add("m_cannang", NpgsqlDbType.Numeric).Value = m_cannang;
                    cmd.Parameters.Add("m_chieucao", NpgsqlDbType.Numeric).Value = m_chieucao;
                    cmd.Parameters.Add("m_thuchien", NpgsqlDbType.Numeric).Value = m_thuchien;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dmchidinh");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        //02/03/2009
        public bool upd_datgiuong(string m_mabn, string m_ngay, decimal m_idgiuong, string m_ghichu, int m_userid)
        {
            sql = "update datgiuong set ghichu=:m_ghichu,userid=:m_userid where mabn=:m_mabn and to_char(ngay,'dd/mm/yyyy hh24:mi')=:m_ngay and idgiuong=:m_idgiuong";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text, 254).Value = m_ghichu;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                cmd.Parameters.Add("m_idgiuong", NpgsqlDbType.Numeric).Value = m_idgiuong;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into datgiuong (mabn,ngay,idgiuong,ghichu,userid) values (:m_mabn,to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),:m_idgiuong,:m_ghichu,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                    cmd.Parameters.Add("m_idgiuong", NpgsqlDbType.Numeric).Value = m_idgiuong;
                    cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text, 254).Value = m_ghichu;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "datgiuong");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_datgiuong(string m_mabn, string m_ngay, string m_den)
        {
            sql = "update datgiuong set den=to_date(:m_den,'dd/mm/yyyy hh24:mi') where mabn=:m_mabn and to_char(ngay,'dd/mm/yyyy hh24:mi')=:m_ngay";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_den", NpgsqlDbType.Text, 16).Value = m_den;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                cmd.ExecuteNonQuery();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "datgiuong");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool bChonhinh_mabn
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=313");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public decimal get_idthuchien(string ngay, decimal maql, string makp, decimal idkhoa)
        {
            ds = get_data("select id from " + user + mmyy(ngay) + ".ba_thuchien where idkhoa=" + idkhoa + " order by id desc");
            if (ds.Tables[0].Rows.Count == 0)
            {
                ds = get_data("select id from " + user + mmyy(ngay) + ".ba_thuchien where maql=" + maql + " and makp='" + makp + "' order by id desc");
                if (ds.Tables[0].Rows.Count == 0) return 0;
                else return decimal.Parse(ds.Tables[0].Rows[0]["id"].ToString());
            }
            else return decimal.Parse(ds.Tables[0].Rows[0]["id"].ToString());
        }

        public decimal get_idthuchien_maql(string ngay, decimal maql)
        {
            ds = get_data("select id from " + user + mmyy(ngay) + ".ba_thuchien where maql=" + maql + " order by id desc");
            if (ds.Tables[0].Rows.Count == 0) return 0;
            else return decimal.Parse(ds.Tables[0].Rows[0]["id"].ToString());
        }
        public bool upd_ba_ungbuou(string ngay, decimal id, string xnmau, string xntebao, string xnblgp, string xquang,
            string sieuam, string xnkhac, int trietde, int trieuchung, string tienphau, string hach1, string donthuan,
            string hach2, string phauthuat, string hauphau, string hach3, string hoachat, string sodot,
            string dapung, int loai, string khac)
        {
            string xxx = user + mmyy(ngay);
            sql = "update " + xxx + ".ba_ungbuou set xnmau=:xnmau,xntebao=:xntebao,xnblgp=:xnblgp,xquang=:xquang,";
            sql += "sieuam=:sieuam,xnkhac=:xnkhac,trietde=" + trietde + ",trieuchung=" + trieuchung + ",tienphau=:tienphau,";
            sql += "hach1=:hach1,donthuan=:donthuan,hach2=:hach2,phauthuat=:phauthuat,hauphau=:hauphau,hach3=:hach3,";
            sql += "hoachat=:hoachat,sodot=:sodot,dapung=:dapung,loai=" + loai + ",khac=:khac where id=" + id;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("xnmau", NpgsqlDbType.Text, 254).Value = xnmau;
                cmd.Parameters.Add("xntebao", NpgsqlDbType.Text, 254).Value = xntebao;
                cmd.Parameters.Add("xnblgp", NpgsqlDbType.Text, 254).Value = xnblgp;
                cmd.Parameters.Add("xquang", NpgsqlDbType.Text, 254).Value = xquang;
                cmd.Parameters.Add("sieuam", NpgsqlDbType.Text, 254).Value = sieuam;
                cmd.Parameters.Add("xnkhac", NpgsqlDbType.Text, 254).Value = xnkhac;
                cmd.Parameters.Add("tienphau", NpgsqlDbType.Text, 254).Value = tienphau;
                cmd.Parameters.Add("hach1", NpgsqlDbType.Text, 254).Value = hach1;
                cmd.Parameters.Add("donthuan", NpgsqlDbType.Text, 254).Value = donthuan;
                cmd.Parameters.Add("hach2", NpgsqlDbType.Text, 254).Value = hach2;
                cmd.Parameters.Add("phauthuat", NpgsqlDbType.Text, 254).Value = phauthuat;
                cmd.Parameters.Add("hauphau", NpgsqlDbType.Text, 254).Value = hauphau;
                cmd.Parameters.Add("hach3", NpgsqlDbType.Text, 254).Value = hach3;
                cmd.Parameters.Add("hoachat", NpgsqlDbType.Text, 254).Value = hoachat;
                cmd.Parameters.Add("sodot", NpgsqlDbType.Text, 254).Value = sodot;
                cmd.Parameters.Add("dapung", NpgsqlDbType.Text, 254).Value = dapung;
                cmd.Parameters.Add("khac", NpgsqlDbType.Text, 254).Value = khac;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_ungbuou (id,xnmau,xntebao,xnblgp,xquang,sieuam,xnkhac,trietde,trieuchung,tienphau,hach1,donthuan,";
                    sql += "hach2,phauthuat,hauphau,hach3,hoachat,sodot,dapung,loai,khac)";
                    sql += " values (";
                    sql += id + ",:xnmau,:xntebao,:xnblgp,:xquang,:sieuam,:xnkhac," + trietde + "," + trieuchung + ",:tienphau,:hach1,:donthuan,";
                    sql += ":hach2,:phauthuat,:hauphau,:hach3,:hoachat,:sodot,:dapung," + loai + ",:khac)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("xnmau", NpgsqlDbType.Text, 254).Value = xnmau;
                    cmd.Parameters.Add("xntebao", NpgsqlDbType.Text, 254).Value = xntebao;
                    cmd.Parameters.Add("xnblgp", NpgsqlDbType.Text, 254).Value = xnblgp;
                    cmd.Parameters.Add("xquang", NpgsqlDbType.Text, 254).Value = xquang;
                    cmd.Parameters.Add("sieuam", NpgsqlDbType.Text, 254).Value = sieuam;
                    cmd.Parameters.Add("xnkhac", NpgsqlDbType.Text, 254).Value = xnkhac;
                    cmd.Parameters.Add("tienphau", NpgsqlDbType.Text, 254).Value = tienphau;
                    cmd.Parameters.Add("hach1", NpgsqlDbType.Text, 254).Value = hach1;
                    cmd.Parameters.Add("donthuan", NpgsqlDbType.Text, 254).Value = donthuan;
                    cmd.Parameters.Add("hach2", NpgsqlDbType.Text, 254).Value = hach2;
                    cmd.Parameters.Add("phauthuat", NpgsqlDbType.Text, 254).Value = phauthuat;
                    cmd.Parameters.Add("hauphau", NpgsqlDbType.Text, 254).Value = hauphau;
                    cmd.Parameters.Add("hach3", NpgsqlDbType.Text, 254).Value = hach3;
                    cmd.Parameters.Add("hoachat", NpgsqlDbType.Text, 254).Value = hoachat;
                    cmd.Parameters.Add("sodot", NpgsqlDbType.Text, 254).Value = sodot;
                    cmd.Parameters.Add("dapung", NpgsqlDbType.Text, 254).Value = dapung;
                    cmd.Parameters.Add("khac", NpgsqlDbType.Text, 254).Value = khac;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_ungbuou");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_ba_gayme(decimal m_id, string m_ngayvv, decimal m_idthuchien, string m_ngay, string m_diung, string m_tenpt,
            int m_nhommau, decimal m_cannang, string m_ptv, string m_bsgmhs, string m_ktvgm, string m_asa,
            string m_mallampati, int m_tuthe, int m_dau, int m_sankhoa, int m_modetho, int m_nkq, int m_npq,
            decimal m_so, decimal m_dosau, int m_baloon, int m_thuong, int m_loxo, int m_mieng, int m_mui, int m_mtq,
            decimal m_mtq_so, decimal m_mtq_dosau, int m_mtq_baloon, int m_classic, int m_seal, int m_tienme,
            int m_metm, int m_tts, string m_tts_tt, string m_tts_vitri, decimal m_tts_so, int m_tnmc,
            string m_tnmc_tt, string m_tnmc_vitri, decimal m_tnmc_luon, int m_tetung, int m_nach, int m_cobac,
            int m_khac, int m_ttc, int m_tieu, int m_daday, int m_cvp, string m_cvp_vitri, decimal m_cvp_dosau,
            int m_abp, string m_abp_vitri, int m_iv, string m_iv_vitri, int m_mar, string m_mar_lieu, int m_mar_dd,
            int m_mar_cd, int m_fen, string m_fen_lieu, int m_fen_dd, int m_fen_cd, int m_lid,
            string m_lid_lieu, int m_lid_dd, int m_lid_cd, int m_bomdien, string m_ghichu, int m_userid)
        {
            string xxx = user + mmyy(m_ngayvv);
            sql = "update " + xxx + ".ba_gayme set ";
            sql += "idthuchien=:m_idthuchien,ngay=to_date(:m_ngay,'dd/mm/yyyy'),diung=:m_diung,tenpt=:m_tenpt,";
            sql += "nhommau=:m_nhommau,cannang=:m_cannang,ptv=:m_ptv,bsgmhs=:m_bsgmhs,ktvgm=:m_ktvgm,asa=:m_asa,";
            sql += "mallampati=:m_mallampati,tuthe=:m_tuthe,dau=:m_dau,sankhoa=:m_sankhoa,modetho=:m_modetho,";
            sql += "nkq=:m_nkq,npq=:m_npq,so=:m_so,dosau=:m_dosau,baloon=:m_baloon,thuong=:m_thuong,loxo=:m_loxo,";
            sql += "mieng=:m_mieng,mui=:m_mui,mtq=:m_mtq,mtq_so=:m_mtq_so,mtq_dosau=:m_mtq_dosau,mtq_baloon=:m_mtq_baloon,";
            sql += "classic=:m_classic,seal=:m_seal,tienme=:m_tienme,metm=:m_metm,tts=:m_tts,tts_tt=:m_tts_tt,";
            sql += "tts_vitri=:m_tts_vitri,tts_so=:m_tts_so,tnmc=:m_tnmc,tnmc_tt=:m_tnmc_tt,tnmc_vitri=:m_tnmc_vitri,";
            sql += "tnmc_luon=:m_tnmc_luon,tetung=:m_tetung,nach=:m_nach,cobac=:m_cobac,khac=:m_khac,ttc=:m_ttc,";
            sql += "tieu=:m_tieu,daday=:m_daday,cvp=:m_cvp,cvp_vitri=:m_cvp_vitri,cvp_dosau=:m_cvp_dosau,";
            sql += "abp=:m_abp,abp_vitri=:m_abp_vitri,iv=:m_iv,iv_vitri=:m_iv_vitri,mar=:m_mar,mar_lieu=:m_mar_lieu,";
            sql += "mar_dd=:m_mar_dd,mar_cd=:m_mar_cd,fen=:m_fen,fen_lieu=:m_fen_lieu,fen_dd=:m_fen_dd,fen_cd=:m_fen_cd,";
            sql += "lid=:m_lid,lid_lieu=:m_lid_lieu,lid_dd=:m_lid_dd,lid_cd=:m_lid_cd,bomdien=:m_bomdien,";
            sql += "ghichu=:m_ghichu,userid=:m_userid ";
            sql += " where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 10).Value = m_ngay;
                cmd.Parameters.Add("m_diung", NpgsqlDbType.Text, 254).Value = m_diung;
                cmd.Parameters.Add("m_tenpt", NpgsqlDbType.Text, 254).Value = m_tenpt;
                cmd.Parameters.Add("m_nhommau", NpgsqlDbType.Numeric).Value = m_nhommau;
                cmd.Parameters.Add("m_cannang", NpgsqlDbType.Numeric).Value = m_cannang;
                cmd.Parameters.Add("m_ptv", NpgsqlDbType.Varchar, 4).Value = m_ptv;
                cmd.Parameters.Add("m_bsgmhs", NpgsqlDbType.Varchar, 4).Value = m_bsgmhs;
                cmd.Parameters.Add("m_ktvgm", NpgsqlDbType.Varchar, 4).Value = m_ktvgm;
                cmd.Parameters.Add("m_asa", NpgsqlDbType.Varchar, 3).Value = m_asa;
                cmd.Parameters.Add("m_mallampati", NpgsqlDbType.Varchar, 3).Value = m_mallampati;
                cmd.Parameters.Add("m_tuthe", NpgsqlDbType.Numeric).Value = m_tuthe;
                cmd.Parameters.Add("m_dau", NpgsqlDbType.Numeric).Value = m_dau;
                cmd.Parameters.Add("m_sankhoa", NpgsqlDbType.Numeric).Value = m_sankhoa;
                cmd.Parameters.Add("m_modetho", NpgsqlDbType.Numeric).Value = m_modetho;
                cmd.Parameters.Add("m_nkq", NpgsqlDbType.Numeric).Value = m_nkq;
                cmd.Parameters.Add("m_npq", NpgsqlDbType.Numeric).Value = m_npq;
                cmd.Parameters.Add("m_so", NpgsqlDbType.Numeric).Value = m_so;
                cmd.Parameters.Add("m_dosau", NpgsqlDbType.Numeric).Value = m_dosau;
                cmd.Parameters.Add("m_baloon", NpgsqlDbType.Numeric).Value = m_baloon;
                cmd.Parameters.Add("m_thuong", NpgsqlDbType.Numeric).Value = m_thuong;
                cmd.Parameters.Add("m_loxo", NpgsqlDbType.Numeric).Value = m_loxo;
                cmd.Parameters.Add("m_mieng", NpgsqlDbType.Numeric).Value = m_mieng;
                cmd.Parameters.Add("m_mui", NpgsqlDbType.Numeric).Value = m_mui;
                cmd.Parameters.Add("m_mtq", NpgsqlDbType.Numeric).Value = m_mtq;
                cmd.Parameters.Add("m_mtq_so", NpgsqlDbType.Numeric).Value = m_mtq_so;
                cmd.Parameters.Add("m_mtq_dosau", NpgsqlDbType.Numeric).Value = m_mtq_dosau;
                cmd.Parameters.Add("m_mtq_baloon", NpgsqlDbType.Numeric).Value = m_mtq_baloon;
                cmd.Parameters.Add("m_classic", NpgsqlDbType.Numeric).Value = m_classic;
                cmd.Parameters.Add("m_seal", NpgsqlDbType.Numeric).Value = m_seal;
                cmd.Parameters.Add("m_tienme", NpgsqlDbType.Numeric).Value = m_tienme;
                cmd.Parameters.Add("m_metm", NpgsqlDbType.Numeric).Value = m_metm;
                cmd.Parameters.Add("m_tts", NpgsqlDbType.Numeric).Value = m_tts;
                cmd.Parameters.Add("m_tts_tt", NpgsqlDbType.Text, 50).Value = m_tts_tt;
                cmd.Parameters.Add("m_tts_vitri", NpgsqlDbType.Text, 50).Value = m_tts_vitri;
                cmd.Parameters.Add("m_tts_so", NpgsqlDbType.Numeric).Value = m_tts_so;
                cmd.Parameters.Add("m_tnmc", NpgsqlDbType.Numeric).Value = m_tnmc;
                cmd.Parameters.Add("m_tnmc_tt", NpgsqlDbType.Text, 50).Value = m_tnmc_tt;
                cmd.Parameters.Add("m_tnmc_vitri", NpgsqlDbType.Text, 50).Value = m_tnmc_vitri;
                cmd.Parameters.Add("m_tnmc_luon", NpgsqlDbType.Numeric).Value = m_tnmc_luon;
                cmd.Parameters.Add("m_tetung", NpgsqlDbType.Numeric).Value = m_tetung;
                cmd.Parameters.Add("m_nach", NpgsqlDbType.Numeric).Value = m_nach;
                cmd.Parameters.Add("m_cobac", NpgsqlDbType.Numeric).Value = m_cobac;
                cmd.Parameters.Add("m_khac", NpgsqlDbType.Numeric).Value = m_khac;
                cmd.Parameters.Add("m_ttc", NpgsqlDbType.Numeric).Value = m_ttc;
                cmd.Parameters.Add("m_tieu", NpgsqlDbType.Numeric).Value = m_tieu;
                cmd.Parameters.Add("m_daday", NpgsqlDbType.Numeric).Value = m_daday;
                cmd.Parameters.Add("m_cvp", NpgsqlDbType.Numeric).Value = m_cvp;
                cmd.Parameters.Add("m_cvp_vitri", NpgsqlDbType.Text, 50).Value = m_cvp_vitri;
                cmd.Parameters.Add("m_cvp_dosau", NpgsqlDbType.Numeric).Value = m_cvp_dosau;
                cmd.Parameters.Add("m_abp", NpgsqlDbType.Numeric).Value = m_abp;
                cmd.Parameters.Add("m_abp_vitri", NpgsqlDbType.Text, 50).Value = m_abp_vitri;
                cmd.Parameters.Add("m_iv", NpgsqlDbType.Numeric).Value = m_iv;
                cmd.Parameters.Add("m_iv_vitri", NpgsqlDbType.Text, 50).Value = m_iv_vitri;
                cmd.Parameters.Add("m_mar", NpgsqlDbType.Numeric).Value = m_mar;
                cmd.Parameters.Add("m_mar_lieu", NpgsqlDbType.Text, 50).Value = m_mar_lieu;
                cmd.Parameters.Add("m_mar_dd", NpgsqlDbType.Numeric).Value = m_mar_dd;
                cmd.Parameters.Add("m_mar_cd", NpgsqlDbType.Numeric).Value = m_mar_cd;
                cmd.Parameters.Add("m_fen", NpgsqlDbType.Numeric).Value = m_fen;
                cmd.Parameters.Add("m_fen_lieu", NpgsqlDbType.Text, 50).Value = m_fen_lieu;
                cmd.Parameters.Add("m_fen_dd", NpgsqlDbType.Numeric).Value = m_fen_dd;
                cmd.Parameters.Add("m_fen_cd", NpgsqlDbType.Numeric).Value = m_fen_cd;
                cmd.Parameters.Add("m_lid", NpgsqlDbType.Numeric).Value = m_lid;
                cmd.Parameters.Add("m_lid_lieu", NpgsqlDbType.Text, 50).Value = m_lid_lieu;
                cmd.Parameters.Add("m_lid_dd", NpgsqlDbType.Numeric).Value = m_lid_dd;
                cmd.Parameters.Add("m_lid_cd", NpgsqlDbType.Numeric).Value = m_lid_cd;
                cmd.Parameters.Add("m_bomdien", NpgsqlDbType.Numeric).Value = m_bomdien;
                cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text, 1000).Value = m_ghichu;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_gayme (id,idthuchien,ngay,diung,tenpt,nhommau,cannang,ptv,bsgmhs,";
                    sql += "ktvgm,asa,mallampati,tuthe,dau,sankhoa,modetho,nkq,npq,so,dosau,baloon,thuong,loxo,mieng,";
                    sql += "mui,mtq,mtq_so,mtq_dosau,mtq_baloon,classic,seal,tienme,metm,tts,tts_tt,tts_vitri,tts_so,";
                    sql += "tnmc,tnmc_tt,tnmc_vitri,tnmc_luon,tetung,nach,cobac,khac,ttc,tieu,daday,cvp,cvp_vitri,";
                    sql += "cvp_dosau,abp,abp_vitri,iv,iv_vitri,mar,mar_lieu,mar_dd,mar_cd,fen,fen_lieu,fen_dd,fen_cd,";
                    sql += "lid,lid_lieu,lid_dd,lid_cd,bomdien,ghichu,userid) values ";
                    sql += "(:m_id,:m_idthuchien,to_date(:m_ngay,'dd/mm/yyyy'),:m_diung,:m_tenpt,:m_nhommau,:m_cannang,";
                    sql += ":m_ptv,:m_bsgmhs,:m_ktvgm,:m_asa,:m_mallampati,:m_tuthe,:m_dau,:m_sankhoa,:m_modetho,:m_nkq,";
                    sql += ":m_npq,:m_so,:m_dosau,:m_baloon,:m_thuong,:m_loxo,:m_mieng,:m_mui,:m_mtq,:m_mtq_so,";
                    sql += ":m_mtq_dosau,:m_mtq_baloon,:m_classic,:m_seal,:m_tienme,:m_metm,:m_tts,:m_tts_tt,";
                    sql += ":m_tts_vitri,:m_tts_so,:m_tnmc,:m_tnmc_tt,:m_tnmc_vitri,:m_tnmc_luon,:m_tetung,:m_nach,";
                    sql += ":m_cobac,:m_khac,:m_ttc,:m_tieu,:m_daday,:m_cvp,:m_cvp_vitri,:m_cvp_dosau,:m_abp,";
                    sql += ":m_abp_vitri,:m_iv,:m_iv_vitri,:m_mar,:m_mar_lieu,:m_mar_dd,:m_mar_cd,:m_fen,:m_fen_lieu,";
                    sql += ":m_fen_dd,:m_fen_cd,:m_lid,:m_lid_lieu,:m_lid_dd,:m_lid_cd,:m_bomdien,:m_ghichu,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 10).Value = m_ngay;
                    cmd.Parameters.Add("m_diung", NpgsqlDbType.Text, 254).Value = m_diung;
                    cmd.Parameters.Add("m_tenpt", NpgsqlDbType.Text, 254).Value = m_tenpt;
                    cmd.Parameters.Add("m_nhommau", NpgsqlDbType.Numeric).Value = m_nhommau;
                    cmd.Parameters.Add("m_cannang", NpgsqlDbType.Numeric).Value = m_cannang;
                    cmd.Parameters.Add("m_ptv", NpgsqlDbType.Varchar, 4).Value = m_ptv;
                    cmd.Parameters.Add("m_bsgmhs", NpgsqlDbType.Varchar, 4).Value = m_bsgmhs;
                    cmd.Parameters.Add("m_ktvgm", NpgsqlDbType.Varchar, 4).Value = m_ktvgm;
                    cmd.Parameters.Add("m_asa", NpgsqlDbType.Varchar, 3).Value = m_asa;
                    cmd.Parameters.Add("m_mallampati", NpgsqlDbType.Varchar, 3).Value = m_mallampati;
                    cmd.Parameters.Add("m_tuthe", NpgsqlDbType.Numeric).Value = m_tuthe;
                    cmd.Parameters.Add("m_dau", NpgsqlDbType.Numeric).Value = m_dau;
                    cmd.Parameters.Add("m_sankhoa", NpgsqlDbType.Numeric).Value = m_sankhoa;
                    cmd.Parameters.Add("m_modetho", NpgsqlDbType.Numeric).Value = m_modetho;
                    cmd.Parameters.Add("m_nkq", NpgsqlDbType.Numeric).Value = m_nkq;
                    cmd.Parameters.Add("m_npq", NpgsqlDbType.Numeric).Value = m_npq;
                    cmd.Parameters.Add("m_so", NpgsqlDbType.Numeric).Value = m_so;
                    cmd.Parameters.Add("m_dosau", NpgsqlDbType.Numeric).Value = m_dosau;
                    cmd.Parameters.Add("m_baloon", NpgsqlDbType.Numeric).Value = m_baloon;
                    cmd.Parameters.Add("m_thuong", NpgsqlDbType.Numeric).Value = m_thuong;
                    cmd.Parameters.Add("m_loxo", NpgsqlDbType.Numeric).Value = m_loxo;
                    cmd.Parameters.Add("m_mieng", NpgsqlDbType.Numeric).Value = m_mieng;
                    cmd.Parameters.Add("m_mui", NpgsqlDbType.Numeric).Value = m_mui;
                    cmd.Parameters.Add("m_mtq", NpgsqlDbType.Numeric).Value = m_mtq;
                    cmd.Parameters.Add("m_mtq_so", NpgsqlDbType.Numeric).Value = m_mtq_so;
                    cmd.Parameters.Add("m_mtq_dosau", NpgsqlDbType.Numeric).Value = m_mtq_dosau;
                    cmd.Parameters.Add("m_mtq_baloon", NpgsqlDbType.Numeric).Value = m_mtq_baloon;
                    cmd.Parameters.Add("m_classic", NpgsqlDbType.Numeric).Value = m_classic;
                    cmd.Parameters.Add("m_seal", NpgsqlDbType.Numeric).Value = m_seal;
                    cmd.Parameters.Add("m_tienme", NpgsqlDbType.Numeric).Value = m_tienme;
                    cmd.Parameters.Add("m_metm", NpgsqlDbType.Numeric).Value = m_metm;
                    cmd.Parameters.Add("m_tts", NpgsqlDbType.Numeric).Value = m_tts;
                    cmd.Parameters.Add("m_tts_tt", NpgsqlDbType.Text, 50).Value = m_tts_tt;
                    cmd.Parameters.Add("m_tts_vitri", NpgsqlDbType.Text, 50).Value = m_tts_vitri;
                    cmd.Parameters.Add("m_tts_so", NpgsqlDbType.Numeric).Value = m_tts_so;
                    cmd.Parameters.Add("m_tnmc", NpgsqlDbType.Numeric).Value = m_tnmc;
                    cmd.Parameters.Add("m_tnmc_tt", NpgsqlDbType.Text, 50).Value = m_tnmc_tt;
                    cmd.Parameters.Add("m_tnmc_vitri", NpgsqlDbType.Text, 50).Value = m_tnmc_vitri;
                    cmd.Parameters.Add("m_tnmc_luon", NpgsqlDbType.Numeric).Value = m_tnmc_luon;
                    cmd.Parameters.Add("m_tetung", NpgsqlDbType.Numeric).Value = m_tetung;
                    cmd.Parameters.Add("m_nach", NpgsqlDbType.Numeric).Value = m_nach;
                    cmd.Parameters.Add("m_cobac", NpgsqlDbType.Numeric).Value = m_cobac;
                    cmd.Parameters.Add("m_khac", NpgsqlDbType.Numeric).Value = m_khac;
                    cmd.Parameters.Add("m_ttc", NpgsqlDbType.Numeric).Value = m_ttc;
                    cmd.Parameters.Add("m_tieu", NpgsqlDbType.Numeric).Value = m_tieu;
                    cmd.Parameters.Add("m_daday", NpgsqlDbType.Numeric).Value = m_daday;
                    cmd.Parameters.Add("m_cvp", NpgsqlDbType.Numeric).Value = m_cvp;
                    cmd.Parameters.Add("m_cvp_vitri", NpgsqlDbType.Text, 50).Value = m_cvp_vitri;
                    cmd.Parameters.Add("m_cvp_dosau", NpgsqlDbType.Numeric).Value = m_cvp_dosau;
                    cmd.Parameters.Add("m_abp", NpgsqlDbType.Numeric).Value = m_abp;
                    cmd.Parameters.Add("m_abp_vitri", NpgsqlDbType.Text, 50).Value = m_abp_vitri;
                    cmd.Parameters.Add("m_iv", NpgsqlDbType.Numeric).Value = m_iv;
                    cmd.Parameters.Add("m_iv_vitri", NpgsqlDbType.Text, 50).Value = m_iv_vitri;
                    cmd.Parameters.Add("m_mar", NpgsqlDbType.Numeric).Value = m_mar;
                    cmd.Parameters.Add("m_mar_lieu", NpgsqlDbType.Text, 50).Value = m_mar_lieu;
                    cmd.Parameters.Add("m_mar_dd", NpgsqlDbType.Numeric).Value = m_mar_dd;
                    cmd.Parameters.Add("m_mar_cd", NpgsqlDbType.Numeric).Value = m_mar_cd;
                    cmd.Parameters.Add("m_fen", NpgsqlDbType.Numeric).Value = m_fen;
                    cmd.Parameters.Add("m_fen_lieu", NpgsqlDbType.Text, 50).Value = m_fen_lieu;
                    cmd.Parameters.Add("m_fen_dd", NpgsqlDbType.Numeric).Value = m_fen_dd;
                    cmd.Parameters.Add("m_fen_cd", NpgsqlDbType.Numeric).Value = m_fen_cd;
                    cmd.Parameters.Add("m_lid", NpgsqlDbType.Numeric).Value = m_lid;
                    cmd.Parameters.Add("m_lid_lieu", NpgsqlDbType.Text, 50).Value = m_lid_lieu;
                    cmd.Parameters.Add("m_lid_dd", NpgsqlDbType.Numeric).Value = m_lid_dd;
                    cmd.Parameters.Add("m_lid_cd", NpgsqlDbType.Numeric).Value = m_lid_cd;
                    cmd.Parameters.Add("m_bomdien", NpgsqlDbType.Numeric).Value = m_bomdien;
                    cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text, 1000).Value = m_ghichu;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_gayme");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_ba_gaymect(string m_ngay, decimal m_id, int m_ma, string m_ten, string m_c01, string m_c02, string m_c03,
            string m_c04, string m_c05, string m_c06, string m_c11, string m_c12, string m_c13, string m_c14,
            string m_c15, string m_c16, string m_c21, string m_c22, string m_c23, string m_c24, string m_c25,
            string m_c26, string m_c31, string m_c32, string m_c33, string m_c34)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_gaymect set ten=:m_ten,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,c05=:m_c05,c06=:m_c06,";
            sql += "c11=:m_c11,c12=:m_c12,c13=:m_c13,c14=:m_c14,c15=:m_c15,c16=:m_c16,c21=:m_c21,c22=:m_c22,";
            sql += "c23=:m_c23,c24=:m_c24,c25=:m_c25,c26=:m_c26,c31=:m_c31,c32=:m_c32,c33=:m_c33,c34=:m_c34";
            sql += " where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text, 254).Value = m_ten;
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Text, 20).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Text, 20).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Text, 20).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Text, 20).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Text, 20).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Text, 20).Value = m_c06;
                cmd.Parameters.Add("m_c11", NpgsqlDbType.Text, 20).Value = m_c11;
                cmd.Parameters.Add("m_c12", NpgsqlDbType.Text, 20).Value = m_c12;
                cmd.Parameters.Add("m_c13", NpgsqlDbType.Text, 20).Value = m_c13;
                cmd.Parameters.Add("m_c14", NpgsqlDbType.Text, 20).Value = m_c14;
                cmd.Parameters.Add("m_c15", NpgsqlDbType.Text, 20).Value = m_c15;
                cmd.Parameters.Add("m_c16", NpgsqlDbType.Text, 20).Value = m_c16;
                cmd.Parameters.Add("m_c21", NpgsqlDbType.Text, 20).Value = m_c21;
                cmd.Parameters.Add("m_c22", NpgsqlDbType.Text, 20).Value = m_c22;
                cmd.Parameters.Add("m_c23", NpgsqlDbType.Text, 20).Value = m_c23;
                cmd.Parameters.Add("m_c24", NpgsqlDbType.Text, 20).Value = m_c24;
                cmd.Parameters.Add("m_c25", NpgsqlDbType.Text, 20).Value = m_c25;
                cmd.Parameters.Add("m_c26", NpgsqlDbType.Text, 20).Value = m_c26;
                cmd.Parameters.Add("m_c31", NpgsqlDbType.Text, 20).Value = m_c31;
                cmd.Parameters.Add("m_c32", NpgsqlDbType.Text, 20).Value = m_c32;
                cmd.Parameters.Add("m_c33", NpgsqlDbType.Text, 20).Value = m_c33;
                cmd.Parameters.Add("m_c34", NpgsqlDbType.Text, 20).Value = m_c34;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_gaymect (id,ma,ten,c01,c02,c03,c04,c05,c06,c11,c12,c13,c14,c15,c16,c21,c22,c23,c24,c25,c26,c31,c32,c33,c34) values (:m_id,:m_ma,:m_ten,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c11,:m_c12,:m_c13,:m_c14,:m_c15,:m_c16,:m_c21,:m_c22,:m_c23,:m_c24,:m_c25,:m_c26,:m_c31,:m_c32,:m_c33,:m_c34)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text, 254).Value = m_ten;
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Text, 20).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Text, 20).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Text, 20).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Text, 20).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Text, 20).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Text, 20).Value = m_c06;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Text, 20).Value = m_c11;
                    cmd.Parameters.Add("m_c12", NpgsqlDbType.Text, 20).Value = m_c12;
                    cmd.Parameters.Add("m_c13", NpgsqlDbType.Text, 20).Value = m_c13;
                    cmd.Parameters.Add("m_c14", NpgsqlDbType.Text, 20).Value = m_c14;
                    cmd.Parameters.Add("m_c15", NpgsqlDbType.Text, 20).Value = m_c15;
                    cmd.Parameters.Add("m_c16", NpgsqlDbType.Text, 20).Value = m_c16;
                    cmd.Parameters.Add("m_c21", NpgsqlDbType.Text, 20).Value = m_c21;
                    cmd.Parameters.Add("m_c22", NpgsqlDbType.Text, 20).Value = m_c22;
                    cmd.Parameters.Add("m_c23", NpgsqlDbType.Text, 20).Value = m_c23;
                    cmd.Parameters.Add("m_c24", NpgsqlDbType.Text, 20).Value = m_c24;
                    cmd.Parameters.Add("m_c25", NpgsqlDbType.Text, 20).Value = m_c25;
                    cmd.Parameters.Add("m_c26", NpgsqlDbType.Text, 20).Value = m_c26;
                    cmd.Parameters.Add("m_c31", NpgsqlDbType.Text, 20).Value = m_c31;
                    cmd.Parameters.Add("m_c32", NpgsqlDbType.Text, 20).Value = m_c32;
                    cmd.Parameters.Add("m_c33", NpgsqlDbType.Text, 20).Value = m_c33;
                    cmd.Parameters.Add("m_c34", NpgsqlDbType.Text, 20).Value = m_c34;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_gaymect");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_ba_gaymethuoc(string m_ngay, decimal m_id, int m_ma, string m_ten)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_gaymethuoc set ten=:m_ten where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text, 254).Value = m_ten;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_gaymethuoc (id,ma,ten) values (:m_id,:m_ma,:m_ten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text, 254).Value = m_ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_gaymethuoc");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_ba_gaymehinh(string m_ngay, decimal m_id, decimal m_idgayme, int m_stt, byte[] m_image)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".ba_gaymehinh set idgayme=:m_idgayme,stt=:m_stt,image=:m_image where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_idgayme", NpgsqlDbType.Numeric).Value = m_idgayme;
                cmd.Parameters.Add("m_image", NpgsqlDbType.Bytea, m_image.Length).Value = m_image;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_gaymehinh (id,idgayme,stt,image) values (:m_id,:m_idgayme,:m_stt,:m_image)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_idgayme", NpgsqlDbType.Numeric).Value = m_idgayme;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_image", NpgsqlDbType.Bytea, m_image.Length).Value = m_image;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_gaymehinh");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public decimal get_mabns(int yy, int loai, int userid)
        {
            int ma = 0;
            ds = get_data("select stt from " + user + ".capmabns where yy=" + yy + " and loai=" + loai + " and userid=" + userid + " and computer=" + iRownum + " order by stt");
            if (ds.Tables[0].Rows.Count > 0) ma = int.Parse(ds.Tables[0].Rows[0]["stt"].ToString());
            return ma;
        }

        public void upd_mabns(int m_yy, int m_loai, int m_userid, decimal m_stt)
        {
            sql = "update " + user + ".capmabns set computer=" + iRownum + " where yy=:m_yy and loai=:m_loai and userid=:m_userid and stt=:m_stt";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            con.Open();
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;
            cmd.Parameters.Add("m_yy", NpgsqlDbType.Numeric).Value = m_yy;
            cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
            cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
            cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
            int irec = cmd.ExecuteNonQuery();
            cmd.Dispose();
            if (irec == 0)
            {
                sql = "insert into " + user + ".capmabns(yy,stt,loai,userid,computer) values (:m_yy,:m_stt,:m_loai,:m_userid," + iRownum + ")";
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_yy", NpgsqlDbType.Numeric).Value = m_yy;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            con.Close(); con.Dispose();
        }
        public void del_mabns(int yy, int loai, int userid, decimal stt)
        {
            execute_data("delete from " + user + ".capmabns where yy=" + yy + " and loai=" + loai + " and userid=" + userid + " and stt=" + stt);
        }

        public void tao_schema_emr(string m_mmyy, int m_userid)
        {
            return;
            if (m_mmyy.IndexOf("/") != -1)
            {
                System.Windows.Forms.MessageBox.Show("Tháng / năm " + m_mmyy + " không hợp lệ !", Msg);
                return;
            }
            if (bMmyy(m_mmyy))
            {
                string usr = userid;
                schema = usr + m_mmyy;

                sql = "";
                sql += "CREATE TABLE " + schema + ".bask_chiso(  mabn text,  maql numeric NOT NULL,  ngay timestamp without time zone DEFAULT now(),  mantinh text,   namvien text,  pttt text,  chanthuong text,  para text,  docthan numeric(1),  kinhnguyet text,   sankhoa text,  phukhoa text,  ruou numeric(1),  thuocla numeric(1),  diung numeric(1),  tendiung text,  viemgana numeric(1),  viemganb numeric(1),  khac text,  soi numeric(1),  viennao numeric(1),  lao numeric(1),  uonvan numeric(1),  bachhau numeric(1),  cum numeric(1),  userid numeric(5),  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_bask_chiso PRIMARY KEY (maql)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".bask_chiso OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".bask_donvi( mabn text,  maql numeric NOT NULL,  madonvi numeric,  mach numeric(3),  huyetap text,  cannang numeric(7),  chieucao numeric(7),  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_bask_donvi PRIMARY KEY (maql)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".bask_donvi OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".bask_mat(  mavaovien numeric,  maql numeric NOT NULL,  ngay timestamp without time zone DEFAULT now(),  makp text,   tlcp text,  tlct text,  tlkp text,  tlkt text,  truoc text,  sau text,  nhanapp text,  nhanapt text,  khac text,  mabs text,  userid numeric(5),  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_bask_mat PRIMARY KEY (maql)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".bask_mat OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".bask_ngkhoa(  mavaovien numeric,  maql numeric NOT NULL,  ngay timestamp without time zone DEFAULT now(),  makp text,   tongquat text,  chanthuong text,  dalieu text,  khac text,  mabs text,  userid numeric(5),  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_bask_ngkhoa PRIMARY KEY (maql)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".bask_ngkhoa OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".bask_noikhoa(  mavaovien numeric,  maql numeric NOT NULL,  ngay timestamp without time zone DEFAULT now(),  makp text,   timmach text,  hohap text,  tieuhoa text,  than text,  thankinh text,  khac text,  mabs text,  userid numeric(5),  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_bask_noikhoa PRIMARY KEY (maql)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".bask_noikhoa OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".bask_rhm(  mavaovien numeric,  maql numeric NOT NULL,  ngay timestamp without time zone DEFAULT now(),  makp text,   image bytea[],  nhanxet text,  khac text,  mabs text,  userid numeric(5),  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_bask_rhm PRIMARY KEY (maql)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".bask_rhm OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".bask_sanphu(  mavaovien numeric,  maql numeric NOT NULL,  ngay timestamp without time zone DEFAULT now(),  makp text,   san text,  phu text,  khac text,  mabs text,  userid numeric(5),  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_bask_sanphu PRIMARY KEY (maql)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".bask_sanphu OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".bask_tmh(  mavaovien numeric,  maql numeric NOT NULL,  ngay timestamp without time zone DEFAULT now(),  makp text,   tai text,  mui text,  hong text,  thanhquan text,  daumatco text,  khac text,  mabs text,  userid numeric(5),  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_bask_tmh PRIMARY KEY (maql)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".bask_tmh OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".bask_tongket(  mavaovien numeric,  maql numeric NOT NULL,  ngay timestamp without time zone DEFAULT now(),  makp text,   nhanxet text,  ketluan text,  phanloai numeric(2),  denghi text,  khac text,  mabs text,  lanin numeric(3),  userid numeric(5),  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_bask_tongket PRIMARY KEY (maql)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".bask_tongket OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".bavv_chung(  maql numeric NOT NULL,  lydo text,   hb_benhly text,  hb_banthan text,  hb_giadinh text,  kb_toanthan text,  kb_bophan text,  kb_tomtat text,  kb_xuly text,  kb_chuy text,  sobo text,  phanbiet text,	    userid numeric(5),  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_bavv_chung PRIMARY KEY (maql)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".bavv_chung OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".bavv_dausinhton(  maql numeric NOT NULL,  mach numeric(3),   nhietdo numeric(5),  huyetap text,  nhiptho numeric(3),  cannang numeric(7),  chieucao numeric(5),  CONSTRAINT pk_bavv_dausinhton PRIMARY KEY (maql)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".bavv_dausinhton OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".bavv_khamthai(  id numeric NOT NULL,  maql numeric,  ngay timestamp without time zone DEFAULT now(),   tuoithai numeric(3),  cannang numeric(7),  huyetap text,  phu numeric(1),  bctc text,  thaimay text,  timthai text,  ngoithai text,  ctc text,  tim text,  phoi text,	    khac text,  ketluan text,  cls text,  xutri text,  mabs text,  userid numeric(5),  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_bavv_khamthai PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".bavv_khamthai OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".bavv_mat(  maql numeric NOT NULL,  kb_mat text,   tlkk_mp text,  tlkk_mt text,  tlck_mp text,  tlck_mt text,  na_mp text,  na_mt text,  CONSTRAINT pk_bavv_mat PRIMARY KEY (maql)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".bavv_mat OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".bavv_phukhoa(  mavaovien numeric,  maql numeric NOT NULL,  lydokham text,  giadinh text,  diung text,  buouco numeric(1),  tieuduong numeric(1),  timmach numeric(1),  lao numeric(1),  khac text,  ngoaikhoa text,  chuky numeric(2),  tinhchat numeric(1),  songay numeric(2),  luongkinh numeric(1),  thongkinh numeric(1),  kinhnam text,  chongnam text,  kh_vong numeric(1),  kh_thuoc numeric(1),  kh_baocs numeric(1), kh_khac numeric(1),  phukhoa text,  vmcngay timestamp without time zone,  lydo text,  taibv text,  ptkhac text,  para text,  connang numeric(5),  namsinh text,  taibien text,  phu numeric(1),  nieu text,  tim text,  phoi text,  kb_khac text,  kinhcc timestamp without time zone,  benhly text,  khamngoai text,  movit text,  amdao text,  xuly text,  userid numeric(5),  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_bavv_phukhoa PRIMARY KEY (maql)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".bavv_phukhoa OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".bavv_rhm(  maql numeric NOT NULL,  image bytea[],   nhanxet text,  chandoan text,  CONSTRAINT pk_bavv_rhm PRIMARY KEY (maql)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".bavv_rhm OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".bavv_sankhoa(  maql numeric NOT NULL,  lydokham text,   giadinh text,  diung text,  buouco numeric(1),  tieuduong numeric(1),  timmach numeric(1),  lao numeric(1),  khac text,  ngoaikhoa text,  chuky numeric(2),  tinhchat numeric(1),  songay numeric(2),  luongkinh numeric(1),  thongkinh numeric(1),  kinhnam text,  chongnam text,  kh_vong numeric(1),  kh_thuoc numeric(1),  kh_baocs numeric(1),  kh_khac numeric(1),  phukhoa text,  vmcngay timestamp without time zone,  lydo text,  taibv text,  ptkhac text,  para text,  connang numeric(5),  namsinh text,  taibien text,  phu numeric(1),  nieu text,  tim text,  phoi text,  kb_khac text,  kinhcc timestamp without time zone,  ngaysanh timestamp without time zone,  thanhbung text,  vmc text,  caotc text,  dangtc text,  timthai numeric(3),  amho text,  tangsinhmon text,  cotc text,  tinhtrangoi numeric(1),  oiluc timestamp without time zone,  mauoi text,  nuocoi text,  ngoithai text,  kieuthe text,  dolot numeric(1),  khungchau text,  xuly text,  userid numeric(5),  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_bavv_sankhoa PRIMARY KEY (maql)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".bavv_sankhoa OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".bavv_tmh(  mavaovien numeric,  maql numeric NOT NULL,  tai text,   mui text,  hong text,  kham text,  image1 bytea[],  image2 bytea[],  image3 bytea[],  image4 bytea[],  CONSTRAINT pk_bavv_tmh PRIMARY KEY (maql)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".bavv_tmh OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".bavv_tmhct(  maql numeric NOT NULL,  stt numeric(2) NOT NULL,   taip text,  tait text,  CONSTRAINT pk_bavv_tmhct PRIMARY KEY (maql)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".bavv_tmhct OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_camdoan(  id numeric NOT NULL,  idthuchien numeric,  ngay timestamp without time zone DEFAULT now(),  hoten text,   tuoi numeric(3),  phai text,  dantoc text,  nghenghiep text,  ngoaikieu text,  diachi text,  noilam text,  nguoinha text,  dongy numeric(1),  image bytea[],  ghichu text,  userid numeric(5),  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_ba_camdoan PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_camdoan OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_chamsoc(  id numeric NOT NULL,  idthuchien numeric,  ngay timestamp without time zone DEFAULT now(),  sophieu numeric(7),  mach numeric(3),  huyetap text,  nhietdo numeric(5),  nhiptho numeric(3),  dienbien text,  ylenh text,  yta text,  userid numeric(5),  iddieutri numeric,  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_ba_chamsoc PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_chamsoc OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_chamsocct(  id numeric NOT NULL,  stt numeric(3),  loai numeric(2),  noidung text,   ghichu text,  thuchien text,  CONSTRAINT pk_ba_chamsocct PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_chamsocct OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_chung(  id numeric NOT NULL,  idthuchien numeric,  lydo text,  lanthu numeric(3),  hb_benhly text,  bh_banthan text,  hb_giadinh text,  kb_toanthan text,  kb_ngoai text,  kb_tuanhoan text,  kb_hohap text,  kb_tieuhoa text,  kb_than text,  kb_thankinh text,  kb_co text,  kb_tmh text,  kb_rhm text,  kb_mat text,  kb_noitiet text,  kb_khac text,  kb_tomtat text,  phanbiet text,  tienluong text,  dieutri text,  bslban text,  tk_benhly text,  tk_tomtat text,   tk_phuongphap text,  tk_tinhtrang text,  tk_dieutri text,  nguoigiao text,  nguoinhan text,  mabs text,  userid numeric(5),  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_ba_chung PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_chung OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_chuyenbenh(  id numeric NOT NULL,  idthuchien numeric,  ngay timestamp without time zone DEFAULT now(),  thannhan text,  taisan text,  ngayvv timestamp without time zone,  ngaycv timestamp without time zone,  tu text,  den text,  mabs text,  lydo text,  cd_noikhoa text,  cd_ngoaikhoa text,  cd_khac text,  tongtrang text,  giaotiep text,  chedoan text,  vesinh text,  baitiet text,  vandong text,  trilieu text,  cachly text,  oxy text,  luuthong text,  loai text,  khidung text,  vetthuong text,  thaybang numeric(3),  ngoaibien numeric(1),  ngoaibien_vt text,  trungtam numeric(1),  trungtam_vt text,  thongtieu numeric(1),  thongtieu_vt text,  vanmach text,  khangdong text,  anthan text,  dichtruyen text,  mau text,  khac text,  bangiaokhac text,  yta text,  userid numeric(5),  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_ba_chuyenbenh PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_chuyenbenh OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_chuyenbenhct(  id numeric NOT NULL,  stt numeric(3),  ten text,  vitri text,  CONSTRAINT pk_ba_chuyenbenhct PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_chuyenbenhct OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_danhgia1(  id numeric NOT NULL,  idthuchien numeric,  ngay timestamp without time zone DEFAULT now(),  thuoc text,   thuoc_k numeric(1),  cannang numeric(7,2),  chieucao numeric(5),  mach numeric(3),  nhietdo numeric(5,2),  huyatap text,  nhiptho numeric(3),  diung text,  diung_k numeric(1),  tm text,  tm_k numeric(1),  tm_1 numeric(1),  tm_2 numeric(1),  tm_3 numeric(1),  tm_4 numeric(1),  tm_5 numeric(1),  tm_6 numeric(1),  tm_7 numeric(1),  hh text,  hh_k numeric(1),  hh_1 numeric(1),  hh_2 numeric(1),  hh_3 numeric(1),  hh_4 numeric(1),  hh_5 numeric(1),  hh_6 numeric(1),  hh_7 numeric(1),  than text,  than_k numeric(1),  than_1 numeric(1),  than_2 numeric(1),  than_3 numeric(1),  than_4 numeric(1),  CONSTRAINT pk_ba_danhgia1 PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_danhgia1 OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_danhgia2(  id2 numeric NOT NULL,  noitiet text,   noitiet_k numeric(1),  noitiet_1 numeric(1),  noitiet_2 numeric(1),  noitiet_3 numeric(1),  noitiet_4 numeric(1),  noitiet_5 numeric(1),  noitiet_6 numeric(1),  tieuhoa text,  tieuhoa_k numeric(1),  tieuhoa_1 numeric(1),  tieuhoa_2 numeric(1),  tieuhoa_3 numeric(1),  tieuhoa_4 numeric(1),  tieuhoa_5 numeric(1),  tieuhoa_6 numeric(1),  tieuhoa_7 numeric(1),  thankinh text,  thankinh_k numeric(1),  thankinh_1 numeric(1),  thankinh_2 numeric(1),  thankinh_3 numeric(1),  thankinh_4 numeric(1),  huyethoc text,  huyethoc_k numeric(1),  huyethoc_1 numeric(1),  huyethoc_2 numeric(1),  huyethoc_3 numeric(1),  CONSTRAINT pk_ba_danhgia2 PRIMARY KEY (id2)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_danhgia2 OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_danhgia3(  id3 numeric NOT NULL,  lamsang text,   kham text,  kham_1 numeric(1),  kham_2 numeric(1),  kham_3 numeric(1),  kham_4 numeric(1),  kham_5 numeric(1),  xn text,  cls text,  luuy text,  asa text,  thaoluan_1 numeric(1),  thaoluan_2 numeric(1),  thaoluan_3 numeric(1),  thaoluan_4 numeric(1),  thaoluan_5 numeric(1),  kehoach text,  mabs text,  userid numeric(5),  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_ba_danhgia3 PRIMARY KEY (id3)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_danhgia3 OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_dbchuyenda(  id numeric NOT NULL,  idthuchien numeric,  ngay timestamp without time zone,  mach numeric(3),  huyetap text,  nhietdo numeric(5,2),  nhiptho numeric(3),  timthai numeric(3),  tucung text,  mo numeric(3),  xoa numeric(3),  tinhtrangoi numeric(1),  ngoithai text,  dolot text,  tienluong text,  xutri text,  theodoi text,  userid numeric(5),  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_ba_dbchuyenda PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_dbchuyenda OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_dieutri(  id numeric NOT NULL,  idthuchien numeric,  sophieu numeric(7),  ngay timestamp without time zone,  dienbien text,  ylenh text,  idylenh numeric,  chedoan numeric(3),  mabs text,  loai numeric(1),  sankhoa numeric,  done numeric(1),  userid numeric(5),  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_ba_dieutri PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_dieutri OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_dieutrict(  id numeric NOT NULL,  stt numeric(3),  loai numeric(2),  noidung text,  ghichu text,  thuchien text,  CONSTRAINT pk_ba_dieutrict PRIMARY KEY (id,stt)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_dieutrict OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_dongmachvanh(  id numeric NOT NULL,  stt numeric(3),  soluong numeric(5),  vitri text,  CONSTRAINT pk_ba_dongmachvanh PRIMARY KEY (id,stt)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_dongmachvanh OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_gayme(  id numeric NOT NULL,  idthuchien numeric,  ngay timestamp without time zone,  diung text,  tenpt text,  nhommau numeric(1),  cannang numeric(5,3),  ptv text,  bsgmhs text,  ktvgm text,  asa text,  mallampati text,  tuthe numeric(2),  dau numeric(2),  sankhoa numeric(1),  modetho numeric(2),  nkq numeric(1),  npq numeric(1),  so numeric(5),  dosau numeric(5),  baloon numeric(1),  thuong numeric(1),  loxo numeric(1),  mieng numeric(1),  mui numeric(1),  mtq numeric(1),  mtq_so numeric(5),  mtq_dosau numeric(5),  mtq_baloon numeric(1),  classic numeric(1),  seal numeric(1),  tienme numeric(1),  metm numeric(1),  tts numeric(1),  tts_tt text,  tts_vitri text,  tts_so numeric(5),  tnmc numeric(1),  tmnc_tt text,  tnmc_vitri text,  tnmc_luon numeric(5),  tetung numeric(1),  nach numeric(1),  cobac numeric(1),  khac numeric(1),  ttc numeric(1),  tieu numeric(1),  daday numeric(1),  cvp numeric(1),  cvp_vitri text,  cvp_dosau numeric(5),  abp numeric(1),  abp_vitri text,  iv numeric(1),  iv_vitri text,  mar numeric(1),  mar_lieu text,  mar_dd numeric(1),  mar_cd numeric(1),  fen numeric(1),  fen_lieu text,  fen_dd numeric(1),  fen_cd numeric(1),  lid numeric(1),  lid_lieu text,  lid_dd numeric(1),  lid_cd numeric(1),  bomdien numeric(1),  ghichu text,  userid numeric(5),  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_ba_gayme PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_gayme OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_gaymect(  id numeric NOT NULL,  ma numeric(3),  ten text,  c01 text,  c02 text,  c03 text,  c04 text,  c05 text,  c06 text,  c11 text,  c12 text,  c13 text,  c14 text,  c15 text,  c16 text,  c21 text,  c22 text,  c23 text,  c24 text,  c25 text,  c26 text,  c31 text,  c32 text,  c33 text,  c34 text,  CONSTRAINT pk_ba_gaymect PRIMARY KEY (id,ma)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_gaymect OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_gaymehinh(  id numeric NOT NULL,  idgayme numeric,  stt numeric(3),  image bytea[],  CONSTRAINT pk_ba_gaymehinh PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_gaymehinh OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_gaymethuoc(  id numeric NOT NULL,  ma numeric(1),  ten text,  CONSTRAINT pk_ba_gaymethuoc PRIMARY KEY (id,ma)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_gaymethuoc OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_giaonhan(  id numeric NOT NULL,  idthuchien numeric,  ngay timestamp without time zone,  trigiac text,  mach numeric(3),  nhietdo numeric(5,2),  huyetap text,  nhiptho numeric(3),  cannang numeric(7,2),  spo2 numeric(7,2),  camtay text,  yta text,  userid numeric(5),  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_ba_giaonhan PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_giaonhan OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_giaonhanct(  id numeric NOT NULL,  stt numeric(3),  soluong numeric(3),  loai text,  CONSTRAINT pk_ba_giaonhanct PRIMARY KEY (id,stt)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_giaonhanct OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_hausan(  id numeric NOT NULL,  idthuchien numeric,  ngay timestamp without time zone,  toantrang text,  mach numeric(3),  huyetap text,  nhietdo numeric(5,2),  nhiptho numeric(3),  tim text,  phoi text,  tucung text,  tangsinhmon numeric(1),  tinhchat numeric(2),  khac text,  ditieu numeric(1),  tc_ditieu text,  tieu numeric(1),  tc_tieu text,  sandich numeric(1),  tc_sandich numeric(1),  tresosinh text,  tienluong text,  xutri text,  theodoi text,  userid numeric(5),  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_ba_hausan PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_hausan OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_hausangan(  id numeric NOT NULL,  idthuchien numeric,  ngay timestamp without time zone,  toantrang text,  mach numeric(3),  huyetap text,  nhietdo numeric(5,2),  nhiptho numeric(3),  tim text,  phoi text,  tucung text,  tangsinhmon numeric(1),  tinhchat numeric(2),  khac text,  maumat numeric(5),  tresosinh text,  nuoctieu text,  tienluong text,  xutri text,  theodoi text,  userid numeric(5),  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_ba_hausangan PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_hausangan OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_hbdacdiem(  id numeric NOT NULL,  ma numeric(3),  thoigian text,  CONSTRAINT pk_ba_hbdacdiem PRIMARY KEY (id,ma)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_hbdacdiem OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_hinh(  id numeric NOT NULL, stt numeric(3),  image bytea[],  CONSTRAINT pk_ba_hinh PRIMARY KEY (id,stt)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_hinh OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_hoichan(  id numeric NOT NULL,  idthuchien numeric,  ngay timestamp without time zone,  ngaymo timestamp without time zone,  mamau text,  tenpt text,  thoigian text,  sonde numeric(3),  nhommau numeric(1),  rh numeric(1),  mau numeric(7),  xnkhac text,  ptdutru text,  ptchinh text,  ptphu text,  phuongphap numeric(2),  tuthe text,  xq numeric(1),  dungcu text,  khac text,  ykien text,  giamdoc text,  khth text,  gayme text,  bstruongk text,  ptv text,  userid numeric(5),  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_ba_hoichan PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_hoichan OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_hoichancc(  id numeric NOT NULL,  idthuchien numeric,  ngay timestamp without time zone,  ngaymo timestamp without time zone,  mamau text,  tenpt text,  nhommau numeric(1),  rh numeric(1),  mau numeric(7),  xnkhac text,  ptdutru text,  ptchinh text,  ptphu text,  phuongphap numeric(2),  tuthe text,  ykien text,  bstruongk text,  bstruong text,  ptv text,  tiensu text,  tim text,  phoi text,  tienluong text,  khac text,  cotsong text,  thankinh text,  anlancuoi text,  asa text,  glodmann text,  mallampati text,  bsgayme text,  bstruonggmhs text,   userid numeric(5),  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_ba_hoichancc PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_hoichancc OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_hoichanccxn(  id numeric NOT NULL,  ma numeric(3),  tinhtrang numeric(7,2),  CONSTRAINT pk_ba_hoichanccxn PRIMARY KEY (id,ma)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_hoichanccxn OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_hoichanthuoc(  id numeric NOT NULL,  idthuchien numeric,  ngay timestamp without time zone,  tu timestamp without time zone,  den timestamp without time zone,  mabs text,  thuky text,  thanhvien text,  tinhtrang numeric(1),  gan text,  sgot text,  sgpt text,  ure text,  creatimin text,  ion text,  ctm text,  tptnt text,  xq text,  vikhuan text,  ksd text,  thuoc text,  thaythe text,  lydo text,  userid numeric(5),  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_ba_hoichanthuoc PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_hoichanthuoc OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_hoichanxn(  id numeric NOT NULL,  ma numeric(3),  tinhtrang numeric(7,2),  CONSTRAINT pk_ba_hoichanxn PRIMARY KEY (id,ma)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_hoichanxn OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_kbdausinhton(  id numeric NOT NULL,  mach numeric(3),  nhietdo numeric(5,2),  huyetap text,  nhiptho numeric(3),  cannang numeric(7,2),  chieucao numeric(5),  CONSTRAINT pk_ba_kbdausinhton PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_kbdausinhton OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_khamtienme(  id numeric NOT NULL,  ngay timestamp without time zone,  mo text,   mete numeric(1),  taibien numeric(1),  truyenmau numeric(1),  diung text,  bieuhien text,  thuocla numeric(1),  ruou numeric(1),  matuy numeric(1),  caoha numeric(1),  thatnguc numeric(1),  nmct numeric(1),  suytim numeric(1), timbamsinh numeric(1),  lao numeric(1),  phequan numeric(1),  horamau numeric(1),  copd numeric(1),  hh_khac numeric(1),  tamthan numeric(1),  dongkinh numeric(1), tbmmn numeric(1),  buouco numeric(1),  maukdong numeric(1),  tieuduong numeric(1),  hethong numeric(1),  tk_khac numeric(1),  cauthan numeric(1),  suythan numeric(1),  soithan numeric(1),  tn_khac numeric(1),  vangda numeric(1),  viemgan numeric(1),  tieuhoa numeric(1),  thuongvi numeric(1),  th_khac numeric(1),  giadinh text,  chitiet text,  map numeric(1),  phu numeric(1),  hong numeric(1),  nhot numeric(1),  yeu numeric(1),  khotho numeric(1),  glasgow numeric(5),  mach numeric(3),  huyetap text,  nhietdo numeric(5,2),  nhiptho numeric(3),  cannang numeric(7,2),  chieucao numeric(5),  hanche numeric(1),  congan numeric(1),  luoito numeric(1),  khoiu numeric(1),  giap numeric(1),  cungham numeric(1),  seo numeric(1),  ranggia numeric(1),  tl_khac text,  timmach numeric(1),  hohap numeric(1),  than numeric(1),  k_tieuhoa numeric(1),  k_khac numeric(1),  gu numeric(1),  cungcotsong numeric(1),  cotsongcu numeric(1),  canlamsang text,  dieutri text,  denghi text,  asa text,  glodmann text,  mallampati text,  dukien text,  thuthuat text,  ketluan text,  mabs text,  tinhmach text,  tm_bt numeric(1),  tm_cha numeric(1),  tm_dtn numeric(1),  tm_ln numeric(1),  tm_khac text,  hh_bt numeric(1),  hh_copd numeric(1),  hh_suyen numeric(1),  k_hh_khac text,  nt_bt numeric(1),  nt_bg numeric(1),  nt_td numeric(1),  nt_khac text,  tk_bt numeric(1),  tk_yeu numeric(1),  k_tk_khac text,  cs_bt numeric(1),  cs_khac text,  CONSTRAINT pk_ba_khamtienme PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_khamtienme OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_kiemsoat(  id numeric NOT NULL,  idthuchien numeric,  ngay timestamp without time zone,  thuoc text,  tiembap numeric(1),  tiemtm numeric(1),  mach numeric(3),  huyetap text,  nhietdo numeric(5,2),  nhiptho numeric(3),  trigiac text,  nhanxet text,  ddtruong text,  ddpmo text,  ddphutrach text,  userid numeric(5),  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_ba_kiemsoat PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_kiemsoat OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_kiemsoatcc(  id numeric NOT NULL,  idthuchien numeric,  ngay timestamp without time zone,  nhanxet text,  ddtruong text,  ddpmo text,  ddphutrach text,  userid numeric(5),  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_ba_kiemsoatcc PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_kiemsoatcc OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_kiemsoatccct(  id numeric NOT NULL,  ma numeric(1),  cokhong numeric(1),  ghichu text,  CONSTRAINT pk_ba_kiemsoatccct PRIMARY KEY (id,ma)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_kiemsoatccct OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_kiemsoatct(  id numeric NOT NULL,  ma numeric(1),  cokhong numeric(1),  ghichu text,  CONSTRAINT pk_ba_kiemsoatct PRIMARY KEY (id,ma)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_kiemsoatct OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_linhmau(  id numeric NOT NULL,  idthuchien numeric,  sophieu text,  ngaylinh timestamp without time zone,  donvi text,  chepham text,  nhommau numeric(1),  lanthu numeric(3),  nguoilinh text,  bsdt text,  phongphat text,  bvphat text,  dvphat text,  ngayphat timestamp without time zone,  nguoiphat text,  truongkhoa text,  done numeric(1),  userid numeric(5),  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_ba_linhmau PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_linhmau OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_linhmauct(  id numeric NOT NULL,  stt numeric(3),  chepham text,  maso text,  nhommau numeric(1),  CONSTRAINT pk_ba_linhmauct PRIMARY KEY (id,stt)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_linhmauct OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_locmauct(  id numeric NOT NULL,  stt numeric(3),  ngay timestamp without time zone,  mach numeric(3),  huyetap text,  nhietdo numeric(5,2),  nhiptho numeric(3),  tocdo numeric(5),    dm text,  tm text,  sieuloc numeric(7),  taibien text,  thuoc text,  mabs text,  yta text,  CONSTRAINT pk_ba_locmauct PRIMARY KEY (id,stt)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_locmauct OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_locmaull(  id numeric NOT NULL,  idthuchien numeric,  ngaybd timestamp without time zone,  cantloc numeric(1),  rutnuoc numeric(5),  dichvamau numeric(5),  cansloc numeric(7,2),  fav numeric(1),  ttmd numeric(1),  mtct numeric(1),  tmdd numeric(1),  heparin numeric(1),  tlpt numeric(1),  lieudau text,  duytri text,  tonglieu text,  lientuc numeric(1),  cachquang numeric(1), khac text,   ngaykt timestamp without time zone,  mangloc text,  nhanhieu text,  dientich text,  heso text,  baoquan text,  landung numeric(5),  mabs text,  yta text,  userid numeric(5),  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_ba_locmaull PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_locmaull OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_nhi( id numeric NOT NULL,  conthu numeric(2),  para text,  tinhtrang numeric(1),  cannang numeric(5,2),  ditat numeric(1),  tenditat text,  tinhthan text,  vandong text,  benhlykhac text,  nuoiduong numeric(1),  caisua numeric(3),  vuontre numeric(1),  tainha numeric(1),  lao numeric(1),  bailiet numeric(1),  soi numeric(1),  hoga numeric(1),  uonvan numeric(1),  bachhau numeric(1),  tckhac numeric(1),  chuthe text,  chieucao numeric(5),  vongnguc numeric(5), vongdau numeric(5),  CONSTRAINT pk_ba_nhi PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_nhi OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_noikhoa(  id numeric NOT NULL,  chidinh numeric(2),  thoigian timestamp without time zone,  soluong numeric(5),  loai text,  thoidiem timestamp without time zone,  CONSTRAINT pk_ba_noikhoa PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_noikhoa OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_phukhoa(  id numeric NOT NULL,  kinhnam text,  tinhchat text,  chuky text,  songay numeric(2),  luongkinh text,  kinhcc timestamp without time zone,  daubung numeric(1),  thoigian numeric(1),  chongnam text,  hetkinh text,  dieutri text,  para text,  da text,  hach text,  vu text,  dauhieu text,  moilon text,  moinho text,  amvat text,  amho text,  mangtrinh text,  tangsinhmon text,  amdao text,  cotucung text,  thantucung text,  phanphu text,  cactui text,  CONSTRAINT pk_ba_phukhoa PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_phukhoa OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_puthuoc(  id numeric NOT NULL,  idthuchien numeric,  ngay timestamp without time zone,  ten text,  phuongphap text,  bscd text,  nguoithu text,  bsdoc text,  ketqua text,  userid numeric(5),  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_ba_puthuoc PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_puthuoc OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_sankhoa(  id numeric NOT NULL,  tungay timestamp without time zone,  denngay timestamp without time zone,  tuoithai numeric(5,2),  khamthai text,  uonvan numeric(1),  tiem numeric(3),  chuyenda timestamp without time zone,  dauhieu text,  bienchuyen text,  kinhnam text,  tinhchat text,  chuky numeric(2),  luongkinh text,  chongnam text,  dieutri text,  phu numeric(1),  ptcu numeric(1),  dangtc text,  tuthe text,  caotc numeric(3),  vongbung numeric(3),  cotc text,  timthai numeric(3),  vu text,  bishop numeric(5),  amho text,  amdao text,  sinhmon text,  tucung text,  phanphu text,  tinhtrangoi numeric(1),  voluc timestamp without time zone,  oivo numeric(1),  mausac text,  nuocoi text,  ngoi text,  the text,  kieu text,  dolot numeric(1),  have text,  deluc timestamp without time zone,  theodoi text,  chucdanh text,  rau numeric(1),  rauluc timestamp without time zone,  cachso text,  mang text,  mui text,  banhrau text,  raucannang numeric(5),  raucuon numeric(1),  raudai numeric(3),  chaymau numeric(1),  maumat numeric(5),  kiemsoattc numeric(1),  xuly text,  ngaysaude timestamp without time zone,  da text,  ppde numeric(1),  mach numeric(3),  nhietdo numeric(5,2),  huyetap text,  nhiptho numeric(3),  canthiep text,  tangsinhmon numeric(1),  loaichi text,  somui numeric(3),  cotucung numeric(1),  cao numeric(5),  CONSTRAINT pk_ba_sankhoa PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_sankhoa OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_scan(  id numeric NOT NULL,  stt numeric(5),  ngay timestamp without time zone,  nhom numeric(1),  loai numeric(3),  ten text,  image bytea[],  CONSTRAINT pk_ba_scan PRIMARY KEY (id,stt)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_scan OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_soket(  id numeric NOT NULL,  idthuchien numeric,  ngay timestamp without time zone,  dienbien text,  cls text,  dieutri text,  ketqua text,  tienluong text,  bstruong text,  mabs text,  userid numeric(5),  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_ba_soket PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_soket OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_sosinh(  id numeric NOT NULL,  oivo timestamp without time zone,  mausac text,  cachde numeric(1),  luc timestamp without time zone,  lydo text,  tinhtrang numeric(1),  mabs text,  apgar1 numeric(3),  apgar5 numeric(3),  apgar10 numeric(3),  cannang numeric(5),  sausinh text,  nguoichuyen text,  ditat numeric(1),  haumon numeric(1),  tenditat text,  tinhhinh text,  can numeric(5),  chieudai numeric(5),  vongdau numeric(5),  nhietdo numeric(5,2),  nhiptho numeric(3),  toanthan text,  mausacda numeric(2), khac text,  hohap text,  nhiptho_khac numeric(3),  nghephoi text,  chiso numeric(3),  nhiptim numeric(3),  bung text,  coquan text,  xuongkhop text,  phanxa text,  lucco text,  theodoi text,  CONSTRAINT pk_ba_sosinh PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_sosinh OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_sosinh_pp(  id numeric NOT NULL,  ma numeric(2),  CONSTRAINT pk_ba_sosinh_pp PRIMARY KEY (id,ma)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_sosinh_pp OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_theodoian(  id numeric NOT NULL,  idthuchien numeric,  ngay timestamp without time zone,  duong numeric(3),  loai numeric(3),  soluong numeric(7,2),  truoc text,  sau text,  ghichu text,  yta text,  userid numeric(5),  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_ba_theodoian PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_theodoian OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_theodoicn(  id numeric NOT NULL,  idthuchien numeric,  userid numeric(5),  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_ba_theodoicn PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_theodoicn OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_theodoicnct(  id numeric NOT NULL,  idthuchien numeric,  mach numeric(3),  nhietdo numeric(5,2),  huyetap text,  nhiptho numeric(3),  cannang numeric(7,2),  yta text,  userid numeric(5),  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_ba_theodoicnct PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_theodoicnct OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_thuchien(  id numeric NOT NULL,  mabn text,  maql numeric,  idkhoa numeric,  makp text,  phong text,  giuong text,  chandoan text,  CONSTRAINT pk_ba_thuchien PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_thuchien OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_tiensusk(  id numeric NOT NULL,  stt numeric(3),  nam text,  duthieu numeric(1),  sayhutnao numeric(1),  covac numeric(1),  ngoaitrung numeric(1),  chetsong numeric(1),  cannang numeric(5),  ppde numeric(1),  taibien numeric(1),  CONSTRAINT pk_ba_tiensusk PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_tiensusk OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_tkhoso(  id numeric NOT NULL,  ma numeric(3),  khac text,  so numeric(5),  CONSTRAINT pk_ba_tkhoso PRIMARY KEY (id,ma)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_tkhoso OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_tomtat(  id numeric NOT NULL,  benhan text,  lydo text,  conang text,  thucthe text,  clsdaco text,  CONSTRAINT pk_ba_tomtat PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_tomtat OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_truyendich(  id numeric NOT NULL,  idthuchien numeric,  ngay timestamp without time zone,  userid numeric(5),  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_ba_truyendich PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_truyendich OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_truyendichct(  id numeric NOT NULL,  stt numeric(3),  ten text,  soluong numeric(7,2),  losx text,  tocdo text,  batdau timestamp without time zone,  ketthuc timestamp without time zone,  bccd text,  yta text,  ghichu text,  userid numeric(5),  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_ba_truyendichct PRIMARY KEY (id,stt)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_truyendichct OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_truyenmau(  id numeric NOT NULL,  idthuchien numeric,  ngay timestamp without time zone,  chepham text,  maso text,  ngaylay timestamp without time zone,  handung timestamp without time zone,  soluong text,  noilam text,  kythuat text,  sinhpham text,  hbsag numeric(1),  hcv numeric(1),  giangmai numeric(1),  sotret numeric(1),  nguoicho numeric(1),  benhnhan numeric(1),  ong1 text,  ong2 text,  truongkhoa text,  ktv1 text,  ktv2 text,  chephamtr text,  masotr text,  handungtr timestamp without time zone,  lanthu numeric(3),  bscd text,  nguoichotr numeric(1),  benhnhantr numeric(1),  tai text,  soluongtr text,  batdau timestamp without time zone,  ketthuc timestamp without time zone,  soluongthuc text,  sacmat text,  nhiptho numeric(3),  nhietdo numeric(5,2),  huyetap text,  mach numeric(3),  dienbien text,  bsth text,  yta text,  idlinh numeric,  userid numeric(5),  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_ba_truyenmau PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_truyenmau OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_truyenmauct(  id numeric NOT NULL,  stt numeric(3),  ngay timestamp without time zone,  sacmat text,  nhiptho numeric(3),  nhietdo numeric(5,2),  huyetap text,  mach numeric(3),  dienbien text,  CONSTRAINT pk_ba_truyenmauct PRIMARY KEY (id,stt)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_truyenmauct OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_ungbuou(  id numeric NOT NULL,  xnmau text,  xntebao text,  xnblgp text,  xquang text,  sieuam text,  xnkhac text,  trietde numeric(1),  trieuchung numeric(1),  tienphau text,  hach1 text,  donthuan text,  hach2 text,  phauthuat text,  hauphau text,  hach3 text,  hoachat text,  sodot text,  dapung text,  loai numeric(1),  khac text,  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_ba_ungbuou PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_ungbuou OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_vanchuyen(  id numeric NOT NULL,  idthuchien numeric,  ngay timestamp without time zone,  khoaden text,  ngayvv timestamp without time zone,  ngayrk timestamp without time zone,  ngayvk timestamp without time zone,  m_cc numeric(5),  ha_cc text,  nt_cc numeric(5),  t_cc numeric(7,2),  tg_cc numeric(1),  m_vc numeric(5),  ha_vc text,  nt_vc numeric(5),  t_vc numeric(7,2),  tg_vc numeric(1),  m_kd numeric(5),  ha_kd numeric(7),  nt_kd numeric(5),  t_kd numeric(7,2),  tg_kd numeric(1),  bs_cc text,  dd_cc text,  bs_vc text,  dd_vc text,  bs_kd text,  dd_kd text,  khac text,  luc timestamp without time zone,  vedenkhoa timestamp without time zone,  thangmay numeric(3),  phongmo numeric(3),  nhanbenh numeric(3),  userid numeric(5),  ngayud timestamp without time zone DEFAULT now(),  CONSTRAINT pk_ba_vanchuyen PRIMARY KEY (id)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_vanchuyen OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";

                sql += "CREATE TABLE " + schema + ".ba_vanchuyenct(  id numeric NOT NULL,  stt numeric(3),  ngay timestamp without time zone,  cc numeric(1),  vc numeric(1),  kd numeric(1),  CONSTRAINT pk_ba_vanchuyenct PRIMARY KEY (id,stt)) WITH OIDS;\n";
                sql += "ALTER TABLE " + schema + ".ba_vanchuyenct OWNER TO " + owner + ";\n";
                execute_data_noerror(sql);
                sql = "";
            }
        }
        public void tao_schema_emr_root(int m_userid)
        {
            return;
            string usr = userid;
            schema = usr;

            sql = "";
            sql += "CREATE TABLE " + schema + ".ba_danhmuc(id numeric NOT NULL,loai numeric(3),stt numeric(5),ten text,ngayud timestamp without time zone DEFAULT now(), CONSTRAINT pk_ba_danhmuc PRIMARY KEY (id)) WITH OIDS;\n";
            sql += "ALTER TABLE " + schema + ".ba_danhmuc OWNER TO " + owner + ";\n";
            execute_data_noerror(sql);
            sql = "";

            sql += "CREATE TABLE " + schema + ".dmchidinh(id numeric(3) NOT NULL,idloaivp numeric(3), stt numeric(3), ten text, report text, tinhtrang numeric(1), lanthu numeric(1), hen text, noidung text, ketqua text, cannang numeric(1), chieucao numeric(1), thuchien numeric(1), CONSTRAINT pk_dmchidinh PRIMARY KEY (id)) WITH OIDS;\n";
            sql += "ALTER TABLE " + schema + ".dmchidinh OWNER TO " + owner + ";\n";

            execute_data_noerror(sql);
            sql = "";
            sql += "CREATE TABLE " + schema + ".ba_dmchedoan(id numeric(3) NOT NULL, stt numeric(3), ten text, userid numeric(5), ngayud timestamp without time zone DEFAULT now(), CONSTRAINT pk_ba_dmchedoan PRIMARY KEY (id)) WITH OIDS;\n";
            sql += "ALTER TABLE " + schema + ".ba_dmchedoan OWNER TO " + owner + ";\n";

            execute_data_noerror(sql);
            sql = "";
            sql += "CREATE TABLE " + schema + ".ba_dmchepham( id numeric(3) NOT NULL, stt numeric(3), handung numeric(4), ten text, userid numeric(5), ngayud timestamp without time zone DEFAULT now(), CONSTRAINT pk_ba_dmchepham PRIMARY KEY (id)) WITH OIDS;\n";
            sql += "ALTER TABLE " + schema + ".ba_dmchepham OWNER TO " + owner + ";\n";

            execute_data_noerror(sql);
            sql = "";
            sql += "CREATE TABLE " + schema + ".ba_dmcongtac( id numeric(3) NOT NULL, stt numeric(3), ten text, userid numeric(5), ngayud timestamp without time zone DEFAULT now(), CONSTRAINT pk_ba_dmcongtac PRIMARY KEY (id)) WITH OIDS;\n";
            sql += "ALTER TABLE " + schema + ".ba_dmcongtac OWNER TO " + owner + ";\n";

            execute_data_noerror(sql);
            sql = "";
            sql += "CREATE TABLE " + schema + ".ba_dmcongtaccc( id numeric(3) NOT NULL, stt numeric(3), ten text, userid numeric(5), ngayud timestamp without time zone DEFAULT now(), CONSTRAINT pk_ba_dmcongtaccc PRIMARY KEY (id)) WITH OIDS;\n";
            sql += "ALTER TABLE " + schema + ".ba_dmcongtaccc OWNER TO " + owner + ";\n";

            execute_data_noerror(sql);
            sql = "";
            sql += "CREATE TABLE " + schema + ".ba_dmdacdiem( id numeric(3) NOT NULL, stt numeric(3), ten text, userid numeric(5), ngayud timestamp without time zone DEFAULT now(), CONSTRAINT pk_ba_dmdacdiem PRIMARY KEY (id)) WITH OIDS;\n";
            sql += "ALTER TABLE " + schema + ".ba_dmdacdiem OWNER TO " + owner + ";\n";

            execute_data_noerror(sql);
            sql = "";
            sql += "CREATE TABLE " + schema + ".ba_dmduongan( id numeric(3) NOT NULL, stt numeric(3), ten text, userid numeric(5), ngayud timestamp without time zone DEFAULT now(), CONSTRAINT pk_ba_dmduongan PRIMARY KEY (id)) WITH OIDS;\n";
            sql += "ALTER TABLE " + schema + ".ba_dmduongan OWNER TO " + owner + ";\n";

            execute_data_noerror(sql);
            sql = "";
            sql += "CREATE TABLE " + schema + ".ba_dmhoso( id numeric(3) NOT NULL, stt numeric(3), ten text, khac numeric(1), userid numeric(5), ngayud timestamp without time zone DEFAULT now(), CONSTRAINT pk_ba_dmhoso PRIMARY KEY (id)) WITH OIDS;\n";
            sql += "ALTER TABLE " + schema + ".ba_dmhoso OWNER TO " + owner + ";\n";

            execute_data_noerror(sql);
            sql = "";
            sql += "CREATE TABLE " + schema + ".ba_dmkythuat( id numeric(3) NOT NULL, stt numeric(3), ten text, userid numeric(5), ngayud timestamp without time zone DEFAULT now(), CONSTRAINT pk_ba_dmkythuat PRIMARY KEY (id)) WITH OIDS;\n";
            sql += "ALTER TABLE " + schema + ".ba_dmkythuat OWNER TO " + owner + ";\n";

            execute_data_noerror(sql);
            sql = "";
            sql += "CREATE TABLE " + schema + ".ba_dmloaian( id numeric(3) NOT NULL, stt numeric(3), ten text, userid numeric(5), ngayud timestamp without time zone DEFAULT now(), CONSTRAINT pk_ba_dmloaian PRIMARY KEY (id)) WITH OIDS;\n";
            sql += "ALTER TABLE " + schema + ".ba_dmloaian OWNER TO " + owner + ";\n";

            execute_data_noerror(sql);
            sql = "";
            sql += "CREATE TABLE " + schema + ".ba_dmmau( id numeric(7) NOT NULL, stt numeric(3), ma text, ten text, dvt text, chepham numeric(3), thetich text, userid numeric(5), ngayud timestamp without time zone DEFAULT now(), CONSTRAINT pk_ba_dmmau PRIMARY KEY (id)) WITH OIDS;\n";
            sql += "ALTER TABLE " + schema + ".ba_dmmau OWNER TO " + owner + ";\n";

            execute_data_noerror(sql);
            sql = "";
            sql += "CREATE TABLE " + schema + ".ba_dmppde( id numeric(3) NOT NULL, stt numeric(3), ten text, userid numeric(5), ngayud timestamp without time zone DEFAULT now(), CONSTRAINT pk_ba_dmppde PRIMARY KEY (id)) WITH OIDS;\n";
            sql += "ALTER TABLE " + schema + ".ba_dmppde OWNER TO " + owner + ";\n";

            execute_data_noerror(sql);
            sql = "";
            sql += "CREATE TABLE " + schema + ".ba_dmppthu( id numeric(3) NOT NULL, stt numeric(3), ten text, userid numeric(5),  ngayud timestamp without time zone DEFAULT now(), CONSTRAINT pk_ba_dmppthu PRIMARY KEY (id)) WITH OIDS;\n";
            sql += "ALTER TABLE " + schema + ".ba_dmppthu OWNER TO " + owner + ";\n";

            execute_data_noerror(sql);
            sql = "";
            sql += "CREATE TABLE " + schema + ".ba_dmvanchuyen( id numeric(3) NOT NULL, stt numeric(3), ten text, userid numeric(5), ngayud timestamp without time zone DEFAULT now(), CONSTRAINT pk_ba_dmvanchuyen PRIMARY KEY (id)) WITH OIDS;\n";
            sql += "ALTER TABLE " + schema + ".ba_dmvanchuyen OWNER TO " + owner + ";\n";

            execute_data_noerror(sql);
            sql = "";
            sql += "CREATE TABLE " + schema + ".ba_dmxntienphau( id numeric(3) NOT NULL, stt numeric(3), ten text, mavp numeric(10), userid numeric(5), ngayud timestamp without time zone DEFAULT now(), CONSTRAINT pk_ba_dmxntienphau PRIMARY KEY (id)) WITH OIDS;\n";
            sql += "ALTER TABLE " + schema + ".ba_dmxntienphau OWNER TO " + owner + ";\n";

            execute_data_noerror(sql);
            sql = "";
            sql += "CREATE TABLE " + schema + ".ba_dmylenh( id numeric(3) NOT NULL, stt numeric(3), ten text, userid numeric(5), ngayud timestamp without time zone DEFAULT now(), CONSTRAINT pk_ba_dmylenh PRIMARY KEY (id)) WITH OIDS;\n";
            sql += "ALTER TABLE " + schema + ".ba_dmylenh OWNER TO " + owner + ";\n";

            execute_data_noerror(sql);
            sql = "";
            sql += "CREATE TABLE " + schema + ".ba_hinh( id numeric(3) NOT NULL, stt numeric(3), ten text, hinh bytea[], CONSTRAINT pk_ba_hinh PRIMARY KEY (id)) WITH OIDS;\n";
            sql += "ALTER TABLE " + schema + ".ba_hinh OWNER TO " + owner + ";\n";

            execute_data_noerror(sql);
            sql = "";
            sql += "CREATE TABLE " + schema + ".ba_loaiphieu( id numeric(3) NOT NULL, stt numeric(3), tenreport text, ten text, noidung text, ketqua text, thuchien numeric(1), tinhtrang numeric(1), lanthu numeric(1), hen text, cannang numeric(1), chieucao numeric(1), ngayud timestamp without time zone DEFAULT now(), CONSTRAINT pk_ba_loaiphieu PRIMARY KEY (id)) WITH OIDS;\n";
            sql += "ALTER TABLE " + schema + ".ba_loaiphieu OWNER TO " + owner + ";\n";

            execute_data_noerror(sql);
            sql = "";
            sql += "CREATE TABLE " + schema + ".ba_luutru( mabn text, maql numeric NOT NULL, soluutru text, nhanba numeric(1), ngaynhan timestamp without time zone DEFAULT now(), gia text, tang text, vitri_o text, soto numeric(8), soxq numeric(5), soct numeric(5), sosa numeric(5), soxn numeric(5), sokhac numeric(5), tonghoso numeric(10), nguoigiao text, nguoinhan text, stt numeric(8), CONSTRAINT pk_ba_luutru PRIMARY KEY (maql)) WITH OIDS;\n";
            sql += "ALTER TABLE " + schema + ".ba_luutru OWNER TO " + owner + ";\n";

            execute_data_noerror(sql);
            sql = "";
            sql += "CREATE TABLE " + schema + ".ba_muon( id numeric(12) NOT NULL, mabn text, maql numeric, soluutru text, mabs text, ngaymuon timestamp without time zone, datra numeric(1), ngaytra timestamp without time zone, ghichu text, CONSTRAINT pk_ba_muon PRIMARY KEY (id)) WITH OIDS;\n";
            sql += "ALTER TABLE " + schema + ".ba_muon OWNER TO " + owner + ";\n";

            execute_data_noerror(sql);
            sql = "";
            sql += "CREATE TABLE " + schema + ".ba_sankhoa( id numeric NOT NULL, tungay timestamp without time zone, denngay timestamp without time zone, tuoithai numeric(5), khamthai text, uonvan numeric(1), tiem numeric(3), chuyenda timestamp without time zone, dauhieu text, bienchuyen text, kinhnam text, tinhchat text, chuky numeric(2), luongkinh text, chongnam text, dieutri text, phu numeric(1), ptcu numeric(1), dangtc text, tuthe text, caotc numeric(3), vongbung numeric(3), cotc text, timthai numeric(3), vu text, bishop numeric(5), amho text, amdao text, sinhmon text, tucung text, phanphu text, tinhtrangoi numeric(1), voluc timestamp without time zone, oivo numeric(1), mausac text, nuocoi text, ngoi text,  the text, kieu text, dolot numeric(1), have text, deluc timestamp without time zone, theodoi text, chucdanh text, rau numeric(1), rauluc timestamp without time zone, cachso text, mang text, mui text, banhrau text, raucannang numeric(5), raucuon numeric(1), raudai numeric(3), chaymau numeric(1), maumat numeric(5),  kiemsoattc numeric(1),  xuly text,  da text,  ppde numeric(1),  mach numeric(3),  nhietdo numeric(3),  huyetap text,  nhiptho numeric(3),  canthiep text,  tangsinhmon numeric(1),  loaichi text,  somui numeric(3),  cotucung numeric(1),  CONSTRAINT pk_ba_sankhoa PRIMARY KEY (id)) WITH OIDS;\n";
            sql += "ALTER TABLE " + schema + ".ba_sankhoa OWNER TO " + owner + ";\n";

            execute_data_noerror(sql);
            sql = "";
            sql += "CREATE TABLE " + schema + ".ba_soket( id numeric NOT NULL, idthuchien numeric, ngay timestamp without time zone DEFAULT now(), dienbien text, cls text, dieutri text, ketqua text, tienluong text, bstruong text, mabs text, userid numeric(5), ngayud timestamp without time zone DEFAULT now(), CONSTRAINT pk_ba_soket PRIMARY KEY (id)) WITH OIDS;\n";
            sql += "ALTER TABLE " + schema + ".ba_soket OWNER TO " + owner + ";\n";

            execute_data_noerror(sql);
            sql = "";
            sql += "CREATE TABLE " + schema + ".ba_tiensusk( id numeric NOT NULL, stt numeric(3), nam text, duthieu numeric(1), sayhutnao numeric(1), covat numeric(1), ngoaitrung numeric(1), chetsong numeric(1), cannang numeric(5), ppde numeric(1), taibien numeric(1), CONSTRAINT pk_ba_tiensusk PRIMARY KEY (id)) WITH OIDS;\n";
            sql += "ALTER TABLE " + schema + ".ba_tiensusk OWNER TO " + owner + ";\n";
        }
        public bool upd_theodoigiuong(decimal m_id, string m_makp, string m_mabn, decimal m_maql, decimal m_idkhoa, int m_madoituong, int m_idgiuong, string m_tu, decimal m_dongia, int m_userid)
        {
            sql = "update " + user + ".theodoigiuong set makp=:m_makp,mabn=:m_mabn,maql=:m_maql,idkhoa=:m_idkhoa,madoituong=:m_madoituong,idgiuong=:m_idgiuong,tu=:m_tu,dongia=:m_dongia,userid=:m_userid where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar).Value = m_makp;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                cmd.Parameters.Add("m_idkhoa", NpgsqlDbType.Numeric).Value = m_idkhoa;
                cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                cmd.Parameters.Add("m_idgiuong", NpgsqlDbType.Numeric).Value = m_idgiuong;
                cmd.Parameters.Add("m_tu", NpgsqlDbType.Date).Value = StringToDateTime(m_tu);
                cmd.Parameters.Add("m_dongia", NpgsqlDbType.Numeric).Value = m_dongia;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".theodoigiuong (id,makp,mabn,maql,idkhoa,madoituong,idgiuong,tu,dongia,useri) values (:m_id,:m_makp,:m_mabn,:m_maql,:m_idkhoa,:m_madoituong,:m_idgiuong,:m_tu,:m_dongia,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar).Value = m_makp;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_idkhoa", NpgsqlDbType.Numeric).Value = m_idkhoa;
                    cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                    cmd.Parameters.Add("m_idgiuong", NpgsqlDbType.Numeric).Value = m_idgiuong;
                    cmd.Parameters.Add("m_tu", NpgsqlDbType.Date).Value = StringToDateTime(m_tu);
                    cmd.Parameters.Add("m_dongia", NpgsqlDbType.Numeric).Value = m_dongia;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "theodoigiuong");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }//end
        public bool upd_theodoigiuong(decimal m_id, string m_makp, string m_mabn, decimal m_maql, decimal m_idkhoa, int m_madoituong, int m_idgiuong, string m_tu, decimal m_dongia, int m_userid, decimal m_mavaovien)
        {
            sql = "update " + user + ".theodoigiuong set makp=:m_makp,mabn=:m_mabn,maql=:m_maql,idkhoa=:m_idkhoa,madoituong=:m_madoituong,idgiuong=:m_idgiuong,tu=to_date(:m_tu,'dd/mm/yyyy hh24:mi'),dongia=:m_dongia,userid=:m_userid, mavaovien=:m_mavaovien where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar).Value = m_makp;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                cmd.Parameters.Add("m_idkhoa", NpgsqlDbType.Numeric).Value = m_idkhoa;
                cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                cmd.Parameters.Add("m_idgiuong", NpgsqlDbType.Numeric).Value = m_idgiuong;
                cmd.Parameters.Add("m_tu", NpgsqlDbType.Varchar).Value = m_tu; //cmd.Parameters.Add("m_tu", NpgsqlDbType.Date).Value = StringToDateTime(m_tu);
                cmd.Parameters.Add("m_dongia", NpgsqlDbType.Numeric).Value = m_dongia;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".theodoigiuong (id,makp,mabn,maql,idkhoa,madoituong,idgiuong,tu,dongia,userid, mavaovien) values (:m_id,:m_makp,:m_mabn,:m_maql,:m_idkhoa,:m_madoituong,:m_idgiuong,to_date(:m_tu,'dd/mm/yyyy hh24:mi'),:m_dongia,:m_userid,:m_mavaovien)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar).Value = m_makp;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_idkhoa", NpgsqlDbType.Numeric).Value = m_idkhoa;
                    cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                    cmd.Parameters.Add("m_idgiuong", NpgsqlDbType.Numeric).Value = m_idgiuong;
                    cmd.Parameters.Add("m_tu", NpgsqlDbType.Varchar).Value = m_tu; //cmd.Parameters.Add("m_tu", NpgsqlDbType.Date).Value = StringToDateTime(m_tu);
                    cmd.Parameters.Add("m_dongia", NpgsqlDbType.Numeric).Value = m_dongia;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "theodoigiuong");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }//end
        #endregion

        public bool kiemtra_sothe(string sothe)
        {
            string val = "QWERTYUIOPASDFGHJKLZXCVBNM0123456789";
            int i = 0, len = sothe.Trim().Length;
            bool bError = false;
            while (i < len && !bError)
            {
                bError = val.IndexOf(sothe.Substring(i, 1)) == -1;
                i++;
            }
            return bError;
        }

        public bool getLetet(string ngay)
        {
            return get_data("select * from " + user + ".letet where ngay='" + ngay.Substring(0, 5) + "'").Tables[0].Rows.Count > 0;
        }

        public bool bcstt_linh(int d_nhom)
        {
            ds = get_data("select ten from " + user + ".d_thongso where id=60 and nhom=" + d_nhom);
            if (ds.Tables[0].Rows.Count == 0) return false;
            return ds.Tables[0].Rows[0][0].ToString() == "1";
        }

        public bool bcstt_haophi(int d_nhom)
        {
            ds = get_data("select ten from " + user + ".d_thongso where id=61 and nhom=" + d_nhom);
            if (ds.Tables[0].Rows.Count == 0) return false;
            return ds.Tables[0].Rows[0][0].ToString() == "1";
        }

        public bool bBucstt_tronso(int d_nhom)
        {
            ds = get_data("select ten from " + user + ".d_thongso where id=125 and nhom=" + d_nhom);
            if (ds.Tables[0].Rows.Count == 0) return false;
            return ds.Tables[0].Rows[0][0].ToString().Trim() == "1";
        }
        public bool bPhattron_congdondoituong(int d_nhom)
        {
            ds = get_data("select ten from " + user + ".d_thongso where id=69 and nhom=" + d_nhom);
            if (ds.Tables[0].Rows.Count == 0) return false;
            return ds.Tables[0].Rows[0][0].ToString() == "1";
        }

        public bool bSLDuyet_nho_yeucau(int d_nhom)
        {
            ds = get_data("select ten from " + user + ".d_thongso where id=78 and nhom=" + d_nhom);
            if (ds.Tables[0].Rows.Count == 0) return false;
            return ds.Tables[0].Rows[0][0].ToString() == "1";
        }

        public bool bPhattron(int d_nhom)
        {
            ds = get_data("select ten from " + user + ".d_thongso where id=63 and nhom=" + d_nhom);
            if (ds.Tables[0].Rows.Count == 0) return false;
            return ds.Tables[0].Rows[0][0].ToString() == "1";
        }

        public bool bBucstt_nguon(int d_nhom)
        {
            ds = get_data("select ten from " + user + ".d_thongso where id=54 and nhom=" + d_nhom);
            if (ds.Tables[0].Rows.Count == 0) return false;
            return ds.Tables[0].Rows[0][0].ToString() == "1";
        }

        public int d_soluong_le(int d_nhom)
        {
            ds = get_data("select ten from " + user + ".d_thongso where id=57 and nhom=" + d_nhom);
            if (ds.Tables[0].Rows.Count == 0) return 2;
            return int.Parse(ds.Tables[0].Rows[0][0].ToString());
        }

        public bool bTreole_duyetrieng(int d_nhom)
        {
            ds = get_data("select ten from " + user + ".d_thongso where id=169 and nhom=" + d_nhom);
            if (ds.Tables[0].Rows.Count > 0) return int.Parse(ds.Tables[0].Rows[0]["ten"].ToString()) == 1;
            else return false;
        }

        public bool bIntheocstt(int d_nhom)
        {
            ds = get_data("select ten from " + user + ".d_thongso where id=144 and nhom=" + d_nhom);
            if (ds.Tables[0].Rows.Count == 0) return false;
            return ds.Tables[0].Rows[0][0].ToString() == "1";
        }

        public DataTable get_tutructh_duyet(string mmyy, string kho, int makp)
        {
            sql = "select b.id,a.makho,a.tondau+a.slnhap-a.slxuat as soluong,a.manguon,trim(b.ten)||' '||b.hamluong as ten,b.dang,b.ma,b.tenhc,b.mahc,b.soluong as slphat from " + user + mmyy + ".d_tutructh a," + user + ".d_dmbd b where a.mabd=b.id";
            if (kho != "") sql += " and a.makho in (" + kho.Substring(0, kho.Length - 1) + ")";
            sql += " and a.makp=" + makp;
            DataTable tmp = get_data(sql).Tables[0];
            DataRow r1;
            string mmyys = "";
            foreach (DataRow r2 in get_data("select mmyy from " + user + ".table where substr(mmyy,3,2)||substr(mmyy,1,2)>'" + mmyy.Substring(2, 2) + mmyy.Substring(0, 2) + "'").Tables[0].Rows)
            {
                mmyys = r2["mmyy"].ToString();
                sql = "select makho,mabd,manguon,sum(slxuat) as soluong from " + user + mmyys + ".d_tutructh where slxuat>0";
                if (kho != "") sql += " and makho in (" + kho.Substring(0, kho.Length - 1) + ")";
                sql += " and makp=" + makp;
                sql += " group by makho,mabd,manguon";
                foreach (DataRow r in get_data(sql).Tables[0].Rows)
                {
                    r1 = getrowbyid(tmp, "makho=" + int.Parse(r["makho"].ToString()) + " and id=" + int.Parse(r["mabd"].ToString()) + " and manguon=" + int.Parse(r["manguon"].ToString()));
                    if (r1 != null) r1["soluong"] = decimal.Parse(r1["soluong"].ToString()) - decimal.Parse(r["soluong"].ToString());
                }
            }
            return tmp;
        }

        public DataTable get_tonkhoth_duyet(string mmyy, string kho)
        {
            sql = "select b.id,a.makho,a.tondau+a.slnhap-a.slxuat as soluong,a.manguon,trim(b.ten)||' '||b.hamluong as ten,b.dang,b.ma,b.tenhc,b.mahc,b.soluong as slphat from " + user + mmyy + ".d_tonkhoth a," + user + ".d_dmbd b where a.mabd=b.id";
            if (kho != "") sql += " and a.makho in (" + kho.Substring(0, kho.Length - 1) + ")";
            DataTable tmp = get_data(sql).Tables[0];
            DataRow r1;
            string mmyys = "";
            foreach (DataRow r2 in get_data("select mmyy from " + user + ".table where substr(mmyy,3,2)||substr(mmyy,1,2)>'" + mmyy.Substring(2, 2) + mmyy.Substring(0, 2) + "'").Tables[0].Rows)
            {
                mmyys = r2["mmyy"].ToString();
                sql = "select makho,mabd,manguon,sum(slxuat) as soluong from " + user + mmyys + ".d_tonkhoth where slxuat>0";
                if (kho != "") sql += " and makho in (" + kho.Substring(0, kho.Length - 1) + ")";
                sql += " group by makho,mabd,manguon";
                foreach (DataRow r in get_data(sql).Tables[0].Rows)
                {
                    r1 = getrowbyid(tmp, "makho=" + int.Parse(r["makho"].ToString()) + " and id=" + int.Parse(r["mabd"].ToString()) + " and manguon=" + int.Parse(r["manguon"].ToString()));
                    if (r1 != null) r1["soluong"] = decimal.Parse(r1["soluong"].ToString()) - decimal.Parse(r["soluong"].ToString());
                }
            }
            return tmp;
        }

        public decimal get_slton_nguon(DataTable dt, int makho, int mabd, int manguon, decimal soluong)
        {
            DataRow r = getrowbyid(dt, "makho=" + makho + " and id=" + mabd + " and manguon=" + manguon);
            if (r == null) return 0;
            else return decimal.Parse(r["soluong"].ToString()) + soluong;
        }

        public void updrec_tonkho_nguon(DataTable dt, int kho, int mabd, int manguon, decimal soluong, string toantu)
        {
            DataRow[] r = dt.Select("makho=" + kho + " and id=" + mabd + " and manguon=" + manguon);
            if (r.Length > 0)
            {
                if (toantu == "+")
                    r[0]["soluong"] = decimal.Parse(r[0]["soluong"].ToString()) + soluong;
                else
                    r[0]["soluong"] = decimal.Parse(r[0]["soluong"].ToString()) - soluong;
            }
        }

        public DataTable get_duyet(int i_nhom, int i_loai, int i_phieu, string s_ngay, int i_makp, string s_tenkp,
            string s_mmyy, string s_kho, bool bBuhaophi, bool bThua, int i_thuoc, bool bCongdon, bool bTutrucchung,
            bool bTaisan, bool bHaophi, string makho_auto_duyet)
        {
            if (makho_auto_duyet != "")
            {
                s_kho = makho_auto_duyet;
                if (s_kho.Substring(s_kho.Length - 1, 1) != ",") s_kho += ",";
            }
            string file1, file2, xxx = user + s_mmyy, tu, den, f_ngay = "dd/mm/yyyy";
            tu = den = s_ngay;
            int soluong_le = d_soluong_le(i_nhom);
            bool bSlthuc_yeucau, _bPhattron, _bBucstt_tronso, _bBucstt_nguon, bSolan = false, bCstt = bcstt_linh(i_nhom);
            bool _bIntheocstt = bIntheocstt(i_nhom), _bPhattron_congdondoituong = bPhattron_congdondoituong(i_nhom);
            if (bBuhaophi)
            {
                file1 = xxx + ".d_haophill"; file2 = xxx + ".d_haophict";
            }
            else
            {
                switch (i_loai)
                {
                    case 1: file1 = "xxx.d_dutrull"; file2 = "xxx.d_dutruct";
                        break;
                    case 2: file1 = "xxx.d_xtutrucll"; file2 = "xxx.d_xtutrucct";
                        break;
                    case 3: file1 = "xxx.d_hoantrall"; file2 = "xxx.d_hoantract";
                        break;
                    default: file1 = "xxx.d_haophill"; file2 = "xxx.d_haophict";
                        break;
                }
            }
            bSlthuc_yeucau = bSLDuyet_nho_yeucau(i_nhom);
            _bPhattron = bPhattron(i_nhom);
            _bBucstt_tronso = bBucstt_tronso(i_nhom);
            _bBucstt_nguon = bBucstt_nguon(i_nhom);
            DataTable dt = new DataTable();
            DataTable dtct = new DataTable();
            DataTable dtton = new DataTable();
            DataTable dtbd = new DataTable();
            dtbd = get_data("select * from " + user + ".d_dmbd where nhom=" + i_nhom).Tables[0];
            if (i_loai == 3 && i_thuoc == 2) dtton = get_tutructh_duyet(s_mmyy, s_kho, i_makp);
            else if (i_loai != 3) dtton = get_tonkhoth_duyet(s_mmyy, s_kho);
            bool bCont = false, bTreole = false;
            bool _bTreole_duyetrieng = (i_loai == 2 && _bBucstt_tronso) ? bTreole_duyetrieng(i_nhom) : false;
            if (i_loai == 4 || bBuhaophi) //hao phi
            {
                sql = "select a.id,a.sophieu as mabn,'" + s_tenkp + "' as hoten,0 as mavaovien,0 as maql,0 as idkhoa,f.doituong,g.ten as tenkho,d.ma,";
                sql += "trim(d.ten)||' '||d.hamluong as ten,d.tenhc,d.dang,trunc(b.slyeucau-b.slthuc," + soluong_le + ") as soluong,trunc(b.slyeucau-b.slthuc," + soluong_le + ") as soluongcu,trunc(b.slyeucau-b.slthuc," + soluong_le + ") as soluongyc,0001.00 as sltd,";
                sql += "b.madoituong,b.makho,b.mabd,c.makp,c.makhoa,c.phieu,b.stt,a.idduyet,b.manguon,h.ten as tennguon,b.tutruc,'xx/xx/xxxx' as ngay,0000000.00 as coso,0000000.00 as ton,d.phatsau,d.hamluong";
                sql += ",d.dongia as giamua,d.giaban,'0000' as handung,' ' as losx,0 as tt,to_char(c.ngay,'dd/mm/yyyy') as ngayylenh,0 as treo";
                sql += " from " + file1 + " a," + file2 + " b,xxx.d_duyet c," + user + ".d_dmbd d," + user + ".d_doituong f," + user + ".d_dmkho g," + user + ".d_dmnguon h";
                sql += " where a.id=b.id and a.idduyet=c.id and b.mabd=d.id and b.madoituong=f.madoituong and b.makho=g.id and b.manguon=h.id";
                sql += " and c.done<>0 and b.slyeucau>b.slthuc and c.nhom=" + i_nhom + " and c.loai in (2,4) and c.makhoa=" + i_makp;
                sql += " and c.ngay between to_date('" + tu + "','" + f_ngay + "') and to_date('" + den + "','" + f_ngay + "')";
                if (s_kho != "") sql += " and b.makho in (" + s_kho.Substring(0, s_kho.Length - 1) + ")";
                if (bBuhaophi) sql += " and b.tutruc=1";
                else sql += " and b.tutruc=0";
                sql += " and c.phieu=" + i_phieu;
                sql += " order by c.makp,a.id,b.stt";
            }
            else
            {
                sql = "";
                bCont = (_bTreole_duyetrieng) ? false : (i_loai == 2 && _bBucstt_tronso);
                sql = " select a.id,";
                if (bThua || i_thuoc == 2) sql += " a.mabn,'" + s_tenkp + "' as hoten,";
                else sql += " a.mabn,e.hoten,";
                sql += "a.mavaovien,a.maql,a.idkhoa,f.doituong,g.ten as tenkho,d.ma,";
                sql += "trim(d.ten)||' '||d.hamluong as ten,d.tenhc,d.dang,trunc(b.slyeucau-b.slthuc," + soluong_le + ") as soluong,trunc(b.slyeucau-b.slthuc," + soluong_le + ") as soluongcu,trunc(b.slyeucau-b.slthuc," + soluong_le + ") as soluongyc,0001.00 as sltd,";
                sql += "b.madoituong,b.makho,b.mabd,c.makp,c.makhoa,c.phieu,b.stt,a.idduyet,b.manguon,h.ten as tennguon,0 as tutruc,";
                if (i_loai == 3) sql += "to_char(b.ngay,'dd/mm/yyyy') as ngay ";
                else sql += "'xx/xx/xxxx' as ngay ";
                sql += ",0000000.00 as coso,0000000.00 as ton,d.phatsau,d.hamluong";
                sql += ",d.dongia as giamua,d.giaban,'0000' as handung,' ' as losx,0 as tt,";
                if (i_loai == 3) sql += "to_char(b.ngay,'dd/mm/yyyy') as ngayylenh,";
                else sql += "to_char(c.ngay,'dd/mm/yyyy') as ngayylenh,";
                sql += "0 as treo";
                sql += " from " + file1 + " a inner join " + file2 + " b on a.id=b.id ";
                //sql+=" inner join " + xxx + ".d_duyet c on a.idduyet=c.id ";
                sql += " inner join xxx.d_duyet c on a.idduyet=c.id ";
                sql += " inner join " + user + ".d_dmbd d on b.mabd=d.id ";
                sql += " left join  " + user + ".btdbn e on a.mabn=e.mabn ";
                sql += " inner join " + user + ".d_doituong f on b.madoituong=f.madoituong ";
                sql += " inner join " + user + ".d_dmkho g on b.makho=g.id ";
                sql += " inner join " + user + ".d_dmnguon h on b.manguon=h.id ";
                sql += " where c.done<>0 and b.slyeucau>b.slthuc ";
                if (bThua || i_thuoc == 2) sql += " and a.maql=0";
                sql += " and c.nhom=" + i_nhom + " and c.loai=" + i_loai;
                sql += " and c.phieu=" + i_phieu;
                if (i_loai == 2)
                {
                    if (_bIntheocstt) sql += " and c.makp=" + i_makp;
                    else sql += " and c.makhoa=" + i_makp;
                }
                else sql += " and c.makhoa=" + i_makp;
                sql += " and c.ngay between to_date('" + tu + "','" + f_ngay + "') and to_date('" + den + "','" + f_ngay + "')";
                if (s_kho != "") sql += " and b.makho in (" + s_kho.Substring(0, s_kho.Length - 1) + ")";
                if (i_loai == 1) sql += " and b.tutruc=0";
                if (i_loai != 2) sql += " order by a.mabn,a.id,b.stt";
                if (i_loai == 2) //lay tutruc -> du tru
                {
                    sql += " and b.idvpkhoa=0";
                    sql += " union all select a.id,a.mabn,e.hoten,a.mavaovien,a.maql,a.idkhoa,f.doituong,g.ten as tenkho,d.ma,";
                    sql += " trim(d.ten)||' '||d.hamluong as ten,d.tenhc,d.dang,trunc(b.slyeucau-b.slthuc," + soluong_le + ") as soluong,trunc(b.slyeucau-b.slthuc," + soluong_le + ") as soluongcu,trunc(b.slyeucau-b.slthuc," + soluong_le + ") as soluongyc,0001.00 as sltd,";
                    sql += " b.madoituong,b.makho,b.mabd,c.makp,c.makhoa,c.phieu,b.stt,a.idduyet,b.manguon,h.ten as tennguon,b.tutruc,'xx/xx/xxxx' as ngay,0000000.00 as coso,0000000.00 as ton,d.phatsau,d.hamluong";
                    sql += ",d.dongia as giamua,d.giaban,'0000' as handung,' ' as losx,0 as tt,to_char(c.ngay,'dd/mm/yyyy') as ngayylenh,0 as treo";
                    //sql+=" from " + xxx + ".d_dutrull a," + xxx + ".d_dutruct b," + xxx + ".d_duyet c," + user + ".d_dmbd d," + user + ".btdbn e," + user + ".d_doituong f," + user + ".d_dmkho g," + user + ".d_dmnguon h";
                    sql += " from xxx.d_dutrull a,xxx.d_dutruct b,xxx.d_duyet c," + user + ".d_dmbd d," + user + ".btdbn e," + user + ".d_doituong f," + user + ".d_dmkho g," + user + ".d_dmnguon h";
                    sql += " where a.id=b.id and a.idduyet=c.id and b.mabd=d.id and a.mabn=e.mabn and b.madoituong=f.madoituong and b.makho=g.id and b.manguon=h.id";
                    sql += " and c.done<>0 and b.slyeucau>b.slthuc and b.tutruc=1 and c.nhom=" + i_nhom + " and c.loai=1 ";
                    if (_bIntheocstt) sql += " and c.makp=" + i_makp;
                    else sql += " and c.makhoa=" + i_makp;
                    sql += " and c.ngay between to_date('" + tu + "','" + f_ngay + "') and to_date('" + den + "','" + f_ngay + "')";
                    if (s_kho != "") sql += " and b.makho in (" + s_kho.Substring(0, s_kho.Length - 1) + ")";
                    sql += " and c.phieu=" + i_phieu;
                }
            }

            dt = get_data_mmyy(sql, tu, den, true).Tables[0];
            if (bCongdon)
            {
                dtct = dt.Copy();
                dt.Clear();
                DataRow r2, r3;
                DataRow[] dr;
                foreach (DataRow r4 in dtct.Rows)
                {
                    sql = "makho=" + int.Parse(r4["makho"].ToString()) + " and mabd=" + int.Parse(r4["mabd"].ToString());
                    if (_bBucstt_nguon) sql += " and manguon=" + int.Parse(r4["manguon"].ToString());
                    if (!bPhattron_congdondoituong(i_nhom)) sql += " and madoituong=" + int.Parse(r4["madoituong"].ToString());
                    r2 = d.getrowbyid(dt, sql);
                    if (r2 == null)
                    {
                        r3 = dt.NewRow();
                        r3["makho"] = r4["makho"].ToString();
                        r3["tenkho"] = r4["tenkho"].ToString();
                        r3["makp"] = r4["makp"].ToString();
                        r3["makhoa"] = r4["makhoa"].ToString();
                        r3["manguon"] = r4["manguon"].ToString();
                        r3["tennguon"] = r4["tennguon"].ToString();
                        r3["mabd"] = r4["mabd"].ToString();
                        r3["ma"] = r4["ma"].ToString();
                        r3["ten"] = r4["ten"].ToString();
                        r3["tenhc"] = r4["tenhc"].ToString();
                        r3["dang"] = r4["dang"].ToString();
                        r3["madoituong"] = r4["madoituong"].ToString();
                        r3["tutruc"] = r4["tutruc"].ToString();
                        r3["coso"] = r4["coso"].ToString();
                        r3["ton"] = r4["ton"].ToString();
                        r3["phatsau"] = r4["phatsau"].ToString();
                        r3["soluong"] = r4["soluong"].ToString();
                        r3["ngay"] = r4["ngay"].ToString();
                        r3["sltd"] = r4["sltd"].ToString();
                        r3["soluongcu"] = r4["soluongcu"].ToString();
                        r3["soluongyc"] = r4["soluongyc"].ToString();
                        r3["giamua"] = r4["giamua"].ToString();
                        r3["giaban"] = r4["giaban"].ToString();
                        r3["handung"] = r4["handung"].ToString();
                        r3["losx"] = r4["losx"].ToString();
                        dt.Rows.Add(r3);
                    }
                    else
                    {
                        dr = dt.Select(sql);
                        if (dr.Length > 0)
                        {
                            dr[0]["soluong"] = decimal.Parse(dr[0]["soluong"].ToString()) + decimal.Parse(r4["soluong"].ToString());
                            dr[0]["soluongcu"] = decimal.Parse(dr[0]["soluongcu"].ToString()) + decimal.Parse(r4["soluongcu"].ToString());
                            dr[0]["soluongyc"] = decimal.Parse(dr[0]["soluongyc"].ToString()) + decimal.Parse(r4["soluongyc"].ToString());
                        }
                    }
                }
            }
            dt.Columns.Add("Chon", typeof(bool));
            DataRow r, r1;
            int tt = 1, i_mabd, i_makho, i_manguon;
            decimal d_soluong = 0, d_soluongcu = 0, d_soluongton = 0;
            foreach (DataRow row in dt.Rows)
            {
                if (row["phatsau"].ToString() == "1") row["chon"] = true;
                else row["chon"] = false;
                row["tt"] = tt++;
                #region kiem tra ton kho
                if ((i_loai == 3 && i_thuoc == 1) == false)
                {
                    d_soluong = decimal.Parse(row["soluong"].ToString());
                    i_mabd = int.Parse(row["mabd"].ToString());
                    i_makho = int.Parse(row["makho"].ToString());
                    i_manguon = int.Parse(row["manguon"].ToString());
                    if (i_loai == 1 || i_loai == 2 || bBuhaophi)
                    {
                        //sql="soluong>0 and makho="+i_makho+" and id="+i_mabd;
                        sql = "soluong>=" + d_soluong + " and makho=" + i_makho + " and id=" + i_mabd;
                        sql += " and manguon=" + i_manguon;
                        r = getrowbyid(dtton, sql);
                        if (r == null)
                        {
                            sql = "soluong>=" + d_soluong + " and makho=" + i_makho + " and ten='" + row["ten"].ToString() + "' and dang='" + row["dang"].ToString() + "' and hamluong='" + row["hamluong"].ToString() + "'";
                            if (_bBucstt_nguon) sql += " and manguon=" + i_manguon;
                            r1 = d.getrowbyid(dtton, sql);
                            if (r1 != null)
                            {
                                row["mabd"] = r1["id"].ToString();
                                row["ten"] = r1["ten"].ToString();
                                row["dang"] = r1["dang"].ToString();
                                row["manguon"] = r1["manguon"].ToString();
                                i_mabd = int.Parse(row["mabd"].ToString());
                                i_manguon = int.Parse(row["manguon"].ToString());
                            }
                            else //tuong duong
                            {
                                bool bFound = false;
                                foreach (DataRow r2 in d.get_data("select mabd,soluong from " + user + ".d_dmbdtd where id=" + int.Parse(row["mabd"].ToString())).Tables[0].Rows)
                                {
                                    d_soluong = decimal.Parse(row["soluong"].ToString()) * decimal.Parse(r2["soluong"].ToString());
                                    sql = "makho=" + i_makho + " and id=" + int.Parse(r2["mabd"].ToString()) + " and soluong>=" + d_soluong;
                                    if (_bBucstt_nguon) sql += " and manguon=" + i_manguon;
                                    r1 = getrowbyid(dtton, sql);
                                    if (r1 != null)
                                    {
                                        row["mabd"] = r1["id"].ToString();
                                        row["ten"] = r1["ten"].ToString();
                                        row["dang"] = r1["dang"].ToString();
                                        row["manguon"] = r1["manguon"].ToString();
                                        row["soluong"] = d_soluong;
                                        row["sltd"] = r2["soluong"].ToString();
                                        i_mabd = int.Parse(row["mabd"].ToString());
                                        i_manguon = int.Parse(row["manguon"].ToString());
                                        bFound = true;
                                        break;
                                    }
                                }
                                //hoatchat - hamluong - dvt 
                                if (!bFound && row["tenhc"].ToString() != "")
                                {
                                    d_soluong = decimal.Parse(row["soluong"].ToString());
                                    sql = "soluong>=" + d_soluong + " and makho=" + i_makho + " and tenhc='" + row["tenhc"].ToString() + "'" + " and dang='" + row["dang"].ToString() + "' and hamluong='" + row["hamluong"].ToString() + "'";
                                    if (_bBucstt_nguon) sql += " and manguon=" + i_manguon;
                                    r1 = d.getrowbyid(dtton, sql);
                                    if (r1 != null)
                                    {
                                        row["mabd"] = r1["id"].ToString();
                                        row["ten"] = r1["ten"].ToString();
                                        row["dang"] = r1["dang"].ToString();
                                        row["manguon"] = r1["manguon"].ToString();
                                        i_mabd = int.Parse(row["mabd"].ToString());
                                        i_manguon = int.Parse(row["manguon"].ToString());
                                    }
                                }
                            }
                        }
                    }
                    d_soluongcu = 0;//decimal.Parse(row["soluongcu"].ToString());
                    d_soluongton = get_slton_nguon(dtton, i_makho, i_mabd, i_manguon, d_soluongcu);
                    if (d_soluong > d_soluongton) row["soluong"] = Math.Max(d_soluongton, 0);
                    updrec_tonkho_nguon(dtton, i_makho, i_mabd, i_manguon, d_soluong - d_soluongcu, "-");
                    dtton.AcceptChanges();
                    if (row["soluong"].ToString().Trim() == "0") row["chon"] = true;
                    r = d.getrowbyid(dtton, "makho=" + i_makho + " and manguon=" + i_manguon + " and id=" + i_mabd);
                    if (r != null) row["ton"] = r["soluong"].ToString();
                }
                #endregion
            }
            if (i_loai == 2 && _bBucstt_tronso && !bCongdon)
            {
                ds.Clear();
                DataRow r5, r6, r7;
                DataRow[] dr;

                #region sum
                foreach (DataRow r4 in dt.Rows)
                {
                    r4["chon"] = true;
                    sql = "id=" + int.Parse(r4["mabd"].ToString()) + " and makho=" + int.Parse(r4["makho"].ToString());
                    if (_bBucstt_nguon) sql += " and manguon=" + int.Parse(r4["manguon"].ToString());
                    r5 = d.getrowbyid(dtton, sql);
                    if (r5 != null)
                    {
                        r6 = d.getrowbyid(ds.Tables[0], sql);
                        if (r6 == null)
                        {
                            r7 = ds.Tables[0].NewRow();
                            r7["makho"] = r4["makho"].ToString();
                            r7["manguon"] = r4["manguon"].ToString();
                            r7["id"] = r4["mabd"].ToString();
                            r7["slyeucau"] = r4["soluong"].ToString();
                            r7["slphat"] = r5["slphat"].ToString();
                            r7["min"] = r4["soluong"].ToString();
                            ds.Tables[0].Rows.Add(r7);
                        }
                        else
                        {
                            dr = ds.Tables[0].Select(sql);
                            if (dr.Length > 0)
                            {
                                dr[0]["min"] = Math.Min(decimal.Parse(dr[0]["min"].ToString()), decimal.Parse(r4["soluong"].ToString()));
                                dr[0]["slyeucau"] = decimal.Parse(dr[0]["slyeucau"].ToString()) + decimal.Parse(r4["soluong"].ToString());
                            }
                        }
                    }
                }
                #endregion

                double sl = 1;
                foreach (DataRow r4 in ds.Tables[0].Rows)
                {
                    r5 = d.getrowbyid(dtbd, "id=" + decimal.Parse(r4["id"].ToString()));
                    sl = (r5 != null) ? double.Parse(r5["soluong"].ToString()) : 1;
                    r4["slyeucau"] = sl * Math.Floor(double.Parse(r4["slyeucau"].ToString()) / double.Parse(r4["slphat"].ToString()));
                    r4["min"] = r4["slyeucau"].ToString();
                }
                string sort = "makho,mabd";
                if (_bBucstt_nguon) sql += ",manguon=";
                decimal sum = 0;
                foreach (DataRow r4 in dt.Select("chon=true", sort))
                {
                    sql = "makho=" + int.Parse(r4["makho"].ToString()) + " and id=" + int.Parse(r4["mabd"].ToString());
                    if (_bBucstt_nguon) sql += " and manguon=" + int.Parse(r4["manguon"].ToString());
                    dr = ds.Tables[0].Select(sql);
                    if (dr.Length > 0)
                    {
                        sum = Math.Min(decimal.Parse(r4["soluong"].ToString()), decimal.Parse(dr[0]["min"].ToString()));
                        dr[0]["min"] = decimal.Parse(dr[0]["min"].ToString()) - sum;
                        r4["soluong"] = sum;
                        r4["chon"] = false;
                    }
                }
            }
            return (bCongdon) ? dtct : dt;
        }

        public bool b1kho(string makho)
        {
            if (makho == "") return false;
            else
            {
                int i = 0;
                for (int j = 0; j < makho.Length; j++)
                    if (makho.Substring(j, 1) == ",") i++;
                return i < 2;
            }
        }

        public bool get_duyet(int i_makp, int i_nhom, int i_loai, int i_phieu, string s_ngay, string s_makho, string s_mmyy)
        {
            sql = "select * from " + user + s_mmyy + ".d_ngayduyet where nhom=" + i_nhom + " and loai=" + i_loai + " and phieu=" + i_phieu + " and makp=" + i_makp + " and to_char(ngay,'dd/mm/yyyy')='" + s_ngay + "'";
            if (s_makho != "") sql += " and makho='" + s_makho + "'";
            return get_data(sql).Tables[0].Rows.Count > 0;
        }

        public void upd_duyet(DataTable dt, string s_mmyy, int i_nhom, int i_loai, int i_phieu, int i_makp, int i_makhoa,
            string s_ngay, string s_kho, bool bTutrucchung, bool bBuhaophi, int i_thuoc, int i_userid, bool bCongdon, string s_makp, string makho_auto_duyet)
        {
            LibDuoc.AccessData d = new LibDuoc.AccessData();
            bool _bPhattron = bPhattron(i_nhom);
            bool _bBucstt_tronso = bBucstt_tronso(i_nhom);
            bool _b1kho = b1kho(s_kho), bTreole = false;
            int _makp = i_makp;
            d.upd_dangduyet(i_nhom, s_ngay, s_ngay, i_loai, _makp);
            sql = "delete from " + user + s_mmyy + ".d_ngayduyet where nhom=" + i_nhom + " and loai=" + i_loai + " and phieu=" + i_phieu + " and makp=" + i_makp + " and to_char(ngay,'dd/mm/yyyy')='" + s_ngay + "'";
            execute_data(sql);
            if (bBuhaophi) phieu_butruc(dt, s_mmyy, s_ngay, i_nhom, i_makp, i_loai, i_phieu, _bPhattron, i_thuoc, s_kho, tableid(s_mmyy, "d_xuatsdll"), bBuhaophi, _b1kho, i_userid, bCongdon, s_makp, bTutrucchung, _bBucstt_tronso, "xxx.d_xtutrucct");
            else
            {
                switch (i_loai)
                {
                    case 1: phieu_dutru(dt, s_mmyy, s_ngay, i_nhom, i_makp, i_loai, i_phieu, _bPhattron, i_thuoc, s_kho, tableid(s_mmyy, "d_xuatsdll"), bBuhaophi, _b1kho, i_userid, "xxx.d_dutruct");
                        break;
                    case 2: phieu_butruc(dt, s_mmyy, s_ngay, i_nhom, i_makp, i_loai, i_phieu, _bPhattron, i_thuoc, s_kho, tableid(s_mmyy, "d_xuatsdll"), bBuhaophi, _b1kho, i_userid, bCongdon, s_makp, bTutrucchung, _bBucstt_tronso, "xxx.d_xtutrucct");
                        break;
                    case 4: phieu_dutru(dt, s_mmyy, s_ngay, i_nhom, i_makp, i_loai, i_phieu, _bPhattron, i_thuoc, s_kho, tableid(s_mmyy, "d_xuatsdll"), bBuhaophi, _b1kho, i_userid, "xxx.d_haophict");
                        break;
                }
            }
            if (_bPhattron || _bBucstt_tronso)
            {
                if (i_loai == 2 || bBuhaophi) d.upd_thucbucstt(s_ngay, i_nhom, i_loai, i_phieu, i_makp, i_makhoa, s_mmyy, (_b1kho) ? int.Parse(s_kho.Substring(0, s_kho.Length - 1)) : 0);
                else
                {
                    if (i_loai != 3)
                    {
                        sql = "select b.*,c.handung,c.losx,c.manguon,c.nhomcc,c.giamua ";
                        sql += " from " + user + s_mmyy + ".d_xuatsdll a," + user + s_mmyy + ".d_xuatsdct b," + user + s_mmyy + ".d_theodoi c ";
                        sql += " where a.id=b.id and b.sttt=c.id and a.nhom=" + i_nhom + " and a.loai=" + i_loai;
                        sql += " and a.phieu=" + i_phieu + " and to_char(a.ngay,'dd/mm/yyyy')='" + s_ngay + "' and a.makp=" + i_makp;
                        foreach (DataRow r in get_data(sql).Tables[0].Rows)
                            d.upd_tonkhoct_thucbucstt(d.delete, s_mmyy, i_makp, decimal.Parse(r["sttt"].ToString()), int.Parse(r["makho"].ToString()), int.Parse(r["manguon"].ToString()), int.Parse(r["nhomcc"].ToString()), int.Parse(r["mabd"].ToString()), r["handung"].ToString(), r["losx"].ToString(), decimal.Parse(r["soluong"].ToString()), decimal.Parse(r["soluong"].ToString()) * decimal.Parse(r["giamua"].ToString()), decimal.Parse(r["giaban"].ToString()), decimal.Parse(r["giamua"].ToString()));
                    }
                    d.upd_thucxuat(s_ngay, i_nhom, i_loai, i_phieu, i_makp, i_makhoa, s_mmyy, i_thuoc, (_b1kho) ? int.Parse(s_kho.Substring(0, s_kho.Length - 1)) : 0);
                }
            }
            DataTable dtton = new DataTable();
            if (i_loai == 3 && i_thuoc == 2) dtton = d.get_tutructh_duyet(s_mmyy, s_kho, i_makp);
            else if (i_loai != 3) dtton = d.get_tonkhoth_duyet(s_mmyy, s_kho);
            d.upd_theodoiduyet(s_mmyy, s_ngay, i_nhom, i_loai, i_makp, 2);
            sql = "select * from " + user + ".d_dmkho where nhom=" + i_nhom;
            if (s_kho != "") sql += " and id in (" + s_kho.Substring(0, s_kho.Length - 1) + ")";
            DataRow r1;
            string _khoa = "";
            foreach (DataRow r in get_data(sql).Tables[0].Rows)
            {
                r1 = getrowbyid(dt, "makho=" + int.Parse(r["id"].ToString()));
                if (r1 != null)
                {
                    d.upd_daduyet(s_mmyy, i_nhom, s_ngay, i_makhoa, i_loai, i_phieu, int.Parse(r["id"].ToString()), (bTreole) ? 1 : 0);
                    if (i_loai == 2)
                    {
                        if (_khoa.IndexOf(i_makhoa.ToString().Trim() + ",") == -1) _khoa += i_makhoa.ToString().Trim() + ",";
                        foreach (DataRow r2 in dt.Select("makp not in (" + _khoa.Substring(0, _khoa.Length - 1) + ")"))
                            if (_khoa.IndexOf(r2["makp"].ToString().Trim() + ",") == -1)
                            {
                                _khoa += r2["makp"].ToString().Trim() + ",";
                                d.upd_daduyet(s_mmyy, i_nhom, s_ngay, int.Parse(r2["makp"].ToString()), i_loai, i_phieu, int.Parse(r["id"].ToString()), (bTreole) ? 1 : 0);
                            }
                    }
                }
            }
            d.del_dangduyet(i_nhom, s_ngay, s_ngay, i_loai, _makp);
            int itable = tableid(s_mmyy, "d_ngayduyet");
            d.upd_eve_tables(s_mmyy, itable, i_userid, "upd");
            d.upd_eve_upd_del(s_mmyy, itable, i_userid, "upd", i_nhom.ToString() + "^" + i_loai.ToString() + "^" + i_makhoa.ToString() + "^" + s_ngay + "^0^" + i_phieu.ToString() + "^" + s_kho + "^0");
        }
        private void phieu_dutru(DataTable dt, string s_mmyy, string s_ngay, int i_nhom, int i_makp, int i_loai,
            int i_phieu, bool bPhattron, int i_thuoc, string s_kho, int itable, bool bBuhaophi, bool _b1kho,
            int i_userid, string file2)
        {
            LibDuoc.AccessData d = new LibDuoc.AccessData();
            string xxx = user + s_mmyy, s_sttduyet;
            DataTable dtct = new DataTable();
            DataRow r2;
            bool bFound = false;
            decimal id = 0, idduyet = 0;
            bool bGiaban = false;
            if (!d.bGiaban_theodot(i_nhom))
                bGiaban = d.get_data("select * from " + user + ".d_doituong where loai=1").Tables[0].Rows.Count > 0;
            DataRow[] dr = dt.Select("chon=false and soluong>0", "id,stt");
            for (int i = 0; i < dr.Length; i++)
            {
                if (idduyet != decimal.Parse(dr[i]["id"].ToString()))
                {
                    d.upd_eve_tables(s_mmyy, itable, i_userid, "ins");
                    idduyet = decimal.Parse(dr[i]["id"].ToString());
                    id = d.get_id_xuatsd;
                    d.upd_xuatsdll(s_mmyy, id, i_nhom, dr[i]["mabn"].ToString(), decimal.Parse(dr[i]["mavaovien"].ToString()), decimal.Parse(dr[i]["maql"].ToString()), decimal.Parse(dr[i]["idkhoa"].ToString()), s_ngay, i_loai, i_phieu, int.Parse(dr[i]["makp"].ToString()), i_userid, idduyet, i_thuoc, int.Parse(dr[i]["makhoa"].ToString()), (_b1kho) ? int.Parse(s_kho.Substring(0, s_kho.Length - 1)) : 0, (bPhattron) ? 1 : 0, "", dr[i]["ngayylenh"].ToString(), 0, "");
                    //
                    d.execute_data("update " + d.user + s_mmyy + ".d_tienthuoc set traituyen=" + dr[i]["traituyen"].ToString() + " where id=" + id);
                    //
                    sql = "select a.*,t.manguon,t.nhomcc,t.handung,t.losx,t.giamua,";
                    if (bGiaban) sql += "d.giaban,";
                    else sql += "t.giaban,";
                    sql += "t.tyle_ggia,t.st_ggia,b.ten as tennguon,c.ten as tennhomcc ";
                    sql += " from " + xxx + ".d_tonkhoct a," + xxx + ".d_theodoi t," + user + ".d_dmnguon b," + user + ".d_dmnx c," + user + ".d_dmbd d ";
                    sql += " where a.stt=t.id and t.manguon=b.id and t.nhomcc=c.id and a.mabd=d.id";
                    dtct = d.get_xuatsdct(s_mmyy, dt.Select("chon=false and id=" + idduyet, "stt"), sql, id, idduyet, bPhattron, i_thuoc, i_loai, file2, int.Parse(dr[i]["makp"].ToString()), int.Parse(dr[i]["makhoa"].ToString()), dr[i]["mabn"].ToString(), decimal.Parse(dr[i]["mavaovien"].ToString()), decimal.Parse(dr[i]["maql"].ToString()), decimal.Parse(dr[i]["idkhoa"].ToString()), s_ngay, decimal.Parse(dr[i]["sltd"].ToString()), bBuhaophi, dr[i]["ngayylenh"].ToString(), false, int.Parse(dr[i]["traituyen"].ToString()), "");
                    s_sttduyet = "";
                    foreach (DataRow r4 in dtct.Rows) s_sttduyet += r4["sttduyet"].ToString().Trim() + ",";
                    d.upd_ngayduyet(s_mmyy, i_nhom, i_loai, i_phieu, int.Parse(dr[i]["makhoa"].ToString()), s_ngay, idduyet, s_kho, s_sttduyet);
                    execute_data_mmyy("update xxx.d_duyet set done=2 where id=" + decimal.Parse(dr[i]["idduyet"].ToString()), s_ngay, s_ngay, true);
                    if (s_kho == "") execute_data_mmyy("update xxx.d_duyetkho set done=2 where idduyet=" + decimal.Parse(dr[i]["idduyet"].ToString()), s_ngay, s_ngay, true);
                    else
                    {
                        foreach (DataRow r4 in get_data("select * from " + user + ".d_dmkho where id in (" + s_kho.Substring(0, s_kho.Length - 1) + ")").Tables[0].Rows)
                            execute_data_mmyy("update xxx.d_duyetkho set done=2 where idduyet=" + decimal.Parse(dr[i]["idduyet"].ToString()) + " and makho=" + int.Parse(r4["id"].ToString()), s_ngay, s_ngay, true);
                    }
                }
            }
        }

        private DataTable butruc_congdon(DataTable dt, int i_nhom)
        {
            DataRow[] dr1, dr = dt.Select("chon=false and soluong>0", "makho,manguon,madoituong,mabd");
            dt.Columns.Add("Chon", typeof(bool));
            foreach (DataRow r in dt.Rows) r["chon"] = true;
            bool congdondoituong = bPhattron_congdondoituong(i_nhom);
            decimal d_soluong = 0, d_soluongcu = 0;
            foreach (DataRow r in dr)
            {
                sql = "makho=" + int.Parse(r["makho"].ToString()) + " and mabd=" + int.Parse(r["mabd"].ToString());
                if (bBucstt_nguon(i_nhom)) sql += " and manguon=" + int.Parse(r["manguon"].ToString());
                if (!congdondoituong) sql += " and madoituong=" + int.Parse(r["madoituong"].ToString());
                d_soluong = decimal.Parse(r["soluong"].ToString());
                foreach (DataRow r1 in dt.Select(sql, "id"))
                {
                    d_soluongcu = Math.Min(decimal.Parse(r1["soluong"].ToString()), d_soluong);
                    if (d_soluongcu > 0)
                    {
                        r1["soluong"] = d_soluongcu.ToString();
                        r1["chon"] = false;
                        d_soluong -= d_soluongcu;
                    }
                }
                if (d_soluong > 0)
                {
                    sql += " and chon=false";
                    dr1 = dt.Select(sql, "id");
                    if (dr1.Length > 0) dr1[0]["soluong"] = decimal.Parse(dr1[0]["soluong"].ToString()) + d_soluong;
                }
            }
            dt.AcceptChanges();
            return dt;
        }
        private void phieu_butruc(DataTable dt, string s_mmyy, string s_ngay, int i_nhom, int i_makp, int i_loai,
            int i_phieu, bool bPhattron, int i_thuoc, string s_kho, int itable, bool bBuhaophi, bool _b1kho,
            int i_userid, bool bCongdon, string s_makp, bool bTutrucchung, bool bBucstt_tronso, string file2)
        {
            LibDuoc.AccessData d = new LibDuoc.AccessData();
            string xxx = user + s_mmyy;
            DataTable dtct = new DataTable();
            if (bCongdon) butruc_congdon(dt, i_nhom);
            decimal id = 0, idduyet = 0;
            bool bGiaban = false, _bIntheocstt = bIntheocstt(i_nhom), bTreole = false;
            string s_sttduyet = "";
            if (!d.bGiaban_theodot(i_nhom))
                bGiaban = d.get_data("select * from " + user + ".d_doituong where loai=1").Tables[0].Rows.Count > 0;
            DataRow[] dr = dt.Select("chon=false and soluong>0", "id,stt");
            for (int i = 0; i < dr.Length; i++)
            {
                if (idduyet != decimal.Parse(dr[i]["id"].ToString()))
                {
                    d.upd_eve_tables(s_mmyy, itable, i_userid, "ins");
                    idduyet = decimal.Parse(dr[i]["id"].ToString());
                    id = d.get_id_xuatsd;
                    d.upd_xuatsdll(s_mmyy, id, i_nhom, dr[i]["mabn"].ToString(), decimal.Parse(dr[i]["mavaovien"].ToString()), decimal.Parse(dr[i]["maql"].ToString()), decimal.Parse(dr[i]["idkhoa"].ToString()), s_ngay, i_loai, i_phieu, int.Parse(dr[i]["makp"].ToString()), i_userid, idduyet, i_thuoc, int.Parse(dr[i]["makhoa"].ToString()), (_b1kho) ? int.Parse(s_kho.Substring(0, s_kho.Length - 1)) : 0, (bPhattron) ? 1 : 0, "", dr[i]["ngayylenh"].ToString(), 0, "");
                    //
                    d.execute_data("update " + d.user + s_mmyy + ".d_xuatsdll set traituyen=" + dr[i]["traituyen"].ToString() + " where id=" + id);
                    //
                    sql = "select a.*,t.manguon,t.nhomcc,t.handung,t.losx,t.giamua,";
                    if (bGiaban) sql += "d.giaban,";
                    else sql += "t.giaban,";
                    sql += "t.tyle_ggia,t.st_ggia,b.ten as tennguon,c.ten as tennhomcc ";
                    sql += " from " + xxx + ".d_tonkhoct a," + xxx + ".d_theodoi t," + user + ".d_dmnguon b," + user + ".d_dmnx c," + user + ".d_dmbd d";
                    sql += " where a.stt=t.id and t.manguon=b.id and t.nhomcc=c.id and a.mabd=d.id";
                    dtct = d.get_xuatsdct(s_mmyy, dt.Select("chon=false and id=" + idduyet, "stt"), sql, id, idduyet, bPhattron, i_thuoc, i_loai, file2, int.Parse(dr[i]["makp"].ToString()), int.Parse(dr[i]["makhoa"].ToString()), dr[i]["mabn"].ToString(), decimal.Parse(dr[i]["mavaovien"].ToString()), decimal.Parse(dr[i]["maql"].ToString()), decimal.Parse(dr[i]["idkhoa"].ToString()), s_ngay, decimal.Parse(dr[i]["sltd"].ToString()), bBuhaophi, dr[i]["ngayylenh"].ToString(), bTreole, int.Parse(dr[i]["traituyen"].ToString()), "");
                    s_sttduyet = "";
                    foreach (DataRow r4 in dtct.Select("true and treo=0")) s_sttduyet += r4["sttduyet"].ToString().Trim() + ",";
                    d.upd_ngayduyet(s_mmyy, i_nhom, i_loai, i_phieu, (_bIntheocstt) ? int.Parse(dr[i]["makp"].ToString()) : int.Parse(dr[i]["makhoa"].ToString()), s_ngay, (s_sttduyet != "") ? idduyet : 0, s_kho, s_sttduyet);
                    execute_data_mmyy("update xxx.d_duyet set done=2 where id=" + decimal.Parse(dr[i]["idduyet"].ToString()), s_ngay, s_ngay, true);
                    if (s_kho == "") execute_data_mmyy("update xxx.d_duyetkho set done=2 where idduyet=" + decimal.Parse(dr[i]["idduyet"].ToString()), s_ngay, s_ngay, true);
                    else
                    {
                        foreach (DataRow r4 in get_data("select * from " + user + ".d_dmkho where id in (" + s_kho.Substring(0, s_kho.Length - 1) + ")").Tables[0].Rows)
                            execute_data_mmyy("update xxx.d_duyetkho set done=2 where idduyet=" + decimal.Parse(dr[i]["idduyet"].ToString()) + " and makho=" + int.Parse(r4["id"].ToString()), s_ngay, s_ngay, true);
                    }
                }
            }
            if (bBucstt_tronso)
            {
                foreach (DataRow r4 in dt.Select("treo=1"))
                    d.execute_data("update " + user + ".d_treoduyet set slthuc=slthuc+" + decimal.Parse(r4["soluong"].ToString()) + " where id=" + decimal.Parse(r4["id"].ToString()) + " and stt=" + int.Parse(r4["stt"].ToString()));// + " and slthuc=0");
                if (!bTreole)
                {
                    foreach (DataRow r4 in dt.Select("chon=true or soluongyc<>soluong"))
                    {
                        //d.execute_data("update " + user + ".d_treoduyet set slthuc=0 where id=" + decimal.Parse(r4["id"].ToString()) + " and stt=" + int.Parse(r4["stt"].ToString()));// + " and slthuc<>0");
                        d.upd_treoduyet(decimal.Parse(r4["id"].ToString()), int.Parse(r4["stt"].ToString()), int.Parse(r4["madoituong"].ToString()), int.Parse(r4["makho"].ToString()), int.Parse(r4["mabd"].ToString()), decimal.Parse(r4["soluongyc"].ToString()), (decimal.Parse(r4["soluongyc"].ToString()) == decimal.Parse(r4["soluong"].ToString())) ? 0 : decimal.Parse(r4["soluong"].ToString()), int.Parse(r4["manguon"].ToString()));
                        execute_data_mmyy("update xxx.d_xtutrucct set slthuc=" + decimal.Parse(r4["soluongyc"].ToString()) + " where id=" + decimal.Parse(r4["id"].ToString()) + " and stt=" + int.Parse(r4["stt"].ToString()), s_ngay, s_ngay, true);
                    }
                }
            }
        }

        public bool bThuphi(int madoituong)
        {
            return get_data("select * from " + user + ".doituong where madoituong=" + madoituong + " and mien=0 and trasau=0 and madoituong<>1").Tables[0].Rows.Count > 0;
        }


        public bool upd_dmhuyet(decimal id, decimal stt, string ten, string mabs, string maicd, string noidung, int userid)
        {
            sql = "update " + user + ".dmhuyet set stt=" + stt + ",ten=:ten,mabs=:mabs,maicd=:maicd,noidung=:noidung,userid=" + userid + " where id=" + id;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                cmd.Parameters.Add("mabs", NpgsqlDbType.Varchar, 4).Value = mabs;
                cmd.Parameters.Add("maicd", NpgsqlDbType.Varchar, 9).Value = maicd;
                cmd.Parameters.Add("noidung", NpgsqlDbType.Text).Value = noidung;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dmhuyet(id,stt,ten,mabs,maicd,noidung,userid) values (" + id + "," + stt + ",:ten,:mabs,:maicd,:noidung," + userid + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("ten", NpgsqlDbType.Text).Value = ten;
                    cmd.Parameters.Add("mabs", NpgsqlDbType.Varchar, 4).Value = mabs;
                    cmd.Parameters.Add("maicd", NpgsqlDbType.Varchar, 9).Value = maicd;
                    cmd.Parameters.Add("noidung", NpgsqlDbType.Text).Value = noidung;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dmhuyet");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_bsnghi(string mabs, string tu, string den, string ghichu, string mabsc, int userid)
        {
            sql = "update " + user + ".bsnghi set ghichu=:ghichu,mabsc='" + mabsc + "',userid=" + userid;
            sql += " where mabs='" + mabs + "' and to_char(tu,'dd/mm/yyyy hh24:mi')='" + tu + "' and to_char(den,'dd/mm/yyyy hh24:mi')='" + den + "'";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("ghichu", NpgsqlDbType.Text).Value = ghichu;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".bsnghi(mabs,tu,den,ghichu,mabsc,userid)";
                    sql += " values ('" + mabs + "',to_timestamp('" + tu + "','dd/mm/yyyy hh24:mi'),to_timestamp('" + den + "','dd/mm/yyyy hh24:mi'),:ghichu,'" + mabsc + "'," + userid + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("ghichu", NpgsqlDbType.Text).Value = ghichu;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "bsnghi");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool get_paid(string mabn, decimal maql, decimal idkhoa, string ngay)
        {
            string stime = "'dd/mm/yyyy'";
            sql = "select mabn from " + user + ".v_paid where mabn='" + mabn + "'";
            sql += " and " + for_ngay("ngayvao", stime) + "<=to_date('" + ngay + "','dd/mm/yyyy') ";
            sql += " and " + for_ngay("ngayra", stime) + ">=to_date('" + ngay + "','dd/mm/yyyy') ";
            if (idkhoa != 0) sql += " and idkhoa=" + idkhoa;
            else sql += " and maql=" + maql;
            ds = get_data(sql);
            return ds.Tables[0].Rows.Count > 0;
        }

        public void updrec_tamung(DataTable dt, decimal id, string ngay, string makp, string tenkp, int madoituong, string doituong, string ten, decimal sotien, int done)
        {
            string exp = "id=" + id;
            DataRow r = getrowbyid(dt, exp);
            if (r == null)
            {
                DataRow nrow = dt.NewRow();
                nrow["id"] = id;
                nrow["ngay"] = ngay;
                nrow["makp"] = makp;
                nrow["tenkp"] = tenkp;
                nrow["madoituong"] = madoituong;
                nrow["doituong"] = doituong;
                nrow["ten"] = ten;
                nrow["sotien"] = sotien;
                nrow["done"] = done;
                dt.Rows.Add(nrow);
            }
            else
            {
                DataRow[] dr = dt.Select(exp);
                dr[0]["ngay"] = ngay;
                dr[0]["makp"] = makp;
                dr[0]["tenkp"] = tenkp;
                dr[0]["madoituong"] = madoituong;
                dr[0]["doituong"] = doituong;
                dr[0]["ten"] = ten;
                dr[0]["sotien"] = sotien;
                dr[0]["done"] = done;
            }
        }
        public void updrec_vpkhoa(DataTable dt, string mabn, string hoten, decimal maql, decimal idkhoa)
        {
            string exp = "idkhoa=" + idkhoa;
            DataRow r = getrowbyid(dt, exp);
            if (r == null)
            {
                DataRow nrow = dt.NewRow();
                nrow["mabn"] = mabn;
                nrow["hoten"] = hoten;
                nrow["maql"] = maql;
                nrow["idkhoa"] = idkhoa;
                dt.Rows.Add(nrow);
            }
            else
            {
                DataRow[] dr = dt.Select(exp);
                dr[0]["mabn"] = mabn;
                dr[0]["hoten"] = hoten;
                dr[0]["maql"] = maql;
                dr[0]["idkhoa"] = idkhoa;
            }
        }
        public decimal congno(int loai, string mabn, decimal maql, decimal idkhoa)
        {
            decimal ret = 0;
            sql = "select sum(a.thuoc+a.vienphi-a.tamung-a.mien) sotien from " + user + ".v_theodoicongno a," + user + ".doituong b where a.madoituong=b.madoituong and a.done=0";
            sql += " and a.mabn='" + mabn + "'";
            if (loai == 2) sql += " and a.maql=" + maql;
            else if (loai == 3) sql += " and a.idkhoa=" + idkhoa;
            ds = get_data(sql + " and (b.mien=0 or b.trasau=0)");
            if (ds.Tables[0].Rows[0]["sotien"].ToString() != "") ret = decimal.Parse(ds.Tables[0].Rows[0]["sotien"].ToString());
            return ret;
        }

        public decimal tamung_conlai(int loai, string mabn, decimal maql, decimal idkhoa)
        {
            decimal ret = 0;
            sql = "select sum(a.tamung-a.thuoc-a.vienphi+a.mien) sotien from " + user + ".v_theodoicongno a," + user + ".doituong b where a.madoituong=b.madoituong and a.done=0";
            sql += " and a.mabn='" + mabn + "'";
            if (loai == 2) sql += " and a.maql=" + maql;
            else if (loai == 3) sql += " and a.idkhoa=" + idkhoa;
            ds = get_data(sql + " and (b.mien=0 or b.trasau=0)");
            if (ds.Tables[0].Rows[0]["sotien"].ToString() != "") ret = decimal.Parse(ds.Tables[0].Rows[0]["sotien"].ToString());
            return ret;
        }

        public bool upd_m_thongso_tim(string stable, string m_ctlname, string m_ctltext, string m_loai)
        {
            sql = "update " + user + "." + stable + " set controltext=:m_ctltext where controlname=:m_ctlname";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("m_ctltext", NpgsqlDbType.Text).Value = m_ctltext;
                cmd.Parameters.Add("m_ctlname", NpgsqlDbType.Varchar).Value = m_ctlname;

                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + "." + stable + " (controlname, controltext, loai, ngayud) values (:m_ctlname,:m_ctltext,:m_loai,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ctlname", NpgsqlDbType.Varchar).Value = m_ctlname;
                    cmd.Parameters.Add("m_ctltext", NpgsqlDbType.Text).Value = m_ctltext;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Varchar).Value = m_loai;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "upd_m_thongso_tim");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_sophieucls(string m_mmyy, string m_mabn, decimal m_mavaovien, string m_ngay, int m_madoituong, string m_ghichu)
        {
            sql = "update " + user + m_mmyy + ".v_sophieucls set ghichu=:m_ghichu where mabn=:m_mabn and mavaovien=:m_mavaovien and to_char(ngay,'dd/mm/yyyy')=:m_ngay and madoituong=:m_madoituong";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text).Value = m_ghichu;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar).Value = m_ngay;
                cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "v_sophieucls");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public int get_sophieucls(string mmyy, string mabn, decimal mavaovien, string ngay, int madoituong, int userid)
        {
            int so = 0;
            string xxx = user + mmyy;
            DataTable dt = get_data("select so from " + xxx + ".v_sophieucls where so<>0 and mabn='" + mabn + "' and mavaovien=" + mavaovien + " and to_char(ngay,'dd/mm/yyyy')='" + ngay + "' and madoituong=" + madoituong).Tables[0];
            if (dt.Rows.Count > 0)
            {
                so = int.Parse(dt.Rows[0]["so"].ToString());
                execute_data("update " + xxx + ".v_sophieucls set lanin=lanin+1 where mabn='" + mabn + "' and mavaovien=" + mavaovien + " and to_char(ngay,'dd/mm/yyyy')='" + ngay + "' and madoituong=" + madoituong);
            }
            else
            {
                sql = "update " + xxx + ".d_capsotoa set sotoa=sotoa+1 where id=-89 and to_char(ngay,'dd/mm/yyyy')='" + ngay + "'";
                if (madoituong < 0) sql += " and loai=" + madoituong;
                else if (madoituong == 1) sql += " and loai=0";
                else sql += " and loai=1";
                sql += " and userid=" + userid;
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
                //
                sql = "select sotoa from " + xxx + ".d_capsotoa where id=-89 and to_char(ngay,'dd/mm/yyyy')='" + ngay + "'";
                if (madoituong < 0) sql += " and loai=" + madoituong;
                else if (madoituong == 1) sql += " and loai=0";
                else sql += " and loai=1";
                sql += " and userid=" + userid;
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                dest = new NpgsqlDataAdapter(cmd);
                ds = new DataSet();
                dest.Fill(ds);
                cmd.Dispose();
                //
                con.Close(); con.Dispose();
                so = int.Parse(ds.Tables[0].Rows[0]["sotoa"].ToString());
                upd_sophieucls(mmyy, mabn, mavaovien, ngay, madoituong, so, userid);
            }
            return so;
        }

        public void upd_sophieucls(string mmyy, string mabn, decimal mavaovien, string ngay, int madoituong, int so, int userid)
        {
            sql = "insert into " + user + mmyy + ".v_sophieucls(mabn,mavaovien,ngay,madoituong,so,lanin,userid) values ('" + mabn + "'," + mavaovien + ",to_timestamp('" + ngay + "','dd/mm/yyyy hh24:mi')," + madoituong + "," + so + ",1," + userid + ")";
            execute_data(sql);
        }

        public int get_laninkb(string mmyy, string mabn, decimal mavaovien, string ngay, int madoituong)
        {
            sql = "select lanin from " + user + mmyy + ".v_sophieucls where mabn='" + mabn + "' and mavaovien=" + mavaovien + " and to_char(ngay,'dd/mm/yyyy')='" + ngay + "' and madoituong=" + madoituong;
            DataTable tmp = get_data(sql).Tables[0];
            if (tmp.Rows.Count == 0) return 0;
            else return int.Parse(tmp.Rows[0]["lanin"].ToString());
        }

        public string get_ghichukb(string mmyy, string mabn, decimal mavaovien, string ngay, int madoituong)
        {
            sql = "select ghichu from " + user + mmyy + ".v_sophieucls where mabn='" + mabn + "' and mavaovien=" + mavaovien + " and to_char(ngay,'dd/mm/yyyy')='" + ngay + "' and madoituong=" + madoituong;
            DataTable tmp = get_data(sql).Tables[0];
            if (tmp.Rows.Count == 0) return "";
            else return tmp.Rows[0]["ghichu"].ToString();
        }

        public bool upd_capsotoa(string mmyy, int id, string ngay, int loai, int userid)
        {
            string xxx = user + mmyy;
            sql = "update " + xxx + ".capsotoa set id=" + id;
            sql += " where id=" + id + " and to_char(ngay,'dd/mm/yyyy')='" + ngay + "'";
            sql += " and loai=" + loai + " and userid=" + userid;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".capsotoa(id,ngay,loai,sotoa,userid) values ";
                    sql += "(" + id + ",to_timestamp('" + ngay + "','dd/mm/yyyy')," + loai + ",0," + userid + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ngay, ex.Message, sComputer, "capsotoa");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_capsotoa_yy(int id, string ngay, int loai, int userid)
        {
            string xxx = user;
            sql = "update " + xxx + ".capsotoa set id=" + id;
            sql += " where id=" + id + " and to_char(ngay,'dd/mm/yyyy')='" + ngay + "'";
            sql += " and loai=" + loai + " and userid=" + userid;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".capsotoa(id,ngay,loai,sotoa,userid) values ";
                    sql += "(" + id + ",to_timestamp('" + ngay + "','dd/mm/yyyy')," + loai + ",0," + userid + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ngay, ex.Message, sComputer, "capsotoa");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_capsotoacls(string d_mmyy, int d_id, string d_ngay, int d_loai, int d_userid)
        {
            sql = "update " + user + d_mmyy + ".d_capsotoa set id=:d_id where to_char(ngay,'dd/mm/yyyy')=:d_ngay and loai=:d_loai and userid=:d_userid and id=:d_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("d_id", NpgsqlDbType.Numeric).Value = d_id;
                cmd.Parameters.Add("d_ngay", NpgsqlDbType.Varchar, 10).Value = d_ngay;
                cmd.Parameters.Add("d_loai", NpgsqlDbType.Numeric).Value = d_loai;
                cmd.Parameters.Add("d_userid", NpgsqlDbType.Numeric).Value = d_userid;
                cmd.Parameters.Add("d_id", NpgsqlDbType.Numeric).Value = d_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + d_mmyy + ".d_capsotoa (id,ngay,loai,userid) values (:d_id,to_timestamp(:d_ngay,'dd/mm/yyyy'),:d_loai,:d_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("d_id", NpgsqlDbType.Numeric).Value = d_id;
                    cmd.Parameters.Add("d_ngay", NpgsqlDbType.Varchar, 10).Value = d_ngay;
                    cmd.Parameters.Add("d_loai", NpgsqlDbType.Numeric).Value = d_loai;
                    cmd.Parameters.Add("d_userid", NpgsqlDbType.Numeric).Value = d_userid;
                    cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(d_ngay, ex.Message, sComputer, "d_capsotoa");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool get_phongluu_nhapkhoa(decimal maql)
        {
            bool bRet = false;
            foreach (DataRow r0 in get_data("select mavaovien,to_char(ngay,'mmyy') as mmyy from " + user + ".benhandt where maql=" + maql).Tables[0].Rows)
            {
                if (bMmyy(r0["mmyy"].ToString()))
                {
                    bRet = get_data("select mabn from " + user + r0["mmyy"].ToString() + ".benhancc where mavaovien=" + decimal.Parse(r0["mavaovien"].ToString())).Tables[0].Rows.Count > 0;
                }
            }
            return bRet;
        }
        #region thongso_binh
        public bool bDuyet_donvepl
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1002");//F14.1
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bPhongluu_ra_captoave
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1001");//C59
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bPhongkham_batbuotxutri
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1003");//F14.1
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bPTTT_Xuatvien
        {
            //1: Khi BN xuat vien van cho nhap PTTT
            //0: Khi BN xuat vien  khong cho nhap PTTT
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1004");//I07
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bChuyenkham_Chitinhchenhlech
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1005");//G73
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }



        public bool bPhongluu_bhyt_khambenh_khongnhapvien
        {
            //chi tinh BHYT phong luu nhu PK khi BN vao phong luu nhung khong nhap vien
            get
            {
                try
                {

                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1006");//G73
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bKTCao_chitratoida
        {
            //chi tinh BHYT phong luu nhu PK khi BN vao phong luu nhung khong nhap vien
            get
            {
                try
                {

                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1007");//G73
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bTTRV_Intenhoatchat_Truoc
        {
            //In ten hoat chat truoc ten biet duoc trong phieu thanh toan ra vien
            get
            {
                try
                {

                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1009");//G75
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public decimal dKTCao_chitratoida
        {
            //chi tinh BHYT phong luu nhu PK khi BN vao phong luu nhung khong nhap vien
            get
            {
                try
                {

                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1008");//G73
                    return decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return decimal.Parse("26000000"); }
            }
        }
        public bool bChandoan_kemtheo_icd10
        {
            //false: cho phep nhap chan doan tu do: noi chuyen den, kem theo, phan biet..
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1010");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }
        public bool bChandoan_nguyennhan_icd10
        {
            //false: chaN DOAN nguyen nhan nhap tu do 
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1011");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bPhongkhamInchiphi_kemphongluu
        {
            //Khi in chi phí tại form kham benh se lay ca chi phi cua phong luu: khi phong luu chuyen sang phong kham
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1012");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        #endregion thongso_binh

        public string f_get_cdkemtheo(string ngay, decimal m_maql, int i_loai)
        {
            string m_cdkemtheo = "", m_icdkemtheo = "";
            string xxx = "";
            if (i_loai == 1 || i_loai == 2) xxx = user;
            else xxx = user + mmyy(ngay.Substring(0, 10));
            sql = "select * from " + xxx + ".cdkemtheo where maql = " + m_maql + " and loai=" + i_loai;
            foreach (DataRow r in get_data(sql).Tables[0].Rows)
            {
                m_cdkemtheo += (m_cdkemtheo.Trim().IndexOf(r["chandoan"].ToString() + ",") < 0) ? r["chandoan"].ToString() + ", " : "";
                m_icdkemtheo += (m_icdkemtheo.Trim().IndexOf(r["maicd"].ToString() + ",") < 0) ? r["maicd"].ToString() + ", " : "";
            }
            if (m_cdkemtheo.Trim().Trim(',') != "")
            {
                return m_cdkemtheo.Trim().Trim(',') + " [" + m_icdkemtheo.Trim().Trim(',') + "]";
            }
            else
                return "";
        }
        //
        public string get_chiphi_mabn(string mabn, decimal maql, int loaiba, bool full)
        {
            DataSet ds0 = new DataSet();
            DataSet dstmp0 = new DataSet();
            dstmp0.ReadXml("..//..//..//xml//m_chiphidt.xml");
            ds0.ReadXml("..//..//..//xml//m_chiphidt.xml");
            dstmp0 = load_danhsach(dstmp0, loaiba, mabn, maql, full);
            ds0.Clear();
            ds0 = dstmp0.Copy();
            return get_data(ds0, loaiba, full);
        }
        public string get_chiphi_mabn1(string mabn, decimal maql, int loaiba, bool full,decimal chiphihientai,int i_madoituong)
        {
            DataSet ds0 = new DataSet();
            DataSet dstmp0 = new DataSet();
            dstmp0.ReadXml("..//..//..//xml//m_chiphidt.xml");
            ds0.ReadXml("..//..//..//xml//m_chiphidt.xml");
            dstmp0 = load_danhsach(dstmp0, loaiba, mabn, maql, full);
            ds0.Clear();
            ds0 = dstmp0.Copy();
            return get_data1(ds0, loaiba, full,chiphihientai,i_madoituong);
        }
        private DataSet load_danhsach(DataSet dstmp0, int loaiba, string mabn, decimal maql, bool full)
        {
            if (loaiba == 2)
            {
                sql = "select 0 as id,a.mabn,a.hoten,b.maql,to_char(b.ngay,'dd/mm/yyyy hh24:mi') as ngayvao,";
                sql += " case when b.ngayrv is null then ' ' else to_char(b.ngayrv,'dd/mm/yyyy hh24:mi') end as ngayra,";
                sql += " to_char(sysdate,'dd/mm/yyyy') as den,";
                sql += " 00000000000.00 as thuoc,00000000000.00 as vienphi,00000000000.00 as sotien,";
                sql += " 00000000000.00 as tamung,00000000000.00 as conlai,f.mien,f.doituong,c.sothe,nvl(c.traituyen,0) as traituyen";
                sql += " from " + user + ".btdbn a inner join " + user + ".benhanngtr b ";
                sql += " on a.mabn=b.mabn left join " + user + ".bhyt c ";
                sql += " on b.maql=c.maql inner join " + user + ".doituong f on b.madoituong=f.madoituong ";
                sql += " where (c.sudung is null or c.sudung=1)";
                if (!full) sql += " and b.ttlucrv=0 and b.ngayrv is null";
                if (mabn != "") sql += " and a.mabn='" + mabn + "'";
                if (maql != 0) sql += " and (b.mavaovien=" + maql + " or b.maql=" + maql + ")";
                sql += " order by b.makp,b.ngay desc";
                dstmp0 = get_data(sql);
            }
            else if (loaiba == 4)
            {
                sql = "select 0 as id,a.mabn,a.hoten,b.maql,to_char(b.ngay,'dd/mm/yyyy hh24:mi') as ngayvao,";
                sql += " case when b.ngayrv is null then ' ' else to_char(b.ngayrv,'dd/mm/yyyy hh24:mi') end as ngayra,";
                sql += " to_char(sysdate,'dd/mm/yyyy') as den,";
                sql += " 00000000000.00 as thuoc,00000000000.00 as vienphi,00000000000.00 as sotien,";
                sql += " 00000000000.00 as tamung,00000000000.00 as conlai,f.mien,f.doituong,c.sothe,nvl(c.traituyen,0) as traituyen";
                sql += " from " + user + ".btdbn a inner join xxx.benhancc b ";
                sql += " on a.mabn=b.mabn left join xxx.bhyt c ";
                sql += " on b.maql=c.maql inner join " + user + ".doituong f on b.madoituong=f.madoituong ";
                sql += " where (c.sudung is null or c.sudung=1)";
                if (!full) sql += " and b.ngayrv is null";
                if (mabn != "") sql += " and a.mabn='" + mabn + "'";
                if (maql != 0) sql += " and b.maql=" + maql;
                sql += " order by b.makp,b.ngay desc";
                string s_nam = DateTime.Now.Year.ToString();
                string s_namtruoc = Convert.ToString(DateTime.Now.Year - 1);
                dstmp0 = get_data_yy(s_namtruoc, sql);
                dstmp0.Merge(get_data_yy(s_nam, sql));
            }
            else
            {
                sql = "select d.id,a.mabn,a.hoten,b.maql,to_char(d.ngay,'dd/mm/yyyy hh24:mi') as ngayvao,";
                sql += " case when e.ngay is null then ' ' else to_char(e.ngay,'dd/mm/yyyy hh24:mi') end as ngayra,";
                sql += " to_char(sysdate,'dd/mm/yyyy') as den,";
                sql += " 00000000000.00 as thuoc,00000000000.00 as vienphi,00000000000.00 as sotien,";
                sql += " 00000000000.00 as tamung,00000000000.00 as conlai,f.mien,f.doituong,c.sothe,nvl(c.traituyen,0) as traituyen";
                sql += " from " + user + ".btdbn a inner join " + user + ".benhandt b ";
                sql += " on a.mabn=b.mabn left join " + user + ".bhyt c ";
                sql += " on b.maql=c.maql inner join " + user + ".nhapkhoa d ";
                sql += " on b.maql=d.maql left join " + user + ".xuatkhoa e ";
                sql += " on d.id=e.id inner join " + user + ".doituong f on b.madoituong=f.madoituong ";
                sql += " inner join " + user + ".hiendien g on d.id=g.id ";
                sql += " where (c.sudung is null or c.sudung=1)";
                sql += " and g.nhapkhoa=1 and g.xuatkhoa=0";
                if (mabn != "") sql += " and a.mabn='" + mabn + "'";
                if (maql != 0) sql += " and b.maql=" + maql;
                sql += " order by g.makp,g.ngay desc";
                dstmp0 = get_data(sql);
            }
            return dstmp0;
        }
        private DataSet ins(string mabn, decimal id, decimal maql, string sothe, string denngay, string ngay1, string ngay2, string ngay3,
            int loaiba, DataTable dtdt, bool full)
        {
            DataSet ds0 = new DataSet();
            DataSet dsss0 = new DataSet();
            DataSet dsxml0 = new DataSet();

            dsxml0.ReadXml("..//..//..//xml//m_inravien.xml");
            dsxml0.Tables[0].Columns.Add("Image", typeof(byte[]));
            dsxml0.Tables[0].Columns.Add("Imagetk", typeof(byte[]));
            dsxml0.Tables[0].Columns.Add("Imageuser", typeof(byte[]));
            dsxml0.Tables[0].Columns.Add("mabs");
            dsxml0.Tables[0].Columns.Add("tenbs");
            dsxml0.Tables[0].Columns.Add("makprv");
            dsxml0.Tables[0].Columns.Add("cholam");
            dsxml0.Tables[0].Columns.Add("gianovat", typeof(decimal));
            dsxml0.Tables[0].Columns.Add("idttrv", typeof(decimal));
            dsxml0.Tables[0].Columns.Add("sotientra", typeof(decimal));
            dsxml0.Tables[0].Columns.Add("traituyen", typeof(decimal));
            dsxml0.Tables[0].Columns.Add("vattu", typeof(decimal));
            dsxml0.Tables[0].Columns.Add("ngay1");
            dsxml0.Tables[0].Columns.Add("ngay2");
            dsxml0.Tables[0].Columns.Add("ngay3");
            dsxml0.Tables[0].Columns.Add("kythuat", typeof(decimal));
            dsxml0.Tables[0].Columns.Add("loaikythuat", typeof(string));
            dsxml0.Tables[0].Columns.Add("quyenso_tt", typeof(string));
            dsxml0.Tables[0].Columns.Add("sobienlai_tt", typeof(string));
            dsxml0.Tables[0].Columns.Add("id_ktcao", typeof(decimal));

            ds0.ReadXml("..//..//..//xml//m_ravien.xml");
            ds0.Tables[0].Columns.Add("chon", typeof(bool));
            ds0.Tables[0].Columns.Add("mabs");
            ds0.Tables[0].Columns.Add("tenbs");
            ds0.Tables[0].Columns.Add("makprv");
            ds0.Tables[0].Columns.Add("cholam");
            ds0.Tables[0].Columns.Add("gianovat", typeof(decimal));
            ds0.Tables[0].Columns.Add("idttrv", typeof(decimal));
            ds0.Tables[0].Columns.Add("sotientra", typeof(decimal));
            ds0.Tables[0].Columns.Add("traituyen", typeof(decimal));
            ds0.Tables[0].Columns.Add("vattu", typeof(decimal));
            ds0.Tables[0].Columns.Add("ngay1");
            ds0.Tables[0].Columns.Add("ngay2");
            ds0.Tables[0].Columns.Add("ngay3");
            ds0.Tables[0].Columns.Add("kythuat", typeof(decimal));
            ds0.Tables[0].Columns.Add("loaikythuat", typeof(string));
            ds0.Tables[0].Columns.Add("quyenso_tt", typeof(string));
            ds0.Tables[0].Columns.Add("sobienlai_tt", typeof(string));
            ds0.Tables[0].Columns.Add("id_ktcao", typeof(decimal));

            dsss0.ReadXml("..//..//..//xml//m_ravienss.xml");
            dsss0.Tables[0].Columns.Add("chon", typeof(bool));
            dsss0.Tables[0].Columns.Add("mabs");
            dsss0.Tables[0].Columns.Add("tenbs");
            dsss0.Tables[0].Columns.Add("makprv");
            dsss0.Tables[0].Columns.Add("cholam");
            dsss0.Tables[0].Columns.Add("gianovat", typeof(decimal));
            dsss0.Tables[0].Columns.Add("idttrv", typeof(decimal));
            dsss0.Tables[0].Columns.Add("sotientra", typeof(decimal));
            dsss0.Tables[0].Columns.Add("traituyen", typeof(decimal));
            dsss0.Tables[0].Columns.Add("vattu", typeof(decimal));
            dsss0.Tables[0].Columns.Add("ngay1");
            dsss0.Tables[0].Columns.Add("ngay2");
            dsss0.Tables[0].Columns.Add("ngay3");
            dsss0.Tables[0].Columns.Add("kythuat", typeof(decimal));
            dsss0.Tables[0].Columns.Add("loaikythuat", typeof(string));
            dsss0.Tables[0].Columns.Add("quyenso_tt", typeof(string));
            dsss0.Tables[0].Columns.Add("sobienlai_tt", typeof(string));

            string s = "", makp = "";
            int nhom = nhom_duoc;
            bool bVienphi_phongluu = bCapcuu_noitru;
            DataTable dtkp = get_data("select * from " + user + ".d_duockp").Tables[0];
            sql = "select a.id,a.ma,trim(a.ten)||' '||trim(a.hamluong)||' ['||trim(b.ten)||']' as ten,";
            sql += "a.dang as dvt,c.stt as sttloai,c.ten as loai,d.stt as sttnhom,d.ten as nhom,a.bhyt,a.tenhc,trim(a.ten)||' '||trim(a.hamluong) as tenbd,a.gia_bh ";
            sql += ", a.kythuat,d.ma as manhomvp";
            if (bChenhlech_thuoc_dannhmuc) sql += ",a.chenhlech ";
            sql += " , a.kcct , a.bhyt as bhyt_tt, a.sothe";
            sql += " from " + user + ".d_dmbd a," + user + ".d_dmhang b," + user + ".d_dmnhom c," + user + ".v_nhomvp d";
            sql += " where a.mahang=b.id and a.manhom=c.id and c.nhomvp=d.ma";
            DataTable dtbd = get_data(sql).Tables[0];
            sql = "select a.id,a.ma,a.ten,a.dvt,b.stt as sttloai,b.ten as loai,c.stt as sttnhom,c.ten as nhom,a.bhyt";
            sql += ",a.gia_th,a.gia_bh,a.gia_dv,a.gia_nn,a.vattu_th,a.vattu_bh,a.vattu_dv,a.vattu_nn,a.gia_cs,a.vattu_cs,a.chenhlech ";
            sql += ", a.kythuat,c.ma as manhomvp, a.kcct, a.bhyt_tt, a.sothe";
            sql += " from " + user + ".v_giavp a," + user + ".v_loaivp b," + user + ".v_nhomvp c";
            sql += " where a.id_loai=b.id and b.id_nhom=c.ma";
            DataTable dtvp = get_data(sql).Tables[0];

            DataRow dr;
            DataTable tmp = new DataTable();
            if (loaiba == 1)
            {
                if (id == 0)
                {
                    sql = "select a.maql,a.mavaovien,to_char(a.ngay,'dd/mm/yyyy hh24:mi') as ngayvao,case when b.ngay is null then to_char(sysdate,'dd/mm/yyyy hh24:mi') else to_char(b.ngay,'dd/mm/yyyy hh24:mi') end as ngayra,b.makp,";
                    sql += "a.madoituong,c.sothe,nvl(c.traituyen,0) as traituyen from " + user + ".benhandt a left join " + user + ".xuatvien b on a.maql=b.maql ";
                    sql += " left join " + user + ".bhyt c on a.maql=c.maql ";
                    sql += " where a.mabn='" + mabn + "' and a.maql=" + maql;
                }
                else
                {
                    sql = "select h.maql,h.mavaovien,to_char(h.ngay,'dd/mm/yyyy hh24:mi') as ngayvao,case when b.ngay is null then to_char(sysdate,'dd/mm/yyyy hh24:mi') else to_char(b.ngay,'dd/mm/yyyy hh24:mi') end as ngayra,a.makp,";
                    sql += "h.madoituong,c.sothe,nvl(c.traituyen,0) as traituyen from " + user + ".nhapkhoa a left join " + user + ".xuatkhoa b on a.id=b.id ";
                    sql += " inner join " + user + ".benhandt h on a.maql=h.maql ";
                    sql += " left join " + user + ".bhyt c on a.maql=c.maql ";
                    sql += " where a.mabn='" + mabn + "' and a.maql=" + maql + " and a.id=" + id;
                }
                tmp = get_data(sql).Tables[0];
            }
            else if (loaiba == 4)
            {
                sql = "select h.maql,h.mavaovien,to_char(h.ngay,'dd/mm/yyyy hh24:mi') as ngayvao,case when h.ngayrv is null then to_char(sysdate,'dd/mm/yyyy hh24:mi') else to_char(h.ngayrv,'dd/mm/yyyy hh24:mi') end as ngayra,h.makp,";
                sql += "h.madoituong,c.sothe,nvl(c.traituyen,0) as traituyen from  xxx.benhancc h  ";
                sql += " left join xxx.bhyt c on h.maql=c.maql ";
                sql += " where h.mabn='" + mabn + "' and h.maql=" + maql;
                string s_nam = DateTime.Now.Year.ToString();
                string s_namtruoc = Convert.ToString(DateTime.Now.Year - 1);
                string sql1 = "select mmyy from " + user + ".tables where substr(mmyy,3,2)='" + s_namtruoc.Substring(2, 2) + "' order by mmyy";
                if (get_data(sql1).Tables[0].Rows.Count > 0) tmp = get_data_yy(s_namtruoc, sql).Tables[0];
                if (tmp == null) tmp = get_data_yy(s_nam, sql).Tables[0];
                else tmp.Merge(get_data_yy(s_nam, sql).Tables[0]);
            }
            else
            {
                sql = "select h.maql,h.mavaovien,to_char(h.ngay,'dd/mm/yyyy hh24:mi') as ngayvao,case when h.ngayrv is null then to_char(sysdate,'dd/mm/yyyy hh24:mi') else to_char(h.ngayrv,'dd/mm/yyyy hh24:mi') end as ngayra,h.makp,";
                sql += "h.madoituong,c.sothe,nvl(c.traituyen,0) as traituyen from  " + user + ".benhanngtr h  ";
                sql += " left join " + user + ".bhyt c on h.maql=c.maql ";
                sql += " where h.mabn='" + mabn + "' and h.maql=" + maql;
                tmp = get_data(sql).Tables[0];
            }
            string maso = "";
            foreach (DataRow r in tmp.Rows)
            {
                maso = maql.ToString() + ",";
                if (loaiba == 1)
                {
                    maso += get_maql_Capcuu_noitru(r["ngayvao"].ToString().Substring(0, 10), decimal.Parse(r["mavaovien"].ToString()));
                    maso += get_maql_Capve_noitru(r["ngayvao"].ToString().Substring(0, 10), decimal.Parse(r["mavaovien"].ToString()));
                }
                else if (loaiba == 2)
                {
                    maso += r["mavaovien"].ToString() + ",";
                    maso += get_maql_ngoaitru(r["ngayvao"].ToString().Substring(0, 10), r["ngayra"].ToString().Substring(0, 10), decimal.Parse(r["maql"].ToString()));
                }
                makp = r["makp"].ToString();
                s = get_doituong(mabn, maql, id, r["ngayvao"].ToString(), r["ngayra"].ToString(), "", dtkp, 2, bVienphi_phongluu, loaiba, (bChiphikp_noingoai) ? decimal.Parse(r["mavaovien"].ToString()) : 0);//(id!=0)?r["makp"].ToString():""
                if (s == "") s = r["madoituong"].ToString() + ",";
                foreach (DataRow r1 in dtdt.Rows)
                    if (s.IndexOf(r1["madoituong"].ToString().Trim() + ",") != -1)
                    {
                        dr = ds0.Tables[0].NewRow();
                        dr["madoituongvao"] = r["madoituong"].ToString();
                        dr["mabn"] = mabn;
                        dr["ngayvao"] = r["ngayvao"].ToString();
                        dr["ngayra"] = r["ngayra"].ToString();
                        dr["madoituong"] = r1["madoituong"].ToString();
                        dr["doituong"] = r1["doituong"].ToString();
                        dr["hinhthuc"] = 0;
                        dr["phuongphap"] = 0;
                        dr["ketqua"] = 0;
                        dr["sothe"] = r["sothe"].ToString();
                        dr["maphu"] = 0;
                        dr["makp"] = r["makp"].ToString();
                        dr["maql"] = maql;
                        dr["idkhoa"] = 0;
                        dr["denngay"] = denngay;
                        dr["done"] = (full) ? 3 : 2;
                        dr["chon"] = true;
                        dr["tresosinh"] = 0;
                        dr["khu"] = 0;
                        /*
                        dr["ngay1"] = ngay1;
                        dr["ngay2"] = ngay2;
                        dr["ngay3"] = ngay3;
                         * */
                        dr["id_ktcao"] = 0;
                        dr["maso"] = maso;
                        dr["traituyen"] = r["traituyen"].ToString();
                        ds0.Tables[0].Rows.Add(dr);
                    }
                break;
            }
            return get_ttravien_ct(dsxml0, ds0.Tables[0].Select("chon=true", "mabn"), dsss0.Tables[0].Select("chon=true", "mame,mabn"), dtkp, dtbd, dtvp, "", bVienphi_phongluu, loaiba, false, "", 0, false);
        }
        private string get_data(DataSet ds0, int loaiba, bool full)
        {
            DataSet dsxml0 = new DataSet();
            dsxml0.ReadXml("..//..//..//xml//m_inravien.xml");
            dsxml0.Tables[0].Columns.Add("Image", typeof(byte[]));
            dsxml0.Tables[0].Columns.Add("Imagetk", typeof(byte[]));
            dsxml0.Tables[0].Columns.Add("Imageuser", typeof(byte[]));
            dsxml0.Tables[0].Columns.Add("mabs");
            dsxml0.Tables[0].Columns.Add("tenbs");
            dsxml0.Tables[0].Columns.Add("makprv");
            dsxml0.Tables[0].Columns.Add("cholam");
            dsxml0.Tables[0].Columns.Add("gianovat", typeof(decimal));
            dsxml0.Tables[0].Columns.Add("idttrv", typeof(decimal));
            dsxml0.Tables[0].Columns.Add("sotientra", typeof(decimal));
            dsxml0.Tables[0].Columns.Add("traituyen", typeof(decimal));
            dsxml0.Tables[0].Columns.Add("vattu", typeof(decimal));
            dsxml0.Tables[0].Columns.Add("ngay1");
            dsxml0.Tables[0].Columns.Add("ngay2");
            dsxml0.Tables[0].Columns.Add("ngay3");
            dsxml0.Tables[0].Columns.Add("kythuat", typeof(decimal));
            dsxml0.Tables[0].Columns.Add("loaikythuat", typeof(string));
            try
            {
                ds0.Tables[0].Columns.Add("bhyttra", typeof(decimal)).DefaultValue = 0;
            }
            catch { }
            try
            {
                ds0.Tables[0].Columns.Add("bntra", typeof(decimal)).DefaultValue = 0;
            }
            catch { }
            dsxml0.Tables[0].Columns.Add("quyenso_tt", typeof(string));
            dsxml0.Tables[0].Columns.Add("sobienlai_tt", typeof(string));
            DataTable dtdt = get_data("select * from " + user + ".doituong").Tables[0];
            int nhom = nhom_duoc;
            string s_thuoc = "";
            foreach (DataRow r in get_data("select * from " + user + ".v_nhomvp where ma=" + iNhomvpthuoc).Tables[0].Rows)
                s_thuoc = r["ten"].ToString().Trim();
            decimal tamung = 0, th = 0, vp = 0, th20 = 0, vp20 = 20, st = 0, chiphi = 0, bh_th = 0, bh_vp = 0;
            DataRow r6;
            int maphu = 0;
            int _madt = -1;
            int tylechitra = 0, iTraituyen = iTraituyen_bhyt;
            decimal bhyttra, bntra, tbn, tbh, zbhyt, zst = 0, bntp_tra = 0;
            foreach (DataRow r in ds0.Tables[0].Select("true"))
            {
                dsxml0 = ins(r["mabn"].ToString(), decimal.Parse(r["id"].ToString()), decimal.Parse(r["maql"].ToString()), r["sothe"].ToString(), "", "", "", "", loaiba, dtdt, full);
                _madt = 0; zbhyt = tamung = th = vp = th20 = vp20 = bh_th = bh_vp = bntp_tra = zst = 0;
                foreach (DataRow r1 in dsxml0.Tables[0].Select("mabn='" + r["mabn"].ToString() + "' and tamung<>0", "madoituong"))
                {
                    if (int.Parse(r1["madoituong"].ToString()) != _madt)
                    {
                        tamung += decimal.Parse(r1["tamung"].ToString());
                        _madt = int.Parse(r1["madoituong"].ToString());
                    }
                }
                maphu = (r["sothe"].ToString().Trim() != "") ? get_maphu_noitru(r["sothe"].ToString(), nhom) : 0; zst = 0;
                foreach (DataRow r1 in dsxml0.Tables[0].Select("mabn='" + r["mabn"].ToString() + "'", "sttnhom,bntra desc"))
                {
                    st = decimal.Parse(r1["sotien"].ToString());
                    zst += st;
                    if (full)
                    {
                        if (int.Parse(r1["madoituong"].ToString()) == 1) th += st;
                    }
                    else
                    {
                        r6 = getrowbyid(dtdt, "madoituong=" + int.Parse(r1["madoituong"].ToString()) + " and mien=0");
                        if (r6 != null)
                        {
                            if (r1["nhom"].ToString().Trim() == s_thuoc)
                            {
                                th += st;
                            }
                            else
                            {
                                vp += st;
                            }
                            bntp_tra += st;
                        }
                        else if (int.Parse(r1["madoituong"].ToString()) == 1)
                        {
                            if (int.Parse(r["traituyen"].ToString()) != 0 && iTraituyen != 0)
                            {
                                tylechitra = (maphu == 0) ? 100 : (maphu == 1) ? 80 : 95;
                                bhyttra = st * tylechitra / 100;
                                bntra = st - bhyttra;
                                st = bhyttra;
                                tylechitra = iTraituyen;
                                tbh = st * tylechitra / 100;
                                tbn = st - (st * tylechitra / 100);
                                bntra += tbn;
                                if (r1["nhom"].ToString().Trim() == s_thuoc)
                                {
                                    bh_th += tbh;
                                    th20 = th20 + bntra;
                                }
                                else
                                {
                                    bh_vp += tbh;
                                    vp20 = vp20 + bntra;
                                }
                            }
                            else
                            {
                                tylechitra = (maphu == 0) ? 100 : (maphu == 1) ? 80 : 95;
                                bhyttra = st * tylechitra / 100;
                                bntra = st - bhyttra;
                                if (r1["nhom"].ToString().Trim() == s_thuoc)
                                {
                                    bh_th += st * tylechitra / 100;
                                    th20 = th20 + st - (st * tylechitra / 100);
                                }
                                else
                                {
                                    bh_vp += st * tylechitra / 100;
                                    vp20 = vp20 + st - (st * tylechitra / 100);
                                }
                            }
                            zbhyt += bhyttra;
                        }
                        else
                        {
                            if (r1["nhom"].ToString().Trim() == s_thuoc) th += st;
                            else vp += st;
                        }
                    }
                }
                r["tamung"] = tamung;
                r["thuoc"] = th + bh_th + th20;
                r["vienphi"] = vp + bh_vp + vp20;
                r["sotien"] = zst;
                r["bhyttra"] = bh_th + bh_vp;
                r["bntra"] = bntp_tra + th20 + vp20;
                r["conlai"] = decimal.Parse(r["bntra"].ToString()) - tamung;// zbhyt;
                chiphi = decimal.Parse(r["sotien"].ToString());
            }
            if (!full)
            {
                foreach (DataRow r in ds0.Tables[0].Rows)
                {
                    r6 = getrowbyid(dtdt, "doituong='" + r["doituong"].ToString() + "'");
                    if (r6 != null)
                    {
                        sql = "update " + user + ".v_theodoicongno set thuoc=" + decimal.Parse(r["thuoc"].ToString()) + ",vienphi=" + decimal.Parse(r["vienphi"].ToString()) + ",tamung=" + decimal.Parse(r["tamung"].ToString()) + ",mien=0 where madoituong=" + int.Parse(r6["madoituong"].ToString());
                        sql += " and mabn='" + r["mabn"].ToString() + "' and maql=" + decimal.Parse(r["maql"].ToString()) + " and idkhoa=" + decimal.Parse(r["id"].ToString());
                        execute_data(sql);
                    }
                }
            }
            bntp_tra += th20 + vp20;
            bh_th += bh_vp;
            return chiphi.ToString() + "~" + tamung.ToString() + "~" + bh_th.ToString() + "~" + bntp_tra.ToString();
        }
        private string get_data1(DataSet ds0, int loaiba, bool full,decimal chiphihientai,int madoituong)
        {
            DataSet dsxml0 = new DataSet();
            dsxml0.ReadXml("..//..//..//xml//m_inravien.xml");
            dsxml0.Tables[0].Columns.Add("Image", typeof(byte[]));
            dsxml0.Tables[0].Columns.Add("Imagetk", typeof(byte[]));
            dsxml0.Tables[0].Columns.Add("Imageuser", typeof(byte[]));
            dsxml0.Tables[0].Columns.Add("mabs");
            dsxml0.Tables[0].Columns.Add("tenbs");
            dsxml0.Tables[0].Columns.Add("makprv");
            dsxml0.Tables[0].Columns.Add("cholam");
            dsxml0.Tables[0].Columns.Add("gianovat", typeof(decimal));
            dsxml0.Tables[0].Columns.Add("idttrv", typeof(decimal));
            dsxml0.Tables[0].Columns.Add("sotientra", typeof(decimal));
            dsxml0.Tables[0].Columns.Add("traituyen", typeof(decimal));
            dsxml0.Tables[0].Columns.Add("vattu", typeof(decimal));
            dsxml0.Tables[0].Columns.Add("ngay1");
            dsxml0.Tables[0].Columns.Add("ngay2");
            dsxml0.Tables[0].Columns.Add("ngay3");
            dsxml0.Tables[0].Columns.Add("kythuat", typeof(decimal));
            dsxml0.Tables[0].Columns.Add("loaikythuat", typeof(string));
            try
            {
                ds0.Tables[0].Columns.Add("bhyttra", typeof(decimal)).DefaultValue = 0;
            }
            catch { }
            try
            {
                ds0.Tables[0].Columns.Add("bntra", typeof(decimal)).DefaultValue = 0;
            }
            catch { }
            dsxml0.Tables[0].Columns.Add("quyenso_tt", typeof(string));
            dsxml0.Tables[0].Columns.Add("sobienlai_tt", typeof(string));
            DataTable dtdt = get_data("select * from " + user + ".doituong").Tables[0];
            int nhom = nhom_duoc;
            string s_thuoc = "";
            foreach (DataRow r in get_data("select * from " + user + ".v_nhomvp where ma=" + iNhomvpthuoc).Tables[0].Rows)
                s_thuoc = r["ten"].ToString().Trim();
            decimal tamung = 0, th = 0, vp = 0, th20 = 0, vp20 = 20, st = 0, chiphi = 0, bh_th = 0, bh_vp = 0;
            DataRow r6;
            int maphu = 0,tem=0;
            int _madt = -1;
            int tylechitra = 0, iTraituyen = iTraituyen_bhyt;
            decimal bhyttra, bntra, tbn, tbh, zbhyt, zst = 0, bntp_tra = 0;
            foreach (DataRow r in ds0.Tables[0].Select("true"))
            {
                dsxml0 = ins(r["mabn"].ToString(), decimal.Parse(r["id"].ToString()), decimal.Parse(r["maql"].ToString()), r["sothe"].ToString(), "", "", "", "", loaiba, dtdt, full);
                _madt = 0; zbhyt = tamung = th = vp = th20 = vp20 = bh_th = bh_vp = bntp_tra = zst = 0;
                foreach (DataRow r1 in dsxml0.Tables[0].Select("mabn='" + r["mabn"].ToString() + "' and tamung<>0", "madoituong"))
                {
                    if (int.Parse(r1["madoituong"].ToString()) != _madt)
                    {
                        tamung += decimal.Parse(r1["tamung"].ToString());
                        _madt = int.Parse(r1["madoituong"].ToString());
                    }
                }
                maphu = (r["sothe"].ToString().Trim() != "") ? get_maphu_noitru(r["sothe"].ToString(), nhom) : 0; zst = 0;
                foreach (DataRow r1 in dsxml0.Tables[0].Select("mabn='" + r["mabn"].ToString() + "'", "sttnhom,bntra desc"))
                {
                    st = decimal.Parse(r1["sotien"].ToString());
                    zst += st;
                    if (tem == 0)
                    {
                        zst += chiphihientai;
                    }
                    r6 = getrowbyid(dtdt, "madoituong="+r1["madoituong"].ToString()+" or mien=1");
                    if (full)
                    {
                        if (int.Parse(r1["madoituong"].ToString()) == 1) th += st;
                    }
                    else
                    {
                        if (int.Parse(r1["madoituong"].ToString()) == 1)
                        {
                            if (int.Parse(r["traituyen"].ToString()) != 0 && iTraituyen != 0)
                            {
                                if (tem == 0 && madoituong == 1)
                                {
                                    st = st + chiphihientai;
                                    tylechitra = (maphu == 0) ? 100 : (maphu == 1) ? 80 : 95;
                                    bhyttra = st * tylechitra / 100;
                                    bntra = st - bhyttra;
                                    st = bhyttra;
                                    tylechitra = iTraituyen;
                                    tbh = st * tylechitra / 100;
                                    tbn = st - (st * tylechitra / 100);
                                    bntra += tbn;
                                    if (r1["nhom"].ToString().Trim() == s_thuoc)
                                    {
                                        bh_th += tbh;
                                        th20 = th20 + bntra;
                                    }
                                    else
                                    {
                                        bh_vp += tbh;
                                        vp20 = vp20 + bntra;
                                    }
                                }
                                else
                                {
                                    if (tem == 0)
                                    {
                                        st = st + chiphihientai;
                                        tylechitra = (maphu == 0) ? 100 : (maphu == 1) ? 80 : 95;
                                        bhyttra = st * tylechitra / 100;
                                        bntra = st - bhyttra;
                                        st = bhyttra;
                                        tylechitra = iTraituyen;
                                        tbh = st * tylechitra / 100;
                                        tbn = st - (st * tylechitra / 100);
                                        bntra += tbn;
                                        if (r1["nhom"].ToString().Trim() == s_thuoc)
                                        {
                                            bh_th += tbh;
                                            th20 = th20 + bntra;
                                        }
                                        else
                                        {
                                            bh_vp += tbh;
                                            vp20 = vp20 + bntra;
                                        }
                                    }
                                    else
                                    {
                                        tylechitra = (maphu == 0) ? 100 : (maphu == 1) ? 80 : 95;
                                        bhyttra = st * tylechitra / 100;
                                        bntra = st - bhyttra;
                                        st = bhyttra;
                                        tylechitra = iTraituyen;
                                        tbh = st * tylechitra / 100;
                                        tbn = st - (st * tylechitra / 100);
                                        bntra += tbn;
                                        if (r1["nhom"].ToString().Trim() == s_thuoc)
                                        {
                                            bh_th += tbh;
                                            th20 = th20 + bntra;
                                        }
                                        else
                                        {
                                            bh_vp += tbh;
                                            vp20 = vp20 + bntra;
                                        }
                                    }
                                }
                            }
                            else
                            {
                                if (tem == 0)
                                {
                                    st = st + chiphihientai;
                                    tylechitra = (maphu == 0) ? 100 : (maphu == 1) ? 80 : 95;
                                    bhyttra = st * tylechitra / 100;
                                    bntra = st - bhyttra;
                                    if (r1["nhom"].ToString().Trim() == s_thuoc)
                                    {
                                        bh_th += st * tylechitra / 100;
                                        th20 = th20 + st - (st * tylechitra / 100);
                                    }
                                    else
                                    {
                                        bh_vp += st * tylechitra / 100;
                                        vp20 = vp20 + st - (st * tylechitra / 100);
                                    }
                                }
                                else
                                {
                                    tylechitra = (maphu == 0) ? 100 : (maphu == 1) ? 80 : 95;
                                    bhyttra = st * tylechitra / 100;
                                    bntra = st - bhyttra;
                                    if (r1["nhom"].ToString().Trim() == s_thuoc)
                                    {
                                        bh_th += st * tylechitra / 100;
                                        th20 = th20 + st - (st * tylechitra / 100);
                                    }
                                    else
                                    {
                                        bh_vp += st * tylechitra / 100;
                                        vp20 = vp20 + st - (st * tylechitra / 100);
                                    }
                                }
                            }
                            zbhyt += bhyttra;
                        }
                        else if (int.Parse(r1["madoituong"].ToString()) != 5)//r6 == null && 
                        {
                            if (tem == 0)
                            {
                                r6 = getrowbyid(dtdt, "madoituong=" + madoituong + " or mien=1");
                                if (r6 == null && madoituong != 5)
                                {
                                    bntp_tra += chiphihientai;
                                }
                            }
                            bntp_tra += st;
                        }
                    }
                    tem++;
                }
                r["tamung"] = tamung;
                r["thuoc"] = th + bh_th + th20;
                r["vienphi"] = vp + bh_vp + vp20;
                r["sotien"] = zst;
                r["bhyttra"] = bh_th + bh_vp;
                r["bntra"] = bntp_tra + th20 + vp20;
                r["conlai"] = decimal.Parse(r["bntra"].ToString()) - tamung;// zbhyt;
                chiphi = decimal.Parse(r["sotien"].ToString());
            }
            bntp_tra += th20 + vp20;
            bh_th += bh_vp;
            return chiphi.ToString() + "~" + tamung.ToString() + "~" + bh_th.ToString() + "~" + bntp_tra.ToString();
        }
        public int get_maphu_noitru(string sothe, int nhom)
        {
            if (sothe == "") return 0;
            else return get_maphu(sothe);
        }
        public int get_maphu(string sothe)
        {
            try
            {
                string ma13 = ma13_vitri.ToString(), ma16 = ma16_vitri.ToString();
                int m131 = 4, m132 = 1, m161 = 4, m162 = 2, pos = 0;
                try
                {
                    if (ma13 != "")
                    {
                        pos = ma13.IndexOf(",");
                        if (pos != -1)
                        {
                            m131 = int.Parse(ma13.Substring(0, pos)) - 1;
                            m132 = int.Parse(ma13.Substring(pos + 1));
                        }
                    }
                    if (ma16 != "")
                    {
                        pos = ma16.IndexOf(",");
                        if (pos != -1)
                        {
                            m161 = int.Parse(ma16.Substring(0, pos)) - 1;
                            m162 = int.Parse(ma16.Substring(pos + 1));
                        }
                    }
                }
                catch { m131 = 4; m132 = 1; m161 = 4; m162 = 2; }
                if (sothe.Trim().Length == 18)
                {
                    string _mathecu_95 = mathecu_95;// "GL+JL+HN+HL";
                    return (_mathecu_95.IndexOf(sothe.Trim().Substring(m161, m162)) != -1) ? 2 : (get_ma16.IndexOf(sothe.Trim().Substring(m161, m162)) != -1) ? 1 : 0;
                }
                else
                    return (get_ma13.IndexOf(sothe.Trim().Substring(m131, m132)) != -1) ? 1 : (get_ma16_95.IndexOf(sothe.Trim().Substring(m131, m132)) != -1) ? 2 : 0;
            }
            catch { return 0; }
        }
        private string get_ma13 { get { return get_data("select ten from " + user + ".thongso where id=49").Tables[0].Rows[0][0].ToString(); } }
        private string get_ma16 { get { return get_data("select ten from " + user + ".thongso where id=50").Tables[0].Rows[0][0].ToString(); } }
        private string get_ma16_95 { get { return get_data("select ten from " + user + ".thongso where id=-50").Tables[0].Rows[0][0].ToString(); } }
        public string ma13_vitri
        {
            get
            {
                ds = get_data("select ten from " + user + ".d_thongso where id=52");
                if (ds.Tables[0].Rows.Count == 0) return "5,1";
                return ds.Tables[0].Rows[0][0].ToString().Trim();
            }
        }

        public string ma16_vitri
        {
            get
            {
                ds = get_data("select ten from " + user + ".d_thongso where id=53");
                if (ds.Tables[0].Rows.Count == 0) return "5,2";
                return ds.Tables[0].Rows[0][0].ToString().Trim();
            }
        }
        public string remove_text(string s1, string s2)
        {
            string[] a1 = s1.Trim(',').Split(',');
            string[] a2 = s2.Trim(',').Split(',');
            string s = "";
            bool bln = false;
            for (int i = 0; i < a1.Length; i++)
            {
                bln = false;
                for (int j = 0; j < a2.Length; j++)
                {
                    if (a1[i] == a2[j])
                    {
                        bln = true;
                        break;
                    }
                }
                if (!bln) s += a1[i] + ",";
            }
            return s;
        }

        public bool get_dain_chidinh(string mmyy, decimal id)
        {
            return get_data("select id from " + user + mmyy + ".v_chidinh where id=" + id + " and lan>0").Tables[0].Rows.Count > 0;
        }
        //
        public decimal get_mavaovien(decimal l_maql)
        {
            try
            {
                return decimal.Parse(get_data("select mavaovien from " + user + ".benhandt where maql=" + l_maql).Tables[0].Rows[0]["mavaovien"].ToString());
            }
            catch { return 0; }
        }

        public decimal get_maql_noitru_saucung(string m_mabn)
        {
            try
            {
                return decimal.Parse(get_data("select maql from " + user + ".benhandt where mabn='" + m_mabn + "' order by maql desc").Tables[0].Rows[0]["maql"].ToString());
            }
            catch { return 0; }
        }


        public decimal get_mavaovien_tiepdon(decimal l_maql, string mmyy)
        {
            try
            {
                return decimal.Parse(get_data("select mavaovien from " + user + mmyy + ".tiepdon where maql=" + l_maql).Tables[0].Rows[0]["mavaovien"].ToString());
            }
            catch { return 0; }
        }

        private DataSet get_cdkemtheo(string mavaovien, string tu, string den)
        {
            string asql = "select a.maicd, a.chandoan from xxx.cdkemtheo a inner join xxx.benhanpk b on a.maql=b.maql where b.mavaovien=" + mavaovien;
            asql += " union all ";
            asql += "select a.maicd, a.chandoan from xxx.cdkemtheo a inner join xxx.benhancc b on a.maql=b.maql where b.mavaovien=" + mavaovien;
            DataSet lds = get_data_mmyy(asql, tu, den, true);
            asql = "select a.maicd, a.chandoan from " + user + ".cdkemtheo a inner join " + user + ".benhandt b on a.maql=b.maql where b.mavaovien=" + mavaovien;
            lds.Merge(get_data(asql));
            return lds;
        }

        public void f_Traituyen_dungtuyen(string m_tu, string m_den, decimal m_maql, int m_traituyen)
        {
            //
            string suser = user;
            sql = "update xxx.v_chidinh set traituyen=" + m_traituyen + " where maql=" + m_maql + " and to_date(to_char(ngay,'dd/mm/yyyy'),'dd/mm/yyyy') between to_date('" + m_tu + "','dd/mm/yyyy') and to_date('" + m_den + "','dd/mm/yyyy')";
            execute_data_mmyy(sql, m_tu, m_den, true);
            //
            sql = "update xxx.v_vpkhoa set traituyen=" + m_traituyen + " where maql=" + m_maql + " and to_date(to_char(ngay,'dd/mm/yyyy'),'dd/mm/yyyy') between to_date('" + m_tu + "','dd/mm/yyyy') and to_date('" + m_den + "','dd/mm/yyyy')";
            execute_data_mmyy(sql, m_tu, m_den, true);
            //
            sql = "update xxx.d_tienthuoc set traituyen=" + m_traituyen + " where maql=" + m_maql + " and to_date(to_char(ngay,'dd/mm/yyyy'),'dd/mm/yyyy') between to_date('" + m_tu + "','dd/mm/yyyy') and to_date('" + m_den + "','dd/mm/yyyy')";
            execute_data_mmyy(sql, m_tu, m_den, true);
            //
            sql = "update xxx.d_xuatsdll set traituyen=" + m_traituyen + " where maql=" + m_maql + " and to_date(to_char(ngay,'dd/mm/yyyy'),'dd/mm/yyyy') between to_date('" + m_tu + "','dd/mm/yyyy') and to_date('" + m_den + "','dd/mm/yyyy')";
            execute_data_mmyy(sql, m_tu, m_den, true);
            //
        }

        public void f_upd_tuoivao(string m_maql, string m_tuoivao)
        {
            string s_user = user;
            sql = "update " + s_user + ".lienhe set tuoivao='" + m_tuoivao + "' where maql=" + m_maql;
            execute_data(sql);
            sql = "update " + s_user + ".nhapkhoa set tuoivao='" + m_tuoivao + "' where maql=" + m_maql;
            execute_data(sql);

        }
        public void f_upd_tuoivao(string m_maql, string m_tuoivao, string m_mmyy)
        {
            string s_user = user;
            if (bMmyy(m_mmyy))
            {
                sql = "update " + s_user + m_mmyy + ".lienhe set tuoivao='" + m_tuoivao + "' where maql=" + m_maql;
                execute_data(sql);
            }
        }
        public string f_ngaychuathanhtoan(string m_mabn)
        {
            string s_user = user;
            sql = " select a.maql, to_char(a.ngay,'dd/mm/yyyy') as ngayvao, to_char(b.ngay,'dd/mm/yyyy') as ngayra, b.sotien, b.paid, c.tenkp ";
            sql += " from " + s_user + ".benhandt a, " + s_user + ".xuatvien b , " + s_user + ".btdkp_bv c ";
            sql += " where a.maql=b.maql and b.makp=c.makp and a.mabn='" + m_mabn + "' and b.paid=0 and b.sotien>0 ";
            sql += " order by b.ngay desc ";
            DataSet lds = get_data(sql);
            string s_chuathanhtoan = "";
            foreach (DataRow r in lds.Tables[0].Rows)
            {
                //
                string s_ngayra = r["ngayra"].ToString();
                try
                {
                    sql = "select quyenso, sobienlai from xxx.v_ttrvds a, xxx.v_ttrvll b where a.id=b.id and a.maql=" + r["maql"].ToString() + " and a.mabn='" + m_mabn + "'";
                    DataSet lds1 = get_data_mmyy(sql, s_ngayra, s_ngayra, true);
                    if (lds1.Tables[0].Rows.Count > 0) s_chuathanhtoan = ""; //Khuong 09/12/2011
                    else s_chuathanhtoan = "Đợt điều trị của Bệnh nhân '" + m_mabn + "' (" + r["tenkp"].ToString() + "): vào từ ngày " + r["ngayvao"].ToString() + ", ra ngày : " + r["ngayra"].ToString() + "\nChưa làm thủ tục thanh toán, tổng Chi phí: " + r["sotien"].ToString() + "";
                }
                catch { }
                break;
            }
            return s_chuathanhtoan;
        }
        public string f_get_makp_bo(string s_makp)
        {
            string s_makp_bo = "";
            sql = "select distinct makpbo from " + user + ".btdkp_bv where makp in ('" + s_makp.Trim().Trim(',').Replace(",", "'',''") + "')";
            foreach (DataRow r in get_data(sql).Tables[0].Rows)
            {
                s_makp_bo += r["makpbo"].ToString() + ",";
            }
            return s_makp_bo.Trim().Trim(',');
        }

        public bool f_makp_is_phongkham(string s_makp)
        {
            bool bln = false;
            sql = "select distinct loai from " + user + ".btdkp_bv where loai=1 and makp in ('" + s_makp.Trim().Trim(',').Replace(",", "'',''") + "')";
            DataSet lds = get_data(sql);
            if (lds == null || lds.Tables.Count <= 0 || lds.Tables[0].Rows.Count <= 0) bln = false;
            else bln = true;

            return bln;
        }
        public string f_get_idduyet(string s_mmyy, string s_ngay, int i_nhom, int i_loai, int i_phieu, int i_makp, decimal l_idduyet_hientai)
        {
            sql = "select id from " + user + s_mmyy + ".d_duyet where nhom=" + i_nhom + " and loai=" + i_loai + " and phieu=" + i_phieu + " and makp=" + i_makp + " and to_char(ngay,'dd/mm/yyyy')='" + s_ngay + "'";
            DataSet lds = get_data(sql);
            string s_idduyet = "";
            foreach (DataRow r in lds.Tables[0].Rows)
            {
                s_idduyet += r["id"].ToString() + ",";
            }
            if (s_idduyet.IndexOf(l_idduyet_hientai.ToString() + ",") < 0) s_idduyet = "";
            return s_idduyet.Trim().Trim(',');
        }
        public string f_get_idduyet(string s_mmyy, string s_ngay, int i_nhom, int i_loai, int i_phieu, int i_makp, decimal l_idduyet_hientai, string s_makhoa)
        {
            sql = "select id from " + user + s_mmyy + ".d_duyet where nhom=" + i_nhom + " and loai=" + i_loai + " and phieu=" + i_phieu + " and makp=" + i_makp + " and to_char(ngay,'dd/mm/yyyy')='" + s_ngay + "' and makhoa=" + s_makhoa;
            DataSet lds = get_data(sql);
            string s_idduyet = "";
            foreach (DataRow r in lds.Tables[0].Rows)
            {
                s_idduyet += r["id"].ToString() + ",";
            }
            if (s_idduyet.IndexOf(l_idduyet_hientai.ToString() + ",") < 0) s_idduyet = "";
            return s_idduyet.Trim().Trim(',');
        }
        public void f_chuyen_idduyet(string mmyy, string m_idduyet, decimal l_idduyet, int i_loai)
        {
            if (m_idduyet.Trim().Trim(',') == "" || m_idduyet.Trim().Trim(',') == l_idduyet.ToString()) return;
            string xxx = user + mmyy;
            string s_table = "d_dutrull";
            if (i_loai == 1) s_table = "d_dutrull";
            else if (i_loai == 2) s_table = "d_xtutrucll";
            else if (i_loai == 3) s_table = "d_hoantrall";
            else if (i_loai == 4) s_table = "d_haophill";
            else s_table = "d_dutrull";
            sql = " update " + xxx + "." + s_table + " set idduyet=" + l_idduyet + " where idduyet in(" + m_idduyet.Trim().Trim(',') + ")";
            execute_data(sql);
            sql = " delete from  " + xxx + ".d_duyetkho where idduyet in(" + m_idduyet.Trim().Trim(',') + ") and idduyet<>" + l_idduyet;
            execute_data(sql);
            sql = " delete from  " + xxx + ".d_duyet where id in(" + m_idduyet.Trim().Trim(',') + ") and id<>" + l_idduyet;
            execute_data(sql);
        }

        public bool bNgaynghi(string ngay, DataTable dtletet)
        {
            string s_makho = "", s_kho = "", s_ngay = ngay, s_khong = "", s_khong1 = "";//, s_nguon_khoa = "";
            DataRow r;
            bool bln = false;

            s_ngay = ngay;
            r = getrowbyid(dtletet, "ngay='" + s_ngay.Substring(0, 5) + "'");
            bool bLetet = r != null;
            DateTime dt = StringToDate(s_ngay.Substring(0, 10));
            string ddd = dt.DayOfWeek.ToString().Substring(0, 3);
            bln = (bLetet || (ddd == "Sat") || (ddd == "Sun"));

            return bln;
        }

        public bool bNgaynghi(string ngay)
        {
            string s_makho = "", s_kho = "", s_ngay = ngay, s_khong = "", s_khong1 = "";//, s_nguon_khoa = "";
            DataRow r;
            bool bln = false;

            DataTable dtletet = get_data("select * from " + user + ".letet ").Tables[0];
            s_ngay = ngay;
            r = getrowbyid(dtletet, "ngay='" + s_ngay.Substring(0, 5) + "'");
            bool bLetet = r != null;
            DateTime dt = StringToDate(s_ngay.Substring(0, 10));
            string ddd = dt.DayOfWeek.ToString().Substring(0, 3);
            bln = (bLetet || (ddd == "Sat") || (ddd == "Sun"));

            return bln;
        }
        public DataSet f_get_quanhe(string m_mabn)
        {
            string s_nam = "";
            string s_user = user;
            sql = "select nam from " + s_user + ".btdbn where mabn='" + m_mabn + "'";
            DataSet lds = get_data(sql);
            foreach (DataRow r in lds.Tables[0].Rows)
            {
                s_nam = r["nam"].ToString();
                break;
            }
            sql = "select a.* from xxx.quanhe a inner join xxx.tiepdon b on a.maql=b.maql where b.mabn='" + m_mabn + "'";
            lds = get_data_nam_all_dec(s_nam, sql);

            return lds;
        }
        public string f_get_maql(decimal l_mavv, string tu, string den)
        {
            string s_maql = "";
            sql = "select maql from xxx.benhanpk where mavaovien=" + l_mavv;
            sql += " union all";
            sql += " select maql from xxx.benhancc where mavaovien=" + l_mavv;

            DataSet lds = get_data_mmyy(sql, tu, den, false);
            foreach (DataRow r in lds.Tables[0].Rows)
            {
                s_maql += r["maql"].ToString() + ",";
            }
            return s_maql.Trim().Trim(',');
        }
        public string f_get_maql(decimal l_mavv, string tu, string den, string makp)
        {
            string s_maql = "";
            sql = "select maql from xxx.benhanpk where mavaovien=" + l_mavv + " and makp='" + makp + "'";
            sql += " union all";
            sql += " select maql from xxx.benhancc where mavaovien=" + l_mavv + " and makp='" + makp + "'";

            DataSet lds = get_data_mmyy(sql, tu, den, false);
            foreach (DataRow r in lds.Tables[0].Rows)
            {
                s_maql += r["maql"].ToString() + ",";
            }
            return s_maql.Trim().Trim(',');
        }
        //
        #region TAOVIEW
        public void f_taoview_bhyt(string s_tungay)
        {
            if (s_tungay.Trim() == "") s_tungay = ngayhienhanh_server;
            else if (StringToDate(s_tungay) > StringToDate(ngayhienhanh_server)) s_tungay = ngayhienhanh_server;
            string suser = user, asql1 = "", xxx = "";
            string asql = "create or replace view " + suser + ".vbhyt_" + get_dmcomputer(System.Environment.MachineName).ToString().PadLeft(4, '0') + " as ";
            asql += " select mabn, maql, sothe, tungay, denngay, maphu, mabv, sudung, traituyen, ngay1, ngay2, ngay3 from " + suser + ".bhyt ";

            d = new LibDuoc.AccessData();
            DateTime dt1 = StringToDate(s_tungay).AddDays(-d.iNgaykiemke);
            DateTime dt2 = StringToDate(ngayhienhanh_server).AddDays(d.iNgaykiemke);
            int y1 = dt1.Year, m1 = dt1.Month;
            int y2 = dt2.Year, m2 = dt2.Month;
            int itu, iden;
            string mmyy = "";
            for (int i = y1; i <= y2; i++)
            {
                itu = (i == y1) ? m1 : 1;
                iden = (i == y2) ? m2 : 12;
                for (int j = itu; j <= iden; j++)
                {
                    mmyy = j.ToString().PadLeft(2, '0') + i.ToString().Substring(2, 2);
                    if (bMmyy(mmyy))
                    {
                        xxx = suser + mmyy;
                        if (asql1.Trim() != "") asql1 += " union ";
                        asql1 += " select mabn, maql, sothe, tungay, denngay, maphu, mabv, sudung, traituyen, ngay1, ngay2, ngay3 from " + xxx + ".bhyt ";
                    }
                }
            }
            asql += " union " + asql1;
            execute_data(asql);
        }
        public void f_taoview_cdkemtheo(string s_tungay)
        {
            if (s_tungay.Trim() == "") s_tungay = ngayhienhanh_server;
            else if (StringToDate(s_tungay) > StringToDate(ngayhienhanh_server)) s_tungay = ngayhienhanh_server;
            string suser = user, asql1 = "", xxx = "";
            string asql = "create or replace view " + suser + ".vcdkemtheo_" + get_dmcomputer(System.Environment.MachineName).ToString().PadLeft(4, '0') + " as ";
            asql += " select id, maql, loai, chandoan, maicd, stt from " + suser + ".cdkemtheo ";

            d = new LibDuoc.AccessData();
            DateTime dt1 = StringToDate(s_tungay).AddDays(-d.iNgaykiemke);
            DateTime dt2 = StringToDate(ngayhienhanh_server).AddDays(d.iNgaykiemke);
            int y1 = dt1.Year, m1 = dt1.Month;
            int y2 = dt2.Year, m2 = dt2.Month;
            int itu, iden;
            string mmyy = "";
            for (int i = y1; i <= y2; i++)
            {
                itu = (i == y1) ? m1 : 1;
                iden = (i == y2) ? m2 : 12;
                for (int j = itu; j <= iden; j++)
                {
                    mmyy = j.ToString().PadLeft(2, '0') + i.ToString().Substring(2, 2);
                    if (bMmyy(mmyy))
                    {
                        xxx = suser + mmyy;
                        if (asql1.Trim() != "") asql1 += " union ";
                        asql1 += " select id, maql, loai, chandoan, maicd, stt from " + xxx + ".bhyt ";
                    }
                }
            }
            asql += " union " + asql1;
            execute_data(asql);
        }

        public void f_taoview_pk_cc_ngtru_ntru(string s_tungay)
        {
            if (s_tungay.Trim() == "") s_tungay = ngayhienhanh_server;
            else if (StringToDate(s_tungay) > StringToDate(ngayhienhanh_server)) s_tungay = ngayhienhanh_server;
            string suser = user, asql1 = "", xxx = "";
            string asql = "create or replace view " + suser + ".vbenhanpk_" + get_dmcomputer(System.Environment.MachineName).ToString().PadLeft(4, '0') + " as ";
            asql += " select mabn, maql, mavaovien, ngay, makp, chandoan, maicd, madoituong, mabs, userid, loaiba from " + suser + ".benhandt ";
            asql += " union select mabn, maql, mavaovien, ngay, makp, chandoan, maicd, madoituong, mabs, userid, 2 as loaiba from " + suser + ".benhanngtr ";
            //asql += " union all select mabn, maql, mavaovien, ngay, makp, chandoan, maicd, madoituong, mabs, userid, 3 as loaiba from " + suser + ".benhanpk ";
            //asql += " union all select mabn, maql, mavaovien, ngay, makp, chandoan, maicd, madoituong, mabs, userid, 4 as loaiba from " + suser + ".benhancc ";


            d = new LibDuoc.AccessData();
            DateTime dt1 = StringToDate(s_tungay).AddDays(-d.iNgaykiemke);
            DateTime dt2 = StringToDate(ngayhienhanh_server).AddDays(d.iNgaykiemke);
            int y1 = dt1.Year, m1 = dt1.Month;
            int y2 = dt2.Year, m2 = dt2.Month;
            int itu, iden;
            string mmyy = "";
            for (int i = y1; i <= y2; i++)
            {
                itu = (i == y1) ? m1 : 1;
                iden = (i == y2) ? m2 : 12;
                for (int j = itu; j <= iden; j++)
                {
                    mmyy = j.ToString().PadLeft(2, '0') + i.ToString().Substring(2, 2);
                    if (bMmyy(mmyy))
                    {
                        xxx = suser + mmyy;
                        if (asql1.Trim() != "") asql1 += " union ";
                        asql1 += " select mabn, maql, mavaovien, ngay, makp, chandoan, maicd, madoituong, mabs, userid, 3 as loaiba from " + xxx + ".benhanpk ";
                        asql1 += " union select mabn, maql, mavaovien, ngay, makp, chandoan, maicd, madoituong, mabs, userid, 4 as loaiba from " + xxx + ".benhancc ";
                    }
                }
            }
            asql += " union " + asql1;
            execute_data(asql);
        }
        public string f_get_tendoituong(string madoituong)
        {
            string asql = "select doituong from " + user + ".doituong where madoituong=" + madoituong;
            return get_data(asql).Tables[0].Rows[0][0].ToString();
        }

        public string f_get_tuoivao(string tu, string den, decimal m_maql)
        {
            sql = "select tuoivao from xxx.lienhe where maql=" + m_maql;
            DataSet lds = get_data_mmyy(sql, tu, den, true);
            string s_tuoivao = "";
            foreach (DataRow r in lds.Tables[0].Rows)
            {
                s_tuoivao = r["tuoivao"].ToString().PadLeft(4, '0');
                break;
            }
            try
            {
                s_tuoivao = int.Parse(s_tuoivao.Substring(0, 3)).ToString() + ((s_tuoivao.Substring(3, 1) == "0") ? "" : (s_tuoivao.Substring(3, 1) == "1") ? " tháng" : (s_tuoivao.Substring(3, 1) == "2") ? " ngày" : " giờ");
            }
            catch { s_tuoivao = ""; }
            return s_tuoivao;
        }
        public string f_get_tuoivao(decimal m_maql)
        {
            sql = "select tuoivao from " + user + ".lienhe where maql=" + m_maql;
            DataSet lds = get_data(sql);
            string s_tuoivao = "";
            foreach (DataRow r in lds.Tables[0].Rows)
            {
                s_tuoivao = r["tuoivao"].ToString().PadLeft(4, '0');
                break;
            }
            try
            {
                s_tuoivao = int.Parse(s_tuoivao.Substring(0, 3)).ToString() + ((s_tuoivao.Substring(3, 1) == "0") ? "" : (s_tuoivao.Substring(3, 1) == "1") ? " tháng" : (s_tuoivao.Substring(3, 1) == "2") ? " ngày" : " giờ");
            }
            catch { s_tuoivao = ""; }
            return s_tuoivao;
        }

        public string f_get_tuoivao(string m_ngaysinh, string m_namsinh, string m_ngaykcb)
        {
            string s_tuoivao = (m_ngaysinh.Trim().Length == 10) ? Tuoivao_thang(m_ngaykcb, m_ngaysinh, m_namsinh) : "";
            if (s_tuoivao.Trim() == "0") return "";
            try
            {
                s_tuoivao = int.Parse(s_tuoivao.Substring(2)).ToString() + ((s_tuoivao.Substring(0, 1) == "0") ? "" : (s_tuoivao.Substring(0, 1) == "1") ? " tháng" : (s_tuoivao.Substring(0, 1) == "2") ? " ngày" : " giờ");
            }
            catch { s_tuoivao = ""; }
            return s_tuoivao;
        }
        #endregion
        //
        //
        // hien them cho bao cao bo y te
        #region update dm_11
        public bool upd_DM11(int m_ma, string m_stt, string m_ten, string m_icd10)
        {
            sql = "update medibv.DM_11 set stt='" + m_stt + "',ten=:m_ten, icd10='" + m_icd10 + "'  where ma=" + m_ma;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("m_ten", NpgsqlDbType.Varchar, 200).Value = m_ten;
            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into medibv.dm_11(ma,stt,ten,icd10) values ";
                    sql += " (" + m_ma + ",'" + m_stt + "',:m_ten,'" + m_icd10 + "')";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Varchar, 200).Value = m_ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_error(ex.Message, sComputer, "Dm_11");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }

        #endregion
        #region upd-danh muc
        public bool upd_danhmuc(string m_ma, string m_stt, string m_ten, string m_table)
        {
            sql = "update medibv." + m_table + " set stt=:m_stt,ten=:m_ten";
            sql += " where ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Varchar, 3).Value = m_stt;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 7).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into medibv." + m_table + " (ma,stt,ten) values (:m_ma,:m_stt,:m_ten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 7).Value = m_ma;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Varchar, 3).Value = m_stt;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, m_table);
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        #endregion
        #region upd danh mục điều kiện
        public bool upd_danhmuc_dk(string m_ma, string m_ten, string m_dk, string m_table)
        {
            sql = "update medibv." + m_table + " set dk=:m_dk,ten=:m_ten";
            sql += " where ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_dk", NpgsqlDbType.Text).Value = m_dk;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 3).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into medibv." + m_table + " (ma,dk,ten) values (:m_ma,:m_dk,:m_ten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 3).Value = m_ma;
                    cmd.Parameters.Add("m_dk", NpgsqlDbType.Text).Value = m_dk;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, m_table);
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        #endregion
        public void sort_stt02(string table)
        {
            string xxx = "medibv." + table;
            int i = 1, j = 0;
            execute_data("delete from " + xxx + " where stt in ('B','C')");
            foreach (DataRow r in get_data("select * from " + xxx + " where stt<>'A' order by ma").Tables[0].Rows)
            {
                j = int.Parse(r["ma"].ToString());
                upd_danhmuc((j < 50) ? 0 : 50, (j < 50) ? "B" : "C", (j < 50) ? "I. Tuyến huyện" : "II. Tuyến xã", table);
            }
            foreach (DataRow r in get_data("select * from " + xxx + " where ma between 1 and 49 order by ma").Tables[0].Rows)
            {
                upd_danhmuc(int.Parse(r["ma"].ToString()), i.ToString(), table);
                i++;
            }
            i = 1;
            foreach (DataRow r in get_data("select * from " + xxx + " where ma between 51 and 149 order by ma").Tables[0].Rows)
            {
                upd_danhmuc(int.Parse(r["ma"].ToString()), i.ToString(), table);
                i++;
            }
        }
        #region cap nhat dm loai co so
        public bool upd_dmloaics(int m_id, int m_stt, string m_ten, string m_table)
        {
            sql = "update medibv." + m_table + " set ten=:m_ten where  stt =:m_stt and id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;
            cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
            cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
            cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into medibv." + m_table + " (id,stt,ten) values (:m_id,:m_stt,:m_ten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch
            {
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        #endregion
        #region update danh muc bieu 03.1
        /// <summary>
        /// cập nhật danh mục cho biểu 03 của vụ kế hoạch
        /// </summary>
        public void upd_dmkhbieu_03()
        {
            System.Data.DataTable dt = get_data("Select a.ma as ma, a.ten as ten ,a.idloaicoso as idlcs,b.ten as tenlcs from medibv.DMCOSO a, medibv.DMLOAICOSO b where  a.idloaicoso = b.id and  a.IDLOAICOSO<> 0 ").Tables[0];
            DataRow[] dr;
            // quan ly nha nuoc
            execute_data("delete from medibv.KHDM_031");
            dr = dt.Select("idlcs=1");
            int index = 0;
            upd_danhmuc(-1, "A", "Tổng số", "khdm_031", index++, -1);
            if (dr.Length > 0)
            {
                upd_danhmuc(-2, "B", dr[0]["tenlcs"].ToString(), "KHDM_031", index++, -2);
                for (int i = 0; i < dr.Length; i++)
                {
                    upd_danhmuc(int.Parse(dr[i]["ma"].ToString()), (i + 1).ToString(), dr[i]["ten"].ToString(), "KHDM_031", index++, 1);
                }
            }
            // quan ly y te cac nganh
            dr = dt.Select("idlcs=2");
            if (dr.Length > 0)
            {

                upd_danhmuc(-3, "C", dr[0]["tenlcs"].ToString(), "KHDM_031", index++, 2);
                for (int i = 0; i < dr.Length; i++)
                {
                    upd_danhmuc(int.Parse(dr[i]["ma"].ToString()), (i + 1).ToString(), dr[i]["ten"].ToString(), "KHDM_031", index++, 2);
                }
            }
            // quan ly y te tu nhan
            dr = dt.Select("idlcs=3");
            if (dr.Length > 0)
            {

                upd_danhmuc(-4, "D", dr[0]["tenlcs"].ToString(), "KHDM_031", index++, -4);
                for (int i = 0; i < dr.Length; i++)
                {
                    upd_danhmuc(int.Parse(dr[i]["ma"].ToString()), (i + 1).ToString(), dr[i]["ten"].ToString(), "KHDM_031", index++, 3);
                }
            }

        }
        #endregion
        public bool upd_danhmuc(int m_ma, string m_stt, string m_ten, string m_table, int m_sttt, int m_idloaics)
        {
            sql = "update medibv." + m_table + " set stt=:m_stt,ten=:m_ten,sttt=:m_sttt,idloaics=:m_idloaics ";
            sql += " where ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Varchar, 3).Value = m_stt;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_sttt", NpgsqlDbType.Numeric).Value = m_sttt;
                cmd.Parameters.Add("m_idloaics", NpgsqlDbType.Numeric).Value = m_idloaics;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric, 1).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into medibv." + m_table + " (ma,stt,ten,idloaics,sttt) values (:m_ma,:m_stt,:m_ten,:m_idloaics,:m_sttt)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Varchar, 3).Value = m_stt;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text, 200).Value = m_ten;
                    cmd.Parameters.Add("m_idloaics", NpgsqlDbType.Numeric).Value = m_idloaics;
                    cmd.Parameters.Add("m_sttt", NpgsqlDbType.Numeric).Value = m_sttt;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, m_table);
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        #region  update danh muc tuyen
        public void upd_dmtuyen(int m_ma, string m_tuyen)
        {
            sql = "update medibv.dmtuyen set ten=:m_tuyen where ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(this.sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_tuyen", NpgsqlDbType.Varchar, 30).Value = m_tuyen;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int rec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (rec == 0)
                {
                    sql = "insert into medibv.dmtuyen(ma,ten) values (:m_ma,:m_tuyen)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_tuyen", NpgsqlDbType.Varchar, 30).Value = m_tuyen;
                    cmd.ExecuteNonQuery();
                }
            }
            catch (NpgsqlException er)
            {
                upd_error(er.Message, sComputer, "dmtuyen");
                return;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
                con.Dispose();
            }
        }
        #endregion
        #region sort_stt05
        public void sort_stt05(string table)
        {
            int i = 1, j = 0;
            execute_data("delete from medibv." + table + " where stt in ('I','II')");
            foreach (DataRow r in get_data("select * from medibv." + table + " where (stt<>'A' and stt<>'B')or(stt is null)  order by ma").Tables[0].Rows)
            {
                j = int.Parse(r["ma"].ToString());
                if (j < 150)
                    upd_danhmuc((j < 50) ? 0 : 50, (j < 50) ? "I" : "II", (j < 50) ? "- Cơ sở y tế tuyến huyện" : "- Trạm y tế", table);
            }
            foreach (DataRow r in get_data("select * from medibv." + table + " where ma between 1 and 49 order by ma").Tables[0].Rows)
            {
                upd_danhmuc(int.Parse(r["ma"].ToString()), i.ToString(), table);
                i++;
            }
            i = 1;
            foreach (DataRow r in get_data("select * from medibv." + table + " where ma between 51 and 149 order by ma").Tables[0].Rows)
            {
                upd_danhmuc(int.Parse(r["ma"].ToString()), i.ToString(), table);
                i++;
            }
            i = 1;
            foreach (DataRow r in get_data("select * from medibv." + table + " where ma >150 order by ma").Tables[0].Rows)
            {
                upd_danhmuc(int.Parse(r["ma"].ToString()), i.ToString(), table);
                i++;
            }
        }

        #endregion
        #region update bieu 01
        public bool upd_kh01(decimal m_id, string m_ma, string m_ngay, int m_c01, int m_c02, int m_c03, int m_c04,
            int m_c05, int m_c06, int m_c07, int m_c08, int m_c09,
            int m_c10, int m_c11, int m_c12, int m_c13, int m_c14, int m_c15, int m_c16, int m_userid)
        {
            sql = "update " + user + ".khbieu_01 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,c11=:m_c11,";
            sql += "c12=:m_c12,c13=:m_c13,c14=:m_c14,c15=:m_c15,c16=:m_c16,userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 7).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".khbieu_01(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,c13,c14,c15,c16,userid) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_c11,:m_c12,:m_c13,:m_c14,:m_c15,:m_c16,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 7).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                    cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                    cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                    cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                    cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                    cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "khbieu_01");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_kh01(decimal m_id, string m_ma, string m_ngay, int m_c01, int m_c02, int m_c03, int m_c04,
            int m_c05, int m_c06, int m_c07, int m_c08, int m_c09,
            int m_c10, int m_c11, int m_c12, int m_c13, int m_c14, int m_c15, int m_c16, int m_userid, int m_c17, int m_c18)
        {
            sql = "update " + user + ".khbieu_01 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,c11=:m_c11,";
            sql += "c12=:m_c12,c13=:m_c13,c14=:m_c14,c15=:m_c15,c16=:m_c16,userid=:m_userid ";
            sql += ", c17=:m_c17, c18=:m_c18";
            sql += " where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 7).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".khbieu_01(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,c13,c14,c15,c16,userid, c17, c18) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_c11,:m_c12,:m_c13,:m_c14,:m_c15,:m_c16,:m_userid, :m_c17, :m_c18)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 7).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                    cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                    cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                    cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                    cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                    cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                    cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "khbieu_01");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        #endregion
        #region Bieu 02
        public bool upd_kh02(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09,
            int m_c10, int m_c11, int m_c12, int m_c13, int m_c14, int m_c15, int m_c16, int m_userid)
        {
            sql = "update " + user + ".khbieu_02 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,";
            sql += "c11=:m_c11,c12=:m_c12,c13=:m_c13,c14=:m_c14,c15=:m_c15,c16=:m_c16,";
            sql += "userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".khbieu_02(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,c13,c14,c15,c16,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_c11,:m_c12,:m_c13,:m_c14,:m_c15,:m_c16,:m_userid,sysdate)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                    cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                    cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                    cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                    cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                    cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "khbieu_02");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        #endregion
        #region update danh muc co so
        public bool upd_dmcoso(int m_ma, string m_ten, int m_tuyen, int m_loaicoso)
        {
            sql = "update " + user + ".dmcoso set ten=:m_ten,tuyen=:m_tuyen,idloaicoso=" + m_loaicoso;
            sql += " where ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_tuyen", NpgsqlDbType.Numeric).Value = m_tuyen;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dmcoso(ma,ten,tuyen,idloaicoso) values (:m_ma,:m_ten,:m_tuyen," + m_loaicoso + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    cmd.Parameters.Add("m_tuyen", NpgsqlDbType.Numeric).Value = m_tuyen;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dmcoso");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        #endregion
        #region bieu 03.1 vu ke hoach
        public bool upd_kh031(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09,
            int m_c10, int m_c11, int m_userid)
        {
            sql = "update " + user + ".khbieu_031 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,";
            sql += "c11=:m_c11,";
            sql += "userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".khbieu_031(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_c11,:m_userid,sysdate)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "khbieu_031");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        #endregion
        public void updrec_021(DataTable dt, string ma, int col, Decimal so)
        {
            DataRow[] dr = dt.Select("stt='" + ma + "'");
            if (dr.Length > 0) dr[0][col] = so;
        }
        #region bieu 03.2 vu ke hoach
        public bool upd_kh032(decimal m_id, string m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_userid)
        {
            sql = "update " + user + ".khbieu_032 set ngay=:m_ngay, c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,";
            sql += "userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 8).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".khbieu_032(id,ma,ngay,c01,c02,c03,c04,c05,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_userid,sysdate)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 8).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "khbieu_032");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public void updrec_031(DataTable dt, string ma, int col, Decimal so)
        {
            DataRow[] dr = dt.Select("stt='" + ma + "'");
            if (dr.Length > 0) dr[0][col] = so;
        }
        #endregion
        #region bieu 04 ke hoach
        public bool upd_kh04(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09,
            int m_c10, int m_c11, int m_c12, int m_c13, int m_c14, int m_c15, int m_c16, int m_c17, int m_c18, int m_userid)
        {
            sql = "update " + user + ".khbieu_04 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,";
            sql += "c11=:m_c11,c12=:m_c12,c13=:m_c13,c14=:m_c14,c15=:m_c15,c16=:m_c16,c17=:m_c17,c18=:m_c18,";
            sql += "userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".khbieu_04(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,c13,c14,c15,c16,c17,c18,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_c11,:m_c12,:m_c13,:m_c14,:m_c15,:m_c16,:m_c17,:m_c18,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                    cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                    cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                    cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                    cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                    cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                    cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                    cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "kh_bieu_04");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        #endregion
        public void updrec_050(DataTable dt, string stt, int col, Decimal so)
        {
            Decimal l = 0;
            DataRow[] dr = dt.Select("stt='" + stt + "'");
            if (dr.Length != 0) dr[0][col] = so;
            if (stt != "B")
            {
                dr = dt.Select("stt='I'");
                if (dr.Length != 0) l += Decimal.Parse(dr[0][col].ToString());
                dr = dt.Select("stt='II'");
                if (dr.Length != 0) l += Decimal.Parse(dr[0][col].ToString());
                dr = dt.Select("stt='A'");
                if (dr.Length != 0) dr[0][col] = l;
            }
        }
        public bool upd_kh05_moi(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09,
            int m_c10, int m_c11, int m_c12, int m_c13, int m_c14, int m_userid)
        {
            sql = "update " + user + ".khbieu_05 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,";
            sql += "c11=:m_c11,c12=:m_c12,c13=:m_c13,c14=:m_c14,";
            sql += "userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".khbieu_05(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,c13,c14,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_c11,:m_c12,:m_c13,:m_c14,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                    cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                    cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                    cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "khbieu_05");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        #region ke hoach bieu 06
        public bool upd_kh06(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09,
            int m_c10, int m_userid)
        {
            sql = "update " + user + ".khbieu_06 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,";
            sql += "userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
            cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
            cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
            cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
            cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
            cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
            cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
            cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
            cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
            cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
            cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
            cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
            cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
            cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".khbieu_06(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,userid) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "khbieu_06");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }

        #endregion
        #region update bieu 07
        public bool upd_kh07_moi(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09, int m_userid)
        {
            sql = "update " + user + ".khbieu_07 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,";
            sql += "userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".khbieu_07(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "khbieu_07");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        #endregion
        public bool upd_kh08(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09, int m_c10, int m_userid)
        {
            sql = "update " + user + ".khbieu_08 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,";
            sql += "userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".khbieu_08(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "khbieu_08");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        #region update bieu 09 vu ke hoach
        public bool upd_kh09(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_userid)
        {
            sql = "update " + user + ".khbieu_09 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,";
            sql += "userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".khbieu_09(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "khbieu_09");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_kh09(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_userid, string m_ghichu)
        {
            sql = "update " + user + ".khbieu_09 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,";
            sql += "userid=:m_userid ";
            sql += ", ghichu=:m_ghichu";
            sql += " where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Varchar).Value = m_ghichu;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".khbieu_09(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,userid,ngayud, ghichu) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_userid,now(),:m_ghichu)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Varchar).Value = m_ghichu;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "khbieu_09");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        #endregion
        public bool upd_kh10(decimal m_id, string m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09,
            int m_c10, int m_c11, int m_userid)
        {
            sql = "update " + user + ".khbieu_10 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,";
            sql += "c11=:m_c11,";
            sql += "userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 7).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".khbieu_10(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_c11,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 7).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "khbieu_10");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_kh11(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09,
            int m_c10, int m_c11, int m_c12, int m_c13, int m_c14, int m_c15, int m_c16,
            int m_c17, int m_c18, int m_c19, int m_c20, int m_c21, int m_c22, int m_c23, int m_c24, int m_userid)
        {
            sql = "update " + user + ".khbieu_11 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,";
            sql += "c11=:m_c11,c12=:m_c12,c13=:m_c13,c14=:m_c14,c15=:m_c15,c16=:m_c16,c17=:m_c17,";
            sql += "c18=:m_c18,c19=:m_c19,c20=:m_c20,c21=:m_c21,c22=:m_c22,c23=:m_c23,c24=:m_c24,";
            sql += "userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                cmd.Parameters.Add("m_c20", NpgsqlDbType.Numeric).Value = m_c20;
                cmd.Parameters.Add("m_c21", NpgsqlDbType.Numeric).Value = m_c20;
                cmd.Parameters.Add("m_c22", NpgsqlDbType.Numeric).Value = m_c20;
                cmd.Parameters.Add("m_c23", NpgsqlDbType.Numeric).Value = m_c20;
                cmd.Parameters.Add("m_c24", NpgsqlDbType.Numeric).Value = m_c20;

                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".khbieu_11(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,c13,c14,c15,c16,c17,c18,c19,c20,c21,c22,c23,c24,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_c11,:m_c12,:m_c13,:m_c14,:m_c15,:m_c16,:m_c17,:m_c18,:m_c19,:m_c20,:m_c21,:m_c22,:m_c23,:m_c24,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                    cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                    cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                    cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                    cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                    cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                    cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                    cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                    cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                    cmd.Parameters.Add("m_c20", NpgsqlDbType.Numeric).Value = m_c20;
                    cmd.Parameters.Add("m_c21", NpgsqlDbType.Numeric).Value = m_c20;
                    cmd.Parameters.Add("m_c22", NpgsqlDbType.Numeric).Value = m_c20;
                    cmd.Parameters.Add("m_c23", NpgsqlDbType.Numeric).Value = m_c20;
                    cmd.Parameters.Add("m_c24", NpgsqlDbType.Numeric).Value = m_c20;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "khbieu_11");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_kh121(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_userid)
        {
            sql = "update " + user + ".khbieu_121 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,";
            sql += "userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".khbieu_121(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "khbieu_121");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        //
        public bool upd_kh122(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09,
            int m_c10, int m_userid)
        {
            sql = "update " + user + ".khbieu_122 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".khbieu_122(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "khbieu_122");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        #region ke hoach bieu 13
        public bool upd_kh13(decimal m_id, int m_ma, string m_ngay, int m_soluong, string m_ghichu, int m_userid)
        {
            sql = "update " + user + ".khbieu_13 set ngay=:m_ngay,soluong=:m_soluong, ghichu=:m_ghichu,userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
            cmd.Parameters.Add("m_soluong", NpgsqlDbType.Numeric).Value = m_soluong;
            cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text).Value = m_ghichu;
            cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
            cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
            cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".khbieu_13(id,ma,ngay,soluong,ghichu,userid) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_soluong,:m_ghichu,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_soluong", NpgsqlDbType.Numeric).Value = m_soluong;
                    cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text).Value = m_ghichu;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "khbieu_13");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        #endregion

        public bool upd_kh141(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09,
            int m_c10, int m_c11, int m_c12, int m_c13, int m_c14, int m_c15, int m_c16,
            int m_c17, int m_c18, int m_c19, int m_c20, int m_userid)
        {
            sql = "update " + user + ".khbieu_141 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,";
            sql += "c11=:m_c11,c12=:m_c12,c13=:m_c13,c14=:m_c14,c15=:m_c15,c16=:m_c16,c17=:m_c17,";
            sql += "c18=:m_c18,c19=:m_c19,c20=:m_c20,userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                cmd.Parameters.Add("m_c20", NpgsqlDbType.Numeric).Value = m_c20;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".khbieu_141(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,c13,c14,c15,c16,c17,c18,c19,c20,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_c11,:m_c12,:m_c13,:m_c14,:m_c15,:m_c16,:m_c17,:m_c18,:m_c19,:m_c20,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                    cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                    cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                    cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                    cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                    cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                    cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                    cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                    cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                    cmd.Parameters.Add("m_c20", NpgsqlDbType.Numeric).Value = m_c20;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "khbieu_141");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_kh142(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09,
            int m_c10, int m_c11, int m_c12, int m_c13, int m_c14, int m_c15, int m_c16,
            int m_c17, int m_c18, int m_c19, int m_c20, int m_userid)
        {
            sql = "update " + user + ".khbieu_142 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,";
            sql += "c11=:m_c11,c12=:m_c12,c13=:m_c13,c14=:m_c14,c15=:m_c15,c16=:m_c16,c17=:m_c17,";
            sql += "c18=:m_c18,c19=:m_c19,c20=:m_c20,";
            sql += "userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                cmd.Parameters.Add("m_c20", NpgsqlDbType.Numeric).Value = m_c20;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".khbieu_142(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,c13,c14,c15,c16,c17,c18,c19,c20,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_c11,:m_c12,:m_c13,:m_c14,:m_c15,:m_c16,:m_c17,:m_c18,:m_c19,:m_c20,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                    cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                    cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                    cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                    cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                    cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                    cmd.Parameters.Add("m_c17", NpgsqlDbType.Numeric).Value = m_c17;
                    cmd.Parameters.Add("m_c18", NpgsqlDbType.Numeric).Value = m_c18;
                    cmd.Parameters.Add("m_c19", NpgsqlDbType.Numeric).Value = m_c19;
                    cmd.Parameters.Add("m_c20", NpgsqlDbType.Numeric).Value = m_c20;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "khbieu_142");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_kh143(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09,
            int m_c10, int m_c11, int m_c12, int m_c13, int m_c14, int m_c15, int m_c16, int m_userid)
        {
            sql = "update " + user + ".khbieu_143 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,";
            sql += "c11=:m_c11,c12=:m_c12,c13=:m_c13,c14=:m_c14,c15=:m_c15,c16=:m_c16,";
            sql += "userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".khbieu_143(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,c13,c14,c15,c16,userid,ngayud) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_c11,:m_c12,:m_c13,:m_c14,:m_c15,:m_c16,:m_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                    cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                    cmd.Parameters.Add("m_c13", NpgsqlDbType.Numeric).Value = m_c13;
                    cmd.Parameters.Add("m_c14", NpgsqlDbType.Numeric).Value = m_c14;
                    cmd.Parameters.Add("m_c15", NpgsqlDbType.Numeric).Value = m_c15;
                    cmd.Parameters.Add("m_c16", NpgsqlDbType.Numeric).Value = m_c16;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "khbieu_143");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        #region update bieu 15
        public bool upd_kh15(decimal m_id, int m_ma, string m_ngay, int m_c01, int m_c02,
            int m_c03, int m_c04, int m_c05, int m_c06, int m_c07, int m_c08, int m_c09, int m_c10, int m_c11, int m_c12, int m_userid)
        {
            sql = "update " + user + ".khbieu_15 set ngay=:m_ngay,c01=:m_c01,c02=:m_c02,c03=:m_c03,c04=:m_c04,";
            sql += "c05=:m_c05,c06=:m_c06,c07=:m_c07,c08=:m_c08,c09=:m_c09,c10=:m_c10,c11=:m_c11,c12=:m_c12,";
            sql += "userid=:m_userid where id=:m_id and ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
            cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
            cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
            cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
            cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
            cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
            cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
            cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
            cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
            cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
            cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
            cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
            cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
            cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
            cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
            cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".khbieu_15(id,ma,ngay,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,userid) values ";
                    sql += "(:m_id,:m_ma,:m_ngay,:m_c01,:m_c02,:m_c03,:m_c04,:m_c05,:m_c06,:m_c07,:m_c08,:m_c09,:m_c10,:m_c11,:m_c12,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_c01", NpgsqlDbType.Numeric).Value = m_c01;
                    cmd.Parameters.Add("m_c02", NpgsqlDbType.Numeric).Value = m_c02;
                    cmd.Parameters.Add("m_c03", NpgsqlDbType.Numeric).Value = m_c03;
                    cmd.Parameters.Add("m_c04", NpgsqlDbType.Numeric).Value = m_c04;
                    cmd.Parameters.Add("m_c05", NpgsqlDbType.Numeric).Value = m_c05;
                    cmd.Parameters.Add("m_c06", NpgsqlDbType.Numeric).Value = m_c06;
                    cmd.Parameters.Add("m_c07", NpgsqlDbType.Numeric).Value = m_c07;
                    cmd.Parameters.Add("m_c08", NpgsqlDbType.Numeric).Value = m_c08;
                    cmd.Parameters.Add("m_c09", NpgsqlDbType.Numeric).Value = m_c09;
                    cmd.Parameters.Add("m_c10", NpgsqlDbType.Numeric).Value = m_c10;
                    cmd.Parameters.Add("m_c11", NpgsqlDbType.Numeric).Value = m_c11;
                    cmd.Parameters.Add("m_c12", NpgsqlDbType.Numeric).Value = m_c12;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "khbieu_15");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        #endregion
        // hien them dat kham ngay 01/03/2011
        public bool upd_datkham(string m_mabn, string m_ngay, string m_den)
        {
            sql = "update " + user + ".datkham set den=to_date(:m_den,'dd/mm/yyyy hh24:mi') where mabn=:m_mabn and to_char(ngay,'dd/mm/yyyy hh24:mi')=:m_ngay";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_den", NpgsqlDbType.Text, 16).Value = m_den;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                cmd.ExecuteNonQuery();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "datkham");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_datkham(string m_mabn, string m_ngay, string m_dienthoai, string m_didong,
            string m_kham, string m_ghichu, string m_mabs, int m_userid)
        {
            sql = "update " + user + ".datkham set dienthoai=:m_dienthoai,didong=:m_didong,kham=:m_kham,ghichu=:m_ghichu,mabs=:m_mabs,userid=:m_userid where mabn=:m_mabn and to_char(ngay,'dd/mm/yyyy hh24:mi')=:m_ngay";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_dienthoai", NpgsqlDbType.Varchar, 30).Value = m_dienthoai;
                cmd.Parameters.Add("m_didong", NpgsqlDbType.Varchar, 20).Value = m_didong;
                cmd.Parameters.Add("m_kham", NpgsqlDbType.Text, 254).Value = m_kham;
                cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text, 500).Value = m_ghichu;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".datkham (mabn,ngay,dienthoai,didong,kham,ghichu,mabs,userid) values (:m_mabn,to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),:m_dienthoai,:m_didong,:m_kham,:m_ghichu,:m_mabs,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                    cmd.Parameters.Add("m_dienthoai", NpgsqlDbType.Varchar, 30).Value = m_dienthoai;
                    cmd.Parameters.Add("m_didong", NpgsqlDbType.Varchar, 20).Value = m_didong;
                    cmd.Parameters.Add("m_kham", NpgsqlDbType.Text, 254).Value = m_kham;
                    cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text, 500).Value = m_ghichu;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "datkham");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public string get_mavp_phongkham()
        {
            string s_mavp_pk = "";
            sql = "select distinct mavp from " + user + ".btdkp_bv ";
            DataSet lds = get_data(sql);
            foreach (DataRow r in lds.Tables[0].Rows)
            {
                s_mavp_pk += r["mavp"].ToString() + ",";
            }
            return s_mavp_pk.Trim().Trim(',');
        }

        public bool upd_taosolieu_duoc(int d_nhom, string d_mmyy, int d_userid)
        {
            //luu lai ngay tao so lieu thang moi
            string ngaytaosolieu = ngayhienhanh_server.Substring(0, 10);
            sql = "update " + user + ".d_taosolieu set userid=:d_userid where nhom=:d_nhom and mmyy=:d_mmyy";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("d_userid", NpgsqlDbType.Numeric).Value = d_userid;
                cmd.Parameters.Add("d_nhom", NpgsqlDbType.Numeric).Value = d_nhom;
                cmd.Parameters.Add("d_mmyy", NpgsqlDbType.Varchar, 4).Value = d_mmyy;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".d_taosolieu (nhom,mmyy,userid, ngayud) values (:d_nhom,:d_mmyy,:d_userid,to_date('" + ngaytaosolieu + "','dd/mm/yyyy'))";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("d_nhom", NpgsqlDbType.Numeric).Value = d_nhom;
                    cmd.Parameters.Add("d_mmyy", NpgsqlDbType.Varchar, 4).Value = d_mmyy;
                    cmd.Parameters.Add("d_userid", NpgsqlDbType.Numeric).Value = d_userid;
                    //cmd.Parameters.Add("d_ngayud", NpgsqlDbType.Varchar, 10).Value = ngayhienhanh_server.Substring(0, 10);
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "d_taosolieu");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        public string get_ngaytao_solieu_thangmoi(string d_mmyy, int d_nhom)
        {
            string s_ngay = "";
            sql = "select to_char(ngayud,'dd/mm/yyyy') ngay from " + user + ".d_taosolieu where nhom=" + d_nhom + " and  mmyy='" + d_mmyy + "'";
            DataSet lds = get_data(sql);
            if (lds == null || lds.Tables.Count <= 0 || lds.Tables[0].Rows.Count == 0) s_ngay = "";
            else s_ngay = lds.Tables[0].Rows[0]["ngay"].ToString();
            if (s_ngay == "")
            {
                upd_taosolieu_duoc(d_nhom, d_mmyy, 0);
                s_ngay = ngayhienhanh_server.Substring(0, 10);
            }
            return s_ngay;
        }
        public decimal get_maqltc(string m_mabn, string m_ngay)
        {
            ds = get_data("select maql from " + user + ".benhantc where mabn='" + m_mabn + "'" + " and to_char(ngay,'dd/mm/yyyy hh24:mi')='" + m_ngay + "'");
            decimal l_maql = (ds.Tables[0].Rows.Count == 0) ? 0 : decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            if (l_maql == 0) l_maql = getidyymmddhhmiss_stt_computer;// get_capid(1);
            return l_maql;
        }
        public decimal get_mavaovientc(decimal l_maql)
        {
            ds = get_data("select mavaovien from " + user + ".benhantc where maql='" + l_maql + "'");
            decimal l_mavv = (ds.Tables[0].Rows.Count == 0) ? 0 : decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            if (l_mavv == 0) l_mavv = getidyymmddhhmiss_stt_computer;// get_capid(1);
            return l_mavv;
        }
        //Tu:28/06/2011 số lưu trữ pk,pl,ngtru tăng tự động(D28)
        public bool bSoluutruPK_PL_NGT_tudong
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1090");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }//end Tu

        #region sua benh an dien tu:28/03/2011 Tu
        public bool bPhongluu_userid
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=368");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bHen_dangkylai
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=471");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bChuctramngan
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=358");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }
        public string xutri_hen
        {
            get
            {
                try
                {
                    ds = get_data("select ten from " + user + ".thongso where id=461");
                    if (ds.Tables[0].Rows.Count == 0) return "";
                    return ds.Tables[0].Rows[0][0].ToString().Trim();
                }
                catch { return ""; }
            }
        }
        public bool bHienthi_tivi
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=283");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bStt_tudong
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=282");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bYta_khambenh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=262");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bBacsi_hanhchinh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=263");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        //Khuong 11/11/2011
        public bool bTienGiuongBHYT_TuDong
        {//J10
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1102");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        //khuong 13/12/2011
        public bool bTienGiuongBHYT_KhongTinhNgayCho
        {//J10.1
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1103");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bNgay1kham
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=252");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bKhambenh_bangdien
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=257");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bGhichu_toamuangoai
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=226");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public string Makp_khamnoi
        {
            get
            {
                try
                {
                    ds = get_data("select ten from " + user + ".thongso where id=217");
                    if (ds.Tables[0].Rows.Count == 0) return "";
                    return ds.Tables[0].Rows[0][0].ToString().Trim();
                }
                catch { return ""; }
            }
        }
        public bool bTamung_khambenh
        {
            get
            {
                try
                {
                    return int.Parse(Thongso("c297").ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public decimal get_chiphikb(string m_ngay, decimal m_mavaovien)
        {
            ds = get_data("select tamung-sotien+thuathieu as conlai from " + user + mmyy(m_ngay) + ".chiphikb where mavaovien=" + m_mavaovien);
            if (ds.Tables[0].Rows.Count > 0) return decimal.Parse(ds.Tables[0].Rows[0]["conlai"].ToString());
            else return 0;
        }
        public bool bAdmin_hethong(int userid)
        {
            try
            {
                ds = get_data("select manhom from " + user + ".dlogin where manhom in(0) and id=" + userid);
                return ds.Tables[0].Rows.Count != 0;
            }
            catch { return false; }
        }
        public string f_get_khudt(int userid)
        {
            try
            {
                ds = get_data("select khu from " + user + ".dlogin where id=" + userid);
                return ds.Tables[0].Rows[0]["khu"].ToString();
            }
            catch { return ""; }
        }
        public decimal get_maql_mmyy(string m_mabn, string m_makp, string m_ngay)
        {
            if (!bMmyy(mmyy(m_ngay))) return 0;
            sql = "select maql from " + user + mmyy(m_ngay) + ".tiepdon where mabn='" + m_mabn + "'" + " and to_char(ngay,'dd/mm/yyyy hh24:mi')='" + m_ngay + "'";
            if (m_makp != "??") sql += " and makp='" + m_makp + "'";
            ds = get_data(sql);
            decimal l_maql = (ds.Tables[0].Rows.Count == 0) ? 0 : decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            if (l_maql == 0 && m_makp != "??") l_maql = getidyymmddhhmiss_stt_computer;//get_capid(1);
            return l_maql;
        }
        public bool bSoluutru_makpmmsttyy//???
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=314");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bSovaovien_tudong_ngoaitru_chungnoitru//???
        {
            //Tab MS tu dong
            //1: So ngoai tru tang tu dong, tang lien tuc chung voi noi tru
            //0: khong tang tu dong
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1009");//I13 
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bSovaovien_tudong_ngoaitru_rieng//???
        {
            //Tab MS tu dong
            //1: So ngoai tru tang tu dong, tang theo day so rieng: dua table capid where ma=-5
            //0: khong tang tu dong
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1010");//I13 
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bSovaovien_khoa//???
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=264");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        // LCD
        public string Mau(string sql)
        {
            try
            {
                XmlDocument doc = new XmlDocument();
                doc.Load("..\\..\\..\\xml\\mau.xml");
                XmlNodeList nodeLst = doc.GetElementsByTagName(sql);
                return nodeLst.Item(0).InnerText;
            }
            catch
            {
                return "";
            }
        }
        public int LocationX
        {
            get
            {
                return int.Parse(Mau("x"));
            }
        }
        public int LocationY
        {
            get
            {
                return int.Parse(Mau("y"));
            }
        }
        public int width
        {
            get
            {
                return int.Parse(Mau("w"));
            }
        }
        public int height
        {
            get
            {
                return int.Parse(Mau("h"));
            }
        }
        public int size
        {
            get
            {
                return int.Parse(Mau("s"));
            }
        }
        public int delay
        {
            //get
            //{
            //    DataSet ds = get_data("select ten from thongso where id=284");
            //    return (ds.Tables[0].Rows[0][0].ToString().Trim() == "") ? 20 : int.Parse(ds.Tables[0].Rows[0][0].ToString().Trim());
            //}
            get
            {
                return int.Parse(Mau("delay"));
            }
        }
        //end LCD

        //tao user
        public void tao_user_mmyy(string mmyy, int d_userid)
        {
            //try
            //{
            //    sql = "CREATE USER " + userid + mmyy + " IDENTIFIED BY " + userid + mmyy + " DEFAULT TABLESPACE MEDISOFT QUOTA 100M ON MEDISOFT;\n";
            //    sql += "GRANT CREATE SESSION, IMP_FULL_DATABASE TO " + userid + mmyy + ";\n";
            //    sql += "GRANT JAVASYSPRIV, JAVAUSERPRIV TO " + userid + mmyy + ";\n";
            //    sql += "GRANT ALL PRIVILEGES TO " + userid + mmyy + ";\n";
            //    sql += "exit;";
            //    string tenfile = "..\\..\\..\\xml\\tao.sql";
            //    if (File.Exists(tenfile)) File.Delete(tenfile);
            //    FileStream file = new FileStream(tenfile, FileMode.CreateNew, FileAccess.Write);
            //    StreamWriter sw = new StreamWriter(file);
            //    sw.Write(sql);
            //    sw.Close();
            //    string filerun = @"sqlplus.exe";
            //    string arg = "system/links1920@" + service_name + " @" + tenfile;
            //    run f = new run(filerun, arg, true);
            //    f.Launch();
            //    if (File.Exists(tenfile)) File.Delete(tenfile);
            //    tao_table(mmyy);
            //    tao_sp(mmyy);
            //    if (bIndex) tao_index_mmyy(mmyy);
            //    if (bUser(userid + mmyy)) upd_m_table(mmyy, d_userid);

            //    //System.Windows.Forms.MessageBox.Show("Đang tạo số liệu tháng "+mmyy.Substring(0,2)+" năm 20"+mmyy.Substring(2),"Medisoft",System.Windows.Forms.MessageBoxButtons.OK,System.Windows.Forms.MessageBoxIcon.Exclamation);
            //}
            //catch (Exception ex)
            //{
            //    System.Windows.Forms.MessageBox.Show(ex.Message);
            //}
        }
        //
        public string bNhapvien(string m_mabn)
        {
            try
            {
                return get_data("select trim(b.tenkp)||' '||to_char(a.ngay,'dd/mm/yyyy hh24:mi') from " + user + ".benhandt a," + user + ".btdkp_bv b where a.makp=b.makp and a.maql not in (select maql from " + user + ".xuatvien) and a.mabn='" + m_mabn + "'").Tables[0].Rows[0][0].ToString();
            }
            catch { return ""; }
        }
        public string bNhapvien(string m_mabn, decimal m_maql, int loaiba)
        {
            try
            {
                return get_data("select trim(b.tenkp)||' '||to_char(a.ngay,'dd/mm/yyyy hh24:mi') from " + user + ".benhandt a," + user + ".btdkp_bv b where a.makp=b.makp and a.maql not in (select maql from " + user + ".xuatvien) and a.mabn='" + m_mabn + "'" + " and a.loaiba=" + loaiba + " and maql<>" + m_maql).Tables[0].Rows[0][0].ToString();
            }
            catch { return ""; }
        }
        public decimal get_maql(string mabn, string ngay, int loaiba)
        {
            //sql = "select maql from " + user + ".benhandt where mabn='" + mabn + "' and to_char(ngay,'dd/mm/yyyy hh24:mi')='" + ngay + "' and loaiba=" + loaiba;
            if (loaiba == 1)
                sql = "select maql from " + user + ".benhandt where mabn='" + mabn + "' and to_char(ngay,'dd/mm/yyyy hh24:mi')='" + ngay + "' ";
            else if (loaiba == 2)
                sql = "select maql from " + user + ".benhanngtr where mabn='" + mabn + "' and to_char(ngay,'dd/mm/yyyy hh24:mi')='" + ngay + "' ";
            else if (loaiba == 3)
                sql = "select maql from " + user + mmyy(ngay) + ".benhanpk where mabn='" + mabn + "' and to_char(ngay,'dd/mm/yyyy hh24:mi')='" + ngay + "' ";
            else if (loaiba == 4)
                sql = "select maql from " + user + mmyy(ngay) + ".benhancc where mabn='" + mabn + "' and to_char(ngay,'dd/mm/yyyy hh24:mi')='" + ngay + "' ";
            ds = get_data(sql);
            if (ds.Tables[0].Rows.Count > 0) return decimal.Parse(ds.Tables[0].Rows[0]["maql"].ToString());
            else return 0;
        }
        public decimal get_maql_ngay_gio(int m_loaiba, string m_mabn, string m_makp, string m_ngay)
        {
            if (!bMmyy(mmyy(m_ngay))) return 0;
            sql = "select maql from " + user + mmyy(m_ngay) + ".benhanpk where mabn='" + m_mabn + "' and to_char(ngay,'dd/mm/yyyy hh24:mi')<>'" + m_ngay + "'";
            sql += " and to_char(ngay,'dd/mm/yyyy')='" + m_ngay.Substring(0, 10) + "'";
            if (m_makp != "??") sql += " and makp='" + m_makp + "'";
            ds = get_data(sql);
            decimal l_maql = (ds.Tables[0].Rows.Count == 0) ? 0 : decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            return l_maql;
        }
        public bool upd_benhandt_mmyy(string m_mabn, decimal m_maql, string m_makp, string m_ngay,
            int m_dentu, int m_nhantu, int m_lanthu, int m_madoituong, string m_chandoan,
            string m_maicd, string m_mabs, string m_sovaovien, int m_loaiba, int m_userid, bool m_update, decimal m_mangtr, decimal m_mavaovien)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".benhanpk set ";
            if (m_update) sql += "makp=:m_makp,";
            sql += "ngay=to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),dentu=:m_dentu,nhantu=:m_nhantu,";
            sql += "madoituong=:m_madoituong,chandoan=:m_chandoan,maicd=:m_maicd,mabs=:m_mabs,";//lanthu=:m_lanthu,
            if (m_sovaovien != "") sql += "sovaovien=:m_sovaovien,";
            sql += "userid=:m_userid,mangtr=:m_mangtr,mavaovien=:m_mavaovien where maql=:m_maql";//loaiba=:m_loaiba,
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                if (m_update) cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar).Value = m_makp;
                //cmd.Parameters.Add("m_ngay", NpgsqlDbType.Date).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar).Value = m_ngay;
                cmd.Parameters.Add("m_dentu", NpgsqlDbType.Numeric).Value = m_dentu;
                cmd.Parameters.Add("m_nhantu", NpgsqlDbType.Numeric).Value = m_nhantu;
                //cmd.Parameters.Add("m_lanthu", NpgsqlDbType.Numeric).Value = m_lanthu;
                cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                if (m_sovaovien != "") cmd.Parameters.Add("m_sovaovien", NpgsqlDbType.Varchar, 10).Value = m_sovaovien;
                //cmd.Parameters.Add("m_loaiba", NpgsqlDbType.Numeric).Value = m_loaiba;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_mangtr", NpgsqlDbType.Numeric).Value = m_mangtr;
                cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    if (m_sovaovien == "")
                    {
                        //,lanthu,:m_lanthu,loaiba,:m_loaiba
                        sql = "insert into " + xxx + ".benhanpk(mabn,maql,makp,ngay,dentu,nhantu,madoituong,chandoan,maicd,mabs,userid,ngayud,mangtr,mavaovien)";
                        sql += " values (:m_mabn,:m_maql,:m_makp,to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),:m_dentu,:m_nhantu,:m_madoituong,:m_chandoan,:m_maicd,:m_mabs,:m_userid,sysdate,:m_mangtr,:m_mavaovien)";
                    }
                    else
                    {
                        //,lanthu,:m_lanthu,loaiba,:m_loaiba
                        sql = "insert into " + xxx + ".benhanpk(mabn,maql,makp,ngay,dentu,nhantu,madoituong,chandoan,maicd,mabs,sovaovien,userid,ngayud,mangtr,mavaovien)";
                        sql += " values (:m_mabn,:m_maql,:m_makp,to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),:m_dentu,:m_nhantu,:m_madoituong,:m_chandoan,:m_maicd,:m_mabs,:m_sovaovien,:m_userid,sysdate,:m_mangtr,:m_mavaovien)";
                    }
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar).Value = m_makp;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar).Value = m_ngay;
                    cmd.Parameters.Add("m_dentu", NpgsqlDbType.Numeric).Value = m_dentu;
                    cmd.Parameters.Add("m_nhantu", NpgsqlDbType.Numeric).Value = m_nhantu;
                    cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                    cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                    cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    if (m_sovaovien != "") cmd.Parameters.Add("m_sovaovien", NpgsqlDbType.Varchar, 10).Value = m_sovaovien;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    cmd.Parameters.Add("m_mangtr", NpgsqlDbType.Numeric).Value = m_mangtr;
                    cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "benhanpk");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }

            return true;
        }
        public bool upd_bavv_chung(string m_ngay, string m_mabn, decimal m_maql, string m_lydo, string m_hb_benhly, string m_hb_banthan, string m_hb_giadinh,
            string m_kb_toanthan, string m_kb_bophan, string m_kb_tomtat, string m_kb_xuli, string m_kb_chuy,
            string m_sobo, string m_phanbiet, int m_userid)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".bavv_chung set mabn=:m_mabn,lydo=:m_lydo,hb_benhly=:m_hb_benhly,hb_banthan=:m_hb_banthan,hb_giadinh=:m_hb_giadinh,";
            sql += "kb_toanthan=:m_kb_toanthan,kb_bophan=:m_kb_bophan,";
            sql += "kb_tomtat=:m_kb_tomtat,kb_xuli=:m_kb_xuli,kb_chuy=:m_kb_chuy,";
            sql += "sobo=:m_sobo,phanbiet=:m_phanbiet,";
            sql += "userid=:m_userid where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_lydo", NpgsqlDbType.Text).Value = m_lydo;
                cmd.Parameters.Add("m_hb_benhly", NpgsqlDbType.Text).Value = m_hb_benhly;
                cmd.Parameters.Add("m_hb_banthan", NpgsqlDbType.Text).Value = m_hb_banthan;
                cmd.Parameters.Add("m_hb_giadinh", NpgsqlDbType.Text).Value = m_hb_giadinh;
                cmd.Parameters.Add("m_kb_toanthan", NpgsqlDbType.Text).Value = m_kb_toanthan;
                cmd.Parameters.Add("m_kb_bophan", NpgsqlDbType.Text).Value = m_kb_bophan;
                cmd.Parameters.Add("m_kb_tomtat", NpgsqlDbType.Text).Value = m_kb_tomtat;
                cmd.Parameters.Add("m_kb_xuli", NpgsqlDbType.Text).Value = m_kb_xuli;
                cmd.Parameters.Add("m_kb_chuy", NpgsqlDbType.Text).Value = m_kb_chuy;
                cmd.Parameters.Add("m_sobo", NpgsqlDbType.Text).Value = m_sobo;
                cmd.Parameters.Add("m_phanbiet", NpgsqlDbType.Text).Value = m_phanbiet;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".bavv_chung (mabn,maql,lydo,hb_benhly,hb_banthan,hb_giadinh,kb_toanthan,kb_bophan,kb_tomtat,kb_xuli,kb_chuy,sobo,phanbiet,userid) values (:m_mabn,:m_maql,:m_lydo,:m_hb_benhly,:m_hb_banthan,:m_hb_giadinh,:m_kb_toanthan,:m_kb_bophan,:m_kb_tomtat,:m_kb_xuli,:m_kb_chuy,:m_sobo,:m_phanbiet,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_lydo", NpgsqlDbType.Text).Value = m_lydo;
                    cmd.Parameters.Add("m_hb_benhly", NpgsqlDbType.Text).Value = m_hb_benhly;
                    cmd.Parameters.Add("m_hb_banthan", NpgsqlDbType.Text).Value = m_hb_banthan;
                    cmd.Parameters.Add("m_hb_giadinh", NpgsqlDbType.Text).Value = m_hb_giadinh;
                    cmd.Parameters.Add("m_kb_toanthan", NpgsqlDbType.Text).Value = m_kb_toanthan;
                    cmd.Parameters.Add("m_kb_bophan", NpgsqlDbType.Text).Value = m_kb_bophan;
                    cmd.Parameters.Add("m_kb_tomtat", NpgsqlDbType.Text).Value = m_kb_tomtat;
                    cmd.Parameters.Add("m_kb_xuli", NpgsqlDbType.Text).Value = m_kb_xuli;
                    cmd.Parameters.Add("m_kb_chuy", NpgsqlDbType.Text).Value = m_kb_chuy;
                    cmd.Parameters.Add("m_sobo", NpgsqlDbType.Text).Value = m_sobo;
                    cmd.Parameters.Add("m_phanbiet", NpgsqlDbType.Text).Value = m_phanbiet;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "bavv_chung");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_bavv_dausinhton(string m_ngay, string m_mabn, decimal m_maql, decimal m_mach, decimal m_nhietdo, string m_huyetap, decimal m_nhiptho, decimal m_cannang)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".bavv_dausinhton set mabn=:m_mabn,mach=:m_mach,nhietdo=:m_nhietdo,huyetap=:m_huyetap,nhiptho=:m_nhiptho,cannang=:m_cannang where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_mach", NpgsqlDbType.Numeric).Value = m_mach;
                cmd.Parameters.Add("m_nhietdo", NpgsqlDbType.Numeric).Value = m_nhietdo;
                cmd.Parameters.Add("m_huyetap", NpgsqlDbType.Varchar, 7).Value = m_huyetap;
                cmd.Parameters.Add("m_nhiptho", NpgsqlDbType.Numeric).Value = m_nhiptho;
                cmd.Parameters.Add("m_cannang", NpgsqlDbType.Numeric).Value = m_cannang;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".bavv_dausinhton (maql,mach,nhietdo,huyetap,nhiptho,cannang) values (:m_maql,:m_mach,:m_nhietdo,:m_huyetap,:m_nhiptho,:m_cannang)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_mach", NpgsqlDbType.Numeric).Value = m_mach;
                    cmd.Parameters.Add("m_nhietdo", NpgsqlDbType.Numeric).Value = m_nhietdo;
                    cmd.Parameters.Add("m_huyetap", NpgsqlDbType.Varchar, 7).Value = m_huyetap;
                    cmd.Parameters.Add("m_nhiptho", NpgsqlDbType.Numeric).Value = m_nhiptho;
                    cmd.Parameters.Add("m_cannang", NpgsqlDbType.Numeric).Value = m_cannang;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "bavv_dausinhton");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_bhyt(string v_mmyy, decimal v_id, string v_sothe, int v_maphu, string v_mabv, string v_noigioithieu, int v_traituyen)
        {
            string xxx = user + v_mmyy + ".pkg_vienphi.upd_bhyt";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(xxx, con);
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                cmd.Parameters.Add("v_sothe", NpgsqlDbType.Varchar, 20).Value = v_sothe;
                cmd.Parameters.Add("v_maphu", NpgsqlDbType.Numeric).Value = v_maphu;
                cmd.Parameters.Add("v_mabv", NpgsqlDbType.Varchar, 10).Value = v_mabv;
                cmd.Parameters.Add("v_noigioithieu", NpgsqlDbType.Varchar, 8).Value = v_noigioithieu;
                cmd.Parameters.Add("v_traituyen", NpgsqlDbType.Numeric).Value = v_traituyen;
                cmd.ExecuteNonQuery();
            }
            catch (Exception ex)
            {
                upd_error(ex.Message, sComputer, "v_bhyt");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_bhyt(string m_ngay, string m_mabn, decimal m_maql, string m_sothe, string m_denngay, string m_mabv,
            int m_maphu, string m_tungay, int traituyen)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".bhyt set sothe=:m_sothe";
            if (m_denngay != "") sql += ",denngay=:m_denngay";
            sql += ",mabv=:m_mabv,maphu=:m_maphu";
            if (m_tungay != "") sql += ",tungay=:m_tungay";
            sql += ",traituyen=" + traituyen;
            sql += " where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_sothe", NpgsqlDbType.Varchar, 20).Value = m_sothe;
                if (m_denngay != "") cmd.Parameters.Add("m_denngay", NpgsqlDbType.Date).Value = StringToDateTime(m_denngay);
                cmd.Parameters.Add("m_mabv", NpgsqlDbType.Varchar, 10).Value = m_mabv;
                cmd.Parameters.Add("m_maphu", NpgsqlDbType.Numeric).Value = m_maphu;
                if (m_tungay != "") cmd.Parameters.Add("m_tungay", NpgsqlDbType.Date).Value = StringToDateTime(m_tungay);
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".bhyt(mabn,maql,sothe";
                    if (m_denngay != "") sql += ",denngay";
                    sql += ",mabv,maphu";
                    if (m_tungay != "") sql += ",tungay";
                    sql += ",traituyen) values (:m_mabn,:m_maql,:m_sothe";
                    if (m_denngay != "") sql += ",:m_denngay";
                    sql += ",:m_mabv,:m_maphu";
                    if (m_tungay != "") sql += ",:m_tungay";
                    sql += "," + traituyen + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_sothe", NpgsqlDbType.Varchar, 20).Value = m_sothe;
                    if (m_denngay != "") cmd.Parameters.Add("m_denngay", NpgsqlDbType.Date).Value = StringToDateTime(m_denngay);
                    cmd.Parameters.Add("m_mabv", NpgsqlDbType.Varchar, 10).Value = m_mabv;
                    cmd.Parameters.Add("m_maphu", NpgsqlDbType.Numeric).Value = m_maphu;
                    if (m_tungay != "") cmd.Parameters.Add("m_tungay", NpgsqlDbType.Date).Value = StringToDateTime(m_tungay);
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "Bhyt " + m_mabn);
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_bhyt(string m_mabn, decimal m_maql, string m_sothe, string m_denngay, string m_mabv, int m_maphu,
            string m_tungay, int traituyen)
        {
            sql = "update " + user + ".bhyt set sothe=:m_sothe";
            if (m_denngay != "") sql += ",denngay=:m_denngay";
            sql += ",mabv=:m_mabv,maphu=:m_maphu";
            if (m_tungay != "") sql += ",tungay=:m_tungay";
            sql += ",traituyen=" + traituyen;
            sql += " where maql=:m_maql";
            sql += " and sothe=:m_sothe";//binh
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_sothe", NpgsqlDbType.Varchar, 20).Value = m_sothe;
                if (m_denngay != "") cmd.Parameters.Add("m_denngay", NpgsqlDbType.Date).Value = StringToDateTime(m_denngay);
                cmd.Parameters.Add("m_mabv", NpgsqlDbType.Varchar, 10).Value = m_mabv;
                cmd.Parameters.Add("m_maphu", NpgsqlDbType.Numeric).Value = m_maphu;
                if (m_tungay != "") cmd.Parameters.Add("m_tungay", NpgsqlDbType.Date).Value = StringToDateTime(m_tungay);
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".bhyt(mabn,maql,sothe";
                    if (m_denngay != "") sql += ",denngay";
                    sql += ",mabv,maphu";
                    if (m_tungay != "") sql += ",tungay";
                    sql += ",traituyen) values (:m_mabn,:m_maql,:m_sothe";
                    if (m_denngay != "") sql += ",:m_denngay";
                    sql += ",:m_mabv,:m_maphu";
                    if (m_tungay != "") sql += ",:m_tungay";
                    sql += "," + traituyen + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_sothe", NpgsqlDbType.Varchar, 20).Value = m_sothe;
                    if (m_denngay != "") cmd.Parameters.Add("m_denngay", NpgsqlDbType.Date).Value = StringToDateTime(m_denngay);
                    cmd.Parameters.Add("m_mabv", NpgsqlDbType.Varchar, 10).Value = m_mabv;
                    cmd.Parameters.Add("m_maphu", NpgsqlDbType.Numeric).Value = m_maphu;
                    if (m_tungay != "") cmd.Parameters.Add("m_tungay", NpgsqlDbType.Date).Value = StringToDateTime(m_tungay);
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "Bhyt " + m_mabn);
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        //Thuy 21.12.2011
        public bool upd_benhandt_noitru(string m_mabn, decimal m_mavaovien, decimal m_maql, string m_makp, string m_ngay,
            int m_dentu, int m_nhantu, int m_lanthu, int m_madoituong, string m_chandoan,
            string m_maicd, string m_mabs, string m_sovaovien, int m_loaiba, int m_userid, string m_para, bool m_update)
        {
            bool Sovaovien = bSovaovien;
            sql = "update " + user + ".benhandt set ";
            if (m_update) sql += "makp=:m_makp,";
            sql += "ngay=:m_ngay,dentu=:m_dentu,nhantu=:m_nhantu,";
            sql += "lanthu=:m_lanthu,madoituong=:m_madoituong,chandoan=:m_chandoan,maicd=:m_maicd,mabs=:m_mabs,";
            if (!Sovaovien) sql += "sovaovien=:m_sovaovien,";
            sql += "para=:m_para,";//Thuy 21.12.2011
            sql += "loaiba=:m_loaiba where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                if (m_update) cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_dentu", NpgsqlDbType.Numeric).Value = m_dentu;
                cmd.Parameters.Add("m_nhantu", NpgsqlDbType.Numeric).Value = m_nhantu;
                cmd.Parameters.Add("m_lanthu", NpgsqlDbType.Numeric).Value = m_lanthu;
                cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                if (!Sovaovien) cmd.Parameters.Add("m_sovaovien", NpgsqlDbType.Varchar, 10).Value = m_sovaovien;
                cmd.Parameters.Add("m_para", NpgsqlDbType.Varchar).Value = m_para;//Thuy 21.12.2011
                cmd.Parameters.Add("m_loaiba", NpgsqlDbType.Numeric).Value = m_loaiba;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".benhandt(mabn,mavaovien,maql,makp,ngay,dentu,nhantu,lanthu," +
                        "madoituong,chandoan,maicd,mabs,sovaovien,loaiba,userid,para,ngayud)";
                    sql += " values (:m_mabn,:m_mavaovien,:m_maql,:m_makp,:m_ngay,:m_dentu,:m_nhantu,:m_lanthu," +
                        ":m_madoituong,:m_chandoan,:m_maicd,:m_mabs,:m_sovaovien,:m_loaiba,:m_userid,:m_para,now())";//Thuy 21.12.2011
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_dentu", NpgsqlDbType.Numeric).Value = m_dentu;
                    cmd.Parameters.Add("m_nhantu", NpgsqlDbType.Numeric).Value = m_nhantu;
                    cmd.Parameters.Add("m_lanthu", NpgsqlDbType.Numeric).Value = m_lanthu;
                    cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                    cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                    cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    cmd.Parameters.Add("m_sovaovien", NpgsqlDbType.Varchar, 10).Value = m_sovaovien;
                    cmd.Parameters.Add("m_loaiba", NpgsqlDbType.Numeric).Value = m_loaiba;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    cmd.Parameters.Add("m_para", NpgsqlDbType.Varchar).Value = m_para;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                    con.Close(); con.Dispose();
                    if (m_sovaovien == "" && Sovaovien)
                    {
                        if (bSovaovien_noitru)
                        {
                            if (m_loaiba == 1) upd_sovaovien(m_maql, get_capid(5, m_ngay.Substring(8, 2)).ToString().PadLeft(7, '0') + "/" + m_ngay.Substring(8, 2));
                        }
                        else if (m_loaiba != 3) upd_sovaovien(m_maql, get_capid(5, m_ngay.Substring(8, 2)).ToString().PadLeft(7, '0') + "/" + m_ngay.Substring(8, 2));
                    }
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "Benhandt");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        //end Thuy
        public bool upd_benhandt(string m_mabn, decimal m_maql, string m_makp, string m_ngay,
            int m_dentu, int m_nhantu, int m_lanthu, int m_madoituong, string m_chandoan,
            string m_maicd, string m_mabs, string m_sovaovien, int m_loaiba, int m_userid, bool m_update, decimal m_mangtr)
        {
            sql = "update " + user + ".benhandt set ";
            if (m_update) sql += "makp=:m_makp,";//userid=:m_userid,";
            sql += "ngay=to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),dentu=:m_dentu,nhantu=:m_nhantu,";
            sql += "madoituong=:m_madoituong,chandoan=:m_chandoan,maicd=:m_maicd,mabs=:m_mabs,";
            if (m_sovaovien != "") sql += "sovaovien=:m_sovaovien,";
            sql += "loaiba=:m_loaiba where maql=:m_maql";//,mangtr=:m_mangtr,lanthu=:m_lanthu,
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                if (m_update)
                {
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar).Value = m_makp;
                    //cmd.Parameters.Add("m_userid",NpgsqlDbType.Number).Value=m_userid;
                }
                //cmd.Parameters.Add("m_ngay", NpgsqlDbType.Date).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar).Value = m_ngay;
                cmd.Parameters.Add("m_dentu", NpgsqlDbType.Numeric).Value = m_dentu;
                cmd.Parameters.Add("m_nhantu", NpgsqlDbType.Numeric).Value = m_nhantu;
                //cmd.Parameters.Add("m_lanthu", NpgsqlDbType.Numeric).Value = m_lanthu;
                cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                if (m_sovaovien != "") cmd.Parameters.Add("m_sovaovien", NpgsqlDbType.Varchar, 10).Value = m_sovaovien;
                cmd.Parameters.Add("m_loaiba", NpgsqlDbType.Numeric).Value = m_loaiba;
                //cmd.Parameters.Add("m_mangtr", NpgsqlDbType.Numeric).Value = m_mangtr;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    if (m_sovaovien == "")
                    {
                        //,lanthu,:m_lanthu,mangtr,:m_mangtr
                        sql = "insert into " + user + ".benhandt(mabn,maql,makp,ngay,dentu,nhantu,madoituong,chandoan,maicd,mabs,loaiba,userid,ngayud)";
                        sql += " values (:m_mabn,:m_maql,:m_makp,to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),:m_dentu,:m_nhantu,:m_madoituong,:m_chandoan,:m_maicd,:m_mabs,:m_loaiba,:m_userid,sysdate)";
                    }
                    else
                    {
                        //,lanthu,:m_lanthu,mangtr,:m_mangtr
                        sql = "insert into " + user + ".benhandt(mabn,maql,makp,ngay,dentu,nhantu,madoituong,chandoan,maicd,mabs,sovaovien,loaiba,userid,ngayud)";
                        sql += " values (:m_mabn,:m_maql,:m_makp,to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),:m_dentu,:m_nhantu,:m_madoituong,:m_chandoan,:m_maicd,:m_mabs,:m_sovaovien,:m_loaiba,:m_userid,sysdate)";
                    }
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar).Value = m_makp;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar).Value = m_ngay;
                    cmd.Parameters.Add("m_dentu", NpgsqlDbType.Numeric).Value = m_dentu;
                    cmd.Parameters.Add("m_nhantu", NpgsqlDbType.Numeric).Value = m_nhantu;
                    cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                    cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                    cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    if (m_sovaovien != "") cmd.Parameters.Add("m_sovaovien", NpgsqlDbType.Varchar, 10).Value = m_sovaovien;
                    cmd.Parameters.Add("m_loaiba", NpgsqlDbType.Numeric).Value = m_loaiba;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                    con.Close(); con.Dispose();
                    if (m_sovaovien == "")
                    {
                        if (bSoluutru_makpmmsttyy) upd_sovaovien(m_maql, get_sovaovien_makpmmsttyy(m_maql, m_makp, m_ngay));
                        else if (m_loaiba == 2 && bSovaovien_tudong_ngoaitru_chungnoitru) upd_sovaovien(m_maql, get_capid(5, m_ngay.Substring(8, 2)).ToString().PadLeft(7, '0') + "/" + m_ngay.Substring(8, 2));
                        else if (m_loaiba == 2 && bSovaovien_tudong_ngoaitru_rieng) upd_sovaovien(m_maql, get_capid(-5, m_ngay.Substring(8, 2)).ToString().PadLeft(7, '0') + "/" + m_ngay.Substring(8, 2));
                        else if (bSovaovien_noitru)
                        {
                            if (m_loaiba == 1)
                            {
                                if (bSovaovien_khoa) upd_sovaovien(m_maql, get_capid(900 + int.Parse(m_makp), m_ngay.Substring(8, 2)).ToString().PadLeft(7, '0') + "/" + m_ngay.Substring(8, 2));
                                else upd_sovaovien(m_maql, get_capid(5, m_ngay.Substring(8, 2)).ToString().PadLeft(7, '0') + "/" + m_ngay.Substring(8, 2));
                            }
                        }

                        else if (m_loaiba != 3) upd_sovaovien(m_maql, get_capid(5, m_ngay.Substring(8, 2)).ToString().PadLeft(7, '0') + "/" + m_ngay.Substring(8, 2));
                    }
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "benhandt");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        //Thuy 21.12.2011
        public bool upd_nhapkhoa_noitru(decimal m_id, string m_mabn, decimal m_mavaovien, decimal m_maql, string m_makp, int m_maba, string m_ngayvv, string m_ngay, string m_tuoivao, string m_giuong, string m_khoachuyen, string m_chandoan, string m_maicd, string m_mabs, int m_lan, int m_userid, string m_para)
        {
            sql = "update " + user + ".nhapkhoa set makp=:m_makp,maba=:m_maba,ngay=:m_ngay,";
            sql += "tuoivao=:m_tuoivao,giuong=:m_giuong,khoachuyen=:m_khoachuyen,";
            sql += "chandoan=:m_chandoan,maicd=:m_maicd,mabs=:m_mabs,lan=:m_lan,para=:m_para";
            sql += " where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                cmd.Parameters.Add("m_maba", NpgsqlDbType.Numeric).Value = m_maba;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_tuoivao", NpgsqlDbType.Varchar, 4).Value = m_tuoivao;
                cmd.Parameters.Add("m_giuong", NpgsqlDbType.Varchar, 20).Value = m_giuong;
                cmd.Parameters.Add("m_khoachuyen", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_khoachuyen;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_lan", NpgsqlDbType.Numeric).Value = m_lan;
                cmd.Parameters.Add("m_para", NpgsqlDbType.Varchar).Value = m_para;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".nhapkhoa(id,mabn,maql,makp,maba,ngay,tuoivao,giuong,khoachuyen,chandoan,maicd,mabs,lan,userid,para,ngayud)";
                    sql += " values (:m_id,:m_mabn,:m_maql,:m_makp,:m_maba,:m_ngay,:m_tuoivao,:m_giuong,:m_khoachuyen,:m_chandoan,:m_maicd,:m_mabs,:m_lan,:m_userid,:m_para,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_maba", NpgsqlDbType.Numeric).Value = m_maba;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_tuoivao", NpgsqlDbType.Varchar, 4).Value = m_tuoivao;
                    cmd.Parameters.Add("m_giuong", NpgsqlDbType.Varchar, 20).Value = m_giuong;
                    cmd.Parameters.Add("m_khoachuyen", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_khoachuyen;
                    cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                    cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    cmd.Parameters.Add("m_lan", NpgsqlDbType.Numeric).Value = m_lan;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    cmd.Parameters.Add("m_para", NpgsqlDbType.Varchar).Value = m_para;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                    con.Close(); con.Dispose();
                    execute_data("delete from " + user + ".hiendien where nhapkhoa=0 and xuatkhoa=0 and mabn='" + m_mabn + "' and maql=" + m_maql + " and makp='" + m_makp + "'");
                    upd_hiendien(m_id, m_mabn, m_mavaovien, m_maql, m_makp, m_ngayvv, m_ngay, m_giuong, m_mabs, m_maicd, m_khoachuyen);
                    upd_hiendien(m_id, 0);
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "Nhapkhoa");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close(); con.Dispose();
                //upd_hiendien(m_id,m_mabn,m_mavaovien,m_maql,m_makp,m_ngayvv,m_ngay,m_giuong,m_mabs,m_maicd,m_khoachuyen);
                //upd_hiendien(m_id,0);
            }
            return true;
        }
        //end Thuy
        public string get_sovaovien_makpmmsttyy(decimal maql, string makp, string ngay)
        {
            sql = "select max(substr(sovaovien,5,4)) as so from " + user + ".benhandt where makp='" + makp + "' and to_char(ngay,'yymm')='" + ngay.Substring(8, 2) + ngay.Substring(3, 2) + "' and maql<>" + maql + " and length(trim(sovaovien))=10 and loaiba=1";
            ds = get_data(sql);
            if (ds.Tables[0].Rows[0]["so"].ToString() == "") return makp + ngay.Substring(3, 2) + "0001" + ngay.Substring(8, 2);
            else
            {
                int stt = int.Parse(ds.Tables[0].Rows[0]["so"].ToString()) + 1;
                return makp + ngay.Substring(3, 2) + stt.ToString().PadLeft(4, '0') + ngay.Substring(8, 2);
            }
        }
        public bool upd_tiepdon_mmyy(string m_mabn, decimal m_maql, string m_makp, string m_ngay,
            int m_madoituong, string m_sovaovien, string m_tuoivao, int m_bnmoi, int m_userid, int m_noitiepdon, int m_loai, decimal m_mavaovien)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".tiepdon set makp=:m_makp,ngay=to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),madoituong=:m_madoituong,";
            if (m_sovaovien != "") sql += "sovaovien=:m_sovaovien,";
            sql += "tuoivao=:m_tuoivao,bnmoi=:m_bnmoi,userid=:m_userid,noitiepdon=:m_noitiepdon,loai=:m_loai,";
            sql += "mavaovien=:m_mavaovien where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar).Value = m_makp;
                //cmd.Parameters.Add("m_ngay", NpgsqlDbType.Date).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar).Value = m_ngay;
                cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                if (m_sovaovien != "") cmd.Parameters.Add("m_sovaovien", NpgsqlDbType.Varchar, 10).Value = m_sovaovien;
                cmd.Parameters.Add("m_tuoivao", NpgsqlDbType.Varchar, 4).Value = m_tuoivao;
                cmd.Parameters.Add("m_bnmoi", NpgsqlDbType.Numeric).Value = m_bnmoi;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_noitiepdon", NpgsqlDbType.Numeric).Value = m_noitiepdon;
                cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    if (m_sovaovien == "")
                    {
                        sql = "insert into " + xxx + ".tiepdon(mabn,maql,makp,ngay,madoituong,tuoivao,bnmoi,userid,noitiepdon,loai,ngayud,mavaovien)";
                        sql += " values (:m_mabn,:m_maql,:m_makp,to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),:m_madoituong,:m_tuoivao,:m_bnmoi,:m_userid,:m_noitiepdon,:m_loai,sysdate,:m_mavaovien)";
                    }
                    else
                    {
                        sql = "insert into " + xxx + ".tiepdon(mabn,maql,makp,ngay,madoituong,sovaovien,tuoivao,bnmoi,userid,noitiepdon,loai,ngayud,mavaovien)";
                        sql += " values (:m_mabn,:m_maql,:m_makp,to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),:m_madoituong,:m_sovaovien,:m_tuoivao,:m_bnmoi,:m_userid,:m_noitiepdon,:m_loai,sysdate,:m_mavaovien)";
                    }
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar).Value = m_makp;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar).Value = m_ngay;
                    cmd.Parameters.Add("m_madoituong", NpgsqlDbType.Numeric).Value = m_madoituong;
                    if (m_sovaovien != "") cmd.Parameters.Add("m_sovaovien", NpgsqlDbType.Varchar, 10).Value = m_sovaovien;
                    cmd.Parameters.Add("m_bnmoi", NpgsqlDbType.Numeric).Value = m_bnmoi;
                    cmd.Parameters.Add("m_tuoivao", NpgsqlDbType.Varchar, 4).Value = m_tuoivao;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    cmd.Parameters.Add("m_noitiepdon", NpgsqlDbType.Numeric).Value = m_noitiepdon;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                    cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "TD-" + m_mabn.Trim());
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_xuatvien_mmyy(string m_mabn, decimal m_maql, string m_makp, string m_ngay, int m_ketqua, int m_ttlucrv,
            string m_chandoan, string m_maicd, string m_mabs, string m_soluutru, int m_bienchung, int m_taibien, int m_giaiphau, int m_userid)
        {
            string xxx = user + mmyy(m_ngay);
            string sql = "update " + user + ".xuatvien set makp=:m_makp,ngay=to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),";
            sql += "ketqua=:m_ketqua,ttlucrv=:m_ttlucrv,chandoan=:m_chandoan,";
            sql += "maicd=:m_maicd,mabs=:m_mabs,soluutru=:m_soluutru,bienchung=:m_bienchung,";
            sql += "taibien=:m_taibien,giaiphau=:m_giaiphau,userid=:m_userid";
            sql += " where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar).Value = m_makp;
                //cmd.Parameters.Add("m_ngay", NpgsqlDbType.Date).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar).Value = m_ngay;
                cmd.Parameters.Add("m_ketqua", NpgsqlDbType.Numeric).Value = m_ketqua;
                cmd.Parameters.Add("m_ttlucrv", NpgsqlDbType.Numeric).Value = m_ttlucrv;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_soluutru", NpgsqlDbType.Text).Value = m_soluutru;
                cmd.Parameters.Add("m_bienchung", NpgsqlDbType.Numeric).Value = m_bienchung;
                cmd.Parameters.Add("m_taibien", NpgsqlDbType.Numeric).Value = m_taibien;
                cmd.Parameters.Add("m_giaiphau", NpgsqlDbType.Numeric).Value = m_giaiphau;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;

                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".xuatvien (mabn,maql,makp,ngay,ketqua,ttlucrv,chandoan,maicd,mabs,soluutru,bienchung,taibien,giaiphau,userid,ngayud)";
                    sql += " values (:m_mabn,:m_maql,:m_makp,to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),:m_ketqua,:m_ttlucrv,:m_chandoan,:m_maicd,:m_mabs,:m_soluutru,:m_bienchung,:m_taibien,:m_giaiphau,:m_userid,sysdate)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar).Value = m_makp;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar).Value = m_ngay;
                    cmd.Parameters.Add("m_ketqua", NpgsqlDbType.Numeric).Value = m_ketqua;
                    cmd.Parameters.Add("m_ttlucrv", NpgsqlDbType.Numeric).Value = m_ttlucrv;
                    cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                    cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    cmd.Parameters.Add("m_soluutru", NpgsqlDbType.Text).Value = m_soluutru;
                    cmd.Parameters.Add("m_bienchung", NpgsqlDbType.Numeric).Value = m_bienchung;
                    cmd.Parameters.Add("m_taibien", NpgsqlDbType.Numeric).Value = m_taibien;
                    cmd.Parameters.Add("m_giaiphau", NpgsqlDbType.Numeric).Value = m_giaiphau;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }

                //upd_hiendien(m_maql);
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "Xuatvien");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        //Thuy 21.12.2011
        public bool upd_xuatkhoa_noitru(decimal m_id, string m_ngay, int m_ketqua, int m_ttlucrk,
            string m_chandoan, string m_maicd, string m_mabs, int m_bienchung, int m_taibien,
            int m_giaiphau, int m_userid, string m_para, int m_phatqua)
        {
            sql = "update " + user + ".xuatkhoa set ngay=:m_ngay,ketqua=:m_ketqua,ttlucrk=:m_ttlucrk,";
            sql += "chandoan=:m_chandoan,maicd=:m_maicd,mabs=:m_mabs,bienchung=:m_bienchung,";
            sql += "taibien=:m_taibien,giaiphau=:m_giaiphau,para=:m_para,phatqua=:m_phatqua where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_ketqua", NpgsqlDbType.Numeric).Value = m_ketqua;
                cmd.Parameters.Add("m_ttlucrk", NpgsqlDbType.Numeric).Value = m_ttlucrk;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_bienchung", NpgsqlDbType.Numeric).Value = m_bienchung;
                cmd.Parameters.Add("m_taibien", NpgsqlDbType.Numeric).Value = m_taibien;
                cmd.Parameters.Add("m_giaiphau", NpgsqlDbType.Numeric).Value = m_giaiphau;
                cmd.Parameters.Add("m_para", NpgsqlDbType.Varchar).Value = m_para;
                cmd.Parameters.Add("m_phatqua", NpgsqlDbType.Numeric).Value = m_phatqua;//gam 11042012
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".xuatkhoa(id,ngay,ketqua,ttlucrk,chandoan,maicd,mabs,bienchung,taibien,giaiphau,userid,ngayud,para,phatqua)";
                    sql += "values (:m_id,:m_ngay,:m_ketqua,:m_ttlucrk,:m_chandoan,:m_maicd,:m_mabs,:m_bienchung,:m_taibien,:m_giaiphau,:m_userid,now(),:m_para,:m_phatqua)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_ketqua", NpgsqlDbType.Numeric).Value = m_ketqua;
                    cmd.Parameters.Add("m_ttlucrk", NpgsqlDbType.Numeric).Value = m_ttlucrk;
                    cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                    cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    cmd.Parameters.Add("m_bienchung", NpgsqlDbType.Numeric).Value = m_bienchung;
                    cmd.Parameters.Add("m_taibien", NpgsqlDbType.Numeric).Value = m_taibien;
                    cmd.Parameters.Add("m_giaiphau", NpgsqlDbType.Numeric).Value = m_giaiphau;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    cmd.Parameters.Add("m_para", NpgsqlDbType.Varchar).Value = m_para;
                    cmd.Parameters.Add("m_phatqua", NpgsqlDbType.Numeric).Value = m_phatqua; //gam 11042012
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "Xuatkhoa");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
                upd_hiendien(m_id, 1);
            }
            return true;
        }
        public string MaDangKyKhamBenh()//gam 20/03/2012
        {
            ds = get_data("select ten from medibv.d_thongso where id=216 ");
            if (ds.Tables[0].Rows.Count == 0) return "";
            return ds.Tables[0].Rows[0][0].ToString();
        }

        public string ViTriMaDangKyKhamBenh()//gam 20/03/2012
        {
            string ret = "15,5";
            ds = get_data("select ten from medibv.d_thongso where id=217");
            if (ds.Tables[0].Rows.Count > 0)
            {
                ret = ds.Tables[0].Rows[0][0].ToString().Trim();
                int pos = ret.IndexOf(",");
                if (pos != -1)
                {
                    int p1 = int.Parse(ret.Substring(0, pos)) - 1;
                    int p2 = int.Parse(ret.Substring(pos + 1));
                    ret = p1.ToString() + "," + p2.ToString();
                }
            }
            return ret;

        }

        public bool upd_xuatvien_noitru(string m_mabn, decimal m_maql, string m_makp, string m_ngay, int m_ketqua, int m_ttlucrv,
            string m_chandoan, string m_maicd, string m_mabs, string m_soluutru, int m_bienchung, int m_taibien,
            int m_giaiphau, int m_userid, string m_para, int m_phatqua, string m_ngaythoinoi)
        {
            string sql = "update " + user + ".xuatvien set makp=:m_makp,ngay=:m_ngay,";
            sql += "ketqua=:m_ketqua,ttlucrv=:m_ttlucrv,chandoan=:m_chandoan,";
            sql += "maicd=:m_maicd,mabs=:m_mabs,soluutru=:m_soluutru,bienchung=:m_bienchung,";
            sql += "taibien=:m_taibien,giaiphau=:m_giaiphau,para=:m_para,phatqua=:m_phatqua," +
                "ngaythoinoi=to_date(:m_ngaythoinoi,'dd/mm/yyyy')";
            sql += " where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_ketqua", NpgsqlDbType.Numeric).Value = m_ketqua;
                cmd.Parameters.Add("m_ttlucrv", NpgsqlDbType.Numeric).Value = m_ttlucrv;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_soluutru", NpgsqlDbType.Varchar, 10).Value = m_soluutru;
                cmd.Parameters.Add("m_bienchung", NpgsqlDbType.Numeric).Value = m_bienchung;
                cmd.Parameters.Add("m_taibien", NpgsqlDbType.Numeric).Value = m_taibien;
                cmd.Parameters.Add("m_giaiphau", NpgsqlDbType.Numeric).Value = m_giaiphau;
                cmd.Parameters.Add("m_para", NpgsqlDbType.Numeric).Value = m_para;
                cmd.Parameters.Add("m_phatqua", NpgsqlDbType.Numeric).Value = m_phatqua;
                cmd.Parameters.Add("m_ngaythoinoi", NpgsqlDbType.Varchar).Value = m_ngaythoinoi; 
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".xuatvien (mabn,maql,makp,ngay,ketqua,ttlucrv," +
                        "chandoan,maicd,mabs,soluutru,bienchung,taibien,giaiphau,userid,ngayud,para," +
                        "phatqua,ngaythoinoi)";
                    sql += " values (:m_mabn,:m_maql,:m_makp,:m_ngay,:m_ketqua,:m_ttlucrv,:m_chandoan," +
                        ":m_maicd,:m_mabs,:m_soluutru,:m_bienchung,:m_taibien,:m_giaiphau,:m_userid,now()," +
                        ":m_para,:m_phatqua,to_date(:m_ngaythoinoi,'dd/mm/yyyy'))";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_ketqua", NpgsqlDbType.Numeric).Value = m_ketqua;
                    cmd.Parameters.Add("m_ttlucrv", NpgsqlDbType.Numeric).Value = m_ttlucrv;
                    cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                    cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    cmd.Parameters.Add("m_soluutru", NpgsqlDbType.Varchar, 10).Value = m_soluutru;
                    cmd.Parameters.Add("m_bienchung", NpgsqlDbType.Numeric).Value = m_bienchung;
                    cmd.Parameters.Add("m_taibien", NpgsqlDbType.Numeric).Value = m_taibien;
                    cmd.Parameters.Add("m_giaiphau", NpgsqlDbType.Numeric).Value = m_giaiphau;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    cmd.Parameters.Add("m_para", NpgsqlDbType.Numeric).Value = m_para;
                    cmd.Parameters.Add("m_phatqua", NpgsqlDbType.Numeric).Value = m_phatqua;
                    cmd.Parameters.Add("m_ngaythoinoi", NpgsqlDbType.Varchar).Value = m_ngaythoinoi; 
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
                con.Close(); con.Dispose();
                upd_hiendien(m_maql);
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "Xuatvien");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        //end Thuy
        public decimal get_maql_mmyy(int m_loaiba, string m_mabn, string m_makp, string m_ngay, bool save)
        {
            if (!bMmyy(mmyy(m_ngay))) return 0;
            sql = "select maql from " + user + mmyy(m_ngay) + ".benhanpk where mabn='" + m_mabn + "' and to_char(ngay,'dd/mm/yyyy hh24:mi')='" + m_ngay + "'";
            if (m_makp != "??") sql += " and makp='" + m_makp + "'";
            ds = get_data(sql);
            decimal l_maql = (ds.Tables[0].Rows.Count == 0) ? 0 : decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            if (l_maql == 0 && save) l_maql = getidyymmddhhmiss_stt_computer;//get_capid(1);
            return l_maql;
        }
        public decimal get_maql_tiepdon_mmyy(string m_mabn, string m_ngay)
        {
            if (!bMmyy(mmyy(m_ngay))) return 0;
            sql = "select maql from " + user + mmyy(m_ngay) + ".tiepdon where mabn='" + m_mabn + "'" + " and to_char(ngay,'dd/mm/yyyy hh24:mi')='" + m_ngay + "'";
            ds = get_data(sql);
            decimal l_maql = (ds.Tables[0].Rows.Count == 0) ? 0 : decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            if (l_maql == 0) l_maql = getidyymmddhhmiss_stt_computer;//get_capid(1);
            return l_maql;
        }
        public decimal getSttkham(string ngay, string makp)
        {
            string xxx = user + mmyy(ngay);
            decimal so = get_stt_ngay(ngay);
            upd_sttkham(makp, ngay, so);
            upd_sttchitiet(ngay, makp, so);
            return so;
        }
        public decimal get_stt_ngay(string m_ngay)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".sttngay set so=so+1 where to_char(ngay,'dd/mm/yyyy')=:m_ngay";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            con.Open();
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;
            cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 10).Value = m_ngay;
            int irec = cmd.ExecuteNonQuery();
            cmd.Dispose();
            if (irec == 0)
            {
                sql = "insert into " + xxx + ".sttngay (ngay,so) values (to_date(:m_ngay,'dd/mm/yyyy'),1)";
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 10).Value = m_ngay;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            sql = "select so from " + xxx + ".sttngay where to_char(ngay,'dd/mm/yyyy')='" + m_ngay + "'";
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;
            dest = new NpgsqlDataAdapter(cmd);
            ds = new DataSet();
            dest.Fill(ds);
            cmd.Dispose();
            con.Close(); con.Dispose();
            return decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
        }
        public bool upd_sttchitiet(string m_ngay, string m_makp, decimal m_stt)
        {
            string xxx = user + mmyy(m_ngay);
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                sql = "insert into " + xxx + ".sttchitiet (ngay,makp,stt) values (to_date(:m_ngay,'dd/mm/yyyy'),:m_makp,:m_stt)";
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 10).Value = m_ngay;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar).Value = m_makp;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "sttchitiet");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public decimal getSttkham_hen(string ngay, string makp)
        {
            decimal so = get_stt_ngay_hen(ngay);
            upd_sttkham_hen(ngay, makp, so);
            upd_sttchitiet_hen(ngay, makp, so);
            return so;
        }
        public decimal get_stt_ngay_hen(string m_ngay)
        {
            sql = "update " + user + ".sttngay set so=so+1 where to_char(ngay,'dd/mm/yyyy')=:m_ngay";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            con.Open();
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;
            cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 10).Value = m_ngay;
            int irec = cmd.ExecuteNonQuery();
            cmd.Dispose();
            if (irec == 0)
            {
                sql = "insert into " + user + ".sttngay (ngay,so) values (to_date(:m_ngay,'dd/mm/yyyy'),1)";
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 10).Value = m_ngay;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            sql = "select so from " + user + ".sttngay where to_char(ngay,'dd/mm/yyyy')='" + m_ngay + "'";
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;
            dest = new NpgsqlDataAdapter(cmd);
            ds = new DataSet();
            dest.Fill(ds);
            cmd.Dispose();
            con.Close(); con.Dispose();
            return decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
        }
        public bool upd_sttkham_hen(string m_ngay, string m_makp, decimal m_stt)
        {
            sql = "update " + user + ".sttkham set so=so+1,stt=:m_stt where to_char(ngay,'dd/mm/yyyy')=:m_ngay and makp=:m_makp";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 10).Value = m_ngay;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar).Value = m_makp;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".sttkham (ngay,makp,so,stt) values (to_date(:m_ngay,'dd/mm/yyyy'),:m_makp,1,:m_stt)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 10).Value = m_ngay;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar).Value = m_makp;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "sttkham");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_sttchitiet_hen(string m_ngay, string m_makp, decimal m_stt)
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                sql = "insert into " + user + ".sttchitiet (ngay,makp,stt) values (to_date(:m_ngay,'dd/mm/yyyy'),:m_makp,:m_stt)";
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 10).Value = m_ngay;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "sttchitiet");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public void upd_remark(string m_makp, int m_remark)
        {
            execute_data("update " + user + ".btdkp_bv set remark=" + m_remark + " where makp='" + m_makp + "'");
        }
        public bool upd_nhapkhoa(decimal m_id, string m_mabn, decimal m_maql, string m_makp, int m_maba, string m_ngay, string m_tuoivao, string m_giuong, string m_khoachuyen, string m_chandoan, string m_maicd, string m_mabs, int m_lan, int m_userid)
        {
            sql = "update " + user + ".nhapkhoa set makp=:m_makp,maba=:m_maba,ngay=to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),";
            sql += "tuoivao=:m_tuoivao,giuong=:m_giuong,khoachuyen=:m_khoachuyen,";
            sql += "chandoan=:m_chandoan,maicd=:m_maicd,mabs=:m_mabs,lan=:m_lan";
            //sql+=",userid=:m_userid ";
            sql += " where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                cmd.Parameters.Add("m_maba", NpgsqlDbType.Numeric).Value = m_maba;
                //cmd.Parameters.Add("m_ngay", NpgsqlDbType.Date).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar).Value = m_ngay;
                cmd.Parameters.Add("m_tuoivao", NpgsqlDbType.Varchar, 4).Value = m_tuoivao;
                cmd.Parameters.Add("m_giuong", NpgsqlDbType.Varchar, 10).Value = m_giuong;
                cmd.Parameters.Add("m_khoachuyen", NpgsqlDbType.Varchar, 2).Value = m_khoachuyen;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_lan", NpgsqlDbType.Numeric).Value = m_lan;
                //cmd.Parameters.Add("m_userid",NpgsqlDbType.Number).Value=m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".nhapkhoa(id,mabn,maql,makp,maba,ngay,tuoivao,giuong,khoachuyen,chandoan,maicd,mabs,lan,userid,ngayud)";
                    sql += " values (:m_id,:m_mabn,:m_maql,:m_makp,:m_maba,to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),:m_tuoivao,:m_giuong,:m_khoachuyen,:m_chandoan,:m_maicd,:m_mabs,:m_lan,:m_userid,sysdate)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_maba", NpgsqlDbType.Numeric).Value = m_maba;
                    //cmd.Parameters.Add("m_ngay", NpgsqlDbType.Date).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar).Value = m_ngay;
                    cmd.Parameters.Add("m_tuoivao", NpgsqlDbType.Varchar, 4).Value = m_tuoivao;
                    cmd.Parameters.Add("m_giuong", NpgsqlDbType.Varchar, 10).Value = m_giuong;
                    cmd.Parameters.Add("m_khoachuyen", NpgsqlDbType.Varchar, 2).Value = m_khoachuyen;
                    cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                    cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar, 9).Value = m_maicd;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    cmd.Parameters.Add("m_lan", NpgsqlDbType.Numeric).Value = m_lan;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                    execute_data("delete " + user + ".hiendien where nhapkhoa=0 and xuatkhoa=0 and mabn='" + m_mabn + "' and maql=" + m_maql + " and makp='" + m_makp + "'");
                    upd_hiendien(m_id, m_mabn, m_maql, m_makp, m_ngay, m_khoachuyen);
                    upd_hiendien(m_id, 0);
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "Nhapkhoa");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_hiendien(decimal m_id, string m_mabn, decimal m_maql, string m_makp, string m_ngay, string m_noichuyen)
        {
            sql = "update " + user + ".hiendien set makp=:m_makp,ngay=:m_ngay,noichuyen=:m_noichuyen where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Date).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_noichuyen", NpgsqlDbType.Varchar, 2).Value = m_noichuyen;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".hiendien(id,mabn,maql,makp,ngay,noichuyen,nhapkhoa,xuatkhoa) values (:m_id,:m_mabn,:m_maql,:m_makp,:m_ngay,:m_noichuyen,0,0)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Date).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_noichuyen", NpgsqlDbType.Varchar, 2).Value = m_noichuyen;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "hiendien");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_hiendien(decimal m_id, string m_mabn, decimal m_maql, string m_makp, string m_ngay, string m_noichuyen, int m_nhapkhoa, int m_xuatkhoa)
        {
            sql = "update " + user + ".hiendien set makp=:m_makp,ngay=:m_ngay,noichuyen=:m_noichuyen,";
            sql += "nhapkhoa=:m_nhapkhoa,xuatkhoa=:m_xuatkhoa where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Date).Value = StringToDateTime(m_ngay);
                cmd.Parameters.Add("m_noichuyen", NpgsqlDbType.Varchar, 2).Value = m_noichuyen;
                cmd.Parameters.Add("m_nhapkhoa", NpgsqlDbType.Numeric).Value = m_nhapkhoa;
                cmd.Parameters.Add("m_xuatkhoa", NpgsqlDbType.Numeric).Value = m_xuatkhoa;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".hiendien(id,mabn,maql,makp,ngay,noichuyen,nhapkhoa,xuatkhoa) values (:m_id,:m_mabn,:m_maql,:m_makp,:m_ngay,:m_noichuyen,:m_nhapkhoa,:m_xuatkhoa)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Date).Value = StringToDateTime(m_ngay);
                    cmd.Parameters.Add("m_noichuyen", NpgsqlDbType.Varchar, 2).Value = m_noichuyen;
                    cmd.Parameters.Add("m_nhapkhoa", NpgsqlDbType.Numeric).Value = m_nhapkhoa;
                    cmd.Parameters.Add("m_xuatkhoa", NpgsqlDbType.Numeric).Value = m_xuatkhoa;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "hiendien");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public string get_maso_khambenh(decimal maql, string ngay)
        {
            string maso = maql.ToString().Trim() + ",";
            bool bFound = false;
            //foreach (DataRow r in get_data("select distinct mavaovien from " + user + mmyy(ngay) + ".benhandt where maql=" + maql).Tables[0].Rows)
            foreach (DataRow r in get_data("select distinct mavaovien from " + user + mmyy(ngay) + ".benhanpk where maql=" + maql).Tables[0].Rows)
            {
                if (maso.IndexOf(r["mavaovien"].ToString().Trim() + ",") == -1) maso += r["mavaovien"].ToString().Trim() + ",";
                if (decimal.Parse(r["mavaovien"].ToString()) > 0)
                {
                    //foreach (DataRow r1 in get_data_mmyy("select distinct maql from xxx.benhandt where mavaovien=" + decimal.Parse(r["mavaovien"].ToString()), ngay, ngay, Taikham_songay).Tables[0].Rows)
                    foreach (DataRow r1 in get_data_mmyy("select distinct maql from xxx.benhanpk where mavaovien=" + decimal.Parse(r["mavaovien"].ToString()), ngay, ngay, Taikham_songay).Tables[0].Rows)
                        if (maso.IndexOf(r1["maql"].ToString().Trim() + ",") == -1) maso += r1["maql"].ToString().Trim() + ",";

                    foreach (DataRow r1 in get_data_mmyy("select distinct maql from xxx.tiepdon where mavaovien=" + decimal.Parse(r["mavaovien"].ToString()), ngay, ngay, Taikham_songay).Tables[0].Rows)
                        if (maso.IndexOf(r1["maql"].ToString().Trim() + ",") == -1) maso += r1["maql"].ToString().Trim() + ",";
                }
                bFound = true;
            }
            if (!bFound)
            {
                string s = "";
                foreach (DataRow r in get_data("select distinct matiepdon from " + user + ".sukien where matiepdon>0 and macap=" + maql).Tables[0].Rows)
                    s += r["matiepdon"].ToString() + ",";
                if (s != "")
                {
                    if (bMmyy(mmyy(ngay)))
                    {
                        //foreach (DataRow r1 in get_data_mmyy("select distinct maql from xxx.benhandt where mavaovien in (" + s.Substring(0, s.Length - 1) + ")", ngay, ngay, Taikham_songay).Tables[0].Rows)
                        foreach (DataRow r1 in get_data_mmyy("select distinct maql from xxx.benhanpk where mavaovien in (" + s.Substring(0, s.Length - 1) + ")", ngay, ngay, Taikham_songay).Tables[0].Rows)
                            if (maso.IndexOf(r1["maql"].ToString().Trim() + ",") == -1) maso += r1["maql"].ToString().Trim() + ",";

                        foreach (DataRow r1 in get_data_mmyy("select distinct maql from xxx.tiepdon where mavaovien in(" + s.Trim().Trim(',') + ")", ngay, ngay, Taikham_songay).Tables[0].Rows)
                            if (maso.IndexOf(r1["maql"].ToString().Trim() + ",") == -1) maso += r1["maql"].ToString().Trim() + ",";
                    }
                }
            }
            return maso;
        }
        public DataSet get_data_mmyy(string str, string tu, string den, int songay)
        {
            DataSet tmp = new DataSet();

            DateTime dt1 = (songay != 0) ? StringToDate(tu).AddDays(-songay) : StringToDate(tu);
            DateTime dt2 = (songay != 0) ? StringToDate(den).AddDays(songay) : StringToDate(den);
            int y1 = dt1.Year, m1 = dt1.Month;
            int y2 = dt2.Year, m2 = dt2.Month;
            int itu, iden;
            string mmyy = "";
            bool be = true;
            for (int i = y1; i <= y2; i++)
            {
                itu = (i == y1) ? m1 : 1;
                iden = (i == y2) ? m2 : 12;
                for (int j = itu; j <= iden; j++)
                {
                    mmyy = j.ToString().PadLeft(2, '0') + i.ToString().Substring(2, 2);
                    if (bMmyy(mmyy))
                    {
                        sql = str.Replace("xxx", user + mmyy);
                        if (be || tmp == null)
                        {
                            tmp = get_data(sql);
                            be = false;
                        }
                        else tmp.Merge(get_data(sql));
                    }
                }
            }
            return tmp;
        }
        public bool get_thvp_done(string mabn, string maso, string tu, string den)
        {
            sql = "select a.done from xxx.v_thvpll a," + user + ".btdkp_bv b where a.makp=b.makp";
            sql += " and a.mabn='" + mabn + "'";
            if (maso != "") sql += " and a.maql in (" + maso.Substring(0, maso.Length - 1) + ")";
            sql += " and a.done=1";
            return get_data_mmyy(sql, tu, den, true).Tables[0].Rows.Count > 0;
        }
        public string get_tamung(string mabn, string maso, string tu, string den)
        {
            decimal ret = 0;


            DateTime dt1 = StringToDate(tu).AddDays(-iNgaykiemke);
            DateTime dt2 = StringToDate(den).AddDays(iNgaykiemke);
            int y1 = dt1.Year, m1 = dt1.Month;
            int y2 = dt2.Year, m2 = dt2.Month;
            int itu, iden;
            string mmyy = "", s = "", xxx;
            for (int i = y1; i <= y2; i++)
            {
                itu = (i == y1) ? m1 : 1;
                iden = (i == y2) ? m2 : 12;
                for (int j = itu; j <= iden; j++)
                {
                    mmyy = j.ToString().PadLeft(2, '0') + i.ToString().Substring(2, 2);
                    xxx = user + mmyy;
                    if (bMmyy(mmyy))
                    {
                        sql = "select sum(a.sotien) sotien, a.quyenso, b.sohieu,a.sobienlai,to_char(a.ngay,'dd/mm/yyyy') as ngay,f.hoten ";
                        sql += " from " + xxx + ".v_tamung a, " + user + ".v_quyenso b," + userid + ".btdkp_bv e," + userid + ".v_dlogin f";
                        sql += " where a.quyenso=b.id and a.makp=e.makp(+) and a.userid=f.id and a.mabn='" + mabn + "'";
                        sql += " and to_date(to_char(a.ngay,'dd/mm/yyyy'),'dd/mm/yyyy') between to_date('" + tu.Substring(0, 10) + "','dd/mm/yyyy') and to_date('" + den.Substring(0, 10) + "','dd/mm/yyyy')";
                        if (maso != "") sql += " and a.maql in (" + maso.Substring(0, maso.Trim().Length - 1) + ")";
                        sql += " group by a.quyenso, b.sohieu, a.sobienlai,to_char(a.ngay,'dd/mm/yyyy'),f.hoten ";
                        ds = get_data(sql);
                        foreach (DataRow r in ds.Tables[0].Rows)
                        {
                            ret += decimal.Parse(r["sotien"].ToString());
                            s += r["sohieu"].ToString().Trim() + "-" + r["sobienlai"].ToString().Trim() + " " + r["ngay"].ToString() + " Người thu :" + r["hoten"].ToString().Trim() + " :" + r["sotien"].ToString().Trim() + ";";
                        }
                    }
                }
            }
            //hoan tra
            for (int i = y1; i <= y2; i++)
            {
                itu = (i == y1) ? m1 : 1;
                iden = (i == y2) ? m2 : 12;
                for (int j = itu; j <= iden; j++)
                {
                    mmyy = j.ToString().PadLeft(2, '0') + i.ToString().Substring(2, 2);
                    xxx = user + mmyy;
                    if (bMmyy(mmyy))
                    {
                        sql = "select sum(a.sotien) sotien, a.quyenso, b.sohieu,a.sobienlai,to_char(a.ngay,'dd/mm/yyyy') as ngay,f.hoten ";
                        sql += " from " + xxx + ".v_hoantra a, " + user + ".v_quyenso b," + userid + ".btdkp_bv e," + userid + ".v_dlogin f";
                        sql += " where a.quyenso=b.id and a.makp=e.makp(+) and a.userid=f.id and a.mabn='" + mabn + "'";
                        sql += " and to_date(a.ngay,'dd/mm/yy') between to_date('" + tu.Substring(0, 10) + "','dd/mm/yy') and to_date('" + den.Substring(0, 10) + "','dd/mm/yy')";
                        sql += " and a.loaibn=2";
                        sql += " group by a.quyenso, b.sohieu, a.sobienlai,to_char(a.ngay,'dd/mm/yyyy'),f.hoten ";
                        ds = get_data(sql);
                        foreach (DataRow r in ds.Tables[0].Rows)
                        {
                            if (s.IndexOf(r["quyenso"].ToString().Trim() + "-" + r["sobienlai"].ToString().Trim() + ";") != -1)
                            {
                                ret -= decimal.Parse(r["sotien"].ToString());
                                s += "Hoàn trả " + r["sohieu"].ToString().Trim() + "-" + r["sobienlai"].ToString().Trim() + " " + r["ngay"].ToString() + " Người thu :" + r["hoten"].ToString().Trim() + " :" + r["sotien"].ToString().Trim() + ";";
                            }
                        }
                    }
                }
            }
            return ret.ToString() + "^" + s;
        }
        public int iNgaykiemke
        {
            get
            {
                int i_Ngaykiemke = 0;
                ds = get_data("select distinct ten from " + user + ".d_thongso where id=105 and ten is not null ");
                try
                {
                    foreach (DataRow r in ds.Tables[0].Rows)
                    {
                        if (r["ten"].ToString() == "") i_Ngaykiemke = 22;
                        else
                        {
                            if (i_Ngaykiemke < int.Parse(r["ten"].ToString()))
                                i_Ngaykiemke = int.Parse(r["ten"].ToString());
                        }
                    }
                }
                catch { }
                if (i_Ngaykiemke == 0) i_Ngaykiemke = 22;
                return i_Ngaykiemke;
            }
        }
        public void updrec_ravien(DataSet ds, int khu, string matt, string mabn, decimal maql, decimal idkhoa, string hoten,
            string namsinh, string phai, string diachi, int madoituong, string doituong, string sothe, decimal maphu,
            string tungay, string denngay, string noigioithieu, string noicap, string giuong, string makp, string tenkp,
            string ngayvao, string ngayra, string chandoan, string maicd, int sttnhom, string nhom,
            int sttloai, string loai, int ma, string ten, string dvt, decimal soluong, decimal sotien, decimal bhyt,
            decimal tamung, decimal bhytt0107, string nguoinha, int hinhthuc, int phuongphap, int ketqua,
            string soluutru, decimal dongia, string ngaypt, string tenpt, int loaiba, int done, string mabs, string tenbs,
            string tenuser, string image, string ghichu, string ngay1, string ngay2, string ngay3,
            string ngay, int kythuat, string sobienlaitamung, int traituyen, decimal giachenhlech)
        {
            string exp = "khu=" + khu + " and matt='" + matt + "' and makp='" + makp + "' and mabn='" + mabn + "' and madoituong=" + madoituong + " and ma=" + ma + " and dongia=" + Math.Round(dongia, 2) + " and ngay='" + ngay + "'";
            if (ma == 0) exp += " and sttnhom=" + sttnhom;
            exp += " and giachenhlech=" + Math.Round(giachenhlech, 2);
            DataRow r = getrowbyid(ds.Tables[0], exp);
            if (r == null)
            {
                DataRow r1 = ds.Tables[0].NewRow();
                r1["khu"] = khu;
                r1["matt"] = matt;
                r1["mabn"] = mabn;
                r1["maql"] = maql;
                r1["idkhoa"] = idkhoa;
                r1["hoten"] = hoten;
                r1["namsinh"] = namsinh;
                r1["phai"] = phai;
                r1["diachi"] = diachi;
                r1["madoituong"] = madoituong;
                r1["doituong"] = doituong;
                r1["sothe"] = sothe;
                r1["maphu"] = maphu;
                r1["tungay"] = tungay;
                r1["denngay"] = denngay;
                r1["noigioithieu"] = noigioithieu;
                r1["noicap"] = noicap;
                r1["giuong"] = giuong;
                r1["makp"] = makp;
                r1["tenkp"] = tenkp;
                r1["ngayvao"] = ngayvao;
                r1["ngayra"] = ngayra;
                r1["chandoan"] = chandoan;
                r1["maicd"] = maicd;
                r1["sttnhom"] = sttnhom;
                r1["nhom"] = nhom;
                r1["sttloai"] = sttloai;
                r1["loai"] = loai;
                r1["ma"] = ma;
                r1["ten"] = ten;
                r1["dvt"] = dvt;
                r1["soluong"] = soluong;
                r1["dongia"] = Math.Round(dongia, 2);//dongia;
                r1["sotien"] = sotien;
                r1["bhyt"] = bhyt;
                r1["bhytt0107"] = bhytt0107;
                r1["tamung"] = tamung;
                r1["sbltamung"] = sobienlaitamung;
                r1["tcsotien"] = 0;
                r1["dichso"] = "";
                r1["bhyttra"] = 0;
                r1["mien"] = 0;
                r1["bntra"] = 0;
                r1["dichsotra"] = "";
                r1["nguoinha"] = nguoinha;
                r1["hinhthuc"] = hinhthuc;
                r1["phuongphap"] = phuongphap;
                r1["ketqua"] = ketqua;
                r1["soluutru"] = soluutru;
                r1["ngaypt"] = ngaypt;
                r1["tenpt"] = tenpt;
                r1["loaiba"] = loaiba;
                r1["done"] = done;
                r1["sophieu"] = 0;
                r1["lanin"] = 0;
                r1["mabs"] = mabs;
                r1["tenbs"] = tenbs;
                r1["tenuser"] = tenuser;
                r1["ghichu"] = ghichu;
                r1["ngay1"] = ngay1;
                r1["ngay2"] = ngay2;
                r1["ngay3"] = ngay3;
                r1["ngay"] = ngay;
                if (ngay != "") r1["yyyymmdd"] = ngay.Substring(6, 4) + ngay.Substring(3, 2) + ngay.Substring(0, 2);
                if (image != "") r1["image"] = image;
                r1["kythuat"] = kythuat;
                r1["traituyen"] = traituyen;
                r1["giachenhlech"] = Math.Round(giachenhlech, 0);
                ds.Tables[0].Rows.Add(r1);
            }
            else
            {
                DataRow[] dr = ds.Tables[0].Select(exp);
                if (dr.Length > 0)
                {
                    dr[0]["soluong"] = decimal.Parse(dr[0]["soluong"].ToString()) + soluong;
                    dr[0]["sotien"] = decimal.Parse(dr[0]["sotien"].ToString()) + sotien;
                    dr[0]["bhyt"] = decimal.Parse(dr[0]["bhyt"].ToString()) + bhyt;
                    dr[0]["bhytt0107"] = decimal.Parse(dr[0]["bhytt0107"].ToString()) + bhytt0107;
                }
            }
        }
        public bool bHienthi_BieutuongMayin
        {
            //A17
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from thongso where id=1026");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        private bool bGia_vp_cochenhlech(int igiavp)
        {
            bool bln = false;
            sql = "select chenhlech from " + user + ".v_giavp where id=" + igiavp;
            DataSet lds = get_data(sql);
            if (lds == null || lds.Tables.Count <= 0 || lds.Tables[0].Rows.Count == 0) bln = false;
            else bln = lds.Tables[0].Rows[0]["chenhlech"].ToString() == "1";
            return bln;
        }
        public bool upd_bavv_rhm(string m_ngay, decimal m_maql, byte[] m_image, string m_nhanxet, string m_chandoan)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".bavv_rhm set image=:m_image,nhanxet=:m_nhanxet,chandoan=:m_chandoan";
            sql += " where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("m_image", NpgsqlDbType.Bytea, m_image.Length).Value = m_image;
                cmd.Parameters.Add("m_nhanxet", NpgsqlDbType.Text).Value = m_nhanxet;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".bavv_rhm (maql,image,nhanxet,chandoan) values (:m_maql,:m_image,:m_nhanxet,:m_chandoan)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_image", NpgsqlDbType.Bytea, m_image.Length).Value = m_image;
                    cmd.Parameters.Add("m_nhanxet", NpgsqlDbType.Text).Value = m_nhanxet;
                    cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "bavv_rhm");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_bavv_tmh(string m_ngay, decimal m_maql, byte[] m_image1, byte[] m_image2, byte[] m_image3, byte[] m_image4)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".bavv_tmh set image1=:m_image1,image2=:m_image2,image3=:m_image3,image4=:m_image4";
            sql += " where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("m_image1", NpgsqlDbType.Bytea, m_image1.Length).Value = m_image1;
                cmd.Parameters.Add("m_image2", NpgsqlDbType.Bytea, m_image2.Length).Value = m_image2;
                cmd.Parameters.Add("m_image3", NpgsqlDbType.Bytea, m_image3.Length).Value = m_image3;
                cmd.Parameters.Add("m_image4", NpgsqlDbType.Bytea, m_image4.Length).Value = m_image4;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "bavv_tmh");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_bavv_tmhct(string m_ngay, decimal m_maql, int m_stt, string m_taip, string m_tait)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".bavv_tmhct set taip=:m_taip,tait=:m_tait ";
            sql += "where maql=:m_maql and stt=:m_stt";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_taip", NpgsqlDbType.Text).Value = m_taip;
                cmd.Parameters.Add("m_tait", NpgsqlDbType.Text).Value = m_tait;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".bavv_tmhct (maql,stt,taip,tait) values (:m_maql,:m_stt,:m_taip,:m_tait)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_taip", NpgsqlDbType.Text).Value = m_taip;
                    cmd.Parameters.Add("m_tait", NpgsqlDbType.Text).Value = m_tait;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "bavv_tmhct");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_bavv_tmh(string m_ngay, decimal m_maql, string m_tai, string m_mui, string m_hong, string m_kham)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".bavv_tmh set tai=:m_tai,mui=:m_mui,hong=:m_hong,kham=:m_kham ";
            sql += "where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_tai", NpgsqlDbType.Text).Value = m_tai;
                cmd.Parameters.Add("m_mui", NpgsqlDbType.Text).Value = m_mui;
                cmd.Parameters.Add("m_hong", NpgsqlDbType.Text).Value = m_hong;
                cmd.Parameters.Add("m_kham", NpgsqlDbType.Text).Value = m_kham;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".bavv_tmh (maql,tai,mui,hong,kham) values (:m_maql,:m_tai,:m_mui,:m_hong,:m_kham)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_tai", NpgsqlDbType.Text).Value = m_tai;
                    cmd.Parameters.Add("m_mui", NpgsqlDbType.Text).Value = m_mui;
                    cmd.Parameters.Add("m_hong", NpgsqlDbType.Text).Value = m_hong;
                    cmd.Parameters.Add("m_kham", NpgsqlDbType.Text).Value = m_kham;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "bavv_tmh");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_ba_locmauct(string m_ngayvv, decimal m_id, int m_stt, string m_ngay, decimal m_mach, string m_huyetap,
            decimal m_nhietdo, decimal m_nhiptho, decimal m_tocdo, string m_dm, string m_tm, decimal m_sieuloc, string m_taibien,
            string m_thuoc, string m_mabs, string m_yta)
        {
            string xxx = user + mmyy(m_ngayvv);
            sql = "update " + xxx + ".ba_locmauct set ngay=to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),";
            sql += "mach=:m_mach,huyetap=:m_huyetap,nhietdo=:m_nhietdo,nhiptho=:m_nhiptho,tocdo=:m_tocdo,";
            sql += "dm=:m_dm,tm=:m_tm,sieuloc=:m_sieuloc,taibien=:m_taibien,thuoc=:m_thuoc,mabs=:m_mabs,yta=:m_yta ";
            sql += "where id=:m_id and stt=:m_stt";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                cmd.Parameters.Add("m_mach", NpgsqlDbType.Numeric).Value = m_mach;
                cmd.Parameters.Add("m_huyetap", NpgsqlDbType.Varchar, 7).Value = m_huyetap;
                cmd.Parameters.Add("m_nhietdo", NpgsqlDbType.Numeric).Value = m_nhietdo;
                cmd.Parameters.Add("m_nhiptho", NpgsqlDbType.Numeric).Value = m_nhiptho;
                cmd.Parameters.Add("m_tocdo", NpgsqlDbType.Numeric).Value = m_tocdo;
                cmd.Parameters.Add("m_dm", NpgsqlDbType.Text, 20).Value = m_dm;
                cmd.Parameters.Add("m_tm", NpgsqlDbType.Text, 20).Value = m_tm;
                cmd.Parameters.Add("m_sieuloc", NpgsqlDbType.Numeric).Value = m_sieuloc;
                cmd.Parameters.Add("m_taibien", NpgsqlDbType.Text, 500).Value = m_taibien;
                cmd.Parameters.Add("m_thuoc", NpgsqlDbType.Text, 1000).Value = m_thuoc;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_yta", NpgsqlDbType.Varchar, 4).Value = m_yta;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;

                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_locmauct (id,stt,ngay,mach,huyetap,nhietdo,nhiptho,tocdo,dm,tm,sieuloc,taibien,thuoc,mabs,yta) ";
                    sql += "values (:m_id,:m_stt,to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),:m_mach,:m_huyetap,:m_nhietdo,:m_nhiptho,:m_tocdo,:m_dm,:m_tm,:m_sieuloc,:m_taibien,:m_thuoc,:m_mabs,:m_yta)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 16).Value = m_ngay;
                    cmd.Parameters.Add("m_mach", NpgsqlDbType.Numeric).Value = m_mach;
                    cmd.Parameters.Add("m_huyetap", NpgsqlDbType.Varchar, 7).Value = m_huyetap;
                    cmd.Parameters.Add("m_nhietdo", NpgsqlDbType.Numeric).Value = m_nhietdo;
                    cmd.Parameters.Add("m_nhiptho", NpgsqlDbType.Numeric).Value = m_nhiptho;
                    cmd.Parameters.Add("m_tocdo", NpgsqlDbType.Numeric).Value = m_tocdo;
                    cmd.Parameters.Add("m_dm", NpgsqlDbType.Text, 20).Value = m_dm;
                    cmd.Parameters.Add("m_tm", NpgsqlDbType.Text, 20).Value = m_tm;
                    cmd.Parameters.Add("m_sieuloc", NpgsqlDbType.Numeric).Value = m_sieuloc;
                    cmd.Parameters.Add("m_taibien", NpgsqlDbType.Text, 500).Value = m_taibien;
                    cmd.Parameters.Add("m_thuoc", NpgsqlDbType.Text, 1000).Value = m_thuoc;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    cmd.Parameters.Add("m_yta", NpgsqlDbType.Varchar, 4).Value = m_yta;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_locmauct");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_ba_locmaull(string m_ngayvv, string m_mabn, decimal m_id, decimal m_idthuchien, string m_ngaybd, decimal m_cantloc,
            decimal m_rutnuoc, decimal m_dichvamau, decimal m_cansloc, int m_fav, int m_ttmd, int m_mtct, int m_tmdd,
            int m_heparin, int m_tlpt, string m_lieudau, string m_duytri, string m_tonglieu, int m_lientuc, int m_cachquang,
            string m_khac, string m_ngaykt, string m_mangloc, string m_nhanhieu, string m_dientich, string m_heso,
            string m_baoquan, decimal m_landung, string m_mabs, string m_yta, int m_userid)
        {
            string xxx = user + mmyy(m_ngayvv);
            sql = "update " + xxx + ".ba_locmaull set mabn=:m_mabn,idthuchien=:m_idthuchien,ngaybd=to_date(:m_ngaybd,'dd/mm/yyyy hh24:mi'),";
            sql += "cantloc=:m_cantloc,rutnuoc=:m_rutnuoc,dichvamau=:m_dichvamau,cansloc=:m_cansloc,fav=:m_fav,ttmd=:m_ttmd,";
            sql += "mtct=:m_mtct,tmdd=:m_tmdd,heparin=:m_heparin,tlpt=:m_tlpt,lieudau=:m_lieudau,duytri=:m_duytri,";
            sql += "tonglieu=:m_tonglieu,lientuc=:m_lientuc,cachquang=:m_cachquang,khac=:m_khac,";
            if (m_ngaykt.Trim() != "") sql += "ngaykt=to_date(:m_ngaykt,'dd/mm/yyyy hh24:mi'),";
            sql += "mangloc=:m_mangloc,nhanhieu=:m_nhanhieu,dientich=:m_dientich,heso=:m_heso,baoquan=:m_baoquan,";
            sql += "landung=:m_landung,mabs=:m_mabs,yta=:m_yta,userid=:m_userid where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                cmd.Parameters.Add("m_ngaybd", NpgsqlDbType.Varchar, 16).Value = m_ngaybd;
                cmd.Parameters.Add("m_cantloc", NpgsqlDbType.Numeric).Value = m_cantloc;
                cmd.Parameters.Add("m_rutnuoc", NpgsqlDbType.Numeric).Value = m_rutnuoc;
                cmd.Parameters.Add("m_dichvamau", NpgsqlDbType.Numeric).Value = m_dichvamau;
                cmd.Parameters.Add("m_cansloc", NpgsqlDbType.Numeric).Value = m_cansloc;
                cmd.Parameters.Add("m_fav", NpgsqlDbType.Numeric).Value = m_fav;
                cmd.Parameters.Add("m_ttmd", NpgsqlDbType.Numeric).Value = m_ttmd;
                cmd.Parameters.Add("m_mtct", NpgsqlDbType.Numeric).Value = m_mtct;
                cmd.Parameters.Add("m_tmdd", NpgsqlDbType.Numeric).Value = m_tmdd;
                cmd.Parameters.Add("m_heparin", NpgsqlDbType.Numeric).Value = m_heparin;
                cmd.Parameters.Add("m_tlpt", NpgsqlDbType.Numeric).Value = m_tlpt;
                cmd.Parameters.Add("m_lieudau", NpgsqlDbType.Text, 20).Value = m_lieudau;
                cmd.Parameters.Add("m_duytri", NpgsqlDbType.Text, 20).Value = m_duytri;
                cmd.Parameters.Add("m_tonglieu", NpgsqlDbType.Text, 20).Value = m_tonglieu;
                cmd.Parameters.Add("m_lientuc", NpgsqlDbType.Numeric).Value = m_lientuc;
                cmd.Parameters.Add("m_cachquang", NpgsqlDbType.Numeric).Value = m_cachquang;
                cmd.Parameters.Add("m_khac", NpgsqlDbType.Text, 100).Value = m_khac;
                if (m_ngaykt.Trim() != "") cmd.Parameters.Add("m_ngaykt", NpgsqlDbType.Varchar, 16).Value = m_ngaykt.Trim();
                cmd.Parameters.Add("m_mangloc", NpgsqlDbType.Text, 50).Value = m_mangloc;
                cmd.Parameters.Add("m_nhanhieu", NpgsqlDbType.Text, 50).Value = m_nhanhieu;
                cmd.Parameters.Add("m_dientich", NpgsqlDbType.Text, 50).Value = m_dientich;
                cmd.Parameters.Add("m_heso", NpgsqlDbType.Text, 50).Value = m_heso;
                cmd.Parameters.Add("m_baoquan", NpgsqlDbType.Text, 50).Value = m_baoquan;
                cmd.Parameters.Add("m_landung", NpgsqlDbType.Numeric).Value = m_landung;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                cmd.Parameters.Add("m_yta", NpgsqlDbType.Varchar, 4).Value = m_yta;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;

                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".ba_locmaull (mabn,id,idthuchien,ngaybd,cantloc,rutnuoc,dichvamau,cansloc,fav,ttmd,mtct,tmdd,heparin,tlpt,lieudau,duytri,tonglieu,lientuc,cachquang,khac,";
                    if (m_ngaykt.Trim() != "") sql += "ngaykt,";
                    sql += "mangloc,nhanhieu,dientich,heso,baoquan,landung,mabs,yta,userid) ";
                    sql += "values (:m_mabn,:m_id,:m_idthuchien,to_date(:m_ngaybd,'dd/mm/yyyy hh24:mi'),:m_cantloc,:m_rutnuoc,:m_dichvamau,:m_cansloc,:m_fav,:m_ttmd,:m_mtct,:m_tmdd,:m_heparin,:m_tlpt,:m_lieudau,:m_duytri,:m_tonglieu,:m_lientuc,:m_cachquang,:m_khac,";
                    if (m_ngaykt.Trim() != "") sql += "to_date(:m_ngaykt,'dd/mm/yyyy hh24:mi'),";
                    sql += ":m_mangloc,:m_nhanhieu,:m_dientich,:m_heso,:m_baoquan,:m_landung,:m_mabs,:m_yta,:m_userid) ";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_idthuchien", NpgsqlDbType.Numeric).Value = m_idthuchien;
                    cmd.Parameters.Add("m_ngaybd", NpgsqlDbType.Varchar, 16).Value = m_ngaybd;
                    cmd.Parameters.Add("m_cantloc", NpgsqlDbType.Numeric).Value = m_cantloc;
                    cmd.Parameters.Add("m_rutnuoc", NpgsqlDbType.Numeric).Value = m_rutnuoc;
                    cmd.Parameters.Add("m_dichvamau", NpgsqlDbType.Numeric).Value = m_dichvamau;
                    cmd.Parameters.Add("m_cansloc", NpgsqlDbType.Numeric).Value = m_cansloc;
                    cmd.Parameters.Add("m_fav", NpgsqlDbType.Numeric).Value = m_fav;
                    cmd.Parameters.Add("m_ttmd", NpgsqlDbType.Numeric).Value = m_ttmd;
                    cmd.Parameters.Add("m_mtct", NpgsqlDbType.Numeric).Value = m_mtct;
                    cmd.Parameters.Add("m_tmdd", NpgsqlDbType.Numeric).Value = m_tmdd;
                    cmd.Parameters.Add("m_heparin", NpgsqlDbType.Numeric).Value = m_heparin;
                    cmd.Parameters.Add("m_tlpt", NpgsqlDbType.Numeric).Value = m_tlpt;
                    cmd.Parameters.Add("m_lieudau", NpgsqlDbType.Text, 20).Value = m_lieudau;
                    cmd.Parameters.Add("m_duytri", NpgsqlDbType.Text, 20).Value = m_duytri;
                    cmd.Parameters.Add("m_tonglieu", NpgsqlDbType.Text, 20).Value = m_tonglieu;
                    cmd.Parameters.Add("m_lientuc", NpgsqlDbType.Numeric).Value = m_lientuc;
                    cmd.Parameters.Add("m_cachquang", NpgsqlDbType.Numeric).Value = m_cachquang;
                    cmd.Parameters.Add("m_khac", NpgsqlDbType.Text, 100).Value = m_khac;
                    if (m_ngaykt.Trim() != "") cmd.Parameters.Add("m_ngaykt", NpgsqlDbType.Varchar, 16).Value = m_ngaykt.Trim();
                    cmd.Parameters.Add("m_mangloc", NpgsqlDbType.Text, 50).Value = m_mangloc;
                    cmd.Parameters.Add("m_nhanhieu", NpgsqlDbType.Text, 50).Value = m_nhanhieu;
                    cmd.Parameters.Add("m_dientich", NpgsqlDbType.Text, 50).Value = m_dientich;
                    cmd.Parameters.Add("m_heso", NpgsqlDbType.Text, 50).Value = m_heso;
                    cmd.Parameters.Add("m_baoquan", NpgsqlDbType.Text, 50).Value = m_baoquan;
                    cmd.Parameters.Add("m_landung", NpgsqlDbType.Numeric).Value = m_landung;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar, 4).Value = m_mabs;
                    cmd.Parameters.Add("m_yta", NpgsqlDbType.Varchar, 4).Value = m_yta;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ba_locmaull");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_bavv_mat(string m_ngay, decimal m_maql, string m_mpkk, string m_mtkk, string m_mpck,
            string m_mtck, string m_nhanapp, string m_nhanapt, string m_tt_mp, string m_tt_mt,
            byte[] m_hinh, string m_nhanxet, string m_chandoan)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".bavv_mat set tlkk_mp=:m_mpkk,tlkk_mt=:m_mtkk,tlck_mp=:m_mpck,tlck_mt=:m_mtck,";
            sql += "na_mp=:m_nhanapp,na_mt=:m_nhanapt,tt_mp=:m_tt_mp,tt_mt=:m_tt_mt,hinh=:m_hinh";
            sql += ",nhanxet=:m_nhanxet,chandoan=:m_chandoan ";
            sql += " where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mpkk", NpgsqlDbType.Text).Value = m_mpkk;
                cmd.Parameters.Add("m_mtkk", NpgsqlDbType.Text).Value = m_mtkk;
                cmd.Parameters.Add("m_mpck", NpgsqlDbType.Text).Value = m_mpck;
                cmd.Parameters.Add("m_mtck", NpgsqlDbType.Text).Value = m_mtck;
                cmd.Parameters.Add("m_nhanapp", NpgsqlDbType.Text).Value = m_nhanapp;
                cmd.Parameters.Add("m_nhanapt", NpgsqlDbType.Text).Value = m_nhanapt;
                cmd.Parameters.Add("m_tt_mp", NpgsqlDbType.Text).Value = m_tt_mp;
                cmd.Parameters.Add("m_tt_mt", NpgsqlDbType.Text).Value = m_tt_mt;
                cmd.Parameters.Add("m_hinh", NpgsqlDbType.Bytea).Value = m_hinh;
                cmd.Parameters.Add("m_nhanxet", NpgsqlDbType.Text).Value = m_nhanxet;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".bavv_mat(maql,tlkk_mp,tlkk_mt,tlck_mp,tlck_mt,na_mp,na_mt";
                    sql += ",tt_mp,tt_mt,hinh,nhanxet,chandoan)";
                    sql += " values (:m_maql,:m_mpkk,:m_mtkk,:m_mpck,:m_mtck,:m_nhanapp,:m_nhanapt";
                    sql += ",:m_tt_mp,:m_tt_mt,:m_hinh,:m_nhanxet,:m_chandoan)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_mpkk", NpgsqlDbType.Text).Value = m_mpkk;
                    cmd.Parameters.Add("m_mtkk", NpgsqlDbType.Text).Value = m_mtkk;
                    cmd.Parameters.Add("m_mpck", NpgsqlDbType.Text).Value = m_mpck;
                    cmd.Parameters.Add("m_mtck", NpgsqlDbType.Text).Value = m_mtck;
                    cmd.Parameters.Add("m_nhanapp", NpgsqlDbType.Text).Value = m_nhanapp;
                    cmd.Parameters.Add("m_nhanapt", NpgsqlDbType.Text).Value = m_nhanapt;
                    cmd.Parameters.Add("m_tt_mp", NpgsqlDbType.Text).Value = m_tt_mp;
                    cmd.Parameters.Add("m_tt_mt", NpgsqlDbType.Text).Value = m_tt_mt;
                    cmd.Parameters.Add("m_hinh", NpgsqlDbType.Bytea).Value = m_hinh;
                    cmd.Parameters.Add("m_nhanxet", NpgsqlDbType.Text).Value = m_nhanxet;
                    cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "bavv_mat " + m_maql.ToString());
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_bavv_mat(decimal m_maql, string m_ledao_mp, string m_mimat_mp, string m_ketmac_mp,
            string m_thmathot_mp, string m_giacmac_mp, string m_cungmac_mp, string m_tienphong_mp, string m_mongmat_mp,
            string m_dongtupxa_mp, string m_thuytinhthe_mp, string m_thuytinhdich_mp, string m_soianhdongtu_mp,
            string m_thnhancau_mp, string m_homat_mp, string m_daymat_mp, string m_ledao_mt, string m_mimat_mt, string m_ketmac_mt,
            string m_thmathot_mt, string m_giacmac_mt, string m_cungmac_mt, string m_tienphong_mt, string m_mongmat_mt,
            string m_dongtupxa_mt, string m_thuytinhthe_mt, string m_thuytinhdich_mt, string m_soianhdongtu_mt,
            string m_thnhancau_mt, string m_homat_mt, string m_daymat_mt)
        {
            sql = "update " + user + ".bavv_mat set ledao_mp=:m_ledao_mp,mimat_mp=:m_mimat_mp,ketmac_mp=:m_ketmac_mp";
            sql += ",thmathot_mp=:m_thmathot_mp,giacmac_mp=:m_giacmac_mp,cungmac_mp=:m_cungmac_mp,tienphong_mp=:m_tienphong_mp,";
            sql += "mongmat_mp=:m_mongmat_mp,dongtupxa_mp=:m_dongtupxa_mp,thuytinhthe_mp=:m_thuytinhthe_mp,thuytinhdich_mp=:m_thuytinhdich_mp,";
            sql += "soianhdongtu_mp=:m_soianhdongtu_mp,thnhancau_mp=:m_thnhancau_mp,homat_mp=:m_homat_mp,daymat_mp=:m_daymat_mp,";
            sql += "ledao_mt=:m_ledao_mt,mimat_mt=:m_mimat_mt,ketmac_mt=:m_ketmac_mt";
            sql += ",thmathot_mt=:m_thmathot_mt,giacmac_mt=:m_giacmac_mt,cungmac_mt=:m_cungmac_mt,tienphong_mt=:m_tienphong_mt,";
            sql += "mongmat_mt=:m_mongmat_mt,dongtupxa_mt=:m_dongtupxa_mt,thuytinhthe_mt=:m_thuytinhthe_mt,thuytinhdich_mt=:m_thuytinhdich_mt,";
            sql += "soianhdongtu_mt=:m_soianhdongtu_mt,thnhancau_mt=:m_thnhancau_mt,homat_mt=:m_homat_mt,daymat_mt=:m_daymat_mt ";
            sql += " where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ledao_mp", NpgsqlDbType.Text).Value = m_ledao_mp;
                cmd.Parameters.Add("m_mimat_mp", NpgsqlDbType.Text).Value = m_mimat_mp;
                cmd.Parameters.Add("m_ketmac_mp", NpgsqlDbType.Text).Value = m_ketmac_mp;
                cmd.Parameters.Add("m_thmathot_mp", NpgsqlDbType.Text).Value = m_thmathot_mp;
                cmd.Parameters.Add("m_giacmac_mp", NpgsqlDbType.Text).Value = m_giacmac_mp;
                cmd.Parameters.Add("m_cungmac_mp", NpgsqlDbType.Text).Value = m_cungmac_mp;
                cmd.Parameters.Add("m_tienphong_mp", NpgsqlDbType.Text).Value = m_tienphong_mp;
                cmd.Parameters.Add("m_mongmat_mp", NpgsqlDbType.Text).Value = m_mongmat_mp;
                cmd.Parameters.Add("m_dongtupxa_mp", NpgsqlDbType.Text).Value = m_dongtupxa_mp;
                cmd.Parameters.Add("m_thuytinhthe_mp", NpgsqlDbType.Text).Value = m_thuytinhthe_mp;
                cmd.Parameters.Add("m_thuytinhdich_mp", NpgsqlDbType.Text).Value = m_thuytinhdich_mp;
                cmd.Parameters.Add("m_soianhdongtu_mp", NpgsqlDbType.Text).Value = m_soianhdongtu_mp;
                cmd.Parameters.Add("m_thnhancau_mp", NpgsqlDbType.Text).Value = m_thnhancau_mp;
                cmd.Parameters.Add("m_homat_mp", NpgsqlDbType.Text).Value = m_homat_mp;
                cmd.Parameters.Add("m_daymat_mp", NpgsqlDbType.Text).Value = m_daymat_mp;
                cmd.Parameters.Add("m_ledao_mt", NpgsqlDbType.Text).Value = m_ledao_mt;
                cmd.Parameters.Add("m_mimat_mt", NpgsqlDbType.Text).Value = m_mimat_mt;
                cmd.Parameters.Add("m_ketmac_mt", NpgsqlDbType.Text).Value = m_ketmac_mt;
                cmd.Parameters.Add("m_thmathot_mt", NpgsqlDbType.Text).Value = m_thmathot_mt;
                cmd.Parameters.Add("m_giacmac_mt", NpgsqlDbType.Text).Value = m_giacmac_mt;
                cmd.Parameters.Add("m_cungmac_mt", NpgsqlDbType.Text).Value = m_cungmac_mt;
                cmd.Parameters.Add("m_tienphong_mt", NpgsqlDbType.Text).Value = m_tienphong_mt;
                cmd.Parameters.Add("m_mongmat_mt", NpgsqlDbType.Text).Value = m_mongmat_mt;
                cmd.Parameters.Add("m_dongtupxa_mt", NpgsqlDbType.Text).Value = m_dongtupxa_mt;
                cmd.Parameters.Add("m_thuytinhthe_mt", NpgsqlDbType.Text).Value = m_thuytinhthe_mt;
                cmd.Parameters.Add("m_thuytinhdich_mt", NpgsqlDbType.Text).Value = m_thuytinhdich_mt;
                cmd.Parameters.Add("m_soianhdongtu_mt", NpgsqlDbType.Text).Value = m_soianhdongtu_mt;
                cmd.Parameters.Add("m_thnhancau_mt", NpgsqlDbType.Text).Value = m_thnhancau_mt;
                cmd.Parameters.Add("m_homat_mt", NpgsqlDbType.Text).Value = m_homat_mt;
                cmd.Parameters.Add("m_daymat_mt", NpgsqlDbType.Text).Value = m_daymat_mt;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".bavv_mat(maql,ledao_mp,mimat_mp,ketmac_mp,thmathot_mp,giacmac_mp,";
                    sql += "cungmac_mp,tienphong_mp,mongmat_mp,dongtupxa_mp,thuytinhthe_mp,thuytinhdich_mp,";
                    sql += "soianhdongtu_mp,thnhancau_mp,homat_mp,daymat_mp,ledao_mt,mimat_mt,ketmac_mt";
                    sql += ",thmathot_mt,giacmac_mt,cungmac_mt,tienphong_mt,mongmat_mt,dongtupxa_mt,";
                    sql += "thuytinhthe_mt,thuytinhdich_mt,soianhdongtu_mt,thnhancau_mt,homat_mt,daymat_mt)";
                    sql += " values (:m_maql,:m_ledao_mp,:m_mimat_mp,:m_ketmac_mp,:m_thmathot_mp,:m_giacmac_mp,:m_cungmac_mp,";
                    sql += ":m_tienphong_mp,:m_mongmat_mp,:m_dongtupxa_mp,:m_thuytinhthe_mp,:m_thuytinhdich_mp,";
                    sql += ":m_soianhdongtu_mp,:m_thnhancau_mp,:m_homat_mp,:m_daymat_mp,:m_ledao_mt,:m_mimat_mt,";
                    sql += ":m_ketmac_mt,:m_thmathot_mt,:m_giacmac_mt,:m_cungmac_mt,:m_tienphong_mt,";
                    sql += ":m_mongmat_mt,:m_dongtupxa_mt,:m_thuytinhthe_mt,:m_thuytinhdich_mt,";
                    sql += ":m_soianhdongtu_mt,:m_thnhancau_mt,:m_homat_mt,:m_daymat_mt)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_ledao_mp", NpgsqlDbType.Text).Value = m_ledao_mp;
                    cmd.Parameters.Add("m_mimat_mp", NpgsqlDbType.Text).Value = m_mimat_mp;
                    cmd.Parameters.Add("m_ketmac_mp", NpgsqlDbType.Text).Value = m_ketmac_mp;
                    cmd.Parameters.Add("m_thmathot_mp", NpgsqlDbType.Text).Value = m_thmathot_mp;
                    cmd.Parameters.Add("m_giacmac_mp", NpgsqlDbType.Text).Value = m_giacmac_mp;
                    cmd.Parameters.Add("m_cungmac_mp", NpgsqlDbType.Text).Value = m_cungmac_mp;
                    cmd.Parameters.Add("m_tienphong_mp", NpgsqlDbType.Text).Value = m_tienphong_mp;
                    cmd.Parameters.Add("m_mongmat_mp", NpgsqlDbType.Text).Value = m_mongmat_mp;
                    cmd.Parameters.Add("m_dongtupxa_mp", NpgsqlDbType.Text).Value = m_dongtupxa_mp;
                    cmd.Parameters.Add("m_thuytinhthe_mp", NpgsqlDbType.Text).Value = m_thuytinhthe_mp;
                    cmd.Parameters.Add("m_thuytinhdich_mp", NpgsqlDbType.Text).Value = m_thuytinhdich_mp;
                    cmd.Parameters.Add("m_soianhdongtu_mp", NpgsqlDbType.Text).Value = m_soianhdongtu_mp;
                    cmd.Parameters.Add("m_thnhancau_mp", NpgsqlDbType.Text).Value = m_thnhancau_mp;
                    cmd.Parameters.Add("m_homat_mp", NpgsqlDbType.Text).Value = m_homat_mp;
                    cmd.Parameters.Add("m_daymat_mp", NpgsqlDbType.Text).Value = m_daymat_mp;
                    cmd.Parameters.Add("m_ledao_mt", NpgsqlDbType.Text).Value = m_ledao_mt;
                    cmd.Parameters.Add("m_mimat_mt", NpgsqlDbType.Text).Value = m_mimat_mt;
                    cmd.Parameters.Add("m_ketmac_mt", NpgsqlDbType.Text).Value = m_ketmac_mt;
                    cmd.Parameters.Add("m_thmathot_mt", NpgsqlDbType.Text).Value = m_thmathot_mt;
                    cmd.Parameters.Add("m_giacmac_mt", NpgsqlDbType.Text).Value = m_giacmac_mt;
                    cmd.Parameters.Add("m_cungmac_mt", NpgsqlDbType.Text).Value = m_cungmac_mt;
                    cmd.Parameters.Add("m_tienphong_mt", NpgsqlDbType.Text).Value = m_tienphong_mt;
                    cmd.Parameters.Add("m_mongmat_mt", NpgsqlDbType.Text).Value = m_mongmat_mt;
                    cmd.Parameters.Add("m_dongtupxa_mt", NpgsqlDbType.Text).Value = m_dongtupxa_mt;
                    cmd.Parameters.Add("m_thuytinhthe_mt", NpgsqlDbType.Text).Value = m_thuytinhthe_mt;
                    cmd.Parameters.Add("m_thuytinhdich_mt", NpgsqlDbType.Text).Value = m_thuytinhdich_mt;
                    cmd.Parameters.Add("m_soianhdongtu_mt", NpgsqlDbType.Text).Value = m_soianhdongtu_mt;
                    cmd.Parameters.Add("m_thnhancau_mt", NpgsqlDbType.Text).Value = m_thnhancau_mt;
                    cmd.Parameters.Add("m_homat_mt", NpgsqlDbType.Text).Value = m_homat_mt;
                    cmd.Parameters.Add("m_daymat_mt", NpgsqlDbType.Text).Value = m_daymat_mt;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "bavv_mat " + m_maql.ToString());
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_ttmat(decimal m_maql, string m_mp, string m_mt, string m_nhanapp, string m_nhanapt, string m_mpkk, string m_mtkk)
        {
            sql = "update " + user + ".ttmat set mp=:m_mp,mt=:m_mt,nhanapp=:m_nhanapp,nhanapt=:m_nhanapt,mpkk=:m_mpkk,mtkk=:m_mtkk";
            sql += " where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mp", NpgsqlDbType.Text).Value = m_mp;
                cmd.Parameters.Add("m_mt", NpgsqlDbType.Text).Value = m_mt;
                cmd.Parameters.Add("m_nhanapp", NpgsqlDbType.Text).Value = m_nhanapp;
                cmd.Parameters.Add("m_nhanapt", NpgsqlDbType.Text).Value = m_nhanapt;
                cmd.Parameters.Add("m_mpkk", NpgsqlDbType.Text).Value = m_mpkk;
                cmd.Parameters.Add("m_mtkk", NpgsqlDbType.Text).Value = m_mtkk;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".ttmat(maql,mp,mt,nhanapp,nhanapt,mpkk,mtkk) values (:m_maql,:m_mp,:m_mt,:m_nhanapp,:m_nhanapt,:m_mpkk,:m_mtkk)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_mp", NpgsqlDbType.Text).Value = m_mp;
                    cmd.Parameters.Add("m_mt", NpgsqlDbType.Text).Value = m_mt;
                    cmd.Parameters.Add("m_nhanapp", NpgsqlDbType.Text).Value = m_nhanapp;
                    cmd.Parameters.Add("m_nhanapt", NpgsqlDbType.Text).Value = m_nhanapt;
                    cmd.Parameters.Add("m_mpkk", NpgsqlDbType.Text).Value = m_mpkk;
                    cmd.Parameters.Add("m_mtkk", NpgsqlDbType.Text).Value = m_mtkk;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "ttmat " + m_maql.ToString());
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_khuyettat(decimal m_id, decimal m_maql, string m_mabn, string m_ngay, int m_id_dang, int m_id_mucdo
            , string m_chandoan, string m_ghichu)
        {
            sql = "update " + user + ".khuyettat set maql=:m_maql,mabn=:m_mabn,ngay=to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),";
            sql += "id_dang=:m_id_dang,id_mucdo=:m_id_mucdo,chandoan=:m_chandoan,ghichu=:m_ghichu where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar).Value = m_ngay;
                cmd.Parameters.Add("m_id_dang", NpgsqlDbType.Numeric).Value = m_id_dang;
                cmd.Parameters.Add("m_id_mucdo", NpgsqlDbType.Numeric).Value = m_id_mucdo;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text).Value = m_ghichu;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".khuyettat(id,maql,mabn,ngay,id_dang,id_mucdo,chandoan,ghichu)";
                    sql += " values (:m_id,:m_maql,:m_mabn,to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),:m_id_dang,:m_id_mucdo,";
                    sql += ":m_chandoan,:m_ghichu)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar).Value = m_ngay;
                    cmd.Parameters.Add("m_id_dang", NpgsqlDbType.Numeric).Value = m_id_dang;
                    cmd.Parameters.Add("m_id_mucdo", NpgsqlDbType.Numeric).Value = m_id_mucdo;
                    cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                    cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text).Value = m_ghichu;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "khuyettat");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_phanungthuoc_adr(decimal m_id, string m_mabn, decimal m_maql, decimal m_mavaovien, string m_msbcdonvi
           , string m_msbctt, double m_cannang, double m_chieucao, string m_ngayphanung, string m_motaphanung,
           string m_chandoandieutri, string m_taisudungthuoc, int m_trieuchungcu, string m_thuocsudungdongthoi,
           string m_benhsulienquan, int m_userid, string m_ngaybaocao, int m_dangbaocao, string m_xetnghiem, string m_tgxhpu, int m_mdopu, int m_kqxtpu)
        {
            sql = "update " + user + ".phanungthuoc_adr set mabn=:m_mabn,maql=:m_maql,mavaovien=:m_mavaovien,";
            sql += "msbcdonvi=:m_msbcdonvi,msbctt=:m_msbctt,cannang=:m_cannang,chieucao=:m_chieucao";
            sql += ",ngayphanung=to_date(:m_ngayphanung,'dd/mm/yyyy hh24:mi'),motaphanung=:m_motaphanung,";
            sql += "chandoandieutri=:m_chandoandieutri,taisudungthuoc=:m_taisudungthuoc,trieuchungcu=:m_trieuchungcu,";
            sql += "thuocsudungdongthoi=:m_thuocsudungdongthoi,benhsulienquan=:m_benhsulienquan,";
            sql += "ngaybaocao=to_date(:m_ngaybaocao,'dd/mm/yyyy hh24:mi'),dangbaocao=:m_dangbaocao,xetnghiem=:m_xetnghiem,thoigianxuathienphanung=:m_tgxhpu,mucdopu=:m_mdopu,kqxutripu=:m_kqxtpu ";
            sql += " where id=:m_id ";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                cmd.Parameters.Add("m_msbcdonvi", NpgsqlDbType.Varchar).Value = m_msbcdonvi;
                cmd.Parameters.Add("m_msbctt", NpgsqlDbType.Varchar).Value = m_msbctt;
                cmd.Parameters.Add("m_cannang", NpgsqlDbType.Numeric).Value = m_cannang;
                cmd.Parameters.Add("m_chieucao", NpgsqlDbType.Numeric).Value = m_chieucao;
                cmd.Parameters.Add("m_ngayphanung", NpgsqlDbType.Varchar).Value = m_ngayphanung;
                cmd.Parameters.Add("m_motaphanung", NpgsqlDbType.Text).Value = m_motaphanung;
                cmd.Parameters.Add("m_chandoandieutri", NpgsqlDbType.Text).Value = m_chandoandieutri;
                cmd.Parameters.Add("m_taisudungthuoc", NpgsqlDbType.Text).Value = m_taisudungthuoc;
                cmd.Parameters.Add("m_trieuchungcu", NpgsqlDbType.Numeric).Value = m_trieuchungcu;
                cmd.Parameters.Add("m_thuocsudungdongthoi", NpgsqlDbType.Text).Value = m_thuocsudungdongthoi;
                cmd.Parameters.Add("m_benhsulienquan", NpgsqlDbType.Text).Value = m_benhsulienquan;
                cmd.Parameters.Add("m_ngaybaocao", NpgsqlDbType.Varchar).Value = m_ngaybaocao;
                cmd.Parameters.Add("m_dangbaocao", NpgsqlDbType.Numeric).Value = m_dangbaocao;
                cmd.Parameters.Add("m_xetnghiem", NpgsqlDbType.Varchar).Value = m_xetnghiem;
                cmd.Parameters.Add("m_tgxhpu", NpgsqlDbType.Varchar).Value = m_tgxhpu;
                cmd.Parameters.Add("m_mdopu", NpgsqlDbType.Numeric).Value = m_mdopu;
                cmd.Parameters.Add("m_kqxtpu", NpgsqlDbType.Numeric).Value = m_kqxtpu;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".phanungthuoc_adr(id,mabn,maql,mavaovien,msbcdonvi,msbctt,";
                    sql += "cannang,chieucao,ngayphanung,motaphanung,chandoandieutri,taisudungthuoc,trieuchungcu,";
                    sql += "thuocsudungdongthoi,benhsulienquan,userid,ngayud,ngaybaocao,dangbaocao,xetnghiem,thoigianxuathienphanung,mucdopu,kqxutripu)";
                    sql += " values (:m_id,:m_mabn,:m_maql,:m_mavaovien,:m_msbcdonvi,:m_msbctt,:m_cannang,:m_chieucao";
                    sql += ",to_date(:m_ngayphanung,'dd/mm/yyyy hh24:mi'),:m_motaphanung,:m_chandoandieutri,";
                    sql += ":m_taisudungthuoc,:m_trieuchungcu,:m_thuocsudungdongthoi,:m_benhsulienquan,";
                    sql += ":m_userid,sysdate,to_date(:m_ngaybaocao,'dd/mm/yyyy hh24:mi'),:m_dangbaocao,:m_xetnghiem,:m_tgxhpu,:m_mdopu,:m_kqxtpu)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                    cmd.Parameters.Add("m_msbcdonvi", NpgsqlDbType.Varchar).Value = m_msbcdonvi;
                    cmd.Parameters.Add("m_msbctt", NpgsqlDbType.Varchar).Value = m_msbctt;
                    cmd.Parameters.Add("m_cannang", NpgsqlDbType.Numeric).Value = m_cannang;
                    cmd.Parameters.Add("m_chieucao", NpgsqlDbType.Numeric).Value = m_chieucao;
                    cmd.Parameters.Add("m_ngayphanung", NpgsqlDbType.Varchar).Value = m_ngayphanung;
                    cmd.Parameters.Add("m_motaphanung", NpgsqlDbType.Text).Value = m_motaphanung;
                    cmd.Parameters.Add("m_chandoandieutri", NpgsqlDbType.Text).Value = m_chandoandieutri;
                    cmd.Parameters.Add("m_taisudungthuoc", NpgsqlDbType.Text).Value = m_taisudungthuoc;
                    cmd.Parameters.Add("m_trieuchungcu", NpgsqlDbType.Numeric).Value = m_trieuchungcu;
                    cmd.Parameters.Add("m_thuocsudungdongthoi", NpgsqlDbType.Text).Value = m_thuocsudungdongthoi;
                    cmd.Parameters.Add("m_benhsulienquan", NpgsqlDbType.Text).Value = m_benhsulienquan;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    cmd.Parameters.Add("m_ngaybaocao", NpgsqlDbType.Varchar).Value = m_ngaybaocao;
                    cmd.Parameters.Add("m_dangbaocao", NpgsqlDbType.Numeric).Value = m_dangbaocao;
                    cmd.Parameters.Add("m_xetnghiem", NpgsqlDbType.Varchar).Value = m_xetnghiem;
                    cmd.Parameters.Add("m_tgxhpu", NpgsqlDbType.Varchar).Value = m_tgxhpu;
                    cmd.Parameters.Add("m_mdopu", NpgsqlDbType.Numeric).Value = m_mdopu;
                    cmd.Parameters.Add("m_kqxtpu", NpgsqlDbType.Numeric).Value = m_kqxtpu;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "phanungthuoc_adr");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_thuocnghingo_adr(decimal m_id, int m_stt, int m_mabd, string m_lieudungmotngay
            , int m_solantrongngay, string m_lydodungthuoc, string m_ngaybatdau, string m_ngayketthuc, string m_losx, int m_caithien, int m_taiphanung, int m_moilan, int m_userid)
        {
            sql = "update " + user + ".thuocnghingo_adr set mabd=:m_mabd,lieudungmotlan=:m_lieudungmotngay,";
            sql += "solantrongngay=:m_solantrongngay,lydodungthuoc =:m_lydodungthuoc,ngaybatdau=to_date(:m_ngaybatdau,'dd/mm/yyyy hh24:mi'),";
            sql += "ngayketthuc=to_date(:m_ngayketthuc,'dd/mm/yyyy hh24:mi'),losx=:m_losx,caithien=:m_caithien,taiphanung=:m_taiphanung,moilan=:m_moilan ";
            sql += " where id=:m_id and stt=:m_stt ";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabd", NpgsqlDbType.Numeric).Value = m_mabd;
                cmd.Parameters.Add("m_lieudungmotngay", NpgsqlDbType.Text).Value = m_lieudungmotngay;
                cmd.Parameters.Add("m_solantrongngay", NpgsqlDbType.Numeric).Value = m_solantrongngay;
                cmd.Parameters.Add("m_lydodungthuoc", NpgsqlDbType.Text).Value = m_lydodungthuoc;
                cmd.Parameters.Add("m_ngaybatdau", NpgsqlDbType.Varchar, 16).Value = m_ngaybatdau;
                if (m_ngayketthuc == "") cmd.Parameters.Add("m_ngayketthuc", NpgsqlDbType.Varchar, 16).Value = DBNull.Value;
                else cmd.Parameters.Add("m_ngayketthuc", NpgsqlDbType.Varchar, 16).Value = m_ngayketthuc;
                cmd.Parameters.Add("m_losx", NpgsqlDbType.Text).Value = m_losx;
                cmd.Parameters.Add("m_caithien", NpgsqlDbType.Numeric).Value = m_caithien;
                cmd.Parameters.Add("m_taiphanung", NpgsqlDbType.Numeric).Value = m_taiphanung;
                cmd.Parameters.Add("m_moilan", NpgsqlDbType.Numeric).Value = m_moilan;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".thuocnghingo_adr(id,stt,mabd,lieudungmotlan,solantrongngay,lydodungthuoc,";
                    sql += "ngaybatdau,ngayketthuc,losx,userid,ngayud,caithien,taiphanung,moilan)";
                    sql += " values (:m_id,:m_stt,:m_mabd,:m_lieudungmotngay,";
                    sql += ":m_solantrongngay,:m_lydodungthuoc,to_date(:m_ngaybatdau,'dd/mm/yyyy hh24:mi'),";
                    sql += "to_date(:m_ngayketthuc,'dd/mm/yyyy hh24:mi'),:m_losx,:m_userid,sysdate,:m_caithien,:m_taiphanung,:m_moilan)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_mabd", NpgsqlDbType.Numeric).Value = m_mabd;
                    cmd.Parameters.Add("m_lieudungmotngay", NpgsqlDbType.Text).Value = m_lieudungmotngay;
                    cmd.Parameters.Add("m_solantrongngay", NpgsqlDbType.Numeric).Value = m_solantrongngay;
                    cmd.Parameters.Add("m_lydodungthuoc", NpgsqlDbType.Text).Value = m_lydodungthuoc;
                    cmd.Parameters.Add("m_ngaybatdau", NpgsqlDbType.Varchar, 16).Value = m_ngaybatdau;
                    if (m_ngayketthuc == "") cmd.Parameters.Add("m_ngayketthuc", NpgsqlDbType.Varchar, 16).Value = DBNull.Value;
                    else cmd.Parameters.Add("m_ngayketthuc", NpgsqlDbType.Varchar, 16).Value = m_ngayketthuc;
                    cmd.Parameters.Add("m_losx", NpgsqlDbType.Text).Value = m_losx;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    cmd.Parameters.Add("m_caithien", NpgsqlDbType.Numeric).Value = m_caithien;
                    cmd.Parameters.Add("m_taiphanung", NpgsqlDbType.Numeric).Value = m_taiphanung;
                    cmd.Parameters.Add("m_moilan", NpgsqlDbType.Numeric).Value = m_moilan;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "thuocnghingo_adr");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_thuocsudungdongthoi(decimal m_id, int m_stt, int m_mabd, string m_ngaybatdau, string m_ngayketthuc, int m_userid)
        {
            sql = "update " + user + ".thuocsudungdongthoi set mabd=:m_mabd,";
            sql += "ngaybatdau=to_date(:m_ngaybatdau,'dd/mm/yyyy hh24:mi'),";
            sql += "ngayketthuc=to_date(:m_ngayketthuc,'dd/mm/yyyy hh24:mi') ";
            sql += " where id=:m_id and stt=:m_stt ";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabd", NpgsqlDbType.Numeric).Value = m_mabd;
                cmd.Parameters.Add("m_ngaybatdau", NpgsqlDbType.Varchar, 16).Value = m_ngaybatdau;
                if (m_ngayketthuc == "") cmd.Parameters.Add("m_ngayketthuc", NpgsqlDbType.Varchar, 16).Value = DBNull.Value;
                else cmd.Parameters.Add("m_ngayketthuc", NpgsqlDbType.Varchar, 16).Value = m_ngayketthuc;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".thuocsudungdongthoi(id,stt,mabd,";
                    sql += "ngaybatdau,ngayketthuc,userid,ngayud)";
                    sql += " values (:m_id,:m_stt,:m_mabd,";
                    sql += "to_date(:m_ngaybatdau,'dd/mm/yyyy hh24:mi'),";
                    sql += "to_date(:m_ngayketthuc,'dd/mm/yyyy hh24:mi'),:m_userid,sysdate)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_mabd", NpgsqlDbType.Numeric).Value = m_mabd;
                    cmd.Parameters.Add("m_ngaybatdau", NpgsqlDbType.Varchar, 16).Value = m_ngaybatdau;
                    if (m_ngayketthuc == "") cmd.Parameters.Add("m_ngayketthuc", NpgsqlDbType.Varchar, 16).Value = DBNull.Value;
                    else cmd.Parameters.Add("m_ngayketthuc", NpgsqlDbType.Varchar, 16).Value = m_ngayketthuc;

                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "thuocsudungdongthoi");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_xutri_adr(decimal m_id, string m_ngungdungthuoc, int m_ngung_tientrien, int m_ngung_dieutri
            , string m_sudungthuockhac, int m_sudung_tientrien, int m_sudung_dieutri, int m_ketquaxutriadr,
            string m_bsbinhluan, int m_thamdinhadr_dvyte, string m_thangthamdinhadr_chuyengia, string m_ykienchuyengia,
            int m_userid)
        {
            sql = "update " + user + ".xutri_adr set ngungdungthuoc=:m_ngungdungthuoc,ngung_tientrien=:m_ngung_tientrien,";
            sql += "ngung_dieutri=:m_ngung_dieutri,sudungthuockhac=:m_sudungthuockhac,sudung_tientrien=:m_sudung_tientrien,";
            sql += "sudung_dieutri=:m_sudung_dieutri,ketquaxutriadr=:m_ketquaxutriadr,bsbinhluan=:m_bsbinhluan,";
            sql += "thamdinhadr_dvyte=:m_thamdinhadr_dvyte,thangthamdinhadr_chuyengia=:m_thangthamdinhadr_chuyengia,";
            sql += "ykienchuyengia=:m_ykienchuyengia ";
            sql += " where id=:m_id ";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngungdungthuoc", NpgsqlDbType.Varchar).Value = m_ngungdungthuoc;
                cmd.Parameters.Add("m_ngung_tientrien", NpgsqlDbType.Varchar).Value = m_ngung_tientrien;
                cmd.Parameters.Add("m_ngung_dieutri", NpgsqlDbType.Numeric).Value = m_ngung_dieutri;
                cmd.Parameters.Add("m_sudungthuockhac", NpgsqlDbType.Text).Value = m_sudungthuockhac;
                cmd.Parameters.Add("m_sudung_tientrien", NpgsqlDbType.Numeric).Value = m_sudung_tientrien;
                cmd.Parameters.Add("m_sudung_dieutri", NpgsqlDbType.Numeric).Value = m_sudung_dieutri;
                cmd.Parameters.Add("m_ketquaxutriadr", NpgsqlDbType.Numeric).Value = m_ketquaxutriadr;
                cmd.Parameters.Add("m_bsbinhluan", NpgsqlDbType.Text).Value = m_bsbinhluan;
                cmd.Parameters.Add("m_thamdinhadr_dvyte", NpgsqlDbType.Numeric).Value = m_thamdinhadr_dvyte;
                cmd.Parameters.Add("m_thangthamdinhadr_chuyengia", NpgsqlDbType.Text).Value = m_thangthamdinhadr_chuyengia;
                cmd.Parameters.Add("m_ykienchuyengia", NpgsqlDbType.Text).Value = m_ykienchuyengia;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".xutri_adr(id,ngungdungthuoc,ngung_tientrien,ngung_dieutri,";
                    sql += "sudungthuockhac,sudung_tientrien,sudung_dieutri,ketquaxutriadr,bsbinhluan,";
                    sql += "thamdinhadr_dvyte,thangthamdinhadr_chuyengia,ykienchuyengia)";
                    sql += " values (:m_id,:m_ngungdungthuoc,:m_ngung_tientrien,:m_ngung_dieutri,";
                    sql += ":m_sudungthuockhac,:m_sudung_tientrien,:m_sudung_dieutri,:m_ketquaxutriadr,:m_bsbinhluan,";
                    sql += ":m_thamdinhadr_dvyte,:m_thangthamdinhadr_chuyengia,:m_ykienchuyengia)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ngungdungthuoc", NpgsqlDbType.Varchar).Value = m_ngungdungthuoc;
                    cmd.Parameters.Add("m_ngung_tientrien", NpgsqlDbType.Numeric).Value = m_ngung_tientrien;
                    cmd.Parameters.Add("m_ngung_dieutri", NpgsqlDbType.Numeric).Value = m_ngung_dieutri;
                    cmd.Parameters.Add("m_sudungthuockhac", NpgsqlDbType.Text).Value = m_sudungthuockhac;
                    cmd.Parameters.Add("m_sudung_tientrien", NpgsqlDbType.Numeric).Value = m_sudung_tientrien;
                    cmd.Parameters.Add("m_sudung_dieutri", NpgsqlDbType.Numeric).Value = m_sudung_dieutri;
                    cmd.Parameters.Add("m_ketquaxutriadr", NpgsqlDbType.Numeric).Value = m_ketquaxutriadr;
                    cmd.Parameters.Add("m_bsbinhluan", NpgsqlDbType.Text).Value = m_bsbinhluan;
                    cmd.Parameters.Add("m_thamdinhadr_dvyte", NpgsqlDbType.Numeric).Value = m_thamdinhadr_dvyte;
                    cmd.Parameters.Add("m_thangthamdinhadr_chuyengia", NpgsqlDbType.Text).Value = m_thangthamdinhadr_chuyengia;
                    cmd.Parameters.Add("m_ykienchuyengia", NpgsqlDbType.Text).Value = m_ykienchuyengia;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "khuyettat");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public void f_tangid_medibv()
        {
            string sql = "select 'alter table '||table_schema||'.'||table_name|| ' alter column '||column_name||' type numeric;' as ten from information_schema.columns  where table_catalog='" + database + "' and table_schema='medibv' and numeric_precision=18 and numeric_scale=0 ";
            DataSet lds = get_data(sql);
            lds.WriteXml("..//tangid.xml", XmlWriteMode.WriteSchema);

            if (System.IO.File.Exists("..//tangid.xml"))
            {
                ds = new DataSet();
                ds.ReadXml("..//tangid.xml");


                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                con.Open();
                foreach (DataRow r in ds.Tables[0].Rows)
                {
                    sql = r["ten"].ToString().Trim();
                    try
                    {
                        cmd = new NpgsqlCommand(sql, con);
                        cmd.CommandType = CommandType.Text;
                        cmd.ExecuteNonQuery();
                        cmd.Dispose();
                    }
                    catch
                    {
                        cmd.Dispose(); //con.Close(); con.Dispose(); 
                    }
                }
                con.Close(); con.Dispose();
                if (bQuanly_theokhu || bQuanly_Theo_Chinhanh)
                {
                    if (ds.Tables[0].Rows.Count > 0)
                    {
                        //
                        sql = "alter table " + user + ".v_giavp alter column id numeric(10) "; execute_data(sql, false);
                        sql = "alter table " + user + ".v_giavp_luu alter column id numeric(10) "; execute_data(sql, false);
                        sql = "alter table " + user + ".d_dmbd_luu alter column id numeric(10) "; execute_data(sql, false);
                        sql = "alter table " + user + ".v_giavp alter column id numeric(10) "; execute_data(sql, false);
                        //
                    }
                }
            }
            if (bQuanly_Theo_Chinhanh || bQuanly_theokhu)
            {
                sql = "select 'alter table '||table_schema||'.'||table_name|| ' alter column '||column_name||' type numeric(10);' as ten from information_schema.columns  where table_catalog='" + database + "' and table_schema='medibv' and numeric_precision=7 and column_name in('mavp','mavptk','mabd') and numeric_scale=0 ";
                lds = get_data(sql);
                lds.WriteXml("..//tangid.xml", XmlWriteMode.WriteSchema);

                if (System.IO.File.Exists("..//tangid.xml"))
                {
                    ds.ReadXml("..//tangid.xml");
                    if (con != null)
                    {
                        con.Close(); con.Dispose();
                    }
                    con = new NpgsqlConnection(sConn);
                    con.Open();
                    foreach (DataRow r in ds.Tables[0].Rows)
                    {
                        sql = r["ten"].ToString().Trim();

                        try
                        {

                            cmd = new NpgsqlCommand(sql, con);
                            cmd.CommandType = CommandType.Text;
                            cmd.ExecuteNonQuery();
                            cmd.Dispose();

                        }
                        catch { cmd.Dispose(); }
                    }
                    con.Close(); con.Dispose();
                }
            }
        }
        public void f_tangid_medibv_mmyy(string m_mmyy)
        {
            string sql = "select 'alter table '||table_schema||'.'||table_name|| ' alter column '||column_name||' type numeric;' as ten from information_schema.columns  where table_catalog='" + database + "' and table_schema='medibv" + m_mmyy + "' and numeric_precision=18 and numeric_scale=0 ";
            DataSet lds = get_data(sql);
            if (System.IO.File.Exists("..//tangid.xml")) System.IO.File.Delete("..//tangid.xml");
            lds.WriteXml("..//tangid.xml", XmlWriteMode.WriteSchema);
            if (System.IO.File.Exists("..//tangid.xml"))
            {
                ds = new DataSet();
                ds.ReadXml("..//tangid.xml");
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                con.Open();
                foreach (DataRow r in ds.Tables[0].Rows)
                {
                    sql = r["ten"].ToString().Trim();
                    try
                    {
                        cmd = new NpgsqlCommand(sql, con);
                        cmd.CommandType = CommandType.Text;
                        cmd.ExecuteNonQuery();
                        cmd.Dispose();

                    }
                    catch { cmd.Dispose(); }
                }
                con.Close(); con.Dispose();
            }
            //
            if (bQuanly_theokhu || bQuanly_Theo_Chinhanh)
            {
                sql = "select 'alter table '||table_schema||'.'||table_name|| ' alter column '||column_name||' type numeric(10);' as ten from information_schema.columns  where table_catalog='" + database + "' and table_schema='medibv" + m_mmyy + "' and numeric_precision=7 and column_name in('mavp','mavptk','mabd') and numeric_scale=0 ";
                lds = get_data(sql);
                lds.WriteXml("..//tangid.xml", XmlWriteMode.WriteSchema);

                if (System.IO.File.Exists("..//tangid.xml"))
                {
                    ds.ReadXml("..//tangid.xml");
                    if (con != null)
                    {
                        con.Close(); con.Dispose();
                    }
                    con = new NpgsqlConnection(sConn);
                    con.Open();
                    foreach (DataRow r in ds.Tables[0].Rows)
                    {
                        sql = r["ten"].ToString().Trim();

                        try
                        {
                            cmd = new NpgsqlCommand(sql, con);
                            cmd.CommandType = CommandType.Text;
                            cmd.ExecuteNonQuery();
                            cmd.Dispose();

                        }
                        catch { cmd.Dispose(); }
                    }
                    con.Close(); con.Dispose();
                }
            }
        }
        public void f_tangmakp_3kytu()
        {
            string sql = " select 'alter table '||table_schema||'.'||table_name|| ' alter column '||column_name||' type varchar(3);' as ten from information_schema.columns  where table_catalog='" + database + "' and table_schema='medibv'  and column_name='makp' and data_type='character varying' and character_maximum_length=2 ";
            DataSet lds = get_data(sql);
            lds.WriteXml("..//tangid.xml", XmlWriteMode.WriteSchema);

            if (System.IO.File.Exists("..//tangid.xml"))
            {
                ds = new DataSet();
                ds.ReadXml("..//tangid.xml");
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                con.Open();

                foreach (DataRow r in ds.Tables[0].Rows)
                {
                    sql = r["ten"].ToString().Trim();

                    try
                    {

                        cmd = new NpgsqlCommand(sql, con);
                        cmd.CommandType = CommandType.Text;
                        cmd.ExecuteNonQuery();
                        cmd.Dispose();

                    }
                    catch { cmd.Dispose(); }
                }
                con.Close(); con.Dispose();
            }
        }
        public void f_tangmakp_3kytu(string mmyy)
        {
            string sql = " select 'alter table '||table_schema||'.'||table_name|| ' alter column '||column_name||' type varchar(3);' as ten from information_schema.columns  where table_catalog='" + database + "' and table_schema='medibv" + mmyy + "'  and column_name='makp' and data_type='character varying' and character_maximum_length=2 ";
            DataSet lds = get_data(sql);
            lds.WriteXml("..//tangid.xml", XmlWriteMode.WriteSchema);

            if (System.IO.File.Exists("..//tangid.xml"))
            {
                ds = new DataSet();
                ds.ReadXml("..//tangid.xml");
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                con.Open();

                foreach (DataRow r in ds.Tables[0].Rows)
                {
                    sql = r["ten"].ToString().Trim();

                    try
                    {
                        cmd = new NpgsqlCommand(sql, con);
                        cmd.CommandType = CommandType.Text;
                        cmd.ExecuteNonQuery();
                        cmd.Dispose();

                    }
                    catch { cmd.Dispose(); }
                }
                con.Close(); con.Dispose();
            }
        }

        public void f_tangmakho_6so(string mmyy)
        {
            string sql = " select 'alter table '||table_schema||'.'||table_name|| ' alter column '||column_name||' type numeric(6);' as ten from information_schema.columns  where table_catalog='" + database + "' and table_schema='medibv" + mmyy + "'  and column_name in('makp','makhoa', 'makho', 'khon','khox') and numeric_precision=3 and numeric_scale=0 ";
            DataSet lds = get_data(sql);
            lds.WriteXml("..//tangid.xml", XmlWriteMode.WriteSchema);

            if (System.IO.File.Exists("..//tangid.xml"))
            {
                ds = new DataSet();
                ds.ReadXml("..//tangid.xml");
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                con.Open();

                foreach (DataRow r in ds.Tables[0].Rows)
                {
                    sql = r["ten"].ToString().Trim();

                    try
                    {
                        cmd = new NpgsqlCommand(sql, con);
                        cmd.CommandType = CommandType.Text;
                        cmd.ExecuteNonQuery();
                        cmd.Dispose();

                    }
                    catch { cmd.Dispose(); }
                }
                con.Close(); con.Dispose();
            }
        }
        public void f_tangmabv_9kytu()
        {
            string sql = " select 'alter table '||table_schema||'.'||table_name|| ' alter column '||column_name||' type varchar(9);' as ten from information_schema.columns  where table_catalog='" + database + "' and table_schema='medibv'  and column_name='mabv' and data_type='character varying' and character_maximum_length=8 ";
            DataSet lds = get_data(sql);
            lds.WriteXml("..//tangid.xml", XmlWriteMode.WriteSchema);

            if (System.IO.File.Exists("..//tangid.xml"))
            {
                ds = new DataSet();
                ds.ReadXml("..//tangid.xml");
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                con.Open();
                foreach (DataRow r in ds.Tables[0].Rows)
                {
                    sql = r["ten"].ToString().Trim();

                    try
                    {

                        cmd = new NpgsqlCommand(sql, con);
                        cmd.CommandType = CommandType.Text;
                        cmd.ExecuteNonQuery();
                        cmd.Dispose();

                    }
                    catch { cmd.Dispose(); }
                }
                con.Close(); con.Dispose();
            }
        }
        public void f_tangmabv_9kytu(string m_mmyy)
        {
            string sql = " select 'alter table '||table_schema||'.'||table_name|| ' alter column '||column_name||' type varchar(9);' as ten from information_schema.columns  where table_catalog='" + database + "' and table_schema='medibv" + m_mmyy + "'  and column_name='mabv' and data_type='character varying' and character_maximum_length=8 ";
            DataSet lds = get_data(sql);
            lds.WriteXml("..//tangid.xml", XmlWriteMode.WriteSchema);

            if (System.IO.File.Exists("..//tangid.xml"))
            {
                ds = new DataSet();
                ds.ReadXml("..//tangid.xml");
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                con.Open();
                foreach (DataRow r in ds.Tables[0].Rows)
                {
                    sql = r["ten"].ToString().Trim();
                    try
                    {
                        cmd = new NpgsqlCommand(sql, con);
                        cmd.CommandType = CommandType.Text;
                        cmd.ExecuteNonQuery();
                        cmd.Dispose();
                    }
                    catch { cmd.Dispose(); }
                }
                con.Close(); con.Dispose();
            }
        }
        public void f_capnhat_db_danhmuc(string tenfile)
        {
            string s_user = user;
            //
            DataSet lds = new DataSet();
            string asql = "";
            string s_gio_modify = Ngaygio_hienhanh;
            string s_mmyy = mmyy(ngayhienhanh_server);
            try
            {
                s_gio_modify = System.IO.File.GetLastWriteTime(tenfile).ToString("dd/MM/yyyy HH:mm");
            }
            catch { s_gio_modify = Ngaygio_hienhanh; }
            asql = "select ngaygio from " + s_user + ".datao where to_char(ngaygio,'dd/mm/yyyy hh24:mi')='" + s_gio_modify + "'";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = " drop table " + s_user + ".datao ";
                execute_data(asql, false);
                asql = " create table " + s_user + ".datao (ngaygio timestamp, constraint pk_datao primary key (ngaygio) USING INDEX TABLESPACE medi_index)  WITH OIDS ";
                execute_data(asql, false);
            }
            else if (lds.Tables[0].Rows.Count > 0) return;
            asql = "insert into " + s_user + ".datao (ngaygio) values (to_date('" + s_gio_modify + "','dd/mm/yyyy hh24:mi'))";
            execute_data(asql, false);
            //
            f_kiemtra_idduoc_idgiavp();//
            //
            asql = "select sothe from " + s_user + ".v_giavp where id=0";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = " alter table " + s_user + ".v_giavp add sothe varchar(100) ";
                execute_data(asql, false);
            }

            asql = "select kcct, tuyentw, tuyentinh, tuyenhuyen, tuyenxa from " + s_user + ".v_giavp where id=0";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = " alter table " + s_user + ".v_giavp add kcct numeric(1) default 0";
                execute_data(asql, false);
                asql = " alter table " + s_user + ".v_giavp add tuyentw numeric(1) default 0";
                execute_data(asql, false);
                asql = " alter table " + s_user + ".v_giavp add tuyentinh numeric(1) default 0";
                execute_data(asql, false);
                asql = " alter table " + s_user + ".v_giavp add tuyenhuyen numeric(1) default 0";
                execute_data(asql, false);
                asql = " alter table " + s_user + ".v_giavp add tuyenxa numeric(1) default 0";
                execute_data(asql, false);
            }


            asql = "select hide from " + s_user + ".dmnoicapbhyt where 1=2";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                sql = "alter table " + s_user + ".dmnoicapbhyt add hide numeric(1) default 0";
                execute_data(sql, false);
            }
            asql = "select hide from " + s_user + ".dstt where 1=2";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = "alter table " + s_user + ".dstt add hide numeric(1) default 0";
                execute_data(asql, false);
            }
            asql = "select paid from " + s_user + ".xuatvien where maql=0";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = "alter table " + s_user + ".xuatvien add paid numeric(1) default 0";
                execute_data(asql, false);
            }

            asql = "select tuchoi from " + user + ".benhandt where 1=2";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = "alter table " + user + ".benhandt add tuchoi numeric(1) default 0";
                execute_data(asql, false);
            }
            asql = "select bhyt_tt from " + s_user + ".v_giavp where id=0";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = " alter table " + s_user + ".v_giavp add bhyt_tt numeric(5,2) default 0 ";
                execute_data(asql, false);

                asql = " update " + s_user + ".v_giavp set bhyt_tt=bhyt ";
                execute_data(asql, false);
            }
            asql = "select hide from " + s_user + ".icd10 where id=0";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = " alter table " + s_user + ".icd10 add hide numeric(1) default 0 ";
                execute_data(asql, false);
            }
            asql = "select yeucau from " + s_user + ".chuyenvien where maql=0";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = " alter table " + s_user + ".chuyenvien add yeucau numeric(1) default 0 ";
                execute_data(asql, false);
            }

            asql = "select thanhthi from " + s_user + ".btdpxa where 1=2";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = " alter table " + s_user + ".btdpxa add thanhthi numeric(1) default 1 ";
                execute_data(asql, false);
            }
            asql = "select mabn from " + s_user + ".datgiuong where 1=2";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = " create table " + s_user + ".datgiuong (MABN varchar(" + i_maxlength_mabn.ToString() + "), NGAY timestamp, IDGIUONG numeric(10), DEN timestamp, GHICHU text, USERID numeric(7) default 0, NGAYUD timestamp default now(), constraint pk_datgiuong primary key (mabn, ngay, idgiuong) USING INDEX TABLESPACE medi_index)  WITH OIDS ";
                execute_data(asql, false);
            }
            asql = "select mabn from " + s_user + ".sophieurv where 1=2";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                sql = "create table " + s_user + ".sophieurv(mabn varchar(" + i_maxlength_mabn.ToString() + "),maql numeric,loaiba numeric(1),ngay timestamp,madoituong numeric(2),so numeric(5) default 0,lanin numeric(5) default 1,ghichu text,constraint pk_sophieurv primary key(maql,ngay)) with oids";
                execute_data(sql, false);
            }
            asql = "select stt from " + s_user + ".capmabns where 1=2";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                sql = "create table " + s_user + ".capmabns(yy numeric(2),stt numeric(6),loai numeric(1),userid numeric(5),computer numeric(5),constraint pk_capmabns primary key(yy, loai, userid, computer)) with oids";
                execute_data(sql, false);
            }
            sql = "select ketoa from " + user + ".d_dmbd where 1=2";
            lds = get_data(sql);
            if (lds == null || lds.Tables.Count <= 0)
            {
                sql = "alter table " + user + ".d_dmbd add ketoa numeric(1) default 1";
                execute_data(sql);
            }
            asql = "select giuongthem from " + s_user + ".theodoigiuong where id=0";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                sql = "alter table " + user + ".theodoigiuong add giuongthem numeric(1) default 0";
                execute_data(sql);
            }
            asql = "select id from " + s_user + ".dmkhudt where id=0";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                sql = "create table " + user + ".dmkhudt (id numeric(3), ten text,constraint pk_dmkhudt primary key(id)) with oids";
                execute_data(sql);
            }
            asql = "select khu from " + s_user + ".dlogin where id=0";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                sql = "alter table " + user + ".dlogin add khu varchar(100)";
                execute_data(sql);
            }
            asql = "select khu from " + s_user + ".btdkp_bv where makp='???'";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                sql = "alter table " + user + ".btdkp_bv add khu numeric(3) default 0";
                execute_data(sql);
                sql = "alter table " + user + ".btdkp_add add khu numeric(3) default 0";
                execute_data(sql);
            }
            asql = "select khu from " + s_user + ".d_duockp where makp='???'";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                sql = "alter table " + user + ".d_duockp add khu numeric(3) default 0";
                execute_data(sql);
            }

            asql = "alter table " + user + ".d_dmnhom add loaivp numeric(7) default 0";
            execute_data(asql, false);

            asql = "select mathoidiemdung from " + user + ".d_dmbd where 1=2";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = "alter table " + user + ".d_dmbd add mathoidiemdung numeric(7) default 0";
                execute_data(asql, false);
            }
            asql = "select id from " + user + ".d_dmthoidiemdung where 1=2";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = "create table " + user + ".d_dmthoidiemdung (id numeric(3), ten text, nhom numeric(3) default 0, stt numeric (3) default 0, ngayud timestamp DEFAULT now(), readonly numeric (1) default 0, CONSTRAINT pk_d_dmthoidiemdung primary key (id) using INDEX TABLESPACE medi_index) WITH OIDS ";
                execute_data(asql, false);
            }

            asql = "select bhyt_tt from " + user + ".v_giavp where 1=2";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = "alter table " + user + ".v_giavp add bhyt_tt numeric(5,2) default 0";
                execute_data(asql, false);
            }
            asql = "select mmyy from " + user + ".d_taosolieu where 1=2";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = "create table " + user + ".d_taosolieu (nhom numeric(5), mmyy varchar(4), userid numeric(7), ngayud timestamp default now(), constraint pk_taosolieu primary key (nhom, mmyy) )";
                execute_data(asql, false);
            }

            asql = "select ketoa from " + user + ".d_dmbd where 1=2";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = "alter table " + user + ".d_dmbd add ketoa numeric(1) default 1";
                execute_data(asql, false);
            }

            asql = "select id from " + user + ".dmkhudt where id=0";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = "create table " + user + ".dmkhudt (id numeric(3), ten text,constraint pk_dmkhudt primary key(id)) with oids";
                execute_data(asql, false);
            }
            asql = "select khu from " + user + ".d_dlogin where id=0";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = "alter table " + user + ".d_dlogin add khu varchar(100)";
                execute_data(asql, false);
            }
            asql = "select khu from " + user + ".d_duockp where 1=2";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = "alter table " + user + ".d_duockp add khu numeric(3) default 0";
                execute_data(asql, false);
            }
            asql = "select khu from " + user + ".btdkp_bv where 1=2";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = "alter table " + user + ".btdkp_bv add khu numeric(3) default 0";
                execute_data(asql, false);
            }
            asql = "select khu from " + user + ".d_dmkho where id=0";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = "alter table " + user + ".d_dmkho add khu numeric(3) default 0";
                execute_data(asql, false);
            }


            asql = "select sothe from " + s_user + ".d_dmbd where id=0";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = " alter table " + s_user + ".d_dmbd add sothe varchar(100) ";
                execute_data(asql, false);
            }

            asql = "select bhyt_tt from " + s_user + ".v_giavp where id=0";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = " alter table " + s_user + ".v_giavp add bhyt_tt numeric(5,2) default 0 ";
                execute_data(asql, false);

                asql = " update " + s_user + ".v_giavp set bhyt_tt=bhyt ";
                execute_data(asql, false);
            }

            asql = "select iddot from " + s_user + ".v_giavp_khuyenmai where 1=2";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                execute_data("CREATE table " + s_user + ".v_dot_khuyenmai (id numeric(7), ten text, userid number(7) default 0, tungay timestamp DEFAULT now(), denngay timestamp DEFAULT now(), tugio varchar(5), dengio varchar(5), hide number(1) default 0, ngayud timestamp DEFAULT now(),CONSTRAINT pk_v_dot_khuyenmai PRIMARY KEY (id) USING INDEX TABLESPACE medi_index)");
                execute_data("CREATE table " + s_user + ".v_giavp_khuyenmai (iddot numeric(7), idvp number(7), tylekhuyenmai numeric(5,2), default 0, sotienkhuyenmai  numeric(15,4), userid number(7) default 0, ngayud timestamp DEFAULT now(),CONSTRAINT pk_v_giavp_khuyenmai PRIMARY KEY (iddot, idvp) USING INDEX TABLESPACE medi_index)");
            }
            asql = "select theogio from " + s_user + ".v_dot_khuyenmai where id=0";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = " alter table " + s_user + ".v_dot_khuyenmai theogio bhyt_tt numeric(1) default 0 ";
                execute_data(asql, false);
            }

            asql = "select maloai_bc from " + s_user + ".v_giavp where id=0";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = "alter table " + s_user + ".v_giavp add maloai_bc numeric(3) default 0";
                execute_data(asql, false);
            }
            asql = "select khudt from " + s_user + ".v_giavp where id=0";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = "alter table " + s_user + ".v_giavp add khudt numeric(3) default 0";
                execute_data(asql, false);
            }
            asql = "select khudt from " + s_user + ".v_dlogin where id=0";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = "alter table " + s_user + ".v_dlogin add khudt varchar(100) default 0";
                execute_data(asql, false);
            }
            asql = "select khudt from " + s_user + ".v_quyenso where id=0";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = "alter table " + s_user + ".v_quyenso add khudt numeric(3) default 0";
                execute_data(asql, false);
            }
            // gam 10-05-2011
            asql = "select dichvu from " + s_user + ".v_quyenso where id=0";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = "alter table " + s_user + ".v_quyenso add dichvu numeric(1) default 0";
                execute_data(asql, false);
            }
            asql = "select dichvu from " + s_user + ".v_giavp where id=0";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = "alter table " + s_user + ".v_giavp add dichvu numeric(1) default 0";
                execute_data(asql, false);
            }

            //Khuong 19/05/2011
            asql = "select cmnd from " + s_user + ".btdbn where 1=2";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = "alter table " + s_user + ".btdbn add cmnd character varying(20)";
                execute_data(asql, false);
            }
            asql = "select msthue from " + s_user + ".btdbn where 1=2";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = "alter table " + s_user + ".btdbn add msthue character varying(20)";
                execute_data(asql, false);
            }

            asql = "select ma from " + s_user + ".atc_generic where 1=2";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = " CREATE TABLE " + s_user + ".atc_generic (ma varchar(6) NOT NULL, atc_code varchar(7) NOT NULL, generic_e text, ten text, adm text, hamluong varchar(20), comments text, nhom varchar(100), userid varchar(10), readonly numeric(2), indications text, chidinh text, dosage text, lieudung text, contraindications text, chongchidinh text, specialprecaution text, luuy text, adversereaction text, tacdungphu text, druginteractions text, tuongtac text, ngayud timestamp DEFAULT now(), CONSTRAINT pk_atc_generic PRIMARY KEY (ma) )WITHOUT OIDS; ALTER TABLE " + s_user + ".atc_generic OWNER TO medisoft;";
                execute_data(asql, false);

            }
            asql = "select id from " + s_user + ".dmchinhanh where 1=2";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = "create table " + s_user + ".dmchinhanh(id numeric(2),ten text,database text,ip varchar(25),trungtam numeric(1) default 0, viettat varchar(50),CONSTRAINT pk_dmchinhanh PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS; ALTER TABLE " + s_user + ".dmchinhanh OWNER TO medisoft;";
                execute_data(asql, false);

            }
            asql = "select trungtam, viettat from " + s_user + ".dmchinhanh where 1=2";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                execute_data("alter table " + s_user + ".dmchinhanh add trungtam numeric(1) default 0;");
                execute_data("alter table " + s_user + ".dmchinhanh add viettat text;");
            }
            //
            asql = "select mach from " + s_user + ".dmgiatribt where 1=2";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = "CREATE TABLE " + s_user + ".dmgiatribt(id numeric(5) NOT NULL, mach varchar(15), nhietdo varchar(15), huyetap varchar(15), nhiptho varchar(15), cannang varchar(15), chieucao varchar(15), ngayud timestamp DEFAULT now(), CONSTRAINT pk_dmgiatribt PRIMARY KEY (id))WITH OIDS;ALTER TABLE " + s_user + ".dmgiatribt OWNER TO medisoft;";
                execute_data(asql, false);
            }
            asql = "select id from " + s_user + ".dmbophan_hoichan where 1=2";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {

                asql = " CREATE TABLE " + s_user + ".dmbophan_hoichan(id numeric(5,0) not null,ten character varying(250),";
                asql += " CONSTRAINT pk_dmbophan_hoichan PRIMARY KEY (id))WITH OIDS;";
                asql += "ALTER TABLE " + s_user + ".dmbophan_hoichan OWNER TO medisoft;";
                execute_data(asql, false);
            }
            asql = "select id from " + s_user + ".hoichan_cdha where 1=2";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = "CREATE TABLE  " + s_user + ".hoichan_cdha (id numeric(22,0) not null,mabn character varying(10),mavaovien numeric(22,0),maql numeric(22,0),ngayhoichan timestamp,lamsang text,chandoan text,xquang text,sieuam text,xetnghiem text,";
                asql += "sdthuoccanquangco numeric(1,0),sdthuoccanquangkhong numeric(1,0),userid numeric(5,0),ngayud timestamp DEFAULT now(),";
                asql += "CONSTRAINT pk_hoichan_cdha PRIMARY KEY (id))WITH OIDS;";
                asql += "ALTER TABLE " + s_user + ".hoichan_cdha OWNER TO medisoft;";
                execute_data(asql, false);
            }
            asql = "select id from " + s_user + ".hoichan_cdha_ct where 1=2";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = "CREATE TABLE  " + s_user + ".hoichan_cdha_ct (id numeric(22,0) not null,iddmbophan numeric(5,0),";
                asql += "CONSTRAINT pk_hoichan_cdha_ct PRIMARY KEY (id,iddmbophan),";
                asql += "CONSTRAINT fk_hoichan_cdha_hoichan_cdha_ct FOREIGN KEY (id)  REFERENCES " + s_user + ".hoichan_cdha (id) ";
                asql += "MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT)WITH OIDS;";
                asql += "ALTER TABLE " + s_user + ".hoichan_cdha_ct OWNER TO medisoft;";
                execute_data(asql, false);
            }
            ///Ngay 24/06/2011
            asql = "select id from " + s_user + ".kbct_canquangll where 1=2";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = "CREATE TABLE  " + s_user + ".kbct_canquangll (id numeric(22,0) not null,mabn character varying(10),mavaovien numeric(22,0),maql numeric(22,0),ngay timestamp,chandoan text,";
                asql += "icd10 character varying(9), tv_canthietchupct numeric(1,0),tv_tacdungphu numeric(1,0),hb_tiensudiung numeric(1,0),hb_tinhtrangmatnuoc numeric(1,0),hb_roiloanhd numeric(1,0),hb_suythan numeric(1,0),hb_thaiky numeric(1,0),";
                asql += "hb_dautuy numeric(1,0),hb_benhlytm numeric(1,0),hb_tinhtrangntr numeric(1,0),mach numeric(5,0),nhietdo numeric(7,2),huyetap character varying(7),nhiptho numeric(5,0),ketquabun text,ketquacreatinin text,";
                asql += "userid numeric(5,0),ngayud timestamp DEFAULT now(),";
                asql += "CONSTRAINT pk_kbct_canquangll PRIMARY KEY (id))WITH OIDS;";
                asql += "ALTER TABLE " + s_user + ".kbct_canquangll OWNER TO medisoft;";
                execute_data(asql, false);
            }
            asql = "select id from " + s_user + ".kbct_canquang where 1=2";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = "CREATE TABLE  " + s_user + ".kbct_canquangct (id numeric(22,0) not null,iddmbophan numeric(5,0),";
                asql += "CONSTRAINT pk_kbct_canquangct PRIMARY KEY (id,iddmbophan),";
                asql += "CONSTRAINT fk_kbct_canquangll_kbct_canquangct FOREIGN KEY (id)  REFERENCES " + s_user + ".kbct_canquangll (id) ";
                asql += "MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT)WITH OIDS;";
                asql += "ALTER TABLE " + s_user + ".kbct_canquangll OWNER TO medisoft;";
                execute_data(asql, false);
            }
            //end dong
            asql = "select mabs from " + s_user + ".v_dsduyet where 1=2";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = " ALTER TABLE medibv.v_dsduyet ADD COLUMN mabs character varying(4);";
                execute_data(asql, false);
            }
            asql = "select id from " + s_user + ".v_nhommien where 1=2";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = " CREATE TABLE medibv.v_nhommien (id numeric(2) NOT NULL DEFAULT 0, ten text, loaivp text, CONSTRAINT pk_v_nhommien PRIMARY KEY (id)) WITH OIDS; ALTER TABLE medibv.v_nhommien OWNER TO medisoft;";
                execute_data(asql, false);
            }
            asql = "select sudung from " + s_user + ".v_nhommien where 1=2";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = "alter table " + s_user + ".v_nhommien add column sudung numeric(1) default 1;";
                execute_data(asql, false);
            }

            asql = "select iddot from " + s_user + ".v_km_nhommien where 1=2";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = " CREATE TABLE " + s_user + ".v_km_nhommien (iddot numeric(7) NOT NULL DEFAULT 0, id_nhommien numeric(2) NOT NULL DEFAULT 0, tyle numeric(3), userid numeric(7) DEFAULT 0, ngayud timestamp without time zone DEFAULT now(), CONSTRAINT pk_v_km_nhommien PRIMARY KEY (iddot,id_nhommien), CONSTRAINT fk_v_km_nhommien_v_dot_khuyenmai FOREIGN KEY (iddot) REFERENCES " + s_user + ".v_dot_khuyenmai (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT, CONSTRAINT fk_v_km_nhommien_v_nhommien FOREIGN KEY (id_nhommien) REFERENCES " + s_user + ".v_nhommien (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT)WITH OIDS;ALTER TABLE " + s_user + ".v_km_nhommien OWNER TO medisoft;";
                execute_data(asql, false);
            }

            asql = "select theogio from " + s_user + ".v_dot_khuyenmai where 1=2";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = "alter table " + s_user + ".v_dot_khuyenmai add column theogio numeric(1) default 0";
                execute_data(asql, false);
            }

            asql = "select sudung from " + s_user + ".v_dot_khuyenmai where 1=2";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = "alter table " + s_user + ".v_dot_khuyenmai add column loai numeric(2) default 0";
                execute_data(asql, false);
            }

            asql = "select idthe from " + s_user + ".v_dmloaithe_tyleuudai where 1=2";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = "CREATE TABLE medibv.v_dmloaithe_tyleuudai(idthe numeric(2) NOT NULL DEFAULT 0, tyle numeric(3) default 0, id_nhommien numeric(2) NOT NULL DEFAULT 0, CONSTRAINT pk_v_dmloaithe_tyleuudai PRIMARY KEY (idthe,id_nhommien) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_pk_v_dmloaithe_tyleuudai_v_nhommien FOREIGN KEY (id_nhommien) REFERENCES medibv.v_nhommien (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT, CONSTRAINT fk_pk_dmloaithe_tyleuudai_dmloaithe_uudai FOREIGN KEY (idthe) REFERENCES medibv.v_nhommien (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT ) WITH OIDS; ALTER TABLE medibv.v_dmloaithe_tyleuudai OWNER TO medisoft;";
                execute_data(asql, false);
            }
            asql = "select id from " + s_user + ".v_dmloaithe_uudai where 1=2";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = " CREATE TABLE medibv.v_dmloaithe_uudai (id numeric(2) NOT NULL DEFAULT 0, ten text, sudung numeric(1) default 1, CONSTRAINT pk_v_dmloaithe_uudai PRIMARY KEY (id) USING INDEX TABLESPACE medi_index )WITH OIDS;ALTER TABLE medibv.v_dmloaithe_uudai OWNER TO medisoft;";
                execute_data(asql, false);
            }
            asql = "select id from " + s_user + ".v_dmloaithe_uudai where 1=2";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = " CREATE TABLE medibv.v_dmloaithe_tyleuudai(idthe numeric(2) NOT NULL DEFAULT 0, tyle numeric(3) default 0, id_nhommien numeric(2) NOT NULL DEFAULT 0, CONSTRAINT pk_v_dmloaithe_tyleuudai PRIMARY KEY (idthe,id_nhommien) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_pk_v_dmloaithe_tyleuudai_v_nhommien FOREIGN KEY (id_nhommien) REFERENCES medibv.v_nhommien (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT, CONSTRAINT fk_pk_dmloaithe_tyleuudai_dmloaithe_uudai FOREIGN KEY (idthe) REFERENCES medibv.v_nhommien (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT)WITH OIDS;ALTER TABLE medibv.v_dmloaithe_tyleuudai OWNER TO medisoft;";
                execute_data(asql, false);
            }

            asql = "select id from " + s_user + ".btdbn_uudai where 1=2";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = " CREATE TABLE " + s_user + ".btdbn_uudai( id numeric(21) NOT NULL DEFAULT 0, sothe numeric(10) DEFAULT 0, mabn character varying(10), idthe numeric(2), tungay timestamp without time zone, denngay timestamp without time zone, ngaycap timestamp without time zone, userid numeric(5) DEFAULT 0, ngayud timestamp without time zone default now(), CONSTRAINT pk_btdbn_uudai PRIMARY KEY (id) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_btdbn_uudai_btdbn FOREIGN KEY (mabn) REFERENCES " + s_user + ".btdbn (mabn) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT, CONSTRAINT fk_btdbn_uudai_v_dmloaithe_uudai FOREIGN KEY (idthe) REFERENCES " + s_user + ".v_dmloaithe_uudai (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS; ALTER TABLE " + s_user + ".btdbn_uudai OWNER TO medisoft;";
                execute_data(asql, false);
            }
            asql = "select id from " + s_user + ".btdbn_uudaict where 1=2";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = " CREATE TABLE " + s_user + ".btdbn_uudaict (id numeric(21) NOT NULL DEFAULT 0, tyle numeric(3) default 0, id_nhommien numeric(2) NOT NULL DEFAULT 0, CONSTRAINT pk_btdbn_uudaict PRIMARY KEY (id) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_btdbn_uudaict_v_nhommien FOREIGN KEY (id_nhommien) REFERENCES " + s_user + ".v_nhommien (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT, CONSTRAINT fk_btdbn_uudaict_btdbn_uudai FOREIGN KEY (id) REFERENCES " + s_user + ".btdbn_uudai (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT)WITH OIDS; ALTER TABLE " + s_user + ".btdbn_uudaict OWNER TO medisoft;";
                execute_data(asql, false);
            }
            asql = "select cls38 from " + s_user + ".d_dlogin where 1=2";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = "alter table " + s_user + ".d_dlogin add column thuoc38 numeric(1) default 1;\n";
                asql += "alter table " + s_user + ".d_dlogin add column cls38 numeric(1) default 1;\n";
                execute_data(asql, false);
            }
            //Dong them filed
            asql = " select hoichan from " + s_user + ".v_giavp where id=0";
            lds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = "alter table " + s_user + ".v_giavp add hoichan numeric(1) default 0 ";
                execute_data(asql, false);
            }
            asql = " select giaycamdoan from " + s_user + ".v_giavp where id=0";
            lds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = "alter table " + s_user + ".v_giavp add giaycamdoan numeric(1) default 0 ";
                execute_data(asql, false);
            }
            asql = " select thoigiantrakq from " + s_user + ".v_giavp where id=0";
            lds = get_data(asql, false);
            if (ds != null && ds.Tables.Count > 0)
            {
                asql = "alter table " + s_user + ".v_giavp drop column thoigiantrakq ";
                execute_data(asql, false);
            }
            asql = " select gioitinh from " + s_user + ".v_giavp where id=0";
            lds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = "alter table " + s_user + ".v_giavp add gioitinh character varying(10) default null ";
                execute_data(asql, false);
            }
            asql = " select tutuoi from " + s_user + ".v_giavp where id=0";
            lds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = "alter table " + s_user + ".v_giavp add tutuoi numeric(3) default 0 ";
                execute_data(asql, false);
            }
            asql = " select dentuoi from " + s_user + ".v_giavp where id=0";
            lds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = "alter table " + s_user + ".v_giavp add dentuoi numeric(3) default 0 ";
                execute_data(asql, false);
            }
            asql = " select batbuocthutien,coso,cosothay,kpthuchien from " + s_user + ".v_giavp where id=0";
            lds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = " alter table " + s_user + ".v_giavp add batbuocthutien numeric(1,0) default 0;\n ";
                asql += " alter table " + s_user + ".v_giavp add coso numeric(3,0) default 0;\n ";
                asql += " alter table " + s_user + ".v_giavp add cosothay character varying(50) default null;\n ";
                asql += " alter table " + s_user + ".v_giavp add phongthuchiencls character varying(50) default null ";
                execute_data(asql, false);
            }
            asql = " select tgtrakq from " + s_user + ".v_giavp where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = " alter table " + s_user + ".v_giavp add tgtrakq character varying(10) default null ";
                execute_data(asql, false);
            }
            asql = " select cosoden from " + s_user + s_mmyy + ".v_chidinh where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = " alter table " + s_user + s_mmyy + ".v_chidinh add cosoden numeric(2,0) default 0 ";
                execute_data(asql, false);
            }
            ///Ngay 16/06/2011
            asql = " select tylegiam from " + s_user + s_mmyy + ".v_chidinh where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = " alter table " + s_user + s_mmyy + ".v_chidinh add tylegiam numeric(3,0) default 0 ";
                execute_data(asql, false);
            }
            asql = " select stgiam from " + s_user + s_mmyy + ".v_chidinh where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = " alter table " + s_user + s_mmyy + ".v_chidinh add stgiam numeric(22,0) default 0 ";
                execute_data(asql, false);
            }
            asql = " select mabv from " + s_user + ".dmchinhanh where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = " alter table " + s_user + ".dmchinhanh add mabv character varying(10) null ";
                execute_data(asql, false);
            }
            //End dong

            asql = " select chinhanh from " + s_user + ".btdkp_bv where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = " alter table " + s_user + ".btdkp_bv add chinhanh numeric(2) default 0;\n ";
                asql += " alter table " + s_user + ".btdkp_add add chinhanh numeric(2) default 0;\n ";
                execute_data(asql, false);
            }
            asql = " select chinhanh from " + s_user + ".dmloaibhyt where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = " CREATE TABLE " + s_user + ".dmloaibhyt (ma character varying(2) not null, tu numeric(2), den numeric(2), chieudai numeric(2), CONSTRAINT pk_dmloaibhyt PRIMARY KEY (ma) USING INDEX TABLESPACE medi_index ) WITH OIDS; ALTER TABLE " + s_user + ".dmloaibhyt OWNER TO medisoft; ";
                execute_data(asql, false);
            }
            asql = " select chinhanh from " + s_user + ".dmbs where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = " alter table " + s_user + ".dmbs add chinhanh numeric(2) default 0 ";
                execute_data(asql, false);
            }
            asql = " select ma from " + s_user + ".tyleuudai_loaibhyt where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = " CREATE TABLE " + s_user + ".tyleuudai_loaibhyt ( ma character varying(2) not null, id_nhommien numeric(2), tyle numeric(3), iddotkm numeric(7), CONSTRAINT pk_tyleuudai_loaibhyt PRIMARY KEY (ma,id_nhommien,iddotkm) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_tyleuudai_loaibhyt_v_nhommien FOREIGN KEY (id_nhommien) REFERENCES " + s_user + ".v_nhommien (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT, CONSTRAINT fk_tyleuudai_loaibhyt_v_dot_khuyenmai FOREIGN KEY (iddotkm) REFERENCES " + s_user + ".v_dot_khuyenmai (id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT )WITH OIDS; ALTER TABLE " + s_user + ".tyleuudai_loaibhyt OWNER TO medisoft;";
                execute_data(asql, false);

            }
            asql = " select benhmantinh, tiensubenh from " + s_user + ".icd10 where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = " alter table " + s_user + ".icd10 add benhmantinh numeric(1) default 0;\n ";
                asql = " alter table " + s_user + ".icd10 add tiensubenh numeric(1) default 0;\n ";
                execute_data(asql, false);
            }
            asql = " select cungtuyen from " + s_user + ".tenvien where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = " alter table " + s_user + ".tenvien add cungtuyen numeric(1) default 0;";
                execute_data(asql, false);
            }
            asql = " select daduyet, userid_duyet from " + s_user + ".chuyenvien where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = " alter table " + s_user + ".chuyenvien add daduyet numeric(1) default 0;\n";
                asql += " alter table " + s_user + ".chuyenvien add userid_duyet numeric(7) default 0;\n";
                execute_data(asql, false);
            }
            asql = " select mabn from " + s_user + ".yeucauhoadon where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = " CREATE TABLE " + s_user + ".yeucauhoadon (mabn character varying(10) not null, mavaovien numeric(21) not null, ngay timestamp without time zone, donvi text, dcdonvi text, masothue text, dcnhan text, nguoinhan text, userid numeric(5), computer numeric(5), ngayud timestamp without time zone DEFAULT now(), CONSTRAINT pk_yeucauhoadon PRIMARY KEY (mabn,mavaovien)) WITH OIDS; ALTER TABLE medibv.yeucauhoadon OWNER TO medisoft;";
                execute_data(asql, false);
            }
            asql = " select mabn from " + s_user + ".tylemien_km where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = " CREATE TABLE medibv.tylemien_km (mabn character varying(10), mavaovien numeric(21) NOT NULL DEFAULT 0, loaiuudai numeric(2), id_nhommien numeric(2), tyle numeric(3), iddotkm numeric(7), userid numeric(5), computer numeric(5), ngayud timestamp without time zone DEFAULT now(), CONSTRAINT pk_tylemien_km PRIMARY KEY (mavaovien,id_nhommien)  USING INDEX TABLESPACE medi_index, CONSTRAINT fk_tylemien_km_v_nhommien FOREIGN KEY (id_nhommien) REFERENCES medibv.v_nhommien (id), CONSTRAINT fk_tylemien_km_v_dot_khuyenmai FOREIGN KEY (iddotkm) REFERENCES medibv.v_dot_khuyenmai (id) )WITH OIDS; ALTER TABLE medibv.tylemien_km OWNER TO medisoft;";
                execute_data(asql, false);
            }
            asql = " select mabn from " + s_user + ".tylemien_ud where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = " CREATE TABLE medibv.tylemien_ud (mabn character varying(10), mavaovien numeric(21) NOT NULL DEFAULT 0, id_nhommien numeric(2), tyle numeric(3), id_theuudai numeric(21),	userid numeric(5), computer numeric(5),	ngayud timestamp without time zone DEFAULT now(),CONSTRAINT pk_tylemien_ud PRIMARY KEY (mavaovien,id_nhommien)  USING INDEX TABLESPACE medi_index,CONSTRAINT fk_tylemien_ud_v_nhommien FOREIGN KEY (id_nhommien) REFERENCES medibv.v_nhommien (id) ,CONSTRAINT fk_tylemien_ud_btdbn_uudai FOREIGN KEY (id_theuudai) REFERENCES medibv.btdbn_uudai (id))WITH OIDS;ALTER TABLE medibv.tylemien_ud OWNER TO medisoft;";
                execute_data(asql, false);
            }
            asql = " select mabn from " + s_user + ".tylemien_mg where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = " CREATE TABLE medibv.tylemien_mg(mabn character varying(10), mavaovien numeric(21) NOT NULL DEFAULT 0, id_nhommien numeric(2), tyle numeric(3), nguoiduyetmien numeric(4), userid numeric(5),  computer numeric(5), ngayud timestamp without time zone DEFAULT now(), CONSTRAINT pk_tylemien_mg PRIMARY KEY (mavaovien,id_nhommien)  USING INDEX TABLESPACE medi_index, CONSTRAINT fk_tylemien_mg_v_nhommien FOREIGN KEY (id_nhommien) REFERENCES medibv.v_nhommien (id), CONSTRAINT fk_tylemien_mg_v_dsduyet FOREIGN KEY (nguoiduyetmien) REFERENCES medibv.v_dsduyet (ma) )WITH OIDS; ALTER TABLE medibv.tylemien_mg OWNER TO medisoft;";
                execute_data(asql, false);
            }
            asql = " select id from " + s_user + ".dmlydodungtuyen where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = " CREATE TABLE medibv.dmlydodungtuyen (id numeric(3) NOT NULL DEFAULT 0, ten text, chuyenvien numeric(1) DEFAULT 0, CONSTRAINT pk_dmlydodungtuyen PRIMARY KEY (id) USING INDEX TABLESPACE medi_index )WITH OIDS; ALTER TABLE medibv.dmlydodungtuyen OWNER TO medisoft; ";
                execute_data(asql, false);
            }
            asql = " select id from " + s_user + ".dmlydokham where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = "CREATE TABLE medibv.dmlydokham (id numeric(3) NOT NULL DEFAULT 0, ten text, danhmuc numeric(1) DEFAULT 0, CONSTRAINT pk_dmlydokham PRIMARY KEY (id) USING INDEX TABLESPACE medi_index )WITH OIDS; ALTER TABLE medibv.dmlydokham OWNER TO medisoft;";
                execute_data(asql, false);
            }
            //ksk
            asql = " select id from " + s_user + ".dmtiensusk where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = " CREATE TABLE " + s_user + ".dmtiensusk(id numeric(5), ten text, CONSTRAINT pk_dmtiensusk PRIMARY KEY (id) USING INDEX TABLESPACE medi_data ) WITHOUT OIDS TABLESPACE medi_data; ALTER TABLE medibv.dmtiensusk OWNER TO medisoft;";
                execute_data(asql, false);
            }
            asql = " select id from " + s_user + ".dmdenghisk where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = " CREATE TABLE medibv.dmdenghisk (id numeric(5), ten text, CONSTRAINT pk_dmdenghisk PRIMARY KEY (id) USING INDEX TABLESPACE medi_data ) WITHOUT OIDS TABLESPACE medi_data; ALTER TABLE medibv.dmdenghisk OWNER TO medisoft;";
                execute_data(asql, false);
            }
            asql = " select id from " + s_user + ".ct_loaibenhtat where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = " CREATE TABLE medibv.ct_loaibenhtat(stt numeric(10) DEFAULT 0, ten text, id numeric(10))WITHOUT OIDS; ALTER TABLE medibv.ct_loaibenhtat OWNER TO medisoft; ";
                execute_data(asql, false);
            }

            asql = " select stt from " + s_user + ".ct_benhtat where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = " CREATE TABLE medibv.ct_benhtat (stt numeric(10), ten text, id_loai numeric(10) DEFAULT 0, id_nhom numeric(10) DEFAULT 0, id_benhtat numeric(10) NOT NULL DEFAULT 0, loai numeric, CONSTRAINT ct_benhtat_pri PRIMARY KEY (id_benhtat) ) WITH OIDS; ALTER TABLE medibv.ct_benhtat OWNER TO medisoft; ";
                execute_data(asql, false);
            }
            asql = " select mabn from " + s_user + ".btdbn_trungcao where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = " CREATE TABLE medibv.btdbn_trungcao (mabn character varying(10), mavaovien numeric(21), thetrungcao character varying(10), userid number(9) default 0, ngayud timestamp default now(), CONSTRAINT pk_btdbn_tc PRIMARY KEY (mavaovien) ) WITH OIDS; ALTER TABLE medibv.btdbn_trungcao OWNER TO medisoft; ";
                execute_data(asql, false);
            }
            asql = " select id from " + s_user + ".dmloaitg where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = " CREATE TABLE medibv.dmloaitg (id numeric(2), ten character varying(50), tugio_s character varying(5), dengio_s character varying(5), tugio_c character varying(5), dengio_c character varying(5), CONSTRAINT pk_dmloaitg PRIMARY KEY (id) ) WITH OIDS; ALTER TABLE medibv.dmloaitg OWNER TO medisoft; ";
                execute_data(asql, false);
                execute_data("insert into medibv.dmloaitg (id,ten) values (0,'Trong giờ');");
                execute_data("insert into medibv.dmloaitg (id,ten) values (1,'Ngoài giờ');");
                execute_data("insert into medibv.dmloaitg (id,ten) values (2,'Ngày nghỉ');");
                execute_data("insert into medibv.dmloaitg (id,ten) values (3,'Ngày lễ-tết');");
            }
            asql = " select ngay from " + s_user + ".ngaynghi where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = " CREATE TABLE medibv.ngaynghi(ngay character varying(20), tugio character varying (5), dengio character varying (5), nghi numeric(1) default 0, day character varying (3) ) WITH OIDS; ALTER TABLE medibv.ngaynghi OWNER TO medisoft;";
                execute_data(asql, false);
                execute_data("insert into medibv.ngaynghi (ngay,day) values ('Thứ hai','MON')");
                execute_data("insert into medibv.ngaynghi (ngay,day) values ('Thứ ba','TUE')");
                execute_data("insert into medibv.ngaynghi (ngay,day) values ('Thứ tư','WED')");
                execute_data("insert into medibv.ngaynghi (ngay,day) values ('Thứ năm','THU')");
                execute_data("insert into medibv.ngaynghi (ngay,day) values ('Thứ sáu','FRI')");
                execute_data("insert into medibv.ngaynghi (ngay,day, nghi) values ('Thứ bảy','SAT',1)");
                execute_data("insert into medibv.ngaynghi (ngay,day, nghi) values ('Chủ nhật','SUN',1)");
            }
            asql = " select mabn from " + s_user + ".bndk_tg where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = " CREATE TABLE medibv.bndk_tg (mabn character varying (10) not null, mavaovien numeric(21), id_loaitg numeric(1), ngaygio timestamp without time zone, CONSTRAINT pk_bndk_tg PRIMARY KEY (mabn,mavaovien), CONSTRAINT fk_bndk_tg_btdbn FOREIGN KEY (mabn) REFERENCES medibv.btdbn (mabn)) WITH OIDS; ALTER TABLE medibv.bndk_tg OWNER TO medisoft;";
                execute_data(asql, false);
            }

            //Tu:14/06/2011
            asql = " select mabn from " + s_user + ".giaythuphanungthuoc where 1=0";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = " create table " + s_user + ".giaythuphanungthuoc(id numeric,stt numeric(3),mabn varchar(10),chandoan text ,ngaythu timestamp,mabd numeric(9),tenbd text,ppthu text,mabs varchar(4),mabs_thu varchar(4),mabs_doc varchar(4),ngay_dockq timestamp,userid numeric(7),ngayud timestamp default now(),CONSTRAINT pk_giaythuphanungthuoc PRIMARY KEY (id,stt),CONSTRAINT fk_giaythuphanungthuoc_btdbn FOREIGN KEY (mabn) REFERENCES " + s_user + ".btdbn(mabn)) WITHOUT OIDS; ALTER TABLE " + s_user + ".giaythuphanungthuoc OWNER TO medisoft;";
                execute_data(asql, false);
            }
            asql = " select id from " + s_user + ".dmbenhtc where 1=0";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = " create table " + s_user + ".dmbenhtc(id numeric(3),ten text,CONSTRAINT pk_dmbenhtc PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + s_user + ".dmbenhtc OWNER TO medisoft;";
                execute_data(asql, false);
            }
            asql = " select id from " + s_user + ".phieutiemchung where 1=0";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = "create table " + s_user + ".phieutiemchung(id numeric,stt numeric(5),mabn varchar(10),sophieu varchar(20),id_benhtc numeric(3),mabd numeric(9),muitiem text,ngaytiem timestamp,ngaytiem_hen timestamp,cosotiem numeric(2),userid numeric(7),ngayud timestamp default now(),CONSTRAINT pk_phieutiemchung PRIMARY KEY (id),CONSTRAINT fk_phieutiemchung_btdbn FOREIGN KEY (mabn) REFERENCES " + s_user + ".btdbn (mabn),CONSTRAINT fk_phieutiemchung_dmbenhtc FOREIGN KEY (id_benhtc) REFERENCES " + s_user + ".dmbenhtc(id)) WITH OIDS;ALTER TABLE " + s_user + ".phieutiemchung OWNER TO medisoft;";
                execute_data(asql, false);
            }
            //asql = " select maql from " + s_user + ".phieutiemchung where 1=0";
            //ds = get_data(asql, false);
            //if (ds == null || ds.Tables.Count <= 0)
            //{
            //    asql = "alter table "+s_user+".phieutiemchung add maql numeric default 0;";
            //    execute_data(asql, false);
            //}
            execute_data("alter table " + s_user + ".phieutiemchung drop CONSTRAINT pk_phieutiemchung;", false);
            execute_data("alter table " + s_user + ".phieutiemchung add CONSTRAINT pk_phieutiemchung PRIMARY KEY(id,mabd);", false);

            asql = " select stt,ngay,maicd from " + s_user + ".theodoitsu where 1=0";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                execute_data("alter table " + s_user + ".theodoitsu add stt numeric(5);", false);
                execute_data("alter table " + s_user + ".theodoitsu add ngay timestamp;", false);
                execute_data("alter table " + s_user + ".theodoitsu add maicd varchar(9);", false);
                execute_data("alter table " + s_user + ".theodoitsu drop CONSTRAINT pk_theodoitsu;", false);
                execute_data("alter table " + s_user + ".theodoitsu add CONSTRAINT pk_theodoitsu PRIMARY KEY(mabn,maicd);", false);
            }

            asql = " select ngay from " + s_user + ".benhmantinh where 1=0";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = "alter table " + s_user + ".benhmantinh add ngay timestamp;";
                execute_data(asql, false);
            }
            asql = " select tiensu from " + s_user + ".dmpttt where 1=0";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = "alter table " + s_user + ".dmpttt add tiensu numeric(1) default 0;";
                execute_data(asql, false);
            }
            asql = " select mabn from " + s_user + ".d_dausinhton where 1=0";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = "alter table " + s_user + ".d_dausinhton add mabn varchar(10);";
                execute_data(asql, false);
            }
            asql = " select mabn from " + s_user + ".tiepdon where 1=0";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = "CREATE TABLE " + s_user + ".tiepdon(mabn varchar(8),mavaovien numeric DEFAULT 0,maql numeric NOT NULL DEFAULT 0,makp varchar(2),ngay timestamp,madoituong numeric(2) DEFAULT 0,sovaovien varchar(10),tuoivao varchar(4),done varchar(1),bnmoi numeric(1) DEFAULT 0,noitiepdon numeric(2) DEFAULT 0, loai numeric(1) DEFAULT 0, ngayhen timestamp, userid numeric(5) DEFAULT 0, ngayud timestamp DEFAULT now(), CONSTRAINT pk_tiepdon PRIMARY KEY (maql), CONSTRAINT fk_tiepdon_btdkp_bv FOREIGN KEY (makp)     REFERENCES medibv.btdkp_bv (makp) MATCH SIMPLE      ON UPDATE RESTRICT ON DELETE RESTRICT, CONSTRAINT fk_tiepdon_doituong FOREIGN KEY (madoituong) REFERENCES " + s_user + ".doituong (madoituong) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT) WITH OIDS; ALTER TABLE " + s_user + ".tiepdon OWNER TO medisoft;";
                execute_data(asql, false);
            }
            asql = " select ngay from " + s_user + ".STTNGAY where 1=0";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                execute_data("CREATE TABLE " + s_user + ".STTNGAY(NGAY timestamp,SO numeric(5,0),CONSTRAINT PK_BAVV_STTNGAY PRIMARY KEY (NGAY) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;", false);
            }
            asql = " select id from " + s_user + ".d_phatthuoc where 1=0";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                execute_data("CREATE TABLE " + s_user + ".d_phatthuoc(id numeric,loai numeric(2,0),stt numeric(3,0),mabd numeric(9,0),sttt_phat numeric(22,0),soluong numeric(12,4),mabn varchar(10),ngayphat timestamp,userid numeric(7,0),ngayud timestamp default now(),CONSTRAINT PK_d_phatthuoc PRIMARY KEY (id,stt) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;", false);
            }
            //end Tu
            asql = " select xamlan from " + s_user + ".v_giavp where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = " alter table " + s_user + ".v_giavp add xamlan numeric(1) default 0;\n";
                execute_data(asql, false);
            }
            asql = " select xamlan from " + s_user + ".v_giavp where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = " CREATE TABLE medibv.dmloaict (id numeric(3) NOT NULL, stt numeric(3), ten text, userid numeric(5), ngayud timestamp without time zone DEFAULT now(), CONSTRAINT pk_dmloaict PRIMARY KEY (id) ) WITH OIDS; ALTER TABLE medibv.dmloaict OWNER TO medisoft; ";
                execute_data(asql, false);
            }
            asql = " select xamlan from " + s_user + ".v_giavp where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = "CREATE TABLE medibv.hachungtu ( mabn character varying(10) NOT NULL,  mavaovien numeric(21) NOT NULL, id_loaict numeric(3) NOT NULL, duongdan text, userid numeric(7), ngayud timestamp without time zone DEFAULT now(), CONSTRAINT pk_hachungtu PRIMARY KEY (mabn, mavaovien, id_loaict), CONSTRAINT fk_hachungtu_dmloaict FOREIGN KEY (id_loaict) REFERENCES medibv.dmloaict (id) ) WITH OIDS; ALTER TABLE medibv.hachungtu OWNER TO medisoft;";
                execute_data(asql, false);
            }

            asql = " select id from " + s_user + ".blgd_tdhv where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = "CREATE TABLE medibv.blgd_tdhv (id numeric(3) NOT NULL, stt numeric(3), ten text, userid numeric(7), ngayud timestamp without time zone DEFAULT now(), CONSTRAINT pk_blgd_tdhv PRIMARY KEY (id) ) WITH OIDS; ALTER TABLE medibv.blgd_tdhv OWNER TO medisoft;";
                execute_data(asql, false);
            }
            asql = " select id from " + s_user + ".blgd_tthonnhan where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = "CREATE TABLE medibv.blgd_tthonnhan (id numeric(3) NOT NULL, stt numeric(3), ten text, userid numeric(7), ngayud timestamp without time zone DEFAULT now(), CONSTRAINT pk_blgd_tthonnhan PRIMARY KEY (id) )WITH OIDS; ALTER TABLE medibv.blgd_tthonnhan OWNER TO medisoft;";
                execute_data(asql, false);
            }

            asql = " select id from " + s_user + ".blgd_nguoigaybl where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = "CREATE TABLE medibv.blgd_nguoigaybl (id numeric(3) NOT NULL, stt numeric(3), ten text, userid numeric(7), ngayud timestamp without time zone DEFAULT now(), CONSTRAINT pk_blgd_nguoigaybl PRIMARY KEY (id)) WITH OIDS; ALTER TABLE medibv.blgd_nguoigaybl OWNER TO medisoft;";
                execute_data(asql, false);
            }
            asql = " select id from " + s_user + ".blgd_tgchiudung where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = "CREATE TABLE medibv.blgd_tgchiudung (id numeric(3) NOT NULL, stt numeric(3), ten text, userid numeric(7), ngayud timestamp without time zone DEFAULT now(), CONSTRAINT pk_blgd_tgchiudung PRIMARY KEY (id)) WITH OIDS; ALTER TABLE medibv.blgd_tgchiudung OWNER TO medisoft; ";
                execute_data(asql, false);
            }

            asql = " select id from " + s_user + ".blgd_tonhaisk where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = " CREATE TABLE medibv.blgd_tonhaisk (id numeric(3) NOT NULL, stt numeric(3), ten text, userid numeric(7), ngayud timestamp without time zone DEFAULT now(), CONSTRAINT pk_blgd_tonhaisk  PRIMARY KEY (id))WITH OIDS; ALTER TABLE medibv.blgd_tonhaisk OWNER TO medisoft;";
                execute_data(asql, false);
            }
            asql = " select id from " + s_user + ".blgd_loaibaoluc where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                //--loai hinh bao luc gia dinh
                asql = " CREATE TABLE medibv.blgd_loaibaoluc (id numeric(3) NOT NULL, stt numeric(3), ten text, userid numeric(7), ngayud timestamp without time zone DEFAULT now(), CONSTRAINT pk_blgd_loaibaoluc  PRIMARY KEY (id))WITH OIDS; ALTER TABLE medibv.blgd_loaibaoluc OWNER TO medisoft;";
                execute_data(asql, false);
            }


            asql = " select mabn from " + s_user + ".blgd_vao where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                //---bao luc gia dinh, thong tin vao
                asql = " CREATE TABLE medibv.blgd_vao(mabn character varying(10) NOT NULL, mavaovien numeric(21) not null, maql numeric(21) not null, ngay timestamp without time zone, tdhv numeric(3), tthonnhan numeric(3), chungsong numeric(2), contrai numeric(2), congai numeric(2),	tennguoigaybl text, quanhe numeric(3), ";
                asql += " tgchiudung numeric(3), tgchiudungkhac text, loaibaoluc text,	ghichu text, tiensu text, khamtt text, tonhaisk numeric(3), userid numeric(7), ngayud timestamp without time zone DEFAULT now(), CONSTRAINT pk_blgd_vao PRIMARY KEY (mabn,mavaovien), constraint fk_blgd_vao_btdbn foreign key(mabn) references medibv.btdbn(mabn), constraint fk_blgd_vao_blgd_tdhv foreign key(tdhv) references medibv.blgd_tdhv(id),  constraint fk_blgd_vao_blgd_tthonnhan foreign key(tthonnhan) references medibv.blgd_tthonnhan(id), constraint fk_blgd_vao_blgd_nguoigaybl foreign key(nguoigaybl) references medibv.blgd_nguoigaybl(id), constraint fk_blgd_vao_blgd_tgchiudung foreign key(tgchiudung) references medibv.blgd_tgchiudung(id) ) WITH OIDS; ALTER TABLE medibv.blgd_vao OWNER TO medisoft;";
                execute_data(asql, false);
            }

            asql = " select mabn from " + s_user + ".blgd_ra where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                //-----bao luc gia dinh, thong tin ra
                asql = "CREATE TABLE medibv.blgd_ra (mabn character varying(10) NOT NULL, mavaovien numeric(21) not null, maql numeric(21) not null, ngay timestamp without time zone, xuly text, kedon numeric(1), danhgiaantoan text, tuvan text,	kehoachantoan text,	xutri numeric(2), tinhtrangsk text,	userid numeric(7),  ngayud timestamp without time zone DEFAULT now(), CONSTRAINT pk_blgd_ra PRIMARY KEY (mabn,mavaovien), constraint fk_blgd_ra_btdbn foreign key(mabn) references medibv.btdbn(mabn)) WITH OIDS; ALTER TABLE medibv.blgd_ra OWNER TO medisoft; ";
                execute_data(asql, false);
            }

            asql = " select sott from " + s_user + ".blgd_sangloc where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                //--sang loc benh nhan bi bao luc gia dinh
                asql = "CREATE TABLE medibv.blgd_sangloc (sott numeric(10), mabn character varying(10) NOT NULL, mavaovien numeric(21) not null, maql numeric(21) not null, ngay timestamp without time zone, tthonnhan numeric(1), baolucgiadinh numeric(1), userid numeric(7), ngayud timestamp without time zone DEFAULT now(), CONSTRAINT pk_blgd_sangloc PRIMARY KEY (mabn,mavaovien), constraint fk_blgd_sangloc_btdbn foreign key(mabn) references medibv.btdbn(mabn)) WITH OIDS; ALTER TABLE medibv.blgd_sangloc OWNER TO medisoft; ";
                execute_data(asql, false);
            }
            asql = " select id from " + s_user + ".dmphongthuchiencls where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                execute_data("create table " + user + ".dmphongthuchiencls(id numeric(3),ma character varying(20),ten text,stt numeric(3),id_loaivp text,CONSTRAINT pk_dmphongthuchiencls PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS; ALTER TABLE " + user + ".dmphongthuchiencls OWNER TO medisoft;", false);
            }
            asql = " select idchinhanh from " + s_user + ".dmphongthuchiencls where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                execute_data(" alter table " + user + ".dmphongthuchiencls add idchinhanh numeric(2,0) default 0", false);
            }
            asql = " select loai from " + s_user + ".dmphongthuchiencls where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                execute_data(" alter table " + user + ".dmphongthuchiencls add loai numeric(2,0) default 0", false);
            }
            //Khuong 21/06/2011
            asql = " select tldongchitra from " + s_user + ".tyleuudai_loaibhyt where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = " alter table " + s_user + ".tyleuudai_loaibhyt add tldongchitra numeric(3) default 0";
                execute_data(asql, false);
            }

            asql = " select tldongchitra from " + s_user + ".tylemien_km where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = " alter table " + s_user + ".tylemien_km add tldongchitra numeric(3) default 0";
                execute_data(asql, false);
            }

            asql = " select madoituong from " + s_user + ".dmloaitg where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = " alter table " + s_user + ".dmloaitg add madoituong numeric(1) default 0";
                execute_data(asql, false);
            }
            //hepa: day cac field
            asql = " select phuthu_th, thoigiantrakq from " + s_user + ".v_giavp where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = " alter table medibv.v_giavp add machuyenkhoa varchar(20)";
                execute_data(asql, false);
                asql = "alter table medibv.v_giavp add manhom varchar(20)";
                execute_data(asql, false);
                asql = "alter table medibv.v_giavp add phuthu_th number(10) default 0";
                execute_data(asql, false);
                asql = "alter table medibv.v_giavp add phuthu_dv number(10)  default 0";
                execute_data(asql, false);
                asql = "alter table medibv.v_giavp add phuthu_nn number(10)  default 0";
                execute_data(asql, false);
                asql = "alter table medibv.v_giavp add phuthu_cs number(10)  default 0 ";
                execute_data(asql, false);
                asql = "alter table medibv.v_giavp add id_vatchuamau number(5)  default 0 ";
                execute_data(asql, false);
                asql = "alter table medibv.v_giavp add thoigiantrakq varchar(50)";
                execute_data(asql, false);
            }

            asql = " select maicd10 from " + s_user + ".icd10_chidinh where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = " CREATE TABLE medibv.icd10_chidinh (maicd10 character varying(9) NOT NULL, mavp text, mabd text, CONSTRAINT pk_icd10_chidinh PRIMARY KEY (maicd10) USING INDEX TABLESPACE medi_index, constraint fk_icd10_chidinh_icd10 foreign key(maicd10) references medibv.icd10) WITH OIDS; ALTER TABLE medibv.icd10_chidinh OWNER TO medisoft;";
                execute_data(asql);
            }
            asql = " select mavp,mabd from " + s_user + ".icd10_chidinh where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = " alter table medibv.icd10_chidinh add mavp text ";
                execute_data(asql, false);
                asql = " alter table medibv.icd10_chidinh add mabd text ";
                execute_data(asql, false);
                asql = " alter table medibv.icd10_chidinh drop column mavp_bd text ";
                execute_data(asql, false);
            }
            asql = " select ctscannercq from " + s_user + ".v_giavp where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = " alter table medibv.v_giavp add ctscannercq numeric(1) default 0";
                execute_data(asql, false);
            }
            asql = " select ctscannercq from " + s_user + ".v_giavp where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = " CREATE TABLE medibv.user_active (userid numeric(7) NOT NULL DEFAULT 0, makp character varying(3), mabs character varying(6), ngay timestamp without time zone )WITHOUT OIDS; ALTER TABLE medibv.user_active OWNER TO medisoft; ";
                execute_data(asql, false);
            }

            asql = " alter table medibv.capid alter yy type varchar(4)";
            execute_data(asql, false);
            asql = " select tiemchung from " + s_user + ".btdkp_bv where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = "alter table medibv.btdkp_bv add column tiemchung numeric(1) default 0;";
                execute_data(asql, false);
            }

            asql = " select vitritiem,mabs from " + s_user + ".phieutiemchung where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = "alter table medibv.phieutiemchung add column vitritiem text;";
                execute_data(asql, false);
                asql = "alter table medibv.phieutiemchung add column mabs character varying(6);";
                execute_data(asql, false);
            }

            if (i_maxlength_mabn > 8)
            {
                f_tangsoluutru_12kytu();
            }
            asql = " select route from " + s_user + ".d_dmduongdung where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = "alter table medibv.d_dmduongdung add column route varchar(10);";
                execute_data(asql, false);
            }
            asql = " select chinhanh from " + s_user + ".v_dlogin where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = "alter table medibv.v_dlogin add column chinhanh numeric(3) default 0;";
                execute_data(asql, false);
            }
            asql = " select chinhanh from " + s_user + ".v_quyenso where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = "alter table medibv.v_quyenso add column chinhanh numeric(3) default 0;";
                execute_data(asql, false);
            }
            asql = " select id_mauthu from " + s_user + ".v_giavp where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = "alter table medibv.v_giavp add column id_mauthu numeric(6) default 0;";
                execute_data(asql, false);
            }
            asql = " select kqtaicho from " + s_user + ".v_giavp where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = "alter table medibv.v_giavp add column kqtaicho numeric(1) default 0;";
                execute_data(asql, false);
            }
            asql = " select khu from " + s_user + ".btdkp_add where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = "alter table medibv.btdkp_add add column khu numeric(3) default 0;";
                execute_data(asql, false);
            }
            asql = " select tuyen from " + s_user + ".d_dmbd where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = "alter table medibv.d_dmbd add tuyen numeric(2) default 0;";
                execute_data(asql, false);
            }
            asql = " select maphu from " + s_user + ".btdbn where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = "alter table medibv.btdbn add maphu varchar(20);";
                execute_data(asql, false);
            }
            asql = " select chuyenchungtu from " + s_user + ".v_giavp where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = "alter table medibv.v_giavp add chuyenchungtu numeric(1) default 0;";
                execute_data(asql, false);
            }
            asql = " select hide from " + s_user + ".xutrikb where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = "alter table medibv.xutrikb add hide numeric(1) default 0;";
                execute_data(asql, false);
            }
            //dmbs them field cho du du lieu cua hepa

            asql = " select cmnd,email, sothebhyt, handung, makcb, noilamviec, tenkp, tenpk from " + s_user + ".dmbs where 1=2";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = "alter table medibv.dmbs add cmnd varchar(20);";
                execute_data(asql, false);
                asql = "alter table medibv.dmbs add email varchar(20);";
                execute_data(asql, false);
                asql = "alter table medibv.dmbs add sothebhyt varchar(20);";
                execute_data(asql, false);
                asql = "alter table medibv.dmbs add handung date;";
                execute_data(asql, false);
                asql = "alter table medibv.dmbs add makcb varchar(20);";
                execute_data(asql, false);
                asql = "alter table medibv.dmbs add tenkp varchar(200);";
                execute_data(asql, false);
                asql = "alter table medibv.dmbs add tenpk varchar(200);";
                execute_data(asql, false);
                asql = "alter table medibv.dmbs add noilamviec varchar(200);";
                execute_data(asql, false);
            }
            //End Khuong 21/06/2011
            //end capnhadb
        }
        public void f_capnhat_db_danhmuc(string tenfile, string m_mmyy)
        {
            string s_user = user + m_mmyy, user1 = user;
            //
            DataSet lds = new DataSet();
            string asql = "";
            string s_gio_modify = Ngaygio_hienhanh;
            string s_mmyy = mmyy(ngayhienhanh_server);
            try
            {
                s_gio_modify = System.IO.File.GetLastWriteTime(tenfile).ToString("dd/MM/yyyy HH:mm");
            }
            catch { s_gio_modify = Ngaygio_hienhanh; }
            asql = "select ngaygio from " + s_user + ".datao where to_char(ngaygio,'dd/mm/yyyy hh24:mi')='" + s_gio_modify + "'";
            lds = get_data(asql, false);
            if (lds == null || lds.Tables.Count <= 0)
            {
                asql = " drop table " + s_user + ".datao ";
                execute_data(asql, false);
                asql = " create table " + s_user + ".datao (ngaygio timestamp, constraint pk_datao primary key (ngaygio) USING INDEX TABLESPACE medi_index)  WITH OIDS ";
                execute_data(asql, false);
            }
            else if (lds.Tables[0].Rows.Count > 0) return;
            asql = "insert into " + s_user + ".datao (ngaygio) values (to_date('" + s_gio_modify + "','dd/mm/yyyy hh24:mi'))";
            execute_data(asql, false);
            //tu 
            if (i_maxlength_mabn > 8) { f_tangmabn_10kytu(s_mmyy); f_tangmakho_6so(s_mmyy); }
            if (i_maxlength_makp > 2) f_tangmakp_3kytu(s_mmyy);
            if (bKhambenh_ba) f_Taodatabase_ba(s_mmyy);
            //
            asql = " select dakham from " + s_user + ".sttkham where 1=0";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                execute_data("alter table " + s_user + ".sttkham add dakham numeric(5) default 0;", false);
            }
            //
            execute_data("alter table " + s_user + ".d_dausinhton alter nhietdo type numeric(7,2)", false);
            asql = " select mabn from " + s_user + ".d_dausinhton where 1=0";
            ds = get_data(asql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                asql = "alter table " + s_user + ".d_dausinhton add mabn varchar(10);";
                execute_data(asql, false);
            }
            //ksk
            sql = "create table " + s_user + ".bask_rhm(mavaovien numeric(21, 0), mabn varchar(10), maql numeric(21, 0), ngay timestamp, makp varchar(" + i_maxlength_makp + "), image bytea, sucnhai text, nhanxet text, khac text, maicd varchar(9), chandoan text, phanloai numeric(2), mabs varchar(4), userid numeric(9, 0), ngayud timestamp DEFAULT now(), CONSTRAINT pk_bask_rhm PRIMARY KEY (mavaovien) USING INDEX TABLESPACE medi_index ) WITH OIDS;ALTER TABLE " + s_user + ".bask_rhm OWNER TO medisoft;\n";
            sql += "create table " + s_user + ".bask_dalieu(mavaovien numeric(21, 0), mabn varchar(10), maql numeric(21, 0), ngay timestamp, makp varchar(" + i_maxlength_makp + "), tongquat text, khac text, maicd varchar(9), chandoan text, phanloai numeric(2),mabs varchar(4), userid numeric(9, 0), ngayud timestamp DEFAULT now(), CONSTRAINT pk_bask_dalieu PRIMARY KEY (mavaovien) USING INDEX TABLESPACE medi_index) WITH OIDS; ALTER TABLE " + s_user + ".bask_dalieu OWNER TO medisoft;\n";
            sql += "create table " + s_user + ".bask_coxuong (mavaovien numeric(21, 0),mabn varchar(10), maql numeric(21, 0), ngay timestamp, makp varchar(" + i_maxlength_makp + "),  tongquat text,  khac text,  maicd varchar(9),  chandoan text, phanloai numeric(2), mabs varchar(4), userid numeric(9, 0),  ngayud timestamp DEFAULT now(), CONSTRAINT pk_bask_coxuong PRIMARY KEY (mavaovien) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + s_user + ".bask_coxuong OWNER TO medisoft;\n";
            sql += "CREATE TABLE " + s_user + ".bask_tiensu (mavaovien numeric(21, 0),mabn varchar(10), id numeric(5, 0), ghichu text, CONSTRAINT pk_bask_tiensu PRIMARY KEY (mavaovien,id) USING INDEX TABLESPACE medi_index ) WITHOUT OIDS TABLESPACE medi_index;ALTER TABLE " + s_user + ".bask_tiensu OWNER TO medisoft;\n";
            get_data(sql, false);

            sql = "alter table " + s_user + ".bask_chiso add userid numeric(9,0);\n";
            sql += "alter table " + s_user + ".bask_chiso add  mantinh text;\n";
            sql += "alter table " + s_user + ".bask_chiso add  namvien text;\n";
            sql += "alter table " + s_user + ".bask_chiso add  ruou numeric;\n";
            sql += "alter table " + s_user + ".bask_chiso add  thuocla numeric;\n";
            sql += "alter table " + s_user + ".bask_chiso add  diung numeric;\n";
            sql += "alter table " + s_user + ".bask_chiso add  tendiung text;\n";
            sql += "alter table " + s_user + ".bask_chiso add  viemgana numeric;\n";
            sql += "alter table " + s_user + ".bask_chiso add  viemganb numeric;\n";
            sql += "alter table " + s_user + ".bask_chiso add  khac text;\n";
            sql += "alter table " + s_user + ".bask_chiso add  para text;\n";
            sql += "alter table " + s_user + ".bask_chiso add  soi numeric;\n";
            sql += "alter table " + s_user + ".bask_chiso add  viemnao numeric;\n";
            sql += "alter table " + s_user + ".bask_chiso add  lao numeric;\n";
            sql += "alter table " + s_user + ".bask_chiso add  uonvan numeric;\n";
            sql += "alter table " + s_user + ".bask_chiso add  bachhau numeric;\n";
            sql += "alter table " + s_user + ".bask_chiso add  cum numeric;\n";
            sql += "alter table " + s_user + ".bask_chiso add  ngayud timestamp default now();\n";
            get_data(sql, false);

            sql = "alter table " + s_user + ".bask_mat add mabn varchar(10);\n";
            sql += "alter table " + s_user + ".bask_mat add truoc varchar(254);\n";
            sql += "alter table " + s_user + ".bask_mat add sau varchar(254);\n";
            sql += "alter table " + s_user + ".bask_mat add nhanapp varchar(254);\n";
            sql += "alter table " + s_user + ".bask_mat add nhanapt varchar(254);\n";
            sql += "alter table " + s_user + ".bask_mat add maicd varchar(9);\n";
            sql += "alter table " + s_user + ".bask_mat add chandoan text;\n";
            sql += "alter table " + s_user + ".bask_mat add pic_mt01 bytea;\n";
            sql += "alter table " + s_user + ".bask_mat add pic_mt02 bytea;\n";
            sql += "alter table " + s_user + ".bask_mat add pic_mp01 bytea;\n";
            sql += "alter table " + s_user + ".bask_mat add pic_mp02 bytea;\n";
            sql += "alter table " + s_user + ".bask_mat add phanloai numeric(1);\n";
            get_data(sql, false);

            sql = "alter table " + s_user + ".bask_sanphu add maicd varchar(9);\n";
            sql += "alter table " + s_user + ".bask_sanphu add chandoan text;\n";
            sql += "alter table " + s_user + ".bask_sanphu add phanloai numeric(1);\n";
            get_data(sql, false);

            sql = "alter table " + s_user + ".bask_tongket add mabn varchar(10);\n";
            sql += "alter table " + s_user + ".bask_tongket add nhanxet text;\n";
            sql += "alter table " + s_user + ".bask_tongket add denghi text;\n";
            sql += "alter table " + s_user + ".bask_tongket add madenghi numeric;\n";
            sql += "alter table " + s_user + ".bask_tongket add maicd varchar(9);\n";
            sql += "alter table " + s_user + ".bask_tongket add chandoan text;\n";
            get_data(sql, false);

            sql = "alter table " + s_user + ".bask_tmh add mabn varchar(10);\n";
            sql += "alter table " + s_user + ".bask_tmh add chandoan text;\n";
            sql += "alter table " + s_user + ".bask_tmh add tai text;\n";
            sql += "alter table " + s_user + ".bask_tmh add mui text;\n";
            sql += "alter table " + s_user + ".bask_tmh add hong text;\n";
            sql += "alter table " + s_user + ".bask_tmh add thanhquan text;\n";
            sql += "alter table " + s_user + ".bask_tmh add daumatco text;\n";
            sql += "alter table " + s_user + ".bask_tmh add pic_tmh1 bytea;\n";
            sql += "alter table " + s_user + ".bask_tmh add pic_tmh2 bytea;\n";
            sql += "alter table " + s_user + ".bask_tmh add maicd varchar(9);\n";
            sql += "alter table " + s_user + ".bask_tmh add phanloai numeric(1);\n";
            get_data(sql, false);

            sql = "alter table " + s_user + ".bask_donvi add stt numeric(6,0);\n";
            sql += "alter table " + s_user + ".bask_donvi add vongbung numeric(7,2);\n";
            sql += "alter table " + s_user + ".bask_donvi add coso numeric(1,0);\n";
            sql += "alter table " + s_user + ".bask_donvi add ngayud timestamp ;\n";
            get_data(sql, false);

            sql = "alter table " + s_user + ".bask_noikhoa add mabn varchar(10);\n";
            sql += "alter table " + s_user + ".bask_noikhoa add  hohap text;\n";
            sql += "alter table " + s_user + ".bask_noikhoa add  tieuhoa text;\n";
            sql += "alter table " + s_user + ".bask_noikhoa add  than text;\n";
            sql += "alter table " + s_user + ".bask_noikhoa add  noitiet text;\n";
            sql += "alter table " + s_user + ".bask_noikhoa add  chuyenhoa text;\n";
            get_data(sql, false);

            sql = "alter table " + s_user + ".bask_noikhoa add  chandoan varchar(254);\n";
            sql += "alter table " + s_user + ".bask_noikhoa add  maicd varchar(9);\n";
            sql += "alter table " + s_user + ".bask_noikhoa add  maicdhh varchar(9);\n";
            sql += "alter table " + s_user + ".bask_noikhoa add  maicdth varchar(9);\n";
            sql += "alter table " + s_user + ".bask_noikhoa add  maicdtn varchar(9);\n";
            sql += "alter table " + s_user + ".bask_noikhoa add  maicdtt varchar(9);\n";
            sql += "alter table " + s_user + ".bask_noikhoa add  maicdnt varchar(9);\n";
            sql += "alter table " + s_user + ".bask_noikhoa add  maicdch varchar(9);\n";
            sql += "alter table " + s_user + ".bask_noikhoa add  maicdtamthan varchar(9);\n";
            sql += "alter table " + s_user + ".bask_noikhoa add  phanloai numeric(2);\n";
            get_data(sql, false);

            sql = "alter table " + s_user + ".bask_ngkhoa add mabn varchar(10);\n";
            sql += "alter table " + s_user + ".bask_ngkhoa add  tongquat text;\n";
            sql += "alter table " + s_user + ".bask_ngkhoa add  chanthuong text;\n";
            sql += "alter table " + s_user + ".bask_ngkhoa add  ubuou text;\n";
            sql += "alter table " + s_user + ".bask_ngkhoa add  maicd varchar(9);\n";
            sql += "alter table " + s_user + ".bask_ngkhoa add  chandoan varchar(254);\n";
            sql += "alter table " + s_user + ".bask_ngkhoa add  maicdub varchar(9);\n";
            sql += "alter table " + s_user + ".bask_ngkhoa add  phanloai numeric(2);\n";
            get_data(sql, false);

            sql = "alter table " + s_user + ".bask_rhm alter column mabn type varchar(10);\n";
            sql += "alter table " + s_user + ".bask_rhm alter column makp type varchar(3);\n";
            sql += "alter table " + s_user + ".bask_rhm alter column ngay type timestamp;\n";
            sql += "alter table " + s_user + ".bask_tmh alter column makp type varchar(3);\n";
            get_data(sql, false);

            sql = "alter table " + s_user + ".bask_dalieu alter column mabn type varchar(10);\n";
            sql += "alter table " + s_user + ".bask_dalieu alter column makp type varchar(3);\n";
            sql += "alter table " + s_user + ".bask_dalieu alter column ngay type timestamp;\n";
            get_data(sql, false);

            sql = "alter table " + s_user + ".bask_coxuong add mabn varchar(10);\n";
            sql += "alter table " + s_user + ".bask_coxuong alter column mabn type varchar(10);\n";
            sql += "alter table " + s_user + ".bask_coxuong alter column makp type varchar(3);\n";
            sql += "alter table " + s_user + ".bask_coxuong alter column ngay type timestamp;\n";
            get_data(sql, false);

            sql = "alter table " + s_user + ".ct_btdbn add docthan numeric(1);\n";
            sql += "alter table " + s_user + ".ct_btdbn add idmuc numeric;\n";
            //End KSK            
            get_data(sql, false);
            //
            sql = "select idphongthuchiencls, stt, idloaitg from " + s_user + ".v_chidinh where 1=2";
            ds = get_data(sql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                sql = "alter table " + s_user + ".v_chidinh add idphongthuchiencls numeric(5) default 0;";
                get_data(sql, false);
                sql = "alter table " + s_user + ".v_chidinh add stt numeric(5) default 0;";
                get_data(sql, false);
                sql = "alter table " + s_user + ".v_chidinh add idloaitg numeric(1) default 0;";
                get_data(sql, false);
            }
            sql = "select stt from " + s_user + ".stt_phongcls where 1=2";
            ds = get_data(sql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                sql = "create table " + s_user + ".stt_phongcls(idphongcls numeric(5), stt numeric(5), ngay timestamp, constraint pk_stt_phongcls (idphongcls, ngay)USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE " + s_user + ".stt_phongcls OWNER TO medisoft;\n";
                get_data(sql, false);
            }
            sql = "select paid from " + s_user + ".d_thuocbhytct where 1=2";
            ds = get_data(sql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                sql = "alter table " + s_user + ".d_thuocbhytct add paid numeric(1) default 0;";
                get_data(sql, false);
                sql = "alter table " + s_user + ".d_thuocbhytct add idttrv numeric(21) default 0;";
                get_data(sql, false);
            }
            sql = "select idphongcls, sttcho from " + s_user + ".v_vienphict where 1=2";
            ds = get_data(sql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                sql = "alter table " + s_user + ".v_vienphict add idphongcls numeric(5) default 0;";
                get_data(sql, false);
                sql = "alter table " + s_user + ".v_vienphict add sttcho numeric(5) default 0;";
                get_data(sql, false);
            }
            sql = "select kskdoan from " + s_user + ".v_chidinh where 1=2";
            ds = get_data(sql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                sql = "alter table " + s_user + ".v_chidinh add kskdoan numeric(1) default 0;";
                get_data(sql, false);
            }

            sql = "select chieucao from " + s_user + ".d_dausinhton where 1=2";
            ds = get_data(sql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                sql = "alter table " + s_user + ".d_dausinhton add chieucao numeric(3) default 0;";
                get_data(sql, false);
            }
            sql = "select ngaynghi from " + s_user + ".d_thuocbhytll where 1=2";
            ds = get_data(sql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                sql = "alter table " + s_user + ".d_thuocbhytll add ngaynghi numeric(3) default 0;";
                get_data(sql, false);
            }
            if (i_maxlength_mabn > 8)
            {
                f_tangsoluutru_12kytu(m_mmyy);
            }

            sql = "select id_xnphieu from " + s_user + ".xn_maubenhpham_ct where 1=2";
            ds = get_data(sql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                sql = "CREATE TABLE " + s_user + ".xn_maubenhpham_ct(id_xnphieu numeric NOT NULL,id_mauthu numeric DEFAULT -1,id_vatchuamau numeric DEFAULT 0,soluong numeric DEFAULT 0,chatluongmau numeric(1) DEFAULT 0, Ghichu varchar(200) default '',laymaulai numeric(1) DEFAULT 0, userid numeric DEFAULT 0, userD numeric DEFAULT 0, nhanmau numeric(1) default 1, ngaynhan timestamp default now(), ngayud timestamp DEFAULT now(), PRIMARY KEY (id_xnphieu,id_mauthu, id_vatchuamau));";
                execute_data(asql, false);
            }
            sql = "select nhanmau, ngaynhan from " + s_user + ".xn_maubenhpham_ct where 1=2";
            ds = get_data(sql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                sql = "alter table " + s_user + ".xn_maubenhpham_ct add nhanmau numeric(1) default 0;";
                get_data(sql, false);
                sql = "alter table " + s_user + ".xn_maubenhpham_ct add ngaynhan timestamp default now();";
                get_data(sql, false);
            }
            sql = "select ketqua_hople, ketqua_ori, userd  from " + s_user + ".xn_phieu where 1=2";
            ds = get_data(sql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                sql = "alter table " + s_user + ".xn_phieu add ketqua_hople numeric(1) default 0;";
                execute_data(asql, false);
                sql = "alter table " + s_user + ".xn_phieu add ketqua_ori text default '';";
                execute_data(asql, false);
                sql = "alter table " + s_user + ".xn_phieu add userd numeric default 0;";
                execute_data(asql, false);
            }
            sql = "select gia_bh  from " + s_user + ".d_thucxuat where 1=2";
            ds = get_data(sql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                sql = "alter table " + s_user + ".d_xuatsdct add gia_bh numeric default 0;";
                execute_data(sql, false);
                sql = "alter table " + s_user + ".d_tienthuoc add gia_bh numeric default 0;";
                execute_data(sql, false);
                sql = "alter table " + s_user + ".d_thucxuat add gia_bh numeric default 0;";
                execute_data(sql, false);


            }
            sql = "update " + s_user + ".d_xuatsdct set gia_bh=(select max(gia_bh) as gia_bh from " + user1 + ".d_dmbd  where " + s_user + ".d_xuatsdct.mabd=" + user1 + ".d_dmbd.id) where gia_bh=0 and mabd in(select id from " + user1 + ".d_dmbd where gia_bh>0) ";
            execute_data(sql);
            sql = "update " + s_user + ".d_thucxuat set gia_bh=(select max(gia_bh) as gia_bh from " + user1 + ".d_dmbd  where " + s_user + ".d_thucxuat.mabd=" + user1 + ".d_dmbd.id) where gia_bh=0 and mabd in(select id from " + user1 + ".d_dmbd where gia_bh>0) ";
            execute_data(sql);
            sql = "update " + s_user + ".d_tienthuoc set gia_bh=(select max(gia_bh) as gia_bh from " + user1 + ".d_dmbd  where " + s_user + ".d_tienthuoc.mabd=" + user1 + ".d_dmbd.id) where gia_bh=0 and mabd in(select id from " + user1 + ".d_dmbd where gia_bh>0) ";
            execute_data(sql);
            //
            sql = "select ngaynghi  from " + s_user + ".bhytkb where 1=2";
            ds = get_data(sql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                sql = "alter table " + s_user + ".bhytkb add ngaynghi numeric default 0;";
                execute_data(sql, false);
            }
            sql = "select id_lydokham, id_lydodungtuyen  from " + s_user + ".lydokham where 1=2";
            ds = get_data(sql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                sql = "alter table " + s_user + ".lydokham add id_lydokham text default '+';";
                execute_data(sql, false);
                sql = "alter table " + s_user + ".lydokham add id_lydodungtuyen text default '+';";
                execute_data(sql, false);
            }

            sql = "select idduoc  from " + s_user + ".v_chidinh where 1=2";
            ds = get_data(sql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                sql = "alter table " + s_user + ".v_chidinh add idduoc numeric default 0;";
                execute_data(sql, false);

            }

            sql = "select done  from " + s_user + ".d_xuatsdct where 1=2";
            ds = get_data(sql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                sql = "alter table " + s_user + ".d_xuatsdct add done numeric(1) default 0;";
                execute_data(sql, false);

            }

            sql = "select thanhtoan  from " + s_user + ".v_vienphill where 1=2";
            ds = get_data(sql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                sql = "alter table " + s_user + ".v_vienphill add thanhtoan numeric(2) default 0 ";
                execute_data(sql, false);
            }
            sql = "select thanhtoan  from " + s_user + ".v_ttrvll where 1=2";
            ds = get_data(sql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                sql = "alter table " + s_user + ".v_ttrvll add thanhtoan numeric(2) default 0 ";
                execute_data(sql, false);
            }
            sql = "select idphongcls, sttcho  from " + s_user + ".v_vienphict where 1=2";
            ds = get_data(sql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                sql = "alter table " + s_user + ".v_vienphict add idphongcls numeric(5) default 0 ";
                execute_data(sql, false);
                sql = "alter table " + s_user + ".v_vienphict add sttcho numeric(5) default 0 ";
                execute_data(sql, false);
            }
            sql = "select idphongcls, sttcho, mien  from " + s_user + ".v_ttrvct where 1=2";
            ds = get_data(sql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                sql = "alter table " + s_user + ".v_ttrvct add idphongcls numeric(5) default 0 ";
                execute_data(sql, false);
                sql = "alter table " + s_user + ".v_ttrvct add sttcho numeric(5) default 0 ";
                execute_data(sql, false);
                sql = "alter table " + s_user + ".v_ttrvct add mien numeric default 0 ";
                execute_data(sql, false);
            }
            sql = "select phuthu  from " + s_user + ".v_ttrvct where 1=2";
            ds = get_data(sql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                sql = "alter table " + s_user + ".v_ttrvct add phuthu numeric(1) default 0 ";
                execute_data(sql, false);
            }
            sql = "select xn_guidi  from " + s_user + ".v_chidinh where 1=2";
            ds = get_data(sql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                sql = "alter table " + s_user + ".v_chidinh add xn_guidi numeric(1) default 0 ";
                execute_data(sql, false);
            }
            sql = "select ghichu  from " + s_user + ".d_thuocbhytct where 1=2";
            ds = get_data(sql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                sql = "alter table " + s_user + ".d_thuocbhytct add ghichu text ";
                execute_data(sql, false);
            }
            sql = "select ngaygiodangky, mabs, idloaitg  from " + s_user + ".v_ttrvct where 1=2";
            ds = get_data(sql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                sql = "alter table " + s_user + ".v_ttrvct add ngaygiodangky timestamp ;";
                execute_data(sql, false);
                sql = "alter table " + s_user + ".v_ttrvct add idloaitg number(2) default 0 ;";
                execute_data(sql, false);
                sql = "alter table " + s_user + ".v_ttrvct add mabs varchar2(4) ;";
                execute_data(sql, false);
            }
            sql = "select sokham from " + s_user + ".v_ttrvll where 1=2";
            ds = get_data(sql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                sql = "alter table " + s_user + ".v_ttrvll add sokham varchar2(20) ;";
                execute_data(sql, false);
            }
            sql = "select id from " + s_user + ".v_capsokham  where 1=2";
            ds = get_data(sql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                sql = "create table medibv.v_capsokham (id numeric, ddmmyy varchar(6), loai varchar(2), chinhanh numeric(2) default 0, ngayud timestamp default now(), stt numeric default 0, constraint pk_v_capsokham primary key(id,ddmmyy, loai, chinhanh)USING INDEX TABLESPACE medi_index) WITH OIDS; ";
                execute_data(sql, false);
            }
            sql = "select idttrv from " + s_user + ".bhytkb where 1=2";
            ds = get_data(sql, false);
            if (ds == null || ds.Tables.Count <= 0)
            {
                sql = "alter table " + s_user + ".bhytkb add idttrv numeric default 0 ;";
                execute_data(sql, false);
            }
            //end mmyy
        }

        public void f_tangmabn_10kytu()
        {
            string sql = " select 'alter table '||table_schema||'.'||table_name|| ' alter column '||column_name||' type varchar(10);' as ten from information_schema.columns  where table_catalog='" + database + "' and table_schema='medibv'  and column_name='mabn' and data_type='character varying' and character_maximum_length=8 ";
            DataSet lds = get_data(sql);
            lds.WriteXml("..//tangid.xml", XmlWriteMode.WriteSchema);

            if (System.IO.File.Exists("..//tangid.xml"))
            {
                ds = new DataSet();
                ds.ReadXml("..//tangid.xml");
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                con.Open();
                foreach (DataRow r in ds.Tables[0].Rows)
                {
                    sql = r["ten"].ToString().Trim();
                    try
                    {
                        cmd = new NpgsqlCommand(sql, con);
                        cmd.CommandType = CommandType.Text;
                        cmd.ExecuteNonQuery();
                        cmd.Dispose();
                    }
                    catch { cmd.Dispose(); }
                }
                con.Close(); con.Dispose();
            }
        }
        public void f_tangmabn_10kytu(string m_mmyy)
        {
            string sql = " select 'alter table '||table_schema||'.'||table_name|| ' alter column '||column_name||' type varchar(10);' as ten from information_schema.columns  where table_catalog='" + database + "' and table_schema='medibv" + m_mmyy + "'  and column_name in('mabn','sophieu') and data_type='character varying' and character_maximum_length=8 ";
            DataSet lds = get_data(sql);
            lds.WriteXml("..//tangid.xml", XmlWriteMode.WriteSchema);

            if (System.IO.File.Exists("..//tangid.xml"))
            {
                ds = new DataSet();
                ds.ReadXml("..//tangid.xml");
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                con.Open();
                foreach (DataRow r in ds.Tables[0].Rows)
                {
                    sql = r["ten"].ToString().Trim();
                    try
                    {
                        cmd = new NpgsqlCommand(sql, con);
                        cmd.CommandType = CommandType.Text;
                        cmd.ExecuteNonQuery();
                        cmd.Dispose();
                    }
                    catch { cmd.Dispose(); }
                }
                con.Close(); con.Dispose();
            }
        }

        public void f_tangsoluutru_12kytu()
        {
            string sql = " select 'alter table '||table_schema||'.'||table_name|| ' alter column '||column_name||' type varchar(12);' as ten from information_schema.columns  where table_catalog='" + database + "' and table_schema='medibv'  and column_name in('soluutru') and data_type='character varying' and character_maximum_length=10 ";
            DataSet lds = get_data(sql);
            lds.WriteXml("..//tangid.xml", XmlWriteMode.WriteSchema);

            if (System.IO.File.Exists("..//tangid.xml"))
            {
                ds = new DataSet();
                ds.ReadXml("..//tangid.xml");
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                con.Open();
                foreach (DataRow r in ds.Tables[0].Rows)
                {
                    sql = r["ten"].ToString().Trim();
                    try
                    {
                        cmd = new NpgsqlCommand(sql, con);
                        cmd.CommandType = CommandType.Text;
                        cmd.ExecuteNonQuery();
                        cmd.Dispose();
                    }
                    catch { cmd.Dispose(); }
                }
                con.Close(); con.Dispose();
            }
        }

        public void f_tangsoluutru_12kytu(string m_mmyy)
        {
            string sql = " select 'alter table '||table_schema||'.'||table_name|| ' alter column '||column_name||' type varchar(12);' as ten from information_schema.columns  where table_catalog='" + database + "' and table_schema='medibv" + m_mmyy + "'  and column_name in('soluutru') and data_type='character varying' and character_maximum_length=10 ";
            DataSet lds = get_data(sql);
            lds.WriteXml("..//tangid.xml", XmlWriteMode.WriteSchema);

            if (System.IO.File.Exists("..//tangid.xml"))
            {
                ds = new DataSet();
                ds.ReadXml("..//tangid.xml");
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                con.Open();
                foreach (DataRow r in ds.Tables[0].Rows)
                {
                    sql = r["ten"].ToString().Trim();
                    try
                    {
                        cmd = new NpgsqlCommand(sql, con);
                        cmd.CommandType = CommandType.Text;
                        cmd.ExecuteNonQuery();
                        cmd.Dispose();
                    }
                    catch { cmd.Dispose(); }
                }
                con.Close(); con.Dispose();
            }
        }
        private void f_Taodatabase_ba(string mmyy)
        {
            string xxx = user + mmyy;

            execute_data("CREATE TABLE " + xxx + ".bask_chiso(mabn varchar(10),maql numeric NOT NULL DEFAULT 0,ngay timestamp,socmnd varchar(20),capngay timestamp,tai varchar(3),lydo text,tiensu text,CONSTRAINT pk_bask_chiso PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;", false);
            execute_data("ALTER TABLE " + xxx + ".bask_chiso add mabn varchar(10)", false);
            execute_data("CREATE TABLE " + xxx + ".bask_cls(maql numeric NOT NULL DEFAULT 0,mavaovien numeric DEFAULT 0,stt numeric(3) default 0,idchidinh numeric default 0,loai numeric(1) default 0,ketluan text,  image bytea,  CONSTRAINT pk_bask_cls PRIMARY KEY (idchidinh) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;", false);
            execute_data("ALTER TABLE " + xxx + ".bask_cls add mabn varchar(10)", false);
            execute_data("CREATE TABLE " + xxx + ".bask_donvi(mabn varchar(10),maql numeric NOT NULL DEFAULT 0,madonvi numeric DEFAULT 0,mach numeric(3) DEFAULT 0,chieucao numeric(6) DEFAULT 0, nhietdo numeric(5,2) DEFAULT 0,  cannang numeric(7,2) DEFAULT 0,  huyetap varchar(7),  nhiptho numeric(3) DEFAULT 0,  CONSTRAINT pk_bask_donvi PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;", false);
            execute_data("ALTER TABLE " + xxx + ".bask_donvi add mabn varchar(10)", false);
            execute_data("CREATE TABLE " + xxx + ".bask_mat(maql numeric NOT NULL DEFAULT 0,  mavaovien numeric DEFAULT 0,  ngay timestamp,  makp varchar(3),  mat text,  thiluc text,  tlcp text,  tlct text,  tlkp text,  tlkt text,  sop text,  sot text,  sacgiac text,  khac text,  mabs varchar(4),  userid numeric(5) DEFAULT 0,  ngayud timestamp DEFAULT now(),  CONSTRAINT pk_bask_mat PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;", false);
            execute_data("ALTER TABLE " + xxx + ".bask_mat add mabn varchar(10)", false);
            execute_data("CREATE TABLE " + xxx + ".bask_ngkhoa(maql numeric NOT NULL DEFAULT 0,  mavaovien numeric DEFAULT 0,  ngay timestamp,  makp varchar(3),  ngoai text,  dalieu text,  khac text,  mabs varchar(4),  userid numeric(5) DEFAULT 0,  ngayud timestamp DEFAULT now(),CONSTRAINT pk_bask_ngkhoa PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;", false);
            execute_data("ALTER TABLE " + xxx + ".bask_ngkhoa add mabn varchar(10)", false);
            execute_data("CREATE TABLE " + xxx + ".bask_noikhoa(maql numeric NOT NULL DEFAULT 0,  mavaovien numeric DEFAULT 0,  ngay timestamp,  makp varchar(3),  toanthan text,  tonghop text,timmach text,  tamthan text,  thankinh text,  khac text,  mabs varchar(4),  userid numeric(5) DEFAULT 0,  ngayud timestamp DEFAULT now(),  CONSTRAINT pk_bask_noikhoa PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;", false);
            execute_data("ALTER TABLE " + xxx + ".bask_noikhoa add mabn varchar(10)", false);
            execute_data("CREATE TABLE " + xxx + ".bask_rmh(maql numeric NOT NULL DEFAULT 0,  mavaovien numeric DEFAULT 0,  ngay timestamp,  makp varchar(3),  rhm text,  saurang text,  nhanhu text,  matrang text,  hammat text,  khac text,  mabs varchar(4),  userid numeric(5) DEFAULT 0,  ngayud timestamp DEFAULT now(),  CONSTRAINT pk_bask_rmh PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;", false);
            execute_data("ALTER TABLE " + xxx + ".bask_rhm add mabn varchar(10)", false);
            execute_data("CREATE TABLE " + xxx + ".bask_sanphu(maql numeric NOT NULL DEFAULT 0,  mavaovien numeric DEFAULT 0,  ngay timestamp,  makp varchar(3),  san text,  phu text,  khac text,  mabs varchar(4),  userid numeric(5) DEFAULT 0,  ngayud timestamp DEFAULT now(),  CONSTRAINT pk_bask_sanphu PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;", false);
            execute_data("ALTER TABLE " + xxx + ".bask_sanphu add mabn varchar(10)", false);
            execute_data("CREATE TABLE " + xxx + ".bask_tmh(maql numeric NOT NULL DEFAULT 0,  mavaovien numeric DEFAULT 0,  ngay timestamp,  makp varchar(3),  tmh text,  thuongt text,  thamt text,  thuongp text,  thamp text,  khac text,  mabs varchar(4),  userid numeric(5) DEFAULT 0,  ngayud timestamp DEFAULT now(),  CONSTRAINT pk_bask_tmh PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;", false);
            execute_data("ALTER TABLE " + xxx + ".bask_tmh add mabn varchar(10)", false);
            execute_data("CREATE TABLE " + xxx + ".bask_tongket(maql numeric NOT NULL DEFAULT 0,  mavaovien numeric DEFAULT 0,  ngay timestamp,  makp varchar(3),  phanloai numeric(2) DEFAULT 0,  ketluan text,  khac text,  mabs varchar(4),  userid numeric(5) DEFAULT 0,  ngayud timestamp DEFAULT now(),  CONSTRAINT pk_bask_tongket PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;", false);
            execute_data("ALTER TABLE " + xxx + ".bask_tongket add mabn varchar(10)", false);
            execute_data("CREATE TABLE " + xxx + ".BAVV_CHUNG(MAQL NUMERIC(22,0), LYDO TEXT, HB_BENHLY TEXT, HB_BANTHAN TEXT, HB_GIADINH TEXT, KB_TOANTHAN TEXT, KB_BOPHAN TEXT, KB_TOMTAT TEXT, KB_XULI TEXT, KB_CHUY TEXT, SOBO TEXT, PHANBIET TEXT, USERID NUMERIC, NGAYUD timestamp DEFAULT now(),CONSTRAINT PK_BAVV_CHUNG PRIMARY KEY (MAQL) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;", false);
            execute_data("ALTER TABLE " + xxx + ".BAVV_CHUNG add mabn varchar(10)", false);
            execute_data("CREATE TABLE " + xxx + ".BAVV_DAUSINHTON(MAQL NUMERIC(22,0),MACH NUMERIC(3,0) DEFAULT 0,NHIETDO NUMERIC(5,2) DEFAULT 0,HUYETAP VARCHAR(7), NHIPTHO NUMERIC(3,0) DEFAULT 0, CANNANG NUMERIC(7,2) DEFAULT 0, CHIEUCAO NUMERIC(5,0) DEFAULT 0,CONSTRAINT PK_BAVV_DAUSINHTON PRIMARY KEY (MAQL) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;", false);
            execute_data("ALTER TABLE " + xxx + ".BAVV_DAUSINHTON add mabn varchar(10)", false);
            execute_data("CREATE TABLE " + xxx + ".STTNGAY(NGAY timestamp,SO numeric(5,0),CONSTRAINT PK_BAVV_STTNGAY PRIMARY KEY (NGAY) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;", false);
            execute_data("CREATE TABLE " + xxx + ".BAVV_TMH(MAQL numeric(22,0),TAI text,MUI text,HONG text,KHAM text,IMAGE1 bytea,IMAGE2 bytea,IMAGE3 bytea,IMAGE4 bytea,CONSTRAINT PK_BAVV_TMH PRIMARY KEY (MAQL) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;", false);
            execute_data("ALTER TABLE " + xxx + ".BAVV_TMH add mabn varchar(10)", false);
            execute_data("CREATE TABLE " + xxx + ".BAVV_RHM(MAQL numeric(22,0),IMAGE bytea,NHANXET text,CHANDOAN text,CONSTRAINT PK_BAVV_RHM PRIMARY KEY (MAQL) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;", false);
            execute_data("ALTER TABLE " + xxx + ".BAVV_RHM add mabn varchar(10)", false);
            execute_data("CREATE TABLE " + xxx + ".BAVV_MAT(MAQL numeric(22,0),KB_MAT text,TLKK_MP text,TLKK_MT text,TLCK_MP text,TLCK_MT text,NA_MP text,NA_MT text,TT_MP text,TT_MT text,CONSTRAINT PK_BAVV_MAT PRIMARY KEY (MAQL) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;", false);
            execute_data("ALTER TABLE " + xxx + ".BAVV_MAT add mabn varchar(10)", false);
            execute_data("CREATE TABLE " + xxx + ".BAVV_TMHCT(MAQL numeric(22,0),STT text,TAIP text,TAIT text,CONSTRAINT PK_BAVV_TMHCT PRIMARY KEY (MAQL) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;", false);
            execute_data("create table " + xxx + ".ba_locmaull(ID numeric(22,0),IDTHUCHIEN numeric(22,0),NGAYBD timestamp,CANTLOC numeric(7,2),RUTNUOC numeric(5,0),DICHVAMAU numeric(5,0),CANSLOC numeric(7,2),FAV numeric(1,0),TTMD numeric(1,0),MTCT numeric(1,0),TMDD numeric(1,0),HEPARIN numeric(1,0),TLPT numeric(1,0),LIEUDAU text,DUYTRI text,TONGLIEU text,LIENTUC numeric(1,0),CACHQUANG numeric(1,0),KHAC text,NGAYKT timestamp,MANGLOC text,NHANHIEU text,DIENTICH text,HESO text,BAOQUAN text,LANDUNG numeric(5,0),MABS VARCHAR(4),YTA VARCHAR(4),USERID  numeric(5,0),NGAYUD timestamp DEFAULT sysdate,CONSTRAINT PK_BAVV_LOCMAULL PRIMARY KEY (ID) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;", false);
            execute_data("ALTER TABLE " + xxx + ".ba_locmaull add mabn varchar(10)", false);
            execute_data("create table " + xxx + ".ba_locmauct(ID numeric(22,0),STT numeric(5,0),NGAY DATE,MACH numeric(3,0),HUYETAP VARCHAR(7),NHIETDO numeric(5,2),NHIPTHO numeric(3,0),TOCDO numeric(5,0),DM text,TM text,SIEULOC numeric(7,0),TAIBIEN text,THUOC text,MABS VARCHAR(4),YTA VARCHAR(4),CONSTRAINT PK_BAVV_LOCMAUCT PRIMARY KEY (ID) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;", false);
            execute_data("create table " + xxx + ".ba_thuchien(ID numeric(22,0),MABN VARCHAR(10),MAQL numeric(22,0),IDKHOA numeric(22,0),makp varchar(3),PHONG VARCHAR(10),GIUONG VARCHAR(20),CHANDOAN text,CONSTRAINT PK_BAVV_THUCHIEN PRIMARY KEY (ID) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;", false);
            execute_data("create table " + xxx + ".ba_scan(ID numeric(22,0),STT numeric(5,0),NGAY timestamp,NHOM numeric(1,0) DEFAULT 0,LOAI numeric(3,0) DEFAULT 0,TEN text,IMAGE bytea,CONSTRAINT PK_BA_SCAN PRIMARY KEY (ID) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;", false);
            execute_data("ALTER TABLE " + xxx + ".ba_scan add mabn varchar(10)", false);
            execute_data("create table " + xxx + ".ba_chung(ID numeric(22,0),IDTHUCHIEN numeric(22,0),LYDO text,LANTHU numeric(3,0) DEFAULT 0,HB_BENHLY text,HB_BANTHAN text,HB_GIADINH text,KB_TOANTHAN text,KB_NGOAI text,KB_TUANHOAN text,KB_HOHAP text,KB_TIEUHOA text,KB_THAN text,KB_THANKINH text,KB_CO text,KB_TMH text,KB_RHM text,KB_MAT text,KB_NOITIET text,KB_KHAC text,KB_TOMTAT text,PHANBIET text,TIENLUONG text,DIEUTRI text,BSLBAN VARCHAR(4),TK_BENHLY text,TK_TOMTAT text,TK_PHUONGPHAP text,TK_TINHTRANG text,TK_DIEUTRI text,NGUOIGIAO VARCHAR(4),NGUOINHAN VARCHAR(4),MABS VARCHAR(4),USERID numeric(5,0),NGAYUD timestamp DEFAULT sysdate,CONSTRAINT PK_BA_CHUNG PRIMARY KEY (ID) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;", false);
            execute_data("ALTER TABLE " + xxx + ".ba_chung add mabn varchar(10)", false);
            execute_data("create table " + xxx + ".ba_kbdausinhton(ID numeric(22,0),MACH numeric(3,0) DEFAULT 0,NHIETDO numeric(5,2) DEFAULT 0,HUYETAP VARCHAR(7),NHIPTHO numeric(3,0) DEFAULT 0,CANNANG numeric(7,2) DEFAULT 0,CHIEUCAO numeric(5,0) DEFAULT 0,CONSTRAINT PK_BA_KBDAUSINHTON PRIMARY KEY (ID) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;", false);
            execute_data("ALTER TABLE " + xxx + ".ba_kbdausinhton add mabn varchar(10)", false);
            execute_data("create table " + xxx + ".ba_tkhoso(ID numeric(22,0),MA numeric(3,0),KHAC text,SO numeric(5,0) DEFAULT 0,CONSTRAINT PK_BA_TKHOSO PRIMARY KEY (ID) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;", false);
            execute_data("ALTER TABLE " + xxx + ".ba_tkhoso add mabn varchar(10)", false);
            execute_data("create table " + xxx + ".ba_dieutri(ID numeric(22,0),IDTHUCHIEN numeric(22,0),SOPHIEU numeric(7,0) DEFAULT 0,NGAY timestamp,DIENBIEN text,YLENH text,IDYLENH numeric(22,0),CHEDOAN numeric(3,0),MABS VARCHAR(4),LOAI numeric(1,0) DEFAULT 0,SANKHOA numeric(22,0) DEFAULT 0,DONE numeric(1,0) DEFAULT 0,USERID numeric(5,0),NGAYUD timestamp DEFAULT now(),CONSTRAINT PK_BA_DIEUTRI PRIMARY KEY (ID) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;", false);
            execute_data("ALTER TABLE " + xxx + ".ba_dieutri add mabn varchar(10)", false);
            execute_data("create table " + xxx + ".ba_dieutrict(ID numeric(22,0),STT numeric(3,0),LOAI numeric(2,0),NOIDUNG text,GHICHU text,THUCHIEN text,CONSTRAINT PK_BA_DIEUTRICT PRIMARY KEY (ID,STT) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;", false);
            execute_data("create table " + xxx + ".ba_chamsoc(ID numeric(22,0),IDTHUCHIEN numeric(22,0),NGAY timestamp,SOPHIEU numeric(7,0) DEFAULT 0,MACH numeric(3,0) DEFAULT 0,HUYETAP VARCHAR(7),NHIETDO numeric(5,2) DEFAULT 0,NHIPTHO numeric(3,0) DEFAULT 0,DIENBIEN text,YLENH text,YTA VARCHAR(4),USERID numeric(5,0),IDDIEUTRI numeric(22,0) DEFAULT 0,NGAYUD timestamp DEFAULT sysdate,CONSTRAINT PK_BA_CHAMSOC PRIMARY KEY (ID) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;", false);
            execute_data("ALTER TABLE " + xxx + ".ba_chamsoc add mabn varchar(10)", false);
            execute_data("create table " + xxx + ".ba_chamsocct(ID numeric(22,0),STT numeric(3,0),LOAI numeric(2,0),NOIDUNG text,GHICHU text,THUCHIEN text,CONSTRAINT PK_BA_CHAMSOCCT PRIMARY KEY (ID,STT) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;", false);
            execute_data("create table " + xxx + ".ba_linhmau(ID numeric(22,0),IDTHUCHIEN numeric(22,0),SOPHIEU VARCHAR(10),NGAYLINH timestamp,DONVI text,CHEPHAM text,NHOMMAU numeric(1,0) DEFAULT 0,LANTHU numeric(3,0) DEFAULT 0,NGUOILINH VARCHAR(4),BSDT VARCHAR(4),PHONGPHAT text,BVPHAT text,DVPHAT text,NGAYPHAT DATE,NGUOIPHAT VARCHAR(4),TRUONGKHOA VARCHAR(4),DONE numeric(1,0) DEFAULT 0,USERID numeric(5,0) DEFAULT 0,NGAYUD timestamp DEFAULT now(),CONSTRAINT PK_BA_LINHMAU PRIMARY KEY (ID) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;", false);
            execute_data("ALTER TABLE " + xxx + ".ba_linhmau add mabn varchar(10)", false);
            execute_data("create table " + xxx + ".ba_linhmauct(ID numeric(22,0),STT numeric(3,0),CHEPHAM text,MASO VARCHAR(10),NHOMMAU numeric(1,0) DEFAULT 0,CONSTRAINT PK_BA_LINHMAUCT PRIMARY KEY (ID,STT) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;", false);
            execute_data("create table " + xxx + ".ba_truyenmau(ID numeric(22,0),IDTHUCHIEN numeric(22,0),NGAY timestamp,CHEPHAM text,MASO VARCHAR(10),NGAYLAY timestamp,HANDUNG timestamp,SOLUONG text,NOILAM text,KYTHUAT text,SINHPHAM text,HBSAG numeric(1,0),HCV numeric(1,0),GIANGMAI numeric(1,0),SOTRET numeric(1,0),NGUOICHO numeric(1,0),BENHNHAN numeric(1,0),ONG1 text,ONG2 text,TRUONGKHOA VARCHAR(4),KTV1 VARCHAR(4),KTV2 VARCHAR(4),CHEPHAMTR text,MASOTR VARCHAR(10),HANDUNGTR timestamp,LANTHU numeric(3,0),BSCD VARCHAR(4),NGUOICHOTR numeric(1,0) DEFAULT 0,BENHNHANTR numeric(1,0) DEFAULT 0,TAI text,SOLUONGTR text,BATDAU timestamp,KETTHUC timestamp,SOLUONGTHUC text,SACMAT text,NHIPTHO numeric(3,0) DEFAULT 0,NHIETDO numeric(5,2) DEFAULT 0,HUYETAP VARCHAR(7),MACH numeric(3,0) DEFAULT 0,DIENBIEN text,BSTH VARCHAR(4),YTA VARCHAR(4),IDLINH numeric(22,0) DEFAULT 0,USERID numeric(5,0) DEFAULT 0,NGAYUD timestamp DEFAULT sysdate,CONSTRAINT PK_BA_TRUYENMAU PRIMARY KEY (ID) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;", false);
            execute_data("ALTER TABLE " + xxx + ".ba_truyenmau add mabn varchar(10)", false);
            execute_data("create table " + xxx + ".ba_truyenmauct(ID numeric(22,0),STT numeric(3,0),NGAY timestamp,SACMAT text,NHIPTHO numeric(3,0) DEFAULT 0,NHIETDO numeric(5,2) DEFAULT 0,HUYETAP VARCHAR(7),MACH numeric(3,0) DEFAULT 0,DIENBIEN text,CONSTRAINT PK_BA_TRUYENMAUCT PRIMARY KEY (ID,STT) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;", false);
            execute_data("create table " + xxx + ".ba_truyendich(ID numeric(22,0),IDTHUCHIEN numeric(22,0),NGAY timestamp,USERID numeric(5,0),NGAYUD timestamp DEFAULT now(),CONSTRAINT PK_BA_TRUYENDICH PRIMARY KEY (ID) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;", false);
            execute_data("ALTER TABLE " + xxx + ".ba_truyendich add mabn varchar(10)", false);
            execute_data("create table " + xxx + ".ba_truyendichct(ID numeric(22,0),STT numeric(3,0),TEN text,SOLUONG numeric(7,2) DEFAULT 0,LOSX VARCHAR(20),TOCDO text DEFAULT 0,BATDAU timestamp,KETTHUC timestamp,BSCD VARCHAR(4),YTA VARCHAR(4),GHICHU text,USERID numeric(5,0),NGAYUD timestamp DEFAULT now(),CONSTRAINT PK_BA_TRUYENDICHCT PRIMARY KEY (ID,STT) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;", false);
            execute_data("create table " + xxx + ".ba_puthuoc(ID numeric(22,0),IDTHUCHIEN numeric(22,0),NGAY timestamp,TEN text,PHUONGPHAP text,BSCD VARCHAR(4),NGUOITHU VARCHAR(4),BSDOC VARCHAR(4),KETQUA text,USERID numeric(5,0),NGAYUD timestamp DEFAULT now(),CONSTRAINT PK_BA_PUTHUOC PRIMARY KEY (ID) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;", false);
            execute_data("ALTER TABLE " + xxx + ".ba_puthuoc add mabn varchar(10)", false);
            execute_data("CREATE TABLE " + user + ".dmdangkt(id numeric(2) NOT NULL DEFAULT 0,ten text,CONSTRAINT pk_dmdangkt PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE medibv.dmdangkt OWNER TO medisoft;", false);
            execute_data("CREATE TABLE " + user + ".dmmucdokt(id numeric(2) NOT NULL DEFAULT 0,ten text,CONSTRAINT pk_dmmucdokt PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE medibv.dmmucdokt OWNER TO medisoft;", false);
            execute_data("CREATE TABLE " + user + ".khuyettat(maql numeric(22,0) NOT NULL DEFAULT 0,mabn varchar(10),ngay timestamp,id_dang numeric(2),id_mucdo numeric(2),chandoan text,CONSTRAINT pk_khuyettat PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE medibv.khuyettat OWNER TO medisoft;", false);
            execute_data("ALTER TABLE " + user + ".khuyettat add id numeric", false);
            execute_data("alter table " + user + ".khuyettat drop CONSTRAINT pk_khuyettat;", false);
            execute_data("alter table " + user + ".khuyettat add CONSTRAINT pk_khuyettat PRIMARY KEY(id);", false);
            execute_data("create table " + user + ".phanungthuoc_adr(id numeric,mabn varchar(10),maql numeric,mavaovien numeric,msbcdonvi varchar(20),msbctt varchar(20),cannang numeric(7,2) DEFAULT 0,chieucao numeric(5) DEFAULT 0,ngayphanung timestamp,motaphanung text,chandoandieutri text,taisudungthuoc text,trieuchungcu numeric(1) default 0,thuocsudungdongthoi text,benhsulienquan text,userid numeric(5),ngayud timestamp default now(),ngaybaocao timestamp,dangbaocao numeric(1) default 0,CONSTRAINT pk_phanungthuoc_adr PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE medibv.phanungthuoc_adr OWNER TO medisoft;", false);
            execute_data("create table " + user + ".thuocnghingo_adr(id numeric,stt numeric(4),mabd numeric(7),lieudungmotlan text,solantrongngay numeric(2),ngaybatdau timestamp,ngayketthuc timestamp,losx varchar(20),userid numeric(5),ngayud timestamp default now(),CONSTRAINT pk_thuocnghingo_adr PRIMARY KEY (id,stt) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE medibv.thuocnghingo_adr OWNER TO medisoft;", false);
            execute_data("create table " + user + ".xutri_adr(id numeric,ngungdungthuoc text,ngung_tientrien numeric(1) default 0,ngung_dieutri numeric(1) default 0,sudungthuockhac text,sudung_tientrien numeric(1) default 0,sudung_dieutri numeric(1) default 0,ketquaxutriADR numeric(7),bsbinhluan text,thamdinhADR_dvyte numeric(1) default 0,thamdinhADR_chuyengia numeric(1) default 0,ykienchuyengia text,userid numeric(5),ngayud timestamp default now(),CONSTRAINT pk_xutri_adr PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE medibv.xutri_adr OWNER TO medisoft;", false);
            execute_data("create table " + user + ".dmkq_adr(id numeric(7),ten text,CONSTRAINT pk_dmkq_adr PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE medibv.dmkq_adr OWNER TO medisoft;", false);
            execute_data("create table " + user + ".bavv_mat(maql numeric,ledao_mp text,mimat_mp text,thmathot_mp text,giacmac_mp text,cungmac_mp text,tienphong_mp text,mongmat_mp text,dongtupxa_mp text,thuytinhthe_mp text,thuytinhdich_mp text,soianhdongtu_mp text,thnhancau_mp text,homat_mp text,daymat_mp text,ledao_mt text,mimat_mt text,thmathot_mt text,giacmac_mt text,cungmac_mt text,tienphong_mt text,mongmat_mt text,dongtupxa_mt text,thuytinhthe_mt text,thuytinhdich_mt text,soianhdongtu_mt text,thnhancau_mt text,homat_mt text,daymat_mt text,CONSTRAINT pk_bavv_mat PRIMARY KEY (maql) USING INDEX TABLESPACE medi_index) WITH OIDS;ALTER TABLE medibv.bavv_mat OWNER TO medisoft;", false);
            execute_data("ALTER TABLE " + user + ".bavv_mat add mabn varchar(10)", false);
            execute_data("alter table " + user + ".bavv_mat add ketmac_mp text;", false);
            execute_data("alter table " + user + ".bavv_mat add ketmac_mt text;", false);
            execute_data("alter table " + xxx + ".bavv_tmhct drop CONSTRAINT pk_bavv_tmhct;", false);
            execute_data("alter table " + xxx + ".bavv_tmhct add CONSTRAINT pk_bavv_tmhct PRIMARY KEY (maql,stt) USING INDEX TABLESPACE medi_index;", false);
            execute_data("alter table " + xxx + ".pttt add bienchung numeric(1);", false);
            execute_data("alter table " + xxx + ".bavv_mat add hinh bytea;", false);
            execute_data("alter table " + xxx + ".bavv_mat add nhanxet text;", false);
            execute_data("alter table " + xxx + ".bavv_mat add chandoan text;", false);
            execute_data("alter table " + user + ".khuyettat add ghichu text;", false);
            execute_data("alter table " + user + ".khuyettat add CONSTRAINT fk_khuyettat_dmdangkt FOREIGN KEY (id_dang) REFERENCES medibv.dmdangkt(id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT;", false);
            execute_data("alter table " + user + ".khuyettat add CONSTRAINT fk_khuyettat_dmmucdokt FOREIGN KEY (id_mucdo) REFERENCES medibv.dmmucdokt(id) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT;", false);
            execute_data("alter table " + xxx + ".ba_thuchien add CONSTRAINT fk_ba_thuchien_btdbn FOREIGN KEY (mabn) REFERENCES medibv.btdbn (mabn) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT;", false);
            execute_data("alter table " + user + ".khuyettat add CONSTRAINT fk_khuyettat_btdbn FOREIGN KEY (mabn) REFERENCES medibv.btdbn (mabn) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT;", false);
            execute_data("alter table " + user + ".phanungthuoc_adr add CONSTRAINT fk_phanungthuoc_adr_btdbn FOREIGN KEY (mabn) REFERENCES medibv.btdbn (mabn) MATCH SIMPLE ON UPDATE RESTRICT ON DELETE RESTRICT;", false);
            execute_data("alter table " + user + ".d_dmnx add column hide numeric(1) default 0;", false);
            execute_data("alter table " + xxx + ".v_ttrvll add column thua numeric(15,4) DEFAULT 0;", false);
            execute_data("CREATE TABLE " + user + ".benhantc(mabn varchar(10) NOT NULL,maql numeric(30) NOT NULL, mavaovien numeric(30), ngay timestamp NOT NULL, benh text,diung text, phanungthuoc text, dongkinh text, ungthu text, benhbathang text, benhmotnam text, thai text, vacxin text, nhanxet text, ngayud timestamp DEFAULT now(),userid text) WITHOUT OIDS;ALTER TABLE " + user + ".benhantc OWNER TO medisoft;", false);
            execute_data("alter table " + user + ".benhantc add CONSTRAINT pk_benhantc PRIMARY KEY(mavaovien);", false);
            execute_data("CREATE TABLE " + xxx + ".BA_VANCHUYEN(ID numeric(22,0), IDTHUCHIEN numeric(22,0), NGAY timestamp, KHOADEN text, NGAYVV timestamp, NGAYRK timestamp, NGAYVK timestamp, M_CC numeric(5,0), HA_CC varchar(7), NT_CC numeric(5,0), T_CC numeric(7,2), TG_CC numeric(1,0), M_VC numeric(5,0), HA_VC varchar(7), NT_VC numeric(5,0), T_VC numeric(7,2), TG_VC numeric(1,0), M_KD numeric(5,0), HA_KD varchar(7), NT_KD numeric(5,0), T_KD numeric(7,2), TG_KD numeric(1,0), BS_CC varchar(4), DD_CC varchar(4), BS_VC varchar(4), DD_VC varchar(4), BS_KD varchar(4), DD_KD varchar(4), KHAC text, LUC timestamp, VEDENKHOA timestamp, THANGMAY numeric(3,0), PHONGMO numeric(3,0), NHANBENH numeric(3,0), USERID numeric(5,0), NGAYUD timestamp DEFAULT now(),CONSTRAINT pk_ba_vanchuyen PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS; ALTER TABLE " + xxx + ".ba_vanchuyen OWNER TO medisoft;", false);
            execute_data("ALTER TABLE " + xxx + ".BA_VANCHUYEN add mabn varchar(10)", false);
            execute_data("CREATE TABLE " + xxx + ".BA_VANCHUYENCT(ID numeric(22,0),STT numeric(3,0),CC numeric(1,0) DEFAULT 0,VC numeric(1,0) DEFAULT 0,KD numeric(1,0) DEFAULT 0,CONSTRAINT pk_ba_vanchuyenct PRIMARY KEY (id,stt) USING INDEX TABLESPACE medi_index) WITH OIDS; ALTER TABLE " + xxx + ".ba_vanchuyenct OWNER TO medisoft;", false);
            execute_data("CREATE TABLE " + xxx + ".BA_HOICHANCC(ID numeric(22,0), IDTHUCHIEN numeric(22,0), NGAY timestamp, NGAYMO timestamp, MAMAU VARCHAR(10),TENPT text, NHOMMAU numeric(1,0), RH numeric(1,0) DEFAULT 0, MAU numeric(7,0) DEFAULT 0, XNKHAC text, PTDUTRU VARCHAR(4), PTCHINH VARCHAR(4), PTPHU VARCHAR(4),PHUONGPHAP numeric(2,0) DEFAULT 0, TUTHE text, YKIEN text, BSTRUONGK VARCHAR(4), BSTRUONG VARCHAR(4), PTV VARCHAR(4), TIENSU text, TIM text, PHOI text, TIENLUONG text, KHAC text, COTSONG text, THANKINH text, ANLANCUOI text, ASA VARCHAR(3), GLODMANN VARCHAR(3), MALLAMPATI VARCHAR(3),BSGAYME VARCHAR(4),BSTRUONGGMHS VARCHAR(4),USERID numeric(5,0), NGAYUD timestamp DEFAULT now(),CONSTRAINT pk_BA_HOICHANCC PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS; ALTER TABLE " + xxx + ".BA_HOICHANCC OWNER TO medisoft;", false);
            execute_data("ALTER TABLE " + xxx + ".BA_HOICHANCC add mabn varchar(10)", false);
            execute_data("CREATE TABLE " + xxx + ".BA_KIEMSOATCC(ID numeric(22,0),IDTHUCHIEN numeric(22,0),NGAY timestamp,NHANXET text,DDTRUONG VARCHAR(4),DDPMO VARCHAR(4),DDPHUTRACH VARCHAR(4),USERID numeric(5,0),NGAYUD timestamp DEFAULT now(),CONSTRAINT pk_BA_KIEMSOATCC PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS; ALTER TABLE " + xxx + ".BA_KIEMSOATCC OWNER TO medisoft;", false);
            execute_data("ALTER TABLE " + xxx + ".BA_KIEMSOATCC add mabn varchar(10)", false);
            execute_data("CREATE TABLE " + xxx + ".BA_KIEMSOATCCCT(ID numeric(22,0),MA numeric(3,0),COKHONG numeric(1,0) DEFAULT 0,GHICHU text,CONSTRAINT pk_BA_KIEMSOATCCCT PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS; ALTER TABLE " + xxx + ".BA_KIEMSOATCCCT OWNER TO medisoft;", false);
            execute_data("CREATE TABLE " + xxx + ".BA_HOICHAN(ID numeric(22,0), IDTHUCHIEN numeric(22,0), NGAY timestamp, NGAYMO timestamp, MAMAU VARCHAR(10), TENPT text, THOIGIAN text, SONDE numeric(1,0) DEFAULT 0, NHOMMAU numeric(1,0), RH numeric(1,0) DEFAULT 0, MAU numeric(7,0) DEFAULT 0, XNKHAC text, PTDUTRU VARCHAR(4), PTCHINH VARCHAR(4), PTPHU VARCHAR(4), PHUONGPHAP numeric(2,0) DEFAULT 0, TUTHE text, XQ numeric(1,0) DEFAULT 0, DUNGCU text, KHAC text, YKIEN text, GIAMDOC VARCHAR(4), KHTH VARCHAR(4), GAYME VARCHAR(4), BSTRUONGK VARCHAR(4), PTV VARCHAR(4), USERID numeric(5,0), NGAYUD timestamp DEFAULT now(),CONSTRAINT pk_BA_HOICHAN PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS; ALTER TABLE " + xxx + ".BA_HOICHAN OWNER TO medisoft;", false);
            execute_data("ALTER TABLE " + xxx + ".BA_HOICHAN add mabn varchar(10)", false);
            execute_data("CREATE TABLE " + xxx + ".BA_HOICHANXN(ID numeric(22,0),MA numeric(3,0),TINHTRANG numeric(7,2) DEFAULT 0,CONSTRAINT pk_BA_HOICHANXN PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS; ALTER TABLE " + xxx + ".BA_HOICHANXN OWNER TO medisoft;", false);
            execute_data("ALTER TABLE " + xxx + ".BA_HOICHANXN add mabn varchar(10)", false);
            execute_data("CREATE TABLE " + xxx + ".BA_KHAMTIENME(ID numeric(22,0), NGAY timestamp, MO text, METE numeric(1,0) DEFAULT 0, TAIBIEN numeric(1,0) DEFAULT 0, TRUYENMAU numeric(1,0) DEFAULT 0, DIUNG text, BIEUHIEN text, THUOCLA numeric(1,0) DEFAULT 0, RUOU numeric(1,0) DEFAULT 0, MATUY numeric(1,0) DEFAULT 0, CAOHA numeric(1,0) DEFAULT 0, THATNGUC numeric(1,0) DEFAULT 0, NMCT numeric(1,0) DEFAULT 0, SUYTIM numeric(1,0) DEFAULT 0, TIMBAMSINH numeric(1,0) DEFAULT 0, LAO numeric(1,0) DEFAULT 0, PHEQUAN numeric(1,0) DEFAULT 0, HORAMAU numeric(1,0) DEFAULT 0, COPD numeric(1,0) DEFAULT 0, HH_KHAC numeric(1,0) DEFAULT 0, TAMTHAN numeric(1,0) DEFAULT 0, DONGKINH numeric(1,0) DEFAULT 0, TBMMN numeric(1,0) DEFAULT 0, BUOUCO numeric(1,0) DEFAULT 0, MAUKDONG numeric(1,0) DEFAULT 0, TIEUDUONG numeric(1,0) DEFAULT 0, HETHONG numeric(1,0) DEFAULT 0, TK_KHAC numeric(1,0) DEFAULT 0, CAUTHAN numeric(1,0) DEFAULT 0, SUYTHAN numeric(1,0) DEFAULT 0, SOITHAN numeric(1,0) DEFAULT 0, TN_KHAC numeric(1,0) DEFAULT 0, VANGDA numeric(1,0) DEFAULT 0, VIEMGAN numeric(1,0) DEFAULT 0, TIEUHOA numeric(1,0) DEFAULT 0, THUONGVI numeric(1,0) DEFAULT 0, TH_KHAC numeric(1,0) DEFAULT 0, GIADINH text, CHITIET text, MAP numeric(1,0) DEFAULT 0, PHU numeric(1,0) DEFAULT 0, HONG numeric(1,0) DEFAULT 0, NHOT numeric(1,0) DEFAULT 0, YEU numeric(1,0) DEFAULT 0, KHOTHO numeric(1,0) DEFAULT 0, GLASGOW numeric(5,0) DEFAULT 0, MACH numeric(3,0) DEFAULT 0, HUYETAP varchar(7), NHIETDO numeric(5,2) DEFAULT 0, NHIPTHO numeric(3,0) DEFAULT 0, CANNANG numeric(7,2) DEFAULT 0, CHIEUCAO numeric(5,0) DEFAULT 0, HANCHE numeric(1,0) DEFAULT 0, CONGAN numeric(1,0) DEFAULT 0, LUOITO numeric(1,0) DEFAULT 0, KHOIU numeric(1,0) DEFAULT 0, GIAP numeric(1,0) DEFAULT 0, CUNGHAM numeric(1,0) DEFAULT 0, SEO numeric(1,0) DEFAULT 0, RANGGIA numeric(1,0) DEFAULT 0, TL_KHAC text, TIMMACH numeric(1,0) DEFAULT 0, HOHAP numeric(1,0) DEFAULT 0, THAN numeric(1,0) DEFAULT 0, K_TIEUHOA numeric(1,0) DEFAULT 0, K_KHAC numeric(1,0) DEFAULT 0, GU numeric(1,0) DEFAULT 0, CUNGCOTSONG numeric(1,0) DEFAULT 0, COTSONGCU numeric(1,0) DEFAULT 0, CANLAMSANG text, DIEUTRI text, DENGHI text, ASA varchar(3), GLODMANN varchar(3), MALLAMPATI varchar(3), DUKIEN text, THUTHUAT text, KETLUAN text, MABS varchar(4), TINHMACH text, TM_BT numeric(1,0) DEFAULT 0, TM_CHA numeric(1,0) DEFAULT 0, TM_DTN numeric(1,0) DEFAULT 0, TM_LN numeric(1,0) DEFAULT 0, TM_KHAC text, HH_BT numeric(1,0) DEFAULT 0, HH_COPD numeric(1,0) DEFAULT 0, HH_SUYEN numeric(1,0) DEFAULT 0, K_HH_KHAC text, NT_BT numeric(1,0) DEFAULT 0, NT_BG numeric(1,0) DEFAULT 0, NT_TD numeric(1,0) DEFAULT 0, NT_KHAC text, TK_BT numeric(1,0) DEFAULT 0, TK_YEU numeric(1,0) DEFAULT 0, K_TK_KHAC text,CS_BT numeric(1,0) DEFAULT 0,CS_KHAC text,CONSTRAINT pk_BA_KHAMTIENME PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS; ALTER TABLE " + xxx + ".BA_KHAMTIENME OWNER TO medisoft;", false);
            execute_data("ALTER TABLE " + xxx + ".BA_KHAMTIENME add mabn varchar(10)", false);
            execute_data("CREATE TABLE " + xxx + ".BA_KIEMSOAT(ID numeric(22,0), IDTHUCHIEN numeric(22,0), NGAY timestamp, THUOC text, TIEMBAP numeric(1,0) DEFAULT 0, TIEMTM numeric(1,0) DEFAULT 0, MACH numeric(3,0) DEFAULT 0, HUYETAP varchar(7), NHIETDO numeric(5,2) DEFAULT 0, NHIPTHO numeric(3,0) DEFAULT 0, TRIGIAC text, NHANXET text, DDTRUONG varchar(4), DDPMO varchar(4), DDPHUTRACH varchar(4), USERID numeric(5,0), NGAYUD timestamp DEFAULT now(),CONSTRAINT pk_BA_KIEMSOAT PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS; ALTER TABLE " + xxx + ".BA_KIEMSOAT OWNER TO medisoft;", false);
            execute_data("ALTER TABLE " + xxx + ".BA_KIEMSOAT add mabn varchar(10)", false);
            execute_data("CREATE TABLE " + xxx + ".BA_KIEMSOATCT(ID numeric(22,0), MA numeric(3,0), COKHONG numeric(1,0) DEFAULT 0, GHICHU text,CONSTRAINT pk_BA_KIEMSOATCT PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS; ALTER TABLE " + xxx + ".BA_KIEMSOATCT OWNER TO medisoft;", false);
            execute_data("CREATE TABLE " + xxx + ".BA_HOICHANTHUOC(ID numeric(22,0), IDTHUCHIEN numeric(22,0), NGAY timestamp, TU timestamp, DEN timestamp, MABS varchar(4), THUKY varchar(4), THANHVIEN text, TINHTRANG numeric(1,0) DEFAULT 0, GAN text, SGOT text, SGPT text, URE text, CREATIMIN text, ION text, CTM text, TPTNT text, XQ text, VIKHUAN text, KSD text, THUOC text, THAYTHE text, LYDO text, USERID numeric(5,0) DEFAULT 0, NGAYUD timestamp DEFAULT now(),CONSTRAINT pk_BA_HOICHANTHUOC PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS; ALTER TABLE " + xxx + ".BA_HOICHANTHUOC OWNER TO medisoft;", false);
            execute_data("ALTER TABLE " + xxx + ".BA_HOICHANTHUOC add mabn varchar(10)", false);
            execute_data("CREATE TABLE " + xxx + ".BA_DANHGIA1(ID numeric(22,0), IDTHUCHIEN numeric(22,0), NGAY timestamp, THUOC text, THUOC_K numeric(1,0) DEFAULT 0, CANNANG numeric(7,2) DEFAULT 0, CHIEUCAO numeric(5,0) DEFAULT 0, MACH numeric(3,0) DEFAULT 0, NHIETDO numeric(5,2) DEFAULT 0, HUYETAP varchar(7), NHIPTHO numeric(3,0) DEFAULT 0, DIUNG text, DIUNG_K numeric(1,0) DEFAULT 0, TM text, TM_K numeric(1,0) DEFAULT 0, TM_1 numeric(1,0) DEFAULT 0, TM_2 numeric(1,0) DEFAULT 0, TM_3 numeric(1,0) DEFAULT 0, TM_4 numeric(1,0) DEFAULT 0, TM_5 numeric(1,0) DEFAULT 0, TM_6 numeric(1,0) DEFAULT 0, TM_7 numeric(1,0) DEFAULT 0, HH text, HH_K numeric(1,0) DEFAULT 0, HH_1 numeric(1,0) DEFAULT 0, HH_2 numeric(1,0) DEFAULT 0, HH_3 numeric(1,0) DEFAULT 0, HH_4 numeric(1,0) DEFAULT 0, HH_5 numeric(1,0) DEFAULT 0, HH_6 numeric(1,0) DEFAULT 0, HH_7 numeric(1,0) DEFAULT 0, THAN text, THAN_K numeric(1,0) DEFAULT 0, THAN_1 numeric(1,0) DEFAULT 0, THAN_2 numeric(1,0) DEFAULT 0, THAN_3 numeric(1,0) DEFAULT 0, THAN_4 numeric(1,0) DEFAULT 0,CONSTRAINT pk_BA_DANHGIA1 PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS; ALTER TABLE " + xxx + ".BA_DANHGIA1 OWNER TO medisoft;", false);
            execute_data("ALTER TABLE " + xxx + ".BA_DANHGIA1 add mabn varchar(10)", false);
            execute_data("CREATE TABLE " + xxx + ".BA_DANHGIA2 (ID2 numeric(22,0), NOITIET text, NOITIET_K numeric(1,0) DEFAULT 0, NOITIET_1 numeric(1,0) DEFAULT 0, NOITIET_2 numeric(1,0) DEFAULT 0, NOITIET_3 numeric(1,0) DEFAULT 0, NOITIET_4 numeric(1,0) DEFAULT 0, NOITIET_5 numeric(1,0) DEFAULT 0, NOITIET_6 numeric(1,0) DEFAULT 0, TIEUHOA text, TIEUHOA_K numeric(1,0) DEFAULT 0, TIEUHOA_1 numeric(1,0) DEFAULT 0, TIEUHOA_2 numeric(1,0) DEFAULT 0, TIEUHOA_3 numeric(1,0) DEFAULT 0, TIEUHOA_4 numeric(1,0) DEFAULT 0, TIEUHOA_5 numeric(1,0) DEFAULT 0, TIEUHOA_6 numeric(1,0) DEFAULT 0, TIEUHOA_7 numeric(1,0) DEFAULT 0, THANKINH text, THANKINH_K numeric(1,0) DEFAULT 0, THANKINH_1 numeric(1,0) DEFAULT 0, THANKINH_2 numeric(1,0) DEFAULT 0, THANKINH_3 numeric(1,0) DEFAULT 0, THANKINH_4 numeric(1,0) DEFAULT 0, HUYETHOC text, HUYETHOC_K numeric(1,0) DEFAULT 0, HUYETHOC_1 numeric(1,0) DEFAULT 0, HUYETHOC_2 numeric(1,0) DEFAULT 0, HUYETHOC_3 numeric(1,0) DEFAULT 0,CONSTRAINT pk_BA_DANHGIA2 PRIMARY KEY (id2) USING INDEX TABLESPACE medi_index) WITH OIDS; ALTER TABLE " + xxx + ".BA_DANHGIA2 OWNER TO medisoft;", false);
            execute_data("ALTER TABLE " + xxx + ".BA_DANHGIA2 add mabn varchar(10)", false);
            execute_data("CREATE TABLE " + xxx + ".BA_DANHGIA3(ID3 numeric(22,0), LAMSANG text, KHAM text, KHAM_1 numeric(1,0) DEFAULT 0, KHAM_2 numeric(1,0) DEFAULT 0, KHAM_3 numeric(1,0) DEFAULT 0, KHAM_4 numeric(1,0) DEFAULT 0, KHAM_5 numeric(1,0) DEFAULT 0, XN text, CLS text, LUUY text, ASA varchar(1), THAOLUAN_1 numeric(1,0) DEFAULT 0, THAOLUAN_2 numeric(1,0) DEFAULT 0, THAOLUAN_3 numeric(1,0) DEFAULT 0, THAOLUAN_4 numeric(1,0) DEFAULT 0, THAOLUAN_5 numeric(1,0) DEFAULT 0, KEHOACH text, MABS varchar(4), USERID numeric(5,0), NGAYUD timestamp DEFAULT now(),CONSTRAINT pk_BA_DANHGIA3 PRIMARY KEY (id3) USING INDEX TABLESPACE medi_index) WITH OIDS; ALTER TABLE " + xxx + ".BA_DANHGIA3 OWNER TO medisoft;", false);
            execute_data("ALTER TABLE " + xxx + ".BA_DANHGIA3 add mabn varchar(10)", false);
            execute_data("CREATE TABLE " + xxx + ".BA_CAMDOAN(ID numeric(22,0), IDTHUCHIEN numeric(22,0), NGAY DATE, HOTEN text, TUOI numeric(3,0) DEFAULT 0, PHAI text, DANTOC text, NGHENGHIEP text, NGOAIKIEU text, DIACHI text, NOILAM text, NGUOINHA text, DONGY numeric(1,0) DEFAULT 0, IMAGE bytea, GHICHU text, USERID numeric(5,0) DEFAULT 0, NGAYUD timestamp DEFAULT now(),CONSTRAINT pk_BA_CAMDOAN PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS; ALTER TABLE " + xxx + ".BA_CAMDOAN OWNER TO medisoft;", false);
            execute_data("ALTER TABLE " + xxx + ".BA_CAMDOAN add mabn varchar(10)", false);
            execute_data("CREATE TABLE " + xxx + ".BA_GIAONHAN (ID numeric(22,0), IDTHUCHIEN numeric(22,0), NGAY timestamp, TRIGIAC text, MACH numeric(3,0) DEFAULT 0, NHIETDO numeric(5,2) DEFAULT 0, HUYETAP varchar(7), NHIPTHO numeric(3,0) DEFAULT 0, CANNANG numeric(7,2) DEFAULT 0, SPO2 numeric(7,2) DEFAULT 0, CAMTAY text, YTA varchar(4), USERID numeric(5,0), NGAYUD timestamp DEFAULT now(),CONSTRAINT pk_BA_GIAONHAN PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS; ALTER TABLE " + xxx + ".BA_GIAONHAN OWNER TO medisoft;", false);
            execute_data("ALTER TABLE " + xxx + ".BA_GIAONHAN add mabn varchar(10)", false);
            execute_data("CREATE TABLE " + xxx + ".BA_GIAONHANCT(ID numeric(22,0), STT numeric(3,0), SOLUONG numeric(3,0), LOAI text,CONSTRAINT pk_BA_GIAONHANCT PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS; ALTER TABLE " + xxx + ".BA_GIAONHANCT OWNER TO medisoft;", false);
            execute_data("CREATE TABLE " + xxx + ".BA_SOKET(ID numeric(22,0), IDTHUCHIEN numeric(22,0), NGAY timestamp, DIENBIEN text, CLS text, DIEUTRI text, KETQUA text, TIENLUONG text, BSTRUONG varchar(4), MABS varchar(4), USERID numeric(5,0),NGAYUD timestamp DEFAULT now(),CONSTRAINT pk_BA_SOKET PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS; ALTER TABLE " + xxx + ".BA_SOKET OWNER TO medisoft;", false);
            execute_data("ALTER TABLE " + xxx + ".BA_SOKET add mabn varchar(10)", false);
            execute_data("create table " + user + ".dmchinhanh(id numeric(2),ten text,database text,ip varchar(25),CONSTRAINT pk_dmchinhanh PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS; ALTER TABLE " + user + ".dmchinhanh OWNER TO medisoft;", false);
            execute_data("alter table " + user + ".dlogin add chinhanh numeric(2) default 0;", false);
            execute_data("alter table " + user + ".d_dlogin add chinhanh numeric(2) default 0;", false);
            execute_data("alter table " + user + ".v_dlogin add chinhanh numeric(2) default 0;", false);
            execute_data("create table " + user + ".dmphongthuchiencls(id numeric(3),ten text,stt numeric(3),id_loaivp numeric(3),CONSTRAINT pk_dmphongthuchiencls PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS; ALTER TABLE " + user + ".dmphongthuchiencls OWNER TO medisoft;", false);
            execute_data("alter table " + user + ".dmtheodoi alter id type varchar(9);", false);
            execute_data("CREATE TABLE " + xxx + ".BA_HOICHANCCXN(ID numeric(22,0), MA numeric(3,0), TINHTRANG numeric(7,2) DEFAULT 0,CONSTRAINT pk_BA_HOICHANCCXN PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS; ALTER TABLE " + xxx + ".BA_HOICHANCCXN OWNER TO medisoft;", false);
            execute_data("ALTER TABLE " + xxx + ".BA_HOICHANCCXN add mabn varchar(10)", false);
            execute_data("CREATE TABLE " + xxx + ".BA_DONGMACHVANH(ID numeric(22,0), STT numeric(3,0), SOLUONG numeric(5,0) DEFAULT 0, VITRI text,CONSTRAINT pk_BA_DONGMACHVANH PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS; ALTER TABLE " + xxx + ".BA_DONGMACHVANH OWNER TO medisoft;", false);
            execute_data("ALTER TABLE " + xxx + ".BA_DONGMACHVANH add mabn varchar(10)", false);
            execute_data("CREATE TABLE " + xxx + ".BA_HINH(ID numeric(22,0), STT numeric(3,0), IMAGE bytea,CONSTRAINT pk_BA_HINH PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS; ALTER TABLE " + xxx + ".BA_HINH OWNER TO medisoft;", false);
            execute_data("ALTER TABLE " + xxx + ".BA_HINH add mabn varchar(10)", false);
            execute_data("CREATE TABLE " + xxx + ".BA_NOIKHOA(ID numeric(22,0), CHIDINH text, THOIGIAN timestamp, SOLUONG numeric(5,0) DEFAULT 0, LOAI text, THOIDIEM timestamp,CONSTRAINT pk_BA_NOIKHOA PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS; ALTER TABLE " + xxx + ".BA_NOIKHOA OWNER TO medisoft;", false);
            execute_data("ALTER TABLE " + xxx + ".BA_NOIKHOA add mabn varchar(10)", false);
            execute_data("CREATE TABLE " + xxx + ".BA_TOMTAT(ID numeric(22,0), BENHNHAN text, LYDO text, CONANG text, THUCTHE text, CLSDACO text,CONSTRAINT pk_BA_TOMTAT PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS; ALTER TABLE " + xxx + ".BA_TOMTAT OWNER TO medisoft;", false);
            execute_data("ALTER TABLE " + xxx + ".BA_TOMTAT add mabn varchar(10)", false);
            execute_data("CREATE TABLE " + xxx + ".BA_HBDACDIEM(ID numeric(22,0), MA numeric(3,0), THOIGIAN text,CONSTRAINT pk_BA_HBDACDIEM PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) WITH OIDS; ALTER TABLE " + xxx + ".BA_HBDACDIEM OWNER TO medisoft;", false);
            execute_data("ALTER TABLE " + xxx + ".BA_HBDACDIEM add mabn varchar(10)", false);
            execute_data("alter table " + user + ".tenvien add ngoaidm numeric(1) default 0;", false);
            execute_data("alter table " + user + ".chuyenvien add daduyet numeric(1) default 0;", false);
        }
        //linh
        public bool upd_dmchinhanh(int m_id, string m_ten, string m_database, string m_ip, string m_viettat, int m_tt, string m_mabv, string m_port, string m_database_local)
        {
            sql = "update " + user + ".dmchinhanh set ten=:m_ten,database=:m_database,ip=:m_ip,viettat=:m_viettat";
            sql += " ,trungtam=:m_tt,mabv=:m_mabv,port='" + m_port + "',database_local='" + m_database_local + "' where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);

            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_database", NpgsqlDbType.Text).Value = m_database;
                cmd.Parameters.Add("m_ip", NpgsqlDbType.Varchar).Value = m_ip;
                cmd.Parameters.Add("m_viettat", NpgsqlDbType.Text).Value = m_viettat;
                cmd.Parameters.Add("m_tt", NpgsqlDbType.Numeric).Value = m_tt;
                cmd.Parameters.Add("m_mabv", NpgsqlDbType.Varchar, 10).Value = m_mabv;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dmchinhanh (id,ten,database,ip,viettat,trungtam,mabv,port,database_local) ";
                    sql += "values (:m_id,:m_ten,:m_database,:m_ip,:m_viettat,:m_tt,:m_mabv,'" + m_port + "','" + m_database_local + "')";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    cmd.Parameters.Add("m_database", NpgsqlDbType.Text).Value = m_database;
                    cmd.Parameters.Add("m_ip", NpgsqlDbType.Varchar).Value = m_ip;
                    cmd.Parameters.Add("m_viettat", NpgsqlDbType.Text).Value = m_viettat;
                    cmd.Parameters.Add("m_tt", NpgsqlDbType.Numeric).Value = m_tt;
                    cmd.Parameters.Add("m_mabv", NpgsqlDbType.Varchar, 10).Value = m_mabv;
                    cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dmchinhanh");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_dmphongthuchiencls(int m_id, string m_ma, string m_ten, string m_id_loaivp, int m_idchinhanh, int m_loai)
        {
            sql = "update " + user + ".dmphongthuchiencls set ma=:m_ma,ten=:m_ten,id_loaivp=:m_id_loaivp,idchinhanh=:m_idchinhanh,loai=:m_loai";
            sql += " where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Text).Value = m_ma;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_id_loaivp", NpgsqlDbType.Char, 20).Value = m_id_loaivp;
                cmd.Parameters.Add("m_idchinhanh", NpgsqlDbType.Numeric).Value = m_idchinhanh;
                cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dmphongthuchiencls (id,ma,ten,id_loaivp,idchinhanh,loai) values (:m_id,:m_ma,:m_ten,:m_id_loaivp,:m_idchinhanh,:m_loai)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Text).Value = m_ma;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    cmd.Parameters.Add("m_id_loaivp", NpgsqlDbType.Char, 20).Value = m_id_loaivp;
                    cmd.Parameters.Add("m_idchinhanh", NpgsqlDbType.Numeric).Value = m_idchinhanh;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                    cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dmphongthuchiencls");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public string get_nor(int m_id)
        {
            string nor = "";
            try
            {
                nor = get_data("select ten from " + user + ".ba_danhmuc where id=" + m_id + "").Tables[0].Rows[0]["ten"].ToString();
            }
            catch { }
            return nor;
        }
        public bool upd_giaythuphanungthuoc(decimal m_id, int m_stt, string m_mabn, string m_chandoan, string m_ngaythu,
            int m_mabd, string m_ppthu, string m_mabs, string m_mabs_thu, string m_mabs_doc, string m_ngay_dockq,
            int m_userid)
        {
            sql = "update " + user + ".giaythuphanungthuoc set mabn=:m_mabn,chandoan=:m_chandoan,ngaythu=to_date(:m_ngaythu,'dd/mm/yyyy hh24:mi')";
            sql += ",mabd=:m_mabd,ppthu=:m_ppthu,mabs=:m_mabs,mabs_thu=:m_mabs_thu,mabs_doc=:m_mabs_doc,";
            sql += "ngay_dockq=to_date(:m_ngay_dockq,'dd/mm/yyyy hh24:mi'),userid=:m_userid ";
            sql += " where id=:m_id and stt=:m_stt";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_ngaythu", NpgsqlDbType.Varchar).Value = m_ngaythu;
                cmd.Parameters.Add("m_mabd", NpgsqlDbType.Numeric).Value = m_mabd;
                cmd.Parameters.Add("m_ppthu", NpgsqlDbType.Text).Value = m_ppthu;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar).Value = m_mabs;
                cmd.Parameters.Add("m_mabs_thu", NpgsqlDbType.Varchar).Value = m_mabs_thu;
                cmd.Parameters.Add("m_mabs_doc", NpgsqlDbType.Varchar).Value = m_mabs_doc;
                cmd.Parameters.Add("m_ngay_dockq", NpgsqlDbType.Varchar).Value = m_ngay_dockq;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".giaythuphanungthuoc (id,stt,mabn,chandoan,ngaythu,mabd,ppthu,mabs,mabs_thu,mabs_doc,ngay_dockq,userid) ";
                    sql += "values (:m_id,:m_stt,:m_mabn,:m_chandoan,to_date(:m_ngaythu,'dd/mm/yyyy hh24:mi'),:m_mabd,:m_ppthu,:m_mabs,:m_mabs_thu,:m_mabs_doc,to_date(:m_ngay_dockq,'dd/mm/yyyy hh24:mi'),:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                    cmd.Parameters.Add("m_ngaythu", NpgsqlDbType.Varchar).Value = m_ngaythu;
                    cmd.Parameters.Add("m_mabd", NpgsqlDbType.Numeric).Value = m_mabd;
                    cmd.Parameters.Add("m_ppthu", NpgsqlDbType.Text).Value = m_ppthu;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar).Value = m_mabs;
                    cmd.Parameters.Add("m_mabs_thu", NpgsqlDbType.Varchar).Value = m_mabs_thu;
                    cmd.Parameters.Add("m_mabs_doc", NpgsqlDbType.Varchar).Value = m_mabs_doc;
                    cmd.Parameters.Add("m_ngay_dockq", NpgsqlDbType.Varchar).Value = m_ngay_dockq;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "giaythuphanungthuoc");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_phieutiemchung(decimal m_id, int m_stt, string m_mabn, string m_sophieu, int m_id_benhtc,
            int m_mabd, string m_muitiem, string m_ngaytiem, string m_ngaytiem_hen, int m_cosotiem, int m_userid, string m_vitritiem, string m_mabs)
        {
            sql = "update " + user + ".phieutiemchung set mabn=:m_mabn,sophieu=:m_sophieu,id_benhtc=:m_id_benhtc";
            sql += ",stt=:m_stt,muitiem=:m_muitiem,ngaytiem=to_date(:m_ngaytiem,'dd/mm/yyyy hh24:mi'),ngaytiem_hen=to_date(:m_ngaytiem_hen,'dd/mm/yyyy'),cosotiem=:m_cosotiem,";
            sql += "userid=:m_userid,vitritiem=:m_vitritiem,mabs=:m_mabs ";
            sql += " where id=:m_id and mabd=:m_mabd";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_sophieu", NpgsqlDbType.Varchar).Value = m_sophieu;
                cmd.Parameters.Add("m_id_benhtc", NpgsqlDbType.Numeric).Value = m_id_benhtc;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                cmd.Parameters.Add("m_muitiem", NpgsqlDbType.Text).Value = m_muitiem;
                cmd.Parameters.Add("m_ngaytiem", NpgsqlDbType.Varchar).Value = m_ngaytiem;
                cmd.Parameters.Add("m_ngaytiem_hen", NpgsqlDbType.Varchar).Value = m_ngaytiem_hen;
                cmd.Parameters.Add("m_cosotiem", NpgsqlDbType.Numeric).Value = m_cosotiem;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_vitritiem", NpgsqlDbType.Text).Value = m_vitritiem;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar).Value = m_mabs;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_mabd", NpgsqlDbType.Numeric).Value = m_mabd;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".phieutiemchung(id,stt,mabn,sophieu,id_benhtc,mabd,muitiem,ngaytiem,ngaytiem_hen,cosotiem,userid,vitritiem,mabs) ";
                    sql += "values (:m_id,:m_stt,:m_mabn,:m_sophieu,:m_id_benhtc,:m_mabd,:m_muitiem,to_date(:m_ngaytiem,'dd/mm/yyyy hh24:mi'),to_date(:m_ngaytiem_hen,'dd/mm/yyyy'),:m_cosotiem,:m_userid,:m_vitritiem,:m_mabs)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_sophieu", NpgsqlDbType.Varchar).Value = m_sophieu;
                    cmd.Parameters.Add("m_id_benhtc", NpgsqlDbType.Numeric).Value = m_id_benhtc;
                    cmd.Parameters.Add("m_mabd", NpgsqlDbType.Numeric).Value = m_mabd;
                    cmd.Parameters.Add("m_muitiem", NpgsqlDbType.Text).Value = m_muitiem;
                    cmd.Parameters.Add("m_ngaytiem", NpgsqlDbType.Varchar).Value = m_ngaytiem;
                    cmd.Parameters.Add("m_ngaytiem_hen", NpgsqlDbType.Varchar).Value = m_ngaytiem_hen;
                    cmd.Parameters.Add("m_cosotiem", NpgsqlDbType.Numeric).Value = m_cosotiem;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    cmd.Parameters.Add("m_vitritiem", NpgsqlDbType.Text).Value = m_vitritiem;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar).Value = m_mabs;
                    cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "phieutiemchung");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        #endregion

        ///04/06/2011 Dong
        public string get_Tendatabase(int i_idcoso)
        {
            string stendata = "";
            try
            {
                stendata = get_data("select database from " + user + ".dmchinhanh where id=" + i_idcoso + "").Tables[0].Rows[0]["database"].ToString();
            }
            catch
            {
                return stendata;
            }
            return stendata;
        }
        public string get_mabv(int i_idcoso)
        {
            string smabv = "";
            try
            {
                smabv = get_data("select mabv from " + user + ".dmchinhanh where id=" + i_idcoso + "").Tables[0].Rows[0]["mabv"].ToString();
            }
            catch
            {
                return smabv;
            }
            return smabv;
        }
        ///End dong
        //Khuong 16/05/2011: them ham update ty le mien
        public bool upd_tylemien(string d_mabn, decimal d_mavaovien, int d_tlkham, int d_tldichvu, int d_tlthuoc, int d_tldongchitra, string d_mmyy, int d_userid)
        {
            string s_xxx = user + d_mmyy;
            sql = "update " + s_xxx + ".tylemien set tlkham=:d_tlkham,tldichvu=:d_tldichvu,tlthuoc=:d_tlthuoc,tldongchitra=:d_tldongchitra where mabn=:d_mabn and mavaovien=:d_mavaovien";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("d_tlkham", NpgsqlDbType.Numeric).Value = d_tlkham;
                cmd.Parameters.Add("d_tldichvu", NpgsqlDbType.Numeric).Value = d_tldichvu;
                cmd.Parameters.Add("d_tlthuoc", NpgsqlDbType.Numeric).Value = d_tlthuoc;
                cmd.Parameters.Add("d_tldongchitra", NpgsqlDbType.Numeric).Value = d_tldongchitra;
                cmd.Parameters.Add("d_mabn", NpgsqlDbType.Varchar, 10).Value = d_mabn;
                cmd.Parameters.Add("d_mavaovien", NpgsqlDbType.Numeric).Value = d_mavaovien;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_xxx + ".tylemien (mabn,mavaovien,tlkham, tldichvu,tlthuoc,tldongchitra,userid) values (:d_mabn,:d_mavaovien,:d_tlkham,:d_tldichvu,:d_tlthuoc,:d_tldongchitra,:d_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("d_mabn", NpgsqlDbType.Varchar, 10).Value = d_mabn;
                    cmd.Parameters.Add("d_mavaovien", NpgsqlDbType.Numeric).Value = d_mavaovien;
                    cmd.Parameters.Add("d_tlkham", NpgsqlDbType.Numeric).Value = d_tlkham;
                    cmd.Parameters.Add("d_tldichvu", NpgsqlDbType.Numeric).Value = d_tldichvu;
                    cmd.Parameters.Add("d_tlthuoc", NpgsqlDbType.Numeric).Value = d_tlthuoc;
                    cmd.Parameters.Add("d_tldongchitra", NpgsqlDbType.Numeric).Value = d_tldongchitra;
                    cmd.Parameters.Add("d_userid", NpgsqlDbType.Numeric).Value = d_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "tylemien");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        //hien 15052011
        /// <summary>
        /// phương thức cập nhật thông tin số chứng minh của bệnh nhân 
        /// </summary>
        /// <param name="ngay"></param>
        /// <param name="maql"></param>
        /// <param name="socmnd"></param>
        /// <param name="noicap"></param>
        /// <returns></returns>
        public bool upd_lienhe(string ngay, decimal maql, string socmnd, string noicap)
        {
            sql = "update " + user + ".lienhe set cmnd='" + socmnd + "',noicap=:noicap where maql=" + maql;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("noicap", NpgsqlDbType.Text).Value = noicap;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "d_taosolieu");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        //Khuong 19/05/2011: update btdbn, update 2 field moi : so cmnd va msthue
        public bool upd_btdbn(string mabn, string cmnd, string msthue)
        {
            sql = "update " + user + ".btdbn set cmnd=:cmnd,msthue=:msthue where mabn=:mabn";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("cmnd", NpgsqlDbType.Text).Value = cmnd;
                cmd.Parameters.Add("msthue", NpgsqlDbType.Text).Value = msthue;
                cmd.Parameters.Add("mabn", NpgsqlDbType.Varchar).Value = mabn;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "btdbn");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        //End Khuong 19/05/2011

        //Khuong 20/05/2011 : danh cho Hepa
        public bool upd_dmlydokham(int d_id, string d_ten, int d_danhmuc)
        {
            sql = "update " + user + ".dmlydokham set ten=:d_ten,danhmuc=:d_danhmuc where id=:d_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("d_ten", NpgsqlDbType.Text).Value = d_ten;
                cmd.Parameters.Add("d_danhmuc", NpgsqlDbType.Numeric).Value = d_danhmuc;
                cmd.Parameters.Add("d_id", NpgsqlDbType.Numeric).Value = d_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dmlydokham (id,ten,danhmuc) values (:d_id,:d_ten,:d_danhmuc)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("d_id", NpgsqlDbType.Numeric).Value = d_id;
                    cmd.Parameters.Add("d_ten", NpgsqlDbType.Text).Value = d_ten;
                    cmd.Parameters.Add("d_danhmuc", NpgsqlDbType.Numeric).Value = d_danhmuc;
                    irec = cmd.ExecuteNonQuery();

                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dmlydokham");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_congthucchenhlech(int m_loaivp, int m_loai, string m_gia1, string m_gia2)
        {
            sql = "update " + user + ".congthucchenhlech set gia_1=:m_gia1,gia_2=:m_gia2 where loai=:m_loai and id_loaivp=:m_loaivp";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_gia1", NpgsqlDbType.Varchar).Value = m_gia1;
                cmd.Parameters.Add("m_gia2", NpgsqlDbType.Varchar).Value = m_gia2;
                cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                cmd.Parameters.Add("m_loaivp", NpgsqlDbType.Numeric).Value = m_loaivp;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".congthucchenhlech (loai,id_loaivp,gia_1,gia_2) values(:m_loai,:m_loaivp,:m_gia1,:m_gia2)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                    cmd.Parameters.Add("m_loaivp", NpgsqlDbType.Numeric).Value = m_loaivp;
                    cmd.Parameters.Add("m_gia1", NpgsqlDbType.Varchar).Value = m_gia1;
                    cmd.Parameters.Add("m_gia2", NpgsqlDbType.Varchar).Value = m_gia2;

                    irec = cmd.ExecuteNonQuery();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "congthucchenhlech");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_dmlydodungtuyen(int d_id, string d_ten, int d_chuyenvien)
        {
            sql = "update " + user + ".dmlydodungtuyen set ten=:d_ten,chuyenvien=:d_chuyenvien where id=:d_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("d_ten", NpgsqlDbType.Text).Value = d_ten;
                cmd.Parameters.Add("d_chuyenvien", NpgsqlDbType.Numeric).Value = d_chuyenvien;
                cmd.Parameters.Add("d_id", NpgsqlDbType.Numeric).Value = d_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dmlydodungtuyen (id,ten,chuyenvien) values (:d_id,:d_ten,:d_chuyenvien)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("d_id", NpgsqlDbType.Numeric).Value = d_id;
                    cmd.Parameters.Add("d_ten", NpgsqlDbType.Text).Value = d_ten;
                    cmd.Parameters.Add("d_chuyenvien", NpgsqlDbType.Numeric).Value = d_chuyenvien;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dmlydodungtuyen");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        //End Khuong 20/05/2011
        //Khuong 23/05/2011 : danh cho Hepa, update ly kham
        public bool upd_lydokham(decimal m_maql, string m_ngay, string m_lydo, string m_lydokham, string m_lydodungtuyen)
        {
            string s_mmyy = mmyy(m_ngay);
            sql = "update " + user + s_mmyy + ".lydokham set lydo=:m_lydo,id_lydokham=:m_lydokham,id_lydodungtuyen=:m_lydodungtuyen where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_lydo", NpgsqlDbType.Text).Value = m_lydo;
                cmd.Parameters.Add("m_lydokham", NpgsqlDbType.Text).Value = m_lydokham;
                cmd.Parameters.Add("m_lydodungtuyen", NpgsqlDbType.Text).Value = m_lydodungtuyen;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + s_mmyy + ".lydokham (maql,lydo,id_lydokham,id_lydodungtuyen) values (:m_maql,:m_lydo,:m_lydokham,:m_lydodungtuyen)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_lydo", NpgsqlDbType.Text).Value = m_lydo;
                    cmd.Parameters.Add("m_lydokham", NpgsqlDbType.Text).Value = m_lydokham;
                    cmd.Parameters.Add("m_lydodungtuyen", NpgsqlDbType.Text).Value = m_lydodungtuyen;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message, sComputer, "lydokham");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
            return true;
        }
        //End Khuong 23/05/2011

        //Tu:21/05/2011
        public bool upd_dmtheodoi(string m_id, decimal m_stt, string m_ten)
        {
            sql = "update " + user + ".dmtheodoi set stt=:m_stt,ten=:m_ten where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Varchar).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dmtheodoi (id,stt,ten) values (:m_id,:m_stt,:m_ten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Varchar).Value = m_id;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dmtheodoi");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        //end Tu

        //Khuong 27/05/2011 cap nhat v_dmloaithe_uudai
        public bool upd_v_dmloaithe_uudai(int v_id, string v_ten, int v_sudung)
        {
            sql = "update " + user + ".v_dmloaithe_uudai set ten=:v_ten,sudung=:v_sudung where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
                cmd.Parameters.Add("v_sudung", NpgsqlDbType.Numeric).Value = v_sudung;
                cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;

                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".v_dmloaithe_uudai (id,ten,sudung) values ";
                    sql += "(:v_id,:v_ten,:v_sudung)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
                    cmd.Parameters.Add("v_sudung", NpgsqlDbType.Numeric).Value = v_sudung;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "v_dmloaithe_uudai");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_v_dmloaithe_tyleuudai(int v_idthe, int v_tyle, int v_idnhommien)
        {
            sql = "update " + user + ".v_dmloaithe_tyleuudai set tyle=:v_tyle where idthe=:v_idthe and id_nhommien=:v_idnhommien";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("v_tyle", NpgsqlDbType.Numeric).Value = v_tyle;
                cmd.Parameters.Add("v_idthe", NpgsqlDbType.Numeric).Value = v_idthe;
                cmd.Parameters.Add("v_idnhommien", NpgsqlDbType.Numeric).Value = v_idnhommien;

                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".v_dmloaithe_tyleuudai(idthe,id_nhommien,tyle) values ";
                    sql += "(:v_idthe,:v_idnhommien,:v_tyle)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_idthe", NpgsqlDbType.Numeric).Value = v_idthe;
                    cmd.Parameters.Add("v_idnhommien", NpgsqlDbType.Numeric).Value = v_idnhommien;
                    cmd.Parameters.Add("v_tyle", NpgsqlDbType.Numeric).Value = v_tyle;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "v_dmloaithe_tyleuudai");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        //End Khuong 27/05/2011

        public void f_kiemtra_idduoc_idgiavp()
        {
            string m_user = user;
            sql = "select max (id) as id  from (";
            sql += " select max(id) as id from " + m_user + ".d_dmbd where id<500000";//duoc: id taang tu 500.000 --> tro di
            sql += " union all ";
            sql += " select max(id) as id from " + m_user + ".v_giavp ";//duoc: id tang tu 1 --> tro di
            sql += ") f";
            DataSet lds1 = get_data(sql);
            decimal l_id1 = 0;
            if (lds1 == null || lds1.Tables.Count <= 0 || lds1.Tables[0].Rows.Count <= 0) l_id1 = 1;
            else l_id1 = (lds1.Tables[0].Rows[0]["id"].ToString() == "") ? 1 : decimal.Parse(lds1.Tables[0].Rows[0]["id"].ToString());
            sql = "select id from " + m_user + ".d_capid where ma=1 ";
            DataSet lds2 = get_data(sql);
            decimal l_id2 = 0;
            if (lds2 == null || lds2.Tables.Count <= 0 || lds2.Tables[0].Rows.Count <= 0) l_id2 = 1;
            else l_id2 = (lds2.Tables[0].Rows[0]["id"].ToString() == "") ? 1 : decimal.Parse(lds2.Tables[0].Rows[0]["id"].ToString());
            if (l_id1 > l_id2)
            {
                sql = "update " + m_user + ".d_capid set id=" + l_id1 + "+10 where ma=1 ";
                execute_data(sql);
            }

            //nuoc sx
            l_id1 = 0; l_id2 = 0;
            sql = "select max(id) as id from " + m_user + ".d_dmnuoc ";
            lds1 = get_data(sql);
            if (lds1 == null || lds1.Tables.Count <= 0 || lds1.Tables[0].Rows.Count <= 0) l_id1 = 1;
            else l_id1 = (lds1.Tables[0].Rows[0]["id"].ToString() == "") ? 1 : decimal.Parse(lds1.Tables[0].Rows[0]["id"].ToString());
            sql = "select id from " + m_user + ".d_capid where ma=13 ";
            lds2 = get_data(sql);
            if (lds2 == null || lds2.Tables.Count <= 0 || lds2.Tables[0].Rows.Count <= 0) l_id2 = 1;
            else l_id2 = (lds2.Tables[0].Rows[0]["id"].ToString() == "") ? 1 : decimal.Parse(lds2.Tables[0].Rows[0]["id"].ToString());
            if (l_id1 > l_id2)
            {
                sql = "update " + m_user + ".d_capid set id=(select max(id)+3 as id from " + m_user + ".d_dmnuoc) where ma=13 ";
                execute_data(sql);
            }
            //hang sx
            l_id1 = 0; l_id2 = 0;
            sql = "select max(id) as id from " + m_user + ".d_dmhang ";
            lds1 = get_data(sql);
            if (lds1 == null || lds1.Tables.Count <= 0 || lds1.Tables[0].Rows.Count <= 0) l_id1 = 1;
            else l_id1 = (lds1.Tables[0].Rows[0]["id"].ToString() == "") ? 1 : decimal.Parse(lds1.Tables[0].Rows[0]["id"].ToString());
            sql = "select id from " + m_user + ".d_capid where ma=3 ";
            lds2 = get_data(sql);
            if (lds2 == null || lds2.Tables.Count <= 0 || lds2.Tables[0].Rows.Count <= 0) l_id2 = 1;
            else l_id2 = (lds2.Tables[0].Rows[0]["id"].ToString() == "") ? 1 : decimal.Parse(lds2.Tables[0].Rows[0]["id"].ToString());
            if (l_id1 > l_id2)
            {
                sql = "update " + m_user + ".d_capid set id=(select max(id)+3 as id from " + m_user + ".d_dmhang) where ma=3 ";
                execute_data(sql);
            }
            //nha cung cap
            l_id1 = 0; l_id2 = 0;
            sql = "select max(id) as id from " + m_user + ".d_dmnx ";
            lds1 = get_data(sql);
            if (lds1 == null || lds1.Tables.Count <= 0 || lds1.Tables[0].Rows.Count <= 0) l_id1 = 1;
            else l_id1 = (lds1.Tables[0].Rows[0]["id"].ToString() == "") ? 1 : decimal.Parse(lds1.Tables[0].Rows[0]["id"].ToString());
            sql = "select id from " + m_user + ".d_capid where ma=2 ";
            lds2 = get_data(sql);
            if (lds2 == null || lds2.Tables.Count <= 0 || lds2.Tables[0].Rows.Count <= 0) l_id2 = 1;
            else l_id2 = (lds2.Tables[0].Rows[0]["id"].ToString() == "") ? 1 : decimal.Parse(lds2.Tables[0].Rows[0]["id"].ToString());
            if (l_id1 > l_id2)
            {
                sql = "update " + m_user + ".d_capid set id=(select max(id)+3 as id from " + m_user + ".d_dmnx) where ma=2 ";
                execute_data(sql);
            }
        }

        //Khuong 28/05/2011

        /// <summary>
        /// cap id 21 ky tu
        /// </summary>
        public decimal get_id_21
        {
            get
            {
                return decimal.Parse(getyymmddhhmiss() + getRandom().ToString().PadLeft(3, '0') + get_dmcomputer().ToString().PadLeft(6, '0'));
            }
        }

        public bool upd_btdbn_uudai(decimal m_id, string m_mabn, int m_idthe, string m_tungay, string m_denngay, string m_ngaycap, int m_userid, string m_sothe)
        {
            sql = "update " + user + ".btdbn_uudai set idthe=:m_idthe,tungay=:m_tungay,denngay=:m_denngay,ngaycap=:m_ngaycap,userid=:m_userid,sothe=:m_sothe where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                //StringToDateTime(m_ngay1)
                cmd.Parameters.Add("m_idthe", NpgsqlDbType.Numeric).Value = m_idthe;
                cmd.Parameters.Add("m_tungay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_tungay);
                cmd.Parameters.Add("m_denngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_denngay);
                cmd.Parameters.Add("m_ngaycap", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngaycap);
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_sothe", NpgsqlDbType.Varchar).Value = m_sothe;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;

                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".btdbn_uudai(id,mabn,idthe,tungay,denngay,ngaycap,userid,sothe) values ";
                    sql += "(:m_id,:m_mabn,:m_idthe,:m_tungay,:m_denngay,:m_ngaycap,:m_userid,:m_sothe)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_idthe", NpgsqlDbType.Numeric).Value = m_idthe;
                    cmd.Parameters.Add("m_tungay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_tungay);
                    cmd.Parameters.Add("m_denngay", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_denngay);
                    cmd.Parameters.Add("m_ngaycap", NpgsqlDbType.Timestamp).Value = StringToDateTime(m_ngaycap);
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    cmd.Parameters.Add("m_sothe", NpgsqlDbType.Varchar).Value = m_sothe;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "btdbn_uudai");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_btdbn_uudaict(decimal m_id, int m_tyle, int m_idnhommien)
        {
            sql = "update " + user + ".btdbn_uudaict set tyle=:v_tyle where id=:v_id and id_nhommien=:v_idnhommien";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("v_tyle", NpgsqlDbType.Numeric).Value = m_tyle;
                cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("v_idnhommien", NpgsqlDbType.Numeric).Value = m_idnhommien;

                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".btdbn_uudaict(id,id_nhommien,tyle) values ";
                    sql += "(:v_id,:v_idnhommien,:v_tyle)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("v_idnhommien", NpgsqlDbType.Numeric).Value = m_idnhommien;
                    cmd.Parameters.Add("v_tyle", NpgsqlDbType.Numeric).Value = m_tyle;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "btdbn_uudaict");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        //End Khuong 28/05/2011

        public string mavpxungdot(int i_idvp)
        {
            //dong 300511
            try
            {
                string s_tmp = "";
                DataSet ds = get_data("select id_mavp_chong as id from " + user + ".v_giavp_chong where id_mavp=" + i_idvp.ToString());//+" or id_mavp_chong="+i_idvp.ToString());
                foreach (DataRow r in ds.Tables[0].Rows)
                {
                    s_tmp += r["id"].ToString() + ",";
                }
                return s_tmp.Trim(',');// ds.Tables[0].Rows[0][0].ToString();
            }
            catch
            { return ""; }
        }

        //Khuong 31/05/2011

        /// <summary>
        /// Cap ma the uu dai
        /// </summary>
        /// <param name="i_khudt"> id khu dieu tri (ma chi nhanh, co so)</param>
        /// <param name="yy">year year</param>
        /// <returns></returns>
        public string get_mathe_uudai(int i_khudt, string yy)
        {
            return i_Chinhanh_hientai.ToString().PadLeft(2, '0') + yy + get_capid(51, yy).ToString().PadLeft(6, '0');
        }

        //End Khuong 31/05/2011

        //Khuong 01/06/2011: cap nhat dmloaithebhyt - thông tin vị trí mã thẻ vd:DN,GD...
        public bool upd_dmloaibhyt(string m_ma, int m_tu, int m_den, int m_chieudai)
        {
            sql = "update " + user + ".dmloaibhyt set tu=:m_tu,den=:m_den,chieudai=:m_chieudai where ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("m_tu", NpgsqlDbType.Numeric).Value = m_tu;
                cmd.Parameters.Add("m_den", NpgsqlDbType.Numeric).Value = m_den;
                cmd.Parameters.Add("m_chieudai", NpgsqlDbType.Numeric).Value = m_chieudai;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar).Value = m_ma;

                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dmloaibhyt(ma,tu,den,chieudai) values ";
                    sql += "(:m_ma,:m_tu,:m_den,:m_chieudai)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar).Value = m_ma;
                    cmd.Parameters.Add("m_tu", NpgsqlDbType.Numeric).Value = m_tu;
                    cmd.Parameters.Add("m_den", NpgsqlDbType.Numeric).Value = m_den;
                    cmd.Parameters.Add("m_chieudai", NpgsqlDbType.Numeric).Value = m_chieudai;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dmloaibhyt");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        //End Khuong 01/06/2011


        public bool upd_dmloaibhyt_chinhsach(int m_id, string m_ma, int m_tu, int m_den, int m_chieudai, int m_trongtinh, int m_ngoaitinh, int m_hide)
        {
            sql = "update " + user + ".dmloaibhyt_chinhsach set tu=:m_tu,den=:m_den,chieudai=:m_chieudai,trongtinh=:m_trongtinh,ngoaitinh=:m_ngoaitinh,ma=:m_ma,hide=:m_hide where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("m_tu", NpgsqlDbType.Numeric).Value = m_tu;
                cmd.Parameters.Add("m_den", NpgsqlDbType.Numeric).Value = m_den;
                cmd.Parameters.Add("m_chieudai", NpgsqlDbType.Numeric).Value = m_chieudai;
                cmd.Parameters.Add("m_trongtinh", NpgsqlDbType.Numeric).Value = m_trongtinh;
                cmd.Parameters.Add("m_ngoaitinh", NpgsqlDbType.Numeric).Value = m_ngoaitinh;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar).Value = m_ma;
                cmd.Parameters.Add("m_hide", NpgsqlDbType.Numeric).Value = m_hide;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;

                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dmloaibhyt_chinhsach(id,ma,tu,den,chieudai,trongtinh,ngoaitinh,hide) values ";
                    sql += "(:m_id,:m_ma,:m_tu,:m_den,:m_chieudai,:m_trongtinh,:m_ngoaitinh,:m_hide)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar).Value = m_ma;
                    cmd.Parameters.Add("m_tu", NpgsqlDbType.Numeric).Value = m_tu;
                    cmd.Parameters.Add("m_den", NpgsqlDbType.Numeric).Value = m_den;
                    cmd.Parameters.Add("m_chieudai", NpgsqlDbType.Numeric).Value = m_chieudai;
                    cmd.Parameters.Add("m_trongtinh", NpgsqlDbType.Numeric).Value = m_trongtinh;
                    cmd.Parameters.Add("m_ngoaitinh", NpgsqlDbType.Numeric).Value = m_ngoaitinh;
                    cmd.Parameters.Add("m_hide", NpgsqlDbType.Numeric).Value = m_hide;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "dmloaibhyt_chinhsach");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public string f_get_mavp_congkham()
        {
            string s_mavpck = ",";
            string asql = "select distinct mavp, mavptk from " + user + ".btdkp_bv";
            DataSet lds = get_data(asql);
            foreach (DataRow r in lds.Tables[0].Rows)
            {
                if (s_mavpck.IndexOf("," + r["mavp"].ToString() + ",") < 0 && r["mavp"].ToString().Trim() != "0") s_mavpck += r["mavp"].ToString() + ",";
                if (s_mavpck.IndexOf("," + r["mavptk"].ToString() + ",") < 0 && r["mavptk"].ToString().Trim() != "0") s_mavpck += r["mavp"].ToString() + ",";
            }
            return s_mavpck.Trim().Trim(',');
        }

        //Khuong 02/06/2011: cap nhat tyleuudai_loaibhyt - thông tin ty le uu dai theo loai bhyt
        public bool upd_tyleuudai_loaibhyt(string m_ma, int m_tyle, int m_idnhommien, decimal m_iddot, int m_chenhlech)
        {
            sql = "update " + user + ".tyleuudai_loaibhyt set tyle=:m_tyle,tldongchitra=:m_chenhlech where iddotkm=:m_iddot and ma=:m_ma and id_nhommien=:m_idnhommien";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("m_tyle", NpgsqlDbType.Numeric).Value = m_tyle;
                cmd.Parameters.Add("m_chenhlech", NpgsqlDbType.Numeric).Value = m_chenhlech;
                cmd.Parameters.Add("m_iddot", NpgsqlDbType.Numeric).Value = m_iddot;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar).Value = m_ma;
                cmd.Parameters.Add("m_idnhommien", NpgsqlDbType.Numeric).Value = m_idnhommien;

                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".tyleuudai_loaibhyt(ma,tyle,tldongchitra,iddotkm,id_nhommien) values ";
                    sql += "(:m_ma,:m_tyle,:m_chenhlech,:m_iddot,:m_idnhommien)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar).Value = m_ma;
                    cmd.Parameters.Add("m_tyle", NpgsqlDbType.Numeric).Value = m_tyle;
                    cmd.Parameters.Add("m_chenhlech", NpgsqlDbType.Numeric).Value = m_chenhlech;
                    cmd.Parameters.Add("m_iddot", NpgsqlDbType.Numeric).Value = m_iddot;
                    cmd.Parameters.Add("m_idnhommien", NpgsqlDbType.Numeric).Value = m_idnhommien;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "tyleuudai_loaibhyt");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        //End Khuong 02/06/2011

        //Khuong 04/06/2011
        /// <summary>
        /// Cập nhật tỷ lệ miễn cho chế độ khuyến mãi và khuyến mãi theo loại thẻ BHYT
        /// </summary>
        /// <param name="m_mabn">Mã bn</param>
        /// <param name="m_mavaovien">Mã vào viện</param>
        /// <param name="m_chedouudai">Chế độ ưu đãi. 2-Khuyến mãi, 4-Khuyến mãi theo loại thẻ BHYT</param>
        /// <param name="m_idnhommien">id nhóm miễn</param>
        /// <param name="m_tyle"> tỷ lệ</param>
        /// <param name="m_iddotkm"> id đợt khuyến mãi</param>
        /// <param name="m_userid"></param>
        /// <param name="m_computer"></param>
        /// <returns></returns>
        public bool upd_tylemien_km(string m_mabn, decimal m_mavaovien, int m_chedouudai, int m_idnhommien, int m_tyle, decimal m_iddotkm, int m_userid, int m_computer, int m_tldongchitra)
        {
            sql = "update " + user + ".tylemien_km set loaiuudai=:m_chedouudai,tyle=:m_tyle,tldongchitra=:m_tldongchitra,iddotkm=:m_iddotkm,userid=:m_userid,computer=:m_computer where mabn=:m_mabn and mavaovien=:m_mavaovien and id_nhommien=:m_idnhommien";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("m_chedouudai", NpgsqlDbType.Numeric).Value = m_chedouudai;
                cmd.Parameters.Add("m_tyle", NpgsqlDbType.Numeric).Value = m_tyle;
                cmd.Parameters.Add("m_tldongchitra", NpgsqlDbType.Numeric).Value = m_chedouudai == 4 ? m_tldongchitra : 0;
                cmd.Parameters.Add("m_iddotkm", NpgsqlDbType.Numeric).Value = m_iddotkm;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_computer", NpgsqlDbType.Numeric).Value = m_computer;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                cmd.Parameters.Add("m_idnhommien", NpgsqlDbType.Numeric).Value = m_idnhommien;

                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".tylemien_km(mabn,mavaovien,loaiuudai,id_nhommien,tyle,tldongchitra,iddotkm,userid,computer) values ";
                    sql += "(:m_mabn,:m_mavaovien,:m_chedouudai,:m_idnhommien,:m_tyle,:m_tldongchitra,:m_iddotkm,:m_userid,:m_computer)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                    cmd.Parameters.Add("m_chedouudai", NpgsqlDbType.Numeric).Value = m_chedouudai;
                    cmd.Parameters.Add("m_idnhommien", NpgsqlDbType.Numeric).Value = m_idnhommien;
                    cmd.Parameters.Add("m_tyle", NpgsqlDbType.Numeric).Value = m_tyle;
                    cmd.Parameters.Add("m_tldongchitra", NpgsqlDbType.Numeric).Value = m_chedouudai == 4 ? m_tldongchitra : 0;
                    cmd.Parameters.Add("m_iddotkm", NpgsqlDbType.Numeric).Value = m_iddotkm;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    cmd.Parameters.Add("m_computer", NpgsqlDbType.Numeric).Value = m_computer;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "tylemien_km");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_tylemien_ud(string m_mabn, decimal m_mavaovien, int m_idnhommien, int m_tyle, decimal m_idtheuudai, int m_userid, int m_computer)
        {
            sql = "update " + user + ".tylemien_ud set id_theuudai=:m_idtheuudai,tyle=:m_tyle,userid=:m_userid,computer=:m_computer where mabn=:m_mabn and mavaovien=:m_mavaovien and id_nhommien=:m_idnhommien";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("m_idtheuudai", NpgsqlDbType.Numeric).Value = m_idtheuudai;
                cmd.Parameters.Add("m_tyle", NpgsqlDbType.Numeric).Value = m_tyle;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_computer", NpgsqlDbType.Numeric).Value = m_computer;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                cmd.Parameters.Add("m_idnhommien", NpgsqlDbType.Numeric).Value = m_idnhommien;

                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".tylemien_ud(mabn,mavaovien,id_theuudai,id_nhommien,tyle,userid,computer) values ";
                    sql += "(:m_mabn,:m_mavaovien,:m_idtheuudai,:m_idnhommien,:m_tyle,:m_userid,:m_computer)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                    cmd.Parameters.Add("m_idtheuudai", NpgsqlDbType.Numeric).Value = m_idtheuudai;
                    cmd.Parameters.Add("m_idnhommien", NpgsqlDbType.Numeric).Value = m_idnhommien;
                    cmd.Parameters.Add("m_tyle", NpgsqlDbType.Numeric).Value = m_tyle;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    cmd.Parameters.Add("m_computer", NpgsqlDbType.Numeric).Value = m_computer;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "tylemien_ud");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_tylemien_mg(string m_mabn, decimal m_mavaovien, int m_idnhommien, int m_tyle, int m_nguoiduyet, int m_userid, int m_computer)
        {
            sql = "update " + user + ".tylemien_mg set nguoiduyetmien=:m_nguoiduyet,tyle=:m_tyle,userid=:m_userid,computer=:m_computer where mabn=:m_mabn and mavaovien=:m_mavaovien and id_nhommien=:m_idnhommien";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("m_nguoiduyet", NpgsqlDbType.Numeric).Value = m_nguoiduyet;
                cmd.Parameters.Add("m_tyle", NpgsqlDbType.Numeric).Value = m_tyle;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_computer", NpgsqlDbType.Numeric).Value = m_computer;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                cmd.Parameters.Add("m_idnhommien", NpgsqlDbType.Numeric).Value = m_idnhommien;

                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".tylemien_mg(mabn,mavaovien,nguoiduyetmien,id_nhommien,tyle,userid,computer) values ";
                    sql += "(:m_mabn,:m_mavaovien,:m_nguoiduyet,:m_idnhommien,:m_tyle,:m_userid,:m_computer)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                    cmd.Parameters.Add("m_nguoiduyet", NpgsqlDbType.Numeric).Value = m_nguoiduyet;
                    cmd.Parameters.Add("m_idnhommien", NpgsqlDbType.Numeric).Value = m_idnhommien;
                    cmd.Parameters.Add("m_tyle", NpgsqlDbType.Numeric).Value = m_tyle;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    cmd.Parameters.Add("m_computer", NpgsqlDbType.Numeric).Value = m_computer;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "tylemien_mg");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        //End Khuong 04/06/2011

        //Khuong 06/06/2011
        public bool upd_yeucauhoadon(string m_mabn, decimal m_mavaovien, string m_ngay, string m_donvi, string m_dcdonvi, string m_masothue, string m_dcnhan, string m_nguoinhan, int m_userid, int m_computer)
        {
            sql = "update " + user + ".yeucauhoadon set ngay=:m_ngay,donvi=:m_donvi,dcdonvi=:m_dcdonvi,masothue=:m_masothue,dcnhan=:m_dcnhan,nguoinhan=:m_nguoinhan,userid=:m_userid,computer=:m_computer where mabn=:m_mabn and mavaovien=:m_mavaovien ";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDate(m_ngay);
                cmd.Parameters.Add("m_donvi", NpgsqlDbType.Varchar).Value = m_donvi;
                cmd.Parameters.Add("m_dcdonvi", NpgsqlDbType.Varchar).Value = m_dcdonvi;
                cmd.Parameters.Add("m_masothue", NpgsqlDbType.Varchar).Value = m_masothue;
                cmd.Parameters.Add("m_dcnhan", NpgsqlDbType.Varchar).Value = m_dcnhan;
                cmd.Parameters.Add("m_nguoinhan", NpgsqlDbType.Varchar).Value = m_nguoinhan;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_computer", NpgsqlDbType.Numeric).Value = m_computer;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;

                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".yeucauhoadon(mabn,mavaovien,ngay,donvi,dcdonvi,masothue,dcnhan,nguoinhan,userid,computer) values ";
                    sql += "(:m_mabn,:m_mavaovien,:m_ngay,:m_donvi,:m_dcdonvi,:m_masothue,:m_dcnhan,:m_nguoinhan,:m_userid,:m_computer)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDate(m_ngay);
                    cmd.Parameters.Add("m_donvi", NpgsqlDbType.Varchar).Value = m_donvi;
                    cmd.Parameters.Add("m_dcdonvi", NpgsqlDbType.Varchar).Value = m_dcdonvi;
                    cmd.Parameters.Add("m_masothue", NpgsqlDbType.Varchar).Value = m_masothue;
                    cmd.Parameters.Add("m_dcnhan", NpgsqlDbType.Varchar).Value = m_dcnhan;
                    cmd.Parameters.Add("m_nguoinhan", NpgsqlDbType.Varchar).Value = m_nguoinhan;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    cmd.Parameters.Add("m_computer", NpgsqlDbType.Numeric).Value = m_computer;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "yeucauhoadon");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        //end Khuong 06/06/2011

        public bool upd_btdbn_trungcao(string m_mabn, decimal m_mavaovien, string m_thetrungcao, int m_userid)
        {
            sql = "update " + user + ".btdbn_trungcao set thetrungcao=:m_thetrungcao, userid=:m_userid where mabn=:m_mabn and mavaovien=:m_mavaovien ";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("m_thetrungcao", NpgsqlDbType.Varchar, 10).Value = m_thetrungcao;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;

                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".btdbn_trungcao(mabn,mavaovien,thetrungcao,userid) values ";
                    sql += "(:m_mabn,:m_mavaovien,:m_thetrungcao,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                    cmd.Parameters.Add("m_thetrungcao", NpgsqlDbType.Varchar).Value = m_thetrungcao;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "btdbn_trungcao");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        //Khuong 13/06/2011
        public bool upd_bndk_tg(string m_mabn, decimal m_mavaovien, int m_idloaitg)
        {
            string ngay = ngayhienhanh_server;
            string _sql = "insert into " + user + ".bndk_tg (mabn,mavaovien,id_loaitg,ngaygio) values(:m_mabn,:m_mavaovien,:m_idloaitg,:m_ngaygio) ";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(_sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                cmd.Parameters.Add("m_idloaitg", NpgsqlDbType.Numeric).Value = m_idloaitg;
                cmd.Parameters.Add("m_ngaygio", NpgsqlDbType.Timestamp).Value = StringToDateTime(ngay);

                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "bndk_tg");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        //end Khuong 13/06/2011

        //Khuong 14/06/2011
        public bool upd_hachungtu(string m_mabn, decimal m_mavaovien, int m_idloaict, string m_duongdan, int m_userid)
        {
            sql = "update " + user + ".hachungtu set duongdan=:m_duongdan, userid=:m_userid where mabn=:m_mabn and mavaovien=:m_mavaovien and id_loaict=:m_idloaict ";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("m_duongdan", NpgsqlDbType.Varchar).Value = m_duongdan;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                cmd.Parameters.Add("m_idloaict", NpgsqlDbType.Numeric).Value = m_idloaict;

                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".hachungtu(mabn,mavaovien,id_loaict,duongdan,userid) values ";
                    sql += "(:m_mabn,:m_mavaovien,:m_idloaict,:m_duongdan,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                    cmd.Parameters.Add("m_idloaict", NpgsqlDbType.Numeric).Value = m_idloaict;
                    cmd.Parameters.Add("m_duongdan", NpgsqlDbType.Varchar).Value = m_duongdan;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "hachungtu");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        //end Khuong 14/06/2011

        //Khuong 15/06/2011
        //cap so thu tu trong phieu sang loc nan nhan bao luc gia dinh
        public decimal sttSangLocBLGD
        {
            get
            {
                DataTable dt_sangloc = new DataTable();
                sql = "select max(sott) from " + user + ".blgd_sangloc";
                dt_sangloc = get_data(sql).Tables[0];
                if (dt_sangloc.Rows[0][0].ToString().Trim() == "")
                    return 1;
                return decimal.Parse(dt_sangloc.Rows[0][0].ToString()) + 1;
            }
        }

        public bool upd_blgd_sangloc(decimal m_stt, string m_mabn, decimal m_mavaovien, decimal m_maql, string m_ngay, int m_tthonnhan, int m_baoluc, int m_userid)
        {
            sql = "update " + user + ".blgd_sangloc set tthonnhan=:m_tthonnhan, baolucgiadinh=:m_baoluc where mabn=:m_mabn and mavaovien=:m_mavaovien and maql=:m_maql ";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("m_tthonnhan", NpgsqlDbType.Numeric).Value = m_tthonnhan;
                cmd.Parameters.Add("m_baoluc", NpgsqlDbType.Numeric).Value = m_baoluc;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;

                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".blgd_sangloc(sott,mabn,mavaovien,maql,ngay,tthonnhan,baolucgiadinh,userid) values ";
                    sql += "(:m_stt,:m_mabn,:m_mavaovien,:m_maql,:m_ngay,:m_tthonnhan,:m_baoluc,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDate(m_ngay);
                    cmd.Parameters.Add("m_tthonnhan", NpgsqlDbType.Numeric).Value = m_tthonnhan;
                    cmd.Parameters.Add("m_baoluc", NpgsqlDbType.Numeric).Value = m_baoluc;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "blgd_sangloc");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        //end Khuong 15/06/2011

        //Khuong 16/06/2011
        public bool upd_blgd_vao(string m_mabn, decimal m_mavaovien, decimal m_maql, string m_ngay, int m_trinhdo, int m_tthonnhan, int m_chungsong, int m_contrai, int m_congai, string m_nguoigaybl, int m_quanhe, int m_tgchiudung, string m_tgchiudungkhac, string m_loaibl, string m_ghichu, string m_tiensu, string m_khamtt, int m_tonhai, int m_userid)
        {
            sql = "update " + user + ".blgd_vao set ngay=:m_ngay, tdhv=:m_trinhdo,tthonnhan=:m_tthonnhan,chungsong=:m_chungsong,contrai=:m_contrai,congai=:m_congai,tennguoigaybl=:m_nguoigaybl,quanhe=:m_quanhe,tgchiudung=:m_tgchiudung,tgchiudungkhac=:m_tgchiudungkhac,loaibaoluc=:m_loaibl,ghichu=:m_ghichu,tiensu=:m_tiensu,khamtt=:m_khamtt,tonhaisk=:m_tonhai where mabn=:m_mabn and mavaovien=:m_mavaovien  ";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDate(m_ngay);
                cmd.Parameters.Add("m_trinhdo", NpgsqlDbType.Numeric).Value = m_trinhdo;
                cmd.Parameters.Add("m_tthonnhan", NpgsqlDbType.Numeric).Value = m_tthonnhan;
                cmd.Parameters.Add("m_chungsong", NpgsqlDbType.Numeric).Value = m_chungsong;
                cmd.Parameters.Add("m_contrai", NpgsqlDbType.Numeric).Value = m_contrai;
                cmd.Parameters.Add("m_congai", NpgsqlDbType.Numeric).Value = m_congai;
                cmd.Parameters.Add("m_nguoigaybl", NpgsqlDbType.Varchar).Value = m_nguoigaybl;
                cmd.Parameters.Add("m_quanhe", NpgsqlDbType.Numeric).Value = m_quanhe;
                cmd.Parameters.Add("m_tgchiudung", NpgsqlDbType.Numeric).Value = m_tgchiudung;
                cmd.Parameters.Add("m_tgchiudungkhac", NpgsqlDbType.Varchar).Value = m_tgchiudungkhac;
                cmd.Parameters.Add("m_loaibl", NpgsqlDbType.Varchar).Value = m_loaibl;
                cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Varchar).Value = m_ghichu;
                cmd.Parameters.Add("m_tiensu", NpgsqlDbType.Varchar).Value = m_tiensu;
                cmd.Parameters.Add("m_khamtt", NpgsqlDbType.Varchar).Value = m_khamtt;
                cmd.Parameters.Add("m_tonhai", NpgsqlDbType.Numeric).Value = m_tonhai;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                //cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;

                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".blgd_vao(mabn,mavaovien,maql,ngay, tdhv,tthonnhan,chungsong,contrai,congai,tennguoigaybl,quanhe,tgchiudung,tgchiudungkhac,loaibaoluc,ghichu,tiensu,khamtt,tonhaisk,userid) values ";
                    sql += "(:m_mabn,:m_mavaovien,:m_maql,:m_ngay,:m_trinhdo,:m_tthonnhan,:m_chungsong,:m_contrai,:m_congai,:m_nguoigaybl,:m_quanhe,:m_tgchiudung,:m_tgchiudungkhac,:m_loaibl,:m_ghichu,:m_tiensu,:m_khamtt,:m_tonhai,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDate(m_ngay);
                    cmd.Parameters.Add("m_trinhdo", NpgsqlDbType.Numeric).Value = m_trinhdo;
                    cmd.Parameters.Add("m_tthonnhan", NpgsqlDbType.Numeric).Value = m_tthonnhan;
                    cmd.Parameters.Add("m_chungsong", NpgsqlDbType.Numeric).Value = m_chungsong;
                    cmd.Parameters.Add("m_contrai", NpgsqlDbType.Numeric).Value = m_contrai;
                    cmd.Parameters.Add("m_congai", NpgsqlDbType.Numeric).Value = m_congai;
                    cmd.Parameters.Add("m_nguoigaybl", NpgsqlDbType.Varchar).Value = m_nguoigaybl;
                    cmd.Parameters.Add("m_quanhe", NpgsqlDbType.Numeric).Value = m_quanhe;
                    cmd.Parameters.Add("m_tgchiudung", NpgsqlDbType.Numeric).Value = m_tgchiudung;
                    cmd.Parameters.Add("m_tgchiudungkhac", NpgsqlDbType.Varchar).Value = m_tgchiudungkhac;
                    cmd.Parameters.Add("m_loaibl", NpgsqlDbType.Varchar).Value = m_loaibl;
                    cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Varchar).Value = m_ghichu;
                    cmd.Parameters.Add("m_tiensu", NpgsqlDbType.Varchar).Value = m_tiensu;
                    cmd.Parameters.Add("m_khamtt", NpgsqlDbType.Varchar).Value = m_khamtt;
                    cmd.Parameters.Add("m_tonhai", NpgsqlDbType.Numeric).Value = m_tonhai;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "blgd_vao");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_blgd_ra(string m_mabn, decimal m_mavaovien, decimal m_maql, string m_xuly, int m_kedon, string m_danhgiaantoan, string m_tuvan, string m_kehoach, int m_xutri, string m_tinhtrangsk, int m_userid)
        {
            string m_ngay = ngayhienhanh_server;
            sql = "update " + user + ".blgd_ra set ngay=:m_ngay,xuly=:m_xuly,kedon=:m_kedon,danhgiaantoan=:m_danhgiaantoan,tuvan=:m_tuvan,kehoachantoan=:m_kehoach,xutri=:m_xutri,tinhtrangsk=:m_tinhtrangsk where mabn=:m_mabn and mavaovien=:m_mavaovien and maql=:m_maql ";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDate(m_ngay);
                cmd.Parameters.Add("m_xuly", NpgsqlDbType.Varchar).Value = m_xuly;
                cmd.Parameters.Add("m_kedon", NpgsqlDbType.Numeric).Value = m_kedon;
                cmd.Parameters.Add("m_danhgiaantoan", NpgsqlDbType.Varchar).Value = m_danhgiaantoan;
                cmd.Parameters.Add("m_tuvan", NpgsqlDbType.Varchar).Value = m_tuvan;
                cmd.Parameters.Add("m_kehoach", NpgsqlDbType.Varchar).Value = m_kehoach;
                cmd.Parameters.Add("m_xutri", NpgsqlDbType.Numeric).Value = m_xutri;
                cmd.Parameters.Add("m_tinhtrangsk", NpgsqlDbType.Varchar).Value = m_tinhtrangsk;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;

                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".blgd_ra(mabn,mavaovien,maql,ngay,xuly,kedon,danhgiaantoan,tuvan,kehoachantoan,xutri,tinhtrangsk,userid) values ";
                    sql += "(:m_mabn,:m_mavaovien,:m_maql,:m_ngay,:m_xuly,:m_kedon,:m_danhgiaantoan,:m_tuvan,:m_kehoach,:m_xutri,:m_tinhtrangsk,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_mavaovien", NpgsqlDbType.Numeric).Value = m_mavaovien;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDate(m_ngay);
                    cmd.Parameters.Add("m_xuly", NpgsqlDbType.Varchar).Value = m_xuly;
                    cmd.Parameters.Add("m_kedon", NpgsqlDbType.Numeric).Value = m_kedon;
                    cmd.Parameters.Add("m_danhgiaantoan", NpgsqlDbType.Varchar).Value = m_danhgiaantoan;
                    cmd.Parameters.Add("m_tuvan", NpgsqlDbType.Varchar).Value = m_tuvan;
                    cmd.Parameters.Add("m_kehoach", NpgsqlDbType.Varchar).Value = m_kehoach;
                    cmd.Parameters.Add("m_xutri", NpgsqlDbType.Numeric).Value = m_xutri;
                    cmd.Parameters.Add("m_tinhtrangsk", NpgsqlDbType.Varchar).Value = m_tinhtrangsk;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "blgd_ra");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        //end Khuong 16/06/2011

        //Khuong 20/06/2011
        /// <summary>
        /// B16: Bat buoc nhap thong tin nguoi than doi voi bn nho hon 72 thang tuoi hoac benh nhan cap cuu
        /// </summary>
        public bool bThongtinNguoithan
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1086");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bChuphinhTraiTuyen
        {//B14.1
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1087");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        //end Khuong 20/06/2011
        /// <summary>
        /// Hiền thêm: F39: nhóm thuốc hướng tâm thần
        /// </summary>
        public string Nhom_thuoc_huong_tam
        {
            get
            {
                try
                {//linh
                    DataSet dstmp = get_data("select array(select id from " + user + ".d_dmbd where tt11=1)");
                    return dstmp.Tables[0].Rows[0][0].ToString();
                }
                catch { return ""; }
            }
        }

        //Khuong 23/06/2011
        /// <summary>
        /// Cap nhat chi dinh dich vy, thuoc duoc phep dung. Voi loai =0 la cap nhat vien phi, loai =1 cap nhat thuoc
        /// </summary>
        /// <param name="m_icd10"></param>
        /// <param name="m_mavp"></param>
        /// <param name="m_loai"></param>
        /// <returns></returns>
        public bool upd_icd10_chidinh(string m_icd10, string m_mavp, int m_loai)
        {
            sql = "update " + user + ".icd10_chidinh set ";
            if (m_loai == 0) sql += " mavp=:m_mavp ";
            else sql += " mabd=:m_mavp ";
            sql += " where maicd10=:m_icd10 ";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("m_mavp", NpgsqlDbType.Varchar).Value = m_mavp;
                cmd.Parameters.Add("m_icd10", NpgsqlDbType.Varchar).Value = m_icd10;

                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".icd10_chidinh(maicd10,";
                    if (m_loai == 0) sql += " mavp ) values ";
                    else sql += " mabd ) values ";

                    sql += "(:m_icd10,:m_mavp)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_icd10", NpgsqlDbType.Varchar).Value = m_icd10;
                    cmd.Parameters.Add("m_mavp", NpgsqlDbType.Varchar).Value = m_mavp;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "icd10_chidinh");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        //End Khuong 23/06/2011

        //Khuong 26/06/2011

        public bool bMienphuthuKham_BnDiungthuoc
        {//G87
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1089");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        //End Khuong 26/06/2011

        //Khuong 27/06/2011
        public bool upd_user_active(int m_userid, string m_makp, string m_mabs, string m_ngay)
        {
            execute_data("delete from " + user + ".user_active where userid=" + m_userid + " and makp='" + m_makp + "' and to_char(ngay,'dd/mm/yyyy')='" + m_ngay + "'");
            sql = "insert into " + user + ".user_active(userid,makp,mabs,ngay) values (:m_userid,:m_makp,:m_mabs,:m_ngay)";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();

                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar).Value = m_makp;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar).Value = m_mabs;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDate(m_ngay);
                cmd.ExecuteNonQuery();
                cmd.Dispose();

            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "user_active");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        //End Khuong 27/06/2011

        //Khuong 28/06/2011
        public bool bBNPhongluu_nhapnguoithan
        {//B17
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1091");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        //End Khuong 28/06/2011
        public bool bBHYT_QRCode_Dangky
        {//B18
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1600");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bSTT_phieulinhbangSTTcongkhai
        {//B18
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=50114");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bChuyenvien_ngoaids_duyet
        {//B17
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1092");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bBH_chitra_1congkham_conlai_dttunguyen_G79_2
        {//G79.2
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1096");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public bool bCongkham_Chenhlech_nguoidungchon_khidangky
        {//G88
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1097");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        //Khuong 03/11/2011
        public bool bDondichvu_capnhieulantrongngay
        {//F43
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1100");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        //Khuong 03/07/2011
        public bool upd_phanung_sautc(string m_mabn, decimal m_id, int m_stt, string m_tenbome, string m_mota, string m_tiensu, int m_tinhtrang, string m_ghichu, string m_ngay, int m_userid)
        {
            sql = "update " + user + ".phanung_sautc set ngay=:m_ngay,tenbome=:m_tenbome,mota=:m_mota,tiensu=:m_tiensu,id_tinhtrang=:m_tinhtrang,ghichu=:m_ghichu,userid=:m_userid where mabn=:m_mabn and id=:m_id and stt=:m_stt ";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDate(m_ngay);
                cmd.Parameters.Add("m_tenbome", NpgsqlDbType.Varchar).Value = m_tenbome;
                cmd.Parameters.Add("m_mota", NpgsqlDbType.Text).Value = m_mota;
                cmd.Parameters.Add("m_tiensu", NpgsqlDbType.Text).Value = m_tiensu;
                cmd.Parameters.Add("m_tinhtrang", NpgsqlDbType.Numeric).Value = m_tinhtrang;
                cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text).Value = m_ghichu;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;

                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".phanung_sautc(mabn,id,stt,ngay,tenbome,mota,tiensu,id_tinhtrang,ghichu,userid) values ";
                    sql += "(:m_mabn,:m_id,:m_stt,:m_ngay,:m_tenbome,:m_mota,:m_tiensu,:m_tinhtrang,:m_ghichu,:m_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Timestamp).Value = StringToDate(m_ngay);
                    cmd.Parameters.Add("m_tenbome", NpgsqlDbType.Varchar).Value = m_tenbome;
                    cmd.Parameters.Add("m_mota", NpgsqlDbType.Text).Value = m_mota;
                    cmd.Parameters.Add("m_tiensu", NpgsqlDbType.Text).Value = m_tiensu;
                    cmd.Parameters.Add("m_tinhtrang", NpgsqlDbType.Numeric).Value = m_tinhtrang;
                    cmd.Parameters.Add("m_ghichu", NpgsqlDbType.Text).Value = m_ghichu;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "phanung_sautc");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool bBNTuvong_dichvu
        {//C68
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1093");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public string sBNTuvong_dichvu
        {//C68
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1094");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return ""; }
            }
        }
        public bool bCaptoa_xong_tudongluu
        {//F40
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1095");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        //End Khuong 03/07/2011

        /// <summary>
        /// Kiem tra xem benh nhan da co ket qua cls hay chua. Chi kiem tra nhung vien phi trong option c68.
        /// </summary>
        /// <param name="_mabn"></param>
        /// <param name="_mavaovien"></param>
        /// <param name="_mmyy"></param>
        /// <returns>true neu da co ket qua</returns>
        public string sKtKetquaCLS(string _mabn, decimal _mavaovien, string _ngayvao, string _ngayra)
        {
            string[] s_mavp;
            DataTable dttam = new DataTable();
            string vp_chua = "";
            int ngaylamviec = Ngaylv_Ngayht;
            if (!bBNTuvong_dichvu)
                return "";
            else
            {
                s_mavp = sBNTuvong_dichvu.Trim().Trim(',').Split(',');
                sql = "select * from ( ";
                sql += " select e.mavaovien,e.mavp ";
                sql += " from xxx.cdha_bnll a,xxx.cdha_bnct b," + user + ".cdha_kythuat c,xxx.v_chidinh e ";
                sql += " where a.id=b.id and a.mabn='" + _mabn + "' and b.makt=c.makt and a.maql=e.maql and c.id_vp=e.mavp group by e.mavaovien,e.mavp ";
                sql += " ) where mavaovien=" + _mavaovien;
                dttam = get_data_mmyy(sql, _ngayvao, _ngayra, ngaylamviec).Tables[0];
                for (int i = 0; i < s_mavp.Length; i++)
                {
                    if (dttam.Select("mavp=" + s_mavp[i]).Length == 0)
                        vp_chua += s_mavp[i] + ",";
                }
                if (vp_chua != "")
                {
                    sql = "select ten from " + user + ".v_giavp where id in (" + vp_chua.Trim(',') + ")";
                    dttam = get_data(sql).Tables[0];
                    vp_chua = "";
                    for (int i = 0; i < dttam.Rows.Count; i++)
                    {
                        vp_chua += dttam.Rows[i]["ten"].ToString() + "; ";
                    }
                }
            }
            return vp_chua;
        }
        /// <summary>
        /// Sử dụng trong các form chỉ định: frmChidinh
        /// </summary>
        /// <param name="i_cn"></param>
        /// <returns></returns>
        public string f_getten_chinhanh(int i_cn)
        {
            string s_tencn = "";
            sql = "select * from " + user + ".dmchinhanh where id>0 and id=" + i_cn;
            DataSet lds = get_data(sql);
            if (lds == null || lds.Tables.Count <= 0 || lds.Tables[0].Rows.Count <= 0)
                s_tencn = "";
            else s_tencn = lds.Tables[0].Rows[0]["ten"].ToString();
            return s_tencn;
        }
        //linh
        /// <summary>
        /// Sử dụng trong các form khám bệnh: frmKhambenh_...
        /// </summary>
        /// <param name="s_mabv"></param>
        /// <returns></returns>
        public int HangBenhVien(string s_mabv)
        {
            string s_sql = "select mahang from " + userid + ".tenvien where mabv='" + s_mabv + "'";
            DataSet dstmp = new DataSet();
            dstmp = get_data(s_sql);
            if (dstmp != null)
            {
                return int.Parse(dstmp.Tables[0].Rows[0]["mahang"].ToString());
            }
            else
            {
                return -1;
            }
        }
        /// <summary>
        /// Sử dụng trong các form khám bệnh: frmKhambenh_...
        /// </summary>
        /// <param name="ngay"></param>
        /// <param name="maql"></param>
        /// <param name="field"></param>
        /// <returns></returns>
        public string get_lydokham(string ngay, decimal maql, string field)
        {
            ds = get_data("select " + field + " as lydo from " + userid + mmyy(ngay) + ".lydokham where maql=" + maql);
            if (ds.Tables[0].Rows.Count > 0) return ds.Tables[0].Rows[0]["lydo"].ToString();
            else return "";
        }
        /// <summary>
        /// Sử dụng trong các form khám bệnh: frmKhambenh_...
        /// </summary>
        /// <param name="m_maicd"></param>
        /// <returns></returns>
        public bool ManTinh(string m_maicd)
        {
            m_maicd = m_maicd.Trim(',');
            if (m_maicd == "") return false;
            string _mabenh = "";
            foreach (string _maicd in m_maicd.Split(','))
            {
                _mabenh += _maicd.Substring(0, 3) + ",";
            }
            _mabenh = _mabenh.Trim(',');
            _mabenh = "'" + _mabenh.Replace(",", "','") + "'";
            DataSet dstmp = get_data("select benhmantinh from " + userid + ".icd10 where substr(cicd10,1,3) in (" + _mabenh + ") and benhmantinh=1");
            return dstmp.Tables[0].Rows.Count > 0;
        }
        /// <summary>
        /// Tên databse link đến cơ sở 
        /// </summary>
        public string DatabseLinkName
        {
            set
            {
                dblink = value;
                dblink = dblink.Trim('@');
            }
        }
        //tu
        public bool upd_bienbantuvong(string m_mabn, decimal m_maql, string m_makp, int m_chinhanh,
            string m_mabs, string m_manv, string m_nguoithan, string m_hotennguoidua, string m_namsinh,
            int m_phai, string m_diachi, string m_cmnd, string m_quanhe, string m_phuongtien, string m_soxe, string m_tinhtrang
            , string m_chandoan, string m_daxuly, string m_ngaytuvong, string m_nguyennhan, string m_ykien, string m_taisan, string m_congan)
        {
            sql = "update " + user + ".bienbantuvong set maql=:m_maql,makp=:m_makp,chinhanh=:m_chinhanh";
            sql += ",mabs=:m_mabs,manv=:m_manv,nguoithan=:m_nguoithan,hotennguoidua=:m_hotennguoidua,namsinh=:m_namsinh,";
            sql += "phai=:m_phai,diachi=:m_diachi,cmnd=:m_cmnd,quanhe=:m_quanhe,phuongtien=:m_phuongtien, ";
            sql += "soxe=:m_soxe,tinhtrang=:m_tinhtrang,chandoan=:m_chandoan,daxuly=:m_daxuly,ngaytuvong=to_date(:m_ngaytuvong,'dd/mm/yyyy hh24:mi'),";
            sql += "nguyennhan=:m_nguyennhan,ykien=:m_ykien,taisan=:m_taisan,congan=:m_congan ";
            sql += " where mabn=:m_mabn";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar).Value = m_makp;
                cmd.Parameters.Add("m_chinhanh", NpgsqlDbType.Numeric).Value = m_chinhanh;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar).Value = m_mabs;
                cmd.Parameters.Add("m_manv", NpgsqlDbType.Varchar).Value = m_manv;
                cmd.Parameters.Add("m_nguoithan", NpgsqlDbType.Text).Value = m_nguoithan;
                cmd.Parameters.Add("m_hotennguoidua", NpgsqlDbType.Text).Value = m_hotennguoidua;
                cmd.Parameters.Add("m_namsinh", NpgsqlDbType.Varchar).Value = m_namsinh;
                cmd.Parameters.Add("m_phai", NpgsqlDbType.Numeric).Value = m_phai;
                cmd.Parameters.Add("m_diachi", NpgsqlDbType.Text).Value = m_diachi;
                cmd.Parameters.Add("m_cmnd", NpgsqlDbType.Varchar).Value = m_cmnd;
                cmd.Parameters.Add("m_quanhe", NpgsqlDbType.Text).Value = m_quanhe;
                cmd.Parameters.Add("m_phuongtien", NpgsqlDbType.Text).Value = m_phuongtien;
                cmd.Parameters.Add("m_soxe", NpgsqlDbType.Varchar).Value = m_soxe;
                cmd.Parameters.Add("m_tinhtrang", NpgsqlDbType.Text).Value = m_tinhtrang;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.Parameters.Add("m_daxuly", NpgsqlDbType.Text).Value = m_daxuly;
                cmd.Parameters.Add("m_ngaytuvong", NpgsqlDbType.Varchar).Value = m_ngaytuvong;
                cmd.Parameters.Add("m_nguyennhan", NpgsqlDbType.Text).Value = m_nguyennhan;
                cmd.Parameters.Add("m_ykien", NpgsqlDbType.Text).Value = m_ykien;
                cmd.Parameters.Add("m_taisan", NpgsqlDbType.Text).Value = m_taisan;
                cmd.Parameters.Add("m_congan", NpgsqlDbType.Text).Value = m_congan;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".bienbantuvong(mabn,maql,makp,chinhanh,mabs,manv,nguoithan,hotennguoidua,";
                    sql += "namsinh,phai,diachi,cmnd,quanhe,phuongtien,soxe,tinhtrang,chandoan,daxuly,ngaytuvong,";
                    sql += "nguyennhan,ykien,taisan,congan) ";
                    sql += "values (:m_mabn,:m_maql,:m_makp,:m_chinhanh,:m_mabs,:m_manv,:m_nguoithan,:m_hotennguoidua,";
                    sql += ":m_namsinh,:m_phai,:m_diachi,:m_cmnd,:m_quanhe,:m_phuongtien,:m_soxe,:m_tinhtrang,";
                    sql += ":m_chandoan,:m_daxuly,to_date(:m_ngaytuvong,'dd/mm/yyyy hh24:mi'),:m_nguyennhan,:m_ykien,:m_taisan,:m_congan)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar).Value = m_makp;
                    cmd.Parameters.Add("m_chinhanh", NpgsqlDbType.Numeric).Value = m_chinhanh;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar).Value = m_mabs;
                    cmd.Parameters.Add("m_manv", NpgsqlDbType.Varchar).Value = m_manv;
                    cmd.Parameters.Add("m_nguoithan", NpgsqlDbType.Text).Value = m_nguoithan;
                    cmd.Parameters.Add("m_hotennguoidua", NpgsqlDbType.Text).Value = m_hotennguoidua;
                    cmd.Parameters.Add("m_namsinh", NpgsqlDbType.Varchar).Value = m_namsinh;
                    cmd.Parameters.Add("m_phai", NpgsqlDbType.Numeric).Value = m_phai;
                    cmd.Parameters.Add("m_diachi", NpgsqlDbType.Text).Value = m_diachi;
                    cmd.Parameters.Add("m_cmnd", NpgsqlDbType.Varchar).Value = m_cmnd;
                    cmd.Parameters.Add("m_quanhe", NpgsqlDbType.Text).Value = m_quanhe;
                    cmd.Parameters.Add("m_phuongtien", NpgsqlDbType.Text).Value = m_phuongtien;
                    cmd.Parameters.Add("m_soxe", NpgsqlDbType.Varchar).Value = m_soxe;
                    cmd.Parameters.Add("m_tinhtrang", NpgsqlDbType.Text).Value = m_tinhtrang;
                    cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                    cmd.Parameters.Add("m_daxuly", NpgsqlDbType.Text).Value = m_daxuly;
                    cmd.Parameters.Add("m_ngaytuvong", NpgsqlDbType.Varchar).Value = m_ngaytuvong;
                    cmd.Parameters.Add("m_nguyennhan", NpgsqlDbType.Text).Value = m_nguyennhan;
                    cmd.Parameters.Add("m_ykien", NpgsqlDbType.Text).Value = m_ykien;
                    cmd.Parameters.Add("m_taisan", NpgsqlDbType.Text).Value = m_taisan;
                    cmd.Parameters.Add("m_congan", NpgsqlDbType.Text).Value = m_congan;
                    cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "bienbantuvong");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        //end tu
        public bool upd_lienhe(string m_ngay, decimal m_maql, string m_sonha, string m_thon, string m_cholam, string m_matt, string m_maqu,
            string m_maphuongxa, string m_tuoivao, int m_loai, int m_bnmoi, string m_chuyendi)
        {
            string _mmyy = mmyy(m_ngay);
            if (bMmyy(_mmyy))
            {
                dblink = dblink.Trim('@');
                dblink = dblink == "" ? "" : "@" + dblink;
                string s_chema = userid + _mmyy;
                string s_sql = "update " + s_chema + ".lienhe" + dblink + " set  sonha=:m_sonha,thon=:m_thon,cholam=:m_cholam,matt='" + m_matt + "',maqu='" + m_maqu + "'," +
                    "maphuongxa='" + m_maphuongxa + "',tuoivao='" + m_tuoivao + "',loai=" + m_loai.ToString() + ",bnmoi=" + m_bnmoi.ToString() + ",chuyendi='" + m_chuyendi + "'" +
                    " where maql=" + m_maql.ToString();
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                try
                {
                    con.Open();
                    cmd = new NpgsqlCommand(s_sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_sonha", NpgsqlDbType.Text).Value = m_sonha;
                    cmd.Parameters.Add("m_thon", NpgsqlDbType.Text).Value = m_thon;
                    cmd.Parameters.Add("m_cholam", NpgsqlDbType.Text).Value = m_cholam;
                    int i = cmd.ExecuteNonQuery();
                    if (i == 0)
                    {
                        s_sql = "insert into " + s_chema + ".lienhe" + dblink + "(maql,sonha,thon,cholam,matt,maqu,maphuongxa,tuoivao,loai,bnmoi,chuyendi)" +
                            "values (" + m_maql.ToString() + ",:m_sonha,:m_thon,:m_cholam,'" + m_matt + "','" + m_maqu + "','" + m_maphuongxa + "'," +
                            "'" + m_tuoivao + "'," + m_loai.ToString() + "," + m_bnmoi.ToString() + ",'" + m_chuyendi + "')";
                        cmd.Dispose();
                        cmd = new NpgsqlCommand(s_sql, con);
                        cmd.CommandType = CommandType.Text;
                        cmd.Parameters.Add("m_sonha", NpgsqlDbType.Text).Value = m_sonha;
                        cmd.Parameters.Add("m_thon", NpgsqlDbType.Text).Value = m_thon;
                        cmd.Parameters.Add("m_cholam", NpgsqlDbType.Text).Value = m_cholam;
                        cmd.ExecuteNonQuery();
                    }
                }
                catch (NpgsqlException ex)
                {
                    upd_error(m_ngay, ex.Message, sComputer, "lienhe");
                    return false;
                }
                finally
                {
                    cmd.Dispose();
                    con.Close(); con.Dispose();
                }
                return true;
            }
            return false;
        }
        public bool upd_btdbn(string m_mabn, string m_hoten, string m_ngaysinh, string m_namsinh,
            int m_phai, string m_mann, string m_madantoc, string m_sonha, string m_thon,
            string m_cholam, string m_matt, string m_maqu, string m_maphuongxa, int m_userid, string m_chuyendi, string m_cmnd)
        {
            dblink = dblink.Trim('@');
            dblink = dblink == "" ? "" : "@" + dblink;
            m_hotenkdau = Hoten_khongdau(m_hoten);
            string s_sql = "update " + userid + ".btdbn" + dblink + " set hoten=:m_hoten,ngaysinh=to_date(:m_ngaysinh,'dd/mm/yyyy'),namsinh='" + m_namsinh + "',phai=" + m_phai.ToString() + "," +
                "mann='" + m_mann + "',madantoc='" + m_madantoc + "',sonha=:m_sonha,thon=:m_thon,cholam=:m_cholam,matt='" + m_matt + "',maqu='" + m_maqu + "',maphuongxa='" + m_maphuongxa + "'," +
                "userid=" + m_userid.ToString() + ",hotenkdau='" + m_hotenkdau + "',chuyendi='" + m_chuyendi + "',cmnd='" + m_cmnd + "' where mabn='" + m_mabn + "'";

            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(s_sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_hoten", NpgsqlDbType.Text).Value = m_hoten;
                cmd.Parameters.Add("m_ngaysinh", NpgsqlDbType.Varchar, 10).Value = m_ngaysinh == "" ? null : m_ngaysinh; ;
                cmd.Parameters.Add("m_sonha", NpgsqlDbType.Text).Value = m_sonha;
                cmd.Parameters.Add("m_thon", NpgsqlDbType.Text).Value = m_thon;
                cmd.Parameters.Add("m_cholam", NpgsqlDbType.Text).Value = m_cholam;
                int i = cmd.ExecuteNonQuery();
                if (i == 0)
                {
                    s_sql = "insert into " + userid + ".btdbn" + dblink + "(mabn,hoten,ngaysinh,namsinh,phai,mann,madantoc,sonha,thon,cholam,matt,maqu,maphuongxa,userid,hotenkdau,chuyendi,cmnd) " +
                        "values ('" + m_mabn + "',:m_hoten,to_date(:m_ngaysinh,'dd/mm/yyyy'),'" + m_namsinh + "'," + m_phai.ToString() + ",'" + m_mann + "','" + m_madantoc + "',:m_sonha,:m_thon," +
                        ":m_cholam,'" + m_matt + "','" + m_maqu + "','" + m_maphuongxa + "'," + m_userid.ToString() + ",'" + m_hotenkdau + "','" + m_chuyendi + "','" + m_cmnd + "')";
                    cmd = new NpgsqlCommand(s_sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_hoten", NpgsqlDbType.Text).Value = m_hoten;
                    cmd.Parameters.Add("m_ngaysinh", NpgsqlDbType.Varchar, 10).Value = (m_ngaysinh == "" ? null : m_ngaysinh);
                    cmd.Parameters.Add("m_sonha", NpgsqlDbType.Text).Value = m_sonha;
                    cmd.Parameters.Add("m_thon", NpgsqlDbType.Text).Value = m_thon;
                    cmd.Parameters.Add("m_cholam", NpgsqlDbType.Text).Value = m_cholam;
                    cmd.ExecuteNonQuery();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "btdbn");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_tiepdon(string m_mabn, decimal m_mavaovien, decimal m_maql, string m_makp, string m_ngay, int m_madoituong, string m_sovaovien,
            string m_tuoivao, int m_userid, int m_bnmoi, int m_noitiepdon, int m_loai, string m_chuyendi)
        {
            dblink = dblink.Trim('@');
            dblink = dblink == "" ? "" : "@" + dblink;
            string _mmyy = mmyy(m_ngay);
            if (bMmyy(_mmyy))
            {
                string s_schema = userid + _mmyy;
                string s_sql = "update " + s_schema + ".tiepdon" + dblink + " set mabn='" + m_mabn + "',mavaovien=" + m_mavaovien.ToString() + ",makp='" + m_makp + "'," +
                    "ngay=to_timestamp('" + m_ngay + "','dd/mm/yyyy hh24:mi'),madoituong=" + m_madoituong.ToString() + ",sovaovien='" + m_sovaovien + "'," +
                    "tuoivao='" + m_tuoivao + "',userid=" + m_userid.ToString() + ",bnmoi=" + m_bnmoi.ToString() + ",noitiepdon=" + m_noitiepdon.ToString() + "," +
                    "loai=" + m_loai.ToString() + ",chuyendi='" + m_chuyendi + "' where maql=" + m_maql.ToString();
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                try
                {
                    con.Open();
                    cmd = new NpgsqlCommand(s_sql, con);
                    cmd.CommandType = CommandType.Text;
                    int i = cmd.ExecuteNonQuery();
                    if (i == 0)
                    {
                        cmd.Dispose();
                        s_sql = "insert into " + s_schema + ".tiepdon" + dblink + "(mabn,mavaovien,maql,makp,ngay,madoituong,sovaovien,tuoivao,userid," +
                            "bnmoi,noitiepdon,loai,chuyendi)" +
                            "values ('" + m_mabn + "'," + m_mavaovien.ToString() + "," + m_maql.ToString() + ",'" + m_makp + "',to_timestamp('" + m_ngay + "','dd/mm/yyyy hh24:mi')," +
                            m_madoituong.ToString() + ",'" + m_sovaovien + "','" + m_tuoivao + "'," + m_userid.ToString() + "," + m_bnmoi.ToString() + "," +
                            m_noitiepdon.ToString() + "," + m_loai.ToString() + ",'" + m_chuyendi + "')";
                        cmd = new NpgsqlCommand(s_sql, con);
                        cmd.CommandType = CommandType.Text;
                        cmd.ExecuteNonQuery();
                    }
                }
                catch (NpgsqlException ex)
                {
                    upd_error(m_ngay, ex.Message, sComputer, "tiepdon");
                    return false;
                }
                finally
                {
                    cmd.Dispose();
                    con.Close(); con.Dispose();
                }
                return true;
            }
            return false;
        }
        public bool upd_bhyt(string m_ngay, string m_mabn, decimal m_maql, string m_sothe, string m_denngay, string m_mabv,
           int m_maphu, string m_tungay, string m_ngay1, string m_ngay2, string m_ngay3, int m_traituyen, string m_chuyendi)
        {
            string _mmyy = mmyy(m_ngay);
            if (!bMmyy(_mmyy)) return false;
            dblink = dblink.Trim('@');
            dblink = dblink == "" ? "" : "@" + dblink;
            string s_sql = "update " + userid + _mmyy + ".bhyt" + dblink + " set mabn='" + m_mabn + "',sothe='" + m_sothe + "'";
            s_sql += ",denngay=to_date(:m_denngay,'dd/mm/yyyy')";
            s_sql += ",tungay=to_date(:m_tungay,'dd/mm/yyyy')";
            s_sql += ",ngay1=to_date(:m_ngay1,'dd/mm/yyyy')";
            s_sql += ",ngay2=to_date(:m_ngay2,'dd/mm/yyyy')";
            s_sql += ",ngay3=to_date(:m_ngay3,'dd/mm/yyyy')";
            s_sql += ",mabv='" + m_mabv + "',maphu=" + m_maphu.ToString();
            s_sql += ",traituyen=" + m_traituyen.ToString() + ",chuyendi='" + m_chuyendi + "'";
            s_sql += " where maql=" + m_maql.ToString();
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(s_sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_denngay", NpgsqlDbType.Varchar, 10).Value = (m_denngay == "" ? null : m_denngay.Substring(0, 10));
                cmd.Parameters.Add("m_tungay", NpgsqlDbType.Varchar, 10).Value = (m_tungay == "" ? null : m_tungay.Substring(0, 10));
                cmd.Parameters.Add("m_ngay1", NpgsqlDbType.Varchar, 10).Value = (m_ngay1 == "" ? null : m_ngay1.Substring(0, 10));
                cmd.Parameters.Add("m_ngay2", NpgsqlDbType.Varchar, 10).Value = (m_ngay2 == "" ? null : m_ngay2.Substring(0, 10));
                cmd.Parameters.Add("m_ngay3", NpgsqlDbType.Varchar, 10).Value = (m_ngay3 == "" ? null : m_ngay3.Substring(0, 10));
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    s_sql = "insert into " + userid + mmyy(m_ngay) + ".bhyt" + dblink + "(mabn,maql,sothe,denngay,mabv,maphu,tungay,ngay1,ngay2,ngay3," +
                        "traituyen,chuyendi) values ('" + m_mabn + "'," + m_maql.ToString() + ",'" + m_sothe + "'";
                    s_sql += ",to_date(:m_denngay,'dd/mm/yyyy')";
                    s_sql += ",'" + m_mabv + "'," + m_maphu.ToString() + "";
                    s_sql += ",to_date(:m_tungay,'dd/mm/yyyy')";
                    s_sql += ",to_date(:m_ngay1,'dd/mm/yyyy')";
                    s_sql += ",to_date(:m_ngay2,'dd/mm/yyyy')";
                    s_sql += ",to_date(:m_ngay3,'dd/mm/yyyy')";
                    s_sql += "," + m_traituyen.ToString() + ",'" + m_chuyendi + "')";
                    cmd = new NpgsqlCommand(s_sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_denngay", NpgsqlDbType.Varchar, 10).Value = (m_denngay == "" ? null : m_denngay.Substring(0, 10));
                    cmd.Parameters.Add("m_tungay", NpgsqlDbType.Varchar, 10).Value = (m_tungay == "" ? null : m_tungay.Substring(0, 10));
                    cmd.Parameters.Add("m_ngay1", NpgsqlDbType.Varchar, 10).Value = (m_ngay1 == "" ? null : m_ngay1.Substring(0, 10));
                    cmd.Parameters.Add("m_ngay2", NpgsqlDbType.Varchar, 10).Value = (m_ngay2 == "" ? null : m_ngay2.Substring(0, 10));
                    cmd.Parameters.Add("m_ngay3", NpgsqlDbType.Varchar, 10).Value = (m_ngay3 == "" ? null : m_ngay3.Substring(0, 10));
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message, sComputer, "Bhyt " + m_mabn);
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_kyten(string m_mabn, int m_loaichungtu, string m_ngay, int m_userid, string m_lydo)
        {
            string s_schema = userid;
            string s_sql = "insert into " + s_schema + ".kyten(mabn,loaichungtu,ngay,userid,computer,lydo)" +
                        "values ('" + m_mabn + "'," + m_loaichungtu.ToString() + ",to_date(:m_ngay,'dd/mm/yyyy')," + m_userid.ToString() + ",'" + sComputer + "',:m_lydo)";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(s_sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 10).Value = (m_ngay == "" ? null : m_ngay.Substring(0, 10));
                cmd.Parameters.Add("m_lydo", NpgsqlDbType.Text).Value = m_lydo;
                cmd.ExecuteNonQuery();
            }
            catch (NpgsqlException ex)
            {
                upd_error(m_ngay, ex.Message, sComputer, "kyten");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
            return true;
        }
        public int SoNgayToaThuocCanCanhBao
        {
            get
            {
                try
                {
                    DataSet dstmp = get_data("select ten from " + user + ".thongso where id=" + ((int)LibMedi.IDThongSo.ID_SoNgayToaThuocCanCanhBao).ToString());
                    return int.Parse(dstmp.Tables[0].Rows[0][0].ToString());
                }
                catch { return 0; }
            }
        }
        //Khuong 22/07/2011
        public bool upd_khamchuyenkhoa(string m_mabn, decimal m_mavaovien, decimal m_maql, string m_ngay, string m_yeucau, int m_userid)
        {
            sql = "update " + user + ".khamchuyenkhoa set yeucau=:m_yeucau,ngay=to_date('" + m_ngay + "','dd/mm/yyyy hh24:mi'),userid=" + m_userid.ToString() + " where mabn='" + m_mabn + "' and mavaovien=" + m_mavaovien.ToString() + " and maql=" + m_maql.ToString();
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_yeucau", NpgsqlDbType.Text).Value = m_yeucau;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".khamchuyenkhoa(mabn,mavaovien,maql,yeucau,ngay,userid) values ";
                    sql += "('" + m_mabn + "'," + m_mavaovien.ToString() + "," + m_maql.ToString() + ",:m_yeucau,to_date('" + m_ngay + "','dd/mm/yyyy hh24:mi')," + m_userid.ToString() + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_yeucau", NpgsqlDbType.Text).Value = m_yeucau;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "khamchuyenkhoa");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        //Thuy 02.01.2013
        public bool bHienChandoan_cuoicung
        {//C74
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1507");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }


        public bool upd_bavv_chung(string m_ngay, string m_mabn, decimal m_maql, string m_lydo, string m_hb_benhly, string m_hb_banthan, string m_hb_giadinh,
           string m_kb_toanthan, string m_kb_bophan, string m_kb_tomtat, string m_kb_xuli, string m_kb_chuy,
           string m_sobo, string m_phanbiet, int m_userid, string m_kb_chuyenkhoa)
        {
            string xxx = user + mmyy(m_ngay);
            sql = "update " + xxx + ".bavv_chung set mabn=:m_mabn,lydo=:m_lydo,hb_benhly=:m_hb_benhly,hb_banthan=:m_hb_banthan,hb_giadinh=:m_hb_giadinh,";
            sql += "kb_toanthan=:m_kb_toanthan,kb_bophan=:m_kb_bophan,";
            sql += "kb_tomtat=:m_kb_tomtat,kb_xuli=:m_kb_xuli,kb_chuy=:m_kb_chuy,";
            sql += "sobo=:m_sobo,phanbiet=:m_phanbiet,";
            sql += "userid=:m_userid,kb_chuyenkhoa=:m_kb_chuyenkhoa where maql=:m_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_lydo", NpgsqlDbType.Text).Value = m_lydo;
                cmd.Parameters.Add("m_hb_benhly", NpgsqlDbType.Text).Value = m_hb_benhly;
                cmd.Parameters.Add("m_hb_banthan", NpgsqlDbType.Text).Value = m_hb_banthan;
                cmd.Parameters.Add("m_hb_giadinh", NpgsqlDbType.Text).Value = m_hb_giadinh;
                cmd.Parameters.Add("m_kb_toanthan", NpgsqlDbType.Text).Value = m_kb_toanthan;
                cmd.Parameters.Add("m_kb_bophan", NpgsqlDbType.Text).Value = m_kb_bophan;
                cmd.Parameters.Add("m_kb_tomtat", NpgsqlDbType.Text).Value = m_kb_tomtat;
                cmd.Parameters.Add("m_kb_xuli", NpgsqlDbType.Text).Value = m_kb_xuli;
                cmd.Parameters.Add("m_kb_chuy", NpgsqlDbType.Text).Value = m_kb_chuy;
                cmd.Parameters.Add("m_sobo", NpgsqlDbType.Text).Value = m_sobo;
                cmd.Parameters.Add("m_phanbiet", NpgsqlDbType.Text).Value = m_phanbiet;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_kb_chuyenkhoa", NpgsqlDbType.Text).Value = m_kb_chuyenkhoa;
                cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".bavv_chung (mabn,maql,lydo,hb_benhly,hb_banthan,hb_giadinh,kb_toanthan,kb_bophan,kb_tomtat,kb_xuli," +
                        "kb_chuy,sobo,phanbiet,userid,kb_chuyenkhoa) values (:m_mabn,:m_maql,:m_lydo,:m_hb_benhly,:m_hb_banthan,:m_hb_giadinh," +
                        ":m_kb_toanthan,:m_kb_bophan,:m_kb_tomtat,:m_kb_xuli,:m_kb_chuy,:m_sobo,:m_phanbiet,:m_userid,:m_kb_chuyenkhoa)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_maql", NpgsqlDbType.Numeric).Value = m_maql;
                    cmd.Parameters.Add("m_lydo", NpgsqlDbType.Text).Value = m_lydo;
                    cmd.Parameters.Add("m_hb_benhly", NpgsqlDbType.Text).Value = m_hb_benhly;
                    cmd.Parameters.Add("m_hb_banthan", NpgsqlDbType.Text).Value = m_hb_banthan;
                    cmd.Parameters.Add("m_hb_giadinh", NpgsqlDbType.Text).Value = m_hb_giadinh;
                    cmd.Parameters.Add("m_kb_toanthan", NpgsqlDbType.Text).Value = m_kb_toanthan;
                    cmd.Parameters.Add("m_kb_bophan", NpgsqlDbType.Text).Value = m_kb_bophan;
                    cmd.Parameters.Add("m_kb_tomtat", NpgsqlDbType.Text).Value = m_kb_tomtat;
                    cmd.Parameters.Add("m_kb_xuli", NpgsqlDbType.Text).Value = m_kb_xuli;
                    cmd.Parameters.Add("m_kb_chuy", NpgsqlDbType.Text).Value = m_kb_chuy;
                    cmd.Parameters.Add("m_sobo", NpgsqlDbType.Text).Value = m_sobo;
                    cmd.Parameters.Add("m_phanbiet", NpgsqlDbType.Text).Value = m_phanbiet;
                    cmd.Parameters.Add("m_kb_chuyenkhoa", NpgsqlDbType.Text).Value = m_kb_chuyenkhoa;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "bavv_chung");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_theodoinhietdo(int m_id_phongthuchien, string m_ngay, int m_nhietdo_sang, int m_nhietdo_chieu, int m_userid)
        {
            string s_sql = "update " + user + ".theodoinhietdo set nhietdo_sang=" + m_nhietdo_sang + ",nhietdo_chieu=" + m_nhietdo_chieu + "," +
            "userid=" + m_userid.ToString() + ",ngayud=now() where id_phongthuchien=" + m_id_phongthuchien.ToString() + " and " +
            "ngay=to_date('" + m_ngay + "','dd/mm/yyyy')";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(s_sql, con);
                cmd.CommandType = CommandType.Text;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    s_sql = "update " + user + ".theodoinhietdo(id_phongthuchien,ngay,nhietdo_sang,nhietdo_chieu,userid) values(" +
                    m_id_phongthuchien.ToString() + "," +
                    "to_date('" + m_ngay + "','dd/mm/yyyy')," + m_nhietdo_sang + "," + m_nhietdo_chieu + "," + m_userid.ToString();
                    cmd = new NpgsqlCommand(s_sql, con);
                    cmd.CommandType = CommandType.Text;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "theodoinhietdo");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_theodoinhietdo(int m_id_phongthuchien, string m_ngay, int m_nhietdo, string m_loai, int m_userid)
        {
            string field = "nhietdo_sang";
            if (m_loai.ToLower() == "c")
            {
                field = "nhietdo_chieu";
            }
            string s_sql = "update " + user + ".theodoinhietdo set " + field + "=" + m_nhietdo + "," +
            "userid=" + m_userid.ToString() + ",ngayud=now() where id_phongthuchiencls=" + m_id_phongthuchien.ToString() + " and " +
            "ngay=to_date('" + m_ngay + "','dd/mm/yyyy')";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(s_sql, con);
                cmd.CommandType = CommandType.Text;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    s_sql = "insert into " + user + ".theodoinhietdo(id_phongthuchiencls,ngay," + field + ",userid) values(" +
                    m_id_phongthuchien.ToString() + "," +
                    "to_date('" + m_ngay + "','dd/mm/yyyy')," + m_nhietdo + "," + m_userid.ToString() + ")";
                    cmd = new NpgsqlCommand(s_sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "theodoinhietdo");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        //khuong
        public bool upd_theodoivltl(decimal m_id, string m_mabn, decimal m_mavaovien, decimal m_maql, string m_ngay, string m_mabs, string m_sieuam, string m_keodan, string m_dien, string m_tutruong, string m_apsuat, string m_khac, int m_userid)
        {
            sql = "update " + userid + ".theodoivltl set sieuam=:m_sieuam,keodan=:m_keodan,dien=:m_dien,tutruong=:m_tutruong,apsuat=:m_apsuat,khac=:m_khac,mabs='" + m_mabs + "', ngay=to_date('" + m_ngay + "','dd/mm/yyyy hh24:mi'),userid=" + m_userid.ToString() + " where id=" + m_id;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_sieuam", NpgsqlDbType.Text).Value = m_sieuam;
                cmd.Parameters.Add("m_keodan", NpgsqlDbType.Text).Value = m_keodan;
                cmd.Parameters.Add("m_dien", NpgsqlDbType.Text).Value = m_dien;
                cmd.Parameters.Add("m_tutruong", NpgsqlDbType.Text).Value = m_tutruong;
                cmd.Parameters.Add("m_apsuat", NpgsqlDbType.Text).Value = m_apsuat;
                cmd.Parameters.Add("m_khac", NpgsqlDbType.Text).Value = m_khac;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + userid + ".theodoivltl(id,mabn,mavaovien,maql,ngay,mabs,sieuam,keodan,dien,tutruong,apsuat,khac,userid) values ";
                    sql += "(" + m_id.ToString() + ",'" + m_mabn + "'," + m_mavaovien.ToString() + "," + m_maql.ToString() + ",to_date('" + m_ngay + "','dd/mm/yyyy hh24:mi'),'" + m_mabs + "',:m_sieuam,:m_keodan,:m_dien,:m_tutruong,:m_apsuat,:m_khac," + m_userid.ToString() + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_sieuam", NpgsqlDbType.Text).Value = m_sieuam;
                    cmd.Parameters.Add("m_keodan", NpgsqlDbType.Text).Value = m_keodan;
                    cmd.Parameters.Add("m_dien", NpgsqlDbType.Text).Value = m_dien;
                    cmd.Parameters.Add("m_tutruong", NpgsqlDbType.Text).Value = m_tutruong;
                    cmd.Parameters.Add("m_apsuat", NpgsqlDbType.Text).Value = m_apsuat;
                    cmd.Parameters.Add("m_khac", NpgsqlDbType.Text).Value = m_khac;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "theodoivltl");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        //KHUONG 060811

        public bool upd_phieutiemchung(decimal m_id, int m_stt, string m_mabn, string m_sophieu, int m_id_benhtc,
            int m_mabd, string m_muitiem, string m_ngaytiem, string m_ngaytiem_hen, int m_cosotiem, int m_userid, string m_vitritiem, string m_mabs, string m_makp)
        {
            sql = "update " + user + ".phieutiemchung set mabn=:m_mabn,sophieu=:m_sophieu,id_benhtc=:m_id_benhtc";
            sql += ",stt=:m_stt,muitiem=:m_muitiem,ngaytiem=to_date(:m_ngaytiem,'dd/mm/yyyy hh24:mi'),ngaytiem_hen=to_date(:m_ngaytiem_hen,'dd/mm/yyyy'),cosotiem=:m_cosotiem,";
            sql += "userid=:m_userid,vitritiem=:m_vitritiem,mabs=:m_mabs,makp='" + m_makp + "' ";
            sql += " where id=:m_id and mabd=:m_mabd";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                cmd.Parameters.Add("m_sophieu", NpgsqlDbType.Varchar).Value = m_sophieu;
                cmd.Parameters.Add("m_id_benhtc", NpgsqlDbType.Numeric).Value = m_id_benhtc;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                cmd.Parameters.Add("m_muitiem", NpgsqlDbType.Text).Value = m_muitiem;
                cmd.Parameters.Add("m_ngaytiem", NpgsqlDbType.Varchar).Value = m_ngaytiem;
                cmd.Parameters.Add("m_ngaytiem_hen", NpgsqlDbType.Varchar).Value = m_ngaytiem_hen;
                cmd.Parameters.Add("m_cosotiem", NpgsqlDbType.Numeric).Value = m_cosotiem;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_vitritiem", NpgsqlDbType.Text).Value = m_vitritiem;
                cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar).Value = m_mabs;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                cmd.Parameters.Add("m_mabd", NpgsqlDbType.Numeric).Value = m_mabd;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".phieutiemchung(id,stt,mabn,sophieu,id_benhtc,mabd,muitiem,ngaytiem,ngaytiem_hen,cosotiem,userid,vitritiem,mabs,makp) ";
                    sql += "values (:m_id,:m_stt,:m_mabn,:m_sophieu,:m_id_benhtc,:m_mabd,:m_muitiem,to_date(:m_ngaytiem,'dd/mm/yyyy hh24:mi'),to_date(:m_ngaytiem_hen,'dd/mm/yyyy'),:m_cosotiem,:m_userid,:m_vitritiem,:m_mabs,'" + m_makp + "')";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Numeric).Value = m_stt;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_sophieu", NpgsqlDbType.Varchar).Value = m_sophieu;
                    cmd.Parameters.Add("m_id_benhtc", NpgsqlDbType.Numeric).Value = m_id_benhtc;
                    cmd.Parameters.Add("m_mabd", NpgsqlDbType.Numeric).Value = m_mabd;
                    cmd.Parameters.Add("m_muitiem", NpgsqlDbType.Text).Value = m_muitiem;
                    cmd.Parameters.Add("m_ngaytiem", NpgsqlDbType.Varchar).Value = m_ngaytiem;
                    cmd.Parameters.Add("m_ngaytiem_hen", NpgsqlDbType.Varchar).Value = m_ngaytiem_hen;
                    cmd.Parameters.Add("m_cosotiem", NpgsqlDbType.Numeric).Value = m_cosotiem;
                    cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                    cmd.Parameters.Add("m_vitritiem", NpgsqlDbType.Text).Value = m_vitritiem;
                    cmd.Parameters.Add("m_mabs", NpgsqlDbType.Varchar).Value = m_mabs;
                    cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "phieutiemchung");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_huyvacxin(decimal m_id, string m_soluutru, string m_ngay, string m_madieuduong, string m_truongbophan, string m_dieuduongphong, string m_tungay, string m_denngay, int m_mabd, decimal m_soluong, string m_losx, int m_userid)
        {
            sql = "update " + userid + ".huyvacxin set soluutru='" + m_soluutru + "',ngay=to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),madieuduong='" + m_madieuduong + "',truongbophan='" + m_truongbophan + "'," +
                "dieuduongphong='" + m_dieuduongphong + "',tungay=to_date(:m_tungay,'dd/mm/yyyy'),denngay=to_date(:m_denngay,'dd/mm/yyyy')," +
               "mabd=" + m_mabd.ToString() + ",losx=:m_losx,soluong=" + m_soluong.ToString() + ",userid=" + m_userid.ToString() + " where id=" + m_id.ToString();
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar).Value = m_ngay == "" ? null : m_ngay;
                cmd.Parameters.Add("m_tungay", NpgsqlDbType.Varchar).Value = m_tungay == "" ? null : m_tungay;
                cmd.Parameters.Add("m_denngay", NpgsqlDbType.Varchar).Value = m_denngay == "" ? null : m_denngay;
                cmd.Parameters.Add("m_losx", NpgsqlDbType.Text).Value = m_losx;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + userid + ".huyvacxin(id,soluutru,ngay,madieuduong,truongbophan,dieuduongphong,tungay,denngay,mabd,soluong,losx,userid) values ";
                    sql += "(" + m_id.ToString() + ",'" + m_soluutru + "',to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),'" + m_madieuduong + "','" + m_truongbophan + "','" + m_dieuduongphong + "',to_date(:m_tungay,'dd/mm/yyyy')," +
                        "to_date(:m_denngay,'dd/mm/yyyy')," + m_mabd.ToString() + "," + m_soluong.ToString() + ",:m_losx," + m_userid.ToString() + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar).Value = m_ngay == "" ? null : m_ngay;
                    cmd.Parameters.Add("m_tungay", NpgsqlDbType.Varchar).Value = m_tungay == "" ? null : m_tungay;
                    cmd.Parameters.Add("m_denngay", NpgsqlDbType.Varchar).Value = m_denngay == "" ? null : m_denngay;
                    cmd.Parameters.Add("m_losx", NpgsqlDbType.Text).Value = m_losx;
                    cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "huyvacxin");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public string getSoluutru_huyVacxin(int m_chinhanh)
        {
            return m_chinhanh.ToString().PadLeft(2, '0') + Ngayhienhanh.Substring(8, 2) + get_capid(-406).ToString().PadLeft(6, '0'); ;
        }

        //END KHUONG 060811
        //Tu:22/08/2011 kiem tra tinh hop le cua the BHYT theo qui dinh cua BHYT
        private bool bKiemtrasothe
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=997");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        private string sKituchuoi
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=9971");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return ""; }
            }
        }
        private string sKituso
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=9972");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return ""; }
            }
        }
        public bool bKiemtrasothehople(string sothe)
        {
            if (!bKiemtrasothe) return true;
            try
            {
                int flag = 0;
                string s_5kitudau = sothe.Substring(0, 5);
                if (sKituchuoi.IndexOf(s_5kitudau.Substring(0, 2).Trim()) >= 0)
                {
                    flag = 1;
                }
                if (flag == 1)//kiem tra 2 ki chu
                {
                    flag = 0;
                    if (s_5kitudau.Substring(2, 1).Trim() != "0") flag = 1;
                    if (flag == 1)//kiem tra ki tu thu 3 nam trong 1->9
                    {
                        flag = 0;
                        if (sKituso.IndexOf(s_5kitudau.Substring(3, 2).Trim()) >= 0)
                            flag = 1;
                        if (flag == 0) return true;//kiem tra 2 ki tu ma tinh ngoai qui dinh đã khai báo là không cho khám thì return true => cho khám
                        else return false;
                    }
                    else
                        return false;
                }
                else
                    return false;
            }
            catch { return false; }
        }
        //end Tu
        public bool bQuanly_thuocmo//gam 09/09/2011
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=445");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool upd_pttt_chandoan(decimal m_id, string m_icd, string m_chandoan, int m_userid, int m_loai)
        {

            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();

                sql = "insert into " + userid + ".pttt_chandoan(id,maicd,chandoan,userid,loai) values ";
                sql += "(" + m_id.ToString() + ",:m_maicd,:m_chandoan," + m_userid.ToString() + "," + m_loai + ")";
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar).Value = m_icd;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.ExecuteNonQuery();
                cmd.Dispose();

            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "pttt_chandoan");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        //Khuong 16/12/2011
        public bool upd_pttt_phuongphap(decimal m_id, string m_icd, string m_chandoan, int m_userid)
        {

            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();

                sql = "insert into " + userid + ".pttt_phuongphap(id,mapt,tenpt,userid) values ";
                sql += "(" + m_id.ToString() + ",:m_maicd,:m_chandoan," + m_userid.ToString() + ")";
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_maicd", NpgsqlDbType.Varchar).Value = m_icd;
                cmd.Parameters.Add("m_chandoan", NpgsqlDbType.Text).Value = m_chandoan;
                cmd.ExecuteNonQuery();
                cmd.Dispose();

            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "pttt_phuongphap");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        #region Ly Thanh Cuong (điều kiện vụ kế hoạch)
        public bool upd_kh_dm_dk(string m_ma, string m_ten, string m_dk, string m_table)
        {
            sql = "update " + user + "." + m_table + " set ten=:m_ten,dk=:m_dk where ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Varchar, 100).Value = m_ten;
                cmd.Parameters.Add("m_dk", NpgsqlDbType.Varchar, 50).Value = m_dk;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 3).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + "." + m_table + "(ma,ten,dk) values ";
                    sql += "(:m_ma,:m_ten,:m_dk)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 3).Value = m_ma;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Varchar, 100).Value = m_ten;
                    cmd.Parameters.Add("m_dk", NpgsqlDbType.Varchar, 50).Value = m_dk;
                    cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, m_table);
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_kh_dm(int m_ma, string m_stt, string m_ten, string m_table)
        {
            sql = "update " + user + "." + m_table + " set stt=:m_stt,ten=:m_ten where ma=:m_ma";
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Varchar, 2).Value = m_stt;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Varchar, 100).Value = m_ten;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 2).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + "." + m_table + "(ma,stt,ten) values ";
                    sql += "(:m_ma,:m_stt,:m_ten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 2).Value = m_ma;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Varchar, 2).Value = m_stt;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Varchar, 100).Value = m_ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, m_table);
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_kh_dm_dv(int m_ma, string m_stt, string m_ten, string m_table, string m_donvi)
        {
            sql = "update " + user + "." + m_table + " set stt=:m_stt,ten=:m_ten,donvi=:m_donvi where ma=:m_ma";
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_stt", NpgsqlDbType.Varchar, 2).Value = m_stt;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Varchar, 100).Value = m_ten;
                cmd.Parameters.Add("m_donvi", NpgsqlDbType.Varchar, 20).Value = m_donvi;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 2).Value = m_ma;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + "." + m_table + "(ma,stt,ten,donvi) values ";
                    sql += "(:m_ma,:m_stt,:m_ten,:m_donvi)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 2).Value = m_ma;
                    cmd.Parameters.Add("m_stt", NpgsqlDbType.Varchar, 2).Value = m_stt;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Varchar, 100).Value = m_ten;
                    cmd.Parameters.Add("m_donvi", NpgsqlDbType.Varchar, 20).Value = m_donvi;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, m_table);
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }


        public void CapNhat_dk_VuKeHoach()
        {
            //update datapase
            sql = " alter table " + user + ".kh_bieu_05 add C15 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_dm_05 add C15 number DEFAULT 0";
            execute_data(sql);

            sql = " alter table " + user + ".kh_bieu_06 add C32 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_06 add C33 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_06 add C34 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_06 add C35 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_06 add C36 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_06 add C37 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_06 add C38 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_dm_06 add C32 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_dm_06 add C33 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_dm_06 add C34 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_dm_06 add C35 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_dm_06 add C36 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_dm_06 add C37 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_dm_06 add C38 number DEFAULT 0";
            execute_data(sql);

            sql = " alter table " + user + ".kh_dm_07 add donvi nvarchar2(20)";
            execute_data(sql);
            sql = " alter table " + user + ".kh_dm_07 add C10 nvarchar2(200)";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_07 add C10 nvarchar2(200)";
            execute_data(sql);

            sql = " alter table " + user + ".kh_dm_131 add C24 nvarchar2(200)";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_131 add C24 nvarchar2(200)";
            execute_data(sql);

            sql = " alter table " + user + ".kh_bieu_141 add C29 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_141 add C30 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_141 add C31 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_141 add C32 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_141 add C33 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_141 add C34 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_141 add C35 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_141 add C36 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_141 add C37 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_141 add C38 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_141 add C39 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_141 add C40 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_141 add C41 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_141 add C42 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_141 add C43 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_141 add C44 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_141 add C45 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_141 add C46 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_141 add C47 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_141 add C48 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_141 add C49 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_141 add C50 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_141 add C51 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_141 add C52 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_141 add C53 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_141 add C54 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_141 add C55 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_141 add C56 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_dm_141 add C29 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_dm_141 add C30 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_dm_141 add C31 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_dm_141 add C32 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_dm_141 add C33 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_dm_141 add C34 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_dm_141 add C35 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_dm_141 add C36 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_dm_141 add C37 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_dm_141 add C38 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_dm_141 add C39 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_dm_141 add C40 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_dm_141 add C41 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_dm_141 add C42 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_dm_141 add C43 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_dm_141 add C44 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_dm_141 add C45 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_dm_141 add C46 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_dm_141 add C47 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_dm_141 add C48 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_dm_141 add C49 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_dm_141 add C50 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_dm_141 add C51 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_dm_141 add C52 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_dm_141 add C53 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_dm_141 add C54 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_dm_141 add C55 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_dm_141 add C56 number DEFAULT 0";
            execute_data(sql);

            sql = " alter table " + user + ".kh_bieu_15 add C07 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_15 add C08 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_15 add C09 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_15 add C10 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_15 add C11 number DEFAULT 0";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_15 add C12 number DEFAULT 0";
            execute_data(sql);

            sql = " alter table " + user + ".kh_dm_15_dk alter ten type varchar(200)";
            execute_data(sql);

            sql = " alter table " + user + ".kh_dm_08 add donvi varchar(20)";
            execute_data(sql);
            sql = " alter table " + user + ".kh_bieu_08 alter c06 type varchar(200)";
            execute_data(sql);
            sql = " alter table " + user + ".kh_dm_08 alter c06 type varchar(200)";
            execute_data(sql);

            sql = " alter table " + user + ".kh_bieu_123 alter c20 type varchar(200)";
            execute_data(sql);
            sql = " alter table " + user + ".kh_dm_123 alter c20 type varchar(200)";
            execute_data(sql);
            //


            //Biểu 01
            upd_kh_dm_dk("C01", "", "", "kh_dm_01_dk");
            upd_kh_dm_dk("C02", "Tên huyện, thị xã, thành phố", "", "kh_dm_01_dk");
            upd_kh_dm_dk("C03", "Dân số có đến 1/7", "", "kh_dm_01_dk");
            upd_kh_dm_dk("C04", "Trong đó\\Nữ", "", "kh_dm_01_dk");
            upd_kh_dm_dk("C05", "Trong đó\\Trẻ em < 5 tuổi", "", "kh_dm_01_dk");
            upd_kh_dm_dk("C06", "Trong đó\\Trẻ em < 6 tuổi", "", "kh_dm_01_dk");
            upd_kh_dm_dk("C07", "Trong đó\\Trẻ em < 15 tuổi", "", "kh_dm_01_dk");
            upd_kh_dm_dk("C08", "TS xã phường, thị trấn", "", "kh_dm_01_dk");
            upd_kh_dm_dk("C09", "Trong đó: Vùng sâu", "", "kh_dm_01_dk");
            upd_kh_dm_dk("C10", "Trong đó: Vùng núi", "", "kh_dm_01_dk");
            upd_kh_dm_dk("C11", "Trong đó: Hải đảo", "", "kh_dm_01_dk");
            upd_kh_dm_dk("C12", "Trong đó: Đồng bằng", "", "kh_dm_01_dk");
            upd_kh_dm_dk("C13", "Số thôn/ bản", "", "kh_dm_01_dk");
            //Biểu 02
            upd_kh_dm_dk("C01", "Số trẻ đẻ sống\\Tổng số", "", "kh_dm_02_dk");
            upd_kh_dm_dk("C02", "Số trẻ đẻ sống\\Trong đó: Nữ", "", "kh_dm_02_dk");
            upd_kh_dm_dk("C03", "Tổng số chết\\Tổng số", "", "kh_dm_02_dk");
            upd_kh_dm_dk("C04", "Tổng số chết\\Trong đó: Nữ", "", "kh_dm_02_dk");
            upd_kh_dm_dk("C05", "Trong đó\\Chết < 1 tuổi\\Tổng số", "", "kh_dm_02_dk");
            upd_kh_dm_dk("C06", "Trong đó\\Chết < 1 tuổi\\Nữ", "", "kh_dm_02_dk");
            upd_kh_dm_dk("C07", "Trong đó\\Chết < 5 tuổi\\Tổng số", "", "kh_dm_02_dk");
            upd_kh_dm_dk("C08", "Trong đó\\Chết < 5 tuổi\\Nữ", "", "kh_dm_02_dk");
            upd_kh_dm_dk("C09", "Chết mẹ", "", "kh_dm_02_dk");
            //Biểu 04a
            upd_kh_dm_dk("C01", "Bệnh viện\\Cơ sở", "", "kh_dm_05_dk");
            upd_kh_dm_dk("C02", "Bệnh viện\\Giường bệnh\\KH", "", "kh_dm_05_dk");
            upd_kh_dm_dk("C03", "Bệnh viện\\Giường bệnh\\Thực kê", "", "kh_dm_05_dk");
            upd_kh_dm_dk("C04", "Điều dưỡng\\Cơ sở", "", "kh_dm_05_dk");
            upd_kh_dm_dk("C05", "Điều dưỡng\\Giường", "", "kh_dm_05_dk");
            upd_kh_dm_dk("C06", "Phòng khám\\Cơ sở", "", "kh_dm_05_dk");
            upd_kh_dm_dk("C07", "Phòng khám\\Giường", "", "kh_dm_05_dk");
            upd_kh_dm_dk("C08", "Nhà hộ sinh\\Cơ sở", "", "kh_dm_05_dk");
            upd_kh_dm_dk("C09", "Nhà hộ sinh\\Giường", "", "kh_dm_05_dk");
            upd_kh_dm_dk("C10", "Khu điều trị phong\\Cơ sở", "", "kh_dm_05_dk");
            upd_kh_dm_dk("C11", "Khu điều trị phong\\Giường", "", "kh_dm_05_dk");
            upd_kh_dm_dk("C12", "Trạm y tế\\Cơ sở", "", "kh_dm_05_dk");
            upd_kh_dm_dk("C13", "Trạm y tế\\Giường", "", "kh_dm_05_dk");
            upd_kh_dm_dk("C14", "Cơ sở khác\\Cơ sở", "", "kh_dm_05_dk");
            upd_kh_dm_dk("C15", "Cơ sở khác\\Giường", "", "kh_dm_05_dk");
            //Biểu 04b
            upd_kh_dm_dk("C01", "Trạm y tế có\\Tổ YHCT", "", "kh_dm_04_dk");
            upd_kh_dm_dk("C02", "Trạm y tế có\\Bác sỹ", "", "kh_dm_04_dk");
            upd_kh_dm_dk("C03", "Trạm y tế có\\NHS/ YSSN", "", "kh_dm_04_dk");
            upd_kh_dm_dk("C04", "Số xã không có trạm", "", "kh_dm_04_dk");
            upd_kh_dm_dk("C05", "Số TYT đạt chuẩn QG", "", "kh_dm_04_dk");
            upd_kh_dm_dk("C06", "Số thôn bản có NVYT", "", "kh_dm_04_dk");
            //Biểu 05
            upd_kh_dm_dk("C01", "Tổng số\\Tổng số", "", "kh_dm_06_dk");
            upd_kh_dm_dk("C02", "Tổng số\\Trong đó: Nữ", "", "kh_dm_06_dk");
            upd_kh_dm_dk("C03", "Tỉnh/Thành phố\\QLNN\\Tổng số", "", "kh_dm_06_dk");
            upd_kh_dm_dk("C04", "Tỉnh/Thành phố\\QLNN\\Trong đó: Nữ", "", "kh_dm_06_dk");
            upd_kh_dm_dk("C05", "Tỉnh/Thành phố\\Phòng bệnh\\Tổng số", "", "kh_dm_06_dk");
            upd_kh_dm_dk("C06", "Tỉnh/Thành phố\\Phòng bệnh\\Trong đó: Nữ", "", "kh_dm_06_dk");
            upd_kh_dm_dk("C07", "Tỉnh/Thành phố\\Chữa bệnh\\Tổng số", "", "kh_dm_06_dk");
            upd_kh_dm_dk("C08", "Tỉnh/Thành phố\\Chữa bệnh\\Trong đó: Nữ", "", "kh_dm_06_dk");
            upd_kh_dm_dk("C09", "Tỉnh/Thành phố\\Chi cục dân số\\Tổng số", "", "kh_dm_06_dk");
            upd_kh_dm_dk("C10", "Tỉnh/Thành phố\\Chi cục dân số\\Trong đó: Nữ", "", "kh_dm_06_dk");
            upd_kh_dm_dk("C11", "Tỉnh/Thành phố\\Đào tạo(THYT...)\\Tổng số", "", "kh_dm_06_dk");
            upd_kh_dm_dk("C12", "Tỉnh/Thành phố\\Đào tạo(THYT...)\\Trong đó: Nữ", "", "kh_dm_06_dk");
            upd_kh_dm_dk("C13", "Tỉnh/Thành phố\\Công ty Dược\\Tổng số", "", "kh_dm_06_dk");
            upd_kh_dm_dk("C14", "Tỉnh/Thành phố\\Công ty Dược\\Trong đó: Nữ", "", "kh_dm_06_dk");
            upd_kh_dm_dk("C15", "Quận/Huyện\\QLNN\\Tổng số", "", "kh_dm_06_dk");
            upd_kh_dm_dk("C16", "Quận/Huyện\\QLNN\\Trong đó: Nữ", "", "kh_dm_06_dk");
            upd_kh_dm_dk("C17", "Quận/Huyện\\Phòng bệnh\\Tổng số", "", "kh_dm_06_dk");
            upd_kh_dm_dk("C18", "Quận/Huyện\\Phòng bệnh\\Trong đó: Nữ", "", "kh_dm_06_dk");
            upd_kh_dm_dk("C19", "Quận/Huyện\\Chữa bệnh\\Tổng số", "", "kh_dm_06_dk");
            upd_kh_dm_dk("C20", "Quận/Huyện\\Chữa bệnh\\Trong đó: Nữ", "", "kh_dm_06_dk");
            upd_kh_dm_dk("C21", "Trung tâm dân số\\Tổng số", "", "kh_dm_06_dk");
            upd_kh_dm_dk("C22", "Trung tâm dân số\\Trong đó: Nữ", "", "kh_dm_06_dk");
            upd_kh_dm_dk("C23", "Tuyến xã\\Trạm y tế\\Tổng số", "", "kh_dm_06_dk");
            upd_kh_dm_dk("C24", "Tuyến xã\\Trạm y tế\\Trong đó: Nữ", "", "kh_dm_06_dk");
            upd_kh_dm_dk("C25", "Tuyến xã\\Thôn bản\\Tổng số", "", "kh_dm_06_dk");
            upd_kh_dm_dk("C26", "Tuyến xã\\Thôn bản\\Trong đó: Nữ", "", "kh_dm_06_dk");
            upd_kh_dm_dk("C27", "Y tế ngành\\QLNN\\Tổng số", "", "kh_dm_06_dk");
            upd_kh_dm_dk("C28", "Y tế ngành\\QLNN\\Trong đó: Nữ", "", "kh_dm_06_dk");
            upd_kh_dm_dk("C29", "Y tế ngành\\Phòng bệnh\\Tổng số", "", "kh_dm_06_dk");
            upd_kh_dm_dk("C30", "Y tế ngành\\Phòng bệnh\\Trong đó: Nữ", "", "kh_dm_06_dk");
            upd_kh_dm_dk("C31", "Y tế ngành\\Chữa bệnh\\Tổng số", "", "kh_dm_06_dk");
            upd_kh_dm_dk("C32", "Y tế ngành\\Chữa bệnh\\Trong đó: Nữ", "", "kh_dm_06_dk");
            upd_kh_dm_dk("C33", "Tư nhân\\Bệnh viện\\Tổng số", "", "kh_dm_06_dk");
            upd_kh_dm_dk("C34", "Tư nhân\\Bệnh viện\\Trong đó: Nữ", "", "kh_dm_06_dk");
            upd_kh_dm_dk("C35", "Tư nhân\\Phòng khám\\Tổng số", "", "kh_dm_06_dk");
            upd_kh_dm_dk("C36", "Tư nhân\\Phòng khám\\Trong đó: Nữ", "", "kh_dm_06_dk");
            upd_kh_dm_dk("C37", "Tư nhân\\Cơ sở khác\\Tổng số", "", "kh_dm_06_dk");
            upd_kh_dm_dk("C38", "Tư nhân\\Cơ sở khác\\Trong đó: Nữ", "", "kh_dm_06_dk");

            execute_data("delete from kh_dm_06");
            upd_kh_dm(0, " ", "Tổng số", "kh_dm_06");
            upd_kh_dm(1, "1", "Tiến sỹ Y", "kh_dm_06");
            upd_kh_dm(2, "2", "Thạc sỹ Y", "kh_dm_06");
            upd_kh_dm(3, "3", "Chuyên khoa II", "kh_dm_06");
            upd_kh_dm(4, "4", "Chuyên khoa I", "kh_dm_06");
            upd_kh_dm(5, "5", "Bác sỹ", "kh_dm_06");
            upd_kh_dm(6, "6", "Tiến sỹ Dược", "kh_dm_06");
            upd_kh_dm(7, "7", "Thạc sỹ Dược", "kh_dm_06");
            upd_kh_dm(8, "8", "Chuyên khoa II Dược", "kh_dm_06");
            upd_kh_dm(9, "9", "Chuyên khoa I Dược", "kh_dm_06");
            upd_kh_dm(10, "10", "Dược sỹ đại học", "kh_dm_06");
            upd_kh_dm(11, "11", "Thạc sỹ y tế Công cộng", "kh_dm_06");
            upd_kh_dm(12, "12", "Đại học y tế Công cộng", "kh_dm_06");
            upd_kh_dm(13, "13", "Cao đẳng y tế Công cộng", "kh_dm_06");
            upd_kh_dm(14, "14", "Y sỹ", "kh_dm_06");
            upd_kh_dm(15, " ", "Trong đó: Y sỹ sản nhi", "kh_dm_06");
            upd_kh_dm(16, "15", "KTV y đại học", "kh_dm_06");
            upd_kh_dm(17, "16", "KTV y cao đẳng", "kh_dm_06");
            upd_kh_dm(18, "17", "KTV y trung học", "kh_dm_06");
            upd_kh_dm(19, "18", "KTV y sơ học", "kh_dm_06");
            upd_kh_dm(20, "19", "Dược sỹ/KTV TH dược", "kh_dm_06");
            upd_kh_dm(21, "20", "Dược tá", "kh_dm_06");
            upd_kh_dm(22, "21", "ĐD(y tá) Đại học", "kh_dm_06");
            upd_kh_dm(23, "22", "ĐD(y tá) Cao đẳng", "kh_dm_06");
            upd_kh_dm(24, "23", "ĐD(y tá) Trung học", "kh_dm_06");
            upd_kh_dm(25, "24", "ĐD(y tá) Sơ học", "kh_dm_06");
            upd_kh_dm(26, "25", "Hộ sinh Đại học", "kh_dm_06");
            upd_kh_dm(27, "26", "Hộ sinh Cao đẳng", "kh_dm_06");
            upd_kh_dm(28, "27", "Hộ sinh Trung học", "kh_dm_06");
            upd_kh_dm(29, "28", "Hộ sinh Sơ học", "kh_dm_06");
            upd_kh_dm(30, "29", "Lương y/ Lương dược", "kh_dm_06");
            upd_kh_dm(31, "30", "Đại học ngành khác", "kh_dm_06");
            upd_kh_dm(32, "31", "Cán bộ khác", "kh_dm_06");
            //Biểu 06
            execute_data("delete from kh_dm_08");
            upd_kh_dm_dv(0, "I", "Tham gia BHYT", "kh_dm_08", "Triệu đồng");
            upd_kh_dm_dv(1, "1", "Tổng số người tham gia BHYT", "kh_dm_08", "Triệu người");
            upd_kh_dm_dv(2, " ", "Trong đó:", "kh_dm_08", " ");
            upd_kh_dm_dv(3, " ", "		Người nghèo", "kh_dm_08", "Triệu người");
            upd_kh_dm_dv(4, " ", "		Tự nguyện", "kh_dm_08", "Triệu người");
            upd_kh_dm_dv(5, " ", "		Trẻ em < 6 tuổi", "kh_dm_08", "Triệu người");
            upd_kh_dm_dv(6, "2", "Tỷ lệ tham gia BHYT", "kh_dm_08", "%");
            upd_kh_dm_dv(7, "II", "Thu BHYT", "kh_dm_08", "Triệu đồng");
            upd_kh_dm_dv(8, " ", "Tổng số thu BHYT", "kh_dm_08", "Tỷ đồng");
            upd_kh_dm_dv(9, " ", "Trong đó:", "kh_dm_08", " ");
            upd_kh_dm_dv(10, " ", "		Người nghèo", "kh_dm_08", "Tỷ đồng");
            upd_kh_dm_dv(11, " ", "		Tự nguyện", "kh_dm_08", "Tỷ đồng");
            upd_kh_dm_dv(12, " ", "		Trẻ em < 6 tuổi", "kh_dm_08", "Tỷ đồng");
            upd_kh_dm_dv(13, "III", "Khám chữa bệnh có BHYT", "kh_dm_08", "%");
            upd_kh_dm_dv(14, "1", "Khám và điều trị ngoại trú", "kh_dm_08", "Ngàn lượt");
            upd_kh_dm_dv(15, " ", "Trong đó:", "kh_dm_08", " ");
            upd_kh_dm_dv(16, " ", "		Người nghèo", "kh_dm_08", "Ngàn lượt");
            upd_kh_dm_dv(17, " ", "		Trẻ em < 6 tuổi", "kh_dm_08", "Ngàn lượt");
            upd_kh_dm_dv(18, "2", "Khám và điều trị nội trú", "kh_dm_08", "Ngàn lượt");
            upd_kh_dm_dv(19, " ", "Trong đó:", "kh_dm_08", " ");
            upd_kh_dm_dv(20, " ", "		Người nghèo", "kh_dm_08", "Ngàn lượt");
            upd_kh_dm_dv(21, " ", "		Trẻ em < 6 tuổi", "kh_dm_08", "Ngàn lượt");
            upd_kh_dm_dv(22, "IV", "Chi BHYT", "kh_dm_08", "Triệu đồng");
            upd_kh_dm_dv(23, "1", "Khám và điều trị ngoại trú", "kh_dm_08", "Triệu đồng");
            upd_kh_dm_dv(24, " ", "Trong đó:", "kh_dm_08", " ");
            upd_kh_dm_dv(25, " ", "		Người nghèo", "kh_dm_08", "Triệu đồng");
            upd_kh_dm_dv(26, " ", "		Trẻ em < 6 tuổi", "kh_dm_08", "Triệu đồng");
            upd_kh_dm_dv(27, "2", "Khám và điều trị nội trú", "kh_dm_08", "Triệu đồng");
            upd_kh_dm_dv(28, " ", "Trong đó:", "kh_dm_08", " ");
            upd_kh_dm_dv(29, " ", "		Người nghèo", "kh_dm_08", "Triệu đồng");
            upd_kh_dm_dv(30, " ", "		Trẻ em < 6 tuổi", "kh_dm_08", "Triệu đồng");
            upd_kh_dm_dv(31, "V", "Chi phí trung bình 1 lượt khám & điều trị ngoại trú", "kh_dm_08", "Ngàn đồng");
            upd_kh_dm_dv(32, "VI", "Chi phí trung bình 1 lượt khám & điều trị nội trú", "kh_dm_08", "Ngàn đồng");

            upd_kh_dm_dk("C01", "Tổng số", "", "kh_dm_08_dk");
            upd_kh_dm_dk("C02", "Ghi chú", "", "kh_dm_08_dk");
            //Biểu 07
            upd_kh_dm_dk("C01", "Năm trước", "", "kh_dm_07_dk");
            upd_kh_dm_dk("C02", "Năm nay", "", "kh_dm_07_dk");
            upd_kh_dm_dk("C03", "Tốc độ tăng", "", "kh_dm_07_dk");
            upd_kh_dm_dk("C10", "Ghi chú", "", "kh_dm_07_dk");

            execute_data("delete from kh_dm_07");
            upd_kh_dm_dv(0, "1", "Doanh thu sản xuất", "kh_dm_07", "Triệu đồng");
            upd_kh_dm_dv(1, "2", "Xuất khẩu", "kh_dm_07", "1000 USD");
            upd_kh_dm_dv(2, "3", "Nhập khẩu", "kh_dm_07", "1000 USD");
            upd_kh_dm_dv(3, " ", " - Thành phẩm", "kh_dm_07", "1000 USD");
            upd_kh_dm_dv(4, " ", "     Tỷ trọng TP/ Nhập khẩu", "kh_dm_07", "%");
            upd_kh_dm_dv(5, " ", " - Nguyên liệu", "kh_dm_07", "1000 USD");
            upd_kh_dm_dv(6, " ", "     Tỷ trọng NL/ Nhập khẩu", "kh_dm_07", "%");
            //Biểu 08
            execute_data("delete from kh_dm_123");
            upd_kh_dm(0, " ", "Tổng số", "kh_dm_123");
            upd_kh_dm(1, "1", "Y sỹ đa khoa", "kh_dm_123");
            upd_kh_dm(2, "2", "Y sỹ y học cổ truyền", "kh_dm_123");
            upd_kh_dm(3, "3", "Điều dưỡng đại học", "kh_dm_123");
            upd_kh_dm(4, "4", "Điều dưỡng cao đẳng", "kh_dm_123");
            upd_kh_dm(5, "5", "Điều dưỡng trung học", "kh_dm_123");
            upd_kh_dm(6, "6", "Điều dưỡng sơ học", "kh_dm_123");
            upd_kh_dm(7, "7", "Hộ sinh đại học", "kh_dm_123");
            upd_kh_dm(8, "8", "Hộ sinh cao đẳng", "kh_dm_123");
            upd_kh_dm(9, "9", "Hộ sinh trung học", "kh_dm_123");
            upd_kh_dm(10, "10", "Hộ sinh sơ học", "kh_dm_123");
            upd_kh_dm(11, "11", "Kỹ thuật viên y cao đẳng", "kh_dm_123");
            upd_kh_dm(12, "12", "Kỹ thuật viên y trung học", "kh_dm_123");
            upd_kh_dm(13, "13", "Kỹ thuật viên y sơ học", "kh_dm_123");
            upd_kh_dm(14, "14", "Dược sỹ trung học", "kh_dm_123");
            upd_kh_dm(15, "15", "Dược tá", "kh_dm_123");
            upd_kh_dm(16, "16", "Công nhân kỹ thuật thiết bị y tế", "kh_dm_123");
            upd_kh_dm(17, "17", "Nhân viên y tế thôn bản", "kh_dm_123");
            upd_kh_dm(18, "18", "Khác", "kh_dm_123");

            upd_kh_dm_dk("C01", "Số tuyển sinh trong năm\\Tổng số", "", "kh_dm_123_dk");
            upd_kh_dm_dk("C02", "Số tuyển sinh trong năm\\Trong đó: Hệ chính quy", "", "kh_dm_123_dk");
            upd_kh_dm_dk("C03", "Số tuyển sinh trong năm\\Trong đó: Nữ", "", "kh_dm_123_dk");
            upd_kh_dm_dk("C04", "Số tuyển sinh trong năm\\Trong đó: Dân tộc ít người", "", "kh_dm_123_dk");
            upd_kh_dm_dk("C05", "Số tốt nghiệp trong năm\\Tổng số", "", "kh_dm_123_dk");
            upd_kh_dm_dk("C06", "Số tốt nghiệp trong năm\\Trong đó: Hệ chính quy", "", "kh_dm_123_dk");
            upd_kh_dm_dk("C07", "Số tốt nghiệp trong năm\\Trong đó: Nữ", "", "kh_dm_123_dk");
            upd_kh_dm_dk("C08", "Số tốt nghiệp trong năm\\Trong đó: Dân tộc ít người", "", "kh_dm_123_dk");
            upd_kh_dm_dk("C09", "Số hiện có cuối năm\\Tổng số", "", "kh_dm_123_dk");
            upd_kh_dm_dk("C10", "Số hiện có cuối năm\\Trong đó: Hệ chính quy", "", "kh_dm_123_dk");
            upd_kh_dm_dk("C11", "Số hiện có cuối năm\\Trong đó: Nữ", "", "kh_dm_123_dk");
            upd_kh_dm_dk("C12", "Số hiện có cuối năm\\Trong đó: Dân tộc ít người", "", "kh_dm_123_dk");
            upd_kh_dm_dk("C20", "Ghi chú", "", "kh_dm_123_dk");
            //Biểu 09
            upd_kh_dm_dk("C01", "Phụ nữ có thai\\Tổng số", "", "kh_dm_10_dk");
            upd_kh_dm_dk("C02", "Phụ nữ có thai\\Trong đó: Vị thành niên", "", "kh_dm_10_dk");
            upd_kh_dm_dk("C03", "Tổng số lần khám thai", "", "kh_dm_10_dk");
            upd_kh_dm_dk("C04", "Số đẻ được quản lý thai", "", "kh_dm_10_dk");
            upd_kh_dm_dk("C05", "Số phụ nữ đẻ được tiêm đủ UV", "", "kh_dm_10_dk");
            upd_kh_dm_dk("C06", "Phụ nữ đẻ\\Tổng số PN đẻ", "", "kh_dm_10_dk");
            upd_kh_dm_dk("C07", "Phụ nữ đẻ\\Trong đó\\Khám>=3 lần trong 3 kỳ", "", "kh_dm_10_dk");
            upd_kh_dm_dk("C08", "Phụ nữ đẻ\\Trong đó\\FX/GH", "", "kh_dm_10_dk");
            upd_kh_dm_dk("C09", "Phụ nữ đẻ\\Trong đó\\Mổ lấy thai", "", "kh_dm_10_dk");
            upd_kh_dm_dk("C10", "Phụ nữ đẻ\\Trong đó\\Đẻ con thứ 3 trở lên", "", "kh_dm_10_dk");
            upd_kh_dm_dk("C11", "Phụ nữ đẻ\\Trong đó\\Đẻ do CBYT đỡ", "", "kh_dm_10_dk");
            upd_kh_dm_dk("C12", "Phụ nữ đẻ\\Trong đó\\Đẻ tại cơ sở y tế", "", "kh_dm_10_dk");
            upd_kh_dm_dk("C13", "Số bà mẹ/trẻ SS được chăm sóc sau sinh\\Tổng số", "", "kh_dm_10_dk");
            upd_kh_dm_dk("C14", "Số bà mẹ/trẻ SS được chăm sóc sau sinh\\Trong đó: ", "", "kh_dm_10_dk");
            //Biểu 10 
            upd_kh_dm_dk("C01", "Băng huyết\\Mắc", "", "kh_dm_124_dk");
            upd_kh_dm_dk("C02", "Băng huyết\\Chết", "", "kh_dm_124_dk");
            upd_kh_dm_dk("C03", "Sản giật\\Mắc", "", "kh_dm_124_dk");
            upd_kh_dm_dk("C04", "Sản giật\\Chết", "", "kh_dm_124_dk");
            upd_kh_dm_dk("C05", "Uốn ván SS\\Mắc", "", "kh_dm_124_dk");
            upd_kh_dm_dk("C06", "Uốn ván SS\\Chết", "", "kh_dm_124_dk");
            upd_kh_dm_dk("C07", "Vỡ tử cung\\Mắc", "", "kh_dm_124_dk");
            upd_kh_dm_dk("C08", "Vỡ tử cung\\Chết", "", "kh_dm_124_dk");
            upd_kh_dm_dk("C09", "Nhiễm trùng\\Mắc", "", "kh_dm_124_dk");
            upd_kh_dm_dk("C10", "Nhiễm trùng\\Chết", "", "kh_dm_124_dk");
            //Biểu 11 
            upd_kh_dm_dk("C01", "Tổng số lần khám phụ khoa", "", "kh_dm_132_dk");
            upd_kh_dm_dk("C02", "Tổng số lượt chữa phụ khoa", "", "kh_dm_132_dk");
            upd_kh_dm_dk("C03", "Phá thai\\Số phá thai theo tuần\\<=7 tuần", "", "kh_dm_132_dk");
            upd_kh_dm_dk("C04", "Phá thai\\Số phá thai theo tuần\\trên 7 đến <= 12 tuần", "", "kh_dm_132_dk");
            upd_kh_dm_dk("C05", "Phá thai\\Số phá thai theo tuần\\>12 tuần", "", "kh_dm_132_dk");
            upd_kh_dm_dk("C06", "Phá thai\\Trong đó: vị thành niên", "", "kh_dm_132_dk");
            upd_kh_dm_dk("C07", "Tai biến do nạo phá thai\\Số mắc", "", "kh_dm_132_dk");
            upd_kh_dm_dk("C08", "Tai biến do nạo phá thai\\Số chết", "", "kh_dm_132_dk");
            //Biểu 12
            upd_kh_dm_dk("C01", "Tổng số người mới thực hiện BPTT", "", "kh_dm_11_dk");
            upd_kh_dm_dk("C02", "Trong đó\\Số mới đặt dụng cụ tử cung", "", "kh_dm_11_dk");
            upd_kh_dm_dk("C03", "Trong đó\\Thuốc tránh thai\\Thuốc viên", "", "kh_dm_11_dk");
            upd_kh_dm_dk("C04", "Trong đó\\Thuốc tránh thai\\Thuốc tiêm", "", "kh_dm_11_dk");
            upd_kh_dm_dk("C05", "Trong đó\\Thuốc tránh thai\\Thuốc cấy", "", "kh_dm_11_dk");
            upd_kh_dm_dk("C06", "Trong đó\\Bao cao su", "", "kh_dm_11_dk");
            upd_kh_dm_dk("C07", "Trong đó\\Triệt sản mới\\Tổng số", "", "kh_dm_11_dk");
            upd_kh_dm_dk("C08", "Trong đó\\Triệt sản mới\\\\Nữ", "", "kh_dm_11_dk");
            upd_kh_dm_dk("C09", "Tai biến do thực hiện KHHGĐ\\Số mắc", "", "kh_dm_11_dk");
            upd_kh_dm_dk("C10", "Tai biến do thực hiện KHHGĐ\\Số chết", "", "kh_dm_11_dk");
            //Biểu 13 
            upd_kh_dm_dk("C01", "Số trẻ đẻ ra sống\\Tổng số", "", "kh_dm_09_dk");
            upd_kh_dm_dk("C02", "Số trẻ đẻ ra sống\\Trong đó: Nữ", "", "kh_dm_09_dk");
            upd_kh_dm_dk("C03", "Số trẻ được cân\\Tổng số", "", "kh_dm_09_dk");
            upd_kh_dm_dk("C04", "Số trẻ được cân\\Trong đó: <2500g", "", "kh_dm_09_dk");
            upd_kh_dm_dk("C05", "Chết thai nhi và chết trẻ em < 7 ngày\\Thai nhi chết từ 22 tuần đến khi đẻ", "", "kh_dm_09_dk");
            upd_kh_dm_dk("C06", "Chết thai nhi và chết trẻ em < 7 ngày\\Số chết của trẻ em < 7 ngày tuổi", "", "kh_dm_09_dk");
            upd_kh_dm_dk("C07", "Chết thai nhi và chết trẻ em < 7 ngày\\Số chết sơ sinh (<=28 ngày)", "", "kh_dm_09_dk");
            upd_kh_dm_dk("C08", "Tỷ lệ SDD trẻ em < 5 tuổi (cân nặng/tuổi)", "", "kh_dm_09_dk");
            //Biểu 14 
            upd_kh_dm_dk("C01", "Số trẻ<1 tuổi", "", "kh_dm_133_dk");
            upd_kh_dm_dk("C02", "Số trẻ TCĐĐ 7 loại vắc xin", "", "kh_dm_133_dk");
            upd_kh_dm_dk("C03", "Trong đó: BCG", "", "kh_dm_133_dk");
            upd_kh_dm_dk("C04", "Trong đó: DPT", "", "kh_dm_133_dk");
            upd_kh_dm_dk("C05", "Trong đó: OPV", "", "kh_dm_133_dk");
            upd_kh_dm_dk("C06", "Trong đó: Viêm gan B", "", "kh_dm_133_dk");
            upd_kh_dm_dk("C07", "Trong đó: Sởi", "", "kh_dm_133_dk");
            upd_kh_dm_dk("C08", "Viêm não Nhật bản", "", "kh_dm_133_dk");
            upd_kh_dm_dk("C09", "Tả", "", "kh_dm_133_dk");
            upd_kh_dm_dk("C10", "Thương hàn", "", "kh_dm_133_dk");
            upd_kh_dm_dk("C11", "Số phụ nữ có thai được tiêm UV2+", "", "kh_dm_133_dk");
            //Biểu 16.1 kh_dm_121_dk
            upd_kh_dm_dk("C01", "Lần khám bệnh\\Tổng số", "", "kh_dm_121_dk");
            upd_kh_dm_dk("C02", "Lần khám bệnh\\Trong đó: YHCT", "", "kh_dm_121_dk");
            upd_kh_dm_dk("C03", "Lần khám bệnh\\Trong đó: TE<6 tuổi", "", "kh_dm_121_dk");
            upd_kh_dm_dk("C04", "Khám dự phòng", "", "kh_dm_121_dk");
            upd_kh_dm_dk("C05", "Số lượt điều trị nội trú\\Tổng số", "", "kh_dm_121_dk");
            upd_kh_dm_dk("C06", "Số lượt điều trị nội trú\\Trong đó: YHCT", "", "kh_dm_121_dk");
            upd_kh_dm_dk("C07", "Số lượt điều trị nội trú\\Trong đó: TE<6 tuổi", "", "kh_dm_121_dk");
            upd_kh_dm_dk("C08", "Tổng số ngày điều trị nội trú", "", "kh_dm_121_dk");
            //Biểu 15 
            upd_kh_dm_dk("C01", "Sởi\\M", "", "kh_dm_144_dk");
            upd_kh_dm_dk("C02", "Sởi\\C", "", "kh_dm_144_dk");
            upd_kh_dm_dk("C03", "Ho gà\\M", "", "kh_dm_144_dk");
            upd_kh_dm_dk("C04", "Ho gà\\C", "", "kh_dm_144_dk");
            upd_kh_dm_dk("C05", "LMC\\M", "", "kh_dm_144_dk");
            upd_kh_dm_dk("C06", "LMC\\C", "", "kh_dm_144_dk");
            upd_kh_dm_dk("C07", "Bạch hầu\\M", "", "kh_dm_144_dk");
            upd_kh_dm_dk("C08", "Bạch hầu\\C", "", "kh_dm_144_dk");
            upd_kh_dm_dk("C09", "UVSS\\M", "", "kh_dm_144_dk");
            upd_kh_dm_dk("C10", "UVSS\\C", "", "kh_dm_144_dk");
            upd_kh_dm_dk("C11", "UVkhác\\M", "", "kh_dm_144_dk");
            upd_kh_dm_dk("C12", "UVkhác\\C", "", "kh_dm_144_dk");
            upd_kh_dm_dk("C13", "Lao màng não\\M", "", "kh_dm_144_dk");
            upd_kh_dm_dk("C14", "Lao màng não\\C", "", "kh_dm_144_dk");
            upd_kh_dm_dk("C15", "Lao khác\\M", "", "kh_dm_144_dk");
            upd_kh_dm_dk("C16", "Lao khác\\C", "", "kh_dm_144_dk");
            upd_kh_dm_dk("C17", "Viêm gan vi rút\\M", "", "kh_dm_144_dk");
            upd_kh_dm_dk("C18", "Viêm gan vi rút\\C", "", "kh_dm_144_dk");
            upd_kh_dm_dk("C19", "Viêm não vi rút\\M", "", "kh_dm_144_dk");
            upd_kh_dm_dk("C20", "Viêm não vi rút\\C", "", "kh_dm_144_dk");
            upd_kh_dm_dk("C21", "Tả\\M", "", "kh_dm_144_dk");
            upd_kh_dm_dk("C22", "Tả\\C", "", "kh_dm_144_dk");
            upd_kh_dm_dk("C23", "Thương hàn\\M", "", "kh_dm_144_dk");
            upd_kh_dm_dk("C24", "Thương hàn\\C", "", "kh_dm_144_dk");
            //Biểu 16.2 
            upd_kh_dm_dk("C01", "Số lượt điều trị ngoại trú\\Tổng số", "", "kh_dm_122_dk");
            upd_kh_dm_dk("C02", "Số lượt điều trị ngoại trú\\Trong đó: YHCT", "", "kh_dm_122_dk");
            upd_kh_dm_dk("C03", "Số lượt điều trị ngoại trú\\Trong đó: TE<6 tuổi", "", "kh_dm_122_dk");
            upd_kh_dm_dk("C04", "Số chết tại cơ sở y tế\\Tổng số", "", "kh_dm_122_dk");
            upd_kh_dm_dk("C05", "Số chết tại cơ sở y tế\\Trong đó: Chết<1 tuổi", "", "kh_dm_122_dk");
            upd_kh_dm_dk("C06", "Số chết tại cơ sở y tế\\Trong đó: Chết<5 tuổi", "", "kh_dm_122_dk");
            upd_kh_dm_dk("C07", "Số lần xét nghiệm", "", "kh_dm_122_dk");
            upd_kh_dm_dk("C08", "Số lần chụp X quang", "", "kh_dm_122_dk");
            upd_kh_dm_dk("C09", "Số lần chụp cắt lớp", "", "kh_dm_122_dk");
            upd_kh_dm_dk("C10", "Số lần siêu âm", "", "kh_dm_122_dk");
            upd_kh_dm_dk("C11", "Tổng số phẫu thuật", "", "kh_dm_122_dk");
            //Biểu 17 
            upd_kh_dm_dk("C01", "Số lượng", "", "kh_dm_131_dk");
            upd_kh_dm_dk("C24", "Ghi chú", "", "kh_dm_131_dk");

            execute_data("delete from kh_dm_131");
            upd_kh_dm(0, "I", "Phòng Chống Lao", "kh_dm_131");
            upd_kh_dm(1, "1", "Tổng số BN được thu nhận", "kh_dm_131");
            upd_kh_dm(2, "2", "Số BN lao phổi AFB(+)", "kh_dm_131");
            upd_kh_dm(3, " ", "Trong đó: - Mới", "kh_dm_131");
            upd_kh_dm(4, " ", "		- Tái phát", "kh_dm_131");
            upd_kh_dm(5, " ", "		- Thất bại", "kh_dm_131");
            upd_kh_dm(6, " ", "		- Điều trị lại", "kh_dm_131");
            upd_kh_dm(7, "3", "Lao phổi AFB(-)", "kh_dm_131");
            upd_kh_dm(8, "4", "Bệnh nhân Lao ngoài phổi", "kh_dm_131");
            upd_kh_dm(9, "5", "Khác", "kh_dm_131");
            upd_kh_dm(10, "6", "Kết quả điều trị Lao phổi AFB(+) mới", "kh_dm_131");
            upd_kh_dm(11, " ", "Trong đó: - Điều trị thành công", "kh_dm_131");
            upd_kh_dm(12, " ", "			-Số chết", "kh_dm_131");
            upd_kh_dm(13, "II", "Phòng chống Sốt rét", "kh_dm_131");
            upd_kh_dm(14, "1", "Số bệnh nhân được xét nghiệm sốt rét", "kh_dm_131");
            upd_kh_dm(15, " ", "Trong đó: Số có KSTRT", "kh_dm_131");
            upd_kh_dm(16, "2", "Tổng số bệnh nhân SR", "kh_dm_131");
            upd_kh_dm(17, " ", " - Số BNSR được xét nghiệm", "kh_dm_131");
            upd_kh_dm(18, " ", " - Số BN sốt rét ngoại tỉnh", "kh_dm_131");
            upd_kh_dm(19, "3", "Số bệnh nhân sốt rét thường", "kh_dm_131");
            upd_kh_dm(20, " ", "Trong đó: Trẻ em < 5 tuổi", "kh_dm_131");
            upd_kh_dm(21, " ", "			Trẻ em 5 - 14 tuổi", "kh_dm_131");
            upd_kh_dm(22, " ", "			Phụ nữ có thai", "kh_dm_131");
            upd_kh_dm(23, "4", "Số BNSR có KST", "kh_dm_131");
            upd_kh_dm(24, " ", "Trong đó: Trẻ em < 5 tuổi", "kh_dm_131");
            upd_kh_dm(25, " ", "			Trẻ em 5 - 14 tuổi", "kh_dm_131");
            upd_kh_dm(26, " ", "			Phụ nữ có thai", "kh_dm_131");
            upd_kh_dm(27, "5", "Số bệnh nhân SRAT", "kh_dm_131");
            upd_kh_dm(28, " ", " - Trong đó: Trẻ em < 5 tuổi", "kh_dm_131");
            upd_kh_dm(29, " ", "			Trẻ em 5 - 14 tuổi", "kh_dm_131");
            upd_kh_dm(30, " ", "			Phụ nữ có thai", "kh_dm_131");
            upd_kh_dm(31, " ", " - Số BNSRAT có KST", "kh_dm_131");
            upd_kh_dm(32, "6", "Số BN chết sốt rét", "kh_dm_131");
            upd_kh_dm(33, " ", "Trong đó: Trẻ em < 5 tuổi", "kh_dm_131");
            upd_kh_dm(34, " ", "			Trẻ em 5 - 14 tuổi", "kh_dm_131");
            upd_kh_dm(35, " ", "			Phụ nữ có thai", "kh_dm_131");
            upd_kh_dm(36, "III", "Phòng chống HIV/AIDS", "kh_dm_131");
            upd_kh_dm(37, "1", "Số hiện mắc HIV", "kh_dm_131");
            upd_kh_dm(38, " ", "Trong đó: Nữ", "kh_dm_131");
            upd_kh_dm(39, " ", "			Số mới phát hiện HIV", "kh_dm_131");
            upd_kh_dm(40, "2", "Số hiện mắc AIDS", "kh_dm_131");
            upd_kh_dm(41, " ", "Trong đó: Nữ", "kh_dm_131");
            upd_kh_dm(42, " ", "			Số mới chuyển sang AIDS", "kh_dm_131");
            upd_kh_dm(43, "3", "Số chết do bị AIDS", "kh_dm_131");
            upd_kh_dm(44, "IV", "Sức khỏe Tâm thần", "kh_dm_131");
            upd_kh_dm(45, "1", "Số hiện mắc động kinh", "kh_dm_131");
            upd_kh_dm(46, " ", "Số bệnh nhân đã quản lý", "kh_dm_131");
            upd_kh_dm(47, " ", "Trong đó: Số mới", "kh_dm_131");
            upd_kh_dm(48, " ", "			Số đang điều trị < 5 tuổi", "kh_dm_131");
            upd_kh_dm(49, " ", "			Số tử vong", "kh_dm_131");
            upd_kh_dm(50, "V", "Phòng chống Hoa liễu", "kh_dm_131");
            upd_kh_dm(43, "1", "Số bệnh nhân lậu mới phát hiện trong kỳ", "kh_dm_131");
            upd_kh_dm(44, " ", "Trong đó: Lậu mắt trẻ sơ sinh", "kh_dm_131");
            upd_kh_dm(45, "2", "Số bệnh giang mai mới phát hiện", "kh_dm_131");
            upd_kh_dm(46, " ", "Trong đó: Giang mai bẩm sinh", "kh_dm_131");
            upd_kh_dm(47, "VI", "Phòng chống bệnh Phong", "kh_dm_131");
            upd_kh_dm(48, "1", "Số bệnh nhân hiện mắc bệnh phong", "kh_dm_131");
            upd_kh_dm(49, " ", "Trong đó: Số bệnh nhân mới phát hiện", "kh_dm_131");
            upd_kh_dm(50, " ", "Số bệnh nhân Phong mới bị tàn tật độ II", "kh_dm_131");
            //Biểu 18
            upd_kh_dm_dk("C01", "Tả\\M", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C02", "Tả\\C", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C03", "Thương hàn\\M", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C04", "Thương hàn\\C", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C05", "Ly trực trùng\\M", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C06", "Ly trực trùng\\C", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C07", "Lỵ A mip\\M", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C08", "Lỵ A mip\\C", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C09", "Hội chứng lỵ\\M", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C10", "Hội chứng lỵ\\C", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C11", "Tiêu chảy\\M", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C12", "Tiêu chảy\\C", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C13", "Viêm não vi rút\\M", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C14", "Viêm não vi rút\\C", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C15", "Sốt xuất huyết\\M", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C16", "Sốt xuất huyết\\C", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C17", "B. Chân - Tay - Miệng\\M", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C18", "B. Chân - Tay - Miệng\\C", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C19", "Viêm gan vi rút\\M", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C20", "Viêm gan vi rút\\C", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C21", "Dại và nghi dại\\M", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C22", "Dại và nghi dại\\C", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C23", "Viêm màng não mô cầu\\M", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C24", "Viêm màng não mô cầu\\C", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C25", "Thủy đậu\\M", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C26", "Thủy đậu\\C", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C27", "Uốn ván\\M", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C28", "Uốn ván\\C", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C29", "Quai bị\\M", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C30", "Quai bị\\C", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C31", "Viêm đường\\M", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C32", "Viêm đường\\C", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C33", "Viêm phế quản\\M", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C34", "Viêm phế quản\\C", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C35", "Viêm phổi\\M", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C36", "Viêm phổi\\C", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C37", "Cúm A(H5N1)\\M", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C38", "Cúm A(H5N1)\\C", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C39", "Cúm A(H1N1)\\M", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C40", "Cúm A(H1N1)\\C", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C41", "Dịch hạch\\M", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C42", "Dịch hạch\\C", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C43", "Lepto\\M", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C44", "Lepto\\C", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C45", "Tai nạn, ngộ độc, chấn thương các loại\\Tự tử\\M", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C46", "Tai nạn, ngộ độc, chấn thương các loại\\Tự tử\\C", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C47", "Tai nạn, ngộ độc, chấn thương các loại\\Ngộ độc TP\\M", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C48", "Tai nạn, ngộ độc, chấn thương các loại\\Ngộ độc TP\\C", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C49", "Tai nạn, ngộ độc, chấn thương các loại\\TNGT\\M", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C50", "Tai nạn, ngộ độc, chấn thương các loại\\TNGT\\C", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C51", "Tai nạn, ngộ độc, chấn thương các loại\\TNLĐ\\M", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C52", "Tai nạn, ngộ độc, chấn thương các loại\\TNLĐ\\C", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C53", "Tai nạn, ngộ độc, chấn thương các loại\\NĐ h/chất\\M", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C54", "Tai nạn, ngộ độc, chấn thương các loại\\NĐ h/chất\\C", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C55", "Tai nạn, ngộ độc, chấn thương các loại\\TN khác\\M", "", "kh_dm_141_dk");
            upd_kh_dm_dk("C56", "Tai nạn, ngộ độc, chấn thương các loại\\TN khác\\C", "", "kh_dm_141_dk");
            //Biểu 19
            upd_kh_dm_dk("C01", "Tại khoa khám bệnh\\Tổng số", "", "kh_dm_15_dk");
            upd_kh_dm_dk("C02", "Tại khoa khám bệnh\\Trong đó: Nữ", "", "kh_dm_15_dk");
            upd_kh_dm_dk("C03", "Tại khoa khám bệnh\\Trong đó: TE<15", "", "kh_dm_15_dk");
            upd_kh_dm_dk("C04", "Tại khoa khám bệnh\\Trong đó: Số tử vong", "", "kh_dm_15_dk");
            upd_kh_dm_dk("C05", "Điều trị nội trú\\Tổng số\\Mắc\\TS", "", "kh_dm_15_dk");
            upd_kh_dm_dk("C06", "Điều trị nội trú\\Tổng số\\Mắc\\Nữ", "", "kh_dm_15_dk");
            upd_kh_dm_dk("C07", "Điều trị nội trú\\Tổng số\\Số tử vong\\TS", "", "kh_dm_15_dk");
            upd_kh_dm_dk("C08", "Điều trị nội trú\\Tổng số\\Số tử vong\\Nữ", "", "kh_dm_15_dk");
            upd_kh_dm_dk("C09", "Điều trị nội trú\\Trong đó TE<15 tuổi\\Mắc\\TS", "", "kh_dm_15_dk");
            upd_kh_dm_dk("C10", "Điều trị nội trú\\Trong đó TE<15 tuổi\\Mắc\\<5 tuổi", "", "kh_dm_15_dk");
            upd_kh_dm_dk("C11", "Điều trị nội trú\\Trong đó TE<15 tuổi\\Số tử vong\\TS", "", "kh_dm_15_dk");
            upd_kh_dm_dk("C12", "Điều trị nội trú\\Trong đó TE<15 tuổi\\Số tử vong\\<5 tuổi", "", "kh_dm_15_dk");
            //

        }
        #endregion
        //linh 1005012
        public bool execute(string sql1)
        {
            sql1 = sql1.Replace("medibv.", user + ".");
            try
            {
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                con.Open();
                cmd = new NpgsqlCommand(sql1, con);
                cmd.CommandType = CommandType.Text;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
                con.Close(); con.Dispose();
                return true;
            }
            catch(Exception ex)
            {
                upd_error(ex.Message + " - " + sql1, sComputer, "?");
                return false;
            }
        }
        public bool execute(string sql1, bool bluuerr)
        {
            sql1 = sql1.Replace("medibv.", user + ".");
            try
            {
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                con.Open();
                cmd = new NpgsqlCommand(sql1, con);
                cmd.CommandType = CommandType.Text;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
                con.Close(); con.Dispose();
                return true;
            }
            catch (Exception ex)
            {
                if (bluuerr) upd_error(ex.Message + "-" + sql1, sComputer, "?");
                return false;
            }
        }
        public bool upd_vpkhoa(decimal v_id, string v_mabn, decimal v_mavaovien, decimal v_maql, decimal v_idkhoa, string v_ngay, string v_makp, int v_madoituong,
            int v_mavp, decimal v_soluong, decimal v_dongia, decimal v_vattu, int v_userid, int v_buoi, decimal v_idtheodoigiuong,int i_Dachenhlech)
        {
            string s_sql = "update " + user + mmyy(v_ngay) + ".v_vpkhoa set mabn=:v_mabn,mavaovien=:v_mavaovien,maql=:v_maql,idkhoa=:v_idkhoa," +
                "ngay=to_timestamp(:v_ngay,'dd/mm/yyyy hh24:mi'),makp=:v_makp,madoituong=:v_madoituong,mavp=:v_mavp,soluong=:v_soluong,dongia=:v_dongia," +
                "vattu=:v_vattu,userid=:v_userid,buoi=:v_buoi,idtheodoigiuong=:v_idtheodoigiuong,dachenhlech=" + i_Dachenhlech.ToString() + " where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(s_sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
                cmd.Parameters.Add("v_mavaovien", NpgsqlDbType.Numeric).Value = v_mavaovien;
                cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
                cmd.Parameters.Add("v_idkhoa", NpgsqlDbType.Numeric).Value = v_idkhoa;
                cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 16).Value = v_ngay;
                cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = v_makp;
                cmd.Parameters.Add("v_madoituong", NpgsqlDbType.Numeric).Value = v_madoituong;
                cmd.Parameters.Add("v_mavp", NpgsqlDbType.Numeric).Value = v_mavp;
                cmd.Parameters.Add("v_soluong", NpgsqlDbType.Numeric).Value = v_soluong;
                cmd.Parameters.Add("v_dongia", NpgsqlDbType.Numeric).Value = v_dongia;
                cmd.Parameters.Add("v_vattu", NpgsqlDbType.Numeric).Value = v_vattu;
                cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                cmd.Parameters.Add("v_buoi", NpgsqlDbType.Numeric).Value = v_buoi;
                cmd.Parameters.Add("v_idtheodoigiuong", NpgsqlDbType.Numeric).Value = v_idtheodoigiuong;
                cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                int i = cmd.ExecuteNonQuery();
                if (i == 0)
                {
                    s_sql = "insert into " + user + mmyy(v_ngay) + ".v_vpkhoa(id,mabn,mavaovien,maql,idkhoa,ngay,makp,madoituong,mavp,soluong,dongia," +
                        "vattu,done,userid,buoi,idtheodoigiuong,dachenhlech) values (:v_id,:v_mabn,:v_mavaovien,:v_maql,:v_idkhoa," +
                        "to_timestamp(:v_ngay,'dd/mm/yyyy hh24:mi'),:v_makp," +
                        ":v_madoituong,:v_mavp,:v_soluong,:v_dongia,:v_vattu,0,:v_userid,:v_buoi,:v_idtheodoigiuong," + i_Dachenhlech.ToString() + ")";
                    cmd = new NpgsqlCommand(s_sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
                    cmd.Parameters.Add("v_mavaovien", NpgsqlDbType.Numeric).Value = v_mavaovien;
                    cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
                    cmd.Parameters.Add("v_idkhoa", NpgsqlDbType.Numeric).Value = v_idkhoa;
                    cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 16).Value = v_ngay;
                    cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = v_makp;
                    cmd.Parameters.Add("v_madoituong", NpgsqlDbType.Numeric).Value = v_madoituong;
                    cmd.Parameters.Add("v_mavp", NpgsqlDbType.Numeric).Value = v_mavp;
                    cmd.Parameters.Add("v_soluong", NpgsqlDbType.Numeric).Value = v_soluong;
                    cmd.Parameters.Add("v_dongia", NpgsqlDbType.Numeric).Value = v_dongia;
                    cmd.Parameters.Add("v_vattu", NpgsqlDbType.Numeric).Value = v_vattu;
                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                    cmd.Parameters.Add("v_buoi", NpgsqlDbType.Numeric).Value = v_buoi;
                    cmd.Parameters.Add("v_idtheodoigiuong", NpgsqlDbType.Numeric).Value = v_idtheodoigiuong;
                    cmd.ExecuteNonQuery();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(v_ngay, ex.Message, sComputer, "v_vpkhoa");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
            return true;
        }

        /// <summary>
        /// So sánh 2 ngày kiểu chuỗi, nếu âm: ngay1 nhỏ ngay2, nếu =0: ngay1=ngay2, nếu >0: ngay1>ngay2
        /// phải kiểm tra chuỗi không rỗng, và đúng theo cấu trúc dd/mm/yyyy, trước khi sử dụng hàm
        /// </summary>
        /// <param name="s_Ngay1">Theo format: dd/MM/yyyy</param>
        /// <param name="s_Ngay2">Theo format: dd/MM/yyyy</param>
        /// <returns></returns>
        public int SoSanhNgay(string s_Ngay1, string s_Ngay2)
        {
            try
            {
                DateTime dt1 = StringToDate(s_Ngay1);
                DateTime dt2 = StringToDate(s_Ngay2);
                return DateTime.Compare(dt1, dt2);
            }
            catch { return -1; }
        }

        /// <summary>
        /// Theo cách quản lý của khách sạn. Lấy móc 12h trưa
        /// </summary>
        /// <param name="b_QuanLyGiuongTheoKS"></param>
        /// <param name="s_Mabn"></param>
        /// <param name="l_MaVaoVien"></param>
        /// <param name="l_Maql"></param>
        /// <param name="l_IdTheoDoiGiuong"></param>
        /// <param name="i_LoaiGiuong"></param>
        /// <param name="i_MaDoiTuong"></param>
        /// <param name="s_Ngay"></param>
        /// <param name="l_IdKhoa"></param>
        /// <param name="s_Makp"></param>
        /// <param name="i_UserID"></param>
        /// <param name="dtGiaVp"></param>
        /// <param name="i_IDGiuong"></param>
        /// <param name="s_GiuongTuNgay"></param>
        /// <param name="s_GiuongDenNgay"></param>
        /// <param name="s_BHYTTuNgay"></param>
        /// <param name="s_BHYTDenNgay"></param>
        /// <param name="i_DoiTuongDichVu"></param>
        /// <param name="s_NgayPTTT"></param>
        /// <param name="i_LoaiNgayGiuong"></param>
        /// <param name="d_GiaGiuongCho"></param>
        /// <param name="d_GiaGiuongDe"></param>
        /// <param name="d_GiaGiuongPTTT1"></param>
        /// <param name="d_GiaGiuongPTTT2"></param>
        /// <param name="d_GiaGiuongPTTT3"></param>
        /// <param name="d_GiaGiuongPTTTDB"></param>
        /// <param name="d_SoNgayGiuongCho"></param>
        /// <param name="b_RaVien"></param>
        /// <param name="b_KhoaDau"></param>
        /// <returns></returns>
        public bool upd_tiengiuong(bool b_QuanLyGiuongTheoKS, string s_Mabn, 
            decimal l_MaVaoVien, decimal l_Maql, decimal l_IdTheoDoiGiuong, int i_LoaiGiuong,
            int i_MaDoiTuong, string s_Ngay, decimal l_IdKhoa, string s_Makp, int i_UserID, DataTable dtGiaVp, int i_IDGiuong, string s_GiuongTuNgay,
            string s_GiuongDenNgay, string s_BHYTTuNgay, string s_BHYTDenNgay, int i_DoiTuongDichVu, string s_NgayPTTT,
            int i_LoaiNgayGiuong, decimal d_GiaGiuongCho, decimal d_GiaGiuongDe, decimal d_GiaGiuongPTTT1, decimal d_GiaGiuongPTTT2,
            decimal d_GiaGiuongPTTT3, decimal d_GiaGiuongPTTTDB,ref decimal d_SoNgayGiuongCho,bool b_RaVien, bool b_KhoaDau)
        {
            try
            {//linh 26052012
                if (s_Ngay == "" || s_GiuongTuNgay == "" || s_GiuongDenNgay == "") { return false; }
                if (s_BHYTTuNgay == "") { s_BHYTTuNgay = s_GiuongTuNgay; }
                if (i_MaDoiTuong == 1)
                {
                    if (s_BHYTDenNgay == "") { return false; }
                }
                else { s_BHYTDenNgay = s_GiuongDenNgay; }
                DateTime dti_GiuongTuNgay = StringToDateTime(s_GiuongTuNgay);
                DateTime dti_GiuongDenNgay = StringToDateTime(s_GiuongDenNgay);
                DateTime dti_BHYTTuNgay = StringToDate(s_BHYTTuNgay);
                DateTime dti_BHYTDenNgay = StringToDate(s_BHYTDenNgay);
                if (b_KhoaDau) { dti_GiuongTuNgay = new DateTime(dti_GiuongTuNgay.Year, dti_GiuongTuNgay.Month, dti_GiuongTuNgay.Day, 0, 0, 0); }
                string s_FieldGia = "gia_th";
                #region thu phí
                if (i_MaDoiTuong != 1 || DateTime.Compare(dti_GiuongDenNgay, dti_BHYTTuNgay) < 0 || DateTime.Compare(dti_GiuongTuNgay, dti_BHYTDenNgay) > 0)
                {
                    decimal dSoNgayGiuong = 0;
                    TimeSpan tsp = dti_GiuongDenNgay - dti_GiuongTuNgay;
                    dSoNgayGiuong = tsp.Days;
                    int i_SoGio = tsp.Hours;
                    if (dSoNgayGiuong == 0) { dSoNgayGiuong = 1; }
                    else
                    {
                        if (b_QuanLyGiuongTheoKS)
                        {
                            if (dti_GiuongDenNgay.Hour + Math.Min(dti_GiuongDenNgay.Minute, 1) > 12) { dSoNgayGiuong += 0.5M; }
                        }
                    }
                    DataRow rTienGiuong = getrowbyid(dtGiaVp, "id=" + i_IDGiuong.ToString());
                    if (rTienGiuong != null)
                    {
                        decimal d_IDVpKhoa = getidyymmddhhmiss_stt_computer;
                        if (i_LoaiGiuong == 1)
                        {
                            i_MaDoiTuong = i_DoiTuongDichVu;
                        }
                        decimal d_dongia = decimal.Parse(rTienGiuong[field_gia(i_MaDoiTuong.ToString())].ToString());
                        upd_vpkhoa(d_IDVpKhoa, s_Mabn, l_MaVaoVien, l_Maql, l_IdKhoa, s_Ngay, s_Makp, i_MaDoiTuong, i_IDGiuong,
                           dSoNgayGiuong, d_dongia, 0, i_UserID, 0, l_IdTheoDoiGiuong,1);
                    }
                }
                #endregion
                #region BHYT
                else
                {
                    decimal d_GiuongBHYT = 0;
                    decimal d_GiuongThuPhi = 0;
                    decimal d_GiaBHYT = 0;
                    decimal d_GiaChenhLech = 0;
                    decimal d_GiaKhongBHYT = 0;
                    int i_MaDoiTuongKhongBHYT = 2;
                    if (s_NgayPTTT == "") { s_NgayPTTT = DateTime.Now.AddMonths(12).ToString("dd/MM/yyyy hh:mm"); }
                    DateTime dti_NgayPTTT = StringToDateTime(s_NgayPTTT);
                    #region không có PTTT
                    if (DateTime.Compare(dti_GiuongDenNgay, dti_NgayPTTT) < 0)
                    {
                        #region Ngày vào < từ ngày && đến ngày < ngày ra
                        //Ngày giường:  |______________________________________|
                        //BHYT:              |____________________________|
                        if (DateTime.Compare(dti_GiuongTuNgay, dti_BHYTTuNgay) <= 0 && DateTime.Compare(dti_BHYTDenNgay, dti_GiuongDenNgay) <= 0)
                        {
                            TimeSpan tsp = dti_BHYTDenNgay - dti_BHYTTuNgay;
                            d_GiuongBHYT = tsp.Days;
                            if (d_GiuongBHYT == 0) { d_GiuongBHYT = 1; }
                            tsp = (dti_GiuongDenNgay - dti_BHYTDenNgay) + (dti_GiuongTuNgay - dti_BHYTTuNgay);
                            d_GiuongThuPhi += (decimal)tsp.Days;
                            if (dti_GiuongDenNgay.Hour + Math.Min(dti_GiuongDenNgay.Minute, 1) > 12 && b_RaVien) { d_GiuongThuPhi += 0.5M; }
                        }
                        #endregion
                        #region tu ngày < ngày vào && đến ngày < ngày ra && đến ngày > ngày vào
                        //Ngày giường:      |___________________________________|
                        //BHYT:        |_________________________________|
                        else if (DateTime.Compare(dti_GiuongTuNgay, dti_BHYTTuNgay) >= 0 && DateTime.Compare(dti_BHYTDenNgay, dti_GiuongDenNgay) <= 0 && DateTime.Compare(dti_BHYTDenNgay, dti_GiuongTuNgay) >= 0)
                        {
                            TimeSpan tsp = dti_BHYTDenNgay - dti_BHYTTuNgay;
                            d_GiuongBHYT = tsp.Days;
                            if (d_GiuongBHYT == 0) { d_GiuongBHYT = 1; }
                            tsp = dti_GiuongDenNgay - dti_BHYTDenNgay;
                            d_GiuongThuPhi += (decimal)tsp.Days;
                            if (dti_GiuongDenNgay.Hour + Math.Min(dti_GiuongDenNgay.Minute, 1) > 12 && b_RaVien) { d_GiuongThuPhi += 0.5M; }                       
                        }
                        #endregion
                        #region ngày vào < từ ngày && từ ngày < ngày ra && ngày ra < đến ngày
                        //Ngày giường:  |____________________________________|
                        //BHYT:              |_________________________________________|
                        else if (DateTime.Compare(dti_GiuongTuNgay, dti_BHYTTuNgay) <= 0 && DateTime.Compare(dti_BHYTTuNgay, dti_GiuongDenNgay) <= 0 && DateTime.Compare(dti_GiuongDenNgay, dti_BHYTDenNgay) <= 0)
                        {
                            TimeSpan tsp = dti_BHYTDenNgay - dti_BHYTTuNgay;
                            d_GiuongBHYT = tsp.Days;
                            if (d_GiuongBHYT == 0) { d_GiuongBHYT = 1; }
                            tsp = dti_BHYTTuNgay - dti_GiuongTuNgay;
                            d_GiuongThuPhi += (decimal)tsp.Days;
                            if (dti_GiuongDenNgay.Hour + Math.Min(dti_GiuongDenNgay.Minute, 1) > 12 && b_RaVien) { d_GiuongThuPhi += 0.5M; }
                        }
                        #endregion
                        //Ngày giường:  |_________________________|
                        //BHYT      |__________________________________|
                        else
                        {
                            TimeSpan tsp = dti_GiuongDenNgay - dti_GiuongTuNgay;
                            d_GiuongBHYT = tsp.Days;
                            if (d_GiuongBHYT == 0) { d_GiuongBHYT = 1; }
                            if (dti_GiuongDenNgay.Hour + Math.Min(dti_GiuongDenNgay.Minute, 1) > 12 && b_RaVien) { d_GiuongThuPhi += 0.5M; }
                        }
                        DataRow rTienGiuong = getrowbyid(dtGiaVp, "id=" + i_IDGiuong.ToString());
                        if (rTienGiuong != null)
                        {
                            decimal d_IDVpKhoa = getidyymmddhhmiss_stt_computer;
                            d_GiaBHYT = decimal.Parse(rTienGiuong[field_gia(i_MaDoiTuong.ToString())].ToString());
                            upd_vpkhoa(d_IDVpKhoa, s_Mabn, l_MaVaoVien, l_Maql, l_IdKhoa, s_Ngay, s_Makp, i_MaDoiTuong, i_IDGiuong,
                               d_GiuongBHYT, d_GiaBHYT, 0, i_UserID, 0, l_IdTheoDoiGiuong,1);
                            if (rTienGiuong["chenhlech"].ToString() == "1")
                            {
                                int i_MaDoiTuongCL = 2;
                                if (i_LoaiGiuong == 1) { i_MaDoiTuongCL = i_DoiTuongDichVu; }
                                s_FieldGia = field_gia(i_MaDoiTuongCL.ToString());
                                d_GiaChenhLech = decimal.Parse(rTienGiuong[s_FieldGia].ToString()) - decimal.Parse(rTienGiuong["gia_bh"].ToString());
                                if (d_GiaChenhLech > 0)
                                {
                                    upd_vpkhoa(-d_IDVpKhoa, s_Mabn, l_MaVaoVien, l_Maql, l_IdKhoa, s_Ngay, s_Makp, i_MaDoiTuongCL, i_IDGiuong,
                                        d_GiuongBHYT, d_GiaChenhLech, 0, i_UserID, 0, l_IdTheoDoiGiuong,1);
                                }
                            }
                            if (d_GiuongThuPhi > 0)
                            {
                                if (i_LoaiGiuong == 1) { i_MaDoiTuongKhongBHYT = i_DoiTuongDichVu; }
                                s_FieldGia = field_gia(i_MaDoiTuongKhongBHYT.ToString());
                                d_GiaKhongBHYT = decimal.Parse(rTienGiuong[s_FieldGia].ToString());
                                d_IDVpKhoa = getidyymmddhhmiss_stt_computer;
                                upd_vpkhoa(d_IDVpKhoa, s_Mabn, l_MaVaoVien, l_Maql, l_IdKhoa, s_Ngay, s_Makp, i_MaDoiTuongKhongBHYT, i_IDGiuong,
                                    d_GiuongThuPhi, d_GiaKhongBHYT, 0, i_UserID, 0, l_IdTheoDoiGiuong,1);
                            }
                        }
                    }
                    #endregion
                    #region Có PTTT
                    else
                    {
                        decimal d_GiuongChoBHYT = 0;
                        decimal d_GiuongChoTP = 0;
                        decimal d_GiuongSauMoDeBHYT = 0;
                        decimal d_GiuongSauMoDeTP = 0;
                        decimal d_GiuongGiuongTruBotBHYT = 0;//dành cho phần mỗ đẻ khoa trước
                        //dti_NgayPTTT = new DateTime(dti_NgayPTTT.Year, dti_NgayPTTT.Month, dti_NgayPTTT.Day, 0, 0, 0);
                        #region Ngày PTTT > Giường ngày vào && Ngày PTTT < Giường ngày ra
                        if (DateTime.Compare(dti_NgayPTTT, dti_GiuongTuNgay) >= 0)
                        {
                            #region BHYT Từ Ngày < Giường ngày vào && BHYT đến ngày > Giường ngày ra
                            //1.
                            //Ngày giường:  |____________+_____________|
                            //BHYT      |__________________________________|
                            if (DateTime.Compare(dti_BHYTTuNgay, dti_GiuongTuNgay) <= 0 && DateTime.Compare(dti_BHYTDenNgay, dti_GiuongDenNgay) >= 0)
                            {
                                TimeSpan tsp = dti_NgayPTTT - dti_GiuongTuNgay;
                                d_GiuongChoBHYT = tsp.Days;
                                tsp = dti_GiuongDenNgay - dti_NgayPTTT;
                                d_GiuongSauMoDeBHYT = Math.Max(1, tsp.Days);
                                if (b_QuanLyGiuongTheoKS && dti_GiuongDenNgay.Hour + Math.Min(dti_GiuongDenNgay.Minute, 1) > 12 && b_RaVien) { d_GiuongSauMoDeTP += 0.5M; }
                            }
                            #endregion
                            #region BHYT Từ Ngày < Giường ngày vào && BHYT đến ngày > Ngày PTTT
                            //2.
                            //Ngày giường:  |____________+_____________|
                            //BHYT      |______________________|
                            else if (DateTime.Compare(dti_BHYTTuNgay, dti_GiuongTuNgay) <= 0 && DateTime.Compare(dti_BHYTDenNgay, dti_NgayPTTT) >= 0)
                            {
                                TimeSpan tsp = dti_NgayPTTT - dti_GiuongTuNgay;
                                d_GiuongChoBHYT = tsp.Days;
                                tsp = dti_BHYTDenNgay - dti_NgayPTTT;
                                d_GiuongSauMoDeBHYT = Math.Min(1, tsp.Days);
                                tsp = dti_GiuongDenNgay - dti_BHYTDenNgay;
                                d_GiuongSauMoDeTP = tsp.Days;
                                if (b_QuanLyGiuongTheoKS && dti_GiuongDenNgay.Hour + Math.Min(dti_GiuongDenNgay.Minute, 1) > 12 && b_RaVien) { d_GiuongSauMoDeTP += 0.5M; }
                            }
                            #endregion
                            #region BHYT Từ Ngày < Giường ngày vào && BHYT đến ngày < Ngày PTTT
                            //3.
                            //Ngày giường:  |____________+_____________|
                            //BHYT      |__________|
                            else if (DateTime.Compare(dti_BHYTTuNgay, dti_GiuongTuNgay) <= 0 && DateTime.Compare(dti_BHYTDenNgay, dti_NgayPTTT) <= 0)
                            {
                                TimeSpan tsp = dti_BHYTDenNgay - dti_GiuongTuNgay;
                                d_GiuongChoBHYT = tsp.Days;
                                tsp = dti_NgayPTTT - dti_BHYTDenNgay;
                                d_GiuongChoTP = tsp.Days;
                                tsp = dti_GiuongDenNgay - dti_BHYTDenNgay;
                                d_GiuongSauMoDeTP = tsp.Days;
                                if (b_QuanLyGiuongTheoKS && dti_GiuongDenNgay.Hour + Math.Min(dti_GiuongDenNgay.Minute, 1) > 12 && b_RaVien) { d_GiuongSauMoDeTP += 0.5M; }
                            }
                            #endregion
                            #region BHYT Từ Ngày > Giường ngày vào && BHYT đến ngày > Ngày giường ra
                            //4.
                            //Ngày giường:  |____________+_____________|
                            //BHYT                  |______________________|
                            else if (DateTime.Compare(dti_BHYTTuNgay, dti_GiuongTuNgay) >= 0 && DateTime.Compare(dti_BHYTDenNgay, dti_GiuongDenNgay) >= 0)
                            {
                                TimeSpan tsp = dti_BHYTTuNgay - dti_GiuongTuNgay;
                                d_GiuongChoTP = tsp.Days;
                                tsp = dti_NgayPTTT - dti_BHYTTuNgay;
                                d_GiuongChoBHYT = tsp.Days;
                                tsp = dti_GiuongDenNgay - dti_NgayPTTT;
                                d_GiuongSauMoDeBHYT = Math.Min(1, tsp.Days);
                                if (b_QuanLyGiuongTheoKS && dti_GiuongDenNgay.Hour + Math.Min(dti_GiuongDenNgay.Minute, 1) > 12 && b_RaVien) { d_GiuongSauMoDeTP += 0.5M; }
                            }
                            #endregion
                            #region BHYT Từ Ngày > Giường ngày vào && BHYT đến ngày > Ngày PTTT
                            //5.
                            //Ngày giường:  |____________+_____________|
                            //BHYT                  |______________|
                            else if (DateTime.Compare(dti_BHYTTuNgay, dti_GiuongTuNgay) >= 0 && DateTime.Compare(dti_BHYTDenNgay, dti_NgayPTTT) >= 0)
                            {
                                TimeSpan tsp = dti_BHYTTuNgay - dti_GiuongTuNgay;
                                d_GiuongChoTP = tsp.Days;
                                tsp = dti_NgayPTTT - dti_BHYTTuNgay;
                                d_GiuongChoBHYT = tsp.Days;
                                tsp = dti_BHYTDenNgay - dti_NgayPTTT;
                                d_GiuongSauMoDeBHYT = Math.Min(1, tsp.Days);
                                tsp = dti_GiuongDenNgay - dti_BHYTDenNgay;
                                d_GiuongSauMoDeTP = tsp.Days;
                                if (b_QuanLyGiuongTheoKS && dti_GiuongDenNgay.Hour + Math.Min(dti_GiuongDenNgay.Minute, 1) > 12 && b_RaVien) { d_GiuongSauMoDeTP += 0.5M; }
                            }
                            #endregion
                            #region BHYT Từ Ngày > Giường ngày vào && BHYT đến ngày < Ngày PTTT
                            //6.
                            //Ngày giường:  |_________________________+_____________|
                            //BHYT                  |______________|
                            else if (DateTime.Compare(dti_BHYTTuNgay, dti_GiuongTuNgay) >= 0 && DateTime.Compare(dti_BHYTDenNgay, dti_NgayPTTT) <= 0)
                            {
                                TimeSpan tsp = dti_BHYTTuNgay - dti_GiuongTuNgay;
                                d_GiuongChoTP = tsp.Days;
                                tsp = dti_BHYTDenNgay - dti_BHYTTuNgay;
                                d_GiuongChoBHYT = tsp.Days;
                                tsp = dti_GiuongDenNgay - dti_BHYTDenNgay;
                                d_GiuongSauMoDeTP = tsp.Days;
                                if (b_QuanLyGiuongTheoKS && dti_GiuongDenNgay.Hour + Math.Min(dti_GiuongDenNgay.Minute, 1) > 12 && b_RaVien) { d_GiuongSauMoDeTP += 0.5M; }
                               
                            }
                            #endregion
                            #region BHYT Từ Ngày > Ngày PTTT && BHYT đến ngày > Giường ngày ra
                            //7.
                            //Ngày giường:  |____________+_____________|
                            //BHYT                           |______________________|
                            else if (DateTime.Compare(dti_BHYTTuNgay, dti_NgayPTTT) >= 0 && DateTime.Compare(dti_BHYTDenNgay, dti_GiuongDenNgay) >= 0)
                            {
                                TimeSpan tsp = dti_BHYTTuNgay - dti_GiuongTuNgay;
                                d_GiuongThuPhi = tsp.Days;
                                if (b_QuanLyGiuongTheoKS && dti_GiuongDenNgay.Hour + Math.Min(dti_GiuongDenNgay.Minute, 1) > 12 && b_RaVien) { d_GiuongSauMoDeTP += 0.5M; }
                                
                                tsp = dti_GiuongDenNgay - dti_BHYTTuNgay;
                                d_GiuongSauMoDeBHYT = Math.Min(1, tsp.Days);
                            }
                            #endregion
                            #region BHYT Từ Ngày > Ngày PTTT && BHYT đến ngày > Ngày PTTT
                            //8.
                            //Ngày giường:  |____________+_____________|
                            //BHYT                          |______|
                            else
                            {
                                TimeSpan tsp = dti_BHYTTuNgay - dti_GiuongTuNgay;
                                d_GiuongThuPhi = tsp.Days;
                                if (b_QuanLyGiuongTheoKS && dti_GiuongDenNgay.Hour + Math.Min(dti_GiuongDenNgay.Minute, 1) > 12 && b_RaVien) { d_GiuongSauMoDeTP += 0.5M; }
                                
                                tsp = dti_BHYTDenNgay - dti_BHYTTuNgay;
                                d_GiuongSauMoDeBHYT = Math.Min(1, tsp.Days);
                                tsp = dti_GiuongDenNgay - dti_BHYTDenNgay;
                                d_GiuongSauMoDeTP = tsp.Days;
                            }
                            #endregion
                        }
                        #endregion
                        #region Ngày PTTT < Ngày vào
                        else
                        {
                            #region BHYT Từ Ngày < Giường ngày vào && BHYT đến ngày > Giường ngày ra
                            //1.
                            //Ngày giường: +___|_________________________|
                            //BHYT      |__________________________________|
                            if (DateTime.Compare(dti_BHYTTuNgay, dti_NgayPTTT) <= 0 && DateTime.Compare(dti_BHYTDenNgay, dti_GiuongDenNgay) >= 0)
                            {
                                d_GiuongChoBHYT = 0;
                                TimeSpan tsp = dti_GiuongDenNgay - dti_GiuongTuNgay;
                                d_GiuongSauMoDeBHYT = Math.Max(1, tsp.Days);
                                if (dti_GiuongDenNgay.Hour + Math.Min(dti_GiuongDenNgay.Minute, 1) > 12 && b_RaVien ) { d_GiuongSauMoDeTP += 0.5M; }
                                tsp = dti_GiuongTuNgay - dti_NgayPTTT;
                                //d_GiuongGiuongTruBotBHYT = tsp.Days;
                            }
                            ////1.
                            ////Ngày giường: +___|_________________________|
                            ////BHYT      |___________________________|
                            //else if (DateTime.Compare(dti_BHYTTuNgay, dti_NgayPTTT) <= 0 && DateTime.Compare(dti_BHYTDenNgay, dti_GiuongDenNgay) < 0)
                            //{
                            //    d_GiuongChoBHYT = 0;
                            //    TimeSpan tsp = dti_GiuongDenNgay - dti_BHYTDenNgay;
                            //    d_GiuongSauMoDeBHYT = Math.Max(1, tsp.Days);
                            //    if (dti_GiuongDenNgay.Hour + Math.Min(dti_GiuongDenNgay.Minute, 1) > 12) { d_GiuongSauMoDeTP += 0.5M; }
                            //}
                            #endregion
                        }
                        #endregion
                        DataRow rTienGiuong = getrowbyid(dtGiaVp, "id=" + i_IDGiuong.ToString());
                        if (rTienGiuong != null)
                        {
                            decimal d_IDVpKhoa = 0;
                            #region Giường chờ BHYT
                            if (d_GiuongChoBHYT > 0)
                            {
                                d_IDVpKhoa = getidyymmddhhmiss_stt_computer;
                                upd_vpkhoa(d_IDVpKhoa, s_Mabn, l_MaVaoVien, l_Maql, l_IdKhoa, s_Ngay, s_Makp, i_MaDoiTuong, i_IDGiuong,
                                   d_GiuongChoBHYT, d_GiaGiuongCho, 0, i_UserID, 0, l_IdTheoDoiGiuong,1);
                                if (rTienGiuong["chenhlech"].ToString() == "1")
                                {
                                    int i_MaDoiTuongCL = 2;
                                    if (i_LoaiGiuong == 1) { i_MaDoiTuongCL = i_DoiTuongDichVu; }
                                    s_FieldGia = field_gia(i_MaDoiTuongCL.ToString());
                                    d_GiaChenhLech = decimal.Parse(rTienGiuong[s_FieldGia].ToString()) - d_GiaGiuongCho;
                                    if (d_GiaChenhLech > 0)
                                    {
                                        upd_vpkhoa(-d_IDVpKhoa, s_Mabn, l_MaVaoVien, l_Maql, l_IdKhoa, s_Ngay, s_Makp, i_MaDoiTuongCL, i_IDGiuong,
                                            d_GiuongChoBHYT, d_GiaChenhLech, 0, i_UserID, 0, l_IdTheoDoiGiuong,1);
                                    }
                                }
                            }
                            #endregion
                            #region Giường chờ TP
                            if (d_GiuongChoTP > 0)
                            {
                                if (i_LoaiGiuong == 1) { i_MaDoiTuongKhongBHYT = i_DoiTuongDichVu; }
                                else i_MaDoiTuongKhongBHYT = 2;
                                s_FieldGia = field_gia(i_MaDoiTuongKhongBHYT.ToString());
                                d_GiaKhongBHYT = decimal.Parse(rTienGiuong[s_FieldGia].ToString());
                                d_IDVpKhoa = getidyymmddhhmiss_stt_computer;
                                upd_vpkhoa(d_IDVpKhoa, s_Mabn, l_MaVaoVien, l_Maql, l_IdKhoa, s_Ngay, s_Makp, i_MaDoiTuongKhongBHYT, i_IDGiuong,
                                    d_GiuongChoTP, d_GiaKhongBHYT, 0, i_UserID, 0, l_IdTheoDoiGiuong,1);
                            }
                            #endregion
                            d_IDVpKhoa = getidyymmddhhmiss_stt_computer;
                            #region Giường mỗ đẻ BHYT
                            switch (i_LoaiNgayGiuong)
                            {
                                case (int)LoaiNgayGiuong.PhauThuatLoaiI:
                                    d_GiaBHYT = d_GiaGiuongPTTT1;
                                    d_GiuongBHYT = Math.Min(10, d_GiuongSauMoDeBHYT) - d_SoNgayGiuongCho;//giuong cho
                                    d_GiuongSauMoDeBHYT -= (d_GiuongBHYT + d_GiuongGiuongTruBotBHYT);
                                    break;
                                case (int)LoaiNgayGiuong.PhauThuatLoaiII:
                                    d_GiuongBHYT = Math.Min(10, d_GiuongSauMoDeBHYT) - d_SoNgayGiuongCho;//giuong cho
                                    d_GiuongSauMoDeBHYT -= (d_GiuongBHYT + d_GiuongGiuongTruBotBHYT);
                                    d_GiaBHYT = d_GiaGiuongPTTT2;
                                    break;
                                case (int)LoaiNgayGiuong.PhauThuatLoaiIII:
                                    d_GiuongBHYT = Math.Min(10, d_GiuongSauMoDeBHYT) - d_SoNgayGiuongCho;//giuong cho
                                    d_GiuongSauMoDeBHYT -= (d_GiuongBHYT + d_GiuongGiuongTruBotBHYT);
                                    d_GiaBHYT = d_GiaGiuongPTTT3;
                                    break;
                                case (int)LoaiNgayGiuong.PhauThuatLoaiDB://giuong cho
                                    d_GiuongBHYT = Math.Min(10, d_GiuongSauMoDeBHYT) - d_SoNgayGiuongCho;
                                    d_GiuongSauMoDeBHYT -= (d_GiuongBHYT + d_GiuongGiuongTruBotBHYT);
                                    d_GiaBHYT = d_GiaGiuongPTTTDB;
                                    break;
                                case (int)LoaiNgayGiuong.MoDe:
                                    d_GiaBHYT = d_GiaGiuongPTTT3;//giuong cho
                                    d_GiuongBHYT = Math.Min(10, d_GiuongSauMoDeBHYT) - d_SoNgayGiuongCho;
                                    d_GiuongSauMoDeBHYT -= (d_GiuongBHYT + d_GiuongGiuongTruBotBHYT);
                                    break;
                                case (int)LoaiNgayGiuong.SanhThuong:
                                    d_GiuongBHYT = Math.Min(3, d_GiuongSauMoDeBHYT) - d_SoNgayGiuongCho;//giuong cho
                                    d_GiuongSauMoDeBHYT -= (d_GiuongBHYT + d_GiuongGiuongTruBotBHYT);
                                    d_GiaBHYT = d_GiaGiuongDe;
                                    break;
                                default: return false;
                            }
                            d_SoNgayGiuongCho += d_GiuongBHYT;
                            if (d_GiuongBHYT > 0)
                            {
                                upd_vpkhoa(d_IDVpKhoa, s_Mabn, l_MaVaoVien, l_Maql, l_IdKhoa, s_Ngay, s_Makp, i_MaDoiTuong, i_IDGiuong,
                                       d_GiuongBHYT, d_GiaBHYT, 0, i_UserID, 0, l_IdTheoDoiGiuong,1);
                                if (rTienGiuong["chenhlech"].ToString() == "1")
                                {
                                    int i_MaDoiTuongCL = 2;
                                    if (i_LoaiGiuong == 1) { i_MaDoiTuongCL = i_DoiTuongDichVu; }
                                    s_FieldGia = field_gia(i_MaDoiTuongCL.ToString());
                                    d_GiaChenhLech = decimal.Parse(rTienGiuong[s_FieldGia].ToString()) - d_GiaBHYT;
                                    if (d_GiaChenhLech > 0)
                                    {
                                        upd_vpkhoa(-d_IDVpKhoa, s_Mabn, l_MaVaoVien, l_Maql, l_IdKhoa, s_Ngay, s_Makp, i_MaDoiTuongCL, i_IDGiuong,
                                            d_GiuongBHYT, d_GiaChenhLech, 0, i_UserID, 0, l_IdTheoDoiGiuong,1);
                                    }
                                }
                            }
                            #endregion
                            #region Giường mỗ đẻ TP
                            if (d_GiuongThuPhi > 0)
                            {
                                if (i_LoaiGiuong == 1) { i_MaDoiTuongKhongBHYT = i_DoiTuongDichVu; }
                                s_FieldGia = field_gia(i_MaDoiTuongKhongBHYT.ToString());
                                d_IDVpKhoa = getidyymmddhhmiss_stt_computer;
                                d_GiaKhongBHYT = decimal.Parse(rTienGiuong[s_FieldGia].ToString());
                                upd_vpkhoa(d_IDVpKhoa, s_Mabn, l_MaVaoVien, l_Maql, l_IdKhoa, s_Ngay, s_Makp, i_MaDoiTuongKhongBHYT, i_IDGiuong,
                                        d_GiuongThuPhi, d_GiaKhongBHYT, 0, i_UserID, 0, l_IdTheoDoiGiuong,1);
                            }
                            #endregion
                            #region Giường sau mỗ đẻ BHYT
                            if (d_GiuongSauMoDeBHYT > 0)
                            {
                                d_IDVpKhoa = getidyymmddhhmiss_stt_computer;
                                s_FieldGia = field_gia(i_MaDoiTuong.ToString());
                                upd_vpkhoa(d_IDVpKhoa, s_Mabn, l_MaVaoVien, l_Maql, l_IdKhoa, s_Ngay, s_Makp, i_MaDoiTuong, i_IDGiuong,
                                       d_GiuongSauMoDeBHYT, decimal.Parse(rTienGiuong[s_FieldGia].ToString()), 0, i_UserID, 0, l_IdTheoDoiGiuong,1);
                                if (rTienGiuong["chenhlech"].ToString() == "1")
                                {
                                    int i_MaDoiTuongCL = 2;
                                    if (i_LoaiGiuong == 1) { i_MaDoiTuongCL = i_DoiTuongDichVu; }
                                    s_FieldGia = field_gia(i_MaDoiTuongCL.ToString());
                                    d_GiaChenhLech = decimal.Parse(rTienGiuong[s_FieldGia].ToString()) - decimal.Parse(rTienGiuong["gia_bh"].ToString());
                                    if (d_GiaChenhLech > 0)
                                    {
                                        upd_vpkhoa(-d_IDVpKhoa, s_Mabn, l_MaVaoVien, l_Maql, l_IdKhoa, s_Ngay, s_Makp, i_MaDoiTuongCL, i_IDGiuong,
                                            d_GiuongSauMoDeBHYT, d_GiaChenhLech, 0, i_UserID, 0, l_IdTheoDoiGiuong,1);
                                    }
                                }
                            }
                            #endregion
                            #region Giường sau mỗ đẻ TP
                            if (d_GiuongSauMoDeTP > 0)
                            {
                                if (i_LoaiGiuong == 1) { i_MaDoiTuongKhongBHYT = i_DoiTuongDichVu; }
                                else i_MaDoiTuongKhongBHYT = 2;
                                s_FieldGia = field_gia(i_MaDoiTuongKhongBHYT.ToString());
                                d_GiaKhongBHYT = decimal.Parse(rTienGiuong[s_FieldGia].ToString());
                                d_IDVpKhoa = getidyymmddhhmiss_stt_computer;
                                upd_vpkhoa(d_IDVpKhoa, s_Mabn, l_MaVaoVien, l_Maql, l_IdKhoa, s_Ngay, s_Makp, i_MaDoiTuongKhongBHYT, i_IDGiuong,
                                    d_GiuongSauMoDeTP, d_GiaKhongBHYT, 0, i_UserID, 0, l_IdTheoDoiGiuong,1);
                            }
                            #endregion
                        }
                    }
                    #endregion
                }
                #endregion
            }
            catch
            { return false; }
            return true;
        }
        public bool upd_tiengiuong(string s_Mabn,
            decimal l_MaVaoVien, decimal l_Maql, decimal l_IdTheoDoiGiuong, int i_LoaiGiuong,
            int i_MaDoiTuong, string s_Ngay, decimal l_IdKhoa, string s_Makp, int i_UserID, DataTable dtGiaVp, 
            int i_IDGiuong, string s_GiuongTuNgay,
            string s_GiuongDenNgay, string s_BHYTTuNgay, string s_BHYTDenNgay, int i_DoiTuongDichVu,
            int i_LoaiNgayGiuong)
        {
            try
            {//linh 26052012
                if (s_Ngay == "" || s_GiuongTuNgay == "" || s_GiuongDenNgay == "") { return false; }
                if (s_BHYTTuNgay == "") { s_BHYTTuNgay = s_GiuongTuNgay; }
                if (i_MaDoiTuong == 1)
                {
                    if (s_BHYTDenNgay == "")
                    {
                        i_MaDoiTuong = 2;
                        s_BHYTDenNgay = DateTime.Now.ToString("dd/MM/yyyy");
                    }
                }
                else { s_BHYTDenNgay = s_GiuongDenNgay; }
                DateTime dti_GiuongTuNgay = StringToDateTime(s_GiuongTuNgay);
                DateTime dti_GiuongDenNgay = StringToDateTime(s_GiuongDenNgay);
                DateTime dti_BHYTTuNgay = StringToDate(s_BHYTTuNgay);
                DateTime dti_BHYTDenNgay = StringToDate(s_BHYTDenNgay);
                string s_FieldGia = "gia_th";
                #region thu phí
                if (i_MaDoiTuong != 1 || DateTime.Compare(dti_GiuongDenNgay, dti_BHYTTuNgay) < 0 || DateTime.Compare(dti_GiuongTuNgay, dti_BHYTDenNgay) > 0)
                {
                    decimal dSoNgayGiuong = 0;
                    TimeSpan tsp = dti_GiuongDenNgay - dti_GiuongTuNgay;
                    dSoNgayGiuong = tsp.Days;
                    int i_SoGio = tsp.Hours;
                    DataRow rTienGiuong = getrowbyid(dtGiaVp, "id=" + i_IDGiuong.ToString());
                    if (rTienGiuong != null && dSoNgayGiuong>0)//linh 17112012
                    {
                        decimal d_IDVpKhoa = getidyymmddhhmiss_stt_computer;
                        if (i_LoaiGiuong == 1)
                        {
                            i_MaDoiTuong = i_DoiTuongDichVu;
                        }
                        decimal d_dongia = decimal.Parse(rTienGiuong[field_gia(i_MaDoiTuong.ToString())].ToString());
                        upd_vpkhoa(d_IDVpKhoa, s_Mabn, l_MaVaoVien, l_Maql, l_IdKhoa, s_Ngay, s_Makp, i_MaDoiTuong, i_IDGiuong,
                           dSoNgayGiuong, d_dongia, 0, i_UserID, 0, l_IdTheoDoiGiuong, 1);
                    }
                }
                #endregion
                #region BHYT
                else
                {
                    decimal d_GiuongBHYT = 0;
                    decimal d_GiaBHYT = 0;
                    decimal d_GiaChenhLech = 0;
                    TimeSpan tsp = dti_GiuongDenNgay - dti_GiuongTuNgay;
                    d_GiuongBHYT = tsp.Days;
                    DataRow rTienGiuong = getrowbyid(dtGiaVp, "id=" + i_IDGiuong.ToString());
                    if (rTienGiuong != null && d_GiuongBHYT > 0)//linh 17112012
                    {
                        decimal d_IDVpKhoa = getidyymmddhhmiss_stt_computer;
                        d_GiaBHYT = decimal.Parse(rTienGiuong[field_gia(i_MaDoiTuong.ToString())].ToString());
                        upd_vpkhoa(d_IDVpKhoa, s_Mabn, l_MaVaoVien, l_Maql, l_IdKhoa, s_Ngay, s_Makp, i_MaDoiTuong, i_IDGiuong,
                           d_GiuongBHYT, d_GiaBHYT, 0, i_UserID, 0, l_IdTheoDoiGiuong, 1);
                        if (rTienGiuong["chenhlech"].ToString() == "1")
                        {
                            int i_MaDoiTuongCL = 2;
                            if (i_LoaiGiuong == 1) { i_MaDoiTuongCL = i_DoiTuongDichVu; }
                            s_FieldGia = field_gia(i_MaDoiTuongCL.ToString());
                            d_GiaChenhLech = decimal.Parse(rTienGiuong[s_FieldGia].ToString()) - decimal.Parse(rTienGiuong["gia_bh"].ToString());
                            if (d_GiaChenhLech > 0)
                            {
                                upd_vpkhoa(-d_IDVpKhoa, s_Mabn, l_MaVaoVien, l_Maql, l_IdKhoa, s_Ngay, s_Makp, i_MaDoiTuongCL, i_IDGiuong,
                                    d_GiuongBHYT, d_GiaChenhLech, 0, i_UserID, 0, l_IdTheoDoiGiuong, 1);
                            }
                        }
                    }
                }
                #endregion
            }
            catch
            { return false; }
            return true;
        }

        public bool upd_tiengiuong(string s_Mabn,
            decimal l_MaVaoVien, decimal l_Maql, decimal l_IdTheoDoiGiuong, int i_LoaiGiuong,
            int i_MaDoiTuong, string s_Ngay, decimal l_IdKhoa, string s_Makp, int i_UserID, DataTable dtGiaVp,
            int i_IDGiuong, string s_GiuongTuNgay,
            string s_GiuongDenNgay, string s_BHYTTuNgay, string s_BHYTDenNgay, int i_DoiTuongDichVu,
            int i_LoaiNgayGiuong, ref int i_SoNgayNamOPhongLuu, bool b_khoacuoi, bool b_khoadau, decimal d_GiaGiuong)
        {
            //Khoa dau: vao - ra trong ngay: them 1 ngay
            //khoa cuoi se tru 1 ngay 
            try
            {//linh 26052012
                if (s_Ngay == "" || s_GiuongTuNgay == "" || s_GiuongDenNgay == "") { return false; }
                if (s_BHYTTuNgay == "") { s_BHYTTuNgay = s_GiuongTuNgay; }
                if (i_MaDoiTuong == 1)
                {
                    if (s_BHYTDenNgay == "")
                    {
                        i_MaDoiTuong = 2;
                        s_BHYTDenNgay = DateTime.Now.ToString("dd/MM/yyyy");
                    }
                }
                else { s_BHYTDenNgay = s_GiuongDenNgay; }
                DateTime dti_GiuongTuNgay = StringToDate(s_GiuongTuNgay.Substring(0, 10));//StringToDateTime(s_GiuongTuNgay);
                DateTime dti_GiuongDenNgay = StringToDate(s_GiuongDenNgay.Substring(0, 10)); //StringToDateTime(s_GiuongDenNgay);
                DateTime dti_BHYTTuNgay = StringToDate(s_BHYTTuNgay);
                DateTime dti_BHYTDenNgay = StringToDate(s_BHYTDenNgay);
                string s_FieldGia = "gia_th";
                #region thu phí
                if (i_MaDoiTuong != 1 || DateTime.Compare(dti_GiuongDenNgay, dti_BHYTTuNgay) < 0 || DateTime.Compare(dti_GiuongTuNgay, dti_BHYTDenNgay) > 0)
                {
                    decimal dSoNgayGiuong = 0;
                    TimeSpan tsp = dti_GiuongDenNgay - dti_GiuongTuNgay;
                    dSoNgayGiuong = tsp.Days;
                    ////binh 040113
                    //if (b_khoacuoi && dSoNgayGiuong > 0 && s_Makp != "99" && i_SoNgayNamOPhongLuu > 0)
                    //{
                    //    dSoNgayGiuong = dSoNgayGiuong - 1;
                    //    i_SoNgayNamOPhongLuu = i_SoNgayNamOPhongLuu - 1;
                    //}
                    //else if (dSoNgayGiuong == 0 && s_Makp == "99" && i_SoNgayNamOPhongLuu > 0)
                    //{
                    //    dSoNgayGiuong = 1;
                    //}
                    //else if (b_khoadau && dSoNgayGiuong == 0)
                    //{
                    //    dSoNgayGiuong = 1;
                    //}
                    if (b_khoacuoi && dSoNgayGiuong == 0 && i_SoNgayNamOPhongLuu > 0)
                    {
                        dSoNgayGiuong = 1;
                        i_SoNgayNamOPhongLuu = i_SoNgayNamOPhongLuu - 1;
                    }
                    //end binh 040113
                    int i_SoGio = tsp.Hours;
                    DataRow rTienGiuong = getrowbyid(dtGiaVp, "id=" + i_IDGiuong.ToString());
                    if (rTienGiuong != null && dSoNgayGiuong > 0)//linh 17112012
                    {
                        decimal d_IDVpKhoa = getidyymmddhhmiss_stt_computer;
                        if (i_LoaiGiuong == 1)
                        {
                            i_MaDoiTuong = i_DoiTuongDichVu;
                        }
                        decimal d_dongia = 0; //decimal.Parse(rTienGiuong[field_gia(i_MaDoiTuong.ToString())].ToString());
                        if (d_GiaGiuong > 0) d_dongia = d_GiaGiuong;
                        else d_dongia = decimal.Parse(rTienGiuong[field_gia(i_MaDoiTuong.ToString())].ToString());
                        //
                        upd_vpkhoa(d_IDVpKhoa, s_Mabn, l_MaVaoVien, l_Maql, l_IdKhoa, s_Ngay, s_Makp, i_MaDoiTuong, i_IDGiuong,
                           dSoNgayGiuong, d_dongia, 0, i_UserID, 0, l_IdTheoDoiGiuong, 1);
                    }
                }
                #endregion
                #region BHYT
                else
                {
                    decimal d_GiuongBHYT = 0;
                    decimal d_GiaBHYT = 0;
                    decimal d_GiaChenhLech = 0;
                    TimeSpan tsp = dti_GiuongDenNgay - dti_GiuongTuNgay;
                    d_GiuongBHYT = tsp.Days;
                    ////binh 040113
                    //if (b_khoacuoi && d_GiuongBHYT > 0 && s_Makp != "99" && i_SoNgayNamOPhongLuu > 0)
                    //{
                    //    d_GiuongBHYT = d_GiuongBHYT - 1;
                    //    i_SoNgayNamOPhongLuu = i_SoNgayNamOPhongLuu - 1;
                    //}

                    //else if (d_GiuongBHYT == 0 && s_Makp == "99" && i_SoNgayNamOPhongLuu > 0)
                    //{
                    //    d_GiuongBHYT = 1;
                    //}
                    //else if (b_khoadau && d_GiuongBHYT == 0)
                    //{
                    //    d_GiuongBHYT = 1;
                    //}
                    if (b_khoacuoi && d_GiuongBHYT == 0 && i_SoNgayNamOPhongLuu > 0)
                    {
                        d_GiuongBHYT = 1;
                        i_SoNgayNamOPhongLuu = i_SoNgayNamOPhongLuu - 1;
                    }
                    //end binh 040113
                    DataRow rTienGiuong = getrowbyid(dtGiaVp, "id=" + i_IDGiuong.ToString());
                    if (rTienGiuong != null && d_GiuongBHYT > 0)//linh 17112012
                    {
                        decimal d_IDVpKhoa = getidyymmddhhmiss_stt_computer;
                        d_GiaBHYT = decimal.Parse(rTienGiuong[field_gia(i_MaDoiTuong.ToString())].ToString());
                        //decimal d_dongia = 0; //decimal.Parse(rTienGiuong[field_gia(i_MaDoiTuong.ToString())].ToString());
                        if (d_GiaGiuong > 0) d_GiaBHYT = d_GiaGiuong;
                        else d_GiaBHYT = decimal.Parse(rTienGiuong[field_gia(i_MaDoiTuong.ToString())].ToString());

                        upd_vpkhoa(d_IDVpKhoa, s_Mabn, l_MaVaoVien, l_Maql, l_IdKhoa, s_Ngay, s_Makp, i_MaDoiTuong, i_IDGiuong,
                           d_GiuongBHYT, d_GiaBHYT, 0, i_UserID, 0, l_IdTheoDoiGiuong, 1);
                        if (rTienGiuong["chenhlech"].ToString() == "1")
                        {
                            int i_MaDoiTuongCL = 2;
                            if (i_LoaiGiuong == 1) { i_MaDoiTuongCL = i_DoiTuongDichVu; }
                            s_FieldGia = field_gia(i_MaDoiTuongCL.ToString());
                            d_GiaChenhLech = decimal.Parse(rTienGiuong[s_FieldGia].ToString()) - decimal.Parse(rTienGiuong["gia_bh"].ToString());
                            if (d_GiaChenhLech > 0)
                            {
                                upd_vpkhoa(-d_IDVpKhoa, s_Mabn, l_MaVaoVien, l_Maql, l_IdKhoa, s_Ngay, s_Makp, i_MaDoiTuongCL, i_IDGiuong,
                                    d_GiuongBHYT, d_GiaChenhLech, 0, i_UserID, 0, l_IdTheoDoiGiuong, 1);
                            }
                        }
                    }
                }
                #endregion
            }
            catch
            { return false; }
            return true;
        }
        /// <summary>
        /// Nâng chiều dài feild
        /// </summary>
        public void modify_schema()
        {
            string s_sql = " select 'alter table '||table_schema||'.'||table_name|| ' alter column '||column_name||' type varchar2(" + i_maxlength_mabn.ToString() + ")' as ten from information_schema.columns  where lower(table_catalog)='" + database.ToLower() + "' and table_schema like '" + userid + "%' and column_name='mabn' and data_type='character varying' and character_maximum_length<" + i_maxlength_mabn.ToString();
            s_sql += " union all ";
            s_sql += " select 'alter table '||table_schema||'.'||table_name|| ' alter column '||column_name||' type numeric(" + iChieuDaiID.ToString() + ")' as ten from information_schema.columns  where lower(table_catalog)='" + database.ToLower() + "' and table_schema like '" + userid + "%' and column_name='id' and numeric_precision>=18 and numeric_precision<>" + iChieuDaiID.ToString();
            s_sql += " union all ";
            s_sql += " select 'alter table '||table_schema||'.'||table_name|| ' alter column '||column_name||' type numeric(" + iChieuDaiID.ToString() + ")' as ten from information_schema.columns  where lower(table_catalog)='" + database.ToLower() + "' and table_schema like '" + userid + "%' and column_name='idduyet' and numeric_precision>=18 and numeric_precision<>" + iChieuDaiID.ToString();
            s_sql += " union all ";
            s_sql += " select 'alter table '||table_schema||'.'||table_name|| ' alter column '||column_name||' type numeric(" + iChieuDaiID.ToString() + ")' as ten from information_schema.columns  where lower(table_catalog)='" + database.ToLower() + "' and table_schema like '" + userid + "%' and column_name='idthuchien' and numeric_precision>=18 and numeric_precision<>" + iChieuDaiID.ToString();
            s_sql += " union all ";
            s_sql += " select 'alter table '||table_schema||'.'||table_name|| ' alter column '||column_name||' type numeric(" + iChieuDaiID.ToString() + ")' as ten from information_schema.columns  where lower(table_catalog)='" + database.ToLower() + "' and table_schema like '" + userid + "%' and column_name='idttrv' and numeric_precision>=18 and numeric_precision<>" + iChieuDaiID.ToString();
            s_sql += " union all ";
            s_sql += " select 'alter table '||table_schema||'.'||table_name|| ' alter column '||column_name||' type numeric(" + iChieuDaiID.ToString() + ")' as ten from information_schema.columns  where lower(table_catalog)='" + database.ToLower() + "' and table_schema like '" + userid + "%' and column_name='idkhoa' and numeric_precision>=18 and numeric_precision<>" + iChieuDaiID.ToString();
            s_sql += " union all ";
            s_sql += " select 'alter table '||table_schema||'.'||table_name|| ' alter column '||column_name||' type numeric(" + iChieuDaiID.ToString() + ")' as ten from information_schema.columns  where lower(table_catalog)='" + database.ToLower() + "' and table_schema like '" + userid + "%' and column_name='idtheodoigiuong' and numeric_precision>=18 and numeric_precision<>" + iChieuDaiID.ToString();
            s_sql += " union all ";
            s_sql += " select 'alter table '||table_schema||'.'||table_name|| ' alter column '||column_name||' type numeric(" + iChieuDaiID.ToString() + ")' as ten from information_schema.columns  where lower(table_catalog)='" + database.ToLower() + "' and table_schema like '" + userid + "%' and column_name='idn' and numeric_precision>=18 and numeric_precision<>" + iChieuDaiID.ToString();
            s_sql += " union all ";
            s_sql += " select 'alter table '||table_schema||'.'||table_name|| ' alter column '||column_name||' type numeric(" + iChieuDaiID.ToString() + ")' as ten from information_schema.columns  where lower(table_catalog)='" + database.ToLower() + "' and table_schema like '" + userid + "%' and column_name='idx' and numeric_precision>=18 and numeric_precision<>" + iChieuDaiID.ToString();
            s_sql += " union all ";
            s_sql += " select 'alter table '||table_schema||'.'||table_name|| ' alter column '||column_name||' type numeric(" + iChieuDaiID.ToString() + ")' as ten from information_schema.columns  where lower(table_catalog)='" + database.ToLower() + "' and table_schema like '" + userid + "%' and column_name='idchidinh' and numeric_precision>=18 and numeric_precision<>" + iChieuDaiID.ToString();
            s_sql += " union all ";
            s_sql += " select 'alter table '||table_schema||'.'||table_name|| ' alter column '||column_name||' type numeric(" + iChieuDaiID.ToString() + ")' as ten from information_schema.columns  where lower(table_catalog)='" + database.ToLower() + "' and table_schema like '" + userid + "%' and column_name='idduoc' and numeric_precision>=18 and numeric_precision<>" + iChieuDaiID.ToString();
            s_sql += " union all ";
            s_sql += " select 'alter table '||table_schema||'.'||table_name|| ' alter column '||column_name||' type numeric(" + iChieuDaiID.ToString() + ")' as ten from information_schema.columns  where lower(table_catalog)='" + database.ToLower() + "' and table_schema like '" + userid + "%' and column_name='iddutru' and numeric_precision>=18 and numeric_precision<>" + iChieuDaiID.ToString();
            s_sql += " union all ";
            s_sql += " select 'alter table '||table_schema||'.'||table_name|| ' alter column '||column_name||' type numeric(" + iChieuDaiID.ToString() + ")' as ten from information_schema.columns  where lower(table_catalog)='" + database.ToLower() + "' and table_schema like '" + userid + "%' and column_name='stt' and numeric_precision>=18 and numeric_precision<>" + iChieuDaiID.ToString();
            s_sql += " union all ";
            s_sql += " select 'alter table '||table_schema||'.'||table_name|| ' alter column '||column_name||' type numeric(" + iChieuDaiID.ToString() + ")' as ten from information_schema.columns  where lower(table_catalog)='" + database.ToLower() + "' and table_schema like '" + userid + "%' and column_name='sttt' and numeric_precision>=18 and numeric_precision<>" + iChieuDaiID.ToString();
            s_sql += " union all ";
            s_sql += " select 'alter table '||table_schema||'.'||table_name|| ' alter column '||column_name||' type numeric(" + iChieuDaiID.ToString() + ")' as ten from information_schema.columns  where lower(table_catalog)='" + database.ToLower() + "' and table_schema like '" + userid + "%' and column_name='idtonghop' and numeric_precision>=18 and numeric_precision<>" + iChieuDaiID.ToString();
            s_sql += " union all ";
            s_sql += " select 'alter table '||table_schema||'.'||table_name|| ' alter column '||column_name||' type numeric(" + iChieuDaiID.ToString() + ")' as ten from information_schema.columns  where lower(table_catalog)='" + database.ToLower() + "' and table_schema like '" + userid + "%' and column_name='idvpkhoa' and numeric_precision>=18 and numeric_precision<>" + iChieuDaiID.ToString();
            s_sql += " union all ";
            s_sql += " select 'alter table '||table_schema||'.'||table_name|| ' alter column '||column_name||' type numeric(" + iChieuDaiID.ToString() + ")' as ten from information_schema.columns  where lower(table_catalog)='" + database.ToLower() + "' and table_schema like '" + userid + "%' and column_name='maql' and numeric_precision>=18 and numeric_precision<>" + iChieuDaiID.ToString();
            s_sql += " union all ";
            s_sql += " select 'alter table '||table_schema||'.'||table_name|| ' alter column '||column_name||' type numeric(" + iChieuDaiID.ToString() + ")' as ten from information_schema.columns  where lower(table_catalog)='" + database.ToLower() + "' and table_schema like '" + userid + "%' and column_name='maql_td'  and numeric_precision>=18 and numeric_precision<>" + iChieuDaiID.ToString();
            s_sql += " union all ";
            s_sql += " select 'alter table '||table_schema||'.'||table_name|| ' alter column '||column_name||' type numeric(" + iChieuDaiID.ToString() + ")' as ten from information_schema.columns  where lower(table_catalog)='" + database.ToLower() + "' and table_schema like '" + userid + "%' and column_name='mavaovien' and numeric_precision>=18 and numeric_precision<>" + iChieuDaiID.ToString();
            s_sql += " union all ";
            s_sql += " select 'alter table '||table_schema||'.'||table_name|| ' alter column '||column_name||' type varchar2(" + i_maxlength_makp.ToString() + ")' as ten from information_schema.columns  where lower(table_catalog)='" + database.ToLower() + "' and table_schema like '" + userid + "%' and column_name='makp' and data_type='character varying' and character_maximum_length<" + i_maxlength_makp.ToString();
            s_sql += " union all ";
            s_sql += " select 'alter table '||table_schema||'.'||table_name|| ' alter column '||column_name||' type varchar2(" + i_maxlength_makp.ToString() + ")' as ten from information_schema.columns  where lower(table_catalog)='" + database.ToLower() + "' and table_schema like '" + userid + "%' and column_name='mapk' and data_type='character varying' and character_maximum_length<" + i_maxlength_makp.ToString();
            DataSet dstmp = new DataSet();
            dstmp = get_data(s_sql);
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            con.Open();
            foreach (DataRow r in dstmp.Tables[0].Rows)
            {
                try
                {
                    cmd = new NpgsqlCommand(r["ten"].ToString(), con);
                    cmd.CommandType = CommandType.Text;
                    cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
                catch (Exception ex)
                {
                    string s = ex.ToString();
                    continue;
                }
            }
            con.Close(); con.Dispose();
        }
        //linh 06062012
        public void TongHopTienGiuong_linh(string s_Mabn, decimal d_MaVaoVien, decimal d_Maql, int i_MaDoiTuong, string s_Ngayvv, string s_Ngayrv,
            string s_BHYT_TuNgay, string s_BHYT_DenNgay, DataTable dtGiaVienPhi)
        {
            int i_LoaiNgayGiuong = 0;
            int i_TuNguyen = 0;
            decimal d_GiaGiuongCho = 0;
            decimal d_GiaGiuongSauDe = 0;
            decimal d_GiaGiuongPTTT1 = 0;
            decimal d_GiaGiuongPTTT2 = 0;
            decimal d_GiaGiuongPTTT3 = 0;
            decimal d_GiaGiuongPTTTDB = 0;
            i_TuNguyen = this.iTunguyen;
            bool b_QuanLyGiuongTheoCachTinhKhachSan = this.bNgaygiuong_tinhtheo_sangchieu;//linh 04102012
            bool b_QuanLyGiuongTheoCachTinhBHYT = this.bNgayra_ngayvao_1;//linh 05102012
            string s_sql = "select b.id,b.done,'xxx.' as user from xxx.v_vpkhoa b," + userid + ".v_giavp c," + 
                userid + ".v_loaivp d where b.mavp=c.id and c.id_loai=d.id and d.id_nhom=" + this.iNhomphonggiuong + " and b.mavaovien=" + d_MaVaoVien.ToString() + " ";
            s_sql += " and to_date(to_char(b.ngay,'dd/mm/yyyy'),'dd/mm/yyyy') between to_date('" + s_Ngayvv.Substring(0,10) + "','dd/mm/yyyy') ";
            s_sql += " and to_date('" + s_Ngayrv.Substring(0,10) + "','dd/mm/yyyy') ";
            DataTable dtTh = new DataTable();
            dtTh = get_data_mmyy(s_sql, s_Ngayvv, s_Ngayrv, false).Tables[0];
            //if (dtTh.Select("done=1").Length == 0)
            {
                foreach (DataRow rth in dtTh.Select("done=0"))
                {
                    string s_usermmyy = rth["user"].ToString().Trim('.');
                    string s_mmyy = s_usermmyy.Replace(userid, "");
                    if (this.bMmyy(s_mmyy))
                    {
                        s_sql = "delete from " + s_usermmyy + ".v_vpkhoa where id=" + rth["id"].ToString() + " and done=0";
                        this.execute_data(s_sql);
                    }
                }
                #region quản lý theo cách tính của khách sạn
                if (b_QuanLyGiuongTheoCachTinhKhachSan)
                {
                    s_sql = "select a.id,to_char(a.ngay,'dd/mm/yyyy hh24:mi') as ngay,b.sande ,b.dacbiet,b.loai1,b.loai2,b.loai3,b.id_pttt ";
                    s_sql += "from xxx.pttt a inner join medibv.dmpttt b on a.mapt=b.mapt where a.maql=" + d_Maql.ToString();
                    DataTable dtpttt = get_data_mmyy(s_sql, s_Ngayvv.Substring(0, 10), s_Ngayrv.Substring(0, 10), false).Tables[0];
                    DataTable dtgiagiuongbhyt = get_data("select * from " + user + ".v_giagiuongbhyt").Tables[0];
                    #region thông số giá
                    try
                    {
                        d_GiaGiuongCho = decimal.Parse(dtgiagiuongbhyt.Select("id=3")[0]["dongia"].ToString());
                    }
                    catch { }
                    try
                    {
                        d_GiaGiuongSauDe = decimal.Parse(dtgiagiuongbhyt.Select("id=1")[0]["dongia"].ToString());
                    }
                    catch { }
                    try
                    {
                        d_GiaGiuongPTTT1 = decimal.Parse(dtgiagiuongbhyt.Select("id=6")[0]["dongia"].ToString());
                    }
                    catch { }
                    try
                    {
                        d_GiaGiuongPTTT2 = decimal.Parse(dtgiagiuongbhyt.Select("id=7")[0]["dongia"].ToString());
                    }
                    catch { }
                    try
                    {
                        d_GiaGiuongPTTT3 = decimal.Parse(dtgiagiuongbhyt.Select("id=8")[0]["dongia"].ToString());
                    }
                    catch { }
                    try
                    {
                        d_GiaGiuongPTTTDB = decimal.Parse(dtgiagiuongbhyt.Select("id=5")[0]["dongia"].ToString());
                    }
                    catch { }
                    #endregion
                    s_sql = "select to_char(ngay,'dd/mm/yyyy hh24:mi') as ngay from " + userid + ".cdsankhoa where maql=" + d_Maql.ToString();
                    bool b_SanhThuong = false;
                    string s_NgayPTTT = "";
                    foreach (DataRow r in get_data(s_sql).Tables[0].Rows)
                    {
                        i_LoaiNgayGiuong = (int)LoaiNgayGiuong.SanhThuong;
                        b_SanhThuong = true;
                        s_NgayPTTT = r["ngay"].ToString();
                        break;
                    }
                    foreach (DataRow rPttt in dtpttt.Select("", "id desc"))
                    {
                        if (!b_SanhThuong)
                        {
                            s_NgayPTTT = rPttt["ngay"].ToString();
                            if (rPttt["dacbiet"].ToString().Trim() != "") { i_LoaiNgayGiuong = (int)LoaiNgayGiuong.PhauThuatLoaiDB; }
                            else if (rPttt["loai1"].ToString().Trim() != "1") { i_LoaiNgayGiuong = (int)LoaiNgayGiuong.PhauThuatLoaiI; }
                            else if (rPttt["loai2"].ToString().Trim() != "1") { i_LoaiNgayGiuong = (int)LoaiNgayGiuong.PhauThuatLoaiII; }
                            else if (rPttt["loai3"].ToString().Trim() != "1") { i_LoaiNgayGiuong = (int)LoaiNgayGiuong.PhauThuatLoaiIII; }
                        }
                        else if (rPttt["id_pttt"].ToString() == ((int)LoaiPTTT.PhauThuat).ToString())
                        {
                            i_LoaiNgayGiuong = (int)LoaiNgayGiuong.PhauThuatLoaiIII;
                        }
                        break;
                    }
                    decimal d_SoNgayGiuongCho = 0;
                    bool bKhoaDau = true;
                    foreach (DataRow r1 in get_data("select a.id,a.mavaovien,to_char(a.tu,'dd/mm/yyyy hh24:mi') as tu,to_char(coalesce(a.den,now()),'dd/mm/yyyy hh24:mi') as den,a.dongia,a.idgiuong," +
                        "a.madoituong,c.dichvu, d.chenhlech, a.makp, a.userid, a.idkhoa,coalesce(e.ttlucrk,1) as ravien from " + userid + ".theodoigiuong a," + userid + ".dmgiuong b," + userid +
                        ".dmphong c," + userid + ".v_giavp d," + userid + ".xuatkhoa e where a.idkhoa=e.id(+) and a.idgiuong=b.id and b.idphong=c.id and b.id=d.id and a.maql=" + d_Maql.ToString()).Tables[0].Rows)
                    {
                        this.upd_tiengiuong(b_QuanLyGiuongTheoCachTinhKhachSan, s_Mabn, d_MaVaoVien, d_Maql, decimal.Parse(r1["id"].ToString()), int.Parse(r1["dichvu"].ToString()),
                            i_MaDoiTuong, r1["den"].ToString(), decimal.Parse(r1["idkhoa"].ToString()), r1["makp"].ToString(), int.Parse(r1["userid"].ToString()),
                            dtGiaVienPhi, int.Parse(r1["idgiuong"].ToString()), r1["tu"].ToString(), r1["den"].ToString(), s_BHYT_TuNgay, s_BHYT_DenNgay,
                            i_TuNguyen, s_NgayPTTT, i_LoaiNgayGiuong, d_GiaGiuongCho, d_GiaGiuongSauDe, d_GiaGiuongPTTT1, d_GiaGiuongPTTT2, d_GiaGiuongPTTT3,
                            d_GiaGiuongPTTTDB, ref d_SoNgayGiuongCho, r1["ravien"].ToString() != "5", bKhoaDau);
                        bKhoaDau = false;
                    }
                }
                #endregion
                else
                {
                    if (b_QuanLyGiuongTheoCachTinhBHYT)
                    {
                        //NGAY RA - NGAY VAO CHO MOI KHOA
                        //NEU VAO VIEN  - RA VIEN TRONG NGAY: TINH 1 NGAY
                        //NEU VAO VIEN KHOA A - RA VIEN KHOA B TRONG MOT NGAY: KHOA B TINH 1 NGAY
                        string s_Sql = "select a.ngay from " + userid + ".benhandt a," + userid + ".xuatvien b " +
                            " where a.maql=b.maql(+) and to_char(a.ngay,'dd/mm/yyyy')=to_char(coalesce(b.ngay,now()),'dd/mm/yyyy') and a.maql=" + d_Maql;
                        DataTable dt_tmp = new DataTable();
                        dt_tmp = this.get_data(s_Sql).Tables[0];
                        if (dt_tmp.Rows.Count != 0)
                        {
                            foreach (DataRow r1 in get_data("select a.id,a.mavaovien,to_char(a.tu,'dd/mm/yyyy hh24:mi') as tu,to_char(tu+1,'dd/mm/yyyy hh24:mi') as den,a.dongia,a.idgiuong," +
                            "a.madoituong,c.dichvu, d.chenhlech, a.makp, a.userid, a.idkhoa from " + userid + ".theodoigiuong a," + userid + ".dmgiuong b," + userid +
                            ".dmphong c," + userid + ".v_giavp d," + userid + ".benhandt e where a.maql=e.maql and a.makp=e.makp and a.idgiuong=b.id and b.idphong=c.id and b.id=d.id and a.maql=" + d_Maql.ToString()).Tables[0].Rows)
                            {
                                this.upd_tiengiuong(s_Mabn, d_MaVaoVien, d_Maql, decimal.Parse(r1["id"].ToString()), int.Parse(r1["dichvu"].ToString()),
                                i_MaDoiTuong, r1["tu"].ToString(), decimal.Parse(r1["idkhoa"].ToString()), r1["makp"].ToString(), int.Parse(r1["userid"].ToString()),
                                dtGiaVienPhi, int.Parse(r1["idgiuong"].ToString()), r1["tu"].ToString(), r1["den"].ToString(), s_BHYT_TuNgay, s_BHYT_DenNgay,
                                i_TuNguyen, i_LoaiNgayGiuong);
                                break;
                            }
                        }
                        else
                        {
                            dt_tmp = new DataTable();
                            dt_tmp = get_data("select a.id,a.mavaovien,to_char(a.tu,'dd/mm/yyyy') as tu," +
                                " to_char(coalesce(a.den,now()),'dd/mm/yyyy') as den,a.dongia,a.idgiuong," +
                              "a.madoituong,c.dichvu, d.chenhlech, a.makp, a.userid, a.idkhoa," +
                              " coalesce(e.ttlucrk,1) as ravien from " + userid + ".theodoigiuong a," + userid + ".dmgiuong b," +
                              userid + ".dmphong c," + userid + ".v_giavp d," + userid + ".xuatkhoa e " +
                              " where a.idkhoa=e.id(+) and a.idgiuong=b.id and b.idphong=c.id and b.id=d.id " +
                              " and a.mavaovien=" + d_MaVaoVien.ToString() + " order by a.tu asc,a.den asc").Tables[0];
                            decimal d_ID = 0;
                            if (i_MaDoiTuong == 1)//linh 03012013
                            {
                                s_Sql = "select sothe,to_char(tungay,'dd/mm/yyyy') as tungay,to_char(tungay,'yyyymmdd') as tungay_BHYT," +
                                  "to_char(denngay,'dd/mm/yyyy') as denngay,to_char(denngay,'yyyymmdd') as denngay_BHYT from " + userid + ".bhyt where maql =" + d_Maql;
                                DataTable dtBHYT = this.get_data(s_Sql).Tables[0];
                                string s_TuNgay = "";
                                string s_DenNgay = "";
                                bool bKhoaDau = true;
                                foreach (DataRow r1 in dt_tmp.Rows)
                                {
                                    if (d_ID < Convert.ToDecimal(r1["id"]))
                                    {
                                        d_ID = Convert.ToDecimal(r1["id"]);
                                        s_TuNgay = r1["tu"].ToString();
                                        DataRow[] rNgayGiuong = dt_tmp.Select("den='" + r1["den"].ToString() + "' and id>=" + r1["id"].ToString() + "", "id desc");
                                        s_DenNgay = rNgayGiuong[0]["den"].ToString();
                                        if (rNgayGiuong.Length > 0)
                                        {
                                            d_ID = Convert.ToDecimal(rNgayGiuong[0]["id"]);
                                            if (bKhoaDau)
                                            {
                                                DateTime dtingay = StringToDate(rNgayGiuong[0]["den"].ToString()).AddDays(1);
                                                foreach (DataRow rc in dt_tmp.Select("tu='" + r1["den"].ToString() + "' and id>" + r1["id"].ToString()))
                                                {
                                                    rc["tu"] = dtingay.ToString("dd/MM/yyyy");
                                                }
                                                dt_tmp.AcceptChanges();
                                                if (s_TuNgay == s_DenNgay) { s_DenNgay = dtingay.ToString("dd/MM/yyyy"); }
                                            }
                                        }
                                        if (SoSanhNgay(s_TuNgay, s_DenNgay) > 0)
                                        {
                                            continue;
                                        }
                                        bKhoaDau = false;
                                        DateTime dti_Giuong_TuNgay = StringToDate(s_TuNgay);
                                        DateTime dti_Giuong_DenNgay = StringToDate(s_DenNgay);
                                        DataRow[] rBHYT = dtBHYT.Select("(denngay_bhyt>=" + s_TuNgay.Substring(6, 4) + s_TuNgay.Substring(3, 2) + s_TuNgay.Substring(0, 2)+")"+
                                            " and (tungay_bhyt<=" + s_DenNgay.Substring(6, 4) + s_DenNgay.Substring(3, 2) + s_DenNgay.Substring(0, 2) + ")");
                                        if (rBHYT.Length > 0)
                                        {
                                            s_BHYT_TuNgay = rBHYT[0]["tungay"].ToString();
                                            s_BHYT_DenNgay = rBHYT[0]["denngay"].ToString();
                                            DateTime dti_BHYT_TuNgay = StringToDate(s_BHYT_TuNgay);//linh 03012013
                                            DateTime dti_BHYT_DenNgay = StringToDate(s_BHYT_DenNgay);
                                            //bhyt         |-----------------------------|
                                            //giuong   |---------|
                                            if (DateTime.Compare(dti_Giuong_TuNgay, dti_BHYT_TuNgay) <= 0 && DateTime.Compare(dti_Giuong_DenNgay, dti_BHYT_DenNgay) <= 0)
                                            { 
                                                this.upd_tiengiuong(s_Mabn, d_MaVaoVien, d_Maql, decimal.Parse(r1["id"].ToString()), int.Parse(r1["dichvu"].ToString()),
                                                     i_MaDoiTuong, s_DenNgay, decimal.Parse(r1["idkhoa"].ToString()), r1["makp"].ToString(), int.Parse(r1["userid"].ToString()),
                                                     dtGiaVienPhi, int.Parse(r1["idgiuong"].ToString()), s_BHYT_TuNgay, s_DenNgay, s_BHYT_TuNgay, s_BHYT_DenNgay,
                                                     i_TuNguyen, i_LoaiNgayGiuong);
                                                this.upd_tiengiuong(s_Mabn, d_MaVaoVien, d_Maql, decimal.Parse(r1["id"].ToString()), int.Parse(r1["dichvu"].ToString()),
                                                 2, s_BHYT_TuNgay, decimal.Parse(r1["idkhoa"].ToString()), r1["makp"].ToString(), int.Parse(r1["userid"].ToString()),
                                                 dtGiaVienPhi, int.Parse(r1["idgiuong"].ToString()), s_TuNgay, StringToDate( s_BHYT_TuNgay).AddDays(-1).ToString("dd/MM/yyyy"), s_BHYT_TuNgay, s_BHYT_DenNgay,
                                                 i_TuNguyen, i_LoaiNgayGiuong);//linh 04012013
                                            }
                                            //bhyt         |-----------------------------|
                                            //giuong              |---------|
                                            else if (DateTime.Compare(dti_Giuong_TuNgay, dti_BHYT_TuNgay) >= 0 && DateTime.Compare(dti_Giuong_DenNgay, dti_BHYT_DenNgay) <= 0)
                                            { 
                                                 this.upd_tiengiuong(s_Mabn, d_MaVaoVien, d_Maql, decimal.Parse(r1["id"].ToString()), int.Parse(r1["dichvu"].ToString()),
                                                   i_MaDoiTuong, s_DenNgay, decimal.Parse(r1["idkhoa"].ToString()), r1["makp"].ToString(), int.Parse(r1["userid"].ToString()),
                                                   dtGiaVienPhi, int.Parse(r1["idgiuong"].ToString()), s_TuNgay, s_DenNgay, s_BHYT_TuNgay, s_BHYT_DenNgay,
                                                   i_TuNguyen, i_LoaiNgayGiuong);
                                            }
                                            //bhyt         |-----------------------------|
                                            //giuong              |--------------------------|
                                            else if (DateTime.Compare(dti_Giuong_TuNgay, dti_BHYT_TuNgay) >= 0 && DateTime.Compare(dti_Giuong_DenNgay, dti_BHYT_DenNgay) >= 0)
                                            {
                                                this.upd_tiengiuong(s_Mabn, d_MaVaoVien, d_Maql, decimal.Parse(r1["id"].ToString()), int.Parse(r1["dichvu"].ToString()),
                                                     i_MaDoiTuong, s_BHYT_DenNgay, decimal.Parse(r1["idkhoa"].ToString()), r1["makp"].ToString(), int.Parse(r1["userid"].ToString()),
                                                     dtGiaVienPhi, int.Parse(r1["idgiuong"].ToString()), s_TuNgay, s_BHYT_DenNgay, s_BHYT_TuNgay, s_BHYT_DenNgay,
                                                     i_TuNguyen, i_LoaiNgayGiuong);
                                                this.upd_tiengiuong(s_Mabn, d_MaVaoVien, d_Maql, decimal.Parse(r1["id"].ToString()), int.Parse(r1["dichvu"].ToString()),
                                                 2, s_DenNgay, decimal.Parse(r1["idkhoa"].ToString()), r1["makp"].ToString(), int.Parse(r1["userid"].ToString()),
                                                 dtGiaVienPhi, int.Parse(r1["idgiuong"].ToString()),StringToDate( s_BHYT_DenNgay).AddDays(1).ToString("dd/MM/yyyy"), s_DenNgay, s_BHYT_TuNgay, s_BHYT_DenNgay,
                                                 i_TuNguyen, i_LoaiNgayGiuong);//linh 04012013
                                            }
                                            //bhyt         |-----------------------------|
                                            //giuong     |----------------------------------|
                                            //else
                                            //{
                                            //    this.upd_tiengiuong(s_Mabn, d_MaVaoVien, d_Maql, decimal.Parse(r1["id"].ToString()), int.Parse(r1["dichvu"].ToString()),
                                            //         i_MaDoiTuong, s_BHYT_TuNgay, decimal.Parse(r1["idkhoa"].ToString()), r1["makp"].ToString(), int.Parse(r1["userid"].ToString()),
                                            //         dtGiaVienPhi, int.Parse(r1["idgiuong"].ToString()), s_BHYT_DenNgay, s_BHYT_TuNgay, s_BHYT_TuNgay, s_BHYT_DenNgay,
                                            //        this.upd_tiengiuong(s_Mabn, d_MaVaoVien, d_Maql, decimal.Parse(r1["id"].ToString()), int.Parse(r1["dichvu"].ToString()),
                                            //         2, r1["den"].ToString(), decimal.Parse(r1["idkhoa"].ToString()), r1["makp"].ToString(), int.Parse(r1["userid"].ToString()),
                                            //         dtGiaVienPhi, int.Parse(r1["idgiuong"].ToString()), s_BHYT_DenNgay, s_DenNgay, s_BHYT_TuNgay, s_BHYT_DenNgay,
                                            //         i_TuNguyen, i_LoaiNgayGiuong);
                                            //    this.upd_tiengiuong(s_Mabn, d_MaVaoVien, d_Maql, decimal.Parse(r1["id"].ToString()), int.Parse(r1["dichvu"].ToString()),
                                            //     2, s_BHYT_TuNgay, decimal.Parse(r1["idkhoa"].ToString()), r1["makp"].ToString(), int.Parse(r1["userid"].ToString()),
                                            //     dtGiaVienPhi, int.Parse(r1["idgiuong"].ToString()), s_TuNgay, s_BHYT_TuNgay, s_BHYT_TuNgay, s_BHYT_DenNgay,
                                            //     i_TuNguyen, i_LoaiNgayGiuong);
                                            //    this.upd_tiengiuong(s_Mabn, d_MaVaoVien, d_Maql, decimal.Parse(r1["id"].ToString()), int.Parse(r1["dichvu"].ToString()),
                                            //     2, s_BHYT_TuNgay, decimal.Parse(r1["idkhoa"].ToString()), r1["makp"].ToString(), int.Parse(r1["userid"].ToString()),
                                            //     dtGiaVienPhi, int.Parse(r1["idgiuong"].ToString()), s_BHYT_DenNgay, s_BHYT_TuNgay, s_BHYT_TuNgay, s_BHYT_DenNgay,
                                            //     i_TuNguyen, i_LoaiNgayGiuong);
                                            //}
                                        }
                                        //bhyt                     |-----------------------------|
                                        //giuong     |------------|
                                        //giuong                                                    |------------|
                                        else 
                                        {
                                            this.upd_tiengiuong(s_Mabn, d_MaVaoVien, d_Maql, decimal.Parse(r1["id"].ToString()), int.Parse(r1["dichvu"].ToString()),
                                                 2, s_DenNgay, decimal.Parse(r1["idkhoa"].ToString()), r1["makp"].ToString(), int.Parse(r1["userid"].ToString()),
                                                 dtGiaVienPhi, int.Parse(r1["idgiuong"].ToString()), s_TuNgay, s_DenNgay, s_BHYT_TuNgay, s_BHYT_DenNgay,
                                                 i_TuNguyen, i_LoaiNgayGiuong);
                                        }
                                    }
                                }
                            }
                            else
                            { 
                                string s_TuNgay = "";
                                string s_DenNgay = "";
                                bool bKhoaDau = true;
                                foreach (DataRow r1 in dt_tmp.Rows)
                                {
                                    if (d_ID < Convert.ToDecimal(r1["id"]))
                                    {
                                        d_ID = Convert.ToDecimal(r1["id"]);
                                        s_TuNgay = r1["tu"].ToString();
                                        DataRow[] rNgayGiuong = dt_tmp.Select("den='" + r1["den"].ToString() + "' and id>=" + r1["id"].ToString() + "", "id desc");
                                        s_DenNgay = rNgayGiuong[0]["den"].ToString();
                                        if (rNgayGiuong.Length > 0)
                                        {
                                            d_ID = Convert.ToDecimal(rNgayGiuong[0]["id"]);
                                            if (bKhoaDau)
                                            {
                                                DateTime dtingay = StringToDate(rNgayGiuong[0]["den"].ToString()).AddDays(1);
                                                //foreach (DataRow rc in dt_tmp.Select("tu='" + r1["den"].ToString() + "' and id>" + r1["id"].ToString()))
                                                //{
                                                //    rc["tu"] = dtingay.ToString("dd/MM/yyyy");
                                                //}
                                                //dt_tmp.AcceptChanges();
                                                if (s_TuNgay == s_DenNgay) { s_DenNgay = dtingay.ToString("dd/MM/yyyy"); }
                                            }
                                        }
                                        bKhoaDau = false;
                                        if (SoSanhNgay(s_TuNgay, s_DenNgay) > 0)
                                        {
                                            continue;
                                        }
                                        this.upd_tiengiuong(s_Mabn, d_MaVaoVien, d_Maql, decimal.Parse(r1["id"].ToString()), int.Parse(r1["dichvu"].ToString()),
                               i_MaDoiTuong, s_DenNgay, decimal.Parse(r1["idkhoa"].ToString()), r1["makp"].ToString(), int.Parse(r1["userid"].ToString()),
                               dtGiaVienPhi, int.Parse(r1["idgiuong"].ToString()), s_TuNgay, s_DenNgay, s_TuNgay, s_DenNgay,
                               i_TuNguyen, i_LoaiNgayGiuong);
                                    }
                                }
                            }
                        }
                    }
                    else
                    {
                        foreach (DataRow r1 in get_data("select a.id,a.mavaovien,to_char(a.tu,'dd/mm/yyyy hh24:mi') as tu,to_char(coalesce(a.den,now()),'dd/mm/yyyy hh24:mi') as den,a.dongia,a.idgiuong," +
                                                 "a.madoituong,c.dichvu, d.chenhlech, a.makp, a.userid, a.idkhoa,coalesce(e.ttlucrk,1) as ravien from " + userid + ".theodoigiuong a," + userid + ".dmgiuong b," + userid +
                                                 ".dmphong c," + userid + ".v_giavp d," + userid + ".xuatkhoa e where a.idkhoa=e.id(+) and a.idgiuong=b.id and b.idphong=c.id and b.id=d.id and a.maql=" + d_Maql.ToString()).Tables[0].Rows)
                        {
                            this.upd_tiengiuong(s_Mabn, d_MaVaoVien, d_Maql, decimal.Parse(r1["id"].ToString()), int.Parse(r1["dichvu"].ToString()),
                                i_MaDoiTuong, r1["den"].ToString(), decimal.Parse(r1["idkhoa"].ToString()), r1["makp"].ToString(), int.Parse(r1["userid"].ToString()),
                                dtGiaVienPhi, int.Parse(r1["idgiuong"].ToString()), r1["tu"].ToString(), r1["den"].ToString(), s_BHYT_TuNgay, s_BHYT_DenNgay,
                                i_TuNguyen, i_LoaiNgayGiuong);
                        }
                    }
                }
            }
        }

        public void TongHopTienGiuong(string s_Mabn, decimal d_MaVaoVien, decimal d_Maql, int i_MaDoiTuong, string s_NgayBatdauvaovien, string s_Ngayvv, string s_Ngayrv,
            string s_BHYT_TuNgay, string s_BHYT_DenNgay, DataTable dtGiaVienPhi, bool bThanhtoanNhieudot, int i_loaibenhan)
        {
            int i_LoaiNgayGiuong = 0;
            int i_songaygiuongphongluu = 0;//=1: NEU VAO VA RA PHONG LUU TRONG NGAY, =0: RA > VAO PHONG LUU            
            int i_TuNguyen = 0;
            decimal d_GiaGiuongCho = 0;
            decimal d_GiaGiuongSauDe = 0;
            decimal d_GiaGiuongPTTT1 = 0;
            decimal d_GiaGiuongPTTT2 = 0;
            decimal d_GiaGiuongPTTT3 = 0;
            decimal d_GiaGiuongPTTTDB = 0;
            decimal d_giagiuong = 0;
            i_TuNguyen = this.iTunguyen;
            bool b_QuanLyGiuongTheoCachTinhKhachSan = this.bNgaygiuong_tinhtheo_sangchieu;//linh 04102012
            bool b_QuanLyGiuongTheoCachTinhBHYT = this.bNgayra_ngayvao_1;//linh 05102012
            //
            //binh 120113: update den - ngay xuat khoa: do ct cu khi xuat khoa khong set lai den = ngay ra khoa
            sql = " update medibv.theodoigiuong a set den=(select ngay from medibv.xuatkhoa b where a.idkhoa=b.id) where den is null and idkhoa in(select  id from medibv.xuatkhoa) ";
            execute_data(sql);
            //
            string s_sql = "select b.id,b.done,b.makp, b.idttrv,'xxx.' as user from xxx.v_vpkhoa b," + userid + ".v_giavp c," +
                userid + ".v_loaivp d where b.mavp=c.id and c.id_loai=d.id and d.id_nhom=" + this.iNhomphonggiuong + " and b.mavaovien=" + d_MaVaoVien.ToString() + " ";
            //s_sql += " and to_date(to_char(b.ngay,'dd/mm/yyyy'),'dd/mm/yyyy') between to_date('" + s_Ngayvv.Substring(0,10) + "','dd/mm/yyyy') ";
            //s_sql += " and to_date('" + s_Ngayrv.Substring(0,10) + "','dd/mm/yyyy') ";
            if (bThanhtoanNhieudot)
            {
                s_sql += " and to_date(to_char(ngay,'dd/mm/yyyy'),'dd/mm/yyyy')>= to_date('" + s_Ngayvv.Substring(0, 10) + "','dd/mm/yyyy')";
                s_sql += " and to_date(to_char(ngay,'dd/mm/yyyy'),'dd/mm/yyyy')<= to_date('" + s_Ngayrv.Substring(0, 10) + "','dd/mm/yyyy')";
            }
            DataTable dtTh = new DataTable();
            dtTh = get_data_mmyy(s_sql, s_Ngayvv, ngayhienhanh_server.Substring(0, 10), false).Tables[0]; //dtTh = get_data_mmyy(s_sql, s_Ngayvv, s_Ngayrv, false).Tables[0];
            if (dtTh.Select("done=1 and idttrv<>0").Length == 0)
            {
                foreach (DataRow rth in dtTh.Select("done=0 or idttrv=0"))
                {
                    string s_usermmyy = rth["user"].ToString().Trim('.');
                    string s_mmyy = s_usermmyy.Replace(userid, "");
                    if (this.bMmyy(s_mmyy))
                    {
                        s_sql = "delete from " + s_usermmyy + ".v_vpkhoa where id=" + rth["id"].ToString() + " and (done=0 or idttrv=0)";// and (giuongtudong=1 or giuongtudong is null)";
                        if (bThanhtoanNhieudot)
                        {
                            s_sql += " and to_date(to_char(ngay,'dd/mm/yyyy'),'dd/mm/yyyy')>= to_date('" + s_Ngayvv.Substring(0, 10) + "','dd/mm/yyyy')";
                            s_sql += " and to_date(to_char(ngay,'dd/mm/yyyy'),'dd/mm/yyyy')<= to_date('" + s_Ngayrv.Substring(0, 10) + "','dd/mm/yyyy')";
                        }
                        this.execute_data(s_sql);
                    }
                }
                #region quản lý theo cách tính của khách sạn
                if (b_QuanLyGiuongTheoCachTinhKhachSan)
                {
                    s_sql = "select a.id,to_char(a.ngay,'dd/mm/yyyy hh24:mi') as ngay,b.sande ,b.dacbiet,b.loai1,b.loai2,b.loai3,b.id_pttt ";
                    s_sql += "from xxx.pttt a inner join medibv.dmpttt b on a.mapt=b.mapt where a.maql=" + d_Maql.ToString();
                    DataTable dtpttt = get_data_mmyy(s_sql, s_Ngayvv.Substring(0, 10), s_Ngayrv.Substring(0, 10), false).Tables[0];
                    DataTable dtgiagiuongbhyt = get_data("select * from " + user + ".v_giagiuongbhyt").Tables[0];
                    #region thông số giá
                    try
                    {
                        d_GiaGiuongCho = decimal.Parse(dtgiagiuongbhyt.Select("id=3")[0]["dongia"].ToString());
                    }
                    catch { }
                    try
                    {
                        d_GiaGiuongSauDe = decimal.Parse(dtgiagiuongbhyt.Select("id=1")[0]["dongia"].ToString());
                    }
                    catch { }
                    try
                    {
                        d_GiaGiuongPTTT1 = decimal.Parse(dtgiagiuongbhyt.Select("id=6")[0]["dongia"].ToString());
                    }
                    catch { }
                    try
                    {
                        d_GiaGiuongPTTT2 = decimal.Parse(dtgiagiuongbhyt.Select("id=7")[0]["dongia"].ToString());
                    }
                    catch { }
                    try
                    {
                        d_GiaGiuongPTTT3 = decimal.Parse(dtgiagiuongbhyt.Select("id=8")[0]["dongia"].ToString());
                    }
                    catch { }
                    try
                    {
                        d_GiaGiuongPTTTDB = decimal.Parse(dtgiagiuongbhyt.Select("id=5")[0]["dongia"].ToString());
                    }
                    catch { }
                    #endregion
                    s_sql = "select to_char(ngay,'dd/mm/yyyy hh24:mi') as ngay from " + userid + ".cdsankhoa where maql=" + d_Maql.ToString();
                    bool b_SanhThuong = false;
                    string s_NgayPTTT = "";
                    foreach (DataRow r in get_data(s_sql).Tables[0].Rows)
                    {
                        i_LoaiNgayGiuong = (int)LoaiNgayGiuong.SanhThuong;
                        b_SanhThuong = true;
                        s_NgayPTTT = r["ngay"].ToString();
                        break;
                    }
                    foreach (DataRow rPttt in dtpttt.Select("", "id desc"))
                    {
                        if (!b_SanhThuong)
                        {
                            s_NgayPTTT = rPttt["ngay"].ToString();
                            if (rPttt["dacbiet"].ToString().Trim() != "") { i_LoaiNgayGiuong = (int)LoaiNgayGiuong.PhauThuatLoaiDB; }
                            else if (rPttt["loai1"].ToString().Trim() != "1") { i_LoaiNgayGiuong = (int)LoaiNgayGiuong.PhauThuatLoaiI; }
                            else if (rPttt["loai2"].ToString().Trim() != "1") { i_LoaiNgayGiuong = (int)LoaiNgayGiuong.PhauThuatLoaiII; }
                            else if (rPttt["loai3"].ToString().Trim() != "1") { i_LoaiNgayGiuong = (int)LoaiNgayGiuong.PhauThuatLoaiIII; }
                        }
                        else if (rPttt["id_pttt"].ToString() == ((int)LoaiPTTT.PhauThuat).ToString())
                        {
                            i_LoaiNgayGiuong = (int)LoaiNgayGiuong.PhauThuatLoaiIII;
                        }
                        break;
                    }
                    decimal d_SoNgayGiuongCho = 0;
                    bool bKhoaDau = true;
                    foreach (DataRow r1 in get_data("select a.id,a.mavaovien,to_char(a.tu,'dd/mm/yyyy hh24:mi') as tu,to_char(coalesce(a.den,now()),'dd/mm/yyyy hh24:mi') as den,a.dongia,a.idgiuong," +
                        "a.madoituong,c.dichvu, d.chenhlech, a.makp, a.userid, a.idkhoa,coalesce(e.ttlucrk,1) as ravien from " + userid + ".theodoigiuong a," + userid + ".dmgiuong b," + userid +
                        ".dmphong c," + userid + ".v_giavp d," + userid + ".xuatkhoa e where a.idkhoa=e.id(+) and a.idgiuong=b.id and b.idphong=c.id and b.id=d.id and a.maql=" + d_Maql.ToString()).Tables[0].Rows)
                    {
                        this.upd_tiengiuong(b_QuanLyGiuongTheoCachTinhKhachSan, s_Mabn, d_MaVaoVien, d_Maql, decimal.Parse(r1["id"].ToString()), int.Parse(r1["dichvu"].ToString()),
                            int.Parse(r1["MaDoiTuong"].ToString()), r1["den"].ToString(), decimal.Parse(r1["idkhoa"].ToString()), r1["makp"].ToString(), int.Parse(r1["userid"].ToString()),
                            dtGiaVienPhi, int.Parse(r1["idgiuong"].ToString()), r1["tu"].ToString(), r1["den"].ToString(), s_BHYT_TuNgay, s_BHYT_DenNgay,
                            i_TuNguyen, s_NgayPTTT, i_LoaiNgayGiuong, d_GiaGiuongCho, d_GiaGiuongSauDe, d_GiaGiuongPTTT1, d_GiaGiuongPTTT2, d_GiaGiuongPTTT3,
                            d_GiaGiuongPTTTDB, ref d_SoNgayGiuongCho, r1["ravien"].ToString() != "5", bKhoaDau);
                        bKhoaDau = false;
                    }
                }
                #endregion
                else
                {
                    if (b_QuanLyGiuongTheoCachTinhBHYT)
                    {
                        bool bTrongngayLayGiaCaoNhat = true;
                        DataTable dt_tmp = new DataTable();
                        string s_Sql = "";

                        dt_tmp = new DataTable();
                        sql = "select a.id,a.mavaovien,to_char(a.tu,'dd/mm/yyyy') as tu," +
                            " to_char(coalesce(a.den,to_date('" + s_Ngayrv.Substring(0, 10) + "','dd/mm/yyyy')),'dd/mm/yyyy') as den,a.dongia,a.idgiuong," +//" to_char(coalesce(a.den,now()),'dd/mm/yyyy') as den,a.dongia,a.idgiuong," +
                          "a.madoituong,c.dichvu, d.chenhlech, a.makp, a.userid, a.idkhoa," +
                          " coalesce(e.ttlucrk,1) as ravien from " + userid + ".theodoigiuong a," + userid + ".dmgiuong b," +
                          userid + ".dmphong c," + userid + ".v_giavp d," + userid + ".xuatkhoa e " +
                          " where a.idkhoa=e.id(+) and a.idgiuong=b.id and b.idphong=c.id and b.id=d.id " +
                          " and a.mavaovien=" + d_MaVaoVien.ToString();
                        if (bThanhtoanNhieudot)
                        {
                            sql += " and (to_date(to_char(den,'dd/mm/yyyy'),'dd/mm/yyyy') >= to_date('" + s_Ngayvv.Substring(0, 10) + "','dd/mm/yyyy') or den is null)";
                            sql += " and to_date(to_char(tu,'dd/mm/yyyy'),'dd/mm/yyyy') <= to_date('" + s_Ngayrv.Substring(0, 10) + "','dd/mm/yyyy') ";
                        }
                        sql += " order by a.tu asc,a.den asc";
                        dt_tmp = get_data(sql).Tables[0];
                        decimal d_ID = 0;
                        if (i_MaDoiTuong == 1)//linh 03012013
                        {
                            DataTable dtBHYT;
                            if (i_loaibenhan != 4)
                            {
                                s_Sql = "select sothe,to_char(tungay,'dd/mm/yyyy') as tungay,to_char(tungay,'yyyymmdd') as tungay_BHYT," +
                                  "to_char(denngay,'dd/mm/yyyy') as denngay,to_char(denngay,'yyyymmdd') as denngay_BHYT from " + userid + ".bhyt where maql =" + d_Maql;
                                dtBHYT = this.get_data(s_Sql).Tables[0];
                            }
                            else
                            {
                                s_Sql = "select sothe,to_char(tungay,'dd/mm/yyyy') as tungay,to_char(tungay,'yyyymmdd') as tungay_BHYT," +
                                 "to_char(denngay,'dd/mm/yyyy') as denngay,to_char(denngay,'yyyymmdd') as denngay_BHYT from xxx.bhyt where maql =" + d_Maql;
                                dtBHYT = this.get_data_mmyy(s_Sql, s_Ngayvv, s_Ngayrv, true).Tables[0];
                            }
                            string s_TuNgay = "";
                            string s_DenNgay = "";
                            bool bKhoaDau = true, bKhoacuoi = false;
                            string idGiuongKhoaCuoi = "", idGiuongKhoaDau = (dt_tmp.Rows.Count > 0) ? dt_tmp.Rows[0]["id"].ToString() : "";

                            bool bVaoRaTrongNgay = dt_tmp.Rows[0]["tu"].ToString().Substring(0, 10) == dt_tmp.Rows[dt_tmp.Rows.Count - 1]["den"].ToString().Substring(0, 10);
                            if (bVaoRaTrongNgay && bTrongngayLayGiaCaoNhat)
                            {
                                foreach (DataRow drck in dt_tmp.Select("", "dongia desc"))//("tu<>den", "id desc"))
                                {
                                    idGiuongKhoaCuoi = drck["id"].ToString();
                                    break;
                                }
                            }
                            else
                            {
                                foreach (DataRow drck in dt_tmp.Select("", "id desc"))//("tu<>den", "id desc"))
                                {
                                    idGiuongKhoaCuoi = drck["id"].ToString();
                                    break;
                                }
                            }

                            string tmp_ngayketthuckhoatruoc = "", tmp_id = "";
                            foreach (DataRow r1 in dt_tmp.Rows)
                            {
                                d_giagiuong = (r1["dongia"].ToString().Trim('0') == "") ? 0 : decimal.Parse(r1["dongia"].ToString());
                                bKhoaDau = idGiuongKhoaDau == r1["id"].ToString();
                                bKhoacuoi = idGiuongKhoaCuoi == r1["id"].ToString();

                                if (d_ID < Convert.ToDecimal(r1["id"]))
                                {
                                    d_ID = Convert.ToDecimal(r1["id"]);
                                    s_TuNgay = r1["tu"].ToString();
                                    s_DenNgay = r1["den"].ToString();
                                    //binh 040113: lay so ngay giuuong nap o phong luu, de tru vao so ngay nam o noi tru
                                    if (bKhoacuoi && r1["tu"].ToString().Substring(0, 10) == r1["den"].ToString().Substring(0, 10) && r1["tu"].ToString().Substring(0, 10) == s_Ngayvv.Substring(0, 10)) i_songaygiuongphongluu = 1;

                                    if (bThanhtoanNhieudot && s_NgayBatdauvaovien.Substring(0, 10) != s_Ngayvv.Substring(0, 10) && SoSanhNgay(s_Ngayvv.Substring(0, 10), s_TuNgay.Substring(0, 10)) >= 0)
                                    {
                                        s_TuNgay = StringToDate(s_Ngayvv.Substring(0, 10)).AddDays(-1).ToString("dd/MM/yyyy");// ngay giao thoi : 31/12- 01/10: tinh them 1 ngay giuong cho the moi
                                    }
                                    if (SoSanhNgay(s_TuNgay, s_DenNgay) > 0)
                                    {
                                        continue;
                                    }
                                    if (tmp_ngayketthuckhoatruoc != "" && s_TuNgay.Substring(0, 10) != tmp_ngayketthuckhoatruoc)
                                    {
                                        s_TuNgay = tmp_ngayketthuckhoatruoc;
                                    }
                                    //bKhoaDau = false;
                                    DateTime dti_Giuong_TuNgay = StringToDate(s_TuNgay);
                                    DateTime dti_Giuong_DenNgay = StringToDate(s_DenNgay);
                                    string s_BHYT_TuNgay_the2 = "", s_BHYT_DenNgay_the2 = "";
                                    DataRow[] rBHYT = dtBHYT.Select("(denngay_bhyt>=" + s_TuNgay.Substring(6, 4) + s_TuNgay.Substring(3, 2) + s_TuNgay.Substring(0, 2) + ")" +
                                        " and (tungay_bhyt<=" + s_DenNgay.Substring(6, 4) + s_DenNgay.Substring(3, 2) + s_DenNgay.Substring(0, 2) + ")");
                                    if (rBHYT.Length > 0)
                                    {
                                        s_BHYT_TuNgay = rBHYT[0]["tungay"].ToString();
                                        s_BHYT_DenNgay = rBHYT[0]["denngay"].ToString();

                                        s_BHYT_TuNgay_the2 = s_BHYT_TuNgay; s_BHYT_DenNgay_the2 = s_BHYT_DenNgay;

                                        DateTime dti_BHYT_TuNgay = StringToDate(s_BHYT_TuNgay);//linh 03012013
                                        DateTime dti_BHYT_DenNgay = StringToDate(s_BHYT_DenNgay);
                                        //bhyt         |-----------------------------|
                                        //giuong   |---------|
                                        if (DateTime.Compare(dti_Giuong_TuNgay, dti_BHYT_TuNgay) < 0 && DateTime.Compare(dti_Giuong_DenNgay, dti_BHYT_DenNgay) <= 0)
                                        {
                                            //Thu phi: tu ngay bat dau cua the - ngay vao khoa
                                            this.upd_tiengiuong(s_Mabn, d_MaVaoVien, d_Maql, decimal.Parse(r1["id"].ToString()), int.Parse(r1["dichvu"].ToString()),
                                             2, s_BHYT_TuNgay, decimal.Parse(r1["idkhoa"].ToString()), r1["makp"].ToString(), int.Parse(r1["userid"].ToString()),
                                             dtGiaVienPhi, int.Parse(r1["idgiuong"].ToString()), s_TuNgay, StringToDate(s_BHYT_TuNgay).ToString("dd/MM/yyyy"), s_BHYT_TuNgay, s_BHYT_DenNgay,
                                             i_TuNguyen, i_LoaiNgayGiuong, ref i_songaygiuongphongluu, bKhoacuoi, bKhoaDau, d_giagiuong);//linh 04012013
                                            //BHYT: ngay ra - ngay bat dau cua the
                                            this.upd_tiengiuong(s_Mabn, d_MaVaoVien, d_Maql, decimal.Parse(r1["id"].ToString()), int.Parse(r1["dichvu"].ToString()),
                                                 int.Parse(r1["MaDoiTuong"].ToString()), s_DenNgay, decimal.Parse(r1["idkhoa"].ToString()), r1["makp"].ToString(), int.Parse(r1["userid"].ToString()),
                                                 dtGiaVienPhi, int.Parse(r1["idgiuong"].ToString()), s_BHYT_TuNgay, s_DenNgay, s_BHYT_TuNgay, s_BHYT_DenNgay,
                                                 i_TuNguyen, i_LoaiNgayGiuong, ref i_songaygiuongphongluu, bKhoacuoi, bKhoaDau, d_giagiuong);

                                        }
                                        //bhyt         |-----------------------------|
                                        //giuong              |---------|
                                        else if (DateTime.Compare(dti_Giuong_TuNgay, dti_BHYT_TuNgay) >= 0 && DateTime.Compare(dti_Giuong_DenNgay, dti_BHYT_DenNgay) <= 0)
                                        {
                                            this.upd_tiengiuong(s_Mabn, d_MaVaoVien, d_Maql, decimal.Parse(r1["id"].ToString()), int.Parse(r1["dichvu"].ToString()),
                                              int.Parse(r1["MaDoiTuong"].ToString()), s_DenNgay, decimal.Parse(r1["idkhoa"].ToString()), r1["makp"].ToString(), int.Parse(r1["userid"].ToString()),
                                              dtGiaVienPhi, int.Parse(r1["idgiuong"].ToString()), s_TuNgay, s_DenNgay, s_BHYT_TuNgay, s_BHYT_DenNgay,
                                              i_TuNguyen, i_LoaiNgayGiuong, ref i_songaygiuongphongluu, bKhoacuoi, bKhoaDau, d_giagiuong);
                                        }
                                        //bhyt         |-----------------------------|
                                        //giuong              |--------------------------|
                                        else if (DateTime.Compare(dti_Giuong_TuNgay, dti_BHYT_TuNgay) >= 0 && DateTime.Compare(dti_Giuong_DenNgay, dti_BHYT_DenNgay) >= 0)
                                        {
                                            //BN 2 the
                                            // the 1: ngay het han the 1 - ngay vao
                                            this.upd_tiengiuong(s_Mabn, d_MaVaoVien, d_Maql, decimal.Parse(r1["id"].ToString()), int.Parse(r1["dichvu"].ToString()),
                                                 int.Parse(r1["MaDoiTuong"].ToString()), s_BHYT_DenNgay, decimal.Parse(r1["idkhoa"].ToString()), r1["makp"].ToString(), int.Parse(r1["userid"].ToString()),
                                                 dtGiaVienPhi, int.Parse(r1["idgiuong"].ToString()), s_TuNgay, s_BHYT_DenNgay, s_BHYT_TuNgay, s_BHYT_DenNgay,
                                                 i_TuNguyen, i_LoaiNgayGiuong, ref i_songaygiuongphongluu, bKhoacuoi, bKhoaDau, d_giagiuong);
                                            //kiem tra bn co 2 the?       
                                            bool bBN2The = false;
                                            string tmp_ngaybatdauthe2 = s_BHYT_DenNgay;
                                            if (dtBHYT.Rows.Count > 1)
                                            {
                                                foreach (DataRow drbh in dtBHYT.Rows)
                                                {
                                                    if (DateTime.Compare(StringToDate(drbh["denngay"].ToString()), StringToDate(s_BHYT_DenNgay)) > 0)
                                                    {
                                                        s_BHYT_TuNgay = drbh["tungay"].ToString();
                                                        s_BHYT_DenNgay = drbh["denngay"].ToString();
                                                        bBN2The = true;
                                                        break;
                                                    }
                                                }
                                            }
                                            //
                                            if (bThanhtoanNhieudot == false)
                                            {
                                                tmp_ngaybatdauthe2 = StringToDate(tmp_ngaybatdauthe2).AddDays(-1).ToString("dd/MM/yyyy");
                                                if (SoSanhNgay(s_DenNgay, s_Ngayrv.Substring(0, 10)) > 0)
                                                {
                                                    s_DenNgay = s_Ngayrv.Substring(0, 10);
                                                }

                                            }

                                            //the 2: ngay ra - ngay het han cua the 1 (vi tru theo ngay bat dau cua the se thieu 1 ngay cù: ngay het the 1 va ngay bat dau the 2, ngay nay tinh cho the moi)
                                            this.upd_tiengiuong(s_Mabn, d_MaVaoVien, d_Maql, decimal.Parse(r1["id"].ToString()), int.Parse(r1["dichvu"].ToString()),
                                                (bBN2The) ? i_MaDoiTuong : 2, s_DenNgay, decimal.Parse(r1["idkhoa"].ToString()), r1["makp"].ToString(), int.Parse(r1["userid"].ToString()),
                                                dtGiaVienPhi, int.Parse(r1["idgiuong"].ToString()), bBN2The ? tmp_ngaybatdauthe2 : StringToDate(s_BHYT_DenNgay).ToString("dd/MM/yyyy"), s_DenNgay, s_BHYT_TuNgay, s_BHYT_DenNgay,
                                             i_TuNguyen, i_LoaiNgayGiuong, ref  i_songaygiuongphongluu, bKhoacuoi, bKhoaDau, d_giagiuong);//linh 04012013
                                        }

                                    }
                                    //bhyt                     |-----------------------------|
                                    //giuong     |------------|
                                    //giuong                                                    |------------|
                                    else
                                    {
                                        this.upd_tiengiuong(s_Mabn, d_MaVaoVien, d_Maql, decimal.Parse(r1["id"].ToString()), int.Parse(r1["dichvu"].ToString()),
                                             2, s_DenNgay, decimal.Parse(r1["idkhoa"].ToString()), r1["makp"].ToString(), int.Parse(r1["userid"].ToString()),
                                             dtGiaVienPhi, int.Parse(r1["idgiuong"].ToString()), s_TuNgay, s_DenNgay, s_BHYT_TuNgay, s_BHYT_DenNgay,
                                             i_TuNguyen, i_LoaiNgayGiuong, ref i_songaygiuongphongluu, bKhoacuoi, bKhoaDau, d_giagiuong);
                                    }
                                }
                                //
                                //

                                tmp_ngayketthuckhoatruoc = (r1["den"].ToString().Trim().Length >= 10) ? r1["den"].ToString().Trim().Substring(0, 10) : "";

                                //
                                //
                            }
                        }
                        else
                        {
                            string s_TuNgay = "";
                            string s_DenNgay = "";
                            bool bKhoaDau = true, bKhoacuoi = false;
                            string idGiuongKhoaCuoi = "", idGiuongKhoaDau = (dt_tmp.Rows.Count > 0) ? dt_tmp.Rows[0]["id"].ToString() : "";
                            bool bVaoRaTrongNgay = dt_tmp.Rows[0]["tu"].ToString().Substring(0, 10) == dt_tmp.Rows[dt_tmp.Rows.Count - 1]["den"].ToString().Substring(0, 10);
                            if (bVaoRaTrongNgay && bTrongngayLayGiaCaoNhat)
                            {
                                foreach (DataRow drck in dt_tmp.Select("", "dongia desc"))//("tu<>den", "id desc"))
                                {
                                    idGiuongKhoaCuoi = drck["id"].ToString();
                                    break;
                                }
                            }
                            else
                            {
                                foreach (DataRow drck in dt_tmp.Select("", "id desc"))//("tu<>den", "id desc"))
                                {
                                    idGiuongKhoaCuoi = drck["id"].ToString();
                                    break;
                                }
                            }
                            string tmp_ngayketthuckhoatruoc = "", tmp_id = "";
                            foreach (DataRow r1 in dt_tmp.Rows)
                            {
                                d_giagiuong = (r1["dongia"].ToString().Trim('0') == "") ? 0 : decimal.Parse(r1["dongia"].ToString());
                                bKhoacuoi = idGiuongKhoaCuoi == r1["id"].ToString();
                                bKhoaDau = idGiuongKhoaDau == r1["id"].ToString();
                                //
                                if (d_ID < Convert.ToDecimal(r1["id"]))
                                {
                                    d_ID = Convert.ToDecimal(r1["id"]);
                                    s_TuNgay = r1["tu"].ToString();
                                    s_DenNgay = r1["den"].ToString();
                                    //binh 040113: lay so ngay giuuong nap o phong luu, de tru vao so ngay nam o noi tru
                                    if (bKhoacuoi && r1["tu"].ToString().Substring(0, 10) == r1["den"].ToString().Substring(0, 10) && r1["tu"].ToString().Substring(0, 10) == s_Ngayvv.Substring(0, 10)) i_songaygiuongphongluu = 1;

                                    if (bThanhtoanNhieudot && s_NgayBatdauvaovien.Substring(0, 10) != s_Ngayvv.Substring(0, 10) && SoSanhNgay(s_Ngayvv.Substring(0, 10), s_TuNgay.Substring(0, 10)) > 0)
                                    {
                                        s_TuNgay = StringToDate(s_Ngayvv.Substring(0, 10)).AddDays(-1).ToString("dd/MM/yyyy");// ngay gia thoi : 31/12- 01/10: tinh them 1 ngay giuong cho the moi
                                    }
                                    if (SoSanhNgay(s_TuNgay, s_DenNgay) > 0)
                                    {
                                        continue;
                                    }
                                    if (tmp_ngayketthuckhoatruoc != "" && s_TuNgay.Substring(0, 10) != tmp_ngayketthuckhoatruoc)
                                    {
                                        s_TuNgay = tmp_ngayketthuckhoatruoc;
                                    }
                                    this.upd_tiengiuong(s_Mabn, d_MaVaoVien, d_Maql, decimal.Parse(r1["id"].ToString()), int.Parse(r1["dichvu"].ToString()),
                           i_MaDoiTuong, s_DenNgay, decimal.Parse(r1["idkhoa"].ToString()), r1["makp"].ToString(), int.Parse(r1["userid"].ToString()),
                           dtGiaVienPhi, int.Parse(r1["idgiuong"].ToString()), s_TuNgay, s_DenNgay, s_TuNgay, s_DenNgay,
                           i_TuNguyen, i_LoaiNgayGiuong, ref i_songaygiuongphongluu, bKhoacuoi, bKhoaDau, d_giagiuong);

                                    tmp_ngayketthuckhoatruoc = (r1["den"].ToString().Trim().Length >= 10) ? r1["den"].ToString().Trim().Substring(0, 10) : "";
                                }
                            }
                        }
                        //}
                    }
                    else
                    {

                        bool bkhoacuoi = false;
                        sql = "select a.id,a.mavaovien,to_char(a.tu,'dd/mm/yyyy hh24:mi') as tu,to_char(coalesce(a.den,now()),'dd/mm/yyyy hh24:mi') as den,a.dongia,a.idgiuong," +
                                                 "a.madoituong,c.dichvu, d.chenhlech, a.makp, a.userid, a.idkhoa,coalesce(e.ttlucrk,1) as ravien from " + userid + ".theodoigiuong a," + userid + ".dmgiuong b," + userid +
                                                 ".dmphong c," + userid + ".v_giavp d," + userid + ".xuatkhoa e where a.idkhoa=e.id(+) and a.idgiuong=b.id and b.idphong=c.id and b.id=d.id and a.maql=" + d_Maql.ToString();
                        sql += " order by to_char(coalesce(a.den,now()),'yyyymmddhh24'), a.id ";
                        DataSet ads1=get_data(sql);
                        if (ads1 != null && ads1.Tables.Count > 0 && ads1.Tables[0].Rows.Count >0)
                        {
                            string aidKhoacuoi = ads1.Tables[0].Rows[ads1.Tables[0].Rows.Count - 1]["id"].ToString();
                            string aNgayraCuoi = ads1.Tables[0].Rows[ads1.Tables[0].Rows.Count - 1]["den"].ToString();
                            foreach (DataRow r1 in ads1.Tables[0].Rows)
                            {
                                bkhoacuoi = r1["id"].ToString() == aidKhoacuoi;
                                if (bkhoacuoi && s_Ngayvv.Length >= 10 && s_Ngayvv.Substring(0, 10) == aNgayraCuoi.Substring(0,10))
                                {
                                    i_songaygiuongphongluu = 1; bkhoacuoi = true;
                                }
                                this.upd_tiengiuong(s_Mabn, d_MaVaoVien, d_Maql, decimal.Parse(r1["id"].ToString()), int.Parse(r1["dichvu"].ToString()),
                                    int.Parse(r1["madoituong"].ToString()), r1["den"].ToString(), decimal.Parse(r1["idkhoa"].ToString()), r1["makp"].ToString(), int.Parse(r1["userid"].ToString()),
                                    dtGiaVienPhi, int.Parse(r1["idgiuong"].ToString()), r1["tu"].ToString(), r1["den"].ToString(), s_BHYT_TuNgay, s_BHYT_DenNgay,
                                    i_TuNguyen, i_LoaiNgayGiuong, ref i_songaygiuongphongluu, bkhoacuoi, true, (r1["dongia"].ToString().Trim().Trim('0') == "") ? 0 : decimal.Parse(r1["dongia"].ToString()));
                            }
                        }
                    }
                }
            }
        }
        //Thuy 22.06.2012 code chuyen data chi nhanh
        #region ChuyenData

        /// <summary>
        /// Thuc thi Query --> tra ve loi: 1: ket noi loi; 2: cau sql loi
        /// </summary>
        /// <param name="sql1"></param>
        /// <param name="sconn"></param>
        /// <returns></returns>
        public int execute_sql(string sql1, string str_conn)
        {
            int i_error = 0;

            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(str_conn);
            try
            {
                con.Open();
            }
            catch
            {
                i_error = 1;
                return i_error;
            }
            cmd = new NpgsqlCommand(sql1, con);
            cmd.CommandType = CommandType.Text;
            try
            {
                cmd.ExecuteNonQuery();
                cmd.Dispose();
                con.Close(); con.Dispose();
                i_error = 0;

            }
            catch (NpgsqlException ex)
            {

                i_error = 2;
            }
            finally
            {
                con.Close();
                con.Dispose();
            }
            return i_error;
        }

        public DataSet get_data_con(string asql, string Sconnecting)
        {
            if (Sconnecting == "") Sconnecting = sConn;
            DataSet ds1 = new DataSet();
            try
            {
                if (ds1 != null)
                {
                    ds1.Dispose();
                    ds1 = null;
                }
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                ds1 = new DataSet();
                con = new NpgsqlConnection(Sconnecting);
                con.Open();
                asql = asql.Replace("medibv.", user + ".");
                cmd = new NpgsqlCommand(asql, con);
                cmd.CommandType = CommandType.Text;
                dest = new NpgsqlDataAdapter(cmd);
                dest.Fill(ds1);
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
            catch (NpgsqlException ex)
            {
                //upd_error(asql + "-" + ex.Message.ToString().Trim(), sComputer, "?");
            }
            return ds1;
        }
        public string GetConnString(string s_host_nguon, string s_port_nguon, string s_DatabaseName_nguon)
        {

            //System.Windows.Forms.ToolTip tooltip = new ToolTip();
            string strConn_nguon = "Server=0.0.0.0;Port=5432;User Id=medisoft;Password=links1920;Database=medisoft2007;Encoding=UNICODE;Pooling=true;";
            strConn_nguon = "Server=" + s_host_nguon + ";Port=" + s_port_nguon + ";User Id=medisoft;Password=links1920;Database=" + s_DatabaseName_nguon + ";Encoding=UNICODE;Pooling=true;";

            return strConn_nguon;
        }

        public int GetIDClient(string s_host, string s_port, string s_DatabaseName)
        {
            int i_id = 11;
            string asql = "select id from medibv.client where host='" + s_host + "',port='" + s_port + "' and databasename='" + s_DatabaseName + "'";
            DataSet lds = get_data(asql);
            if (lds == null || lds.Tables.Count <= 0 || lds.Tables[0].Rows.Count <= 0)
            {
                //them moi
                i_id = GetMaxIDClient();
                LuuClient(s_host, s_port, s_DatabaseName, i_id);
            }
            else
            {
                i_id = int.Parse(lds.Tables[0].Rows[0]["id"].ToString());
            }
            return i_id;
        }
        public int GetMaxIDClient()
        {
            int i_id = 11;
            string asql = "select max(id)+1 as id from medibv.client where id>10 ";
            DataSet lds = get_data(asql);
            if (lds == null || lds.Tables.Count <= 0 || lds.Tables[0].Rows.Count <= 0)
            {
                i_id = 11;
            }
            else
            {
                i_id = (lds.Tables[0].Rows[0]["id"].ToString() == "") ? 11 : int.Parse(lds.Tables[0].Rows[0]["id"].ToString());
            }
            return i_id;
        }
        public bool LuuClient(string s_host, string s_port, string s_DatabaseName, int i_id)
        {
            sql = "update medibv.client set host='" + s_host + "',port='" + s_port + "',databasename='" + s_DatabaseName + "' where id=" + i_id;
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into medibv.client(id,host,port,databasename)";
                    sql += " values (" + i_id + ",'" + s_host + "','" + s_port + "','" + s_DatabaseName + "')";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {

                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }

        public void KiemTraCauTruc_CN(string aschema, string atablename, string dbname_nguon, string dbname_dich, string s_connnguon, string s_connDich)
        {
            DataSet dsnguon;
            DataSet dsdich;

            string asql = "";
            asql = " select table_schema as a1, table_name as a2, column_name as a3, 'alter table '||table_schema||'.'||table_name ||' add '||column_name||' '|| data_type ||' '|| case when trim(numeric_precision)='' or numeric_precision is null then '' else '('||numeric_precision||')' end ||case when column_default is null then '' else ' default '||column_default||';' end as sql, to_number('0') as khac ";
            asql += " from information_schema.columns  where table_catalog='" + dbname_nguon + "' AND table_schema='" + aschema + "' and table_name ='" + atablename + "' and data_type<>'character varying' ";
            asql += " UNION ALL ";
            asql += " select table_schema as a1, table_name as a2, column_name as a3, 'alter table '||table_schema||'.'||table_name ||' add '||column_name||' '|| data_type ||' ('|| character_maximum_length||')'||';' as sql , to_number('0') as khac ";
            asql += " from information_schema.columns  where table_catalog='" + dbname_nguon + "' AND table_schema='" + aschema + "' and table_name ='" + atablename + "' and data_type='character varying' ";
            dsnguon = get_data_con(asql, s_connnguon);
            //            
            asql = " select table_schema as a1, table_name as a2, column_name as a3, 'alter table '||table_schema||'.'||table_name ||' add '||column_name||' '|| data_type ||' '|| case when trim(numeric_precision)='' or numeric_precision is null then '' else '('||numeric_precision||')' end ||case when column_default is null then '' else ' default '||column_default||';' end as sql, to_number('0') as khac ";
            asql += " from information_schema.columns  where table_catalog='" + dbname_dich + "' AND table_schema='" + aschema + "' and table_name ='" + atablename + "' and data_type<>'character varying' ";
            asql += " UNION ALL ";
            asql += " select table_schema as a1, table_name as a2, column_name as a3, 'alter table '||table_schema||'.'||table_name ||' add '||column_name||' '|| data_type ||' ('|| character_maximum_length||')'||';' as sql , to_number('0') as khac ";
            asql += " from information_schema.columns  where table_catalog='" + dbname_dich + "' AND table_schema='" + aschema + "' and table_name ='" + atablename + "' and data_type='character varying' ";
            if (s_connDich != "") dsdich = get_data_con(asql, s_connDich);
            else dsdich = get_data(asql);

            string s_exp = "";
            DataRow dr1;
            int iCount = 0, iStt = 0, iKhac = 0;
            //neu server nguon khac dich --> tao ben dich
            foreach (DataRow dr in dsnguon.Tables[0].Rows)
            {
                iStt += 1;
                s_exp = "a2='" + dr["a2"].ToString() + "' and a3='" + dr["a3"].ToString() + "'";
                dr1 = getrowbyid(dsdich.Tables[0], s_exp);
                if (dr1 == null)
                {
                    asql = dr["sql"].ToString();
                    execute_data(asql, s_connDich);
                    iKhac += 1;
                }
            }
            //neu ben dich khac nguon --> tao nguon
            foreach (DataRow dr in dsdich.Tables[0].Rows)
            {
                iStt += 1;
                s_exp = "a2='" + dr["a2"].ToString() + "' and a3='" + dr["a3"].ToString() + "'";
                dr1 = getrowbyid(dsnguon.Tables[0], s_exp);
                if (dr1 == null)
                {
                    asql = dr["sql"].ToString();
                    execute_sql(asql, s_connnguon);
                    iKhac += 1;
                }
            }

        }
        public void update(string s_host_nguon, string s_port_nguon, string s_DatabaseName_nguon, string s_host_dich, string s_port_dich, string s_DatabaseName_dich, string schema, string tablename, int i_idChiNhanhDich, ref string s_HostErrorConnection, string s_dieukien, bool bAddFieldChuyendi, System.Windows.Forms.Label lbStatus)
        {
            try
            {

                //System.Windows.Forms.ToolTip tooltip = new ToolTip();
                string strConn_nguon = "Server=0.0.0.0;Port=5432;User Id=medisoft;Password=links1920;Database=medisoft2007;Encoding=UNICODE;Pooling=true;";
                strConn_nguon = "Server=" + s_host_nguon + ";Port=" + s_port_nguon + ";User Id=medisoft;Password=links1920;Database=" + s_DatabaseName_nguon + ";Encoding=UNICODE;Pooling=true;";
                //
                string strConn_Dich = "Server=0.0.0.0;Port=5432;User Id=medisoft;Password=links1920;Database=medisoft2007;Encoding=UNICODE;Pooling=true;";
                strConn_Dich = "Server=" + s_host_dich + ";Port=" + s_port_dich + ";User Id=medisoft;Password=links1920;Database=" + s_DatabaseName_dich + ";Encoding=UNICODE;Pooling=true;";
                //

                string s_select = "";//field nay part kieu date thanh kieu character
                string s_insert = "insert into " + schema + "." + tablename + "(";//menh de insert
                string s_update = "update " + schema + "." + tablename + " set ";//menh de update
                string s_value_insert = " (";//value cua menh de insert
                string s_dk_update = "";// dieu kien udpdate
                string s_para_update = "", s_para_update_dk = "";
                //
                if (bAddFieldChuyendi)
                {
                    string asql2 = "alter table " + schema + "." + tablename + " add chuyendi varchar(300) default lpad('0',300,'0')";
                    string asql1 = "";
                    asql1 = "select chuyendi from  " + schema + "." + tablename + " where 1=2";

                    DataSet ldscd = get_data_con(asql1, strConn_nguon);
                    if (ldscd == null || ldscd.Tables.Count <= 0)
                    {
                        execute_sql(asql2, strConn_nguon);
                    }
                    ldscd = get_data_con(asql1, strConn_Dich);
                    if (ldscd == null || ldscd.Tables.Count <= 0)
                    {
                        execute_sql(asql2, strConn_Dich);
                    }
                }
                //
                #region build_sql
                string s_sql = "select lower(a.column_name) as column_name,lower(a.data_type) as data_type,case when b.position_in_unique_constraint is not null then '' else b.constraint_name end as key,b.ordinal_position as stt " +
                " from information_schema.columns a,information_schema.key_column_usage b where a.table_schema=b.table_schema(+) " +
                " and a.table_name=b.table_name(+) and a.column_name=b.column_name(+) and lower(a.column_name) not in('oid')" +//and lower(a.column_name) not in('ngayud') 
                 " and a.table_schema='" + schema.ToLower() + "' and a.table_name='" + tablename.ToLower() + "'";
                string s_column_name = "", s_data_type = "", s_keys = "";
                DataSet dstmp = new DataSet();
                dstmp = get_data_con(s_sql, strConn_nguon);
                string tmp_column = ",";
                foreach (DataRow row in dstmp.Tables[0].Select("", "key desc, column_name"))
                {
                    s_column_name = row["column_name"].ToString();
                    if (tmp_column.IndexOf("," + s_column_name + ",") >= 0) continue;//binh 100212
                    else
                    {
                        tmp_column += s_column_name + ",";//binh 100212
                    }
                    //
                    //if (s_column_name == row["column_name"].ToString()) continue;////binh 100212 comment                    
                    s_data_type = row["data_type"].ToString();
                    s_keys = row["key"].ToString();
                    s_insert += s_column_name + ",";
                    if (s_data_type.IndexOf("timestamp") > -1)
                    {
                        s_select += "to_char(" + s_column_name + ",'dd/mm/yyyy hh24:mi') as " + s_column_name + ",";
                        s_value_insert += "to_date(:" + s_column_name + ",'dd/mm/yyyy hh24:mi')" + ",";
                    }
                    else if (s_data_type.IndexOf("date") > -1)
                    {
                        s_select += "to_char(" + s_column_name + ",'dd/mm/yyyy') as " + s_column_name + ",";
                        s_value_insert += "to_date(:" + s_column_name + ",'dd/mm/yyyy')" + ",";
                    }
                    else if (s_data_type.IndexOf("character") > -1 || s_data_type.IndexOf("text") > -1)
                    {
                        s_select += s_column_name + ",";
                        s_value_insert += ":" + s_column_name + ",";
                    }//
                    else if (s_data_type.IndexOf("numeric") > -1)
                    {
                        s_select += " coalesce(" + s_column_name + ",0) as " + s_column_name + ",";
                        s_value_insert += ":" + s_column_name + ",";
                    }//numeric
                    else
                    {
                        s_select += s_column_name + ",";
                        s_value_insert += ":" + s_column_name + ",";
                    }
                    if (s_keys != "")
                    {
                        s_dk_update += s_dk_update == "" ? "" : " and ";
                        s_para_update_dk += s_column_name + ",";
                        if (s_data_type.IndexOf("timestamp") > -1)
                        {
                            s_dk_update += " to_char(" + s_column_name + ",'dd/mm/yyyy hh24:mi')=:" + s_column_name;// +",";
                        }
                        else if (s_data_type.IndexOf("date") > -1)
                        {
                            s_dk_update += " to_char(" + s_column_name + ",'dd/mm/yyyy')=:" + s_column_name;// +",";
                        }
                        else if (s_data_type.IndexOf("character") > -1 || s_data_type.IndexOf("text") > -1)
                        {
                            s_dk_update += s_column_name + "=:" + s_column_name + "";// ",";//binh 110112: bo dau ,
                        }
                        else
                        {
                            s_dk_update += s_column_name + "=:" + s_column_name + "";// ",";
                        }
                    }
                    else
                    {
                        s_para_update += s_column_name + ",";
                        if (s_data_type.IndexOf("timestamp") > -1)
                        {
                            s_update += s_column_name + "=to_date(:" + s_column_name + ",'dd/mm/yyyy hh24:mi')" + ",";
                        }
                        else if (s_data_type.IndexOf("date") > -1)
                        {
                            s_update += s_column_name + "=to_date(:" + s_column_name + ",'dd/mm/yyyy')" + ",";
                        }
                        else if (s_data_type.IndexOf("character") > -1 || s_data_type.IndexOf("text") > -1)
                        {
                            s_update += s_column_name + "=:" + s_column_name + ",";
                        }
                        else
                        {
                            s_update += s_column_name + "=:" + s_column_name + ",";
                        }
                    }
                }

                dstmp.Dispose();
                #endregion
                s_select = s_select.Trim(',');
                s_update = s_update.Trim(',');
                s_dk_update = s_dk_update.Trim(',');
                s_para_update_dk = s_para_update_dk.Trim(',');
                s_insert = s_insert.Trim(',') + ")";
                s_value_insert = s_value_insert.Trim(',') + ")";
                s_para_update = s_para_update.Trim(',') + "," + s_para_update_dk;
                #region xu ly client
                int iOK = execute_sql("update " + schema + "." + tablename + " set chuyendi=lpad('0',300,'0') where (chuyendi is null or chuyendi='')" + s_dieukien, strConn_nguon);
                if (iOK == 2) return;//loi khi ket noi client: exit
                else if (iOK == 1)
                {
                    s_HostErrorConnection = s_host_nguon;
                    return;
                }
                int i_stt = i_idChiNhanhDich * 3 - 2;//id_chinhanh*3 -2
                int i_index = i_stt - 1;
                s_sql = "update " + schema + "." + tablename + " set " +
                    " chuyendi=coalesce(substr(chuyendi,1," + i_index + "),'')||'www'||substr(chuyendi," + ((int)(i_stt + 3)).ToString() + ") " +
                    " where substr(chuyendi," + i_stt + ",3)='000'" + s_dieukien.Replace("xxx.", schema + ".");
                execute_data(s_sql, strConn_nguon);

                DataTable data = new DataTable();
                string asql_data = "select " + s_select + " from " + schema + "." + tablename + " where substr(chuyendi," + i_stt + ",3)='www' " + s_dieukien;
                asql_data = asql_data.Replace("xxx.", schema + ".");
                lbStatus.Text = "Get data: " + tablename + "....";
                data = get_data_con(asql_data, strConn_nguon).Tables[0];
                #endregion
                #region chuyen ve may local
                string _update = s_update + " where " + s_dk_update;
                string _insert = s_insert + " values " + s_value_insert;
                NpgsqlConnection con_dich = new NpgsqlConnection(strConn_Dich);
                con_dich.Open();
                NpgsqlConnection con_nguon = new NpgsqlConnection(strConn_nguon);
                con_nguon.Open();
                int i_count = data.Rows.Count;
                int i_recs = 0;
                foreach (DataRow rSave in data.Rows)
                {
                    System.Windows.Forms.Application.DoEvents();
                    try
                    {
                        i_recs++;
                        lbStatus.Text = tablename + " - " + i_recs.ToString() + "/" + i_count.ToString();
                        cmd = new NpgsqlCommand(_update, con_dich);
                        cmd.CommandType = CommandType.Text;
                        foreach (string s_col in s_para_update.Trim(',').Split(','))
                        {
                            string s_val = rSave[s_col].ToString();
                            if (s_col.ToLower() == "chuyendi") { s_val = s_val.Substring(0, i_index) + "111" + s_val.Substring(i_index + 3); } //if (s_col.ToLower() == "chuyendi") { s_val = s_val.Substring(0, i_index) + "111" + s_val.Substring(i_index + 3); }
                            if (s_val == "") s_val = null;
                            cmd.Parameters.Add(s_col, s_val);
                        }
                        int i = cmd.ExecuteNonQuery();
                        string s_text = "";
                        if (i == 0)
                        {
                            cmd = new NpgsqlCommand(_insert, con_dich);
                            cmd.CommandType = CommandType.Text;
                            foreach (DataColumn col in data.Columns)
                            {
                                string s_val = rSave[col.ColumnName].ToString();
                                if (col.ColumnName.ToLower() == "chuyendi") { s_val = s_val.Substring(0, i_index) + "111" + s_val.Substring(i_index + 3); } //if (col.ColumnName.ToLower() == "chuyendi") { s_val = s_val.Substring(0, i_index) + "111" + s_val.Substring(i_index + 3); }
                                else { s_text += s_val + ","; }
                                if (s_val == "") s_val = null;
                                cmd.Parameters.Add(col.ColumnName, s_val);
                            }
                            cmd.ExecuteNonQuery();
                            s_text = s_text.Trim(',') + "\n";

                        }
                        //tooltip.SetToolTip(text, prostatus.Value.ToString() + "/" + i_count.ToString());
                        s_sql = "update " + schema + "." + tablename + " set chuyendi=coalesce(substr(chuyendi,1," + i_index.ToString() + "),'')||'111'||substr(chuyendi," + ((int)(i_stt + 3)).ToString() + ") where substr(chuyendi," + i_stt + ",3)='www' and " + s_dk_update;
                        cmd.Dispose();
                        cmd = new NpgsqlCommand(s_sql, con_nguon);
                        cmd.CommandType = CommandType.Text;
                        foreach (string s_col in s_para_update_dk.Trim(',').Split(','))
                        {
                            cmd.Parameters.Add(s_col, rSave[s_col].ToString());
                        }
                        cmd.ExecuteNonQuery();
                        System.Windows.Forms.Application.DoEvents();
                    }
                    catch (Exception ex)
                    {
                        string s = ex.ToString();
                        if (ex.ToString().IndexOf("No connection could be made") >= 0)
                        {
                            s_HostErrorConnection = s_host_dich;
                            break;
                        }
                        //upd_Events(DateTime.Now.ToString("dd/MM/yyyy"), DateTime.Now.ToString("hh:mm"), c_client.Host + "^" + c_client.DatabaseName, rSave[0].ToString(), "", schema, tablename, "", s, System.Environment.MachineName.ToUpper(), "");

                    }
                    finally
                    {
                        cmd.Dispose();
                    }
                }
                #endregion
                data.Dispose();
                con_nguon.Close();
                con_nguon.Dispose();
                con_dich.Close();
                con_dich.Dispose();
            }
            catch (Exception er)
            {
                upd_error(sql + " - " + er.ToString(), System.Environment.MachineName, tablename);
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
        }

        public void update_dblink(string s_host_nguon, string s_port_nguon, string s_DatabaseName_nguon, string schema, string tablename, int i_idChiNhanhDich, ref string s_HostErrorConnection, string s_dieukien, System.Windows.Forms.Label lbStatus, string a_database_link)
        {
            try
            {
                a_database_link = "@" + a_database_link.Trim().Trim('@');
                //System.Windows.Forms.ToolTip tooltip = new ToolTip();
                string strConn_nguon = "Server=0.0.0.0;Port=5432;User Id=medisoft;Password=links1920;Database=medisoft2007;Encoding=UNICODE;Pooling=true;";
                strConn_nguon = "Server=" + s_host_nguon + ";Port=" + s_port_nguon + ";User Id=medisoft;Password=links1920;Database=" + s_DatabaseName_nguon + ";Encoding=UNICODE;Pooling=true;";
                //
                //string strConn_Dich = "Server=0.0.0.0;Port=5432;User Id=medisoft;Password=links1920;Database=medisoft2007;Encoding=UNICODE;Pooling=true;";
                //strConn_Dich = "Server=" + s_host_dich + ";Port=" + s_port_dich + ";User Id=medisoft;Password=links1920;Database=" + s_DatabaseName_dich + ";Encoding=UNICODE;Pooling=true;";
                //

                string s_select = "";//field nay part kieu date thanh kieu character
                string s_insert = "insert into " + schema + "." + tablename.Trim() + a_database_link + "(";//menh de insert
                string s_update = "update " + schema + "." + tablename.Trim() + a_database_link + " set ";//menh de update
                string s_value_insert = " (";//value cua menh de insert
                string s_dk_update = "";// dieu kien udpdate
                string s_para_update = "", s_para_update_dk = "";

                #region build_sql
                string s_sql = "select lower(a.column_name) as column_name,lower(a.data_type) as data_type,case when b.position_in_unique_constraint is not null then '' else b.constraint_name end as key,b.ordinal_position as stt " +
                " from information_schema.columns a,information_schema.key_column_usage b where a.table_schema=b.table_schema(+) " +
                " and a.table_name=b.table_name(+) and a.column_name=b.column_name(+) and lower(a.column_name) not in('oid')" +//and lower(a.column_name) not in('ngayud') 
                 " and a.table_schema='" + schema.ToLower() + "' and a.table_name='" + tablename.ToLower() + "'";
                string s_column_name = "", s_data_type = "", s_keys = "";
                DataSet dstmp = new DataSet();
                dstmp = get_data_con(s_sql, strConn_nguon);
                string tmp_column = ",";
                foreach (DataRow row in dstmp.Tables[0].Select("", "key desc, column_name"))
                {
                    s_column_name = row["column_name"].ToString();
                    if (tmp_column.IndexOf("," + s_column_name + ",") >= 0) continue;//binh 100212
                    else
                    {
                        tmp_column += s_column_name + ",";//binh 100212
                    }
                    //
                    //if (s_column_name == row["column_name"].ToString()) continue;////binh 100212 comment                    
                    s_data_type = row["data_type"].ToString();
                    s_keys = row["key"].ToString();
                    s_insert += s_column_name + ",";
                    if (s_data_type.IndexOf("timestamp") > -1)
                    {
                        s_select += "to_char(" + s_column_name + ",'dd/mm/yyyy hh24:mi') as " + s_column_name + ",";
                        s_value_insert += "to_date(:" + s_column_name + ",'dd/mm/yyyy hh24:mi')" + ",";
                    }
                    else if (s_data_type.IndexOf("date") > -1)
                    {
                        s_select += "to_char(" + s_column_name + ",'dd/mm/yyyy') as " + s_column_name + ",";
                        s_value_insert += "to_date(:" + s_column_name + ",'dd/mm/yyyy')" + ",";
                    }
                    else if (s_data_type.IndexOf("character") > -1 || s_data_type.IndexOf("text") > -1)
                    {
                        s_select += s_column_name + ",";
                        s_value_insert += ":" + s_column_name + ",";
                    }//
                    else if (s_data_type.IndexOf("numeric") > -1)
                    {
                        s_select += " coalesce(" + s_column_name + ",0) as " + s_column_name + ",";
                        s_value_insert += ":" + s_column_name + ",";
                    }//numeric
                    else
                    {
                        s_select += s_column_name + ",";
                        s_value_insert += ":" + s_column_name + ",";
                    }
                    if (s_keys != "")
                    {
                        s_dk_update += s_dk_update == "" ? "" : " and ";
                        s_para_update_dk += s_column_name + ",";
                        if (s_data_type.IndexOf("timestamp") > -1)
                        {
                            s_dk_update += " to_char(" + s_column_name + ",'dd/mm/yyyy hh24:mi')=:" + s_column_name;// +",";
                        }
                        else if (s_data_type.IndexOf("date") > -1)
                        {
                            s_dk_update += " to_char(" + s_column_name + ",'dd/mm/yyyy')=:" + s_column_name;// +",";
                        }
                        else if (s_data_type.IndexOf("character") > -1 || s_data_type.IndexOf("text") > -1)
                        {
                            s_dk_update += s_column_name + "=:" + s_column_name + "";// ",";//binh 110112: bo dau ,
                        }
                        else
                        {
                            s_dk_update += s_column_name + "=:" + s_column_name + "";// ",";
                        }
                    }
                    else
                    {
                        s_para_update += s_column_name + ",";
                        if (s_data_type.IndexOf("timestamp") > -1)
                        {
                            s_update += s_column_name + "=to_date(:" + s_column_name + ",'dd/mm/yyyy hh24:mi')" + ",";
                        }
                        else if (s_data_type.IndexOf("date") > -1)
                        {
                            s_update += s_column_name + "=to_date(:" + s_column_name + ",'dd/mm/yyyy')" + ",";
                        }
                        else if (s_data_type.IndexOf("character") > -1 || s_data_type.IndexOf("text") > -1)
                        {
                            s_update += s_column_name + "=:" + s_column_name + ",";
                        }
                        else
                        {
                            s_update += s_column_name + "=:" + s_column_name + ",";
                        }
                    }
                }

                dstmp.Dispose();
                #endregion
                s_select = s_select.Trim(',');
                s_update = s_update.Trim(',');
                s_dk_update = s_dk_update.Trim(',');
                s_para_update_dk = s_para_update_dk.Trim(',');
                s_insert = s_insert.Trim(',') + ")";
                s_value_insert = s_value_insert.Trim(',') + ")";
                s_para_update = s_para_update.Trim(',') + "," + s_para_update_dk;
                #region xu ly client
                int iOK = execute_sql("update " + schema + "." + tablename + " set chuyendi=lpad('0',300,'0') where (chuyendi is null or chuyendi='')" + s_dieukien, strConn_nguon);
                if (iOK == 2) return;//loi khi ket noi client: exit
                else if (iOK == 1)
                {
                    s_HostErrorConnection = s_host_nguon;
                    return;
                }
                int i_stt = i_idChiNhanhDich * 3 - 2;//id_chinhanh*3 -2
                int i_index = i_stt - 1;
                s_sql = "update " + schema + "." + tablename + " set " +
                    " chuyendi=coalesce(substr(chuyendi,1," + i_index + "),'')||'www'||substr(chuyendi," + ((int)(i_stt + 3)).ToString() + ") " +
                    " where substr(chuyendi," + i_stt + ",3)='000'" + s_dieukien.Replace("xxx.", schema + ".");
                execute_data(s_sql, strConn_nguon);

                DataTable data = new DataTable();
                string asql_data = "select " + s_select + " from " + schema + "." + tablename + " where substr(chuyendi," + i_stt + ",3)='www' " + s_dieukien;
                asql_data = asql_data.Replace("xxx.", schema + ".");
                lbStatus.Text = "Get data: " + tablename + "....";
                data = get_data_con(asql_data, strConn_nguon).Tables[0];
                #endregion
                #region chuyen ve may local
                string _update = s_update + " where " + s_dk_update;
                string _insert = s_insert + " values " + s_value_insert;
                //NpgsqlConnection con_dich = new NpgsqlConnection(strConn_Dich);
                //con_dich.Open();
                NpgsqlConnection con_nguon = new NpgsqlConnection(strConn_nguon);
                con_nguon.Open();
                int i_count = data.Rows.Count;
                int i_recs = 0;
                foreach (DataRow rSave in data.Rows)
                {
                    System.Windows.Forms.Application.DoEvents();
                    try
                    {
                        i_recs++;
                        lbStatus.Text = tablename + " - " + i_recs.ToString() + "/" + i_count.ToString();
                        cmd = new NpgsqlCommand(_update, con_nguon);//dung dblink --> nen lay tu nguồn
                        cmd.CommandType = CommandType.Text;
                        foreach (string s_col in s_para_update.Trim(',').Split(','))
                        {
                            string s_val = rSave[s_col].ToString();
                            if (s_col.ToLower() == "chuyendi") { s_val = s_val.Substring(0, i_index) + "111" + s_val.Substring(i_index + 3); } //if (s_col.ToLower() == "chuyendi") { s_val = s_val.Substring(0, i_index) + "111" + s_val.Substring(i_index + 3); }
                            if (s_val == "") s_val = null;
                            cmd.Parameters.Add(s_col, s_val);
                        }
                        int i = cmd.ExecuteNonQuery();
                        string s_text = "";
                        if (i == 0)
                        {
                            cmd = new NpgsqlCommand(_insert, con_nguon);
                            cmd.CommandType = CommandType.Text;
                            foreach (DataColumn col in data.Columns)
                            {
                                string s_val = rSave[col.ColumnName].ToString();
                                if (col.ColumnName.ToLower() == "chuyendi") { s_val = s_val.Substring(0, i_index) + "111" + s_val.Substring(i_index + 3); } //if (col.ColumnName.ToLower() == "chuyendi") { s_val = s_val.Substring(0, i_index) + "111" + s_val.Substring(i_index + 3); }
                                if (s_val == "") s_val = null;
                                else { s_text += s_val + ","; }
                                cmd.Parameters.Add(col.ColumnName, s_val);
                            }
                            cmd.ExecuteNonQuery();
                            s_text = s_text.Trim(',') + "\n";

                        }
                        //tooltip.SetToolTip(text, prostatus.Value.ToString() + "/" + i_count.ToString());
                        s_sql = "update " + schema + "." + tablename + " set chuyendi=coalesce(substr(chuyendi,1," + i_index.ToString() + "),'')||'111'||substr(chuyendi," + ((int)(i_stt + 3)).ToString() + ") where substr(chuyendi," + i_stt + ",3)='www' and " + s_dk_update;
                        cmd.Dispose();
                        cmd = new NpgsqlCommand(s_sql, con_nguon);
                        cmd.CommandType = CommandType.Text;
                        foreach (string s_col in s_para_update_dk.Trim(',').Split(','))
                        {
                            cmd.Parameters.Add(s_col, rSave[s_col].ToString());
                        }
                        cmd.ExecuteNonQuery();
                        System.Windows.Forms.Application.DoEvents();
                    }
                    catch (Exception ex)
                    {
                        string s = ex.ToString();
                        if (ex.ToString().IndexOf("No connection could be made") >= 0)
                        {
                            //s_HostErrorConnection = s_host_dich;
                            break;
                        }
                        //upd_Events(DateTime.Now.ToString("dd/MM/yyyy"), DateTime.Now.ToString("hh:mm"), c_client.Host + "^" + c_client.DatabaseName, rSave[0].ToString(), "", schema, tablename, "", s, System.Environment.MachineName.ToUpper(), "");

                    }
                    finally
                    {
                        cmd.Dispose();
                    }
                }
                #endregion
                data.Dispose();
                con_nguon.Close();
                con_nguon.Dispose();
                //con_dich.Close();
                //con_dich.Dispose();
            }
            catch (Exception er)
            {
                upd_error(sql + " - " + er.ToString(), System.Environment.MachineName, tablename);

            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
        }
        #endregion

        string get_date_partition_start(string s_MMYY)
        {
            string s_NgayTemp = "01/" + s_MMYY.Substring(0, 2) + "/20" + s_MMYY.Substring(2);
            DateTime dtNgayTemp = StringToDate(s_NgayTemp);
            return dtNgayTemp.ToString("MM-dd-yyyy");
        }

        string get_date_partition_end(string s_MMYY)
        {
            int i_Thang = int.Parse(s_MMYY.Substring(0, 2));
            int i_Nam = int.Parse("20" + s_MMYY.Substring(2));
            int i_SoNgay = DateTime.DaysInMonth(i_Nam, i_Thang);
            string s_NgayTemp = i_SoNgay.ToString().PadLeft(2,'0') + "/" + i_Thang.ToString().PadLeft(2,'0') + "/" + i_Nam.ToString();
            DateTime dtNgayTemp = StringToDate(s_NgayTemp);
            dtNgayTemp = dtNgayTemp.AddDays(1);
            return dtNgayTemp.ToString("MM-dd-yyyy");
        }
        public void Tao_Table(string mmyy)
        {
            string usr = userid;//linh 23102012
            string s_sql = "CREATE OR REPLACE FUNCTION " + userid + ".khongdau(s_Text text)\n" +
                     "RETURNS varchar AS\n" +
                   "$BODY$\n" +
                   "DECLARE\n" +
                       "sCoDau VARCHAR;  sKhongDau VARCHAR; sVal varchar; sTemp varchar;\n" +
                       "iIndex integer;\n" +
                    "begin\n" +
                       "sCoDau := 'AÁÀẢÃẠÂẤẦẨẪẬĂẮẰẲẴẶEÉÈẺẼẸÊẾỀỂỄỆOÓÒỎÕỌÔỐỒỔỖỘƠỚỜỞỠỢUÚÙỦŨỤƯỨỪỬỮỰIÍÌỈĨỊYÝỲỶỸỴDĐaáàảãạâấầẩẫậăắằẳẵặeéèẻẽẹêếềểễệoóòỏõọôốồổỗộơớờởỡợuúùủũụưứừửữựiíìỉĩịyýỳỷỹỵdđBCFGHJKLMNPQRSTUVXYZbcfghjklmnpqrstuvxyz';\n" +
                       "sKhongDau := 'AAAAAAAAAAAAAAAAAAEEEEEEEEEEEEOOOOOOOOOOOOOOOOOOUUUUUUUUUUUUIIIIIIYYYYYYDDaaaaaaaaaaaaaaaaaaeeeeeeeeeeeeoooooooooooooooooouuuuuuuuuuuuiiiiiiyyyyyyddBCFGHJKLMNPQRSTUVXYZbcfghjklmnpqrstuvxyz';\n" +
                       "sVal := '';\n" +
                       "iIndex := 0;\n" +
                       "for i in 1..length(s_Text)\n" +
                       "loop\n" +
                       "sTemp := substr(s_Text,i,1);\n" +
                       "iIndex := strpos(sCoDau,sTemp);\n" +
                       "if iIndex > 0 then\n" +
                           "sTemp := substr(sKhongDau,iIndex,1);\n" +
                       "end if;\n" +
                       "sVal := sVal||sTemp;\n" +
                       "end loop;\n" +
                       "return replace(sVal,' ','');\n" +
                   "end;\n" +
                   "$BODY$\n" +
                     "LANGUAGE 'plpgsql' VOLATILE;\n" +
                   "ALTER FUNCTION medibv.khongdau(text) OWNER TO medisoft;\n";
            this.execute(s_sql);
            s_sql = "CREATE or replace TRIGGER tri_btdbn_hotenkhongdau\n" +
                    "after insert ON " + userid + ".btdbn FOR EACH ROW\n" +
                    "begin\n" +
                    "if trim(new.hotenkdau)='' or new.hotenkdau is null then update " + userid + ".btdbn set hotenkdau=(select " + userid + ".khongdau(hoten)) " +
                    " where trim(hotenkdau)='' or hotenkdau is null;\n" +
                    "end if;\n" +
                    "end;";
            this.execute(s_sql);
            s_sql = "update " + userid + ".btdbn set hotenkdau=(select " + userid + ".khongdau(hoten)) " +
                    " where trim(hotenkdau)='' or hotenkdau is null;";
            this.execute(s_sql);
            this.execute("drop trigger tri_theodoigiuong");
            s_sql = "CREATE TABLE " + usr + ".v_tamung(id numeric NOT NULL DEFAULT 0,mabn varchar(" +
                i_maxlength_mabn + "),mavaovien numeric DEFAULT 0,maql numeric DEFAULT 0," +
                "idkhoa numeric DEFAULT 0,quyenso numeric(7) DEFAULT 0,sobienlai numeric(10) DEFAULT 0," +
                "ngay timestamp,loai numeric(1) DEFAULT 0,makp varchar(" + i_maxlength_makp + ")," +
                "madoituong numeric(2) DEFAULT 0,sotien numeric(15,4) DEFAULT 0,ketoan numeric(20) default 0," +
                "done numeric(1) DEFAULT 0,lanin numeric(2) DEFAULT 0,loaibn numeric(2) DEFAULT 0," +
                "idttrv numeric DEFAULT 0,datru numeric(15,4) default 0,userid numeric(7) DEFAULT 0," +
                "ngayud timestamp DEFAULT now(),useridtt numeric(7) DEFAULT 0,ngaytt date,ngaytra timestamp," +
                "CONSTRAINT pk_v_tamung PRIMARY KEY (id) USING INDEX TABLESPACE medi_index," +
                "CONSTRAINT fk_v_tamung_btdbn FOREIGN KEY (mabn) REFERENCES " + usr +
                ".btdbn (mabn) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT," +
                "CONSTRAINT fk_v_tamung_btdkp_bv FOREIGN KEY (makp) REFERENCES " + usr +
                ".btdkp_bv (makp) MATCH SIMPLE  ON UPDATE RESTRICT ON DELETE RESTRICT) WITHOUT OIDS;ALTER TABLE " + usr + ".v_tamung OWNER TO " + owner + ";\n";//Thuy 07.07.2012

            s_sql += " CREATE TABLE " + userid + ".pttt_chandoan ";
            s_sql += "(id numeric NOT NULL DEFAULT 0,";
            s_sql += " maicd character varying(9) NOT NULL,";
            s_sql += " chandoan text,";
            s_sql += " loai numeric(1) NOT NULL DEFAULT 0,";
            s_sql += " userid numeric(7) DEFAULT 0,";
            s_sql += " ngayud timestamp without time zone DEFAULT now(),";
            s_sql += " CONSTRAINT pk_pttt_chandoan PRIMARY KEY (id, maicd, loai) USING INDEX TABLESPACE medi_index,";
            s_sql += " CONSTRAINT fk_pttt_chandoan_icd10 FOREIGN KEY (maicd)";
            s_sql += " REFERENCES " + userid + ".icd10 (cicd10) MATCH SIMPLE";
            s_sql += " ON UPDATE RESTRICT ON DELETE NO ACTION";
            s_sql += ")";
            s_sql += " WITH (OIDS=TRUE);";
            s_sql += " ALTER TABLE " + userid + ".pttt_chandoan OWNER TO " + owner + ";\n";

            s_sql += " CREATE TABLE " + userid + ".pttt_phuongphap ";
            s_sql += "(";
            s_sql += " id numeric NOT NULL DEFAULT 0,";
            s_sql += " mapt character varying(6) NOT NULL,";
            s_sql += " tenpt text,";
            s_sql += " userid numeric(7) DEFAULT 0,";
            s_sql += " ngayud timestamp without time zone DEFAULT now(),";
            s_sql += " CONSTRAINT pk_pttt_phuongphap PRIMARY KEY (id, mapt) USING INDEX TABLESPACE medi_index,";
            s_sql += " CONSTRAINT fk_pttt_phuongphap_dmpttt FOREIGN KEY (mapt)";
            s_sql += " REFERENCES " + userid + ".dmpttt (mapt) MATCH SIMPLE";
            s_sql += " ON UPDATE RESTRICT ON DELETE NO ACTION ";
            s_sql += " )";
            s_sql += " WITH (OIDS=TRUE);";
            s_sql += " ALTER TABLE " + userid + ".pttt_phuongphap OWNER TO " + owner + ";\n";
            s_sql += " update " + userid + ".v_giavp set guingoai=0 where guingoai is null;\n";
            s_sql += " update " + userid + ".v_giavp set guinguoi=0 where guinguoi is null;\n";
            s_sql += " update " + userid + ".v_giavp set guimau=0 where guimau is null;\n";
            s_sql += " alter table " + userid + ".v_giavp alter column guingoai set default 0;\n";
            s_sql += " alter table " + userid + ".v_giavp alter column guinguoi set default 0;\n";
            s_sql += " alter table " + userid + ".v_giavp alter column guimau set default 0;\n";

            s_sql += "CREATE TABLE " + userid + ".dmchucdanh ";
            s_sql += "(";
            s_sql += " id numeric(2) NOT NULL DEFAULT 0,";
            s_sql += " ten text,";
            s_sql += " stt numeric(3) DEFAULT 0,";
            s_sql += " CONSTRAINT pk_dmchucdanh PRIMARY KEY (id) USING INDEX TABLESPACE medi_index";
            s_sql += " )";
            s_sql += " WITH (OIDS=TRUE);";
            s_sql += " ALTER TABLE " + userid + ".dmchucdanh OWNER TO " + owner + ";\n";

            s_sql += " CREATE TABLE " + userid + ".d_dmnguongocthuoc ";
            s_sql += "(";
            s_sql += " id numeric(2) NOT NULL DEFAULT 0,";
            s_sql += " ten text,";
            s_sql += " CONSTRAINT pk_d_dmnguongocthuoc PRIMARY KEY (id) USING INDEX TABLESPACE medi_index";
            s_sql += " )";
            s_sql += " WITH (OIDS=TRUE);";
            s_sql += " ALTER TABLE " + userid + ".d_dmnguongocthuoc OWNER TO " + owner + ";\n";

            s_sql += " alter table " + userid + ".dmbs add column chucdanh numeric(3) default 0;\n";
            s_sql += " alter table " + userid + ".btdkp_bv add column phongdv numeric(1) default 0;\n";
            //Thuy tao view benhanpk 14.11.2012
            s_sql += " CREATE OR REPLACE VIEW " + userid + ".vi_benhanpk AS ";
            s_sql += " SELECT benhanpk.mabn, benhanpk.mavaovien, benhanpk.maql, benhanpk.makp, benhanpk.ngay, benhanpk.madoituong, benhanpk.chandoan,";
            s_sql += " benhanpk.maicd, benhanpk.ttlucrv, benhanpk.mabs, benhanpk.userid ";
            s_sql += " FROM " + userid + mmyy + ".benhanpk";
            if (bMmyy(Mmyy_truoc(mmyy)))
            {
                s_sql += " UNION ALL ";
                s_sql += " SELECT benhanpk.mabn, benhanpk.mavaovien, benhanpk.maql, benhanpk.makp, benhanpk.ngay, benhanpk.madoituong, benhanpk.chandoan,";
                s_sql += " benhanpk.maicd, benhanpk.ttlucrv, benhanpk.mabs, benhanpk.userid ";
                s_sql += " FROM " + userid + Mmyy_truoc(mmyy) + ".benhanpk ";
            }
            if (bMmyy(Mmyy_sau(mmyy)))
            {
                s_sql += " UNION ALL ";
                s_sql += " SELECT benhanpk.mabn, benhanpk.mavaovien, benhanpk.maql, benhanpk.makp, benhanpk.ngay, benhanpk.madoituong, benhanpk.chandoan,";
                s_sql += " benhanpk.maicd, benhanpk.ttlucrv, benhanpk.mabs, benhanpk.userid ";
                s_sql += " FROM " + userid + Mmyy_sau(mmyy) + ".benhanpk ";
            }
            s_sql += " ; ALTER TABLE " + userid + ".vi_benhanpk OWNER TO  " + owner + ";\n";
            //Tạo view benhancc
            s_sql += " CREATE OR REPLACE VIEW " + userid + ".vi_benhancc AS ";
            s_sql += " SELECT benhancc.mabn, benhancc.mavaovien, benhancc.maql, benhancc.makp, benhancc.ngay, benhancc.madoituong, benhancc.chandoan,";
            s_sql += " benhancc.maicd, benhancc.ttlucrv, benhancc.mabs, benhancc.userid ";
            s_sql += " FROM " + userid + mmyy + ".benhancc ";
            if (bMmyy(Mmyy_truoc(mmyy)))
            {
                s_sql += " UNION ALL ";
                s_sql += " SELECT benhancc.mabn, benhancc.mavaovien, benhancc.maql, benhancc.makp, benhancc.ngay, benhancc.madoituong, benhancc.chandoan,";
                s_sql += " benhancc.maicd, benhancc.ttlucrv, benhancc.mabs, benhancc.userid ";
                s_sql += " FROM " + userid + Mmyy_truoc(mmyy) + ".benhancc ";
            }
            if (bMmyy(Mmyy_sau(mmyy)))
            {
                s_sql += " UNION ALL ";
                s_sql += " SELECT benhancc.mabn, benhancc.mavaovien, benhancc.maql, benhancc.makp, benhancc.ngay, benhancc.madoituong, benhancc.chandoan,";
                s_sql += " benhancc.maicd, benhancc.ttlucrv, benhancc.mabs, benhancc.userid ";
                s_sql += " FROM " + userid + Mmyy_sau(mmyy) + ".benhancc;";
            }
            s_sql += " ; ALTER TABLE " + userid + ".vi_benhancc OWNER TO  " + owner + ";\n";
            //Goi tin nhan
            //ozekimessagein
            s_sql += "CREATE TABLE medibv.ozekimessagein ";
            s_sql += "(";
            s_sql += " id serial NOT NULL,";
            s_sql += " sender character varying(30),";
            s_sql += " receiver character varying(30),";
            s_sql += " msg character varying(160),";
            s_sql += " senttime character varying(100),";
            s_sql += " receivedtime character varying(100),";
            s_sql += " "+"operator"+" character varying(100),";
            s_sql += " msgtype character varying(160),";
            s_sql += " reference character varying(100),";
            s_sql += " status character varying(20),";
            s_sql += " CONSTRAINT ozekimessagein_id PRIMARY KEY (id) USING INDEX TABLESPACE medi_index";
            s_sql += ")";
            s_sql += " WITH (";
            s_sql += " OIDS=FALSE";
            s_sql += ");";
            s_sql += " ALTER TABLE " + userid + ".ozekimessagein OWNER TO " + owner + ";\n";
            //ozekimessageout
            s_sql += "CREATE TABLE medibv.ozekimessageout ";
            s_sql += "(";
            s_sql += " id serial NOT NULL,";
            s_sql += " sender character varying(30),";
            s_sql += " receiver character varying(30),";
            s_sql += " msg character varying(160),";
            s_sql += " senttime character varying(100),";
            s_sql += " receivedtime character varying(100),";
            s_sql += " reference character varying(100),";
            s_sql += " status character varying(20),";
            s_sql += " "+"operator"+" character varying(100),";
            s_sql += " msgtype character varying(160),";
            s_sql += " CONSTRAINT ozekimessageout_id PRIMARY KEY (id) USING INDEX TABLESPACE medi_index";
            s_sql += ")";
            s_sql += " WITH (";
            s_sql += " OIDS=FALSE";
            s_sql += ");";
            s_sql += " ALTER TABLE " + userid + ".ozekimessageout OWNER TO " + owner + ";\n";
            s_sql += "CREATE TABLE " + userid + ".language " +
                "(id serial NOT NULL, vietnamese character varying(2000)," +
                  "english character varying(2000), other character varying(2000)," +
                  "CONSTRAINT pk_language PRIMARY KEY (id))" +
                " WITH (OIDS=FALSE);ALTER TABLE " + userid + ".language OWNER TO " + owner + ";\n";
            s_sql += " insert into " + userid + ".language(id) values(1);\n";
            //capstt
            s_sql += " CREATE TABLE " + userid + ".capstt";
            s_sql += " ( ";
            s_sql += " NGAY timestamp without time zone DEFAULT now(),";
            s_sql += " MAKP VARCHAR2(3) NOT NULL,";
            s_sql += " STT NUMBER(4,0) NOT NULL default 0,";
            s_sql += " USERID NUMBER(5,0) default 0,";
            s_sql += " IDCOMPUTER NUMBER(6,0)default 0,";
            s_sql += " ngayud timestamp without time zone DEFAULT sysdate,";
            s_sql += " idsystem NUMBER(2,0) DEFAULT 0, ";
            s_sql += " mac varchar(20),";
            s_sql += " CONSTRAINT pk_capstt PRIMARY KEY (ngay,makp)";
            s_sql += " ) ";
            s_sql += " WITH (OIDS=FALSE);";
            s_sql += " ALTER TABLE " + userid + ".capstt OWNER TO " + owner + ";\n";
            s_sql = s_sql.Trim('\n');
            s_sql = s_sql.Trim(';');
            foreach (string query in s_sql.Split(';'))
            {
                string s_tmp = query.Trim('\n');
                if (s_tmp != "")
                {
                    execute(s_tmp);
                }
            }
            
        }
        string CreateFuncPartitionNgay(string s_Table, string s_TuNgay, string s_DenNgay)
        {
            DateTime dtTuNgay = StringToDate(s_TuNgay);
            DateTime dtDenNgay = StringToDate(s_DenNgay);
            string s_Sql = "";
            while(DateTime.Compare(dtTuNgay,dtDenNgay.AddDays(1))<0)
            {
                DateTime dtTemp = dtDenNgay;
                string s_Start = dtTemp.ToString("MM-01-yyyy");
                DateTime dtEnd = dtDenNgay.AddMonths(1);
                string s_End = dtEnd.ToString("MM-01-yyyy");
                if (s_Sql == "") { s_Sql += " IF "; }
                else { s_Sql += " ELSIF "; }
                s_Sql += "(new.ngay >= date '" + s_Start + "' and new.ngay < date '" + s_End + "') then ";
                s_Sql += "  insert into " + s_Table + "_" + dtTemp.ToString("MMyy") + " values(new.*);\n";
                dtDenNgay = dtDenNgay.AddMonths(-1);
            }
            s_Sql += " ELSE\n";
            s_Sql += "       INSERT INTO " + userid + ".v_tamung_mmyy VALUES (NEW.*);\n";
            s_Sql += " END IF;\n";
            return s_Sql;
        }

        public void Tao_Partition()
        {
            string s_Sql = "CREATE OR REPLACE FUNCTION fuc_tamung()\n";
            s_Sql += "RETURNS TRIGGER AS $$\n";
            s_Sql += "BEGIN\n";
            s_Sql += CreateFuncPartitionNgay(userid + ".v_tamung", "01/01/2012", "31/12/2098");
            s_Sql += "   return null;\n";
            s_Sql += "END;\n";
            s_Sql += "$$\n";
            s_Sql += "LANGUAGE plpgsql;\n";
            execute(s_Sql);
            s_Sql = "CREATE TRIGGER tri_tamung BEFORE INSERT ON "+userid+".v_tamung FOR EACH ROW EXECUTE PROCEDURE fuc_tamung();";
            s_Sql = s_Sql.Trim('\n');
            s_Sql = s_Sql.Trim(';');
            foreach (string query in s_Sql.Split(';'))
            {
                string s_tmp = query.Trim('\n');
                if (s_tmp != "")
                {
                    execute(s_tmp);
                }
            }
        }

        public void Tao_Partition(string m_mmyy)
        {
            string usr = userid;
            string s_sql = "CREATE TABLE " + userid + ".v_tamung_" + m_mmyy + "(CHECK ( ngay >= date '" +
                get_date_partition_start(m_mmyy) + "' AND ngay < date '" + get_date_partition_end(m_mmyy) + "')) " +
                "INHERITS (" + userid + ".v_tamung);\n";
            s_sql += "CREATE TABLE " + userid + ".v_tamung_mmyy(CHECK ( 1>0)) INHERITS (" + userid + ".v_tamung);\n";
            s_sql += "CREATE INDEX v_tamung_" + m_mmyy + "_index ON " + userid + ".v_tamung_" + m_mmyy + "(ngay);\n";//linh 09072012
            s_sql += "insert into " + userid + ".v_tamung(id,mabn,mavaovien,maql,idkhoa,quyenso,sobienlai,ngay,loai,makp,madoituong,sotien,ketoan,done,lanin,loaibn,idttrv,datru,userid,ngaytra)";
            s_sql += "select id,mabn,mavaovien,maql,idkhoa,quyenso,sobienlai,ngay,loai,makp,madoituong,sotien,ketoan,done,lanin,loaibn,idttrv,datru,userid,ngaytra from " + schema + ".v_tamung where id not in(select id from " + userid + ".v_tamung);\n";
            s_sql = s_sql.Trim('\n');
            s_sql = s_sql.Trim(';');
            foreach (string query in s_sql.Split(';'))
            {
                string s_tmp = query.Trim('\n');
                if (s_tmp != "")
                {
                    execute(s_tmp);
                }
            }
        }
        //ThanhCuong - 06/08/2012 - Kỹ thuật cao
        public bool bktCao_tinhtungDV
        {
            //E29
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1137");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }
        public string cc1_te1
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1138");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return ""; }
            }
        }
        public string ck2_ca3
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1139");
                    return ds.Tables[0].Rows[0][0].ToString();
                }
                catch { return ""; }
            }
        }
        public decimal ck2_ca3_26
        {
            get
            {
                try
                {

                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1140");
                    if (ds.Tables[0].Rows.Count == 0)
                    {
                        return 26000000;
                    }
                    return decimal.Parse(ds.Tables[0].Rows[0][0].ToString().Trim());
                }
                catch { return decimal.Parse("26000000"); }
            }
        }
        public string bt4_hn4_ht5
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1141");
                    if (ds.Tables[0].Rows.Count == 0)
                    {
                        return "CK2+CA3";
                    }
                    return ds.Tables[0].Rows[0][0].ToString().Trim();
                }
                catch { return "CK2+CA3"; }
            }
        }
        //End
        //linh 25092012
        public bool QuanLyGiaVienPhiTheoThongTuLienTich15042012
        {
            get
            {
                try
                {
                    bool b_Val = false;
                    b_Val = get_data("select ten from " + this.userid + ".thongso where id=" + ((int)IDThongSo.ID_ThongTuLienTich15042012).ToString()).Tables[0].Rows[0][0].ToString() == "1";
                    if (b_Val)
                    {
                        try
                        {
                            s_Ngayvienphithongtulientich = get_data("select ten from " + this.userid + ".thongso where id=" + ((int)IDThongSo.ID_NgayVienPhiThongTuLienTich15042012).ToString()).Tables[0].Rows[0][0].ToString();
                        }
                        catch
                        { s_Ngayvienphithongtulientich = ""; }
                        try
                        {
                            s_Ngaybenhnhanthongtulientich = get_data("select ten from " + this.userid + ".thongso where id=" + ((int)IDThongSo.ID_NgayBenhNhanThongTuLienTich15042012).ToString()).Tables[0].Rows[0][0].ToString();
                        }
                        catch
                        { s_Ngaybenhnhanthongtulientich = ""; }
                    }
                    else
                    {
                        s_Ngayvienphithongtulientich = "";
                        s_Ngaybenhnhanthongtulientich = "";
                    }
                    if (s_Ngayvienphithongtulientich == "" || s_Ngaybenhnhanthongtulientich == "")
                    {
                        return false;
                    }
                    return b_Val;
                }
                catch
                {
                    return false;
                }
            }
        }

        public string NgayVienPhiThongTuLienTich15042012
        {
            get
            {
                if (QuanLyGiaVienPhiTheoThongTuLienTich15042012)
                {
                    return s_Ngayvienphithongtulientich;
                }
                else
                {
                    return "";
                }
            }
        }

        public string NgayBenhNhanVaoThongTuLienTich15042012
        {
            get
            {
                if (QuanLyGiaVienPhiTheoThongTuLienTich15042012)
                {
                    return s_Ngaybenhnhanthongtulientich;
                }
                else
                {
                    return "";
                }
            }
        }

        /// <summary>
        /// Quy trình sử dụng giá áp dụng thông tư liên tịch của BYT.
        /// Mốc chuẩn 15/4/2012.
        /// Chuẩn bị 2 bảng giá: bảng giá trong v_giavp => sử dụng theo bảng giá mới.
        /// Bảng giá trong v_giavp_daapgia => dùng cho bệnh nhân cũ => vào khai báo đợt giá mới ngày 15/4/2012
        /// đến ngày 15/4/2012 vào chỗ khai báo áp giá theo đợt -> bấm vào áp giá
        /// khi chỉ định, dựa vào ngày vào viện của bệnh nhân load lại bảng giá theo option quan ly giá viện phí theo thông tư liên tịch
        /// </summary>
        /// <param name="s_ngayvienphi"></param>
        /// <param name="s_loaivp"></param>
        /// <param name="s_mucvp"></param>
        /// <param name="i_loaibn"></param>
        /// <param name="b_dungbanggiathongtulientich15042012">Nếu bệnh nhân vô trước ngày s_ngayvienphi, thì truyền vào là true, và s_ngayvienphi phải được khai trong table áp giá</param>
        /// <returns></returns>
        public DataSet get_dmvp(string s_ngayvienphi, string s_loaivp, string s_mucvp, int i_loaibn, bool b_dungbanggiathongtulientich15042012)
        {
            if (s_ngayvienphi == "") { s_ngayvienphi = ngayhienhanh_server; }
            s_ngayvienphi = s_ngayvienphi.Substring(0, 10);
            DataSet dstmp = new DataSet();
            string s_ten = "a.ten";
            if (bChidinh_lietke_kemgia) s_ten += "||' ['||a.gia_th||']'";

            string s_sql = "select a.id,"+s_ten+" as ten,a.ma,a.dvt,nvl(c.gia_th,a.gia_th) as gia_th,nvl(c.gia_bh,a.gia_bh) as gia_bh,nvl(c.gia_dv,a.gia_dv) as gia_dv," +
                " nvl(c.gia_nn,a.gia_nn) as gia_nn,nvl(c.bhyt,a.bhyt) as bhyt,nvl(c.vattu_th,a.vattu_th) as vattu_th,nvl(c.vattu_bh,a.vattu_bh) as vattu_bh," +
                " nvl(c.vattu_dv,a.vattu_dv) as vattu_dv,";
            s_sql = s_sql + "nvl(c.vattu_nn,a.vattu_nn) as vattu_nn,b.computer,b.computervp,a.trongoi,a.locthe,nvl(c.gia_cs,a.gia_cs) as gia_cs," +
                " nvl(c.vattu_cs,a.vattu_cs) as vattu_cs,a.chenhlech,nvl(c.gia_ksk,a.gia_ksk) as gia_ksk,nvl(c.vattu_ksk,a.vattu_ksk) as vattu_ksk,";
            s_sql = s_sql + "b.id_nhom,a.kythuat,nvl(c.thuong,a.thuong) as thuong ,a.loaitrongoi,a.sothe,a.tutuoi,a.dentuoi ";
            s_sql = s_sql + " from " + userid + ".v_giavp a," + userid + ".v_loaivp b ";
            if (SoSanhNgay(s_ngayvienphi, s_Ngayvienphithongtulientich) < 0 && b_dungbanggiathongtulientich15042012)
            {
                s_sql += ",(select a.id_vp,gia_th,gia_bh,gia_cs,gia_dv,gia_nn,gia_ksk," +
                    " vattu_th,vattu_bh,vattu_cs,vattu_dv,vattu_nn,vattu_ksk,thuong,bhyt,gia_vip,vattu_vip from " + userid + ".v_giavp_daapgia a," +
                    " (select min(ngay) ngay,id_vp from " + userid + ".v_giavp_daapgia where to_date(to_char(ngay,'dd/mm/yyyy'),'dd/mm/yyyy')" +
                    " >=to_date('" + s_ngayvienphi + "','dd/mm/yyyy') group by id_vp) b where a.id_vp=b.id_vp and a.ngay=b.ngay) c";
            }
            else
            {
                s_sql += ",(select 0 as id_vp,0 as gia_th,0 as gia_bh,0 as gia_cs,0 as gia_dv,0 as gia_nn,0 as gia_ksk," +
                    " 0 as vattu_th,0 as vattu_bh,0 as vattu_cs,0 as vattu_dv,0 as vattu_nn,0 as vattu_ksk," +
                    " 0 as thuong,0 as bhyt,0 as gia_vip,0 as vattu_vip from " + userid + ".v_giavp_daapgia a where 1=0) c";
            }
            s_sql = s_sql + " where a.id_loai=b.id and a.hide=0 and a.id=c.id_vp(+) ";
            if (s_loaivp != "")
            {
                s_sql = s_sql + " and a.id_loai in (" + s_loaivp + ")";
            }
            if (s_mucvp != "")
            {
                s_sql = s_sql + " and a.id not in (" + s_mucvp + ")";
            }
            s_sql += " and (a.loaibn=0 or a.loaibn=" + i_loaibn.ToString() + ")";
            s_sql = s_sql + " order by b.stt,a.stt";
            dstmp = get_data(s_sql);
            return dstmp;
        }

        /// <summary>
        /// </summary>
        /// <param name="s_ngayvienphi"></param>
        /// <param name="s_loaivp"></param>
        /// <param name="s_mucvp"></param>
        /// <param name="i_loaibn"></param>
        /// <returns></returns>
        public DataSet get_dmvp(string s_ngayvienphi, string s_loaivp, string s_mucvp, int i_loaibn)
        {
            if (s_ngayvienphi == "") { s_ngayvienphi = ngayhienhanh_server; }
            s_ngayvienphi = s_ngayvienphi.Substring(0, 10);
            DataSet dstmp = new DataSet();
            string s_sql = "select a.id,a.ten,a.ma,a.dvt,nvl(c.gia_th,a.gia_th) as gia_th,nvl(c.gia_bh,a.gia_bh) as gia_bh,nvl(c.gia_dv,a.gia_dv) as gia_dv," +
                " nvl(c.gia_nn,a.gia_nn) as gia_nn,nvl(c.bhyt,a.bhyt) as bhyt,nvl(c.vattu_th,a.vattu_th) as vattu_th,nvl(c.vattu_bh,a.vattu_bh) as vattu_bh," +
                " nvl(c.vattu_dv,a.vattu_dv) as vattu_dv,";
            s_sql = s_sql + "nvl(c.vattu_nn,a.vattu_nn) as vattu_nn,b.computer,b.computervp,a.trongoi,a.locthe,nvl(c.gia_cs,a.gia_cs) as gia_cs," +
                " nvl(c.vattu_cs,a.vattu_cs) as vattu_cs,a.chenhlech,nvl(c.gia_ksk,a.gia_ksk) as gia_ksk,nvl(c.vattu_ksk,a.vattu_ksk) as vattu_ksk,";
            s_sql = s_sql + "b.id_nhom,a.kythuat,nvl(c.thuong,a.thuong) as thuong ,a.loaitrongoi,a.sothe,a.tutuoi,a.dentuoi ";
            s_sql = s_sql + " from " + userid + ".v_giavp a," + userid + ".v_loaivp b";
            if (SoSanhNgay(s_ngayvienphi, ngayhienhanh_server.Substring(0, 10)) < 0)
            {
                s_sql += ",(select a.id_vp,gia_th,gia_bh,gia_cs,gia_dv,gia_nn,gia_ksk," +
                    " vattu_th,vattu_bh,vattu_cs,vattu_dv,vattu_nn,vattu_ksk,thuong,bhyt,gia_vip,vattu_vip from " + userid + ".v_giavp_daapgia a," +
                    " (select min(ngay) ngay,id_vp from " + userid + ".v_giavp_daapgia where to_date(to_char(ngay,'dd/mm/yyyy'),'dd/mm/yyyy')" +
                    " >=to_date('" + s_ngayvienphi + "','dd/mm/yyyy') group by id_vp) b where a.id_vp=b.id_vp and a.ngay=b.ngay) c";
            }
            else
            {
                s_sql += ",(select 0 as id_vp,0 as gia_th,0 as gia_bh,0 as gia_cs,0 as gia_dv,0 as gia_nn,0 as gia_ksk," +
                    " 0 as vattu_th,0 as vattu_bh,0 as vattu_cs,0 as vattu_dv,0 as vattu_nn,0 as vattu_ksk," +
                    " 0 as thuong,0 as bhyt,0 as gia_vip,0 as vattu_vip from " + userid + ".v_giavp_daapgia a where 1=0) c";
            }
            s_sql = s_sql + " where a.id_loai=b.id and a.hide=0 and a.id=c.id_vp(+) ";
            if (s_loaivp != "")
            {
                s_sql = s_sql + " and a.id_loai in (" + s_loaivp + ")";
            }
            if (s_mucvp != "")
            {
                s_sql = s_sql + " and a.id not in (" + s_mucvp + ")";
            }
            s_sql += " and (a.loaibn=0 or a.loaibn=" + i_loaibn.ToString() + ")";
            s_sql = s_sql + " order by b.stt,a.stt";
            dstmp = get_data(s_sql);
            return dstmp;
        }// thuy 02012013
        //linh 02012013
        internal string PathXML = "..//..//..//xml";
        const string key = "Toancau@Medisoft.vn/03031952#0903937066.";

        internal string Key
        {
            get { return key; }
        }
        /// <summary>
        /// Dịch ngược mật khẩu
        /// </summary>
        /// <param name="values">Chuỗi đã bị mã hoá</param>
        /// <returns></returns>
        internal string DeCode(string values, string s_key)
        {
            string val = "";
            val = DeCrypt(values, s_key);
            return val;
        }

        string DeCrypt(string values, string s_key)
        {
            byte[] keyArray;
            byte[] toEncryptArray = Convert.FromBase64String(values);
            MD5CryptoServiceProvider hashmd5 = new MD5CryptoServiceProvider();
            keyArray = hashmd5.ComputeHash(UTF8Encoding.UTF8.GetBytes(s_key));
            TripleDESCryptoServiceProvider tdes = new TripleDESCryptoServiceProvider();
            tdes.Key = keyArray;
            tdes.Mode = CipherMode.ECB;
            tdes.Padding = PaddingMode.PKCS7;
            ICryptoTransform cTransform = tdes.CreateDecryptor();
            byte[] resultArray = cTransform.TransformFinalBlock(toEncryptArray, 0, toEncryptArray.Length);
            return UTF8Encoding.UTF8.GetString(resultArray);
        }

        /// <summary>
        /// Mã hoá mật khẩu
        /// </summary>
        /// <param name="values">Chuỗi cần được mã hoá</param>
        /// <returns></returns>
        internal string EnCode(string values)
        {
            string val = "";
            val = EnCrypt(values);
            return val;
        }

        string EnCrypt(string values)
        {
            byte[] keyArray;
            byte[] toEncryptArray = UTF8Encoding.UTF8.GetBytes(values);
            MD5CryptoServiceProvider hashmd5 = new MD5CryptoServiceProvider();
            keyArray = hashmd5.ComputeHash(UTF8Encoding.UTF8.GetBytes(Key));
            TripleDESCryptoServiceProvider tdes = new TripleDESCryptoServiceProvider();
            tdes.Key = keyArray;
            tdes.Mode = CipherMode.ECB;
            tdes.Padding = PaddingMode.PKCS7;
            ICryptoTransform cTransform = tdes.CreateEncryptor();
            byte[] resultArray = cTransform.TransformFinalBlock(toEncryptArray, 0, toEncryptArray.Length);
            return Convert.ToBase64String(resultArray, 0, resultArray.Length);
        }

        //linh 28/02/2013

        /// <summary>
        /// Key của PC để cấp license
        /// </summary>
        public string ComputerKey
        {
            get { return sKey; }
            set { sKey = value; }
        }

        /// <summary>
        /// License của máy
        /// </summary>
        public string License
        {
            get { return sValues; }
            set { sValues = value; }
        }

        public bool QuanLyLicense
        {
            get
            {
                bool b_Val = false;
                string s_SQL = "select ten from " + user + ".thongso where id=888";
                try 
                {
                    b_Val = get_data(s_SQL).Tables[0].Rows.Count > 0;
                }
                catch { b_Val = false; }
                return b_Val;
            }
        }

        /// <summary>
        /// Kiểm tra xem máy đã đăng kí license hay chưa
        /// </summary>
        public bool DaDangKiLicense
        {
            get
            {
                bool b_Val = true;
                if (QuanLyLicense)
                {
                    if (sKey == "" || sValues == "")
                    {
                        b_Val = false;
                    }
                    else
                    {
                        string s_Key = Medisoft2009.MACAddress.MedisoftMAC.KeyInfo;
                        if (sKey != s_Key) { b_Val = false; }
                        else
                        {
                            s_Key = Medisoft2009.License.Encryption.DeCode(sKey, Medisoft2009.License.Encryption.Key);
                            b_Val = Medisoft2009.License.Encryption.ValidLicense(s_Key, sValues);
                        }
                    }
                }
                return b_Val;
            }
        }

        public bool RegisterLicense()
        {
            if (iRownum <= 0) { return false; }
            else
            {
                string s_SQL = "update " + this.userid + ".dmcomputer set key='" + this.sKey + "',value='" + this.sValues + "' where id=" + iRownum;
                con = new NpgsqlConnection(sConn);
                try
                {
                    con.Open();
                    NpgsqlCommand ltcCmd = new NpgsqlCommand(s_SQL, con);
                    ltcCmd.CommandType = CommandType.Text;
                    int i = ltcCmd.ExecuteNonQuery();
                    if (i == 0)
                    {
                        return false;
                    }
                    else
                    {
                        return true;
                    }
                }
                finally
                {
                    con.Close();
                    con.Dispose();
                }
            }
        }

        /// <summary>
        /// Lưu ngày bắt đầu chạy chương trình vào register
        /// </summary>
        public void RegisterDateStart()
        {
            string s_SubKey = "Licenses\\" + sRegDateStart + "-" + Medisoft2009.MACAddress.MedisoftMAC.CPUID;
            Microsoft.Win32.RegistryKey reg = Microsoft.Win32.Registry.ClassesRoot.OpenSubKey(s_SubKey, RegistryKeyPermissionCheck.ReadWriteSubTree);
            if (reg == null)
            {
                Microsoft.Win32.RegistryKey nreg = Microsoft.Win32.Registry.ClassesRoot.CreateSubKey(s_SubKey);
                nreg.SetValue(sRegDateStart, sNgayGioHeThong);
                nreg.Close();
            }
        }

        /// <summary>
        /// Lấy ngày bắt đầu chạy chương trình vào register
        /// </summary>
        public string RegisterGetDateStart
        {
            get
            {
                string s_SubKey = "Licenses\\" + sRegDateStart + "-" + Medisoft2009.MACAddress.MedisoftMAC.CPUID;
                Microsoft.Win32.RegistryKey reg = Microsoft.Win32.Registry.ClassesRoot.OpenSubKey(s_SubKey, RegistryKeyPermissionCheck.ReadWriteSubTree);
                if (reg != null)
                {
                    string s_Ngay = reg.GetValue(sRegDateStart).ToString();
                    reg.Close();
                    return s_Ngay;
                }
                else { return ""; }
            }
        }

        public int get_capstt(string m_ngay, string m_makp, int i_sonhay)
        {
            int i_stt = 0;
            string s_sql = "select stt from " + user + ".capstt where to_char(ngay,'dd/mm/yyyy')='" + m_ngay.Substring(0, 10) + "' and makp='" + m_makp + "'";
            if (con != null) { con.Close(); con.Dispose(); }
            try
            {
                if (i_sonhay == 0) { i_sonhay = 1; }
                con = new NpgsqlConnection(sConn);
                con.Open();
                cmd = new NpgsqlCommand(s_sql, con);
                cmd.CommandType = CommandType.Text;
                dest = new NpgsqlDataAdapter(cmd);
                DataTable dttmp = new DataTable();
                dest.Fill(dttmp);
                if (dttmp.Rows.Count == 0)
                {
                    i_stt = i_sonhay;
                }
                else
                {
                    i_stt = Convert.ToInt32(dttmp.Rows[0][0]) + i_sonhay;
                }
                cmd.Dispose();
                s_sql = "update " + user + ".capstt set stt=" + (i_stt).ToString() + " where to_char(ngay,'dd/mm/yyyy')='" + m_ngay.Substring(0, 10) + "' and makp='" + m_makp + "' ";
                cmd = new NpgsqlCommand(s_sql, con);
                cmd.CommandType = CommandType.Text;
                int num = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (num == 0)
                {
                    s_sql = "insert into " + user + ".capstt(ngay,makp,stt) values (to_date('" + m_ngay + "','dd/mm/yyyy'),'" + m_makp + "'," + i_stt + ")";
                    cmd = new NpgsqlCommand(s_sql, con);
                    cmd.CommandType = CommandType.Text;
                    num = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException exception)
            {
                upd_error(exception.Message, sComputer, "capstt");
            }
            finally
            {
                cmd.Dispose();
                con.Close();
                con.Dispose();
            }
            return i_stt;
        }
        public void f_get_stt_cls_loaivp(string m_ngay, string m_mabn, string m_maql)
        {
            //dtchidinh phai co 2 filed: id, mavp
            string s_user = user;
            string xxx = s_user + mmyy(m_ngay);
            string asql = "";
            int m_stt = 1;
            DataSet lds;

            asql = "select distinct case when c.id_nhom=1 then -1 else b.id_loai end as id_loai, max(a.stt) as sttcho from " + xxx + ".v_chidinh a inner join " + s_user + ".v_giavp b on a.mavp=b.id inner join " + s_user + ".v_loaivp c on b.id_loai=c.id inner join " + s_user + ".v_nhomvp d on c.id_nhom=d.ma ";
            asql += " where to_char(a.ngay,'dd/mm/yyyy')='" + m_ngay.Substring(0, 10) + "'";
            asql += " group by case when c.id_nhom =1 then -1 else b.id_loai end";
            lds = get_data(asql);
            if (lds.Tables.Count > 0 && lds.Tables[0].Rows.Count <= 0)
            {
                m_stt = 1;
                asql = "update " + xxx + ".v_chidinh set stt=" + m_stt + " where mabn='" + m_mabn + "' and maql=" + m_maql;
                execute_data(asql);
            }
            else
            {
                foreach (DataRow r in lds.Tables[0].Rows)
                {
                    m_stt = int.Parse(r["sttcho"].ToString()) + 1;
                    //Thuy 30.03.2012
                    if (r["id_loai"].ToString() != "-1")
                    {
                        asql = "update " + xxx + ".v_chidinh set stt=" + m_stt + " where mabn='" + m_mabn + "' and maql=" + m_maql;
                        asql += " and done in(0,3) and stt=0 and mavp in(select id from " + s_user + ".v_giavp where id_loai=" + r["id_loai"].ToString() + ")";
                        execute_data(asql);
                    }
                    else if (r["id_loai"].ToString() == "-1")
                    {
                        asql = "update " + xxx + ".v_chidinh set stt=" + m_stt + " where mabn='" + m_mabn + "' and maql=" + m_maql;
                        asql += " and done in(0,3) and stt=0 and mavp in(select id from " + s_user + ".v_giavp where id_loai in(select id from medibv.v_loaivp where id_nhom=1))";
                        execute_data(asql);
                    }
                }
            }
        }
        public DataSet get_Tainantt(string tu, string den, string mabn, string hoten, string ngaysinh,
           int phai, string thon, string mann, string madantoc, string matt, string maqu,
           string maphuongxa, string dotuoi, string diadiem, string bophan, string nguyennhan,
           string ngodoc, string dienbien, string xutri, string madoituong, int userid, bool time)
        {
            string m_dotuoi = "", stime = (time) ? "'dd/mm/yyyy hh24:mi'" : "'dd/mm/yyyy'";
            if (time)
            {
                tu = tu + " " + sGiobaocao;
                den = den + " " + sGiobaocao;
            }
            hoten = Hoten_khongdau(hoten);
            sql = "SELECT a.mabn,t.hoten,t.namsinh,case when t.phai=1 then 'Nữ' else 'Nam' end as phai,c.tennn,c.viettat as nnviettat,d.ten as diadiem," +
                "d.viettat as ddviettat,e.ten as bophan,e.viettat as bpviettat, f.TEN as nguyennhan," +
                "f.viettat as ngnhanviettat, g.TEN as ngodoc,h.ten as dienbien,h.viettat as dbviettat," +
                "i.TEN as xutri,i.viettat as xtviettat,t0.sonha,t0.thon,x.tentt,x.viettat as ttviettat,y.tenquan," +
                "y.viettat as quanviettat,z.tenpxa,to_char(a.ngay,'dd/mm/yyyy hh24:mi') as ngay,";//xuất thêm các field viettat
            sql += " a.lydo,a.chandoan,a.dieutri,a.lucvao,a.lucra,t1.madoituong,'" + Mabv + "' as mabv,"; // Thuy lấy thêm field madoituong
            //gam 04/01/2012 viết lại cho tainantt left join medibv.DMDIENBIEN left join medibv.DMXUTRi
            sql += "t1.maicd ";
            sql += " FROM xxx.TAINANTT a inner join " + user + ".btdbn t on  a.mabn=t.mabn inner join " + user +
                ".lienhe t0 on a.maql=t0.maql inner join " +//Thuy 21.05.2012
                " (select maql,madoituong,maicd from " + user + ".benhandt union all select maql,madoituong,maicd " +
                " from " + user + ".benhanngtr) t1 on a.maql=t1.maql inner join " + user + ".doituong t2 on t1.madoituong=t2.madoituong left join " + user + ".BTDNN_BV c on t.MANN = c.MANN ";
            sql += " left join " + user + ".DMDIADIEM d on a.DIADIEM = d.MA  left join " + user + ".DMBOPHAN e on a.BOPHAN = e.MA left join " + user + ".DMNGUYENNHAN f ";
            sql += " on a.NGUYENNHAN = f.MA left join medibv.DMDIENBIEN h on a.DIENBIEN = h.MA left join medibv.DMXUTRI i on a.XUTRI = i.MA left join ";
            sql += user + ".DMNGODOC g on a.NGODOC = g.MA  inner join " + user + ".btdtt x on t0.matt=x.matt inner join " + user + ".btdquan y on t0.maqu=y.maqu ";
            sql += " inner join medibv.btdpxa z on t0.maphuongxa=z.maphuongxa ";
            //sql += " inner join medibv.xuatvien xv on a.maql=xv.maql ";
            sql += " where 1=1";
            if (tu != "")
            {
                if (time)
                    sql += " and a.ngay between to_date('" + tu + "'," + stime + ") and to_date('" + den + "'," + stime + ")";
                else
                    sql += " and " + for_ngay("a.ngay", "'dd/mm/yyyy'") + " between to_date('" + tu + "'," + stime + ") and to_date('" + den + "'," + stime + ")";
            }
            if (mabn != "") sql += " and t.mabn='" + mabn + "'";
            if (hoten != "") sql += " and t.hotenkdau='" + hoten + "'";
            if (ngaysinh.Trim().Length == 10) sql += " and to_char(t.ngaysinh,'dd/mm/yyyy')='" + ngaysinh + "'";
            if (phai != -1) sql += " and t.phai=" + phai;
            if (thon != "") sql += " and a.thon='" + thon + "'";
            if (mann != "") sql += " and t.mann='" + mann + "'";
            if (madantoc != "") sql += " and t.madantoc='" + madantoc + "'";
            if (matt != "") sql += " and a.matt='" + matt + "'";
            if (maqu != "") sql += " and a.maqu='" + maqu + "'";
            if (maphuongxa != "") sql += " and a.maphuongxa='" + maphuongxa + "'";
            if (diadiem != "") sql += " and a.diadiem='" + diadiem + "'";
            if (bophan != "") sql += " and a.bophan='" + bophan + "'";
            if (nguyennhan != "") sql += " and a.nguyennhan='" + nguyennhan + "'";
            if (ngodoc != "") sql += " and a.ngodoc='" + ngodoc + "'";
            if (dienbien != "") sql += " and a.dienbien='" + dienbien + "'";
            if (xutri != "") sql += " and a.xutri='" + xutri + "'";
            if (userid != -1) sql += " and a.userid='" + userid + "'";
            if (dotuoi != "")
            {
                if (dotuoi.IndexOf(">") != -1)
                {
                    m_dotuoi = dotuoi.Substring(1);
                    sql += " and to_number(to_char(a.ngay,'yyyy'))-to_number(t.namsinh)>" + m_dotuoi; //sql += " and to_number(to_char(now(),'yyyy'))-to_number(t.namsinh)>" + m_dotuoi;
                }
                else
                {
                    int i1 = int.Parse(dotuoi.Substring(0, dotuoi.IndexOf("-")));
                    int i2 = int.Parse(dotuoi.Substring(dotuoi.IndexOf("-") + 1));
                    sql += " and to_number(to_char(a.ngay,'yyyy'),'0000')-to_number(t.namsinh,'0000') between " + i1 + " and " + i2; //sql += " and to_number(to_char(now(),'yyyy'),'0000')-to_number(t.namsinh,'0000') between " + i1 + " and " + i2;
                }
            }
            if (madoituong != "") sql += " and t1.madoituong='" + madoituong + "'";//Thuy 19.01.2012

            //sql += " order by a.ngay";
            DataSet dstmp = get_data_mmyy(sql, tu, den, false);//Thuy 20.02.2012
            sql = "SELECT a.mabn,t.hoten,t.namsinh,case when t.phai=1 then 'Nữ' else 'Nam' end as phai," +
                "c.tennn,c.viettat as nnviettat,d.ten as diadiem,d.viettat as ddviettat,e.ten as bophan," +
                "e.viettat as bpviettat, f.TEN as nguyennhan, f.viettat as ngnhanviettat,g.TEN as ngodoc," +
                "h.ten as dienbien,h.viettat as dbviettat,i.TEN as xutri,i.viettat as xtviettat,t0.sonha,t0.thon," +
                "x.tentt,x.viettat as ttviettat,y.tenquan,y.viettat as quanviettat,z.tenpxa," +
                //"trim(t.sonha)||' '||t.thon||' '||trim(z.tenpxa)||','||trim(y.tenquan)||','||x.tentt as diachi,"+
                "to_char(a.ngay,'dd/mm/yyyy hh24:mi') as ngay,";
            sql += "a.lydo,a.chandoan,a.dieutri,a.lucvao,a.lucra,t1.madoituong,'" + Mabv + "' as mabv,t1.maicd "; // Thuy lấy thêm field madoituong
            //gam 04/01/2012 viết lại cho tainantt left join medibv.DMDIENBIEN left join medibv.DMXUTRi
            sql += " FROM xxx.TAINANTT a inner join " + user + ".btdbn t on  a.mabn=t.mabn inner join " +
                "xxx.lienhe t0 on a.maql=t0.maql inner join " +//Thuy 21.05.2012
                " (select maql,madoituong,maicd from xxx.benhancc union all select maql,madoituong,maicd from xxx.benhanpk) t1 on a.maql=t1.maql inner join " + user + ".doituong t2 on t1.madoituong=t2.madoituong left join " + user + ".BTDNN_BV c on t.MANN = c.MANN ";
            sql += " left join " + user + ".DMDIADIEM d on a.DIADIEM = d.MA  left join " + user + ".DMBOPHAN e on a.BOPHAN = e.MA  left join " + user + ".DMNGUYENNHAN f ";
            sql += " on a.NGUYENNHAN = f.MA left join medibv.DMDIENBIEN h on a.DIENBIEN = h.MA left join medibv.DMXUTRI i on a.XUTRI = i.MA left join ";
            sql += user + ".DMNGODOC g on a.NGODOC = g.MA  inner join " + user + ".btdtt x on a.matt=x.matt inner join " + user + ".btdquan y on a.maqu=y.maqu ";
            sql += " inner join medibv.btdpxa z on a.maphuongxa=z.maphuongxa where 1=1 ";
            if (tu != "")
            {
                if (time)
                    sql += " and a.ngay between to_date('" + tu + "'," + stime + ") and to_date('" + den + "'," + stime + ")";
                else
                    sql += " and " + for_ngay("a.ngay", "'dd/mm/yyyy'") + " between to_date('" + tu + "'," + stime + ") and to_date('" + den + "'," + stime + ")";
            }
            if (mabn != "") sql += " and t.mabn='" + mabn + "'";
            if (hoten != "") sql += " and t.hotenkdau='" + hoten + "'";
            if (ngaysinh.Trim().Length == 10) sql += " and to_char(t.ngaysinh,'dd/mm/yyyy')='" + ngaysinh + "'";
            if (phai != -1) sql += " and t.phai=" + phai;
            if (thon != "") sql += " and a.thon='" + thon + "'";
            if (mann != "") sql += " and t.mann='" + mann + "'";
            if (madantoc != "") sql += " and t.madantoc='" + madantoc + "'";
            if (matt != "") sql += " and a.matt='" + matt + "'";
            if (maqu != "") sql += " and a.maqu='" + maqu + "'";
            if (maphuongxa != "") sql += " and a.maphuongxa='" + maphuongxa + "'";
            if (diadiem != "") sql += " and a.diadiem='" + diadiem + "'";
            if (bophan != "") sql += " and a.bophan='" + bophan + "'";
            if (nguyennhan != "") sql += " and a.nguyennhan='" + nguyennhan + "'";
            if (ngodoc != "") sql += " and a.ngodoc='" + ngodoc + "'";
            if (dienbien != "") sql += " and a.dienbien='" + dienbien + "'";
            if (xutri != "") sql += " and a.xutri='" + xutri + "'";
            if (userid != -1) sql += " and a.userid='" + userid + "'";
            if (dotuoi != "")
            {
                if (dotuoi.IndexOf(">") != -1)
                {
                    m_dotuoi = dotuoi.Substring(1);
                    sql += " and to_number(to_char(a.ngay,'yyyy'))-to_number(t.namsinh)>" + m_dotuoi; //sql += " and to_number(to_char(now(),'yyyy'))-to_number(t.namsinh)>" + m_dotuoi;
                }
                else
                {
                    int i1 = int.Parse(dotuoi.Substring(0, dotuoi.IndexOf("-")));
                    int i2 = int.Parse(dotuoi.Substring(dotuoi.IndexOf("-") + 1));
                    sql += " and to_number(to_char(a.ngay,'yyyy'),'0000')-to_number(t.namsinh,'0000') between " + i1 + " and " + i2; //sql += " and to_number(to_char(now(),'yyyy'),'0000')-to_number(t.namsinh,'0000') between " + i1 + " and " + i2;
                }
            }
            if (madoituong != "") sql += " and t1.madoituong='" + madoituong + "'";//Thuy 19.01.2012
            dstmp.Merge(get_data_mmyy(sql, tu, den, false));
            return dstmp;
        }
        public bool upd_thuchienylenh(decimal m_id, string m_ngay, string m_manv, int m_mach,
           int m_nhietdo, string m_huyetap, int m_nhiptho, string m_dienbien, string m_thuchien, string m_makp, int m_userid)
        {
            string xxx = userid;
            sql = "update " + xxx + ".thuchienylenh set ngay=to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),manv='" + m_manv + "',mach=" + m_mach.ToString() + ",nhietdo=" + m_nhietdo.ToString() + ",";
            sql += "huyetap='" + m_huyetap + "',nhiptho=" + m_nhiptho.ToString() + ",dienbien=:m_dienbien,thuchien=:m_thuchien ";
            sql += ", makp='" + m_makp + "', userid=" + m_userid + "";
            sql += " where id=" + m_id.ToString();
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Text).Value = m_ngay == "" ? null : (m_ngay.Length == 10 ? m_ngay + " " + DateTime.Now.ToString("hh:mm") : m_ngay);
                cmd.Parameters.Add("m_dienbien", NpgsqlDbType.Text).Value = m_dienbien;
                cmd.Parameters.Add("m_thuchien", NpgsqlDbType.Text).Value = m_thuchien;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".thuchienylenh(id,ngay,manv,mach,nhietdo,huyetap,nhiptho,dienbien,thuchien, makp, userid)";
                    sql += " values (" + m_id.ToString() + ",to_date(:m_ngay,'dd/mm/yyyy hh24:mi'),'" + m_manv + "'," + m_mach + "," +
                        m_nhietdo + ",'" + m_huyetap + "'," + m_nhiptho.ToString() + ",:m_dienbien,:m_thuchien, '" + m_makp + "'," + m_userid + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ngay", NpgsqlDbType.Text).Value = m_ngay == "" ? null : (m_ngay.Length == 10 ? m_ngay + " " + DateTime.Now.ToString("hh:mm") : m_ngay);
                    cmd.Parameters.Add("m_dienbien", NpgsqlDbType.Text).Value = m_dienbien;
                    cmd.Parameters.Add("m_thuchien", NpgsqlDbType.Text).Value = m_thuchien;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "thuchienylenh " + m_id.ToString());
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        //======================Ghi de len file cu

        /// <summary>
        /// Quy trình sử dụng giá áp dụng thông tư liên tịch của BYT.
        /// Mốc chuẩn 15/4/2012.
        /// Chuẩn bị 2 bảng giá: bảng giá trong v_giavp => sử dụng theo bảng giá mới.
        /// Bảng giá trong v_giavp_daapgia => dùng cho bệnh nhân cũ => vào khai báo đợt giá mới ngày 15/4/2012
        /// đến ngày 15/4/2012 vào chỗ khai báo áp giá theo đợt -> bấm vào áp giá
        /// khi chỉ định, dựa vào ngày vào viện của bệnh nhân load lại bảng giá theo option quan ly giá viện phí theo thông tư liên tịch
        /// </summary>
        /// <param name="s_ngayvienphi"></param>
        /// <param name="s_loaivp"></param>
        /// <param name="s_mucvp"></param>
        /// <param name="i_loaibn"></param>
        /// <param name="b_dungbanggiathongtulientich15042012">Nếu bệnh nhân vô trước ngày s_ngayvienphi, thì truyền vào là true, và s_ngayvienphi phải được khai trong table áp giá</param>
        /// <returns></returns>
        public DataSet get_dmvp(string s_ngayvienphi, string s_loaivp, string s_mucvp, int i_loaibn, bool b_dungbanggiathongtulientich15042012, bool b_sapxepTenKTTheoABC)
        {
            if (s_ngayvienphi == "") { s_ngayvienphi = ngayhienhanh_server; }
            s_ngayvienphi = s_ngayvienphi.Substring(0, 10);
            string s_ten = "a.ten";
            if (bChidinh_lietke_kemgia) s_ten += "||' ['||a.gia_th||']'";
            DataSet dstmp = new DataSet();
            string s_sql = "select a.id," + s_ten + " as ten,a.ma,a.dvt,nvl(c.gia_th,a.gia_th) as gia_th,nvl(c.gia_bh,a.gia_bh) as gia_bh,nvl(c.gia_dv,a.gia_dv) as gia_dv," +
                " nvl(c.gia_nn,a.gia_nn) as gia_nn,nvl(c.bhyt,a.bhyt) as bhyt,nvl(c.vattu_th,a.vattu_th) as vattu_th,nvl(c.vattu_bh,a.vattu_bh) as vattu_bh," +
                " nvl(c.vattu_dv,a.vattu_dv) as vattu_dv,";
            s_sql = s_sql + "nvl(c.vattu_nn,a.vattu_nn) as vattu_nn,b.computer,b.computervp,a.trongoi,a.locthe,nvl(c.gia_cs,a.gia_cs) as gia_cs," +
                " nvl(c.vattu_cs,a.vattu_cs) as vattu_cs,a.chenhlech,nvl(c.gia_ksk,a.gia_ksk) as gia_ksk,nvl(c.vattu_ksk,a.vattu_ksk) as vattu_ksk,";
            s_sql = s_sql + "b.id_nhom,a.kythuat,nvl(c.thuong,a.thuong) as thuong ,a.loaitrongoi,a.sothe,a.tutuoi,a.dentuoi ";
            s_sql = s_sql + " from " + userid + ".v_giavp a," + userid + ".v_loaivp b ";
            if (SoSanhNgay(s_ngayvienphi, s_Ngayvienphithongtulientich) < 0 && b_dungbanggiathongtulientich15042012)
            {
                s_sql += ",(select a.id_vp,gia_th,gia_bh,gia_cs,gia_dv,gia_nn,gia_ksk," +
                    " vattu_th,vattu_bh,vattu_cs,vattu_dv,vattu_nn,vattu_ksk,thuong,bhyt,gia_vip,vattu_vip from " + userid + ".v_giavp_daapgia a," +
                    " (select min(ngay) ngay,id_vp from " + userid + ".v_giavp_daapgia where to_date(to_char(ngay,'dd/mm/yyyy'),'dd/mm/yyyy')" +
                    " >=to_date('" + s_ngayvienphi + "','dd/mm/yyyy') group by id_vp) b where a.id_vp=b.id_vp and a.ngay=b.ngay) c";
            }
            else
            {
                s_sql += ",(select 0 as id_vp,0 as gia_th,0 as gia_bh,0 as gia_cs,0 as gia_dv,0 as gia_nn,0 as gia_ksk," +
                    " 0 as vattu_th,0 as vattu_bh,0 as vattu_cs,0 as vattu_dv,0 as vattu_nn,0 as vattu_ksk," +
                    " 0 as thuong,0 as bhyt,0 as gia_vip,0 as vattu_vip from " + userid + ".v_giavp_daapgia a where 1=0) c";
            }
            s_sql = s_sql + " where a.id_loai=b.id and a.hide=0 and a.id=c.id_vp(+) ";
            if (s_loaivp != "")
            {
                s_sql = s_sql + " and a.id_loai in (" + s_loaivp + ")";
            }
            if (s_mucvp != "")
            {
                s_sql = s_sql + " and a.id not in (" + s_mucvp + ")";
            }
            s_sql += " and (a.loaibn=0 or a.loaibn=" + i_loaibn.ToString() + ")";
            if (b_sapxepTenKTTheoABC == false)
            {
                s_sql = s_sql + " order by b.stt,a.stt";
            }
            else
            {
                s_sql += " order by a.ten ";
            }
            dstmp = get_data(s_sql);
            return dstmp;
        }

        public bool upd_btdkp_bv(string m_table, string m_makp, string m_tenkp, int m_kehoach, int m_thucke, string m_makpbo, string m_maba, int m_loai, int m_mavp, string m_loaivp, string m_mucvp, string m_viettat, string m_loaicd, string m_muccd, string m_kho, bool m_Themmoi)
        {
            int irec = 0;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            con.Open();
            try
            {
                if (m_Themmoi == false)
                {
                    sql = "update " + user + "." + m_table + " set tenkp=:m_tenkp,kehoach=:m_kehoach,thucke=:m_thucke,makpbo=:m_makpbo,maba=:m_maba,loai=:m_loai,mavp=:m_mavp,loaivp=:m_loaivp,mucvp=:m_mucvp,viettat=:m_viettat,loaicd=:m_loaicd,muccd=:m_muccd,kho=:m_kho where makp=:m_makp";

                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_tenkp", NpgsqlDbType.Text).Value = m_tenkp;
                    cmd.Parameters.Add("m_kehoach", NpgsqlDbType.Numeric).Value = m_kehoach;
                    cmd.Parameters.Add("m_thucke", NpgsqlDbType.Numeric).Value = m_thucke;
                    cmd.Parameters.Add("m_makpbo", NpgsqlDbType.Varchar, 2).Value = m_makpbo;
                    cmd.Parameters.Add("m_maba", NpgsqlDbType.Text).Value = m_maba;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                    cmd.Parameters.Add("m_mavp", NpgsqlDbType.Numeric).Value = m_mavp;
                    cmd.Parameters.Add("m_loaivp", NpgsqlDbType.Text).Value = m_loaivp;
                    cmd.Parameters.Add("m_mucvp", NpgsqlDbType.Text).Value = m_mucvp;
                    cmd.Parameters.Add("m_viettat", NpgsqlDbType.Varchar, 8).Value = m_viettat;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_loaicd", NpgsqlDbType.Text).Value = m_loaicd;
                    cmd.Parameters.Add("m_muccd", NpgsqlDbType.Text).Value = m_muccd;
                    cmd.Parameters.Add("m_kho", NpgsqlDbType.Text).Value = m_kho;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();


                }
                else
                {

                    sql = "insert into " + user + "." + m_table + " (makp,tenkp,kehoach,thucke,makpbo,maba,loai,mavp,loaivp,mucvp,viettat,loaicd,muccd,kho) values (:m_makp,:m_tenkp,:m_kehoach,:m_thucke,:m_makpbo,:m_maba,:m_loai,:m_mavp,:m_loaivp,:m_mucvp,:m_viettat,:m_loaicd,:m_muccd,:m_kho)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_tenkp", NpgsqlDbType.Text).Value = m_tenkp;
                    cmd.Parameters.Add("m_kehoach", NpgsqlDbType.Numeric).Value = m_kehoach;
                    cmd.Parameters.Add("m_thucke", NpgsqlDbType.Numeric).Value = m_thucke;
                    cmd.Parameters.Add("m_makpbo", NpgsqlDbType.Varchar, 2).Value = m_makpbo;
                    cmd.Parameters.Add("m_maba", NpgsqlDbType.Text).Value = m_maba;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                    cmd.Parameters.Add("m_mavp", NpgsqlDbType.Numeric).Value = m_mavp;
                    cmd.Parameters.Add("m_loaivp", NpgsqlDbType.Text).Value = m_loaivp;
                    cmd.Parameters.Add("m_mucvp", NpgsqlDbType.Text).Value = m_mucvp;
                    cmd.Parameters.Add("m_viettat", NpgsqlDbType.Varchar, 8).Value = m_viettat;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_loaicd", NpgsqlDbType.Text).Value = m_loaicd;
                    cmd.Parameters.Add("m_muccd", NpgsqlDbType.Text).Value = m_muccd;
                    cmd.Parameters.Add("m_kho", NpgsqlDbType.Text).Value = m_kho;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }

            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, m_table);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_btdkp_bv(string m_table, string m_makp, string m_tenkp, int m_kehoach, int m_thucke, string m_makpbo, string m_maba, int m_loai, int m_mavp, string m_loaivp, string m_mucvp, string m_viettat, string m_loaicd, string m_muccd, int m_khudt, int m_chinhanh, int m_tiemchung, string m_kho, int m_dichvu, bool m_Themmoi)
        {

            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();

                if (m_Themmoi == false)
                {
                    sql = "update " + user + "." + m_table + " set tenkp=:m_tenkp,kehoach=:m_kehoach,thucke=:m_thucke,makpbo=:m_makpbo,maba=:m_maba,loai=:m_loai,mavp=:m_mavp,loaivp=:m_loaivp,mucvp=:m_mucvp,viettat=:m_viettat,loaicd=:m_loaicd,muccd=:m_muccd, khu=:m_khudt, chinhanh=:m_chinhanh,tiemchung=:m_tiemchung,kho=:m_kho,phongdv=:m_dichvu where makp=:m_makp";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_tenkp", NpgsqlDbType.Text).Value = m_tenkp;
                    cmd.Parameters.Add("m_kehoach", NpgsqlDbType.Numeric).Value = m_kehoach;
                    cmd.Parameters.Add("m_thucke", NpgsqlDbType.Numeric).Value = m_thucke;
                    cmd.Parameters.Add("m_makpbo", NpgsqlDbType.Varchar, 2).Value = m_makpbo;
                    cmd.Parameters.Add("m_maba", NpgsqlDbType.Text).Value = m_maba;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                    cmd.Parameters.Add("m_mavp", NpgsqlDbType.Numeric).Value = m_mavp;
                    cmd.Parameters.Add("m_loaivp", NpgsqlDbType.Text).Value = m_loaivp;
                    cmd.Parameters.Add("m_mucvp", NpgsqlDbType.Text).Value = m_mucvp;
                    cmd.Parameters.Add("m_viettat", NpgsqlDbType.Varchar, 8).Value = m_viettat;

                    cmd.Parameters.Add("m_loaicd", NpgsqlDbType.Text).Value = m_loaicd;
                    cmd.Parameters.Add("m_muccd", NpgsqlDbType.Text).Value = m_muccd;
                    cmd.Parameters.Add("m_khudt", NpgsqlDbType.Numeric).Value = m_khudt;
                    cmd.Parameters.Add("m_chinhanh", NpgsqlDbType.Numeric).Value = m_chinhanh;
                    cmd.Parameters.Add("m_tiemchung", NpgsqlDbType.Numeric).Value = m_tiemchung;
                    cmd.Parameters.Add("m_kho", NpgsqlDbType.Text).Value = m_kho;
                    cmd.Parameters.Add("m_dichvu", NpgsqlDbType.Numeric).Value = m_dichvu;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
                else //if (irec == 0) 
                {
                    sql = "insert into " + user + "." + m_table + " (makp,tenkp,kehoach,thucke,makpbo,maba,loai,mavp,loaivp,mucvp,viettat,loaicd,muccd, khu, chinhanh,tiemchung,kho,phongdv) values (:m_makp,:m_tenkp,:m_kehoach,:m_thucke,:m_makpbo,:m_maba,:m_loai,:m_mavp,:m_loaivp,:m_mucvp,:m_viettat,:m_loaicd,:m_muccd,:m_khudt,:m_chinhanh,:m_tiemchung,:m_kho,:m_dichvu)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_tenkp", NpgsqlDbType.Text).Value = m_tenkp;
                    cmd.Parameters.Add("m_kehoach", NpgsqlDbType.Numeric).Value = m_kehoach;
                    cmd.Parameters.Add("m_thucke", NpgsqlDbType.Numeric).Value = m_thucke;
                    cmd.Parameters.Add("m_makpbo", NpgsqlDbType.Varchar, 2).Value = m_makpbo;
                    cmd.Parameters.Add("m_maba", NpgsqlDbType.Text).Value = m_maba;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                    cmd.Parameters.Add("m_mavp", NpgsqlDbType.Numeric).Value = m_mavp;
                    cmd.Parameters.Add("m_loaivp", NpgsqlDbType.Text).Value = m_loaivp;
                    cmd.Parameters.Add("m_mucvp", NpgsqlDbType.Text).Value = m_mucvp;
                    cmd.Parameters.Add("m_viettat", NpgsqlDbType.Varchar, 8).Value = m_viettat;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_loaicd", NpgsqlDbType.Text).Value = m_loaicd;
                    cmd.Parameters.Add("m_muccd", NpgsqlDbType.Text).Value = m_muccd;
                    cmd.Parameters.Add("m_khudt", NpgsqlDbType.Numeric).Value = m_khudt;
                    cmd.Parameters.Add("m_chinhanh", NpgsqlDbType.Numeric).Value = m_chinhanh;
                    cmd.Parameters.Add("m_tiemchung", NpgsqlDbType.Numeric).Value = m_tiemchung;
                    cmd.Parameters.Add("m_kho", NpgsqlDbType.Text).Value = m_kho;
                    cmd.Parameters.Add("m_dichvu", NpgsqlDbType.Numeric).Value = m_dichvu;

                    cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, m_table);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool upd_btdkp_bv(string m_table, string m_makp, string m_tenkp, int m_kehoach, int m_thucke, string m_makpbo, string m_maba, int m_loai, int m_mavp, string m_loaivp, string m_mucvp, string m_viettat, string m_loaicd, string m_muccd, int m_khudt, int m_chinhanh, bool m_themmoi)
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                if (m_themmoi == false)
                {
                    sql = "update " + user + "." + m_table + " set tenkp=:m_tenkp,kehoach=:m_kehoach,thucke=:m_thucke,makpbo=:m_makpbo,maba=:m_maba,loai=:m_loai,mavp=:m_mavp,loaivp=:m_loaivp,mucvp=:m_mucvp,viettat=:m_viettat,loaicd=:m_loaicd,muccd=:m_muccd, khu=:m_khudt, chinhanh=:m_chinhanh where makp=:m_makp";

                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_tenkp", NpgsqlDbType.Text).Value = m_tenkp;
                    cmd.Parameters.Add("m_kehoach", NpgsqlDbType.Numeric).Value = m_kehoach;
                    cmd.Parameters.Add("m_thucke", NpgsqlDbType.Numeric).Value = m_thucke;
                    cmd.Parameters.Add("m_makpbo", NpgsqlDbType.Varchar, 2).Value = m_makpbo;
                    cmd.Parameters.Add("m_maba", NpgsqlDbType.Text).Value = m_maba;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                    cmd.Parameters.Add("m_mavp", NpgsqlDbType.Numeric).Value = m_mavp;
                    cmd.Parameters.Add("m_loaivp", NpgsqlDbType.Text).Value = m_loaivp;
                    cmd.Parameters.Add("m_mucvp", NpgsqlDbType.Text).Value = m_mucvp;
                    cmd.Parameters.Add("m_viettat", NpgsqlDbType.Varchar, 8).Value = m_viettat;

                    cmd.Parameters.Add("m_loaicd", NpgsqlDbType.Text).Value = m_loaicd;
                    cmd.Parameters.Add("m_muccd", NpgsqlDbType.Text).Value = m_muccd;
                    cmd.Parameters.Add("m_khudt", NpgsqlDbType.Numeric).Value = m_khudt;
                    cmd.Parameters.Add("m_chinhanh", NpgsqlDbType.Numeric).Value = m_chinhanh;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
                else //if (irec == 0)
                {
                    sql = "insert into " + user + "." + m_table + " (makp,tenkp,kehoach,thucke,makpbo,maba,loai,mavp,loaivp,mucvp,viettat,loaicd,muccd, khu, chinhanh) values (:m_makp,:m_tenkp,:m_kehoach,:m_thucke,:m_makpbo,:m_maba,:m_loai,:m_mavp,:m_loaivp,:m_mucvp,:m_viettat,:m_loaicd,:m_muccd,:m_khudt,:m_chinhanh)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_tenkp", NpgsqlDbType.Text).Value = m_tenkp;
                    cmd.Parameters.Add("m_kehoach", NpgsqlDbType.Numeric).Value = m_kehoach;
                    cmd.Parameters.Add("m_thucke", NpgsqlDbType.Numeric).Value = m_thucke;
                    cmd.Parameters.Add("m_makpbo", NpgsqlDbType.Varchar, 2).Value = m_makpbo;
                    cmd.Parameters.Add("m_maba", NpgsqlDbType.Text).Value = m_maba;
                    cmd.Parameters.Add("m_loai", NpgsqlDbType.Numeric).Value = m_loai;
                    cmd.Parameters.Add("m_mavp", NpgsqlDbType.Numeric).Value = m_mavp;
                    cmd.Parameters.Add("m_loaivp", NpgsqlDbType.Text).Value = m_loaivp;
                    cmd.Parameters.Add("m_mucvp", NpgsqlDbType.Text).Value = m_mucvp;
                    cmd.Parameters.Add("m_viettat", NpgsqlDbType.Varchar, 8).Value = m_viettat;
                    cmd.Parameters.Add("m_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = m_makp;
                    cmd.Parameters.Add("m_loaicd", NpgsqlDbType.Text).Value = m_loaicd;
                    cmd.Parameters.Add("m_muccd", NpgsqlDbType.Text).Value = m_muccd;
                    cmd.Parameters.Add("m_khudt", NpgsqlDbType.Numeric).Value = m_khudt;
                    cmd.Parameters.Add("m_chinhanh", NpgsqlDbType.Numeric).Value = m_chinhanh;

                    cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, m_table);
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool bToaThuocF5_TuDong_TruTonkho_F44
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1512");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bCaptoa_TheodmloaiDuocphepcaptoa_F45
        {
            //F45
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1260");
                    return ds.Tables[0].Rows[0][0].ToString() == "1";
                }
                catch { return false; }
            }
        }
        public bool bchiphi_lonhon_tamung_khongchothuchien_cls_H27
        {
            //H27
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1261");
                    return ds.Tables[0].Rows[0][0].ToString() == "1";
                }
                catch { return true; }
            }
        }
        public void reset_sequence(string v_ngay)
        {
            string s_sql = "select ngay from " + user + ".v_reset_sequence where to_char(ngay,'dd/mm/yyyy')='" + v_ngay.Substring(0, 10) + "'";
            DataSet dstemp = new DataSet();
            dstemp = get_data(s_sql);
            if (dstemp == null || dstemp.Tables.Count == 0)
            {
                execute_data("create table " + user+ ".v_reset_sequence(stt numeric(22),ngay date not null default now(),constraint pk_v_reset_sequence primary key(ngay));");
                dstemp = get_data("select ngay from " + user + ".v_reset_sequence where to_char(ngay,'dd/mm/yyyy')='" + v_ngay.Substring(0, 10) + "'");
            }
            if (dstemp.Tables[0].Rows.Count == 0)
            {
                execute_data("insert into " + user + ".v_reset_sequence(ngay) values(to_date('" + v_ngay.Substring(0, 10) + "','dd/mm/yyyy'))");
                foreach (DataRow nr in get_data("select makp from " + user + ".btdkp_bv where chinhanh=" + i_Chinhanh_hientai).Tables[0].Rows)
                {
                    if (!execute_data("select setval('" + user + ".seq_pk_" + nr["makp"].ToString() + "',0)"))//stt phong cls
                    {
                        execute_data("create sequence " + user + ".seq_pk_" + nr["makp"].ToString() + " INCREMENT 1 START 0 MINVALUE 0");
                    }

                }
                execute_data("select setval('" + user + ".seq_stt_pk',0)");//stt phong kham
                execute_data("select setval('" + user + ".seq_stt_nt',0)");//stt nha thuoc

            }
        }

        #region QRCode
        public bool upd_bhyt_qrcode(string m_sothe, string m_hoten, string m_ngaysinh, int m_gioitinh, string m_diachi, string m_mabv, string m_tungay, string m_denngay, string m_ngaycap, string m_maql_bhxh, string m_makiemtra_bhxh, int m_userid, string m_mabn)
        {
            sql = "update " + user + ".bhyt_qrcode set hoten=:m_hoten, ngaysinh=to_date(:m_ngaysinh,'dd/mm/yyyy'), gioitinh=:m_gioitinh, diachi=:m_diachi, ngaycap=to_date(:m_ngaycap,'dd/mm/yyyy'), maql_bhxh=:m_maql_bhxh, makiemtra_bhxh=:m_makiemtra_bhxh, userid=" + m_userid;
            sql += " where sothe='" + m_sothe + "' and to_char(tungay,'dd/mm/yyyy')='" + m_tungay + "' and to_char(denngay,'dd/mm/yyyy')='" + m_denngay + "' and mabv='" + m_mabv + "' and mabn='" + m_mabn + "'";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_hoten", NpgsqlDbType.Text).Value = m_hoten;
                cmd.Parameters.Add("m_ngaysinh", NpgsqlDbType.Varchar, 10).Value = m_ngaysinh;
                cmd.Parameters.Add("m_gioitinh", NpgsqlDbType.Numeric).Value = m_gioitinh;
                cmd.Parameters.Add("m_diachi", NpgsqlDbType.Text).Value = m_diachi;
                cmd.Parameters.Add("m_ngaycap", NpgsqlDbType.Varchar, 10).Value = m_ngaycap;
                cmd.Parameters.Add("m_maql_bhxh", NpgsqlDbType.Varchar, 30).Value = m_maql_bhxh;
                cmd.Parameters.Add("m_makiemtra_bhxh", NpgsqlDbType.Varchar, 30).Value = m_makiemtra_bhxh;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".bhyt_qrcode(sothe, ngaysinh, gioitinh, mabv,tungay, denngay, ngaycap, userid, mabn, hoten, diachi, maql_bhxh, makiemtra_bhxh) ";
                    sql += " values('" + m_sothe + "', to_date('" + m_ngaysinh + "','dd/mm/yyyy'), " + m_gioitinh + ", '" + m_mabv + "', to_date('" + m_tungay + "','dd/mm/yyyy'), to_date('" + m_denngay + "','dd/mm/yyyy'), to_date('" + m_ngaycap + "','dd/mm/yyyy'), " + m_userid + ",'" + m_mabn + "',:m_hoten, :m_diachi, :m_maql_bhxh, :m_makiemtra_bhxh)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_hoten", NpgsqlDbType.Text).Value = m_hoten;
                    cmd.Parameters.Add("m_diachi", NpgsqlDbType.Text).Value = m_diachi;
                    cmd.Parameters.Add("m_maql_bhxh", NpgsqlDbType.Varchar, 30).Value = m_maql_bhxh;
                    cmd.Parameters.Add("m_makiemtra_bhxh", NpgsqlDbType.Varchar, 30).Value = m_makiemtra_bhxh;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "bhyt_qrcode");
                return false;
            }
            finally
            {

                con.Close(); con.Dispose();
            }
            return true;
        }
        #endregion

        public bool upd_danhmuc_quannhan(int m_id, string m_ma, string m_ten, string m_table)
        {
            sql = "update medibv." + m_table + " set ma=:m_ma,ten=:m_ten";
            sql += " where id=:m_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 20).Value = m_ma;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                cmd.Parameters.Add("m_id", NpgsqlDbType.Integer, 5).Value = m_id;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into medibv." + m_table + " (id,ma,ten) values (:m_id,:m_ma,:m_ten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Integer, 5).Value = m_id;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 20).Value = m_ma;
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, m_table);
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        //khuyen 15/02/14 public bool upd_danhmuc_quannhan(int m_id, string m_ma, string m_ten,int m_idloaidv, string m_table)
        public bool upd_danhmuc_quannhan(int m_id, string m_ma, string m_ten, int m_iddonvicap1, string m_table)//khuyen 15/02/14 sua ten bien m_idloaidv= m_iddonvicap1
        {
            /*sql = "update medibv." + m_table + " set ma=:m_ma,idloaidv=:m_idloaidv,ten=:m_ten";
            sql += " where id=:m_id";*/
            if (m_table == "qn_dmdonvi_cap2")
            {
                sql = "update medibv." + m_table + " set ma=:m_ma,iddonvicap1=:m_iddonvicap1,ten=:m_ten";//khuyenn 15/02/14 thay "idloaidv=:m_idloaidv" ="iddonvicap1=:m_iddonvicap1"
                sql += " where id=:m_id";
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                try
                {
                    con.Open();
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 20).Value = m_ma;
                    //khuyen 15/02/14 cmd.Parameters.Add("m_idloaidv", NpgsqlDbType.Integer, 5).Value = m_idloaidv;
                    cmd.Parameters.Add("m_iddonvicap1", NpgsqlDbType.Integer, 5).Value = m_iddonvicap1;//khuyen 15/2/14 thay m_idloaidv=m_iddonvicap1
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Integer, 5).Value = m_id;
                    int irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                    if (irec == 0)
                    {
                        //khuyen 15/02/14 sql = "insert into medibv." + m_table + " (id,ma,idloaidv,ten) values (:m_id,:m_ma,:m_idloaidv,:m_ten)";
                        sql = "insert into medibv." + m_table + " (id,ma,iddonvicap1,ten) values (:m_id,:m_ma,:m_iddonvicap1,:m_ten)";//khuyen 15/02/14 thay idloaidv=iddonvicap1,m_idloaidv=m_iddonvicap1
                        cmd = new NpgsqlCommand(sql, con);
                        cmd.CommandType = CommandType.Text;
                        cmd.Parameters.Add("m_id", NpgsqlDbType.Integer, 5).Value = m_id;
                        cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 20).Value = m_ma;
                        //khuyen 15/02/14 cmd.Parameters.Add("m_idloaidv", NpgsqlDbType.Integer, 5).Value = m_idloaidv;
                        cmd.Parameters.Add("m_iddonvicap1", NpgsqlDbType.Integer, 5).Value = m_iddonvicap1;//khuyen 15/02/14 thay m_idloaidv=m_iddonvicap1
                        cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                        irec = cmd.ExecuteNonQuery();
                        cmd.Dispose();
                    }
                }
                catch (NpgsqlException ex)
                {
                    upd_error(ex.Message, sComputer, m_table);
                    return false;
                }
                finally
                {
                    con.Close(); con.Dispose();
                }
            }

            if (m_table == "qn_dmdonvi_cap3")
            {
                sql = "update medibv." + m_table + " set ma=:m_ma,id_cap2=:m_iddonvicap1,ten=:m_ten";//khuyenn 15/02/14 thay "idloaidv=:m_idloaidv" ="iddonvicap1=:m_iddonvicap1"
                sql += " where id=:m_id";
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                try
                {
                    con.Open();
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 20).Value = m_ma;
                    //khuyen 15/02/14 cmd.Parameters.Add("m_idloaidv", NpgsqlDbType.Integer, 5).Value = m_idloaidv;
                    cmd.Parameters.Add("m_iddonvicap1", NpgsqlDbType.Integer, 5).Value = m_iddonvicap1;//khuyen 15/2/14 thay m_idloaidv=m_iddonvicap1
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Integer, 5).Value = m_id;
                    int irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                    if (irec == 0)
                    {
                        //khuyen 15/02/14 sql = "insert into medibv." + m_table + " (id,ma,idloaidv,ten) values (:m_id,:m_ma,:m_idloaidv,:m_ten)";
                        sql = "insert into medibv." + m_table + " (id,ma,id_cap2,ten) values (:m_id,:m_ma,:m_iddonvicap1,:m_ten)";//khuyen 15/02/14 thay idloaidv=iddonvicap1,m_idloaidv=m_iddonvicap1
                        cmd = new NpgsqlCommand(sql, con);
                        cmd.CommandType = CommandType.Text;
                        cmd.Parameters.Add("m_id", NpgsqlDbType.Integer, 5).Value = m_id;
                        cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 20).Value = m_ma;
                        //khuyen 15/02/14 cmd.Parameters.Add("m_idloaidv", NpgsqlDbType.Integer, 5).Value = m_idloaidv;
                        cmd.Parameters.Add("m_iddonvicap1", NpgsqlDbType.Integer, 5).Value = m_iddonvicap1;//khuyen 15/02/14 thay m_idloaidv=m_iddonvicap1
                        cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                        irec = cmd.ExecuteNonQuery();
                        cmd.Dispose();
                    }
                }
                catch (NpgsqlException ex)
                {
                    upd_error(ex.Message, sComputer, m_table);
                    return false;
                }
                finally
                {
                    con.Close(); con.Dispose();
                }
            }

            if (m_table == "qn_dmdonvi_cap4")
            {
                sql = "update medibv." + m_table + " set ma=:m_ma,id_cap3=:m_iddonvicap1,ten=:m_ten";//khuyenn 15/02/14 thay "idloaidv=:m_idloaidv" ="iddonvicap1=:m_iddonvicap1"
                sql += " where id=:m_id";
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                try
                {
                    con.Open();
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 20).Value = m_ma;
                    //khuyen 15/02/14 cmd.Parameters.Add("m_idloaidv", NpgsqlDbType.Integer, 5).Value = m_idloaidv;
                    cmd.Parameters.Add("m_iddonvicap1", NpgsqlDbType.Integer, 5).Value = m_iddonvicap1;//khuyen 15/2/14 thay m_idloaidv=m_iddonvicap1
                    cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Integer, 5).Value = m_id;
                    int irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                    if (irec == 0)
                    {
                        //khuyen 15/02/14 sql = "insert into medibv." + m_table + " (id,ma,idloaidv,ten) values (:m_id,:m_ma,:m_idloaidv,:m_ten)";
                        sql = "insert into medibv." + m_table + " (id,ma,id_cap3,ten) values (:m_id,:m_ma,:m_iddonvicap1,:m_ten)";//khuyen 15/02/14 thay idloaidv=iddonvicap1,m_idloaidv=m_iddonvicap1
                        cmd = new NpgsqlCommand(sql, con);
                        cmd.CommandType = CommandType.Text;
                        cmd.Parameters.Add("m_id", NpgsqlDbType.Integer, 5).Value = m_id;
                        cmd.Parameters.Add("m_ma", NpgsqlDbType.Varchar, 20).Value = m_ma;
                        //khuyen 15/02/14 cmd.Parameters.Add("m_idloaidv", NpgsqlDbType.Integer, 5).Value = m_idloaidv;
                        cmd.Parameters.Add("m_iddonvicap1", NpgsqlDbType.Integer, 5).Value = m_iddonvicap1;//khuyen 15/02/14 thay m_idloaidv=m_iddonvicap1
                        cmd.Parameters.Add("m_ten", NpgsqlDbType.Text).Value = m_ten;
                        irec = cmd.ExecuteNonQuery();
                        cmd.Dispose();
                    }
                }
                catch (NpgsqlException ex)
                {
                    upd_error(ex.Message, sComputer, m_table);
                    return false;
                }
                finally
                {
                    con.Close(); con.Dispose();
                }
            }
          

            return true;
        }

        #region modify_table new theo database
        public void modify_schema_mmyy_sql_new(string mmyy)
        {
            upd_alter_table(true, 0, "xxx", "v_thvpct", "idtonghop", "add", "numeric(25)", "0");
            upd_alter_table(true, 0, "xxx", "v_thvpct", "stttonghop", "add", "numeric(5)", "0");
            upd_alter_table(true, 0, "xxx", "d_chuyenct", "stttchuyen", "alter column", "type numeric(25)", "");
            modify_schema_mmyy_new(mmyy);
        }
        /// <summary>
        /// Chay cac lenh add colum co trong database medibv goc
        /// </summary>
        /// <param name="mmyy">du lieu thang mmyy</param>
        public void modify_schema_mmyy_new(string mmyy)
        {
            if (bMmyy(mmyy) == false) return;
            string s_userdb = user;
            DataSet dscolumn = new DataSet(), dscol_alter = new DataSet();
            string asql = " select table_schema, table_name,  column_name ";
            asql += " from information_schema.columns where table_catalog='" + database + "' and table_schema='" + user + mmyy + "' ";
            dscolumn = f_load_dscolumn(mmyy);// get_data(asql);
            //
            asql = " select schema_name,table_name, field_name, command_ct, data_type, case when default_value is not null then ' default '||default_value else '' end as default_value,";
            asql += " 'alter table '||schema_name||'.'||table_name||' '||command_ct||' '||  field_name|| ' '||case when command_ct='add' then '' else ' type ' end|| data_type || case when command_ct='add' and default_value is not null and default_value<>'' then ' default '||default_value else '' end ||';' as sql ";
            asql += " from medibv.alter_table ";
            asql += " where schema_name='xxx'";
            dscol_alter = get_data(asql);
            //
            DataRow dr1;
            string exp = "";
            if (dscolumn == null || dscolumn.Tables.Count <= 0 || dscolumn.Tables[0].Rows.Count <= 0) return;
            foreach (DataRow dr0 in dscol_alter.Tables[0].Rows)
            {
                exp = "table_name='" + dr0["table_name"].ToString() + "'";
                dr1 = getrowbyid(dscolumn.Tables[0], exp);
                if (dr1 == null)
                {
                    asql = " create table " + dr0["schema_name"].ToString() + "." + dr0["table_name"].ToString() + "(" + dr0["field_name"].ToString() + " " + dr0["data_type"].ToString() + " " + dr0["default_value"].ToString() + ")";
                    asql = asql.Replace("xxx", s_userdb + mmyy);
                    execute_data(asql);
                    dscolumn = f_load_dscolumn(mmyy);//
                    continue;
                }
                if (dr0["command_ct"].ToString().ToLower().Length >= 5 && dr0["command_ct"].ToString().ToLower().Substring(0, 5) == "alter")
                {
                    asql = dr0["sql"].ToString().Replace("xxx", s_userdb + mmyy);
                    execute_data(asql, false);
                }
                else
                {
                    exp = "table_name='" + dr0["table_name"].ToString() + "' and column_name='" + dr0["field_name"].ToString() + "'";
                    dr1 = getrowbyid(dscolumn.Tables[0], exp);
                    if (dr1 == null)
                    {
                        asql = dr0["sql"].ToString().Replace("xxx", s_userdb + mmyy);
                        execute_data(asql, false);
                    }
                }
            }

        }

        /// <summary>
        /// Load tat ca column theo database
        /// </summary>
        /// <returns></returns>
        private DataSet f_load_dscolumn(string a_mmyy)
        {
            string asql = " select table_schema, table_name,  column_name ";
            asql += " from information_schema.columns where table_catalog='" + database + "' and table_schema='" + user + a_mmyy + "' ";
            DataSet ads = get_data(asql);

            return ads;
        }
        /// <summary>
        /// Chay cac lenh add colum co trong database medibv goc
        /// </summary>
        public void modify_schema_root_new()
        {
            string s_userdb = user;
            DataSet dscolumn, dscol_alter;
            string asql = " select table_schema, table_name,  column_name ";
            asql += " from information_schema.columns where table_catalog='" + database + "' and table_schema='" + user + "' ";
            dscolumn = f_load_dscolumn("");
            //
            asql = " select table_name, field_name, command_ct, data_type,  case when default_value is not null then ' default '||default_value else '' end  as default_vale, ";
            asql += " 'alter table '||schema_name||'.'||table_name||' '||command_ct||' '||  field_name|| ' '|| data_type || case when command_ct='add' and default_value is not null and default_value<>'' then ' default '||default_value else '' end ||';' as sql ";
            asql += " from medibv.alter_table ";
            asql += " where schema_name='medibv'";
            dscol_alter = get_data(asql);
            //
            DataRow dr1;
            string exp = "";
            if (dscolumn == null || dscolumn.Tables.Count <= 0 || dscolumn.Tables[0].Rows.Count <= 0) return;
            foreach (DataRow dr0 in dscol_alter.Tables[0].Rows)
            {

                exp = "table_name='" + dr0["table_name"].ToString() + "'";
                dr1 = getrowbyid(dscolumn.Tables[0], exp);
                if (dr1 == null)
                {
                    asql = " create table " + dr0["table_name"].ToString() + "." + dr0["table_name"].ToString() + "(" + dr0["field_name"].ToString() + " " + dr0["data_type"].ToString() + " " + dr0["default_value"].ToString() + ")";
                    execute_data(asql);
                    dscolumn = f_load_dscolumn("");//
                    continue;
                }
                if (dr0["command_ct"].ToString().Trim().ToLower().Substring(0, 3) == "add")
                {
                    exp = "table_name='" + dr0["table_name"].ToString() + "' and column_name='" + dr0["field_name"].ToString() + "'";
                    dr1 = getrowbyid(dscolumn.Tables[0], exp);
                    if (dr1 == null)
                    {
                        execute_data(dr0["sql"].ToString());
                    }
                }
                else
                {
                    execute_data(dr0["sql"].ToString());
                }
            }

        }

        public bool upd_alter_table(bool m_new, decimal m_id, string m_schemaname, string m_table_name, string m_field_name, string m_command, string m_data_type_length, string m_default_value)
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            con.Open();
            try
            {
                if (m_new == false)
                {
                    sql = "update " + user + ".alter_table set command_ct=:m_command, data_type=:m_data_type_length, default_value=:m_default_value ";
                    sql += " where id=:m_id ";                    
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_command", NpgsqlDbType.Varchar).Value = m_command;
                    cmd.Parameters.Add("m_data_type_length", NpgsqlDbType.Text).Value = m_data_type_length;
                    cmd.Parameters.Add("m_default_value", NpgsqlDbType.Text).Value = m_default_value;
                    cmd.Parameters.Add("m_id", NpgsqlDbType.Numeric).Value = m_id;
                    cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
                else
                {

                    sql = "insert into " + user + ".alter_table (schema_name,table_name,field_name,command_ct,data_type,default_value) ";
                    sql += " values (:m_schema_name,:m_table_name,:m_field_name,:m_command,:m_data_type_length,:m_default_value)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_schema_name", NpgsqlDbType.Varchar).Value = m_schemaname;
                    cmd.Parameters.Add("m_table_name", NpgsqlDbType.Text).Value = m_table_name;
                    cmd.Parameters.Add("m_field_name", NpgsqlDbType.Text).Value = m_field_name;
                    cmd.Parameters.Add("m_command", NpgsqlDbType.Varchar).Value = m_command;
                    cmd.Parameters.Add("m_data_type_length", NpgsqlDbType.Text).Value = m_data_type_length;
                    cmd.Parameters.Add("m_default_value", NpgsqlDbType.Text).Value = m_default_value;
                    cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_error(ex.Message, sComputer, "upd_alter_table");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }
        /// <summary>
        /// lay cac column name dua vao table alter_table
        /// </summary>
        /// <param name="a_database_name"></param>
        /// <param name="a_schemaname"></param>
        /// <param name="a_mmyy"></param>
        public void f_get_cautruc_chuan(string a_database_name, string a_schemaname, string a_mmyy)
        {
            string s_userdb = user;
            string asql = "";
            asql = " insert into medibv.alter_table (schema_name, table_name,field_name, command_ct,  data_type, default_value) ";
            asql += " select '" + ((a_mmyy == "") ? s_userdb : "xxx") + "' as table_schema, table_name, column_name, 'add' as cmd_ct, ";
            asql += " case when data_type='character varying' then data_type||'('||character_maximum_length||')' ";
            asql += " else case when data_type='numeric' and substr(column_default,1,7)='nextval' then 'serial' ";
            asql += " else case when data_type='numeric' and numeric_precision is not null then data_type||'('||numeric_precision||','||numeric_scale||')' else data_type end end end as type,  ";
            asql += " case when substr(column_default,1,7)='nextval' then '' else column_default end as default_value ";
            asql += " from information_schema.columns where table_catalog='" + a_database_name + "' and table_schema='" + a_schemaname + a_mmyy + "'";// and column_name not in('chuyendi', 'ngayud')";
            asql += " and is_updatable='YES'";
            asql += " and column_name not in('chuyendi') and '" + ((a_mmyy == "") ? s_userdb : "xxx") + "'||'-'||table_name||'-'||column_name not in (select '" + ((a_mmyy == "") ? s_userdb : "xxx") + "'||'-'||table_name||'-'||field_name from medibv.alter_table where command_ct='add' )";
            execute_data(asql);
        }
        #endregion

        /// <summary>
        /// Chuyen so the tu thang truoc: (thang bn vao) --> sang thang bn co chi dinh
        /// </summary>
        /// <param name="m_mmyy"></param>
        /// <param name="m_mabn"></param>
        /// <param name="m_ngavao"></param>
        /// <param name="m_maql"></param>
        public void f_chuyenbhyt_to_next_mmyy(string m_mabn, decimal m_maql, string m_ngavao, string m_ngaychidinh)
        {
            string m_mmyy = mmyy(m_ngaychidinh);
            string s_mmyy_truoc = mmyy(m_ngavao);
            string s_user = user;
            string user_s = s_user + m_mmyy, user_t = s_user + s_mmyy_truoc;

            string asql = " insert into " + user_s + ".bhyt (mabn, maql, sothe, tungay, denngay, traituyen, sudung, mabv) ";
            asql+=" select a.mabn, a.maql, a.sothe, a.tungay, a.denngay, a.traituyen, a.sudung, a.mabv ";
            asql += " from " + user_t + ".bhyt a left join " + user_s + ".bhyt b on a.maql=b.maql ";
            asql += " where b.maql is null";
            asql += " and a.mabn='" + m_mabn + "' and a.maql=" + m_maql;
            execute_data(asql);
        }

    }

    public enum LoaiNgayGiuong
    {
        PhauThuatLoaiI = 1,
        PhauThuatLoaiII = 2,
        PhauThuatLoaiIII = 3,
        PhauThuatLoaiDB = 4,
        SanhThuong = 5,
        MoDe = 6,
    }

    public enum LoaiPTTT
    {
        ThuThuat = 0,
        PhauThuat = 1,
    }
}
