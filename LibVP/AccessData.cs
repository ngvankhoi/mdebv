using System;
using System.Xml;
using System.Data;
using Npgsql;
using NpgsqlTypes;
using System.Diagnostics;
using System.Security.Cryptography;
using System.Text;
using LinksLicense;
using System.Windows.Forms;
using System.Drawing;
using System.Threading;
using Microsoft.VisualBasic;
using Microsoft.VisualBasic.CompilerServices;
using System.Runtime.InteropServices;

namespace LibVP
{
    public class AccessData
    {
        string s_dblink = "";
        [DllImport("winmm.dll")]
        private static extern bool PlaySound(string lpszName, int hModule, int dwFlags);
        public const int i_maxlength_mabn = 10, i_maxlength_makp =3;
        public const int iChieuDaiID=25;
        string xxxxx = "Ð§Ì©Î«³²°Ô£";
        public const string Msg = "Viện phí";
        private int flag_language = 0;
        private string m_cur_mmyy = "";
        public const string s_links_username = "links";
        public const string s_links_password = "link7155019s20";
        public const string s_links_userid = "-99999";
        private string m_db_database = "medisoft2007";
        private string m_db_host = "192.168.1.14";
        private string m_db_port = "5432";
        private string m_db_userid = "medisoft";
        private string m_db_password = "links1920";
        private string m_db_encoding = "UNICODE";
        private string m_db_schemaroot = "medibv";
        private string sConn = "Server=192.168.1.114;Port=5432;User Id=medisoft;Password=links1920;Database=medisoft2007;Encoding=UNICODE;";
        private string m_computername = "";
        private int m_computerid = 1;
        private string sql = "";
        private DataSet m_ds = null;
        private DataSet m_ds_schema = null, ds_ngaykk = null;
        private DataSet ds_event = null;
        private NpgsqlDataAdapter dest;
        private NpgsqlConnection con;
        private NpgsqlCommand cmd;
        public string ConStr
        {
            get {
                return sConn;
            }
        }
        public AccessData()
        {
            m_computername = System.Environment.MachineName.Trim().ToUpper();
            f_load_maincode();
            sConn = "Server=" + m_db_host + ";Port=" + m_db_port + ";User Id=" + m_db_userid + ";Password=" + m_db_password + ";Database=" + m_db_database + ";Encoding=" + m_db_encoding + ";Pooling=true;";
            if (!upd_dmcomputer())
            {
                System.Windows.Forms.MessageBox.Show("Không kết nối được Server !", Msg);
                System.Windows.Forms.Application.Exit();
            }
            m_computerid = int.Parse(i_Chinhanh_hientai.ToString() + get_computerid().ToString().PadLeft(5, '0'));
            m_ds_schema = get_shemaname_mmyy();
            m_cur_mmyy = s_curmmyy;
        }

        #region get_chieudai_mabn_makp
        private int iChieudai_makp
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso" + s_dblink + " where id=-98");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 2; }
            }
        }
        private int iChieudai_mabn
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso" + s_dblink + " where id=-99");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 8; }
            }
        }
        #endregion get_chieudai_mabn_makp
        public string s_AppName
        {
            get
            {
                return Change_language_MessageText(Msg);
            }
        }
        public string user
        {
            get
            {
                return m_db_schemaroot;
            }
        }
        public string s_ComputerName
        {
            get
            {
                return m_computername;
            }
        }
        public decimal get_maql_benhancc(string v_mavaovien, string v_mabn, string v_ngay)
        {
            DataSet ds = get_data_mmyy(get_mmyy(v_ngay), "select maql from medibvmmyy.benhancc" + s_dblink + " where mabn='" + v_mabn + "' and mavaovien=" + v_mavaovien + "");
            decimal l_maql = (ds.Tables[0].Rows.Count == 0) ? 0 : decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            return l_maql;
        }
        public decimal get_maql_tiepdon(string v_mavaovien, string v_mabn, string v_ngay)
        {
            DataSet ds = get_data_mmyy(get_mmyy(v_ngay), "select maql from medibvmmyy.tiepdon" + s_dblink + " where noitiepdon=0 and mabn='" + v_mabn + "' and mavaovien=" + v_mavaovien + "");
            decimal l_maql = (ds.Tables[0].Rows.Count == 0) ? 0 : decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
            return l_maql;
        }
        public int get_stt(DataTable dt, string cot)
        {
            if (dt.Rows.Count == 0) return 1;
            else return int.Parse(dt.Rows[dt.Rows.Count - 1][cot].ToString()) + 1;
        }
        public bool bThanhtoan_khoa
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso" + s_dblink + " where id=242");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        #region SYSTEM CONFIGUREATION

        public int check_process(string program)
        {
            int i = 0;
            Process[] processes = Process.GetProcesses();
            if (processes.Length > 1)
                for (int n = 0; n <= processes.Length - 1; n++)
                    if (((Process)processes[n]).ProcessName.ToString() == program) i++;
            return i;
        }
        public void check_process(int so, string program)
        {
            Process[] processes = Process.GetProcesses();
            int sopro = processes.Length;
            if (sopro > so)
            {
                for (int n = 0; n <= processes.Length - 1; n++)
                    if (((Process)processes[n]).ProcessName == program)
                    {
                        ((Process)processes[n]).Kill();
                        sopro--;
                        if (sopro == so) break;
                    }
            }
        }
        public bool sys_cokhuyenmai_tt
        {
            get
            {
                return get_v_option("chkCoKhuyenMai_TT").ToString() == "1";
            }
            set
            {
                upd_v_option("chkCoKhuyenMai_TT", (value == true) ? "1" : "0");
            }
        }
        public string get_v_option(string v_ma)
        {
            try
            {
                return get_data("select giatri from medibv.v_option" + s_dblink + " where ma='" + v_ma + "'").Tables[0].Rows[0][0].ToString().Trim();
            }
            catch
            {
                return "";
            }
        }
        public string sys_makp_khongkham
        {
            get
            {
                string atmp = get_v_option("cbKhoakhongkham").ToString().Trim();
                if (atmp == "")
                {
                    atmp = "01";
                }
                return atmp;
            }
            set
            {
                upd_v_option("cbKhoakhongkham", value);
            }
        }
        public string sys_solanin
        {
            get
            {
                string atmp = get_v_option("txtSolanin").ToString().Trim();
                if (atmp == "")
                {
                    atmp = "1";
                }
                return atmp;
            }
            set
            {
                upd_v_option("txtSolanin", value);
            }
        }
        public string sys_Loaibn_mien()
        {
            return get_v_option("chkMientheoloaibn");
        }

        public string sys_mavp_congkhamBHYT
        {
            get
            {
                string atmp = get_v_option("cbCongkhambhyt").ToString().Trim();
                if (atmp == "")
                {
                    atmp = "0000";
                }
                return atmp;
            }
            set
            {
                upd_v_option("cbCongkhambhyt", value);
            }
        }

        public bool sys_dungchungso
        {
            get
            {
                return get_v_option("chkDungchungso").ToString() == "1";
            }
            set
            {
                upd_v_option("chkDungchungso", (value == true) ? "1" : "0");
            }
        }
        public bool sys_doctinnhan
        {
            get
            {
                return get_v_option("chkDoctinnhan").ToString() == "1";
            }
            set
            {
                upd_v_option("chkDoctinnhan", (value == true) ? "1" : "0");
            }
        }

        public bool sys_Chuky
        {
            get
            {
                return get_v_option("chkChukyDT").ToString() == "1";
            }
            set
            {
                upd_v_option("chkChukyDT", (value == true) ? "1" : "0");
            }
        }

        public bool sys_Loctheonguoidangnhap
        {
            get
            {
                return get_v_option("chkLocnguoithu").ToString() == "1";
            }
            set
            {
                upd_v_option("chkLocnguoithu", (value == true) ? "1" : "0");
            }
        }

        public bool sys_SBLtu_den
        {
            get
            {
                return get_v_option("chkSBLtuden").ToString() == "1";
            }
            set
            {
                upd_v_option("chkSBLtuden", (value == true) ? "1" : "0");
            }
        }
        public bool sys_ChonhinhBN
        {
            get
            {
                return get_v_option("chkChonhinhBN").ToString() == "1";
            }
            set
            {
                upd_v_option("chkChonhinhBN", (value == true) ? "1" : "0");
            }
        }
        public string sys_Pathimage
        {
            get
            {
                string atmp = get_v_option(" txtPathImageBN").Trim();
                if (atmp == "")
                {
                    atmp = "";
                }
                return atmp;
            }
            set
            {
                upd_v_option(" txtPathImageBN", value);
            }
        }
        public string sys_TypeFile
        {
            get
            {
                string atmp = get_v_option("cbLoaifile").ToString().Trim();
                if (atmp == "")
                {
                    atmp = "JPEG";
                }
                return atmp;
            }
            set
            {
                upd_v_option("cbLoaifile", value);
            }
        }

        public bool sys_khuyenmai
        {
            get
            {
                return get_v_option("chkkhuyenmai").ToString() == "1";
            }
            set
            {
                upd_v_option("chkkhuyenmai", (value == true) ? "1" : "0");
            }
        }
        public bool sys_dichvukhongtinhtien
        {
            get
            {
                return get_v_option("chkdichkhongtinhtien").ToString() == "1";
            }
            set
            {
                upd_v_option("chkdichkhongtinhtien", (value == true) ? "1" : "0");
            }
        }
        public bool sys_nhapsotienchitiet_tu
        {
            get
            {
                return get_v_option("chkNhapsotienchitiet_tu").ToString() == "1";
            }
            set
            {
                upd_v_option("chkNhapsotienchitiet_tu", (value == true) ? "1" : "0");
            }
        }
        public bool sys_hoantramon_tt
        {
            get
            {
                return get_v_option("chkHoantramon_TT").ToString() == "1";
            }
            set
            {
                upd_v_option("chkHoantramon_TT", (value == true) ? "1" : "0");
            }
        }
        public bool sys_ttrv_thuoc_vienphi
        {
            get
            {
                return get_v_option("ttrv_thuoc_vienphi").ToString() == "1";
            }
            set
            {
                upd_v_option("ttrv_thuoc_vienphi", (value == true) ? "1" : "0");
            }
        }
        public bool sys_dongiacongvattu
        {
            get
            {
                return get_v_option("chkDongiacongvattu").ToString() == "1";
            }
            set
            {
                upd_v_option("chkDongiacongvattu", (value == true) ? "1" : "0");
            }
        }
        public string sys_tamungchitiettheo_1loai_2nhom
        {
            get
            {
                return get_v_option("cbChitiettamung");
            }
        }
        public bool sys_insotienchitiet_tamung
        {
            get
            {
                return get_v_option("chkInsotienchitiet_tamung").Trim() == "1";
            }
        }
        public string sys_thuquy
        {
            get
            {
                return get_v_option("txtThuquy").Trim();
            }
            set
            {
                upd_v_option("txtThuquy", value);
            }
        }
        public string sys_ketoanvp
        {
            get
            {
                return get_v_option("txtKetoanvp").Trim();
            }
            set
            {
                upd_v_option("txtKetoanvp", value);
            }
        }
        public string sys_phongtckt
        {
            get
            {
                return get_v_option("txtPhongtckt").Trim();
            }
            set
            {
                upd_v_option("txtPhongtckt", value);
            }
        }
        public string sys_report_thutructiep
        {
            get
            {
                string atmp = "v_bienlaithuvienphi.rpt";
                return atmp;
            }
            set
            {
                upd_v_option("txtReport_Tructiep", value);
            }
        }
        public string sys_report_thutructiep_dacthu
        {
            get
            {
                string atmp = get_v_option("txtReport_Tructiep_dacthu").Trim();
                if (atmp == "")
                {
                    atmp = "v_bienlaithuvienphi_dacthu.rpt";
                }
                return atmp;
            }
            set
            {
                upd_v_option("txtReport_Tructiep_dacthu", value);
            }
        }
        public string sys_report_thutructiep_thuong
        {
            get
            {
                string atmp = get_v_option("txtReport_Tructiep_thuong").Trim();
                if (atmp == "")
                {
                    atmp = "v_bienlaithuvienphi_thuong.rpt";
                }
                return atmp;
            }
            set
            {
                upd_v_option("txtReport_Tructiep_thuong", value);
            }
        }
        public string sys_report_thutructiep_gtgt
        {
            get
            {
                string atmp = get_v_option("txtReport_Tructiep_gtgt").Trim();
                if (atmp == "")
                {
                    atmp = "v_bienlaithuvienphi_gtgt.rpt";
                }
                return atmp;
            }
            set
            {
                upd_v_option("txtReport_Tructiep_gtgt", value);
            }
        }
        public string sys_report_thutrongoi
        {
            get
            {
                string atmp = get_v_option("txtReport_Trongoi").Trim();
                if (atmp == "")
                {
                    atmp = "v_bienlaithuvienphitrongoi.rpt";
                }
                return atmp;
            }
            set
            {
                upd_v_option("txtReport_Trongoi", value);
            }
        }
        public string sys_report_thutamung
        {
            get
            {
                string atmp = get_v_option("txtReport_Tamung").Trim();
                if (atmp == "")
                {
                    atmp = "v_bienlaitamung.rpt";
                }
                return atmp;
            }
            set
            {
                upd_v_option("txtReport_Tamung", value);
            }
        }
        public string sys_report_ravien
        {
            get
            {
                string atmp = get_v_option("txtReport_Ravien").Trim();
                if (atmp == "")
                {
                    atmp = "v_bienlaithuvienphint.rpt";
                }
                return atmp;
            }
            set
            {
                upd_v_option("txtReport_Ravien", value);
            }
        }
        public string sys_report_ravien_thuong
        {
            get
            {
                string atmp = get_v_option("txtReport_Ravien_Thuong").Trim();
                if (atmp == "")
                {
                    atmp = "v_bienlaithuvienphint_thuong.rpt";
                }
                return atmp;
            }
            set
            {
                upd_v_option("txtReport_Ravien_Thuong", value);
            }
        }
        public string sys_report_ravien_chi
        {
            get
            {
                string atmp = get_v_option("txtReport_Ravien_Chi").Trim();
                if (atmp == "")
                {
                    atmp = "v_bienlaithuvienphint_thuchi.rpt";
                }
                return atmp;
            }
            set
            {
                upd_v_option("txtReport_Ravien_Chi", value);
            }
        }

        public string sys_report_inhoantra
        {
            get
            {
                string atmp = get_v_option("txtInbienlaihoan").Trim();
                if (atmp == "")
                {
                    atmp = "v_phieuchi_hoantra.rpt";
                }
                return atmp;
            }
            set
            {
                upd_v_option("txtInbienlaihoan", value);
            }
        }

        //Them thong so de in chi tiet thu theo nhom.
        public string sys_report_ravien_ct
        {
            get
            {
                string atmp = get_v_option("chkReport_Ravien_ct").Trim();
                if (atmp == "")
                {
                    atmp = "0";
                }
                return atmp;
            }
            set
            {
                upd_v_option("chkReport_Ravien_ct", value);
            }
        }
        //Them thong so khong cho phep xem tong tien thu trong
        public string sys_khongchoxem_tongthu
        {
            get
            {
                string atmp = get_v_option("chkKhongxemtongthu").Trim();
                if (atmp == "")
                {
                    atmp = "0";
                }
                return atmp;
            }
            set
            {
                upd_v_option("chkKhongxemtongthu", value);
            }
        }
        public string sys_report_ravien_thuong_ct
        {
            get
            {
                string atmp = get_v_option("chkReport_Ravien_Thuong_ct").Trim();
                if (atmp == "")
                {
                    atmp = "0";
                }
                return atmp;
            }
            set
            {
                upd_v_option("chkReport_Ravien_Thuong_ct", value);
            }
        }
        public string sys_report_ravien_chi_ct
        {
            get
            {
                string atmp = get_v_option("chkReport_Ravien_Chi_ct").Trim();
                if (atmp == "")
                {
                    atmp = "0";
                }
                return atmp;
            }
            set
            {
                upd_v_option("chkReport_Ravien_Chi_ct", value);
            }
        }
        public string sys_write_xml
        {
            get
            {
                string atmp = get_v_option("chkSys_write_xml").Trim();
                if (atmp == "")
                {
                    atmp = "0";
                }
                return atmp;
            }
            set
            {
                upd_v_option("chkSys_write_xml", value);
            }
        }
        //End.
        public string sys_report_phieuchi
        {
            get
            {
                string atmp = get_v_option("txtReport_Phieuchi").Trim();
                if (atmp == "")
                {
                    atmp = "v_phieuchi.rpt";
                }
                return atmp;
            }
            set
            {
                upd_v_option("txtReport_Phieuchi", value);
            }
        }
        public string sys_report_trongoi
        {
            get
            {
                string atmp = get_v_option("txtReport_Trongoi").Trim();
                if (atmp == "")
                {
                    atmp = "v_trongoi.rpt";
                }
                return atmp;
            }
            set
            {
                upd_v_option("txtReport_Trongoi", value);
            }
        }
        public string sys_report_bhyt
        {
            get
            {
                string atmp = get_v_option("txtReport_BHYT").Trim();
                if (atmp == "")
                {
                    atmp = "v_bienlaithuvienphibhyt.rpt";
                }
                return atmp;
            }
            set
            {
                upd_v_option("txtReport_BHYT", value);
            }
        }

        public string sys_ketoantruong
        {
            get
            {
                string atmp = get_v_option("txtketoantruong").Trim();
                if (atmp == "")
                {
                    atmp = "";
                }
                return atmp;
            }
            set
            {
                upd_v_option("txtketoantruong", value);
            }
        }

        public string sys_maubienlai
        {
            get
            {
                string atmp = get_v_option(" txtmausobienlai").Trim();
                if (atmp == "")
                {
                    atmp = "";
                }
                return atmp;
            }
            set
            {
                upd_v_option(" txtmausobienlai", value);
            }
        }
        public string sys_masothue
        {
            get
            {
                string atmp = get_v_option(" txtmasothue").Trim();
                if (atmp == "")
                {
                    atmp = "";
                }
                return atmp;
            }
            set
            {
                upd_v_option(" txtmasothue", value);
            }
        }
        public string sys_sotaikhoan
        {
            get
            {
                string atmp = get_v_option(" txtsotaikhoan").Trim();
                if (atmp == "")
                {
                    atmp = "";
                }
                return atmp;
            }
            set
            {
                upd_v_option(" txtsotaikhoan", value);
            }
        }
        public string sys_diachi
        {
            get
            {
                string atmp = get_v_option(" txtdiachi").Trim();
                if (atmp == "")
                {
                    atmp = "";
                }
                return atmp;
            }
            set
            {
                upd_v_option(" txtdiachi", value);
            }
        }

        public string sys_sokichhoat
        {
            get
            {
                string atmp = get_v_option(" txtSokichhoat").Trim();
                if (atmp == "")
                {
                    atmp = "1";
                }
                return atmp;
            }
            set
            {
                upd_v_option(" txtSokichhoat", value);
            }
        }

        public string sys_sothang
        {
            get
            {
                string atmp = get_v_option(" txtsothang").Trim();
                if (atmp == "")
                {
                    atmp = "1";
                }
                return atmp;
            }
            set
            {
                upd_v_option(" txtsothang", value);
            }
        }
        #endregion

        #region OPTION FORM

        #region OPTION FROM
        public string s_loaiform_thutructiep
        {
            get
            {
                return "1";
            }
        }
        public string s_loaiform_thutamung
        {
            get
            {
                return "2";
            }
        }
        public string s_loaiform_thuchiravien
        {
            get
            {
                return "3";
            }
        }
        public string s_loaiform_thutrongoi
        {
            get
            {
                return "4";
            }
        }
        public string s_loaiform_phieuchi
        {
            get
            {
                return "5";
            }
        }
        public string s_loaiform_bhyt
        {
            get
            {
                return "6";
            }
        }
        public bool upd_optionform(decimal v_userid, decimal v_loai, string v_ma, string v_ten, string v_giatri)
        {
            sql = "update " + s_schemaroot + ".v_optionform" + s_dblink + " set ten=:v_ten,giatri=:v_giatri where userid=:v_userid and loai=:v_loai and ma=:v_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
            cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
            cmd.Parameters.Add("v_ma", NpgsqlDbType.Text).Value = v_ma;
            cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
            cmd.Parameters.Add("v_giatri", NpgsqlDbType.Text).Value = v_giatri;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schemaroot + ".v_optionform" + s_dblink + "(userid,loai,ma,ten,giatri) values(:v_userid,:v_loai,:v_ma,:v_ten,:v_giatri)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                    cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
                    cmd.Parameters.Add("v_ma", NpgsqlDbType.Text).Value = v_ma;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
                    cmd.Parameters.Add("v_giatri", NpgsqlDbType.Text).Value = v_giatri;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_optionform");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_loaitu(decimal v_id, decimal v_sotien, string v_ten, decimal v_ktt)
        {
            sql = "update v_loaitu" + s_dblink + " set sotien=:v_sotien,ten=:v_ten,ktt=:v_ktt where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
            cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
            cmd.Parameters.Add("v_ktt", NpgsqlDbType.Numeric).Value = v_ktt;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schemaroot + ".v_loaitu" + s_dblink + "(id,sotien,ten,ktt) values(:v_id,:v_sotien,:v_ten,:v_ktt)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
                    cmd.Parameters.Add("v_ktt", NpgsqlDbType.Numeric).Value = v_ktt;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_loaitu");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_option_locgiavp(decimal v_userid, decimal v_loai, string v_ten, string v_id_vp)
        {
            sql = "update " + s_schemaroot + ".v_option_locgiavp" + s_dblink + " set ten=:v_ten,id_vp=:v_id_vp where userid=:v_userid and loai=:v_loai";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
            cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
            cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
            cmd.Parameters.Add("v_id_vp", NpgsqlDbType.Varchar, 3000).Value = v_id_vp;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schemaroot + ".v_option_locgiavp" + s_dblink + "(userid,loai,ten,id_vp) values(:v_userid,:v_loai,:v_ten,:v_id_vp)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                    cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
                    cmd.Parameters.Add("v_id_vp", NpgsqlDbType.Varchar, 3000).Value = v_id_vp;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_option_locgiavp");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_option_thutheonhom(decimal v_id, decimal v_userid, decimal v_stt, string v_ten, string v_id_vp)
        {
            sql = "update " + s_schemaroot + ".v_option_thutheonhom" + s_dblink + " set stt=:v_stt,ten=:v_ten,id_vp=:v_id_vp where userid=:v_userid and id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
            cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
            cmd.Parameters.Add("v_ten", NpgsqlDbType.Text, 50).Value = v_ten;
            cmd.Parameters.Add("v_id_vp", NpgsqlDbType.Varchar, 1000).Value = v_id_vp;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schemaroot + ".v_option_thutheonhom" + s_dblink + "(id,userid,stt,ten,id_vp) values(:v_id,:v_userid,:v_stt,:v_ten,:v_id_vp)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                    cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
                    cmd.Parameters.Add("v_id_vp", NpgsqlDbType.Varchar, 1000).Value = v_id_vp;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_option_thutheonhom");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool sys_quyen_suatuychon(string v_userid)
        {
            try
            {
                return get_data("select chon from medibv.v_phanquyen" + s_dblink + " where chon=1 and menuname ='menu_C_3_Tuychon' and  userid=" + v_userid + " limit 1").Tables[0].Rows.Count > 0;
            }
            catch
            {
                return false;
            }
        }
        //1
        public bool get_o_multiline_frmchonvp(string v_userid)
        {
            try
            {
                return get_data("select giatri from medibv.v_optionform" + s_dblink + " where userid=" + v_userid + " and loai=1 and ma='1'").Tables[0].Rows[0][0].ToString() == "1";
            }
            catch
            {
                return false;
            }
        }
        public void set_o_multiline_frmchonvp(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "1", "frmchonvp.multiline", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //2
        public bool get_o_fullscreen_frmthutructiep(string v_userid)
        {
            try
            {
                return get_data("select giatri from medibv.v_optionform" + s_dblink + " where userid=" + v_userid + " and loai=1 and ma='2'").Tables[0].Rows[0][0].ToString() == "1";
            }
            catch
            {
                return false;
            }
        }
        public void set_o_fullscreen_frmthutructiep(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "2", "frmthutructiep.fullscreen", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //3
        public bool get_o_fullgrid_frmthutructiep(string v_userid)
        {
            try
            {
                return get_data("select giatri from medibv.v_optionform" + s_dblink + " where userid=" + v_userid + " and loai=1 and ma='3'").Tables[0].Rows[0][0].ToString() == "1";
            }
            catch
            {
                return false;
            }
        }
        public void set_o_fullgrid_frmthutructiep(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "3", "frmthutructiep.fullgrid", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //4
        public bool get_o_fullgrid_frmtimbenhnhan(string v_userid)
        {
            try
            {
                return get_data("select giatri from medibv.v_optionform" + s_dblink + " where userid=" + v_userid + " and loai=1 and ma='4'").Tables[0].Rows[0][0].ToString() == "1";
            }
            catch
            {
                return false;
            }
        }
        public void set_o_fullgrid_frmtimbenhnhan(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "4", "frmtimbenhnhan.fullgrid", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //5
        public bool get_o_fullgrid_frmtimhoadon(string v_userid)
        {
            try
            {
                return get_data("select giatri from medibv.v_optionform" + s_dblink + " where userid=" + v_userid + " and loai=1 and ma='5'").Tables[0].Rows[0][0].ToString() == "1";
            }
            catch
            {
                return false;
            }
        }
        public void set_o_fullgrid_frmtimhoadon(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "5", "frmtimhoadon.fullgrid", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //6
        public bool get_o_fullgrid_frmdanhsachthutructiep(string v_userid)
        {
            try
            {
                return get_data("select giatri from medibv.v_optionform" + s_dblink + " where userid=" + v_userid + " and loai=1 and ma='6'").Tables[0].Rows[0][0].ToString() == "1";
            }
            catch
            {
                return false;
            }
        }
        public void set_o_fullgrid_frmdanhsachthutructiep(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "6", "frmdanhsachthutructiep.fullgrid", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //7
        public bool get_o_fullgrid_frmdanhsachchothutructiep(string v_userid)
        {
            try
            {
                return get_data("select giatri from medibv.v_optionform" + s_dblink + " where userid=" + v_userid + " and loai=1 and ma='7'").Tables[0].Rows[0][0].ToString() == "1";
            }
            catch
            {
                return false;
            }
        }
        public void set_o_fullgrid_frmdanhsachchothutructiep(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "7", "frmdanhsachchothutructiep.fullgrid", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //8
        public int get_o_limit_frmtimbenhnhan(string v_userid)
        {
            try
            {
                return int.Parse(get_data("select giatri from medibv.v_optionform" + s_dblink + " where userid=" + v_userid + " and loai=1 and ma='8'").Tables[0].Rows[0][0].ToString());
            }
            catch
            {
                return 100;
            }
        }
        public void set_o_limit_frmtimbenhnhan(string v_userid, string v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "8", "frmtimbenhnhan.limit", v_giatri);
            }
            catch
            {
            }
        }
        //9
        public int get_o_limit_frmtimhoadon(string v_userid)
        {
            try
            {
                return int.Parse(get_data("select giatri from medibv.v_optionform" + s_dblink + " where userid=" + v_userid + " and loai=1 and ma='9'").Tables[0].Rows[0][0].ToString());
            }
            catch
            {
                return 0;
            }
        }
        public void set_o_limit_frmtimhoadon(string v_userid, string v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "9", "frmtimhoadon.limit", v_giatri);
            }
            catch
            {
            }
        }
        //10
        public int get_o_limit_frmdanhsachthutructiep(string v_userid)
        {
            try
            {
                return int.Parse(get_data("select giatri from medibv.v_optionform" + s_dblink + " where userid=" + v_userid + " and loai=1 and ma='10'").Tables[0].Rows[0][0].ToString());
            }
            catch
            {
                return 0;
            }
        }
        public void set_o_limit_frmdanhsachthutructiep(string v_userid, string v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "10", "frmdanhsachthutructiep.limit", v_giatri);
            }
            catch
            {
            }
        }
        //11
        public int get_o_limit_frmdanhsachchothutructiep(string v_userid)
        {
            try
            {
                return int.Parse(get_data("select giatri from medibv.v_optionform" + s_dblink + " where userid=" + v_userid + " and loai=1 and ma='11'").Tables[0].Rows[0][0].ToString());
            }
            catch
            {
                return 100;
            }
        }
        public void set_o_limit_frmdanhsachchothutructiep(string v_userid, string v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "11", "frmdanhsachchothutructiep.limit", v_giatri);
            }
            catch
            {
            }
        }
        //12
        public bool get_o_fullgrid_frmhoantra(string v_userid)
        {
            try
            {
                return get_data("select giatri from medibv.v_optionform" + s_dblink + " where userid=" + v_userid + " and loai=1 and ma='12'").Tables[0].Rows[0][0].ToString() == "1";
            }
            catch
            {
                return false;
            }
        }
        public void set_o_fullgrid_frmhoantra(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "12", "frmhoantra.fullgrid", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //14
        public bool get_o_fullgrid_frmhoantra_h(string v_userid)
        {
            try
            {
                return get_data("select giatri from medibv.v_optionform" + s_dblink + " where userid=" + v_userid + " and loai=1 and ma='14'").Tables[0].Rows[0][0].ToString() == "1";
            }
            catch
            {
                return false;
            }
        }
        public void set_o_fullgrid_frmhoantra_h(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "14", "frmhoantra.fullgrid_h", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //13
        public bool get_o_fullgrid_frmhoantrachitiet(string v_userid)
        {
            try
            {
                return get_data("select giatri from medibv.v_optionform" + s_dblink + " where userid=" + v_userid + " and loai=1 and ma='13'").Tables[0].Rows[0][0].ToString() == "1";
            }
            catch
            {
                return false;
            }
        }
        public void set_o_fullgrid_frmhoantrachitiet(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "13", "frmhoantrachitiet.fullgrid", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //15
        public bool get_o_fullgrid_frmhoantrachitiet_1(string v_userid)
        {
            try
            {
                return get_data("select giatri from medibv.v_optionform" + s_dblink + " where userid=" + v_userid + " and loai=1 and ma='15'").Tables[0].Rows[0][0].ToString() == "1";
            }
            catch
            {
                return false;
            }
        }
        public void set_o_fullgrid_frmhoantrachitiet_1(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "15", "frmhoantrachitiet.fullgrid_1", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //16
        public bool get_o_fullgrid_frmhoantrachitiet_h(string v_userid)
        {
            try
            {
                return get_data("select giatri from medibv.v_optionform" + s_dblink + " where userid=" + v_userid + " and loai=1 and ma='16'").Tables[0].Rows[0][0].ToString() == "1";
            }
            catch
            {
                return false;
            }
        }
        public void set_o_fullgrid_frmhoantrachitiet_h(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "16", "frmhoantrachitiet.fullgrid_h", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //17
        public int get_o_limit_frmhoantra(string v_userid)
        {
            try
            {
                return int.Parse(get_data("select giatri from medibv.v_optionform" + s_dblink + " where userid=" + v_userid + " and loai=1 and ma='17'").Tables[0].Rows[0][0].ToString());
            }
            catch
            {
                return 100;
            }
        }
        public void set_o_limit_frmhoantra(string v_userid, string v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "17", "frmhoantra.limit", v_giatri);
            }
            catch
            {
            }
        }
        //18
        public bool get_o_show_hotkey_frmthutructiep(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform" + s_dblink + " where userid=" + v_userid + " and loai=1 and ma='18'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_show_hotkey_frmthutructiep(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "18", "frmthutructiep.show_hotkey", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //19
        public bool get_o_luuin_hoadon_frmthutructiep(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform" + s_dblink + " where userid=" + v_userid + " and loai=1 and ma='19'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_luuin_hoadon_frmthutructiep(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "19", "frmthutructiep.luuin_hoadon", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //20
        public bool get_o_luuin_chiphi_frmthutructiep(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform" + s_dblink + " where userid=" + v_userid + " and loai=1 and ma='20'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_luuin_chiphi_frmthutructiep(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "20", "frmthutructiep.luuin_chiphi", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //21
        public bool get_o_xemtruockhiin_frmthutructiep(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform" + s_dblink + " where userid=" + v_userid + " and loai=1 and ma='21'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_xemtruockhiin_frmthutructiep(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "21", "frmthutructiep.luuin_chiphi", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //22
        public bool get_o_fullgrid_frmthutamung(string v_userid)
        {
            try
            {
                return get_data("select giatri from medibv.v_optionform" + s_dblink + " where userid=" + v_userid + " and loai=1 and ma='22'").Tables[0].Rows[0][0].ToString() == "1";
            }
            catch
            {
                return false;
            }
        }
        public void set_o_fullgrid_frmthutamung(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "22", "frmthutamung.fullgrid", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //23
        public int get_o_dgheight_frmthutamung(string v_userid)
        {
            try
            {
                int atmp = int.Parse(get_data("select giatri from medibv.v_optionform" + s_dblink + " where userid=" + v_userid + " and loai=1 and ma='23'").Tables[0].Rows[0][0].ToString());
                if (atmp < 30)
                {
                    atmp = 125;
                }
                return atmp;
            }
            catch
            {
                return 125;
            }
        }
        public void set_o_dgheight_frmthutamung(string v_userid, int v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "23", "frmthutamung.dgheight", v_giatri.ToString());
            }
            catch
            {
            }
        }
        //24
        public bool get_o_xemlaihoadon_frmthutamung(string v_userid)
        {
            try
            {
                return get_data("select giatri from medibv.v_optionform" + s_dblink + " where userid=" + v_userid + " and loai=1 and ma='24'").Tables[0].Rows[0][0].ToString() == "1";
            }
            catch
            {
                return true;
            }
        }
        public void set_o_xemlaihoadon_frmthutamung(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "24", "frmthutamung.xemlaihoadon", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //25
        public bool get_o_xemlaidanhsach_frmthutamung(string v_userid)
        {
            try
            {
                return get_data("select giatri from medibv.v_optionform" + s_dblink + " where userid=" + v_userid + " and loai=1 and ma='25'").Tables[0].Rows[0][0].ToString() == "1";
            }
            catch
            {
                return true;
            }
        }
        public void set_o_xemlaidanhsach_frmthutamung(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "25", "frmthutamung.xemlaidanhsach", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //26
        public bool get_o_fullgrid_frmdanhsachthutamung(string v_userid)
        {
            try
            {
                return get_data("select giatri from medibv.v_optionform" + s_dblink + " where userid=" + v_userid + " and loai=1 and ma='26'").Tables[0].Rows[0][0].ToString() == "1";
            }
            catch
            {
                return false;
            }
        }
        public void set_o_fullgrid_frmdanhsachthutamung(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "26", "frmdanhsachthutamung.fullgrid", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }

        //27
        public int get_o_limit_frmdanhsachthutamung(string v_userid)
        {
            try
            {
                return int.Parse(get_data("select giatri from medibv.v_optionform" + s_dblink + " where userid=" + v_userid + " and loai=1 and ma='27'").Tables[0].Rows[0][0].ToString());
            }
            catch
            {
                return 0;
            }
        }
        public void set_o_limit_frmdanhsachthutamung(string v_userid, string v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "27", "frmdanhsachthutamung.limit", v_giatri);
            }
            catch
            {
            }
        }
        //28
        public bool get_o_luuin_frmthutamung(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform" + s_dblink + " where userid=" + v_userid + " and loai=1 and ma='28'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_luuin_frmthutamung(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "28", "frmthutamung.luuin", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //29
        public bool get_o_xemtruockhiin_frmthutamung(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform" + s_dblink + " where userid=" + v_userid + " and loai=1 and ma='29'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_xemtruockhiin_frmthutamung(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "29", "frmthutamung.luuin_chiphi", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //30
        public bool get_o_locsotheoloai_frmthutructiep(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform" + s_dblink + " where userid=" + v_userid + " and loai=1 and ma='30'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_locsotheoloai_frmthutructiep(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "30", "frmthutructiep.luuin_chiphi", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //31
        public bool get_o_show_hotkey_ksk_frmthutructiep(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform" + s_dblink + " where userid=" + v_userid + " and loai=1 and ma='31'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return false;
            }
        }
        public void set_o_show_hotkey_ksk_frmthutructiep(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "31", "frmthutructiep.show_hotkey_ksk", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //32
        public bool get_o_addall_hotkey_frmthutructiep(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform" + s_dblink + " where userid=" + v_userid + " and loai=1 and ma='32'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_addall_hotkey_frmthutructiep(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "32", "frmthutructiep.show_addall_hotkey", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //33
        public bool get_o_show_hotkey_toolbar_frmthutructiep(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform" + s_dblink + " where userid=" + v_userid + " and loai=1 and ma='33'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_show_hotkey_toolbar_frmthutructiep(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "33", "frmthutructiep.show_hotkey_toolbar", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //34
        public bool get_o_luuin_frmhoantra(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform" + s_dblink + " where userid=" + v_userid + " and loai=1 and ma='34'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_luuin_frmhoantra(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "34", "frm_hoantra.luuin", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //35
        public bool get_o_preview_frmhoantra(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform" + s_dblink + " where userid=" + v_userid + " and loai=1 and ma='35'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_preview_frmhoantra(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "35", "frm_hoantra.preview", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //36
        public bool get_o_fullgrid_frmsuahoadon(string v_userid)
        {
            try
            {
                return get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='36'").Tables[0].Rows[0][0].ToString() == "1";
            }
            catch
            {
                return false;
            }
        }
        public void set_o_fullgrid_frmsuahoadon(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "36", "frmsuahoadon.fullgrid", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //37
        public int get_o_limit_frmsuahoadon(string v_userid)
        {
            try
            {
                return int.Parse(get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='37'").Tables[0].Rows[0][0].ToString());
            }
            catch
            {
                return 100;
            }
        }
        public void set_o_limit_frmsuahoadon(string v_userid, string v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "37", "frmsuahoadon.limit", v_giatri);
            }
            catch
            {
            }
        }
        //38
        public bool get_o_fullgrid_frmdanhsachchothutamung(string v_userid)
        {
            try
            {
                return get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='38'").Tables[0].Rows[0][0].ToString() == "1";
            }
            catch
            {
                return false;
            }
        }
        public void set_o_fullgrid_frmdanhsachchothutamung(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "38", "frmdanhsachchothutamung.fullgrid", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //39
        public int get_o_limit_frmdanhsachchothutamung(string v_userid)
        {
            try
            {
                return int.Parse(get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='39'").Tables[0].Rows[0][0].ToString());
            }
            catch
            {
                return 100;
            }
        }
        public void set_o_limit_frmdanhsachchothutamung(string v_userid, string v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "39", "frmdanhsachchothutamung.limit", v_giatri);
            }
            catch
            {
            }
        }
        //40
        public bool get_o_fullgridhd_frmthutamung(string v_userid)
        {
            try
            {
                return get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='40'").Tables[0].Rows[0][0].ToString() == "1";
            }
            catch
            {
                return false;
            }
        }
        public void set_o_fullgridhd_frmthutamung(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "40", "frmthutamung.fullgridhd", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //41
        public bool get_o_fullscreen_frmthutrongoi(string v_userid)
        {
            try
            {
                return get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='41'").Tables[0].Rows[0][0].ToString() == "1";
            }
            catch
            {
                return false;
            }
        }
        public void set_o_fullscreen_frmthutrongoi(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "41", "frmthutrongoi.fullscreen", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //42
        public bool get_o_fullgrid_frmthutrongoi(string v_userid)
        {
            try
            {
                return get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='42'").Tables[0].Rows[0][0].ToString() == "1";
            }
            catch
            {
                return false;
            }
        }
        public void set_o_fullgrid_frmthutrongoi(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "42", "frmthutrongoi.fullgrid", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //43
        public bool get_o_fullgrid_frmdanhsachthutrongoi(string v_userid)
        {
            try
            {
                return get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='43'").Tables[0].Rows[0][0].ToString() == "1";
            }
            catch
            {
                return false;
            }
        }
        public void set_o_fullgrid_frmdanhsachthutrongoi(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "43", "frmdanhsachthutrongoi.fullgrid", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //44
        public bool get_o_fullgrid_frmdanhsachchothutrongoi(string v_userid)
        {
            try
            {
                return get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='44'").Tables[0].Rows[0][0].ToString() == "1";
            }
            catch
            {
                return false;
            }
        }
        public void set_o_fullgrid_frmdanhsachchothutrongoi(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "44", "frmdanhsachchothutrongoi.fullgrid", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //45
        public int get_o_limit_frmdanhsachthutrongoi(string v_userid)
        {
            try
            {
                return int.Parse(get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='45'").Tables[0].Rows[0][0].ToString());
            }
            catch
            {
                return 0;
            }
        }
        public void set_o_limit_frmdanhsachthutrongoi(string v_userid, string v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "45", "frmdanhsachthutrongoi.limit", v_giatri);
            }
            catch
            {
            }
        }
        //46
        public int get_o_limit_frmdanhsachchothutrongoi(string v_userid)
        {
            try
            {
                return int.Parse(get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='46'").Tables[0].Rows[0][0].ToString());
            }
            catch
            {
                return 100;
            }
        }
        public void set_o_limit_frmdanhsachchothutrongoi(string v_userid, string v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "46", "frmdanhsachchothutrongoi.limit", v_giatri);
            }
            catch
            {
            }
        }
        //47
        public bool get_o_show_hotkey_frmthutrongoi(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='47'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_show_hotkey_frmthutrongoi(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "47", "frmthutrongoi.show_hotkey", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //48
        public bool get_o_luuin_hoadon_frmthutrongoi(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='48'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_luuin_hoadon_frmthutrongoi(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "48", "frmthutrongoi.luuin_hoadon", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //49
        public bool get_o_luuin_chiphi_frmthutrongoi(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='49'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_luuin_chiphi_frmthutrongoi(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "49", "frmthutrongoi.luuin_chiphi", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //50
        public bool get_o_xemtruockhiin_frmthutrongoi(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='50'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_xemtruockhiin_frmthutrongoi(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "50", "frmthutrongoi.luuin_chiphi", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //51
        public bool get_o_show_hotkey_ksk_frmthutrongoi(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='51'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return false;
            }
        }
        public void set_o_show_hotkey_ksk_frmthutrongoi(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "51", "frmthutrongoi.show_hotkey_ksk", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //52
        public bool get_o_addall_hotkey_frmthutrongoi(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='52'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_addall_hotkey_frmthutrongoi(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "52", "frmthutrongoi.show_addall_hotkey", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //53
        public bool get_o_show_hotkey_toolbar_frmthutrongoi(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='53'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_show_hotkey_toolbar_frmthutrongoi(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "53", "frmthutrongoi.show_hotkey_toolbar", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //54
        public bool get_o_fullscreen_frmthuchiravien(string v_userid)
        {
            try
            {
                return get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='54'").Tables[0].Rows[0][0].ToString() == "1";
            }
            catch
            {
                return false;
            }
        }
        public void set_o_fullscreen_frmthuchiravien(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "54", "frmthuchiravien.fullscreen", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //55
        public bool get_o_fullgrid_frmthuchiravien(string v_userid)
        {
            try
            {
                return get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='55'").Tables[0].Rows[0][0].ToString() == "1";
            }
            catch
            {
                return false;
            }
        }
        public void set_o_fullgrid_frmthuchiravien(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "55", "frmthuchiravien.fullgrid", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //56
        public bool get_o_fullgrid_frmdanhsachthuchiravien(string v_userid)
        {
            try
            {
                return get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='56'").Tables[0].Rows[0][0].ToString() == "1";
            }
            catch
            {
                return false;
            }
        }
        public void set_o_fullgrid_frmdanhsachthuchiravien(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "56", "frmdanhsachthuchiravien.fullgrid", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //57
        public bool get_o_fullgrid_frmdanhsachchothuchiravien(string v_userid)
        {
            try
            {
                return get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='57'").Tables[0].Rows[0][0].ToString() == "1";
            }
            catch
            {
                return false;
            }
        }
        public void set_o_fullgrid_frmdanhsachchothuchiravien(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "57", "frmdanhsachchothuchiravien.fullgrid", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //58
        public int get_o_limit_frmdanhsachthuchiravien(string v_userid)
        {
            try
            {
                return int.Parse(get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='58'").Tables[0].Rows[0][0].ToString());
            }
            catch
            {
                return 0;
            }
        }
        public void set_o_limit_frmdanhsachthuchiravien(string v_userid, string v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "58", "frmdanhsachthuchiravien.limit", v_giatri);
            }
            catch
            {
            }
        }
        //59
        public int get_o_limit_frmdanhsachchothuchiravien(string v_userid)
        {
            try
            {
                return int.Parse(get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='59'").Tables[0].Rows[0][0].ToString());
            }
            catch
            {
                return 100;
            }
        }
        public void set_o_limit_frmdanhsachchothuchiravien(string v_userid, string v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "59", "frmdanhsachchothuchiravien.limit", v_giatri);
            }
            catch
            {
            }
        }
        //60
        public bool get_o_show_hotkey_frmthuchiravien(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='60'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_show_hotkey_frmthuchiravien(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "60", "frmthuchiravien.show_hotkey", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //61
        public bool get_o_luuin_hoadon_frmthuchiravien(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='61'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_luuin_hoadon_frmthuchiravien(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "61", "frmthuchiravien.luuin_hoadon", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }

        //62
        public bool get_o_luuin_chiphi_frmthuchiravien(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='62'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_luuin_chiphi_frmthuchiravien(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "62", "frmthuchiravien.luuin_chiphi", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //63
        public bool get_o_xemtruockhiin_frmthuchiravien(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='63'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_xemtruockhiin_frmthuchiravien(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "63", "frmthuchiravien.luuin_chiphi", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //64
        public bool get_o_locsotheoloai_frmthuchiravien(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='64'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_locsotheoloai_frmthuchiravien(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "64", "frmthuchiravien.luuin_chiphi", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //65
        public bool get_o_show_hotkey_ksk_frmthuchiravien(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='65'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return false;
            }
        }
        public void set_o_show_hotkey_ksk_frmthuchiravien(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "65", "frmthuchiravien.show_hotkey_ksk", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //66
        public bool get_o_addall_hotkey_frmthuchiravien(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='66'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_addall_hotkey_frmthuchiravien(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "66", "frmthuchiravien.show_addall_hotkey", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //67
        public bool get_o_show_hotkey_toolbar_frmthuchiravien(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='67'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_show_hotkey_toolbar_frmthuchiravien(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "67", "frmthuchiravien.show_hotkey_toolbar", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //68
        public bool get_o_xemtonghoptheoloai_frmthuchiravien(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='68'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return false;
            }
        }
        public void set_o_xemtonghoptheoloai_frmthuchiravien(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "68", "frmthuchiravien.xemtonghoptheoloai", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //69
        public bool get_o_luuin_phieuthuphieuchi_frmthuchiravien(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='69'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_luuin_phieuthuphieuchi_frmthuchiravien(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "69", "frmthuchiravien.luuin_phieuthuphieuchi", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //70
        public bool get_o_luuin_hoadon_chitiet_frmthutrongoi(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='70'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_luuin_hoadon_chitiet_frmthutrongoi(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "70", "frmthutrongoi.luuin_hoadon_chitiet_trongoi", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //71
        public bool get_o_luuin_frmthuchiravien(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='71'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_luuin_frmthuchiravien(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "71", "frmthuchiravien.luuin", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //72
        public bool get_o_luuin_frmthutructiep(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='72'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_luuin_frmthutructiep(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "72", "frmthutructiep.luuin", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //73
        public bool get_o_luuin_frmthutrongoi(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='73'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_luuin_frmthutrongoi(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "73", "frmthutrongoi.luuin", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //74
        public bool get_o_fullscreen_frmphieuchi(string v_userid)
        {
            try
            {
                return get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='74'").Tables[0].Rows[0][0].ToString() == "1";
            }
            catch
            {
                return false;
            }
        }
        public void set_o_fullscreen_frmphieuchi(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "74", "frmphieuchi.fullscreen", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //75
        public bool get_o_fullgrid_frmphieuchi(string v_userid)
        {
            try
            {
                return get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='75'").Tables[0].Rows[0][0].ToString() == "1";
            }
            catch
            {
                return false;
            }
        }
        public void set_o_fullgrid_frmphieuchi(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "75", "frmphieuchi.fullgrid", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //76
        public bool get_o_fullgrid_frmdanhsachphieuchi(string v_userid)
        {
            try
            {
                return get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='76'").Tables[0].Rows[0][0].ToString() == "1";
            }
            catch
            {
                return false;
            }
        }
        public void set_o_fullgrid_frmdanhsachphieuchi(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "76", "frmdanhsachphieuchi.fullgrid", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //77
        public bool get_o_fullgrid_frmdanhsachchophieuchi(string v_userid)
        {
            try
            {
                return get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='77'").Tables[0].Rows[0][0].ToString() == "1";
            }
            catch
            {
                return false;
            }
        }
        public void set_o_fullgrid_frmdanhsachchophieuchi(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "77", "frmdanhsachchophieuchi.fullgrid", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //78
        public int get_o_limit_frmdanhsachphieuchi(string v_userid)
        {
            try
            {
                return int.Parse(get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='78'").Tables[0].Rows[0][0].ToString());
            }
            catch
            {
                return 0;
            }
        }
        public void set_o_limit_frmdanhsachphieuchi(string v_userid, string v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "78", "frmdanhsachphieuchi.limit", v_giatri);
            }
            catch
            {
            }
        }
        //79
        public int get_o_limit_frmdanhsachchophieuchi(string v_userid)
        {
            try
            {
                return int.Parse(get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='79'").Tables[0].Rows[0][0].ToString());
            }
            catch
            {
                return 100;
            }
        }
        public void set_o_limit_frmdanhsachchophieuchi(string v_userid, string v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "79", "frmdanhsachchophieuchi.limit", v_giatri);
            }
            catch
            {
            }
        }
        //80
        public bool get_o_show_hotkey_frmphieuchi(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='80'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_show_hotkey_frmphieuchi(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "80", "frmphieuchi.show_hotkey", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //81
        public bool get_o_luuin_hoadon_frmphieuchi(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='81'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_luuin_hoadon_frmphieuchi(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "81", "frmphieuchi.luuin_hoadon", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //82
        public bool get_o_luuin_chiphi_frmphieuchi(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='82'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_luuin_chiphi_frmphieuchi(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "82", "frmphieuchi.luuin_chiphi", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //83
        public bool get_o_xemtruockhiin_frmphieuchi(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='83'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_xemtruockhiin_frmphieuchi(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "83", "frmphieuchi.luuin_chiphi", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //84
        public bool get_o_locsotheoloai_frmphieuchi(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='84'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_locsotheoloai_frmphieuchi(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "84", "frmphieuchi.luuin_chiphi", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //85
        public bool get_o_show_hotkey_ksk_frmphieuchi(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='85'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return false;
            }
        }
        public void set_o_show_hotkey_ksk_frmphieuchi(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "85", "frmphieuchi.show_hotkey_ksk", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //86
        public bool get_o_addall_hotkey_frmphieuchi(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='86'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_addall_hotkey_frmphieuchi(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "86", "frmphieuchi.show_addall_hotkey", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //87
        public bool get_o_show_hotkey_toolbar_frmphieuchi(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='87'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_show_hotkey_toolbar_frmphieuchi(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "87", "frmphieuchi.show_hotkey_toolbar", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //88
        public bool get_o_luuin_frmphieuchi(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='88'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_luuin_frmphieuchi(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "88", "frmphieuchi.luuin", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //89
        public bool get_o_luuin_hoadon_frmthutamung(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='89'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_luuin_hoadon_frmthutamung(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "89", "frmthutamung.luuin_hoadon", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //90
        public bool get_o_luuin_hoadon_chitiet_frmthutamung(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='90'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_luuin_hoadon_chitiet_frmthutamung(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "90", "frmthutamung.luuin_hoadon_chitiet", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //91
        public int get_o_pchitiet_width_frmthutamung(string v_userid)
        {
            try
            {
                return int.Parse(get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='91'").Tables[0].Rows[0][0].ToString());
            }
            catch
            {
                return 240;
            }
        }
        public void set_o_pchitiet_width_frmthutamung(string v_userid, int v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "91", "frmthutamung.pchitiet_width", v_giatri.ToString());
            }
            catch
            {
            }
        }
        //92
        public bool get_o_fullscreen_frmvienphiBHYT(string v_userid)
        {
            try
            {
                return get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='92'").Tables[0].Rows[0][0].ToString() == "1";
            }
            catch
            {
                return false;
            }
        }
        public void set_o_fullscreen_frmvienphiBHYT(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "54", "frmvienphiBHYT.fullscreen", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //93
        public bool get_o_fullgrid_frmvienphiBHYT(string v_userid)
        {
            try
            {
                return get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='93'").Tables[0].Rows[0][0].ToString() == "1";
            }
            catch
            {
                return false;
            }
        }
        public void set_o_fullgrid_frmvienphiBHYT(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "93", "frmvienphiBHYT.fullgrid", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //94
        public bool get_o_fullgrid_frmdanhsachBHYT(string v_userid)
        {
            try
            {
                return get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='94'").Tables[0].Rows[0][0].ToString() == "1";
            }
            catch
            {
                return false;
            }
        }
        public void set_o_fullgrid_frmdanhsachBHYT(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "94", "frmdanhsachBHYT.fullgrid", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //95
        public bool get_o_fullgrid_frmdanhsachchoBHYT(string v_userid)
        {
            try
            {
                return get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='95'").Tables[0].Rows[0][0].ToString() == "1";
            }
            catch
            {
                return false;
            }
        }
        public void set_o_fullgrid_frmdanhsachchoBHYT(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "95", "frmdanhsachchoBHYT.fullgrid", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //96
        public int get_o_limit_frmdanhsachBHYT(string v_userid)
        {
            try
            {
                return int.Parse(get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='96'").Tables[0].Rows[0][0].ToString());
            }
            catch
            {
                return 0;
            }
        }
        public void set_o_limit_frmdanhsachBHYT(string v_userid, string v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "96", "frmdanhsachBHYT.limit", v_giatri);
            }
            catch
            {
            }
        }
        //97
        public int get_o_limit_frmdanhsachchoBHYT(string v_userid)
        {
            try
            {
                return int.Parse(get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='97'").Tables[0].Rows[0][0].ToString());
            }
            catch
            {
                return 100;
            }
        }
        public void set_o_limit_frmdanhsachchoBHYT(string v_userid, string v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "97", "frmdanhsachchoBHYT.limit", v_giatri);
            }
            catch
            {
            }
        }
        //98
        public bool get_o_show_hotkey_frmvienphiBHYT(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='98'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_show_hotkey_frmvienphiBHYT(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "98", "frmvienphiBHYT.show_hotkey", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //99
        public bool get_o_luuin_hoadon_frmvienphiBHYT(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='99'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_luuin_hoadon_frmvienphiBHYT(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "99", "frmvienphiBHYT.luuin_hoadon", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //100
        public bool get_o_luuin_chiphi_frmvienphiBHYT(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='100'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_luuin_chiphi_frmvienphiBHYT(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "100", "frmvienphiBHYT.luuin_chiphi", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //101
        public bool get_o_xemtruockhiin_frmvienphiBHYT(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='101'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_xemtruockhiin_frmvienphiBHYT(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "101", "frmvienphiBHYT.luuin_chiphi", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //102
        public bool get_o_locsotheoloai_frmvienphiBHYT(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='102'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_locsotheoloai_frmvienphiBHYT(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "102", "frmvienphiBHYT.luuin_chiphi", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //103
        public bool get_o_show_hotkey_ksk_frmvienphiBHYT(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='103'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return false;
            }
        }
        public void set_o_show_hotkey_ksk_frmvienphiBHYT(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "103", "frmvienphiBHYT.show_hotkey_ksk", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //104
        public bool get_o_addall_hotkey_frmvienphiBHYT(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='104'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_addall_hotkey_frmvienphiBHYT(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "104", "frmvienphiBHYT.show_addall_hotkey", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //105
        public bool get_o_show_hotkey_toolbar_frmvienphiBHYT(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='105'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_show_hotkey_toolbar_frmvienphiBHYT(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "105", "frmvienphiBHYT.show_hotkey_toolbar", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //106
        public bool get_o_xemtonghoptheoloai_frmvienphiBHYT(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='106'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return false;
            }
        }
        public void set_o_xemtonghoptheoloai_frmvienphiBHYT(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "106", "frmvienphiBHYT.xemtonghoptheoloai", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //107
        public bool get_o_luuin_phieuthuphieuchi_frmvienphiBHYT(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='107'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_luuin_phieuthuphieuchi_frmvienphiBHYT(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "107", "frmvienphiBHYT.luuin_phieuthuphieuchi", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //108
        public bool get_o_luuin_frmvienphiBHYT(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='108'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_luuin_frmvienphiBHYT(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "108", "frmvienphiBHYT.luuin", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //109
        public bool get_o_luuin_mau38_frmvienphiBHYT(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='109'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_luuin_mau38_frmvienphiBHYT(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "109", "frmvienphiBHYT.tmn_inmau38bv", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }

        public string get_v_optionform(int v_loai, string v_userid, string v_ma)
        {
            try
            {
                return get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=" + v_loai.ToString() + " and ma='" + v_ma + "'").Tables[0].Rows[0][0].ToString().Trim();
            }
            catch
            {
                return "";
            }
        }
        public void set_v_optionform(int v_loai, string v_userid, string v_ma, bool v_val)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), decimal.Parse(v_loai.ToString()), v_ma, "", v_val ? "1" : "0");
            }
            catch
            {
            }
        }
        //109 
        public bool get_o_luuin_hoadon_frmthutonghop(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='109'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }

        public void set_o_luuin_hoadon_frmthutonghop(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "109", "frmthuchiravien.luuin_hoadon", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //200
        public bool get_o_xemtruockhiin_frmthutonghop(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='200'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }

        public void set_o_xemtruockhiin_frmthutonghop(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "200", "frmthuchiravien.luuin_chiphi", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //201
        public bool get_o_luuin_frmthutonghop(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='201'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        public void set_o_luuin_frmthutonghop(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "201", "frmthuchiravien.luuin", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //202
        public bool get_o_luuin_chiphi_cadot_frmthutructiep(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='202'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return false;
            }
        }
        public void set_o_luuin_chiphi_cadot_frmthutructiep(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "202", "frmthutructiep.luuin_chiphi_cadot", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        //203
        public bool get_o_luu_nhacnho_khiluu(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform where userid=" + v_userid + " and loai=1 and ma='203'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return false;
            }
        }
        public void set_o_luu_nhacnho_khiluu(string v_userid, bool v_giatri)
        {
            try
            {
                upd_v_optionform(decimal.Parse(v_userid), 1, "203", "frmVienphiBHYT.nhacnho_khiluu", v_giatri ? "1" : "0");
            }
            catch
            {
            }
        }
        #endregion

        //Truc tiep ******************************************
        public bool tt_suahoadon(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_001") == "1";
        }
        public bool tt_suanoidunghoadon(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_002") == "1";
        }
        public bool tt_xoahoadon(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_003") == "1";
        }
        public bool tt_hoanhoadon(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_004") == "1";
        }
        public bool tt_gioihanvp(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_005") == "1";
        }
        public string tt_gioihan_mavp(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_005_MAVP");
        }
        public string tt_gioihan_mavp_noitru(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_016_MAVP");
        }
        public bool tt_nhapkhoaphong(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_006") == "1";
        }
        public bool tt_nhapbacsi(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_007") == "1";
        }
        public bool tt_nhaplydomien(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_008") == "1";
        }
        public bool tt_nhapduyetmien(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_009") == "1";
        }
        public bool bbhyt_nhaplydomien(string v_userid)
        {
            return get_v_optionform(1, v_userid, "BHYT_030") == "1";
        }
        public bool BHYTThu_nhacnho_ThuDichvu_tuchitra(string v_userid)
        {
            return get_v_optionform(1, v_userid, "BHYT_032") == "1";
        }
        public bool bbhyt_nhapduyetmien(string v_userid)
        {
            return get_v_optionform(1, v_userid, "BHYT_028") == "1";
        }

        public bool tt_thuchidinh(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_010") == "1";
        }
        public bool tt_thuchidinh_ngay(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_038") == "1";
        }
        public bool tt_thutoatutruc(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_011") == "1";
        }
        public bool tt_khongthutoatutruc_phongluu(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_040") == "1";
        }
        public bool tt_khongthutoatutruc_noitru(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_041") == "1";
        }
        public string tt_sobanin_hoadonct(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_042");
        }
        public bool tt_ingiaydenghi_miengiam(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_041") == "1";
        }
        public bool tt_thutoamuangoai(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_036") == "1";
        }
        public bool tt_thutoamuangoai_chuaduyet(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_107") == "1";
        }
        //Thuy 20.06.2012
        public bool tt_Thutungdonthuoc(string v_userid)
        {
            return get_v_optionform(1, v_userid, "chkThuTungDonThuoc") == "1";
        }
        public bool tt_trutamung(string v_userid)
        {
            // gam
            return get_v_optionform(1, v_userid, "TT_108") == "1";
        }
        public bool tt_TachhoadonGTGT_theoVAT(string v_userid)
        {
            // binh 120912
            return get_v_optionform(1, v_userid, "TT_109") == "1";
        }

        public bool tt_phuthudonthuocBHYT(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_037") == "1";
        }

        public bool tt_thuvienphikhoa(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_019") == "1";
        }
        public bool tt_thuchenhlech(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_017") == "1";
        }
        public bool tt_chonhapmoi(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_012") == "1";
        }
        public bool tt_mabntudong(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_018") == "1";
        }
        public bool tt_chokhongquatiepdon(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_013") == "1";
        }
        public bool tt_cokhambenh(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_014") == "1";
        }
        public bool tt_conamluu(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_015") == "1";
        }
        public bool tt_conhanbenh(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_016") == "1";
        }
        public bool tt_congoaitru(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_104") == "1";
        }
        public bool tt_thutheonhom(string v_userid)
        {
            return get_v_optionform(1, v_userid, "chkTachbienlai_nhomvp") == "1";
        }
        public bool tt_thutheoloai(string v_userid)
        {
            return get_v_optionform(1, v_userid, "chkTachbienlai_loaivp") == "1";
        }
        public bool tt_Intheonhom(string v_userid)
        {
            return get_v_optionform(1, v_userid, "chkinHDtheo_nhom") == "1";
        }
        public bool tt_Intheoloai(string v_userid)
        {
            return get_v_optionform(1, v_userid, "chkinHDtheo_loai") == "1";
        }
        public bool tt_InchitietHD(string v_userid)
        {
            return get_v_optionform(1, v_userid, "chkInchitiet") == "1";
        }
        public bool tt_InHD_thuong(string v_userid)
        {
            return get_v_optionform(1, v_userid, "ToolStripMenuItem_thuong") == "1";
        }

        public bool tt_InHDdacthu(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_020") == "1";
        }
        public bool tt_ChuyenCLSChuaquaChidinh(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_021") == "1";
        }
        public bool tt_Quanlymavach(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_022") == "1";
        }
        public bool tt_HoanHDchitiet(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_023") == "1";
        }
        public bool tt_Lamsangbandau(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_024") == "1";
        }
        public bool tt_Nhapbacsivpchidinh(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_025") == "1";
        }
        public bool tt_thutheoDT(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_026") == "1";
        }
        public string tt_Loaibn_thutructiep(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_027");
        }
        public string tt_tachhoadon_dichvu(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_106");
        }

        public bool tt_Thutheonamhinh(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_028") == "1";
        }
        public bool tt_Nhapgiavienphichuakhai(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_029") == "1";
        }
        public bool tt_Nhapmiengianchitiet(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_030") == "1";
        }
        public bool tt_Nhapmientheotungmon(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_031") == "1";
        }
        public bool tt_Miendt_loai(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_032") == "1";
        }
        public string tt_DoituongInhoadondichvu(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_034");
        }
        public string tt_khoathututruc(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_035");
        }
        public string tt_bienlai_gtgt(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_039");
        }
        public bool tt_khongthudichvu_hdthuong(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_101") == "1";
        }
        public bool tt_chithudichvu_hdthuong(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_102") == "1";
        }
        public bool tt_huyhoadon_dathuchien(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_103") == "1";
        }
        //*********************************************** Set thu truc tiep
        public void set_tt_suahoadon(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TT_001", v_val);
        }
        public void set_tt_suanoidunghoadon(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TT_002", v_val);
        }
        public void set_tt_xoahoadon(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TT_003", v_val);
        }
        public void set_tt_hoanhoadon(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TT_004", v_val);
        }
        public void set_tt_gioihanvp(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TT_005", v_val);
        }
        public void set_tt_nhapkhoaphong(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TT_006", v_val);
        }
        public void set_tt_nhapbacsi(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TT_007", v_val);
        }
        public void set_tt_nhaplydomien(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TT_008", v_val);
        }
        public void set_tt_nhapduyetmien(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TT_009", v_val);
        }
        public void set_bhyt_nhaplydomien(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "BHYT_029", v_val);
        }
        public void set_bhyt_nhapduyetmien(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "BHYT_028", v_val);
        }

        public void set_tt_thuchidinh(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TT_010", v_val);
        }
        public void set_tt_thuvienphikhoa(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TT_019", v_val);
        }
        public void set_tt_thutoatutruc(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TT_011", v_val);
        }
        public void set_tt_thuchenhlech(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TT_017", v_val);
        }
        public void set_tt_chonhapmoi(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TT_012", v_val);
        }
        public void set_tt_chokhongquatiepdon(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TT_013", v_val);
        }
        //
        public void set_tt_thutheonhom(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "chkTachbienlai_nhomvp", v_val);
        }
        public void set_tt_thutheoloai(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "chkTachbienlai_loaivp", v_val);
        }
        public void set_tt_Intheonhom(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "chkinHDtheo_nhom", v_val);
        }
        public void set_tt_Intheoloai(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "chkinHDtheo_loai", v_val);
        }
        public void set_tt_InchitietHD(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "chkInchitiet", v_val);
        }
        public void set_tt_InHD_thuong(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "ToolStripMenuItem_thuong", v_val);
        }
        public void set_tt_InHDdacthu(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TT_020", v_val);
        }
        public void set_tt_ChuyenCLSChuaquaChidinh(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TT_021", v_val);
        }
        public void set_tt_Quanlymavach(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TT_022", v_val);
        }
        public void set_tt_HoanHDchitiet(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TT_023", v_val);
        }
        public void set_tt_Lamsangbandau(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TT_024", v_val);
        }
        public void set_tt_Nhapbacsivpchidinh(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TT_025", v_val);
        }
        public void set_tt_thutheoDT(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TT_026", v_val);
        }
        public void set_tt_Thutheonamhinh(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TT_028", v_val);
        }
        public void set_tt_Nhapgiavienphichuakhai(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TT_029", v_val);
        }
        public void set_tt_Nhapmiengianchitiet(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TT_030", v_val);
        }
        public void set_tt_Nhapmientheotungmon(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TT_031", v_val);
        }
        public void set_tt_Miendt_loai(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TT_032", v_val);
        }
        public void set_tt_Hoantrakhidalam(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TT_033", v_val);
        }

        //Trongoi*************************************************************

        public bool tg_suahoadon(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TG_001") == "1";
        }
        public bool tg_suanoidunghoadon(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TG_002") == "1";
        }
        public bool tg_xoahoadon(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TG_003") == "1";
        }
        public bool tg_hoanhoadon(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TG_004") == "1";
        }
        public bool tg_gioihanvp(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TG_005") == "1";
        }
        public bool tg_nhapkhoaphong(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TG_006") == "1";
        }
        public bool tg_nhapbacsi(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TG_007") == "1";
        }
        public bool tg_nhaplydomien(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TG_008") == "1";
        }
        public bool tg_nhapduyetmien(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TG_009") == "1";
        }
        public bool tg_thuchidinh(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TG_010") == "1";
        }
        public bool tg_thuchenhlech(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TT_011") == "1";
        }
        public bool tg_chonhapmoi(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TG_012") == "1";
        }
        public bool tg_chokhongquatiepdon(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TG_013") == "1";
        }
        public bool tg_cokhambenh(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TG_014") == "1";
        }
        public bool tg_conamluu(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TG_015") == "1";
        }
        public bool tg_conhanbenh(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TG_016") == "1";
        }

        //SET TG*************************************************************
        public void set_tg_suahoadon(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TG_001", v_val);
        }
        public void set_tg_suanoidunghoadon(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TG_002", v_val);
        }
        public void set_tg_xoahoadon(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TG_003", v_val);
        }
        public void set_tg_hoanhoadon(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TG_004", v_val);
        }
        public void set_tg_gioihanvp(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TG_005", v_val);
        }
        public void set_tg_nhapkhoaphong(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TG_006", v_val);
        }
        public void set_tg_nhapbacsi(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TG_007", v_val);
        }
        public void set_tg_nhaplydomien(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TG_008", v_val);
        }
        public void set_tg_nhapduyetmien(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TG_009", v_val);
        }
        public void set_tg_thuchidinh(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TG_010", v_val);
        }
        public void set_tg_thuchenhlech(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TG11", v_val);
        }
        public void set_tg_chonhapmoi(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TG_012", v_val);
        }
        public void set_tg_chokhongquatiepdon(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TG_013", v_val);
        }


        //Tạm ứng *************************************************************
        public bool tu_suahoadon(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TU_001") == "1";
        }
        public bool tu_suanoidunghoadon(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TU_002") == "1";
        }
        public bool tu_xoahoadon(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TU_003") == "1";
        }
        public bool tu_hoanhoadon(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TU_004") == "1";
        }
        public bool tu_cotiepdon(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TU_005") == "1";
        }
        public bool tu_cokhambenh(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TU_006") == "1";
        }
        public bool tu_conamluu(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TU_007") == "1";
        }
        public bool tu_conhanbenh(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TU_008") == "1";
        }
        public bool tu_congoaitru(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TU_009") == "1";
        }
        public bool tu_theochidinh_khongsuatien(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TU_010") == "1";
        }
        public bool tu_xoahoadon_dain(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TU_011") == "1";
        }
        //TTRV *************************************************************
        public bool ttrv_suahoadon(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TTRV_001") == "1";
        }
        public bool ttrv_suanoidunghoadon(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TTRV_002") == "1";
        }
        public bool ttrv_xoahoadon(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TTRV_003") == "1";
        }
        public bool ttrv_hoanhoadon(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TTRV_004") == "1";
        }
        public bool ttrv_nhaplydomien(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TTRV_005") == "1";
        }
        public bool ttrv_nhapduyetmien(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TTRV_006") == "1";
        }

        public bool ttrv_cokhambenh(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TTRV_007") == "1";
        }
        public bool ttrv_conamluu(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TTRV_008") == "1";
        }
        public bool ttrv_conhanbenh(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TTRV_009") == "1";
        }
        public bool ttrv_thuchidinh(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TTRV_010") == "1";
        }
        public bool ttrv_thutoatutruc(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TTRV_011") == "1";
        }
        public bool ttrv_thuthuocthuongquy(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TTRV_012") == "1";
        }
        public bool ttrv_thuvienphikhoa(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TTRV_013") == "1";
        }
        public bool ttrv_thukhoatonghop(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TTRV_014") == "1";
        }
        public bool ttrv_thanhtoanhaophi(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TTRV_015") == "1";
        }
        public bool ttrv_congoaitru(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TTRV_016") == "1";
        }
        public string ttrv_Loaibn_NT(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TTRV_017");
        }
        public bool ttrv_ToaBHYT(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TTRV_018") == "1";
        }
        public bool ttrv_Miendt_loaiNT(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TTRV_019") == "1";
        }
        public bool ttrv_Quanlythathu(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TTRV_020") == "1";
        }
        public string ttrv_Doituongthu(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TTRV_021");
        }
        public bool ttrv_BHYT_PL_PK(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TTRV_022") == "1";
        }
        public bool ttrv_InHDdacthu(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TTRV_HDDacthu") == "1";
        }
        public bool ttrv_InHDchitiet(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TTRV_HDChitiet") == "1";
        }
        public string ttrv_khoathu(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TTRV_023");
        }

        public bool ttrv_Thanhtoannhieudot_trongkhoa(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TTRV_024") == "1";
        }
        public bool ttrv_nhapmienchitiet(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TTRV_025") == "1";
        }
        public bool ttrv_chophepsuadongia(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TTRV_026") == "1";
        }
        public bool ttrv_dichvucapphatle(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TTRV_027") == "1";
        }
        public bool ttrv_Thanhtoannhieudot_theotungkhoa(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TTRV_028") == "1";
        }
        public bool ttrv_phuthuCapphatleBHYT_Noitru(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TTRV_029") == "1";
        }
        public string ttrv_bienlai_dichvu(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TTRV_030");
        }
        //set ttrv
        public void set_ttrv_InHDdacthu(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TTRV_HDDacthu", v_val);
        }
        public void set_ttrv_InHDchitiet(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "TTRV_HDChitiet", v_val);
        }

        public bool ttrv_tunguyen(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TTRV_031") == "1";
        }

        public bool ttrv_batbuoc(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TTRV_032") == "1";
        }

        public bool bhyt_100_noitru_theodoibienlai(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TTRV_033") == "1";
        }
        public bool bThuchiravien_hoantra_bienlaitamung(string v_userid)
        {
            string v_opt = get_v_optionform(1, v_userid, "TTRV_034");
            return v_opt == "1" || v_opt.Trim() == "";
        }
        public string ttrv_tachhoadon_dichvu(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TTRV_035");
        }
        public bool bThuchiravien_TachHoadonGTGT_VAT(string v_userid)
        {
            string v_opt = get_v_optionform(1, v_userid, "TTRV_036");
            return v_opt == "1" || v_opt.Trim() == "";
        }
        //Thuy 13.09.2012
        public bool bThuchiravien_SuaTamUng(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TTRV_037")=="1";
        }
        //Thuy 01.10.2012 cho phép làm tròn không có số dư đối với tiền bệnh nhân đóng thêm
        public bool bThuchiravien_lamttrontienbn(string v_userid)
        {
            return get_v_optionform(1, v_userid, "TTRV_038") == "1";
        }
        //PHIEU CHI *************************************************************
        public bool pc_suahoadon(string v_userid)
        {
            return get_v_optionform(1, v_userid, "PC_001") == "1";
        }
        public bool pc_suanoidunghoadon(string v_userid)
        {
            return get_v_optionform(1, v_userid, "PC_002") == "1";
        }
        public bool pc_xoahoadon(string v_userid)
        {
            return get_v_optionform(1, v_userid, "PC_003") == "1";
        }
        public bool pc_hoanhoadon(string v_userid)
        {
            return get_v_optionform(1, v_userid, "PC_004") == "1";
        }
        public bool pc_gioihanvp(string v_userid)
        {
            return get_v_optionform(1, v_userid, "PC_005") == "1";
        }
        public bool pc_nhapkhoaphong(string v_userid)
        {
            return get_v_optionform(1, v_userid, "PC_006") == "1";
        }
        public bool pc_nhapbacsi(string v_userid)
        {
            return get_v_optionform(1, v_userid, "PC_007") == "1";
        }
        public bool pc_nhaplydomien(string v_userid)
        {
            return get_v_optionform(1, v_userid, "PC_008") == "1";
        }
        public bool pc_nhapduyetmien(string v_userid)
        {
            return get_v_optionform(1, v_userid, "PC_009") == "1";
        }
        public bool pc_thuchidinh(string v_userid)
        {
            return get_v_optionform(1, v_userid, "PC_010") == "1";
        }
        public bool pc_thutoatutruc(string v_userid)
        {
            return get_v_optionform(1, v_userid, "PC_011") == "1";
        }
        public bool pc_thuchenhlech(string v_userid)
        {
            return get_v_optionform(1, v_userid, "PC_017") == "1";
        }
        public bool pc_chonhapmoi(string v_userid)
        {
            return get_v_optionform(1, v_userid, "PC_012") == "1";
        }
        public bool pc_chokhongquatiepdon(string v_userid)
        {
            return get_v_optionform(1, v_userid, "PC_013") == "1";
        }
        public bool pc_cokhambenh(string v_userid)
        {
            return get_v_optionform(1, v_userid, "PC_014") == "1";
        }
        public bool pc_conamluu(string v_userid)
        {
            return get_v_optionform(1, v_userid, "PC_015") == "1";
        }
        public bool pc_conhanbenh(string v_userid)
        {
            return get_v_optionform(1, v_userid, "PC_016") == "1";
        }

        //SET PC*************************************************************
        public void set_pc_suahoadon(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "PC_001", v_val);
        }
        public void set_pc_suanoidunghoadon(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "PC_002", v_val);
        }
        public void set_pc_xoahoadon(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "PC_003", v_val);
        }
        public void set_pc_hoanhoadon(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "PC_004", v_val);
        }
        public void set_pc_gioihanvp(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "PC_005", v_val);
        }
        public void set_pc_nhapkhoaphong(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "PC_006", v_val);
        }
        public void set_pc_nhapbacsi(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "PC_007", v_val);
        }
        public void set_pc_nhaplydomien(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "PC_008", v_val);
        }
        public void set_pc_nhapduyetmien(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "PC_009", v_val);
        }
        public void set_pc_thuchidinh(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "PC_010", v_val);
        }
        public void set_pc_thutoatutruc(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "PC_011", v_val);
        }
        public void set_pc_thuchenhlech(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "PC_017", v_val);
        }
        public void set_pc_chonhapmoi(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "PC_012", v_val);
        }
        public void set_pc_chokhongquatiepdon(string v_userid, bool v_val)
        {
            set_v_optionform(1, v_userid, "PC_013", v_val);
        }

        //Hoan tra *************************************************************
        public bool ht_suahoadon(string v_userid)
        {
            return get_v_optionform(1, v_userid, "HT_001") == "1";
        }
        public bool ht_phuchoihoatra(string v_userid)
        {
            return get_v_optionform(1, v_userid, "HT_002") == "1";
        }


        //BHYT *************************************************************
        public bool bhyt_thuBHYT_tructiep(string v_userid)
        {
            return get_v_optionform(1, v_userid, "BHYT_000") == "1";
        }
        public bool bhyt_suahoadon(string v_userid)
        {
            return get_v_optionform(1, v_userid, "BHYT_001") == "1";
        }
        public bool bhyt_suanoidunghoadon(string v_userid)
        {
            return get_v_optionform(1, v_userid, "BHYT_002") == "1";
        }
        public bool bhyt_xoahoadon(string v_userid)
        {
            return get_v_optionform(1, v_userid, "BHYT_003") == "1";
        }
        public bool bhyt_hoanhoadon(string v_userid)
        {
            return get_v_optionform(1, v_userid, "BHYT_004") == "1";
        }
        public bool bhyt_nhaplydomien(string v_userid)
        {
            return get_v_optionform(1, v_userid, "BHYT_005") == "1";
        }
        public bool bhyt_nhapduyetmien(string v_userid)
        {
            return get_v_optionform(1, v_userid, "BHYT_006") == "1";
        }
        public bool bhyt_cokhambenh(string v_userid)
        {
            return get_v_optionform(1, v_userid, "BHYT_007") == "1";
        }
        public bool bhyt_conamluu(string v_userid)
        {
            return get_v_optionform(1, v_userid, "BHYT_008") == "1";
        }
        public bool bhyt_conhanbenh(string v_userid)
        {
            return get_v_optionform(1, v_userid, "BHYT_009") == "1";
        }
        public bool bhyt_thuchidinh(string v_userid)
        {
            return get_v_optionform(1, v_userid, "BHYT_010") == "1";
        }

        public bool bhyt_thutoatutruc(string v_userid)
        {
            return get_v_optionform(1, v_userid, "BHYT_011") == "1";
        }
        public bool bhyt_thuthuocthuongquy(string v_userid)
        {
            return get_v_optionform(1, v_userid, "BHYT_012") == "1";
        }
        public bool bhyt_thuvienphikhoa(string v_userid)
        {
            return get_v_optionform(1, v_userid, "BHYT_013") == "1";
        }
        public bool bhyt_thukhoatonghop(string v_userid)
        {
            return get_v_optionform(1, v_userid, "BHYT_014") == "1";
        }
        public bool bhyt_thutoathuocbhyt(string v_userid)
        {
            return get_v_optionform(1, v_userid, "BHYT_015") == "1";
        }
        public bool bhyt_thutoathuocduocphat(string v_userid)
        {
            return get_v_optionform(1, v_userid, "BHYT_016") == "1";
        }
        public bool bhyt_thutheongay(string v_userid)
        {
            return get_v_optionform(1, v_userid, "BHYT_017") == "1";
        }
        public bool bhyt_thutheodot_mavaovien(string v_userid)
        {
            return get_v_optionform(1, v_userid, "BHYT_022") == "1";
        }
        public bool bhyt_100_theodoibienlai(string v_userid)
        {
            return get_v_optionform(1, v_userid, "BHYT_023") == "1";
        }
        public string bhyt_tachhoadon_dichvu(string v_userid)
        {
            return get_v_optionform(1, v_userid, "BHYT_025");
        }
        public string bhyt_bienlai_dichvu(string v_userid)
        {
            return get_v_optionform(1, v_userid, "BHYT_029");
        }
        public bool ChiThuBNChuaVuotNguong(string v_userid)
        {
            return get_v_optionform(1, v_userid, "BHYT_031") == "1";
        }
        public bool BHYTThu_BNChiquatiepdon(string v_userid)
        {
            //nhap truc tiep thuoc+cls ben duoc --> bao hiem vien phi
            return get_v_optionform(1, v_userid, "BHYT_041") == "1";
        }
        public bool bhyt_docmavach(string v_userid)
        {
            return get_v_optionform(1, v_userid, "BHYT_023") == "1";
        }
        public bool bhyt_conamngoaitru(string v_userid)
        {
            return get_v_optionform(1, v_userid, "BHYT_018") == "1";
        }
        public bool bhyt_inchiphihen(string v_userid)
        {
            return get_v_optionform(1, v_userid, "BHYT_019") == "1";
        }
        public bool bhyt_tunguyen(string v_userid)
        {
            return get_v_optionform(1, v_userid, "BHYT_020") == "1";
        }
        public bool bhyt_batbuoc(string v_userid)
        {
            return get_v_optionform(1, v_userid, "BHYT_021") == "1";
        }
        public string bhyt_chithudoituong(string v_userid)
        {
            return get_v_optionform(1, v_userid, "BHYT_024");
        }
        #endregion

        #region OPTION MEDISOFT

        public bool bChenhlech
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=179");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch
                {
                    return false;
                }
            }
        }

        public bool bChenhlech_laygiaphuthu
        {
            //G27.1
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1088");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public int delay_tinnhan
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from medibv.thongso where id=339");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 1000; }
            }
        }

        public void upd_tinnhan(string ten, string phanhe, int trangthai)
        {
            execute_data("update medibv.dmcomputer set " + phanhe + "=" + trangthai + " where computer='" + ten + "'");
        }

        public void get_tinnhan(string ten, string phanhe)
        {
            string file = "";
            DataTable tmp = get_data("select * from medibv.dmcomputer where computer='" + ten + "' and " + phanhe + "=1").Tables[0];
            if (tmp.Rows.Count > 0)
            {
                file = "..//..//..//data//mes//" + tmp.Rows[0]["f" + phanhe].ToString() + ".wav";
                if (System.IO.File.Exists(file))
                {
                    upd_tinnhan(ten, phanhe, 0);
                    PlaySound(file, 0, 1);
                }
            }
        }

        public int iTunguyen
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=149");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch
                {
                    return 2;
                }
            }
        }

        public string sChenhlech
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=335");
                    return ds.Tables[0].Rows[0][0].ToString().Trim();
                }
                catch
                {
                    return " BN thanh toán chênh lệch";
                }
            }
        }

        public int mien_chenhlech
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=366");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 0; }
            }
        }

        public string mien_chenhlech_cholam
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=367");
                    return ds.Tables[0].Rows[0][0].ToString().Trim();
                }
                catch { return ""; }
            }
        }

        public int mien_chenhlech_doituong
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=368");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 0; }
            }
        }

        public decimal Bhyt_Chitra_7cn
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=365");
                    return decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 0; }
            }
        }

        public bool bChenhlech_thuoc
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=359");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }

        public bool bLaygiamua_khi_giabh_0_giabh_nho_giamua
        {
            //E22: medisoft --> thong so he thong
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1045");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }
        public bool bGia_bh_quydinh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=347");
                    return ds.Tables[0].Rows[0][0].ToString() == "1";
                }
                catch { return false; }
            }
        }

        public bool bGia_bh_quydinh_giamua
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=360");
                    return ds.Tables[0].Rows[0][0].ToString() == "1";
                }
                catch { return false; }
            }
        }

        public bool bCapcuu_noitru
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=150");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bCapve_noitru
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=182");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public decimal get_maql_phongluu(string ngay, decimal maql)
        {
            decimal mavaovien = 0, _maql = 0;
            string s_mmyy = "";
            DataSet ds = get_data("select mavaovien from " + user + ".benhandt where maql=" + maql);
            if (ds.Tables[0].Rows.Count > 0) mavaovien = decimal.Parse(ds.Tables[0].Rows[0]["mavaovien"].ToString());
            DateTime _dt1 = StringToDate(ngay).AddMonths(-1);
            DateTime _dt2 = StringToDate(ngay).AddMonths(1);
            while (DateTime.Compare(_dt1, _dt2) <= 0)
            {
                s_mmyy = _dt1.Month.ToString().PadLeft(2, '0') + _dt1.Year.ToString().Substring(2);
                if (bMmyy(s_mmyy))
                {
                    ds = get_data("select maql from " + user + s_mmyy + ".benhancc where mavaovien=" + mavaovien);
                    if (ds.Tables[0].Rows.Count > 0) _maql = decimal.Parse(ds.Tables[0].Rows[0]["maql"].ToString());
                    if (_maql != 0) return _maql;
                }
                _dt1 = _dt1.AddMonths(1);
            }
            return _maql;
        }

        public string get_maql_phongkham(string ngay, decimal maql)
        {
            decimal mavaovien = 0;
            string s_mmyy = "", s = "";
            DataSet ds = get_data("select mavaovien from " + user + ".benhandt where maql=" + maql);
            if (ds.Tables[0].Rows.Count > 0) mavaovien = decimal.Parse(ds.Tables[0].Rows[0]["mavaovien"].ToString());
            DateTime _dt1 = StringToDate(ngay).AddMonths(-1);
            DateTime _dt2 = StringToDate(ngay).AddMonths(1);
            while (DateTime.Compare(_dt1, _dt2) <= 0)
            {
                s_mmyy = _dt1.Month.ToString().PadLeft(2, '0') + _dt1.Year.ToString().Substring(2);
                if (bMmyy(s_mmyy))
                {
                    sql = "select maql from " + user + s_mmyy + ".benhanpk where mavaovien=" + mavaovien + " and mangtr=0";
                    sql += " union all ";
                    sql += "select maql from " + user + s_mmyy + ".tiepdon where mavaovien=" + mavaovien;
                    ds = get_data(sql);
                    foreach (DataRow r in ds.Tables[0].Rows)
                        s += r["maql"].ToString() + ",";
                }
                _dt1 = _dt1.AddMonths(1);
            }
            return s;
        }

        public bool bHinh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=248");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bPhongluu_bhyt_khambenh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=398");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }
        public bool bNoitru_bhyt_khambenh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=443");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bNgoaitru_bhyt_khambenh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=399");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return true; }
            }
        }

        public int nhom_duoc
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=166");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 1; }
            }
        }
        public int nhom_nhathuoc
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=165");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 1; }
            }
        }
        public int iNhomvpthuoc
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=303");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 0; }
            }
        }

        public bool bBHYTngtr_noitru
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=183");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public string ma13_vitri
        {
            get
            {
                DataSet ds = get_data("select ten from " + user + ".d_thongso where id=52");
                if (ds.Tables[0].Rows.Count == 0) return "5,1";
                return ds.Tables[0].Rows[0][0].ToString().Trim();
            }
        }

        public string ma16_vitri
        {
            get
            {
                DataSet ds = get_data("select ten from " + user + ".d_thongso where id=53");
                if (ds.Tables[0].Rows.Count == 0) return "5,2";
                return ds.Tables[0].Rows[0][0].ToString().Trim();
            }
        }

        public decimal ma13_st(int d_nhom)
        {
            DataSet ds = get_data("select ten from " + user + ".d_thongso where id=50 and nhom=" + d_nhom);
            if (ds.Tables[0].Rows.Count == 0) return 20000;
            return decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
        }

        public decimal ma16_st(int d_nhom)
        {
            DataSet ds = get_data("select ten from " + user + ".d_thongso where id=51 and nhom=" + d_nhom);
            if (ds.Tables[0].Rows.Count == 0) return 20000;
            return decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
        }

        public string ma13_ngtru(int d_nhom)
        {
            DataSet ds = get_data("select ten from " + user + ".d_thongso where id=48 and nhom=" + d_nhom);
            if (ds.Tables[0].Rows.Count == 0) return "";
            return ds.Tables[0].Rows[0][0].ToString().Trim();
        }

        public string ma16_ngtru(int d_nhom)
        {
            DataSet ds = get_data("select ten from " + user + ".d_thongso where id=49 and nhom=" + d_nhom);
            if (ds.Tables[0].Rows.Count == 0) return "";
            return ds.Tables[0].Rows[0][0].ToString().Trim();
        }

        public string mmyy(string ngay)
        {
            return ngay.Substring(3, 2) + ngay.Substring(8, 2);
        }

        public string get_maql_ngoaitru(string ngayvao, string ngayra, decimal mavaovien)
        {
            string s = "", s_mmyy = "";
            //if (bMmyy(ngay))
            //{
            //    foreach (DataRow r in get_data("select maql from " + user + mmyy(ngay) + ".benhanpk where mangtr=" + mavaovien).Tables[0].Rows)
            //        s += r["maql"].ToString() + ",";
            //}
            DateTime _dt1 = StringToDate(ngayvao).AddMonths(-1);
            DateTime _dt2 = StringToDate(ngayra).AddMonths(1);
            while (DateTime.Compare(_dt1, _dt2) <= 0)
            {
                s_mmyy = _dt1.Month.ToString().PadLeft(2, '0') + _dt1.Year.ToString().Substring(2);
                if (bMmyy(s_mmyy))
                {
                    foreach (DataRow r in get_data("select maql from " + user + s_mmyy + ".benhanpk where mangtr=" + mavaovien).Tables[0].Rows)
                        s += r["maql"].ToString() + ",";
                }
                _dt1 = _dt1.AddMonths(1);
            }
            return s;
        }

        public string get_maql_Capve_noitru(string ngay, decimal mavaovien)
        {
            string s = "";
            if (bMmyy(ngay) && bCapve_noitru)
            {
                foreach (DataRow r in get_data("select maql from " + user + mmyy(ngay) + ".benhanpk where mavaovien=" + mavaovien + " and mangtr=0").Tables[0].Rows)
                    s += r["maql"].ToString() + ",";
            }
            return s;
        }

        public string get_maql_Capcuu_noitru(string ngay, decimal mavaovien)
        {
            string s = "";
            if (bMmyy(ngay) && bCapcuu_noitru)
            {
                foreach (DataRow r in get_data("select maql from " + user + mmyy(ngay) + ".benhancc where mavaovien=" + mavaovien).Tables[0].Rows)
                    s += r["maql"].ToString() + ",";
            }
            return s;
        }

        public int get_maphu_noitru(string sothe, int nhom)
        {
            if (sothe == "") return 0;
            else return get_maphu(sothe);
        }

        public int get_maphu_ngtru(string sothe, decimal sotien, int nhom)
        {
            if (sothe == "") return 0;
            else
            {
                decimal m13_st = ma13_st(nhom), m16_st = ma16_st(nhom);
                int ma = get_maphu(sothe);
                if (sothe.Trim().Length == 18) return (ma != 0 && sotien > m16_st) ? ma : 0;
                else return (ma != 0 && sotien > m13_st) ? ma : 0;
            }
        }

        public bool bThanhtoan_ndot
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=110");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bChidinh_vienphi
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=157");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bHaophi_thanhtoan
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=246");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public bool bDieutri_donthuoc
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=334");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public string for_ngay(string ngay, string time)
        {
            return "to_date(to_char(" + ngay + ", " + time + "), " + time + ")";
        }

        public bool bChiphikp_noingoai
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=382");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public string get_doituong(string mabn, decimal maql, decimal idkhoa, string tu, string den, string makp, DataTable dtkp, int done, bool bVienphi_phongluu, int loaiba, decimal mavaovien)
        {
            string ret = "", xxx, usr = user, _ngay = f_ngay;
            int i_makp = 0, be = 0;
            DataRow r1;
            DateTime dt1 = StringToDate(tu).AddDays(-iNgaykiemke);
            DateTime dt2 = StringToDate(den).AddDays(iNgaykiemke);
            int y1 = dt1.Year, m1 = dt1.Month;
            int y2 = dt2.Year, m2 = dt2.Month;
            int itu, iden;
            string mmyy = "";
            bool bndot = bThanhtoan_ndot || loaiba == 2;
            bool bCapve = bCapve_noitru, bNgtr = bBHYTngtr_noitru, bdieutri_donthuoc = bDieutri_donthuoc;
            DataSet dsdt = new DataSet();
            decimal maql_phongluu = (bVienphi_phongluu) ? get_maql_phongluu(tu, maql) : 0;
            for (int i = y1; i <= y2; i++)
            {
                itu = (i == y1) ? m1 : 1;
                iden = (i == y2) ? m2 : 12;
                for (int j = itu; j <= iden; j++)
                {
                    mmyy = j.ToString().PadLeft(2, '0') + i.ToString().Substring(2, 2);
                    if (bMmyy(mmyy))
                    {
                        xxx = usr + mmyy;
                        if (makp != "")
                        {
                            r1 = getrowbyid(dtkp, "makp='" + makp + "'");
                            if (r1 != null) i_makp = int.Parse(r1["id"].ToString());
                        }
                        sql = "select distinct madoituong from " + xxx + ".d_tienthuoc ";
                        sql += " where mabn='" + mabn + "'";
                        if (maql != 0 && loaiba != 2) sql += " and maql=" + maql;
                        if (bndot) sql += " and ngay between to_date('" + tu.Substring(0, 10) + "','" + _ngay + "') and to_date('" + den.Substring(0, 10) + "','" + _ngay + "')";
                        if (i_makp != 0) sql += " and makp=" + i_makp;
                        if (done != 2) sql += " and done=" + done;
                        if (be == 0) dsdt = get_data(sql);
                        else dsdt.Merge(get_data(sql));
                        be++;
                        if (maql_phongluu != 0)
                        {
                            sql = "select distinct madoituong from " + xxx + ".d_tienthuoc ";
                            sql += " where mabn='" + mabn + "'";
                            sql += " and maql=" + maql_phongluu;
                            if (done != 2) sql += " and done=" + done;
                            dsdt.Merge(get_data(sql));
                        }
                        if (bCapve || loaiba == 2)
                        {
                            sql = "select distinct maphu as madoituong from " + xxx + ".bhytkb ";
                            sql += " where mabn='" + mabn + "'";
                            if (maql != 0 && loaiba != 2) sql += " and maql=" + maql;
                            sql += " and ngay between to_date('" + tu.Substring(0, 10) + "','" + _ngay + "') and to_date('" + den.Substring(0, 10) + "','" + _ngay + "')";
                            dsdt.Merge(get_data(sql));
                        }
                        if (bNgtr && loaiba != 2)
                        {
                            sql = "select distinct maphu as madoituong from " + xxx + ".bhytkb ";
                            sql += " where mabn='" + mabn + "'";
                            sql += " and maphu=1";
                            sql += " and ngay between to_date('" + tu.Substring(0, 10) + "','" + _ngay + "') and to_date('" + den.Substring(0, 10) + "','" + _ngay + "')";
                            dsdt.Merge(get_data(sql));
                        }

                        if (bdieutri_donthuoc)
                        {
                            sql = "select distinct a.madoituong";
                            sql += " from " + xxx + ".d_ngtrull k," + xxx + ".d_ngtruct a";
                            sql += " where k.id=a.id and k.mabn='" + mabn + "'";
                            sql += " and k.ngay between to_date('" + tu.Substring(0, 10) + "','" + _ngay + "') and to_date('" + den.Substring(0, 10) + "','" + _ngay + "')";
                            sql += " and k.maql=" + maql;
                            if (done != 2) sql += " and a.paid=" + done;
                            else sql += " and a.paid=0";
                            dsdt.Merge(get_data(sql));
                        }

                        sql = "select distinct madoituong from " + xxx + ".v_vpkhoa ";
                        sql += " where mabn='" + mabn + "'";
                        if (maql != 0 && loaiba != 2) sql += " and maql=" + maql;
                        if (bndot) sql += " and " + for_ngay("ngay", "'" + _ngay + "'") + " between to_date('" + tu.Substring(0, 10) + "','" + _ngay + "') and to_date('" + den.Substring(0, 10) + "','" + _ngay + "')";
                        if (makp != "") sql += " and makp='" + makp + "'";
                        if (done != 2) sql += " and done=" + done;
                        dsdt.Merge(get_data(sql));
                        if (bChidinh_vienphi)
                        {
                            sql = "select distinct madoituong from " + xxx + ".v_chidinh ";
                            sql += " where mabn='" + mabn + "'";
                            if (done != 2) sql += " and paid=" + done;
                            else sql += " and paid=0";
                            if (maql != 0 && loaiba != 2) sql += " and maql=" + maql;
                            if (bndot) sql += " and " + for_ngay("ngay", "'" + _ngay + "'") + " between to_date('" + tu.Substring(0, 10) + "','" + _ngay + "') and to_date('" + den.Substring(0, 10) + "','" + _ngay + "')";
                            if (makp != "") sql += " and makp='" + makp + "'";
                            dsdt.Merge(get_data(sql));
                        }
                        if (maql_phongluu != 0)
                        {
                            sql = "select distinct madoituong from " + xxx + ".v_vpkhoa ";
                            sql += " where mabn='" + mabn + "'";
                            sql += " and maql=" + maql_phongluu;
                            if (done != 2) sql += " and done=" + done;
                            dsdt.Merge(get_data(sql));
                            if (bChidinh_vienphi)
                            {
                                sql = "select distinct madoituong from " + xxx + ".v_chidinh ";
                                sql += " where mabn='" + mabn + "' and paid=0";
                                sql += " and maql=" + maql_phongluu;
                                dsdt.Merge(get_data(sql));
                            }
                        }
                        if (mavaovien != 0)
                        {
                            sql = "select distinct madoituong from " + xxx + ".v_chidinh ";
                            sql += " where mabn='" + mabn + "' and paid=0";
                            sql += " and mavaovien=" + mavaovien + " and maql not in (" + maql + "," + maql_phongluu + ")";
                            sql += " union all ";
                            sql += "select distinct maphu as madoituong from " + xxx + ".bhytkb ";
                            sql += " where mabn='" + mabn + "'";
                            sql += " and mavaovien=" + mavaovien + " and maql not in (" + maql + "," + maql_phongluu + ")";
                            dsdt.Merge(get_data(sql));
                        }
                    }
                }
            }
            if (dsdt.Tables[0].Rows.Count > 0)
            {
                foreach (DataRow r in dsdt.Tables[0].Rows) if (r["madoituong"].ToString().Trim() != "") ret += r["madoituong"].ToString().Trim() + ",";
                if (bChenhlech && ret.IndexOf(iTunguyen.ToString() + ",") == -1) ret += iTunguyen.ToString() + ",";
            }
            return (bHaophi_thanhtoan) ? ret : ret.Replace("5,", "");
        }

        #endregion

        #region OPTION DUOC
        public string sCongkham_BHYT
        {
            get
            {
                try
                {
                    return get_data("select ten from medibv.d_thongso where id=47 and nhom=1").Tables[0].Rows[0][0].ToString();
                }
                catch { return ""; }
            }
        }
        #endregion

        #region LICENSE

        private LinksLicense.LibLicense m_license = new LinksLicense.LibLicense();


        public bool upd_md_license(string v_computer_key, string v_license_key)
        {
            if (v_computer_key == "" || v_license_key == "") return false;
            sql = "update " + user + ".license set license_key=:v_license_key,computer='" + m_computername + "' where computer_key=:v_computer_key";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_computer_key", NpgsqlDbType.Text).Value = v_computer_key;
            cmd.Parameters.Add("v_license_key", NpgsqlDbType.Text).Value = v_license_key;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".license(computer_key,license_key,computer) values(:v_computer_key,:v_license_key,'" + m_computername + "')";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_computer_key", NpgsqlDbType.Text).Value = v_computer_key;
                    cmd.Parameters.Add("v_license_key", NpgsqlDbType.Text).Value = v_license_key;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "m_license");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        public bool is_licensed
        {
            get
            {
                bool ar = false;
                try
                {
                    ar = f_get_md_license(m_license.f_generate_computer_key(), m_license.f_generate_license_key()).Tables[0].Rows.Count > 0;
                }
                catch
                {
                    ar = false;
                }
                return ar;
            }
        }
        public DataSet f_get_md_license(string v_computer_key, string v_license_key)
        {
            DataSet ads = null;
            try
            {
                string sql = "", aexp = "";
                sql = "select * from " + user + ".license";

                if (v_computer_key != "")
                {
                    if (aexp.Length > 0)
                    {
                        aexp += " and";
                    }
                    aexp += " computer_key=:v_computer_key";
                }
                if (v_license_key != "")
                {
                    if (aexp.Length > 0)
                    {
                        aexp += " and";
                    }
                    aexp += " license_key=:v_license_key";
                }

                if (aexp.Length > 0)
                {
                    sql += " where" + aexp;
                }
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }

                con = new NpgsqlConnection(sConn);
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                if (v_computer_key != "")
                {
                    cmd.Parameters.Add("v_computer_key", NpgsqlDbType.Text).Value = v_computer_key;
                }

                if (v_license_key != "")
                {
                    cmd.Parameters.Add("v_license_key", NpgsqlDbType.Text).Value = v_license_key;
                }

                dest = new NpgsqlDataAdapter(cmd);
                ads = new DataSet();
                dest.Fill(ads);
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
            catch (NpgsqlException ex)
            {
                create_vp_license();
                upd_v_error(ex.Message.ToString().Trim(), m_computername, "m_license");
            }
            return ads;
        }

        #region Khong su dung
        /*
         * 
        public bool upd_vp_license(string v_computer_key, string v_license_key)
		{
			if(v_computer_key=="" || v_license_key=="") return false;
			sql="update " + m_db_schemaroot + ".vp_license set license_key=:v_license_key where computer_key=:v_computer_key";
			con=new NpgsqlConnection(sConn);
			cmd=new NpgsqlCommand(sql,con);
			cmd.CommandType=CommandType.Text;

			cmd.Parameters.Add("v_computer_key",NpgsqlDbType.Text,255).Value=v_computer_key;
			cmd.Parameters.Add("v_license_key",NpgsqlDbType.Text,255).Value=v_license_key;

			try
			{
				con.Open();
				int irec=cmd.ExecuteNonQuery();
				cmd.Dispose();
				if (irec==0)
				{
					sql="insert into " + m_db_schemaroot + ".vp_license(computer_key,license_key) values(:v_computer_key,:v_license_key)";
					cmd=new NpgsqlCommand(sql,con);
					cmd.CommandType=CommandType.Text;

					cmd.Parameters.Add("v_computer_key",NpgsqlDbType.Text,255).Value=v_computer_key;
					cmd.Parameters.Add("v_license_key",NpgsqlDbType.Text,255).Value=v_license_key;

					irec=cmd.ExecuteNonQuery();
					cmd.Dispose();
				}
			}
			catch(Exception ex)
			{
				upd_v_error(ex.Message,m_computername,"vp_license");    
				return false;
			}
			finally
			{
				cmd.Dispose();
				con.Dispose();
			}		
			return true;
		}
		public DataSet get_vp_license(string v_computer_key, string v_license_key)
		{
			DataSet ads = null;
			try
			{
				string sql="", aexp="";
				sql="select * from " + m_db_schemaroot + ".vp_license";

				if(v_computer_key!="") 
				{
					if(aexp.Length>0)
					{
						aexp+=" and";
					}
					aexp+=" computer_key=:v_computer_key";
				}
				if(v_license_key!="") 
				{
					if(aexp.Length>0)
					{
						aexp+=" and";
					}
					aexp+=" license_key=:v_license_key";
				}

				if(aexp.Length>0)
				{
					sql+=" where"+aexp;
				}
	
				con=new NpgsqlConnection(sConn);
				con.Open();
				cmd=new NpgsqlCommand(sql,con);
				cmd.CommandType=CommandType.Text;
				
				if(v_computer_key!="") 
				{
					cmd.Parameters.Add("v_computer_key",NpgsqlDbType.Text,255).Value=v_computer_key;
				}
				
				if(v_license_key!="") 
				{
					cmd.Parameters.Add("v_license_key",NpgsqlDbType.Text,255).Value=v_license_key;
				}

				dest=new NpgsqlDataAdapter(cmd);
				ads=new DataSet();
				dest.Fill(ads);	
				cmd.Dispose();				
				con.Dispose();
			}
			catch(NpgsqlException ex)
			{
				create_vp_license();
				upd_v_error(ex.Message.ToString().Trim(),m_computername,"vp_license");
			}
			return ads;
		}
         * */
        #endregion

        public void set_licensed(string v_password_)
        {
            try
            {
                if (v_password_ == m_license.f_generate_password_key())
                {
                    string acomputer_key = "", alicence_key = "";
                    acomputer_key = m_license.f_generate_computer_key();
                    alicence_key = m_license.f_generate_license_key();
                    if (acomputer_key != "" && alicence_key != "")
                    {
                        upd_md_license(acomputer_key, alicence_key);
                    }
                }
            }
            catch
            {
            }
        }
        public string s_computer_key
        {
            get
            {
                return m_license.f_generate_computer_key();
            }
        }
        public void create_vp_license()
        {
            try
            {
                int n = get_data("select * from license where 1=-1").Tables[0].Rows.Count;
            }
            catch
            {
                sql = "CREATE TABLE medibv.license(computer_key text, license_key text,computer text,ngayud timestamp default now(),CONSTRAINT pk_license PRIMARY KEY (computer_key) USING INDEX TABLESPACE medi_index) WITH OIDS TABLESPACE medi_data;";
                execute_data(sql);
            }
            /*
			try
			{
				int n = get_data("select * from " + m_db_schemaroot + ".vp_license where 1=0").Tables[0].Rows.Count;
			}
			catch
			{
                execute_data("create table " + m_db_schemaroot + ".vp_license(computer_key text, license_key text, constraint pk_vp_license primary key(computer_key))");
                execute_data("alter table " + m_db_schemaroot + ".vp_license owner to " + m_db_database + "");
            }
             * */
        }

        #endregion LICENSE

        #region  NGÀY HIỆN HÀNH SERVER

        public string s_curyy
        {
            get
            {
                try
                {
                    return get_data("select to_char(now(),'yy')").Tables[0].Rows[0][0].ToString();
                }
                catch
                {
                    return DateTime.Now.Year.ToString().Substring(2, 2);
                }
            }
        }
        public string s_curyyyy
        {
            get
            {
                try
                {
                    return get_data("select to_char(now(),'yyyy')").Tables[0].Rows[0][0].ToString();
                }
                catch
                {
                    return DateTime.Now.Year.ToString();
                }
            }
        }
        public string s_curmmyy
        {
            get
            {
                try
                {
                    return get_data("select to_char(now(),'mmyy')").Tables[0].Rows[0][0].ToString();
                }
                catch
                {
                    return DateTime.Now.Month.ToString().PadLeft(2, '0') + DateTime.Now.Year.ToString().Substring(2, 2);
                }
            }
        }
        public string s_curmmyyyy
        {
            get
            {
                try
                {
                    return get_data("select to_char(now(),'mmyyyy')").Tables[0].Rows[0][0].ToString();
                }
                catch
                {
                    return DateTime.Now.Month.ToString().PadLeft(2, '0') + DateTime.Now.Year.ToString();
                }
            }
        }
        public string s_curddmmyy
        {
            get
            {
                try
                {
                    return get_data("select to_char(now(),'ddmmyy')").Tables[0].Rows[0][0].ToString();
                }
                catch
                {
                    return DateTime.Now.Day.ToString().PadLeft(2, '0') + DateTime.Now.Month.ToString().PadLeft(2, '0') + DateTime.Now.Year.ToString().Substring(2, 2);
                }
            }
        }
        public string s_curddmmyyyy
        {
            get
            {
                try
                {
                    return get_data("select to_char(now(),'ddmmyyyy')").Tables[0].Rows[0][0].ToString();
                }
                catch
                {
                    return DateTime.Now.Day.ToString().PadLeft(2, '0') + DateTime.Now.Month.ToString().PadLeft(2, '0') + DateTime.Now.Year.ToString();
                }
            }
        }
        public string s_curdd_mm_yyyy
        {
            get
            {
                try
                {
                    return get_data("select to_char(now(),'dd/mm/yyyy')").Tables[0].Rows[0][0].ToString();
                }
                catch
                {
                    return DateTime.Now.Day.ToString().PadLeft(2, '0') + "/" + DateTime.Now.Month.ToString().PadLeft(2, '0') + "/" + DateTime.Now.Year.ToString();
                }
            }
        }
        public string s_curdd_mm_yyyy_hh24_mi
        {
            get
            {
                try
                {
                    return get_data("select to_char(now(),'dd/mm/yyyy hh24:mi')").Tables[0].Rows[0][0].ToString();
                }
                catch
                {
                    return DateTime.Now.Day.ToString().PadLeft(2, '0') + "/" + DateTime.Now.Month.ToString().PadLeft(2, '0') + "/" + DateTime.Now.Year.ToString() + " " + DateTime.Now.Hour.ToString().PadLeft(2, '0') + ":" + DateTime.Now.Minute.ToString().PadLeft(2, '0');
                }
            }
        }
        public DateTime s_server_date
        {
            get
            {
                try
                {
                    string r = get_data("select to_char(now(),'dd/mm/yyyy hh24:mi')").Tables[0].Rows[0][0].ToString();
                    return new DateTime(int.Parse(r.Substring(6, 4)), int.Parse(r.Substring(3, 2)), int.Parse(r.Substring(0, 2)));
                }
                catch
                {
                    return DateTime.Now;
                }
            }
        }
        public DateTime s_server_datetime
        {
            get
            {
                try
                {
                    string r = get_data("select to_char(now(),'dd/mm/yyyy hh24:mi')").Tables[0].Rows[0][0].ToString();
                    return new DateTime(int.Parse(r.Substring(6, 4)), int.Parse(r.Substring(3, 2)), int.Parse(r.Substring(0, 2)), int.Parse(r.Substring(11, 2)), int.Parse(r.Substring(14, 2)), 0);
                }
                catch
                {
                    return DateTime.Now;
                }
            }
        }
        public string get_mmyy(string v_ngay)
        {
            try
            {
                return v_ngay.Substring(3, 2) + v_ngay.Substring(8, 2);
            }
            catch
            {
                return s_curmmyy;
            }
        }

        public int iTraituyen_bhyt
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=431");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 0; }
            }
        }
        public string Ngaygio_hienhanh
        {
            get
            {
                return ngayhienhanh_server;
            }
        }
        public string ngayhienhanh_server
        {
            get
            {
                return get_data("select to_char(now(),'dd/mm/yyyy hh24:mi')").Tables[0].Rows[0][0].ToString();
            }
        }
        #endregion  NGÀY HIỆN HÀNH SERVER

        #region CÁC HÀM VỀ NGÀY

        public DateTime f_parse_date(string v_ngay10)
        {
            try
            {
                return new DateTime(int.Parse(v_ngay10.Substring(6, 4)), int.Parse(v_ngay10.Substring(3, 2)), int.Parse(v_ngay10.Substring(0, 2)));
            }
            catch
            {
                return DateTime.Now;
            }
        }
        public DateTime f_parse_date_16(string v_ngay16)
        {
            try
            {
                return new DateTime(int.Parse(v_ngay16.Substring(6, 4)), int.Parse(v_ngay16.Substring(3, 2)), int.Parse(v_ngay16.Substring(0, 2)), int.Parse(v_ngay16.Substring(11, 2)), int.Parse(v_ngay16.Substring(14, 2)), 00);
            }
            catch
            {
                return DateTime.Now;
            }
        }

        public string f_string_date(string v_date)
        {
            string r = "";
            if (v_date != "")
            {
                DateTime ad;
                try
                {
                    string[] ata = v_date.Split('/');
                    ad = new DateTime(int.Parse(ata[2]), int.Parse(ata[1]), int.Parse(ata[0]));
                    r = ad.Day.ToString().PadLeft(2, '0') + "/" + ad.Month.ToString().PadLeft(2, '0') + "/" + ad.Year.ToString().PadLeft(2, '0');
                }
                catch
                {
                    try
                    {
                        ad = new DateTime(int.Parse(v_date.Substring(4, 4)), int.Parse(v_date.Substring(2, 2)), int.Parse(v_date.Substring(0, 2)));
                        r = ad.Day.ToString().PadLeft(2, '0') + "/" + ad.Month.ToString().PadLeft(2, '0') + "/" + ad.Year.ToString().PadLeft(2, '0');
                    }
                    catch
                    {
                        try
                        {
                            ad = new DateTime(int.Parse("20" + v_date.Substring(4, 2)), int.Parse(v_date.Substring(2, 2)), int.Parse(v_date.Substring(0, 2)));
                            r = ad.Day.ToString().PadLeft(2, '0') + "/" + ad.Month.ToString().PadLeft(2, '0') + "/" + ad.Year.ToString().PadLeft(2, '0');
                        }
                        catch
                        {
                        }
                    }
                }
            }
            return r;
        }
        public string f_ngay10(DateTime v_date)
        {
            string art = "";
            try
            {
                art = v_date.Day.ToString().PadLeft(2, '0') + "/" + v_date.Month.ToString().PadLeft(2, '0') + "/" + v_date.Year.ToString();
            }
            catch
            {
                art = "";
            }
            return art;
        }
        public string f_ngay16(DateTime v_date)
        {
            string art = "";
            try
            {
                art = v_date.Day.ToString().PadLeft(2, '0') + "/" + v_date.Month.ToString().PadLeft(2, '0') + "/" + v_date.Year.ToString() + " " + v_date.Hour.ToString().PadLeft(2, '0') + ":" + v_date.Minute.ToString().PadLeft(2, '0');
            }
            catch
            {
                art = "";
            }
            return art;
        }
        public string tinhtuoi(string v_ngay_or_nam, int v_max_tuoi)
        {
            //ngay_or_nam:tuoi:thang:ngay
            string art = "", art1 = "";
            int n = 0, atuoi = 0, athang = 0, angay = 0;
            art = f_string_date(v_ngay_or_nam);
            DateTime adt;
            if (art == "")
            {
                try
                {
                    n = int.Parse(v_ngay_or_nam);
                }
                catch
                {
                    n = 0;
                }
                if (n > 0 && DateTime.Now.Year - n <= v_max_tuoi)
                {
                    art = n.ToString();
                }
            }
            else
            {
                adt = f_parse_date(art);
                TimeSpan ats = DateTime.Now - adt;
                if (ats.Days / 360 > v_max_tuoi)
                {
                    art = "";
                }
            }
            if (art.Length > 4)
            {
                adt = f_parse_date(art);
                atuoi = DateTime.Now.Year - adt.Year;
                if (atuoi <= 0)
                {
                    TimeSpan ats = DateTime.Now - adt;
                    if (ats.Days / 30 > 0)
                    {
                        athang = ats.Days / 30;
                        art1 = art + ":?:" + athang.ToString() + ":?";
                    }
                    else
                        if (ats.Days > 0)
                        {
                            angay = ats.Days;
                            art1 = art + ":?:?:" + angay.ToString();
                        }
                        else
                        {
                            angay = 1;
                            art = s_curdd_mm_yyyy;
                            art1 = art + ":?:?:" + angay.ToString();
                        }
                }
                else
                {
                    art1 = art + ":" + atuoi.ToString() + ":?:?";
                }
            }
            else
                if (art.Length > 0)
                {
                    atuoi = DateTime.Now.Year - int.Parse(art);
                    if (atuoi <= 0)
                    {
                        atuoi = 1;
                    }
                    art1 = art + ":" + atuoi.ToString() + ":?:?";
                }
                else
                {
                    art1 = "?:?:?:?";
                }
            return art1;
        }

        public string tinhngay(string v_tuoi, string v_loaituoi)
        {
            //ngay_or_nam:tuoi:thang:ngay
            string art = "";
            int n = 0;
            try
            {
                n = int.Parse(v_tuoi);
                if (n > 0)
                {
                    DateTime adt = DateTime.Now;
                    switch (v_loaituoi)
                    {
                        case "1"://Tuoi
                            adt = adt.AddYears((-1 * n));
                            art = adt.Day.ToString().PadLeft(2, '0') + "/" + adt.Month.ToString().PadLeft(2, '0') + "/" + adt.Year.ToString().PadLeft(2, '0') + ":" + n.ToString() + ":?:?";
                            break;
                        case "2"://Thang
                            adt = adt.AddMonths((-1 * n));
                            if (n > 12)
                            {
                                art = adt.Day.ToString().PadLeft(2, '0') + "/" + adt.Month.ToString().PadLeft(2, '0') + "/" + adt.Year.ToString().PadLeft(2, '0') + ":" + (n / 12).ToString() + ":?:?";
                            }
                            else
                            {
                                art = adt.Day.ToString().PadLeft(2, '0') + "/" + adt.Month.ToString().PadLeft(2, '0') + "/" + adt.Year.ToString().PadLeft(2, '0') + ":?:" + n.ToString() + ":?";
                            }
                            break;
                        case "3"://Ngay
                        case "4"://Gio
                            adt = adt.AddDays((-1 * n));
                            if (n > 365)
                            {
                                art = adt.Day.ToString().PadLeft(2, '0') + "/" + adt.Month.ToString().PadLeft(2, '0') + "/" + adt.Year.ToString().PadLeft(2, '0') + ":" + (n / 365).ToString() + ":?:?";
                            }
                            else
                                if (n > 30)
                                {
                                    art = adt.Day.ToString().PadLeft(2, '0') + "/" + adt.Month.ToString().PadLeft(2, '0') + "/" + adt.Year.ToString().PadLeft(2, '0') + ":?:" + (n / 30).ToString() + ":?";
                                }
                                else
                                {
                                    art = adt.Day.ToString().PadLeft(2, '0') + "/" + adt.Month.ToString().PadLeft(2, '0') + "/" + adt.Year.ToString().PadLeft(2, '0') + ":?:?:" + n.ToString();
                                }
                            break;
                    }
                }
            }
            catch
            {
                art = "";
            }
            if (art == "")
            {
                art = "?:?:?:?";
            }
            return art;
        }
        public int get_songay(string v_tn10, string v_dn10)
        {
            DateTime adt = f_parse_date(v_tn10);
            DateTime adt1 = f_parse_date(v_dn10);
            TimeSpan ats = adt1 - adt;
            int n = ats.Days + 1;
            return n;
        }
        public System.DateTime StringToDate(string s)
        {
            s = (s == "") ? ngayhienhanh_server.Substring(0, 10) : s;
            string[] format ={ "dd/MM/yyyy" };
            return System.DateTime.ParseExact(s.ToString().Substring(0, 10), format, System.Globalization.DateTimeFormatInfo.CurrentInfo, System.Globalization.DateTimeStyles.None);
        }
        public string DateToString(string format, System.DateTime date)
        {
            if (date.Equals(null)) return "";
            else return date.ToString(format, System.Globalization.DateTimeFormatInfo.CurrentInfo);
        }
        public string f_ngay
        {
            get
            {
                if (get_data("select ten from " + user + ".thongso where id=-2").Tables[0].Rows.Count > 0)
                    return get_data("select ten from " + user + ".thongso where id=-2").Tables[0].Rows[0]["ten"].ToString().Trim();
                else
                    return "dd/mm/yyyy";
            }
        }
        public bool bNgay(string ngayvao, string ngaysinh)
        {
            int d1 = DateTime.Now.Day;
            int m1 = DateTime.Now.Month;
            int y1 = DateTime.Now.Year;
            if (ngayvao != "")
            {
                y1 = int.Parse(ngayvao.Substring(6, 4));
                m1 = int.Parse(ngayvao.Substring(3, 2));
                d1 = int.Parse(ngayvao.Substring(0, 2));
            }
            int d2 = int.Parse(ngaysinh.Substring(0, 2));
            int m2 = int.Parse(ngaysinh.Substring(3, 2));
            int y2 = int.Parse(ngaysinh.Substring(6, 4));

            if (y2 > y1) return false;
            else if (y2 < y1) return true;
            if (m2 > m1) return false;
            else if (m2 < m1) return true;
            if (d2 > d1) return false;
            return true;
        }

        public bool bNgay(string ngay)
        {
            try
            {
                if (ngay.IndexOf("_") != -1 || (ngay.IndexOf(" ") != -1 && ngay.Trim().Length == 10)) return false;
                int len = ngay.Length;
                if (len == 0) return false;
                string dd = ngay.Substring(0, 2), mm = ngay.Substring(3, 2), yyyy = ngay.Substring(6, 4);
                string s31 = "01+03+05+07+08+10+12+", s30 = "04+06+09+11+", s2829 = (int.Parse(yyyy) % 4 == 0) ? "29" : "28";
                if (int.Parse(yyyy.Substring(0, 1)) < 1) return false;
                if (int.Parse(mm) < 1 || int.Parse(mm) > 12) return false;
                if (s31.IndexOf(mm + "+") > -1)
                {
                    if (int.Parse(dd) < 1 || int.Parse(dd) > 31) return false;
                }
                else if (s30.IndexOf(mm + "+") > -1)
                {
                    if (int.Parse(dd) < 1 || int.Parse(dd) > 30) return false;
                }
                else if (int.Parse(dd) < 1 || int.Parse(dd) > int.Parse(s2829)) return false;
                if (len > 10)
                {
                    string hh = ngay.Substring(11, 2), MM = ngay.Substring(14, 2);
                    if (int.Parse(hh) > 23) return false;
                    if (int.Parse(MM) > 59) return false;
                }
                return true;
            }
            catch { return false; };
        }
        public bool Kiemtra_mann(string ma, int tuoi, int treem6, int treem15)
        {
            try
            {
                if (tuoi < treem6) sql = "select * from " + user + ".btdnn_bv where mannbo='01'";
                else if (tuoi < treem15) sql = "select * from " + user + ".btdnn_bv where mannbo in ('01','02')";
                else sql = "select * from " + user + ".btdnn_bv where mannbo<>'01'";
                sql += " and mann='" + ma + "'";
                return get_data(sql).Tables[0].Rows.Count != 0;
            }
            catch
            {
                return false;
            }
        }
        public string Ktngaygio(string s, int len)
        {
            try
            {
                string s1 = f_kytuso(s);
                if (len == 10)
                    return s1.Substring(0, 2).Trim().PadLeft(2, '0') + "/" + s1.Substring(2, 2).Trim().PadLeft(2, '0') + "/" + s1.Substring(4).Trim().PadLeft(4, '0');
                else
                    return s1.Substring(0, 2).Trim().PadLeft(2, '0') + "/" + s1.Substring(2, 2).Trim().PadLeft(2, '0') + "/" + s1.Substring(4, 4).Trim().PadLeft(4, '0') + " " + s1.Substring(9, 2).Trim().PadLeft(2, '0') + ":" + s1.Substring(11, 2).Trim().PadLeft(2, '0');
            }
            catch { return s; }
        }
        #endregion CÁC HÀM VỀ NGÀY

        #region GIÁ TRỊ MẶC ĐỊNH
        public void f_macdinh_v_nhomdlogin()
        {
            upd_v_nhomdlogin(1, 1, "ADMINDBA", "Quản trị cơ sở dữ liệu", "", "", "");
            upd_v_nhomdlogin(2, 2, "ADMINAPP", "Quản trị chương trình", "", "", "");
            upd_v_nhomdlogin(3, 3, "ADMINDEP", "Quản trị khoa, phòng ban", "", "", "");
            upd_v_nhomdlogin(4, 4, "USER", "Nhân viên", "Nhân viên nhập liệu vi tính", "", "");
        }
        #endregion GIÁ TRỊ MẶC ĐỊNH

        #region CẬP NHẬT CẤU TRÚC TABLES
        public void drop_schema(string v_schema)
        {
            try
            {
                execute_data("drop schema " + v_schema + " cascade");
            }
            catch
            {
            }
        }
        public void drop_table(string v_schema, string v_table)
        {
            execute_data("drop table " + v_schema + "." + v_table + " cascade");
        }
        public void create_schema_vp(string v_mmyy)
        {
            execute_data("create schema " + s_schema_mmyy(v_mmyy) + " authorization " + m_db_database + "");
        }

        public void create_tables_vp()
        {
            try
            {
                execute_data("CREATE TABLE " + m_db_schemaroot + ".vp_treemenu(id numeric(5), id_cha numeric(5), stt numeric(5), ten text, sql text, tenfield text, captionfield text, width text, report text,readonly numeric(1) default 0, CONSTRAINT pk_vp_treemenu PRIMARY KEY (id)) WITH OIDS");
                execute_data("ALTER TABLE " + m_db_schemaroot + ".vp_treemenu OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + m_db_schemaroot + ".vp_null(id text, ten text, readonly numeric(1) default 0, CONSTRAINT pk_vp_null PRIMARY KEY (id)) WITH OIDS");
                execute_data("ALTER TABLE " + m_db_schemaroot + ".vp_null OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + m_db_schemaroot + ".v_khongdau(codau text, khongdau text, CONSTRAINT pk_v_khongdau PRIMARY KEY (codau)) WITH OIDS");
                execute_data("ALTER TABLE " + m_db_schemaroot + ".v_khongdau OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + m_db_schemaroot + ".v_phanquyen(userid numeric(5), menuname text, chon numeric(1) DEFAULT 0, chitiet text, CONSTRAINT pk_v_phanquyen PRIMARY KEY (userid,menuname)) WITH OIDS");
                execute_data("ALTER TABLE " + m_db_schemaroot + ".v_phanquyen OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + m_db_schemaroot + ".v_phanquyennhom(id_nhom numeric(5), menuname text, chon numeric(1) DEFAULT 0, chitiet text, CONSTRAINT pk_v_phanquyennhom PRIMARY KEY (id_nhom,menuname)) WITH OIDS");
                execute_data("ALTER TABLE " + m_db_schemaroot + ".v_phanquyennhom OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + m_db_schemaroot + ".v_nhomdlogin(id numeric(5),nhom numeric(1),ma varchar(20), ten text, diengiai text, id_bv_so varchar(4000) DEFAULT 0,right_ varchar(4000), readonly numeric(1) DEFAULT 0,CONSTRAINT pk_v_nhomdlogin PRIMARY KEY (id)) WITH OIDS");
                execute_data("ALTER TABLE " + m_db_schemaroot + ".v_nhomdlogin OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + m_db_schemaroot + ".v_dlogin(id numeric(5) NOT NULL DEFAULT 0,id_nhom numeric(5) NOT NULL DEFAULT 0,hoten text,userid varchar(20),password_ varchar(20),right_ text,loaivp text,mucvp text,loai text,madoituong varchar(20),admin numeric(1) DEFAULT 0,capso numeric(6) DEFAULT 0,nhomvp text,nhombc text,id_nhom numeric(5) DEFAULT 0,CONSTRAINT pk_v_dlogin PRIMARY KEY (id)) WITH OIDS");
                execute_data("ALTER TABLE " + m_db_schemaroot + ".v_dlogin OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + m_db_schemaroot + ".v_capid(ma numeric(3) NOT NULL DEFAULT 0,ten varchar(20),id numeric(12) DEFAULT 0,computer varchar(20) NOT NULL DEFAULT '?'::character varying,CONSTRAINT pk_v_capid PRIMARY KEY (computer, ma)) WITH OIDS");
                execute_data("ALTER TABLE " + m_db_schemaroot + ".v_capid OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + m_db_schemaroot + ".v_dmlydonopthem(id numeric(2) DEFAULT 0,ten text,ngayud timestamp DEFAULT now(), readonly numeric(1) default 0, CONSTRAINT pk_v_dmlydonopthem PRIMARY KEY (id)) WITH OIDS");
                execute_data("ALTER TABLE " + m_db_schemaroot + ".v_dmlydonopthem OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + m_db_schemaroot + ".v_dmlydothieu(id numeric(2) NOT NULL DEFAULT 0,ten text,ngayud timestamp DEFAULT now(), readonly numeric(1) default 0,CONSTRAINT pk_v_dmlydothieu PRIMARY KEY (id)) WITH OIDS");
                execute_data("ALTER TABLE " + m_db_schemaroot + ".v_dmlydothieu OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + m_db_schemaroot + ".v_dsduyet(ma numeric(4) NOT NULL DEFAULT 0,ten text,ngayud timestamp DEFAULT now(),readonly numeric(1) default 0, CONSTRAINT pk_v_dsduyet PRIMARY KEY (ma)) WITH OIDS");
                execute_data("ALTER TABLE " + m_db_schemaroot + ".v_dsduyet OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + m_db_schemaroot + ".v_error(message text,computer varchar(20),tables varchar(20),ngayud timestamp DEFAULT now()) WITH OIDS");
                execute_data("ALTER TABLE " + m_db_schemaroot + ".v_error OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + m_db_schemaroot + ".v_ghichu(id numeric(1) NOT NULL DEFAULT 0,ten text,readonly numeric(1) defaulu 0,CONSTRAINT pk_v_ghichu PRIMARY KEY (id)) WITH OIDS");
                execute_data("ALTER TABLE " + m_db_schemaroot + ".v_ghichu OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + m_db_schemaroot + ".v_nhombhyt(id numeric(2) NOT NULL DEFAULT 0,stt numeric(2) DEFAULT 0,ten text, viettat text,ngayud timestamp DEFAULT now(),readonly numeric(1) default 0,CONSTRAINT pk_v_nhombhyt PRIMARY KEY (id)) WITH OIDS");
                execute_data("ALTER TABLE " + m_db_schemaroot + ".v_nhombhyt OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + m_db_schemaroot + ".v_nhomvp(ma numeric(3) NOT NULL DEFAULT 0,ten text,stt numeric(3) DEFAULT 0,idnhombhyt numeric(2) DEFAULT 0,matat varchar(10),dongia numeric(10) DEFAULT 0,ngayud timestamp DEFAULT now(),trongoi text,readonly numeric(1) default 0,CONSTRAINT pk_v_nhomvp PRIMARY KEY (id)) WITH OIDS");
                execute_data("ALTER TABLE " + m_db_schemaroot + ".v_nhomvp OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + m_db_schemaroot + ".v_loaivp(id numeric(3) NOT NULL DEFAULT 0,id_nhom numeric(3) DEFAULT 0,stt numeric(3) DEFAULT 0,ma text,ten text,userid numeric(5) DEFAULT 0,ngayud timestamp DEFAULT now(),computer varchar(20),readonly numeric(1) default 0,CONSTRAINT pk_v_loaivp PRIMARY KEY (id)) WITH OIDS");
                execute_data("ALTER TABLE " + m_db_schemaroot + ".v_loaivp OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + m_db_schemaroot + ".v_giavp(id numeric(10) NOT NULL DEFAULT 0,id_loai numeric(3) DEFAULT 0,stt numeric(5) DEFAULT 0,ma text,ten text,dvt varchar(20),gia_th numeric(10) DEFAULT 0,gia_bh numeric(10) DEFAULT 0,gia_dv numeric(10) DEFAULT 0,bhyt numeric(3) DEFAULT 0,userid numeric(5) DEFAULT 0,ngayud timestamp DEFAULT now(),gia_nn numeric(10) DEFAULT 0,gia_cs numeric(10) DEFAULT 0,vattu_th numeric(10) DEFAULT 0,vattu_bh numeric(10) DEFAULT 0,vattu_dv numeric(10) DEFAULT 0,vattu_nn numeric(10) DEFAULT 0,vattu_cs numeric(10) DEFAULT 0, loaibn numeric(1) DEFAULT 0,theobs numeric(1) DEFAULT 0,trongoi numeric(1) DEFAULT 0,chenhlech numeric(1) DEFAULT 0,loaitrongoi numeric(1) DEFAULT 0,locthe text,readonly numeric(1) default 0,CONSTRAINT pk_v_giavp PRIMARY KEY (id)) WITH OIDS");
                execute_data("ALTER TABLE " + m_db_schemaroot + ".v_giavp OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + m_db_schemaroot + ".v_giavattu(id numeric(7) NOT NULL DEFAULT 0,mavp numeric(10) NOT NULL DEFAULT 0,stt numeric(5) DEFAULT 0,soluong numeric(7) DEFAULT 0,gia_th numeric(10) DEFAULT 0,gia_bh numeric(10) DEFAULT 0,gia_dv numeric(10) DEFAULT 0,gia_nn numeric(10) DEFAULT 0,CONSTRAINT pk_v_giavattu PRIMARY KEY (id,mavp)) WITH OIDS");
                execute_data("ALTER TABLE " + m_db_schemaroot + ".v_giavattu OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + m_db_schemaroot + ".v_khambenh(ngay timestamp NOT NULL,kyhieu varchar(20),tu numeric(7) DEFAULT 0,den numeric(7) DEFAULT 0,nguoilon numeric(7) DEFAULT 0,treem numeric(7) DEFAULT 0,userid numeric(5) NOT NULL DEFAULT 0,ngayud timestamp DEFAULT now()) WITH OIDS");
                execute_data("ALTER TABLE " + m_db_schemaroot + ".v_khambenh OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + m_db_schemaroot + ".v_loaibn(id numeric(1) NOT NULL DEFAULT 0,ten text,readonly numeric(1) default 0,CONSTRAINT pk_v_loaibn PRIMARY KEY (id)) WITH OIDS");
                execute_data("ALTER TABLE " + m_db_schemaroot + ".v_loaibn OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + m_db_schemaroot + ".v_lydomien(id numeric(2) NOT NULL DEFAULT 0,ten text,readonly numeric(1) default 0, ngayud timestamp DEFAULT now(),CONSTRAINT pk_v_lydomien PRIMARY KEY (id)) WITH OIDS");
                execute_data("ALTER TABLE " + m_db_schemaroot + ".v_lydomien OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + m_db_schemaroot + ".v_lydonopthem(id numeric(12) NOT NULL DEFAULT 0,id_lydo numeric(2) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_v_lydonopthem PRIMARY KEY (id)) WITH OIDS");
                execute_data("ALTER TABLE " + m_db_schemaroot + ".v_lydonopthem OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + m_db_schemaroot + ".v_lydothieu(id numeric(12) NOT NULL DEFAULT 0,id_lydo numeric(2) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_v_lydothieu PRIMARY KEY (id)) WITH OIDS");
                execute_data("ALTER TABLE " + m_db_schemaroot + ".v_lydothieu OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + m_db_schemaroot + ".v_paid(mabn varchar(8) NOT NULL,mavaovien numeric(11) NOT NULL DEFAULT 0,maql numeric(18) NOT NULL DEFAULT 0,idkhoa numeric(11) NOT NULL DEFAULT 0,ngayvao timestamp NOT NULL,ngayra timestamp NOT NULL) WITH OIDS");
                execute_data("ALTER TABLE " + m_db_schemaroot + ".v_paid OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + m_db_schemaroot + ".v_quyenso(id numeric(7) NOT NULL DEFAULT 0,sohieu varchar(20),tu numeric(10) DEFAULT 0,den numeric(10) DEFAULT 0,soghi numeric(10) DEFAULT 0,dangsd numeric(1) DEFAULT 0,khambenh numeric(1) DEFAULT 0,userid numeric(5) DEFAULT 0,ngayud timestamp DEFAULT now(),loai varchar(20)) WITH OIDS");
                execute_data("ALTER TABLE " + m_db_schemaroot + ".v_quyenso OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + m_db_schemaroot + ".v_tenloaivp(ma numeric(2) NOT NULL DEFAULT 0,ten text,readonly numeric(1) default 0,ngayud timestamp DEFAULT now()) WITH OIDS");
                execute_data("ALTER TABLE " + m_db_schemaroot + ".v_tenloaivp OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + m_db_schemaroot + ".v_theodoicongno(mabn varchar(8),mavaovien numeric(11) DEFAULT 0,maql numeric(1) NOT NULL DEFAULT 0,idkhoa numeric(11) NOT NULL DEFAULT 0,madoituong numeric(1) NOT NULL DEFAULT 0,thuoc numeric(15) DEFAULT 0,vienphi numeric(15) DEFAULT 0,tamung numeric(10) DEFAULT 0,mien numeric(15) DEFAULT 0,done numeric(1) DEFAULT 0) WITH OIDS");
                execute_data("ALTER TABLE " + m_db_schemaroot + ".v_theodoicongno OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + m_db_schemaroot + ".v_thongso(id numeric(3) NOT NULL DEFAULT 0,loai text,ten text,ngayud timestamp DEFAULT now()) WITH OIDS");
                execute_data("ALTER TABLE " + m_db_schemaroot + ".v_thongso OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + m_db_schemaroot + ".v_trongoi(id numeric(7) NOT NULL DEFAULT 0,id_nhom numeric(3) NOT NULL DEFAULT 0,id_loai numeric(3) NOT NULL DEFAULT 0,id_gia numeric(7) NOT NULL DEFAULT 0,sotien numeric(12) DEFAULT 0,stt numeric(3) DEFAULT 0) WITH OIDS");
                execute_data("ALTER TABLE " + m_db_schemaroot + ".v_trongoi OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + m_db_schemaroot + ".v_tygia(ngay timestamp NOT NULL,tygia numeric(10) DEFAULT 0,userid numeric(5) DEFAULT 0,ngayud timestamp DEFAULT now()) WITH OIDS");
                execute_data("ALTER TABLE " + m_db_schemaroot + ".v_tygia OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + m_db_schemaroot + ".v_viettat(stt numeric(7), ma text, ten text, readonly numeric(1) DEFAULT 0,CONSTRAINT pk_v_viettat PRIMARY KEY (ma)) WITH OIDS");
                execute_data("ALTER TABLE " + m_db_schemaroot + ".v_viettat OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + m_db_schemaroot + ".vp_license(computer_key text NOT NULL,license_key text) WITHOUT OIDS");
                execute_data("ALTER TABLE " + m_db_schemaroot + ".vp_license OWNER TO " + m_db_database + "");


            }
            catch
            {
            }
        }
        public void f_create_v_khoaso()
        {
            execute_data("CREATE TABLE " + m_db_schemaroot + ".v_khoaso(userid numeric(5),ngay varchar2(10), songay numeric(3) default 0, constraint pk_v_khoaso primary key(userid)) WITH OIDS");
            execute_data("ALTER TABLE " + m_db_schemaroot + ".v_khoaso OWNER TO " + m_db_database + "");
        }
        public void f_upd_v_khoaso()
        {
            try
            {
                try
                {
                    int atmp = get_data("select songay from medibv.v_khoaso limit 1").Tables[0].Rows.Count;
                }
                catch
                {
                    f_create_v_khoaso();
                }
                execute_data("insert into medibv.v_khoaso(userid,ngay,songay) select id,'xx/xx/xxxx',0 from medibv.v_dlogin where id not in (select id from medibv.v_khoaso)");
                foreach (DataRow r in get_data("select userid,songay from medibv.v_khoaso where songay>0").Tables[0].Rows)
                {
                    execute_data("update medibv.v_khoaso set ngay=to_char(now()-" + r["songay"].ToString() + ",'dd/mm/yyyy') where userid=" + r["userid"].ToString());
                }
            }
            catch
            {
            }
        }
        public void f_create_v_nhomdlogin()
        {
            execute_data("CREATE TABLE " + m_db_schemaroot + ".v_nhomdlogin(id numeric(5),nhom numeric(1),ma varchar(20), ten text, diengiai text, id_bv_so varchar(4000) DEFAULT 0,right_ varchar(4000), readonly numeric(1) DEFAULT 0,CONSTRAINT pk_v_nhomdlogin PRIMARY KEY (id)) WITH OIDS");
            execute_data("ALTER TABLE " + m_db_schemaroot + ".v_nhomdlogin OWNER TO " + m_db_database + "");
            execute_data("ALTER TABLE " + m_db_schemaroot + ".v_dlogin add id_nhom numeric(5) default 0");
            execute_data("update " + m_db_schemaroot + ".v_dlogin set id_nhom=1 where id_nhom is null or id_nhom=0");
        }
        public void f_create_v_optionhotkey()
        {
            execute_data("CREATE TABLE " + m_db_schemaroot + ".v_optionhotkey(userid numeric(5),loai numeric(2),hotkey varchar(10), id numeric(7), ghichu text, CONSTRAINT pk_v_optionhotkey PRIMARY KEY (userid,loai,hotkey,id)) WITH OIDS");
            execute_data("ALTER TABLE " + m_db_schemaroot + ".v_optionhotkey OWNER TO " + m_db_database + "");
        }
        public void f_create_v_optionhotkey_ksk()
        {
            execute_data("CREATE TABLE " + m_db_schemaroot + ".v_optionhotkey_ksk(userid numeric(5),loai numeric(2),hotkey varchar(10), id numeric(7), ghichu text, CONSTRAINT pk_v_optionhotkey_ksk PRIMARY KEY (userid,loai,hotkey,id)) WITH OIDS");
            execute_data("ALTER TABLE " + m_db_schemaroot + ".v_optionhotkey_ksk OWNER TO " + m_db_database + "");
        }
        public void f_create_v_optionlien()
        {
            execute_data("CREATE TABLE " + m_db_schemaroot + ".v_optionlien(stt numeric(5),ten text, tenreport text) WITH OIDS");
            execute_data("ALTER TABLE " + m_db_schemaroot + ".v_optionlien OWNER TO " + m_db_database + "");
        }
        public void f_Macdinh_Solien()
        {
            string atmp = "";
            execute_data("delete from medibv.v_optionlien");

            atmp = sys_report_thutructiep;
            upd_v_optionlien(1, "Liên 1: Giao cho bệnh nhân", atmp);
            upd_v_optionlien(2, "Liên 2: Lưu", atmp);

            atmp = sys_report_thutructiep_thuong;
            upd_v_optionlien(1, "Liên 1: Giao cho bệnh nhân", atmp);
            upd_v_optionlien(2, "Liên 2: Lưu", atmp);

            atmp = sys_report_thutructiep_gtgt;
            upd_v_optionlien(1, "Liên 1: Giao cho bệnh nhân", atmp);
            upd_v_optionlien(2, "Liên 2: Lưu", atmp);

            atmp = sys_report_thutamung;
            upd_v_optionlien(1, "Liên 1: Giao cho bệnh nhân", atmp);
            upd_v_optionlien(2, "Liên 2: Lưu", atmp);

            atmp = sys_report_ravien;
            upd_v_optionlien(1, "Liên 1: Giao cho bệnh nhân", atmp);
            upd_v_optionlien(2, "Liên 2: Lưu", atmp);

            atmp = sys_report_ravien_thuong;
            upd_v_optionlien(1, "Liên 1: Giao cho bệnh nhân", atmp);
            upd_v_optionlien(2, "Liên 2: Lưu", atmp);

            atmp = sys_report_ravien_chi;
            upd_v_optionlien(1, "Liên 1: Giao cho bệnh nhân", atmp);
            upd_v_optionlien(2, "Liên 2: Lưu", atmp);

            atmp = sys_report_phieuchi;
            upd_v_optionlien(1, "Liên 1: Giao cho bệnh nhân", atmp);
            upd_v_optionlien(2, "Liên 2: Lưu", atmp);

            atmp = sys_report_thutrongoi;
            upd_v_optionlien(1, "Liên 1: Giao cho bệnh nhân", atmp);
            upd_v_optionlien(2, "Liên 2: Lưu", atmp);

            atmp = sys_report_bhyt;
            upd_v_optionlien(1, "Liên 1: Giao cho bệnh nhân", atmp);
            upd_v_optionlien(2, "Liên 2: Lưu", atmp);

            atmp = sys_report_inhoantra;
            upd_v_optionlien(1, "Liên 1: Giao cho bệnh nhân", atmp);
            upd_v_optionlien(2, "Liên 2: Lưu", atmp);

        }
        public DataSet f_get_hotkey(string v_userid, string v_loai)
        {
            string sql = "", auserid = "", aloai = "";
            try
            {
                auserid = decimal.Parse(v_userid).ToString();
            }
            catch
            {
                auserid = "-1";
            }
            try
            {
                aloai = decimal.Parse(v_loai).ToString();
            }
            catch
            {
                aloai = "-1";
            }
            sql = "select userid,loai,trim(hotkey) as hotkey,id,trim(ghichu) as ghichu from medibv.v_optionhotkey where userid=" + v_userid + " and loai = " + v_loai;
            DataSet ads = null;
            try
            {
                ads = get_data(sql);
                if (ads == null)
                {
                    f_create_v_optionhotkey();
                    ads = get_data(sql);
                }
            }
            catch
            {
                f_create_v_optionhotkey();
                ads = get_data(sql);
            }
            return ads;
        }
        public DataSet f_get_hotkey_frmthutructiep(string v_userid)
        {
            return f_get_hotkey(v_userid, s_loaiform_thutructiep);
        }
        public DataSet f_get_hotkey_frmthuchiravien(string v_userid)
        {
            return f_get_hotkey(v_userid, s_loaiform_thuchiravien);
        }
        public DataSet f_get_hotkey_frmthutrongoi(string v_userid)
        {
            return f_get_hotkey(v_userid, s_loaiform_thutrongoi);
        }
        public DataSet f_get_hotkey_frmphieuchi(string v_userid)
        {
            return f_get_hotkey(v_userid, s_loaiform_phieuchi);
        }
        public DataSet f_get_hotkey_frmvienphibhyt(string v_userid)
        {
            return f_get_hotkey(v_userid, s_loaiform_bhyt);
        }
        public DataSet f_get_hotkey_ksk(string v_userid, string v_loai)
        {
            string sql = "", auserid = "", aloai = "";
            try
            {
                auserid = decimal.Parse(v_userid).ToString();
            }
            catch
            {
                auserid = "-1";
            }
            try
            {
                aloai = decimal.Parse(v_loai).ToString();
            }
            catch
            {
                aloai = "-1";
            }
            sql = "select userid,loai,trim(hotkey) as hotkey,id,trim(ghichu) as ghichu from medibv.v_optionhotkey_ksk where userid=" + v_userid + " and loai = " + v_loai;
            DataSet ads = null;
            try
            {
                ads = get_data(sql);
                if (ads == null)
                {
                    f_create_v_optionhotkey_ksk();
                    ads = get_data(sql);
                }
            }
            catch
            {
                f_create_v_optionhotkey_ksk();
                ads = get_data(sql);
            }
            return ads;
        }
        public DataSet f_get_hotkey_ksk_frmthutructiep(string v_userid)
        {
            return f_get_hotkey_ksk(v_userid, s_loaiform_thutructiep);
        }
        public DataSet f_get_hotkey_ksk_frmthuchiravien(string v_userid)
        {
            return f_get_hotkey_ksk(v_userid, s_loaiform_thuchiravien);
        }
        public DataSet f_get_hotkey_ksk_frmthutrongoi(string v_userid)
        {
            return f_get_hotkey_ksk(v_userid, s_loaiform_thutrongoi);
        }
        public DataSet f_get_hotkey_ksk_frmphieuchi(string v_userid)
        {
            return f_get_hotkey_ksk(v_userid, s_loaiform_phieuchi);
        }
        public DataSet f_get_hotkey_ksk_frmvienphibhyt(string v_userid)
        {
            return f_get_hotkey_ksk(v_userid, s_loaiform_bhyt);
        }
        public DataSet f_get_solien(string v_report)
        {
            return get_data("select ten from medibv.v_optionlien where tenreport = '" + v_report + "' order by stt");
        }
        public DataSet f_get_solien()
        {
            return get_data("select * from medibv.v_optionlien");
        }
        public bool bMmyy(string m_mmyy)
        {
            return get_data("select * from medibv.table where mmyy='" + ((m_mmyy.Trim().Length == 4) ? m_mmyy : get_mmyy(m_mmyy)) + "'").Tables[0].Rows.Count > 0;
        }
        public void create_tables_vp_mmyy(string v_mmyy)
        {
            try
            {
                string aschema = s_schema_mmyy(v_mmyy);

                execute_data("CREATE TABLE " + aschema + ".v_bhyt(id numeric(12) NOT NULL DEFAULT 0,sothe varchar(16),maphu numeric(1) DEFAULT 0,mabv varchar(8),noigioithieu varchar(8)) WITH OIDS");
                execute_data("ALTER TABLE " + aschema + ".v_bhyt OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + aschema + ".v_chidinh(id numeric(12) NOT NULL DEFAULT 0,mabn varchar(8),mavaovien numeric(11) DEFAULT 0,maql numeric(18) DEFAULT 0,idkhoa numeric(11) DEFAULT 0,ngay timestamp,loai numeric(1) DEFAULT 0,makp varchar(2),madoituong numeric(2) DEFAULT 0,mavp numeric(10) DEFAULT 0,soluong numeric(7) DEFAULT 0,dongia numeric(11) DEFAULT 0,paid numeric(1) DEFAULT 0,done numeric(1) DEFAULT 0,userid numeric(5) DEFAULT 0,ngayud timestamp DEFAULT now(),vattu numeric(10) DEFAULT 0,tinhtrang numeric(1) DEFAULT 0,thuchien numeric(1) DEFAULT 0,computer varchar(20)) WITH OIDS");
                execute_data("ALTER TABLE " + aschema + ".v_chidinh OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + aschema + ".v_congno(mabn varchar(8),mavaovien numeric(11) DEFAULT 0,maql numeric(18) NOT NULL DEFAULT 0,idkhoa numeric(11) NOT NULL DEFAULT 0,mavp numeric(10) NOT NULL DEFAULT 0,sotien numeric(15,4) DEFAULT 0,dathu numeric(15,4) DEFAULT 0) WITH OIDS");
                execute_data("ALTER TABLE " + aschema + ".v_congno OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + aschema + ".v_error(message text,computer varchar(20),tables varchar(20),ngayud timestamp DEFAULT now()) WITH OIDS");
                execute_data("ALTER TABLE " + aschema + ".v_error OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + aschema + ".v_giuong(id numeric(12) NOT NULL DEFAULT 0,mavp numeric(10) NOT NULL DEFAULT 0,ngay timestamp NOT NULL,dongia numeric(10) DEFAULT 0) WITH OIDS");
                execute_data("ALTER TABLE " + aschema + ".v_giuong OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + aschema + ".v_hoantra(id numeric(12) NOT NULL DEFAULT 0,quyenso numeric(7) DEFAULT 0,sobienlai numeric(7) DEFAULT 0,ngay timestamp,mabn varchar(8),mavaovien numeric(11) DEFAULT 0,maql numeric(18) DEFAULT 0,hoten text,sotien numeric(15,4) DEFAULT 0,ghichu text,userid numeric(5) DEFAULT 0,ngayud timestamp DEFAULT now(),loai numeric(1) DEFAULT 0,loaibn numeric(2) DEFAULT 0) WITH OIDS");
                execute_data("ALTER TABLE " + aschema + ".v_hoantra OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + aschema + ".v_hoantract(id numeric(12) NOT NULL DEFAULT 0,loaivp numeric(7) NOT NULL DEFAULT 0,sotien numeric(15,4) DEFAULT 0) WITH OIDS");
                execute_data("ALTER TABLE " + aschema + ".v_hoantract OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + aschema + ".v_huybienlai(id numeric(12) NOT NULL DEFAULT 0,tables varchar(20) NOT NULL,loai numeric(2) DEFAULT 0,mabn varchar(8),hoten text,makp varchar(2),ngay timestamp,quyenso numeric(7) DEFAULT 0,sobienlai numeric(7) DEFAULT 0,lydo text,userid numeric(5) DEFAULT 0,ngayud timestamp DEFAULT now()) WITH OIDS");
                execute_data("ALTER TABLE " + aschema + ".v_huybienlai OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + aschema + ".v_mienngtru(id numeric(12) NOT NULL DEFAULT 0,sotien numeric(15,4) DEFAULT 0,ghichu text,maduyet numeric(4) DEFAULT 0,lydo numeric(2) DEFAULT 0) WITH OIDS");
                execute_data("ALTER TABLE " + aschema + ".v_mienngtru OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + aschema + ".v_miennoitru(id numeric(12) NOT NULL DEFAULT 0,lydo numeric(2) DEFAULT 0,ghichu text,maduyet numeric(4) DEFAULT 0) WITH OIDS");
                execute_data("ALTER TABLE " + aschema + ".v_miennoitru OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + aschema + ".v_nhom(id numeric(12) NOT NULL DEFAULT 0,ma numeric(3) NOT NULL DEFAULT 0,sotien numeric(15,4) DEFAULT 0) WITH OIDS");
                execute_data("ALTER TABLE " + aschema + ".v_nhom OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + aschema + ".v_phieuchict(id numeric(12) NOT NULL DEFAULT 0,stt numeric(3) NOT NULL DEFAULT 0,mavp numeric(10) DEFAULT 0,sotien numeric(15,4) DEFAULT 0) WITH OIDS");
                execute_data("ALTER TABLE " + aschema + ".v_phieuchict OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + aschema + ".v_phieuchill(id numeric(12) NOT NULL DEFAULT 0,quyenso numeric(7) DEFAULT 0,sobienlai numeric(7) DEFAULT 0,ngay timestamp,mabn varchar(8),maql numeric(18) DEFAULT 0,idkhoa numeric(11) DEFAULT 0,makp varchar(2),hoten text,loai numeric(2) DEFAULT 0,loaibn numeric(2) DEFAULT 0,userid numeric(5) DEFAULT 0,ngayud timestamp DEFAULT now()) WITH OIDS");
                execute_data("ALTER TABLE " + aschema + ".v_phieuchill OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + aschema + ".v_tamung(id numeric(12) NOT NULL DEFAULT 0,mabn varchar(8),mavaovien numeric(11) DEFAULT 0,maql numeric(18) DEFAULT 0,idkhoa numeric(11) DEFAULT 0,quyenso numeric(7) DEFAULT 0,sobienlai numeric(7) DEFAULT 0,ngay timestamp,loai numeric(1) DEFAULT 0,makp varchar(2),madoituong numeric(2) DEFAULT 0,sotien numeric(15,4) DEFAULT 0,userid numeric(5) DEFAULT 0,ngayud timestamp DEFAULT now(),done numeric(1) DEFAULT 0,lanin numeric(2) DEFAULT 0,loaibn numeric(2) DEFAULT 0,idttrv numeric(12) DEFAULT 0) WITH OIDS");
                execute_data("ALTER TABLE " + aschema + ".v_tamung OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + aschema + ".v_tamungct(id numeric(12) NOT NULL DEFAULT 0,loaivp numeric(3) NOT NULL DEFAULT 0,sotien numeric(15,4) DEFAULT 0) WITH OIDS");
                execute_data("ALTER TABLE " + aschema + ".v_tamungct OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + aschema + ".v_theodoihuy(tables varchar(20),id numeric(12) DEFAULT 0,ma numeric(7) DEFAULT 0,soluong numeric(10,2) DEFAULT 0,computer varchar(20),userid numeric(5) DEFAULT 0,ngayud timestamp DEFAULT now()) WITH OIDS");
                execute_data("ALTER TABLE " + aschema + ".v_theodoihuy OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + aschema + ".v_theodoisua(tables varchar(20),id numeric(12) DEFAULT 0,ma numeric(7) DEFAULT 0,soluong numeric(10,2) DEFAULT 0,computer varchar(20),userid numeric(5) DEFAULT 0,ngayud timestamp DEFAULT now()) WITH OIDS");
                execute_data("ALTER TABLE " + aschema + ".v_theodoisua OWNER TO " + m_db_database + "");


                execute_data("CREATE TABLE " + aschema + ".v_thngayct(id numeric(12) NOT NULL DEFAULT 0,ngay timestamp NOT NULL,mavp numeric(10) NOT NULL DEFAULT 0,soluong numeric(10,2) DEFAULT 0,dongia numeric(24,10) NOT NULL DEFAULT 0,sotien numeric(15,4) DEFAULT 0) WITH OIDS");
                execute_data("ALTER TABLE " + aschema + ".v_thngayct OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + aschema + ".v_thngayll(id numeric(12) NOT NULL DEFAULT 0,madoituong numeric(2) DEFAULT 0,mabn varchar(8),mavaovien numeric(11) DEFAULT 0,maql numeric(18) DEFAULT 0,ngayvao timestamp,tu timestamp,den timestamp,giuong varchar(10),makp varchar(2),conlai numeric(15,4) DEFAULT 0,sotien numeric(15,4) DEFAULT 0,datra numeric(15,4) DEFAULT 0,done numeric(1) DEFAULT 0) WITH OIDS");
                execute_data("ALTER TABLE " + aschema + ".v_thngayll OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + aschema + ".v_thvpbhyt(id numeric(12) NOT NULL DEFAULT 0,sothe varchar(16),maphu numeric(1) DEFAULT 0,noigioithieu varchar(8),noicap varchar(8)) WITH OIDS");
                execute_data("ALTER TABLE " + aschema + ".v_thvpbhyt OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + aschema + ".v_thvpct(id numeric(12) NOT NULL DEFAULT 0,ngay timestamp NOT NULL,makp varchar(2) NOT NULL,madoituong numeric(2) NOT NULL DEFAULT 0,mavp numeric(10) NOT NULL DEFAULT 0,soluong numeric(10,2) DEFAULT 0,dongia numeric(24,10) NOT NULL DEFAULT 0,sotien numeric(15,4) DEFAULT 0,vattu numeric(10) DEFAULT 0) WITH OIDS");
                execute_data("ALTER TABLE " + aschema + ".v_thvpct OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + aschema + ".v_thvpll(id numeric(12) NOT NULL DEFAULT 0,mabn varchar(8),mavaovien numeric(11) DEFAULT 0,maql numeric(18) DEFAULT 0,idkhoa numeric(11) DEFAULT 0,ngayvao timestamp,ngayra timestamp,giuong varchar(10),makp varchar(2),chandoan text,maicd varchar(9),sotien numeric(15,4) DEFAULT 0,tamung numeric(10) DEFAULT 0,bhyt numeric(15,4) DEFAULT 0,mien numeric(15,4) DEFAULT 0,done numeric(1) DEFAULT 0) WITH OIDS");
                execute_data("ALTER TABLE " + aschema + ".v_thvpll OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + aschema + ".v_trongoi(id numeric(12) NOT NULL DEFAULT 0,sotien numeric(10) DEFAULT 0,tamung numeric(10) DEFAULT 0,hoantra numeric(10) DEFAULT 0,pm numeric(1) DEFAULT 0,yc numeric(1) DEFAULT 0,ghichu text) WITH OIDS");
                execute_data("ALTER TABLE " + aschema + ".v_trongoi OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + aschema + ".v_ttrvbhyt(id numeric(12) NOT NULL DEFAULT 0,sothe varchar(16),maphu numeric(1) DEFAULT 0,tungay timestamp,ngay timestamp,mabv varchar(8),noigioithieu varchar(8)) WITH OIDS");
                execute_data("ALTER TABLE " + aschema + ".v_ttrvbhyt OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + aschema + ".v_ttrvct(id numeric(12) NOT NULL DEFAULT 0,stt numeric(5) NOT NULL DEFAULT 0,ngay timestamp,makp varchar(2),madoituong numeric(2) DEFAULT 0,mavp numeric(10) DEFAULT 0,soluong numeric(10,2) DEFAULT 0,dongia numeric(24,10) DEFAULT 0,vat numeric(3) DEFAULT 0,vattu numeric(10) DEFAULT 0,sotien numeric(15,4) DEFAULT 0) WITH OIDS");
                execute_data("ALTER TABLE " + aschema + ".v_ttrvct OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + aschema + ".v_ttrvds(id numeric(12) NOT NULL DEFAULT 0,mabn varchar(8),mavaovien numeric(11) DEFAULT 0,maql numeric(18) DEFAULT 0,idkhoa numeric(11) DEFAULT 0,giuong varchar(10),ngayvao timestamp,ngayra timestamp,chandoan text,maicd varchar(9)) WITH OIDS");
                execute_data("ALTER TABLE " + aschema + ".v_ttrvds OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + aschema + ".v_ttrvll(id numeric(12) NOT NULL DEFAULT 0,loaibn numeric(2) DEFAULT 0,loai numeric(2) DEFAULT 0,quyenso numeric(7) DEFAULT 0,sobienlai numeric(7) DEFAULT 0,ngay timestamp,makp varchar(2),sotien numeric(15,4) DEFAULT 0,tamung numeric(10) DEFAULT 0,mien numeric(15,4) DEFAULT 0,bhyt numeric(15,4) DEFAULT 0,userid numeric(5) DEFAULT 0,ngayud timestamp DEFAULT now(),nopthem numeric(15,4) DEFAULT 0,thieu numeric(15,4) DEFAULT 0,vattu numeric(10) DEFAULT 0,lanin numeric(2) DEFAULT 0,idtonghop numeric(12) DEFAULT 0,chenhlech numeric(15,4) DEFAULT 0) WITH OIDS");
                execute_data("ALTER TABLE " + aschema + ".v_ttrvll OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + aschema + ".v_ttrvnhom(id numeric(12) NOT NULL DEFAULT 0,ma numeric(3) NOT NULL DEFAULT 0,sotien numeric(15,4) DEFAULT 0) WITH OIDS");
                execute_data("ALTER TABLE " + aschema + ".v_ttrvnhom OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + aschema + ".v_ttrvpttt(id numeric(12) NOT NULL DEFAULT 0,ngay timestamp,songay_tpt numeric(3) DEFAULT 0,songay_spt numeric(3) DEFAULT 0,mavp numeric(10) DEFAULT 0,so numeric(1) DEFAULT 0,loaipt numeric(1) DEFAULT 0,tenpt text) WITH OIDS");
                execute_data("ALTER TABLE " + aschema + ".v_ttrvpttt OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + aschema + ".v_ttrvptttct(id numeric(12) NOT NULL DEFAULT 0,stt numeric(1) NOT NULL DEFAULT 0,songay numeric(3) DEFAULT 0,dongia numeric(10) DEFAULT 0,loaipt numeric(2) DEFAULT 0) WITH OIDS");
                execute_data("ALTER TABLE " + aschema + ".v_ttrvptttct OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + aschema + ".v_vienphict(id numeric(12) NOT NULL DEFAULT 0,stt numeric(3) NOT NULL DEFAULT 0,madoituong numeric(2) DEFAULT 0,mavp numeric(10) DEFAULT 0,ten text,soluong numeric(10,2) DEFAULT 0,dongia numeric(15,4) DEFAULT 0,mien numeric(15,4) DEFAULT 0,thieu numeric(15,4) DEFAULT 0,vattu numeric(10) DEFAULT 0,mabs varchar(4),makp varchar(2)) WITH OIDS");
                execute_data("ALTER TABLE " + aschema + ".v_vienphict OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + aschema + ".v_vienphill(id numeric(12) NOT NULL DEFAULT 0,quyenso numeric(7) DEFAULT 0,sobienlai numeric(7) DEFAULT 0,ngay timestamp,mabn varchar(8),mavaovien numeric(11) DEFAULT 0,maql numeric(18) DEFAULT 0,idkhoa numeric(11) DEFAULT 0,makp varchar(2),hoten text,namsinh varchar(4),diachi text,loai numeric(2) DEFAULT 0,loaibn numeric(2) DEFAULT 0,lanin numeric(2) DEFAULT 0,userid numeric(5) DEFAULT 0,ngayud timestamp DEFAULT now(),masothue varchar(20)) WITH OIDS");
                execute_data("ALTER TABLE " + aschema + ".v_vienphill OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + aschema + ".v_vpkhoa(id numeric(12) NOT NULL DEFAULT 0,mabn varchar(8),mavaovien numeric(11) DEFAULT 0,maql numeric(18) DEFAULT 0,idkhoa numeric(11) DEFAULT 0,ngay timestamp,makp varchar(2),madoituong numeric(2) DEFAULT 0,mavp numeric(10) DEFAULT 0,soluong numeric(10,2) DEFAULT 0,dongia numeric(15,4) DEFAULT 0,done numeric(1) DEFAULT 0,userid numeric(5) DEFAULT 0,ngayud timestamp DEFAULT now(),vattu numeric(10) DEFAULT 0,readonly numeric(1) DEFAULT 0,buoi numeric(1) DEFAULT 0) WITH OIDS");
                execute_data("ALTER TABLE " + aschema + ".v_vpkhoa OWNER TO " + m_db_database + "");

            }
            catch
            {
            }
        }
        /// <summary>
        ///  Begin dong
        /// </summary>
        /// <param name="i_id"></param>
        /// <returns></returns>
        public bool bServercenter(int i_id)
        {
            try
            {
                DataSet ds = get_data("select trungtam from " + user + ".dmchinhanh where id=" + i_id + " and trungtam=1");
                return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
            }
            catch { return false; }
        }
        public string get_Tendatabase(int i_idcoso)
        {
            string stendata = "";
            try
            {
                stendata = get_data("select database from " + user + ".dmchinhanh where id=" + i_idcoso + "").Tables[0].Rows[0]["database"].ToString();
            }
            catch
            {
                return stendata;
            }
            return stendata;
        }
        public void modify_tables_vp()
        {
            try
            {
                execute_data("CREATE TABLE " + m_db_schemaroot + ".vp_treemenu(id numeric(5), id_cha numeric(5), stt numeric(5), ten text, sql text, tenfield text, captionfield text, width text, report text,readonly numeric(1) default 0, CONSTRAINT pk_vp_treemenu PRIMARY KEY (id)) WITH OIDS");
                execute_data("ALTER TABLE " + m_db_schemaroot + ".vp_treemenu OWNER TO " + m_db_database + "");

                execute_data("CREATE TABLE " + m_db_schemaroot + ".vp_null(id text, ten text, readonly numeric(1) default 0, CONSTRAINT pk_vp_null PRIMARY KEY (id)) WITH OIDS");
                execute_data("ALTER TABLE " + m_db_schemaroot + ".vp_null OWNER TO " + m_db_database + "");

                execute_data("alter table " + m_db_schemaroot + ".v_quyenso add ngaylinh timestamp DEFAULT now()");
                execute_data("alter table " + m_db_schemaroot + ".v_quyenso add hide numeric(1) default 0");

                execute_data("alter table " + m_db_schemaroot + ".v_giavp_luu add thuong numeric(1) default 0");
                execute_data("alter table " + m_db_schemaroot + ".v_giavp_luu add readonly numeric(1) default 0");
                execute_data("alter table " + m_db_schemaroot + ".v_giavp_luu add ndm numeric(1) default 0");
                execute_data("alter table " + m_db_schemaroot + ".v_giavp_luu add tylekhuyenmai numeric(3) default 0");
                execute_data("alter table " + m_db_schemaroot + ".v_giavp_luu add hide numeric(1) DEFAULT 0");
                execute_data("alter table " + m_db_schemaroot + ".v_giavp_luu add gia_ksk numeric(10) DEFAULT 0");
                execute_data("alter table " + m_db_schemaroot + ".v_giavp_luu add vattu_ksk numeric(10) DEFAULT 0");
                execute_data("alter table " + m_db_schemaroot + ".v_giavp_luu add kythuat numeric(1) default -1");

                execute_data("alter table " + m_db_schemaroot + ".v_giavp add thuong numeric(1) default 0");
                execute_data("alter table " + m_db_schemaroot + ".v_giavp add readonly numeric(1) default 0");
                execute_data("alter table " + m_db_schemaroot + ".v_giavp add ndm numeric(1) default 0");
                execute_data("alter table " + m_db_schemaroot + ".v_giavp add tylekhuyenmai numeric(3) default 0");
                execute_data("alter table " + m_db_schemaroot + ".v_giavp add hide numeric(1) DEFAULT 0");
                execute_data("alter table " + m_db_schemaroot + ".v_giavp add gia_ksk numeric(10) DEFAULT 0");
                execute_data("alter table " + m_db_schemaroot + ".v_giavp add vattu_ksk numeric(10) DEFAULT 0");

                execute_data("alter table " + m_db_schemaroot + ".v_trongoi add soluong numeric(10,2) DEFAULT 0");

                execute_data("alter table " + m_db_schemaroot + ".v_dlogin add id_nhom numeric(5) default 0");
                execute_data("update " + m_db_schemaroot + ".v_dlogin set id_nhom=1 where id_nhom=0 or id_nhom is null");
                execute_data("alter table " + m_db_schemaroot + ".v_nhombhyt add viettat text");
                execute_data("alter table " + m_db_schemaroot + ".v_nhombhyt add readonly numeric(1) default 0");
                execute_data("alter table " + m_db_schemaroot + ".v_nhomvp add matat varchar(20)");
                execute_data("alter table " + m_db_schemaroot + ".v_nhomvp add viettat text");
                execute_data("alter table " + m_db_schemaroot + ".v_nhomvp add readonly numeric(1) default 0");
                execute_data("alter table " + m_db_schemaroot + ".v_loaivp add viettat text");
                execute_data("alter table " + m_db_schemaroot + ".v_loaivp add readonly numeric(1) default 0");
                execute_data("alter table " + m_db_schemaroot + ".v_giavp add theobs numeric(1) default 0");
                execute_data("alter table " + m_db_schemaroot + ".v_giavp add gia_cs numeric(10) default 0");
                execute_data("alter table " + m_db_schemaroot + ".v_giavp add vattu_cs numeric(10) default 0");
                execute_data("alter table " + m_db_schemaroot + ".v_giavp add loaitrongoi numeric(1) default 0");
                execute_data("alter table " + m_db_schemaroot + ".v_giavp add locthe text");
                execute_data("create table " + m_db_schemaroot + ".v_dmghe(id numeric(5),stt numeric(5), makp varchar2(2), ma text,ten text,constraint pk_v_dmghe primary key(id)) with oids");
                execute_data("alter table " + m_db_schemaroot + ".v_dmghe owner to " + m_db_database + "");
                execute_data("create table " + m_db_schemaroot + ".v_sdghe(id numeric(12), loai numeric(1), ghe numeric(5),constraint pk_v_sdghe primary key(id,loai,ghe)) with oids");
                execute_data("alter table " + m_db_schemaroot + ".v_sdghe owner to " + m_db_database + "");
                execute_data("create table " + m_db_schemaroot + ".v_sdvattu(mavp numeric(10), mavt numeric(7), soluong numeric(5,2), dongia numeric(12,2), sotien numeric(12,2), constraint pk_v_sdvattu primary key(mavp,mavt)) with oids");
                execute_data("alter table " + m_db_schemaroot + ".v_sdvattu owner to " + m_db_database + "");
                execute_data("create table " + m_db_schemaroot + ".v_theodoigia(mabd numeric(10), dongia numeric(12,2), constraint pk_v_theodoigia primary key(mabd)) with oids");
                execute_data("alter table " + m_db_schemaroot + ".v_theodoigia owner to " + m_db_database + "");
                execute_data("create table " + m_db_schemaroot + ".v_loaitu(id numeric(3), sotien numeric(10), ten text, ktt numeric(1) default 0, constraint pk_v_loaitu primary key(id)) with oids");
                execute_data("alter table " + m_db_schemaroot + ".v_loaitu owner to " + m_db_database + "");
                execute_data("create table " + m_db_schemaroot + ".v_option_locgiavp(userid numeric(5), loai numeric(5), ten text, id_vp varchar2(3000),constraint pk_v_option_locgiavp primary key(userid,loai)) with oids");
                execute_data("alter table " + m_db_schemaroot + ".v_option_locgiavp owner to " + m_db_database + "");
                execute_data("create table " + m_db_schemaroot + ".v_option_thutheonhom(id numeric(7), userid numeric(5), stt numeric(5), ten text, id_vp varchar2(1000), constraint pk_v_option_thutheonhom primary key(id,userid)) with oids");
                execute_data("alter table " + m_db_schemaroot + ".v_option_thutheonhom owner to " + m_db_database + "");
                execute_data("create table " + m_db_schemaroot + ".v_option(ma text,giatri text, constraint pk_v_option primary key(ma)) with oids");
                execute_data("alter table " + m_db_schemaroot + ".v_option owner to " + m_db_database + "");
                execute_data("create table " + m_db_schemaroot + ".v_optionform(userid numeric(5), loai numeric(2), ma text, ten text,giatri text, constraint pk_v_optionform primary key(userid,loai,ma)) with oids");
                execute_data("alter table " + m_db_schemaroot + ".v_optionform owner to " + m_db_database + "");
                execute_data("create table " + m_db_schemaroot + ".v_tylebhyt(id numeric(3), mabhyt varchar2(1000), tu numeric(3), den numeric(3), tyle numeric(6,2), dieukien varchar2(20), sotiengh numeric(12,2), tylegh numeric(6,2), chieudai numeric(2) default 16, constraint pk_v_tylebhyt primary key(id)) with oids");
                execute_data("alter table " + m_db_schemaroot + ".v_tylebhyt owner to " + m_db_database + "");
                execute_data("alter table " + m_db_schemaroot + ".v_sdvattu add soluong numeric(5,2), dongia numeric(12,2)");
                execute_data("alter table " + m_db_schemaroot + ".v_lydomien add readonly numeric(1) default 0");
                execute_data("alter table " + m_db_schemaroot + ".v_dsduyet add readonly numeric(1) default 0");
                execute_data("alter table " + m_db_schemaroot + ".v_dsduyet add ngayud timestamp DEFAULT now()");
                execute_data("alter table " + m_db_schemaroot + ".v_loaibn add readonly numeric(1) default 0");
                execute_data("alter table " + m_db_schemaroot + ".v_loaibn add ngayud timestamp DEFAULT now()");
                execute_data("alter table " + m_db_schemaroot + ".v_tenloaivp add readonly numeric(1) default 0");
                execute_data("alter table " + m_db_schemaroot + ".v_tenloaivp add ngayud timestamp DEFAULT now()");
                execute_data("alter table " + m_db_schemaroot + ".v_dmlydonopthem add readonly numeric(1) default 0");
                execute_data("alter table " + m_db_schemaroot + ".v_dmlydonopthem add ngayud timestamp DEFAULT now()");
                execute_data("alter table " + m_db_schemaroot + ".v_dmlydothieu add readonly numeric(1) default 0");
                execute_data("alter table " + m_db_schemaroot + ".v_dmlydothieu add ngayud timestamp DEFAULT now()");
                execute_data("alter table " + m_db_schemaroot + ".v_loaitu add ktt numeric(1) default 0");
                execute_data("alter table " + m_db_schemaroot + ".v_loaitu add ten text)");
                execute_data("alter table " + m_db_schemaroot + ".v_tylebhyt add chieudai numeric(2) default 16");
                execute_data("alter table " + m_db_schemaroot + ".v_quyenso add sohieubl varchar2(20)");
                execute_data("update " + m_db_schemaroot + ".v_quyenso set sohieubl=sohieu where sohieubl is null");
                execute_data("alter table " + m_db_schemaroot + ".v_quyenso add soghiam numeric(7) default -1");
                execute_data("alter table " + m_db_schemaroot + ".v_trongoi add madoituong numeric(2) DEFAULT 0");

                execute_data("CREATE TABLE " + m_db_schemaroot + ".v_tylegiamll( id numeric(18) NOT NULL DEFAULT 0, mabn varchar(8),  mavaovien numeric(18), ngayvao timestamp, makp varchar(2), maduyet numeric(4), userid numeric(5) DEFAULT 0, ngayud timestamp DEFAULT now(), CONSTRAINT pk_v_tylegiamll PRIMARY KEY (id)) WITH OIDS");
                execute_data(" ALTER TABLE " + m_db_schemaroot + ".v_tylegiamll OWNER TO " + m_db_database + "");

                execute_data("create table " + m_db_schemaroot + ".v_tylegiamct( id numeric(18) NOT NULL DEFAULT 0,   id_loaivp numeric(3), tyle numeric(5,2),CONSTRAINT pk_v_tylegiamct PRIMARY KEY (id,id_loaivp) , CONSTRAINT fk_v_tylegiamct_v_tylegiamll FOREIGN KEY (id)     REFERENCES medibv.v_tylegiamll (id) MATCH SIMPLE     ON UPDATE NO ACTION ON DELETE SET NULL)WITH OIDS;");
                execute_data("ALTER TABLE " + m_db_schemaroot + ".v_tylegiamct OWNER TO " + m_db_database + ";");

                execute_data("CREATE TABLE " + m_db_schemaroot + ".v_miendtloaivp( madoituong numeric(2) NOT NULL DEFAULT 0,idloaivp numeric(3) NOT NULL,sotien numeric(10) DEFAULT 0, tyle numeric(5,2) DEFAULT 0,userid numeric(5) DEFAULT 0, ngayud timestamp DEFAULT now(), CONSTRAINT pk_v_miendtloaivp PRIMARY KEY (madoituong,idloaivp))WITH OIDS");
                execute_data("ALTER TABLE " + m_db_schemaroot + ".v_miendtloaivp OWNER TO " + m_db_database + "");

                //Dong add table v_giavp :hoichan,giaycamdoan,tgtrakq,gioitinh,tutuoi,dentuoi,batbuocthutien,coso,cosothay
                execute_data(" alter table " + m_db_schemaroot + ".v_giavp add hoichan numeric(1) default 0");
                execute_data(" alter table " + m_db_schemaroot + ".v_giavp add giaycamdoan numeric(1) default 0");
                execute_data(" alter table " + m_db_schemaroot + ".v_giavp add tgtrakq character varying(10) default null");
                execute_data(" alter table " + m_db_schemaroot + ".v_giavp add gioitinh character varying(10) default null");
                execute_data(" alter table " + m_db_schemaroot + ".v_giavp add tutuoi numeric(3) default 0");
                execute_data(" alter table " + m_db_schemaroot + ".v_giavp add dentuoi numeric(3) default 0");
                execute_data(" alter table " + m_db_schemaroot + ".v_giavp add batbuocthutien numeric(1,0) default 0");
                execute_data(" alter table " + m_db_schemaroot + ".v_giavp add coso numeric(3,0) default 0 ");
                execute_data(" alter table " + m_db_schemaroot + ".v_giavp add cosothay character varying(50) default null ");
                execute_data(" alter table " + m_db_schemaroot + ".v_giavp add phongthuchiencls character varying(50) default null ");

                execute_data("CREATE TABLE " + m_db_schemaroot + ".v_giavp_chong(id_mavp numeric(7,0) NOT NULL DEFAULT 0,id_mavp_chong text not null default null,ngayud timestamp DEFAULT now(), CONSTRAINT pk_v_giavp_chong PRIMARY KEY (id_mavp))WITH OIDS ");
                execute_data("ALTER TABLE " + m_db_schemaroot + ".v_giavp_chong OWNER TO " + m_db_database + "");
                execute_data("CREATE TABLE " + m_db_schemaroot + ".dmloaitg (id numeric(1,0) not null, ten character varying(250),CONSTRAINT pk_dmloaitg PRIMARY KEY (id) USING INDEX TABLESPACE medi_index ) WITH OIDS;ALTER TABLE " + m_db_schemaroot + ".dmloaitg OWNER TO medisoft;");
                execute_data("create table " + m_db_schemaroot + ".v_giagiuongbhyt (id numeric(3) NOT NULL,ten text,dongia numeric(10) default 0,makpbo text,userid numeric(5),ngayud timestamp without time zone DEFAULT now(), CONSTRAINT pk_v_giagiuongbhyt PRIMARY KEY (id)); ALTER TABLE " + m_db_schemaroot + ".ba_dmylenh OWNER TO medisoft;");//khuong 21/11/2011
                execute_data("insert into " + m_db_schemaroot + ".v_giagiuongbhyt (id,ten,makpbo) values (1,'Ngày giường bệnh hồi sức cấp cứu, ngày đẻ và 02 ngày sau đẻ','02');insert into " + m_db_schemaroot + ".v_giagiuongbhyt (id,ten,makpbo) values (2,'Các khoa truyền nhiễm, Hô hấp, Tim mạch, Thần kinh, Huyết học, Ung thư, Tiêu hoá, Nhi,  Thận học,  ngày thứ 3 sau  đẻ trở đi, ngày điều trị ngoại khoa sau mổ kể từ ngày thứ 11 trở đi','11,03,10,28,04,14,17,05,07');insert into " + m_db_schemaroot + ".v_giagiuongbhyt (id,ten,makpbo) values (3,'Các khoa Cơ - Xương - Khớp, Da liễu, Dị ứng Tai-Mũi-Họng, Mắt, RHM, Ngoại, Phụ sản không mổ','06,13,09,23,25,24,18');insert into " + m_db_schemaroot + ".v_giagiuongbhyt (id,ten,makpbo) values (4,'Các khoa đông y, phục hồi chức năng','16,26');insert into " + m_db_schemaroot + ".v_giagiuongbhyt (id,ten,makpbo) values (5,'Sau phẩu thuật loại đặc biệt, bỏng loại 3,  4 > 70%','');insert into " + m_db_schemaroot + ".v_giagiuongbhyt (id,ten,makpbo) values (6,'Sau các phẩu thuật loại 1, bỏng loại 3, 4 từ 25-70 %','');insert into " + m_db_schemaroot + ".v_giagiuongbhyt (id,ten,makpbo) values (7,'Sau các phẩu thuật loại 2 ,bỏng độ 2 > 30% bỏng  độ 3, 4 < 25%','');insert into " + m_db_schemaroot + ".v_giagiuongbhyt (id,ten,makpbo) values (8,'Sau các phẩu thuật loại 3, bỏng độ 1, 2 <30%','');");//khuong 21/11/2011
                sql = " CREATE TABLE " + m_db_schemaroot + ".v_giavp_new (id numeric (7,0),id_loai numeric(3,0), stt numeric(5,0),ma text,ten text,dvt character varying(20),bhyt numeric(7,2),";
                sql += " gia_th numeric(10,0),gia_bh numeric(10,0),gia_cs numeric(10,0),gia_dv numeric(10,0),gia_nn numeric(10,0),gia_ksk numeric(10,0),";
                sql += " vattu_th numeric(10,0),vattu_bh numeric(10,0),vattu_dv numeric(10,0),vattu_nn numeric(10,0),vattu_cs numeric(10,0),vattu_ksk numeric(10,0), userid numeric(5,0),idloaitg numeric(1,0),ngayud timestamp,";
                sql += " CONSTRAINT pk_v_giavp_new PRIMARY KEY (id,idloaitg),";
                sql += " CONSTRAINT fk_v_giavp_new_v_giavp FOREIGN KEY (id)  REFERENCES " + m_db_schemaroot + ".v_giavp (id),";
                sql += " CONSTRAINT fk_v_giavp_new_dmloaitg FOREIGN KEY (idloaitg)  REFERENCES " + m_db_schemaroot + ".dmloaitg (id)";
                sql += " MATCH SIMPLE  ON UPDATE NO ACTION ON DELETE SET NULL)WITH OIDS;";
                sql += " ALTER TABLE " + m_db_schemaroot + ".v_giavp_new OWNER TO medisoft;";
                execute_data(sql);
                ///End Begin dong
                foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
                {
                    try
                    {
                        execute_data("alter table " + r[0].ToString() + ".v_ttrvll add (idtonghop numeric(12) default 0");
                        execute_data("alter table " + r[0].ToString() + ".v_vienphict add (makp varchar2(2))");
                        execute_data("alter table " + r[0].ToString() + ".v_vienphict add (mabs varchar2(4))");
                        execute_data("alter table " + r[0].ToString() + ".v_mienngtru add (lydo numeric(2) default 0)");
                        execute_data("alter table " + r[0].ToString() + ".v_vienphill add ghichu text ");
                        execute_data("alter table " + r[0].ToString() + ".v_vienphill add bacsi text ");
                        execute_data("alter table " + r[0].ToString() + ".v_ttrvll add thua numeric(15,4) DEFAULT 0");
                        execute_data("alter table " + r[0].ToString() + ".v_thvpct add done numeric(1) DEFAULT 0");

                        execute_data("alter table " + r[0].ToString() + ".v_chidinh add idttrv numeric(18) DEFAULT 0");
                        execute_data("alter table " + r[0].ToString() + ".v_vpkhoa add idttrv numeric(18) DEFAULT 0");
                        execute_data("alter table " + r[0].ToString() + ".v_thvpll add idttrv numeric(18) DEFAULT 0");
                        execute_data("alter table " + r[0].ToString() + ".d_tienthuoc add idttrv numeric(18) DEFAULT 0");
                    }
                    catch
                    {
                    }
                }
                foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
                {
                    try
                    {

                        execute_data("CREATE TABLE " + r[0].ToString() + ".v_bienlaitaichinhll( id numeric(12) NOT NULL DEFAULT 0, quyenso varchar(30), sobienlai varchar(20), ngayhd timestamp, noidung text, tendv text, masothue varchar(20) DEFAULT 0, sotaikhoan varchar(30) DEFAULT 0, diachi text, sotien numeric(15,4) DEFAULT 0, vat numeric(3) DEFAULT 0, tkno numeric(15,4) DEFAULT 0, tkco numeric(15,4) DEFAULT 0, userid numeric(5) DEFAULT 0, ngayud timestamp DEFAULT now(), CONSTRAINT pk_v_bienlaitaichinhll PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) ");
                        execute_data("ALTER TABLE " + r[0].ToString() + ".v_bienlaitaichinhll OWNER TO " + m_db_database + "");

                        execute_data("CREATE TABLE " + r[0].ToString() + ".v_bienlaitaichinhct(id numeric(12) NOT NULL DEFAULT 0,stt numeric(3) NOT NULL DEFAULT 0, mabn varchar(8), makp varchar(2), chiphi numeric(15,4) DEFAULT 0, bhyt numeric(15,4) DEFAULT 0, mien numeric(10,4) DEFAULT 0, tamung numeric(10) DEFAULT 0, done numeric(1) DEFAULT 0, loai numeric(1) DEFAULT 0,idvienphi numeric(18) NOT NULL DEFAULT 0, CONSTRAINT pk_v_bienlaitaichinhct PRIMARY KEY (id,stt) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_v_bienlaitaichinhct_v_bienlaitaichinhll FOREIGN KEY (id)     REFERENCES " + r[0].ToString() + ".v_bienlaitaichinhll (id) MATCH SIMPLE     ON UPDATE NO ACTION ON DELETE SET NULL) ");
                        execute_data("ALTER TABLE " + r[0].ToString() + ".v_bienlaitaichinhct OWNER TO " + m_db_database + "");

                        execute_data("create table " + r[0].ToString() + ".v_idtonghop(IDBHYTKB numeric(18) NOT NULL DEFAULT 0,  IDTTRVLL numeric(18) NOT NULL DEFAULT 0,  CONSTRAINT pk_v_idtonghop PRIMARY KEY (IDBHYTKB)  )");
                        execute_data("ALTER TABLE " + r[0].ToString() + ".v_idtonghop OWNER TO " + m_db_database + "");
                    }
                    catch
                    { }
                }
            }
            catch
            {
            }
        }
        public void modify_tables_vp_mmyy(string s_mmyy)
        {
            try
            {
                execute_data(false, "CREATE TABLE " + m_db_schemaroot + ".vp_treemenu(id numeric(5), id_cha numeric(5), stt numeric(5), ten text, sql text, tenfield text, captionfield text, width text, report text,readonly numeric(1) default 0, CONSTRAINT pk_vp_treemenu PRIMARY KEY (id)) WITH OIDS");
                execute_data(false, "ALTER TABLE " + m_db_schemaroot + ".vp_treemenu OWNER TO " + m_db_database + "");

                execute_data(false, "CREATE TABLE " + m_db_schemaroot + ".vp_null(id text, ten text, readonly numeric(1) default 0, CONSTRAINT pk_vp_null PRIMARY KEY (id)) WITH OIDS");
                execute_data(false, "ALTER TABLE " + m_db_schemaroot + ".vp_null OWNER TO " + m_db_database + "");

                execute_data(false, "alter table " + m_db_schemaroot + ".v_quyenso add ngaylinh timestamp DEFAULT now()");

                execute_data(false, "alter table " + m_db_schemaroot + ".v_giavp_luu add thuong numeric(1) default 0");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_giavp_luu add readonly numeric(1) default 0");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_giavp_luu add ndm numeric(1) default 0");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_giavp_luu add tylekhuyenmai numeric(3) default 0");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_giavp_luu add hide numeric(1) DEFAULT 0");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_giavp_luu add gia_ksk numeric(10) DEFAULT 0");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_giavp_luu add kythuat numeric(1) default -1");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_giavp_luu add vattu_ksk numeric(10) DEFAULT 0");

                execute_data(false, "create table " + m_db_schemaroot + ".v_maubaocao(id numeric(3), ma text, ten text, loai numeric(1), constraint pk_v_maubaocao primary key(id)) with oids");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_maubaocao owner to " + m_db_database + "");


                execute_data(false, "alter table " + m_db_schemaroot + ".v_giavp add thuong numeric(1) default 0");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_giavp add readonly numeric(1) default 0");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_giavp add ndm numeric(1) default 0");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_giavp add tylekhuyenmai numeric(3) default 0");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_giavp add hide numeric(1) DEFAULT 0");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_giavp add gia_ksk numeric(10) DEFAULT 0");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_giavp add vattu_ksk numeric(10) DEFAULT 0");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_giavp add kythuat numeric(1) default -1");

                execute_data(false, "alter table " + m_db_schemaroot + ".v_giavp add tuyentw numeric(1) default 0");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_giavp add tuyentinh numeric(1) default 0");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_giavp add tuyenhuyen numeric(1) default 0");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_giavp add tuyenxa numeric(1) default 0");

                execute_data(false, "alter table " + m_db_schemaroot + ".v_trongoi add soluong numeric(10,2) DEFAULT 0");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_trongoi add madoituong numeric(2) DEFAULT 0");
                execute_data(false, "CREATE TABLE " + m_db_schemaroot + ".v_trongoipk(id numeric(7) NOT NULL DEFAULT 0,makp varchar(2) NOT NULL DEFAULT 0,sotien numeric(12) DEFAULT 0,stt numeric(3) DEFAULT 0,idgiavp numeric(10)  DEFAULT 0, CONSTRAINT pk_v_trongoipk PRIMARY KEY (id,makp,idgiavp) USING INDEX TABLESPACE medi_index) with oids ");
                execute_data(false, "ALTER TABLE " + m_db_schemaroot + ".v_trongoipk OWNER TO " + m_db_database + "");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_trongoipk add idgiavp numeric(10) NOT NULL DEFAULT 0");
                execute_data(false, "ALTER TABLE " + m_db_schemaroot + ".v_trongoipk DROP CONSTRAINT pk_v_trongoipk;");
                execute_data(false, "ALTER TABLE " + m_db_schemaroot + ".v_trongoipk ADD CONSTRAINT pk_v_trongoipk PRIMARY KEY (idgiavp, id, makp) USING INDEX TABLESPACE medi_index;");

                execute_data(false, "CREATE TABLE " + m_db_schemaroot + ".v_ttrvthatthu(id numeric(18) NOT NULL DEFAULT 0,loai numeric(2) DEFAULT 0,quyenso numeric(7) DEFAULT 0,sobienlai numeric(10) DEFAULT 0,mabn varchar(8),mavaovien numeric(18) DEFAULT 0,maql numeric(18) DEFAULT 0,idkhoa numeric(18) DEFAULT 0,ngayvao timestamp,ngayra timestamp,ngaythu timestamp,sotien numeric(15,4) DEFAULT 0,tamung numeric(10) DEFAULT 0,userid numeric(5) DEFAULT 0,ngayud timestamp DEFAULT now(),sotientra numeric(15,4) DEFAULT 0,useridtra numeric(5) DEFAULT 0,ngaytra timestamp,CONSTRAINT pk_v_ttrvthatthu PRIMARY KEY (id) USING INDEX TABLESPACE medi_index ) WITH OIDS;");
                execute_data(false, "ALTER TABLE " + m_db_schemaroot + ".v_ttrvthatthu OWNER TO " + m_db_database + ";");

                execute_data(false, "CREATE TABLE " + m_db_schemaroot + ".v_ttrvthua(id numeric(18) NOT NULL DEFAULT 0,loai numeric(2) DEFAULT 0,quyenso numeric(7) DEFAULT 0,sobienlai numeric(10) DEFAULT 0,mabn varchar(8),mavaovien numeric(18) DEFAULT 0,maql numeric(18) DEFAULT 0,idkhoa numeric(18) DEFAULT 0,ngayvao timestamp,ngayra timestamp,ngaythu timestamp,sotien numeric(15,4) DEFAULT 0,tamung numeric(10) DEFAULT 0,userid numeric(5) DEFAULT 0,ngayud timestamp DEFAULT now(),sotientra numeric(15,4) DEFAULT 0,useridtra numeric(5) DEFAULT 0,ngaytra timestamp,idttrv text,CONSTRAINT pk_v_ttrvthua PRIMARY KEY (id) USING INDEX TABLESPACE medi_index ) WITH OIDS;");
                execute_data(false, "ALTER TABLE " + m_db_schemaroot + ".v_ttrvthua OWNER TO " + m_db_database + ";");

                execute_data(false, "alter table  " + m_db_schemaroot + ".v_ttrvthatthu alter column idttrv type text");

                execute_data(false, "alter table " + m_db_schemaroot + ".v_dlogin add id_nhom numeric(5) default 0");
                execute_data(false, "update " + m_db_schemaroot + ".v_dlogin set id_nhom=1 where id_nhom=0 or id_nhom is null");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_nhombhyt add viettat text");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_nhombhyt add readonly numeric(1) default 0");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_nhomvp add matat varchar(20)");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_nhomvp add viettat text");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_nhomvp add readonly numeric(1) default 0");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_loaivp add viettat text");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_loaivp add readonly numeric(1) default 0");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_giavp add theobs numeric(1) default 0");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_giavp add gia_cs numeric(10) default 0");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_giavp add vattu_cs numeric(10) default 0");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_giavp add loaitrongoi numeric(1) default 0");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_giavp add locthe text");
                execute_data(false, "create table " + m_db_schemaroot + ".v_dmghe(id numeric(5),stt numeric(5), makp varchar2(2), ma text,ten text,constraint pk_v_dmghe primary key(id)) with oids");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_dmghe owner to " + m_db_database + "");
                execute_data(false, "create table " + m_db_schemaroot + ".v_sdghe(id numeric(12), loai numeric(1), ghe numeric(5),constraint pk_v_sdghe primary key(id,loai,ghe)) with oids");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_sdghe owner to " + m_db_database + "");
                execute_data(false, "create table " + m_db_schemaroot + ".v_sdvattu(mavp numeric(10), mavt numeric(10), soluong numeric(5,2), dongia numeric(12,2), sotien numeric(12,2), constraint pk_v_sdvattu primary key(mavp,mavt)) with oids");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_sdvattu owner to " + m_db_database + "");
                execute_data(false, "create table " + m_db_schemaroot + ".v_theodoigia(mabd numeric(10), dongia numeric(12,2), constraint pk_v_theodoigia primary key(mabd)) with oids");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_theodoigia owner to " + m_db_database + "");
                execute_data(false, "create table " + m_db_schemaroot + ".v_loaitu(id numeric(3), sotien numeric(10), ten text, ktt numeric(1) default 0, constraint pk_v_loaitu primary key(id)) with oids");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_loaitu owner to " + m_db_database + "");
                execute_data(false, "create table " + m_db_schemaroot + ".v_option_locgiavp(userid numeric(5), loai numeric(5), ten text, id_vp varchar2(3000),constraint pk_v_option_locgiavp primary key(userid,loai)) with oids");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_option_locgiavp owner to " + m_db_database + "");
                execute_data(false, "create table " + m_db_schemaroot + ".v_option_thutheonhom(id numeric(7), userid numeric(5), stt numeric(5), ten text, id_vp varchar2(1000), constraint pk_v_option_thutheonhom primary key(id,userid)) with oids");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_option_thutheonhom owner to " + m_db_database + "");
                execute_data(false, "create table " + m_db_schemaroot + ".v_option(ma text,giatri text, constraint pk_v_option primary key(ma)) with oids");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_option owner to " + m_db_database + "");
                execute_data(false, "create table " + m_db_schemaroot + ".v_optionform(userid numeric(5), loai numeric(2), ma text, ten text,giatri text, constraint pk_v_optionform primary key(userid,loai,ma)) with oids");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_optionform owner to " + m_db_database + "");
                execute_data(false, "create table " + m_db_schemaroot + ".v_tylebhyt(id numeric(3), mabhyt varchar2(1000), tu numeric(3), den numeric(3), tyle numeric(6,2), dieukien varchar2(20), sotiengh numeric(12,2), tylegh numeric(6,2), chieudai numeric(2) default 16, constraint pk_v_tylebhyt primary key(id)) with oids");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_tylebhyt owner to " + m_db_database + "");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_sdvattu add soluong numeric(5,2), dongia numeric(12,2)");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_lydomien add readonly numeric(1) default 0");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_dsduyet add readonly numeric(1) default 0");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_dsduyet add ngayud timestamp DEFAULT now()");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_loaibn add readonly numeric(1) default 0");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_loaibn add ngayud timestamp DEFAULT now()");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_tenloaivp add readonly numeric(1) default 0");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_tenloaivp add ngayud timestamp DEFAULT now()");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_dmlydonopthem add readonly numeric(1) default 0");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_dmlydonopthem add ngayud timestamp DEFAULT now()");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_dmlydothieu add readonly numeric(1) default 0");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_dmlydothieu add ngayud timestamp DEFAULT now()");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_loaitu add ktt numeric(1) default 0");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_loaitu add ten text");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_tylebhyt add chieudai numeric(2) default 16");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_quyenso add sohieubl varchar2(20)");
                execute_data(false, "update " + m_db_schemaroot + ".v_quyenso set sohieubl=sohieu where sohieubl is null");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_quyenso add soghiam numeric(7) default -1");

                execute_data(false, "CREATE TABLE " + m_db_schemaroot + ".v_tylegiamll( id numeric(18) NOT NULL DEFAULT 0, mabn varchar(8),  mavaovien numeric(18), ngayvao timestamp, makp varchar(2), maduyet numeric(4), userid numeric(5) DEFAULT 0, ngayud timestamp DEFAULT now(), CONSTRAINT pk_v_tylegiamll PRIMARY KEY (id)) WITH OIDS");
                execute_data(false, " ALTER TABLE " + m_db_schemaroot + ".v_tylegiamll OWNER TO " + m_db_database + "");

                execute_data(false, "create table " + m_db_schemaroot + ".v_tylegiamct( id numeric(18) NOT NULL DEFAULT 0,   id_loaivp numeric(3), tyle numeric(5,2),CONSTRAINT pk_v_tylegiamct PRIMARY KEY (id,id_loaivp) , CONSTRAINT fk_v_tylegiamct_v_tylegiamll FOREIGN KEY (id)     REFERENCES medibv.v_tylegiamll (id) MATCH SIMPLE     ON UPDATE NO ACTION ON DELETE SET NULL)WITH OIDS;");
                execute_data(false, "ALTER TABLE " + m_db_schemaroot + ".v_tylegiamct OWNER TO " + m_db_database + ";");

                execute_data(false, "CREATE TABLE " + m_db_schemaroot + ".v_miendtloaivp( madoituong numeric(2) NOT NULL DEFAULT 0,idloaivp numeric(3) NOT NULL,sotien numeric(10) DEFAULT 0, tyle numeric(5,2) DEFAULT 0,userid numeric(5) DEFAULT 0, ngayud timestamp DEFAULT now(), CONSTRAINT pk_v_miendtloaivp PRIMARY KEY (madoituong,idloaivp))WITH OIDS");
                execute_data(false, "ALTER TABLE " + m_db_schemaroot + ".v_miendtloaivp OWNER TO " + m_db_database + "");

                string xxx = m_db_schemaroot + s_mmyy;

                execute_data(false, "alter table " + xxx + ".v_ttrvll add idtonghop numeric(18) default 0");
                execute_data(false, "alter table " + xxx + ".v_vienphict add makp varchar2(2)");
                //gam-23/02/2011
                execute_data(false, "alter table " + xxx + ".v_vienphict add vat numeric(7,2) default 0");
                //gam
                execute_data(false, "alter table " + xxx + ".v_vienphict add khuyenmai numeric(7) default 0");
                execute_data(false, "alter table " + xxx + ".v_vienphict add ngay timestamp");
                execute_data(false, "alter table " + xxx + ".v_vienphict add mabs varchar2(4)");
                execute_data(false, "alter table " + xxx + ".v_mienngtru add lydo numeric(2) default 0");
                execute_data(false, "alter table " + xxx + ".v_vienphill add ghichu text ");
                execute_data(false, "alter table " + xxx + ".v_vienphill add bacsi text ");
                execute_data(false, "alter table " + xxx + ".v_vienphict add idchidinh numeric(18) default 0");
                execute_data(false, "alter table " + xxx + ".v_ttrvll add thua numeric(15,4) DEFAULT 0");
                execute_data(false, "alter table " + xxx + ".v_thvpct add done numeric(1) DEFAULT 0");
                execute_data(false, "alter table " + xxx + ".v_ttrvct add giamua numeric(24,10) DEFAULT 0");
                execute_data(false, "alter table " + xxx + ".v_ttrvct add tra numeric(24,10) DEFAULT 0");
                execute_data(false, "alter table " + xxx + ".v_ttrvct add ngaytra timestamp");
                execute_data(false, "alter table " + xxx + ".v_vienphill add done numeric(1) DEFAULT 0");

                execute_data(false, "alter table " + xxx + ".v_chidinh add idttrv numeric(18) DEFAULT 0");
                execute_data(false, "alter table " + xxx + ".v_vpkhoa add idttrv numeric(18) DEFAULT 0");
                execute_data(false, "alter table " + xxx + ".v_thvpll add idttrv numeric(18) DEFAULT 0");
                execute_data(false, "alter table " + xxx + ".v_thvpll add idthuoc text");
                execute_data(false, "alter table " + xxx + ".v_thvpct add idttrv numeric(18) DEFAULT 0");
                execute_data(false, "alter table " + xxx + ".d_tienthuoc add idttrv numeric(18) DEFAULT 0");

                execute_data(false, "alter table " + m_db_schemaroot + ".v_loaibn add stt numeric(2) default 0");

                execute_data(false, "alter table " + xxx + ".v_huybienlai add sotien numeric(24,10) DEFAULT 0");


                execute_data(false, "CREATE TABLE " + xxx + ".v_bienlaitaichinhll( id numeric(12) NOT NULL DEFAULT 0, quyenso varchar(30), sobienlai varchar(20), ngayhd timestamp, noidung text, tendv text, masothue varchar(20) DEFAULT 0, sotaikhoan varchar(30) DEFAULT 0, diachi text, sotien numeric(15,4) DEFAULT 0, vat numeric(3) DEFAULT 0, tkno numeric(15,4) DEFAULT 0, tkco numeric(15,4) DEFAULT 0, userid numeric(5) DEFAULT 0, ngayud timestamp DEFAULT now(), CONSTRAINT pk_v_bienlaitaichinhll PRIMARY KEY (id) USING INDEX TABLESPACE medi_index) ");
                execute_data(false, "ALTER TABLE " + xxx + ".v_bienlaitaichinhll OWNER TO " + m_db_database + "");

                execute_data(false, "CREATE TABLE " + xxx + ".v_bienlaitaichinhct(id numeric(12) NOT NULL DEFAULT 0,stt numeric(3) NOT NULL DEFAULT 0, mabn varchar(8), makp varchar(2), chiphi numeric(15,4) DEFAULT 0, bhyt numeric(15,4) DEFAULT 0, mien numeric(10,4) DEFAULT 0, tamung numeric(10) DEFAULT 0, done numeric(1) DEFAULT 0, loai numeric(1) DEFAULT 0,idvienphi numeric(12) NOT NULL DEFAULT 0, CONSTRAINT pk_v_bienlaitaichinhct PRIMARY KEY (id,stt) USING INDEX TABLESPACE medi_index, CONSTRAINT fk_v_bienlaitaichinhct_v_bienlaitaichinhll FOREIGN KEY (id)     REFERENCES " + xxx + ".v_bienlaitaichinhll (id) MATCH SIMPLE     ON UPDATE NO ACTION ON DELETE SET NULL) ");
                execute_data(false, "ALTER TABLE " + xxx + ".v_bienlaitaichinhct OWNER TO " + m_db_database + "");

                execute_data(false, "alter table " + xxx + ".v_bienlaitaichinhct alter column idvienphi type text ");
                execute_data(false, "ALTER TABLE " + m_db_schemaroot + ".v_loaivp ADD COLUMN computervp text");
                execute_data(false, "ALTER TABLE " + xxx + ".d_tienthuoc add column datra numeric(24,10) DEFAULT 0");

                execute_data(false, "create table " + m_db_schemaroot + ".v_nhomkhoabvll(id numeric(3) NOT NULL DEFAULT 0, ma varchar(10), ten text, stt numeric(3) DEFAULT 0, makp text, ngayud timestamp DEFAULT now(), CONSTRAINT v_nhomkhoabvll_pkey PRIMARY KEY (id)) WITHOUT OIDS");
                execute_data(false, "create table " + m_db_schemaroot + ".v_nhomkhoabvct (id numeric(3) NOT NULL DEFAULT 0, makp varchar(3) NOT NULL, tenkp text, CONSTRAINT v_nhomkhoabvct_pkey PRIMARY KEY (id, makp)) WITHOUT OIDS");
                execute_data(false, "create table " + m_db_schemaroot + ".v_nhomkhoabv1ll (id numeric(3) NOT NULL DEFAULT 0, ma varchar(10), ten text, stt numeric(3) DEFAULT 0, mavp text, ngayud timestamp DEFAULT now(), CONSTRAINT pk_v_nhomkhoabv1ll PRIMARY KEY (id) USING INDEX TABLESPACE medi_index )  WITH OIDS");
                execute_data(false, "create table " + m_db_schemaroot + ".v_nhomkhoabv1ct (id numeric(3) NOT NULL DEFAULT 0, mavp varchar(10) NOT NULL, tenvp text, CONSTRAINT pk_v_nhomkhoabv1ct PRIMARY KEY (id, mavp) USING INDEX TABLESPACE medi_index) WITHOUT OIDS");

                execute_data(false, "CREATE TABLE " + xxx + ".v_tamungcd(id numeric(18) NOT NULL DEFAULT 0,mabn varchar(8), mavaovien numeric(18), maql numeric(18),idkhoa numeric(18), makp varchar(2),ngay timestamp,madoituong numeric(2),loai numeric(2), loaibn numeric(2),ten text,sotien numeric(12,2) DEFAULT 0, idduyet numeric(18) DEFAULT 0, done numeric(1) DEFAULT 0, userid numeric(5), ngayud timestamp DEFAULT now(), CONSTRAINT pk_v_tamungcd PRIMARY KEY (id) USING INDEX TABLESPACE medi_index,  CONSTRAINT fk_v_tamungcd_btdbn FOREIGN KEY (mabn)  REFERENCES medibv.btdbn (mabn) MATCH SIMPLE ON UPDATE NO ACTION ON DELETE SET NULL,CONSTRAINT fk_v_tamungcd_btdkp_bv FOREIGN KEY (makp)  REFERENCES medibv.btdkp_bv (makp) MATCH SIMPLE  ON UPDATE NO ACTION ON DELETE SET NULL) WITH OIDS");
                execute_data(false, "alter table " + xxx + ".v_thvpbhyt add column traituyen numeric(1) default 0");
                execute_data(false, "alter table " + xxx + ".v_ttrvbhyt add column traituyen numeric(1) default 0");
                //

                //16/09/2009
                execute_data(false, "alter table " + xxx + ".v_ttrvct add column bhyttra numeric(15,4) default 0");
                execute_data(false, "alter table " + xxx + ".v_ttrvdv add column bhyttra numeric(15,4) default 0");
                execute_data(false, "alter table " + m_db_schemaroot + ".v_giavp add column kcct numeric(1) default 0");
                execute_data(false, "alter table " + m_db_schemaroot + ".d_dmbd add column kcct numeric(1) default 0");
                execute_data(false, "alter table " + xxx + ".v_ttrvct add column gia_bh numeric(18,4) default 0");
                execute_data(false, "alter table " + xxx + ".v_ttrvdv add column gia_bh numeric(18,4) default 0");
                execute_data(false, "alter table " + xxx + ".v_tamungcd add column idtonghop numeric(20) default 0");
                execute_data(false, "alter table " + xxx + ".v_ttrvll add column mien_cs numeric(18,4) default 0");
                execute_data(false, "alter table " + xxx + ".v_ttrvll add column mien_dv numeric(18,4) default 0");
                execute_data(false, "alter table " + xxx + ".v_ttrvll add column mien_gdduyet numeric(15,4) default 0");//Thuy 15.12.2012
                execute_data(false, "alter table " + m_db_schemaroot + ".v_option_bcct alter column id type numeric(12)");
                execute_data(false, "alter table " + xxx + ".v_ttrvct add column idtra numeric(18) default 0");
                execute_data(false, "alter table " + xxx + ".v_vienphict add column idtra numeric(18) default 0");
                execute_data(false, "alter table " + xxx + ".d_thuocbhytll add column idtt_cl numeric(18) default 0");
                //
                execute_data(false, "CREATE TABLE " + xxx + ".v_tontamung(id numeric(18) NOT NULL DEFAULT 0,mabn varchar(8),mavaovien numeric(18) DEFAULT 0,maql numeric(18) DEFAULT 0,idkhoa numeric(18) DEFAULT 0,quyenso numeric(7) DEFAULT 0,sobienlai numeric(10) DEFAULT 0,ngay timestamp,loai numeric(1) DEFAULT 0,makp varchar(2),madoituong numeric(2) DEFAULT 0,sotien numeric(15,4) DEFAULT 0,ketoan numeric(20) default 0,done numeric(1) DEFAULT 0,lanin numeric(2) DEFAULT 0,loaibn numeric(2) DEFAULT 0,idttrv numeric(18) DEFAULT 0,datru numeric(15,4) default 0,userid numeric(5) DEFAULT 0,ngayud timestamp DEFAULT now(),CONSTRAINT pk_v_tontamung PRIMARY KEY (id) USING INDEX TABLESPACE medi_index,CONSTRAINT fk_v_tontamung_btdbn FOREIGN KEY (mabn) REFERENCES medibv.btdbn (mabn) MATCH SIMPLE  ON UPDATE NO ACTION ON DELETE SET NULL,CONSTRAINT fk_v_tontamung_btdkp_bv FOREIGN KEY (makp) REFERENCES medibv.btdkp_bv (makp) MATCH SIMPLE  ON UPDATE NO ACTION ON DELETE SET NULL) WITH OIDS;");
                execute_data(false, "CREATE table " + m_db_schemaroot + ".v_dot_khuyenmai (id numeric(7), ten text, userid number(7) default 0, tungay timestamp DEFAULT now(), denngay timestamp DEFAULT now(), tugio varchar(5), dengio varchar(5), hide number(1) default 0, ngayud timestamp DEFAULT now(),theogio numeric(1) default 0,CONSTRAINT pk_v_dot_khuyenmai PRIMARY KEY (id) USING INDEX TABLESPACE medi_index)");
                execute_data(false, "CREATE table " + m_db_schemaroot + ".v_giavp_khuyenmai (iddot numeric(7), idvp numeric(10), tylekhuyenmai numeric(5,2) default 0, sotienkhuyenmai  numeric(15,4), userid number(7) default 0, ngayud timestamp DEFAULT now(),CONSTRAINT pk_v_giavp_khuyenmai PRIMARY KEY (iddot, idvp) USING INDEX TABLESPACE medi_index)");
                execute_data(false, " alter table " + xxx + ".v_vienphict add khuyenmai numeric(7) default 0");
                execute_data(false, " alter table " + xxx + ".v_vienphill add quyensodv numeric(7) default 0");
                execute_data(false, " alter table " + xxx + ".v_vienphill add sobienlaidv numeric(7) default 0");
                //Dong add table v_giavp :hoichan,giaycamdoan,thoigiantrakq,gioitinh,tutuoi,dentuoi,batbuocthutien,coso,cosothay
                execute_data(" alter table " + m_db_schemaroot + ".v_giavp add hoichan numeric(1) default 0");
                execute_data(" alter table " + m_db_schemaroot + ".v_giavp add giaycamdoan numeric(1) default 0");
                execute_data(" alter table " + m_db_schemaroot + ".v_giavp add thoigiantrakq character varying(20) default 0");
                execute_data(" alter table " + m_db_schemaroot + ".v_giavp add gioitinh character varying(10) default null");
                execute_data(" alter table " + m_db_schemaroot + ".v_giavp add tutuoi numeric(3) default 0");
                execute_data(" alter table " + m_db_schemaroot + ".v_giavp add dentuoi numeric(3) default 0");
                execute_data(" alter table " + m_db_schemaroot + ".v_giavp add batbuocthutien numeric(1,0) default 0");
                execute_data(" alter table " + m_db_schemaroot + ".v_giavp add coso numeric(3,0) default 0 ");
                execute_data(" alter table " + m_db_schemaroot + ".v_giavp add cosothay character varying(50) default null ");
                execute_data(" alter table " + m_db_schemaroot + ".v_giavp add phongthuchiencls character varying(50) default null ");

                execute_data("CREATE TABLE " + m_db_schemaroot + ".v_giavp_chong(id_mavp numeric(7,0) NOT NULL DEFAULT 0,id_mavp_chong text not null default null,ngayud timestamp DEFAULT now(), CONSTRAINT pk_v_giavp_chong PRIMARY KEY (id_mavp))WITH OIDS ");
                execute_data("ALTER TABLE " + m_db_schemaroot + ".v_giavp_chong OWNER TO " + m_db_database + "");

                execute_data(false, "alter table " + xxx + ".v_vienphill add column thanhtoan numeric(1) default 0");
                execute_data(false, "alter table " + xxx + ".v_ttrvll add column thanhtoan numeric(1) default 0");
                execute_data(false, "alter table " + xxx + ".v_vienphict add column idphongcls numeric(5) default 0");
                execute_data(false, "alter table " + xxx + ".v_vienphict add column sttcho numeric(5) default 0");
                execute_data(false, "alter table " + xxx + ".v_ttrvct add column idphongcls numeric(5) default 0");
                execute_data(false, "alter table " + xxx + ".v_ttrvct add column sttcho numeric(5) default 0");
                execute_data(false, "alter table " + xxx + ".v_ttrvct add column mien numeric default 0");
                execute_data(false, "alter table " + xxx + ".v_ttrvct add column phuthu numeric(1) default 0");

                execute_data(false, "alter table " + xxx + ".v_bienlaitaichinhll add column hdcls numeric(1) default 0");//0: hoa thuoc; 1: hoa don cls
                execute_data(false, "alter table " + xxx + ".v_bienlaitaichinhll add column mavaovien numeric default 0");//0: hoa thuoc; 1: hoa don cls

                execute_data(false, "alter table " + xxx + ".v_ttrvct add column idtonghop numeric default 0;");//=id trong v_chidinh, bhyt_thuoc                
                
                //End Dong
                execute_data(false, "alter table " + xxx + ".v_vienphill add tamung numeric default 0;");//de xac dinh trong gio, ngay nghi ngay le
                execute_data(false, "alter table " + xxx + ".v_ttrvct add mabs varchar(4);");//
                execute_data(false, "alter table " + xxx + ".v_ttrvct add dongchitra numeric(1) default 0;");//1: la dich vu can tinh lai dong chi tra, 0: bhyt chi tra da xet
                execute_data(false, "alter table " + xxx + ".v_ttrvct add ngaygiodangky timestamp default now();");//1: la dich vu can tinh lai dong chi tra, 0: bhyt chi tra da xet
                execute_data(false, "alter table " + xxx + ".v_ttrvct add idloaitg numeric(2) default 0;");//1: la dich vu can tinh lai dong chi tra, 0: bhyt chi tra da xet
                execute_data(false, "alter table " + xxx + ".v_ttrvll add sokham varchar(20);");

                execute_data(false, "alter table " + xxx + ".v_ttrvct add makp varchar(3) default 0;");
                execute_data(false, "alter table " + xxx + ".v_ttrvct add mabs varchar(4) default 0;");
                execute_data(false, "alter table " + xxx + ".v_ttrvct add losx varchar(20) default 0;");
                execute_data(false, "alter table " + xxx + ".v_ttrvct add handung varchar(10) default 0;");
                execute_data(false, "alter table " + xxx + ".v_ttrvct add idchinhanh numeric(2) default 0;");
                execute_data(false, "alter table " + xxx + ".v_ttrvct add idchinhanhden numeric(2) default 0;");

                // gam
                execute_data(false, "alter table " + xxx + ".v_tamung add ngaytra timestamp;");
                execute_data(false, "alter table " + xxx + ".v_tontamung add ngaytra timestamp;");
                execute_data(false, "alter table " + xxx + ".v_ttrvll add madoituong number(2) default 0;");
                execute_data(false, "alter table " + xxx + ".v_ttrvds add dain38 numeric default 0;");

                execute_data(false, "alter table " + xxx + ".d_ngtrull add idttrv number default 0;");
                execute_data(false, "alter table " + xxx + ".d_ngtrull add quyenso numeric default 0;");
                execute_data(false, "alter table " + xxx + ".d_ngtrull add sobienlai numeric default 0;");

                execute_data(false, "alter table " + xxx + ".bhytkb add idttrv numeric default 0;");

                execute_data(false, "CREATE TABLE medibv.v_bienlaitaichinhhuy (id numeric(22) NOT NULL DEFAULT 0, quyenso varchar(20) DEFAULT 0, sobienlai numeric(10) DEFAULT 0, ngay timestamp, userid numeric(5) DEFAULT 0, ngayud timestamp DEFAULT now(), idbienlai numeric(22), CONSTRAINT pk_v_bienlaitaichinhhuy PRIMARY KEY (id))WITH OIDS; ALTER TABLE medibv.ba_loaiphieu OWNER TO medisoft;");

                execute_data(false, "alter table " + xxx + ".v_ttrvll add loaithu numeric(1) default 0;");
                execute_data(false, "alter table " + xxx + ".v_ttrvll add column loaithu numeric(1,0) default 0;");
                execute_data(false, "alter table " + xxx + ".v_thvpct add column idtonghop numeric(25) default 0;");
                execute_data(false, "alter table " + xxx + ".v_thvpct add column stttonghop int default 0;");
                execute_data(false, "alter table " + xxx + ".v_ttrvct add column sttduyet numeric(5) default 0;");
            }
            catch
            {
            }
        }
        public void upd_v_capid()
        {
            try
            {
                /*
                execute_data("update v_capid set id="+maxid_v_quyenso().ToString()+" where ma=1");//v_quyenso
                execute_data("update v_capid set id="+maxid_v_loaivp().ToString()+" where ma=2");//v_loaivp
                execute_data("update d_capid set id="+maxid_v_giavp_d_dmbd().ToString()+" where ma=1");//v_giavp+d_dmbd
                execute_data("update v_capid set id="+maxid_v_dlogin().ToString()+" where ma=4");//v_dlogin
                execute_data("update v_capid set id="+maxid_v_vienphill().ToString()+" where ma=5");//v_vienphill
                execute_data("update v_capid set id="+maxid_v_tamung().ToString()+" where ma=6");//v_tamung
                execute_data("update v_capid set id="+maxid_v_nhomvp().ToString()+" where ma=7");//v_nhomvp
                execute_data("update v_capid set id="+maxid_v_hoantra().ToString()+" where ma=8");//v_hoantra
                execute_data("update v_capid set id="+maxid_v_chidinh().ToString()+" where ma=9");//v_chidinh
                execute_data("update v_capid set id="+maxid_v_ttrvll().ToString()+" where ma=10");//v_ttrvll
                execute_data("update v_capid set id="+maxid_v_vpkhoa().ToString()+" where ma=11");//v_vpkhoa 
                execute_data("update v_capid set id="+maxid_v_phieuchi().ToString()+" where ma=12");//v_phieuchi
                execute_data("update d_capid set id="+maxid_bhytkb().ToString()+" where ma=12");//bhytkb
                */
            }
            catch
            {
            }
        }
        public void f_default_nhomvp()
        {
            upd_v_nhomvp(1, 1, "Khám bệnh", "KB", "KB", 1, 1);
            upd_v_nhomvp(2, 2, "Xét nghiệm", "XN", "XN", 2, 1);
            upd_v_nhomvp(3, 3, "Chẩn đoán hình ảnh", "CDHA", "CDHA", 3, 1);
            upd_v_nhomvp(4, 4, "Thăm dò chức năng", "TDCN", "TDCN", 4, 1);
            upd_v_nhomvp(5, 5, "Dịch truyền, Máu, Đạm", "DT", "DT", 5, 1);
            upd_v_nhomvp(6, 6, "Thủ thuật - Phẩu thuật", "PTTT", "PTTT", 6, 1);
            upd_v_nhomvp(7, 7, "Thuốc", "THUOC", "THUOC", 7, 1);
            upd_v_nhomvp(8, 8, "Giường", "GIUONG", "GIUONG", 8, 1);
            upd_v_nhomvp(9, 9, "Khác", "KHAC", "KHAC", 9, 1);
        }
        public void f_default_nhombhyt()
        {
            upd_v_nhombhyt(1, 1, "Khám bệnh", "KB", 1);
            upd_v_nhombhyt(2, 2, "Xét nghiệm", "XN", 1);
            upd_v_nhombhyt(3, 3, "Chẩn đoán hình ảnh", "CDHA", 1);
            upd_v_nhombhyt(4, 4, "Thăm dò chức năng", "TDCN", 1);
            upd_v_nhombhyt(5, 5, "Dịch truyền, Máu, Đạm", "DT", 1);
            upd_v_nhombhyt(6, 6, "Thủ thuật - Phẩu thuật", "PTTT", 1);
            upd_v_nhombhyt(7, 7, "Thuốc", "THUOC", 1);
            upd_v_nhombhyt(8, 8, "Giường", "GIUONG", 1);
            upd_v_nhombhyt(9, 9, "Khác", "KHAC", 1);
        }
        public void f_default_loaivp()
        {
            upd_v_loaivp(1, 1, 1, "KBTT", "Khám thông thường", "", 1, "", 1, "");
            upd_v_loaivp(2, 1, 2, "KBCK", "Khám chuyên khoa", "", 1, "", 1, "");
            upd_v_loaivp(3, 1, 3, "KBSK", "Khám sức khỏe", "", 1, "", 1, "");

            upd_v_loaivp(4, 2, 1, "XNHH", "Huyết học Truyền máu", "", 1, "", 1, "");
            upd_v_loaivp(5, 2, 2, "XNHS", "Hóa sinh", "", 1, "", 1, "");
            upd_v_loaivp(6, 2, 3, "XNVS", "Vi sinh", "", 1, "", 1, "");
            upd_v_loaivp(7, 2, 4, "CTBL", "Cơ thể bệnh lý", "", 1, "", 1, "");
            upd_v_loaivp(8, 2, 5, "XNKH", "Xét nghiệm khác", "", 1, "", 1, "");

            upd_v_loaivp(9, 3, 1, "NS", "Nội soi", "", 1, "", 1, "");
            upd_v_loaivp(10, 3, 2, "SADT", "Siêu âm đen trắng", "", 1, "", 1, "");
            upd_v_loaivp(11, 3, 3, "SAM", "Siêu âm màu", "", 1, "", 1, "");
            upd_v_loaivp(12, 3, 4, "XQ", "X Quang", "", 1, "", 1, "");
            upd_v_loaivp(13, 3, 5, "CT", "City", "", 1, "", 1, "");
            upd_v_loaivp(14, 3, 6, "MRAY", "M-Ray", "", 1, "", 1, "");
            upd_v_loaivp(15, 3, 7, "CDK", "Các kỹ thuật CĐHA khác", "", 1, "", 1, "");

            upd_v_loaivp(16, 4, 1, "KTC", "Dịch vụ kỹ thuật cao", "", 1, "", 1, "");
            upd_v_loaivp(17, 4, 2, "SADT", "Thăm dò chức năng", "", 1, "", 1, "");
            upd_v_loaivp(18, 4, 3, "SAM", "DVKTC Khác", "", 1, "", 1, "");

            upd_v_loaivp(19, 5, 1, "DT", "Dịch truyền", "", 1, "", 1, "");
            upd_v_loaivp(20, 5, 2, "MAU", "Máu", "", 1, "", 1, "");
            upd_v_loaivp(21, 5, 3, "DAM", "Đạm", "", 1, "", 1, "");

            upd_v_loaivp(22, 6, 1, "TT", "Thủ thuật", "", 1, "", 1, "");
            upd_v_loaivp(23, 6, 2, "PT", "Phẩu thuật", "", 1, "", 1, "");
            upd_v_loaivp(24, 6, 3, "MNS", "Mổ nội soi", "", 1, "", 1, "");

            upd_v_loaivp(25, 7, 1, "THUOC", "Thuốc", "", 1, "", 1, "");
            upd_v_loaivp(26, 7, 2, "VTYT", "Vật tư y tế", "", 1, "", 1, "");

            upd_v_loaivp(27, 8, 1, "GITT", "Giường thông thường", "", 1, "", 1, "");
            upd_v_loaivp(28, 8, 2, "GIYC", "Giường yêu cầu", "", 1, "", 1, "");

            upd_v_loaivp(29, 9, 1, "KHAC", "Loại khác", "", 1, "", 1, "");
        }
        #endregion CẬP NHẬT CẤU TRÚC TABLES

        #region LẤY CẤU TRÚC DATABASE

        private void f_load_maincode()
        {
            try
            {
                //linh 02012013
                string s_Key = Maincode("Key");
                if (s_Key == "1")
                {
                    if (Maincode("Ip") != "") m_db_host = DeCode(Maincode("Ip"), key);
                    if (Maincode("Post") != "") m_db_port = DeCode(Maincode("Post"), key);
                    if (Maincode("UserID") != "") m_db_userid = DeCode(Maincode("UserID"), key);
                    if (Maincode("Password") != "") m_db_password = DeCode(Maincode("Password"), key);
                    if (Maincode("Database") != "") m_db_database = DeCode(Maincode("Database"), key);
                }
                else
                {
                    if (Maincode("Ip") != "") m_db_host = Maincode("Ip");
                    if (Maincode("Post") != "") m_db_port = Maincode("Post");
                    if (Maincode("UserID") != "") m_db_userid = Maincode("UserID");
                    if (Maincode("Password") != "") m_db_password = Maincode("Password");
                    if (Maincode("Database") != "") m_db_database = Maincode("Database");
                    //if (Maincode("xxxxx") == "*****") m_db_password = decode(xxxxx).ToLower();
                }
                if (Maincode("User") != "") m_db_schemaroot = Maincode("User");
            }
            catch { }
        }
        public string s_database
        {
            get
            {
                return m_db_database;
            }
        }
        public string s_schemaroot
        {
            get
            {
                return m_db_schemaroot;
            }
        }
        public DataSet f_get_sys_schema()
        {
            return get_data("select * from pg_tables where tableowner ='" + m_db_userid + "' and schemaname like '" + m_db_schemaroot + "%' order by schemaname, tablename");
        }
        public DataSet f_get_sys_table_structure(string v_schemaname, string v_tablename)
        {
            DataSet ads = null;
            try
            {
                ads = new DataSet();
                ads.Tables.Add("Table");
                ads.Tables[0].Columns.Add("name");
                ads.Tables[0].Columns.Add("type");
                if (v_schemaname != "" && v_tablename != "")
                {
                    foreach (DataColumn c in get_data("select * from " + v_schemaname + "." + v_tablename + " where 1=0").Tables[0].Columns)
                    {
                        ads.Tables[0].Rows.Add(new string[] { c.ColumnName, c.DataType.ToString().Split('.')[c.DataType.ToString().Split('.').Length - 1] });
                    }
                }
                else
                    if (v_tablename == "")
                    {
                        foreach (DataRow r in get_data("select distinct tablename from pg_tables where schemaname='" + v_schemaname + "'").Tables[0].Rows)
                        {
                            ads.Tables[0].Rows.Add(new string[] { r[0].ToString(), "table" });
                        }
                    }
                    else
                        if (v_schemaname == "")
                        {
                            foreach (DataRow r in get_data("select distinct schemaname from pg_tables where tableowner='" + m_db_database + "'").Tables[0].Rows)
                            {
                                ads.Tables[0].Rows.Add(new string[] { r[0].ToString(), "schema" });
                            }
                        }
            }
            catch
            {
                ads = null;
            }
            return ads;
        }

        #endregion LẤY CẤU TRÚC DATABASE

        #region CÁC HÀM DÙNG CHUNG HỆ THỐNG

        public string Maincode(string v_columnname)
        {
            string r = "";
            try
            {
                XmlDocument doc = new XmlDocument();
                doc.Load("..//..//..//xml//maincode.xml");
                XmlNodeList nodeLst = doc.GetElementsByTagName(v_columnname);
                r = nodeLst.Item(0).InnerText;
            }
            catch
            {
                r = "";
            }
            return r;
        }
        public string f_thongso(string v_columname)
        {
            string r = "";
            try
            {
                XmlDocument doc = new XmlDocument();
                doc.Load("..//..//..//xml//v_thongso.xml");
                XmlNodeList nodeLst = doc.GetElementsByTagName(v_columname);
                r = nodeLst.Item(0).InnerText;
            }
            catch
            {
                r = "";
            }
            return r;
        }
        public bool s_iscreated(string v_schemaname)
        {
            bool art = false;
            try
            {
                art = (get_data("select schemaname from pg_tables where schemaname = '" + v_schemaname + "' group by schemaname").Tables[0].Rows.Count > 0);
            }
            catch
            {
                art = false;
            }
            return art;
        }
        public bool s_iscreated_mmyy(string v_mmyy)
        {
            return s_iscreated(s_schema_mmyy(v_mmyy));
        }
        public DataSet s_all_tables_vp
        {
            get
            {
                DataSet ads = new DataSet();
                ads.Tables.Add("Table");
                ads.Tables[0].Columns.Add("TABLE_NAME");
                ads.Tables[0].Rows.Add(new string[] { "V_BHYT" });
                ads.Tables[0].Rows.Add(new string[] { "V_CHIDINH" });
                ads.Tables[0].Rows.Add(new string[] { "V_CONGNO" });
                ads.Tables[0].Rows.Add(new string[] { "V_ERROR" });
                ads.Tables[0].Rows.Add(new string[] { "V_GIUONG" });
                ads.Tables[0].Rows.Add(new string[] { "V_SUATAN" });
                ads.Tables[0].Rows.Add(new string[] { "V_HOANTRA" });
                ads.Tables[0].Rows.Add(new string[] { "V_HOANTRACT" });
                ads.Tables[0].Rows.Add(new string[] { "V_MIENNGTRU" });
                ads.Tables[0].Rows.Add(new string[] { "V_MIENNOITRU" });
                ads.Tables[0].Rows.Add(new string[] { "V_NHOM" });
                ads.Tables[0].Rows.Add(new string[] { "V_PHIEUCHICT" });
                ads.Tables[0].Rows.Add(new string[] { "V_PHIEUCHILL" });
                ads.Tables[0].Rows.Add(new string[] { "V_TAMUNGCT" });
                ads.Tables[0].Rows.Add(new string[] { "V_TAMUNG" });
                ads.Tables[0].Rows.Add(new string[] { "V_THNGAYCT" });
                ads.Tables[0].Rows.Add(new string[] { "V_THNGAYLL" });
                ads.Tables[0].Rows.Add(new string[] { "V_THVPBHYT" });
                ads.Tables[0].Rows.Add(new string[] { "V_THVPCT" });
                ads.Tables[0].Rows.Add(new string[] { "V_THVPLL" });
                ads.Tables[0].Rows.Add(new string[] { "V_TRONGOI" });
                ads.Tables[0].Rows.Add(new string[] { "V_TTRVBHYT" });
                ads.Tables[0].Rows.Add(new string[] { "V_TTRVCT" });
                ads.Tables[0].Rows.Add(new string[] { "V_TTRVDS" });
                ads.Tables[0].Rows.Add(new string[] { "V_TTRVLL" });
                ads.Tables[0].Rows.Add(new string[] { "V_TTRVNHOM" });
                ads.Tables[0].Rows.Add(new string[] { "V_TTRVPTTT" });
                ads.Tables[0].Rows.Add(new string[] { "V_TTRVPTTTCT" });
                ads.Tables[0].Rows.Add(new string[] { "V_VIENPHICT" });
                ads.Tables[0].Rows.Add(new string[] { "V_VIENPHILL" });
                ads.Tables[0].Rows.Add(new string[] { "V_VPKHOA" });
                return ads;
            }
        }
        public DataSet s_all_tables_d
        {
            get
            {
                DataSet ads = new DataSet();
                ads.Tables.Add("Table");
                ads.Tables[0].Columns.Add("TABLE_NAME");
                ads.Tables[0].Rows.Add(new string[] { "BHYTCLS" });
                ads.Tables[0].Rows.Add(new string[] { "BHYTDS" });
                ads.Tables[0].Rows.Add(new string[] { "BHYTKB" });
                ads.Tables[0].Rows.Add(new string[] { "BHYTTHUOC" });
                ads.Tables[0].Rows.Add(new string[] { "D_BIENLAI" });
                ads.Tables[0].Rows.Add(new string[] { "D_BUCSTT" });
                ads.Tables[0].Rows.Add(new string[] { "D_CAPSOTOA" });
                ads.Tables[0].Rows.Add(new string[] { "D_CHANDOAN" });
                ads.Tables[0].Rows.Add(new string[] { "D_CHUYENCT" });
                ads.Tables[0].Rows.Add(new string[] { "D_CHUYENLL" });
                ads.Tables[0].Rows.Add(new string[] { "D_CTGHISOCT" });
                ads.Tables[0].Rows.Add(new string[] { "D_CTGHISOLL" });
                ads.Tables[0].Rows.Add(new string[] { "D_DUTRUCAPCT" });
                ads.Tables[0].Rows.Add(new string[] { "D_DUTRUCAPLL" });
                ads.Tables[0].Rows.Add(new string[] { "D_ERROR" });
                ads.Tables[0].Rows.Add(new string[] { "D_HUYBANCT" });
                ads.Tables[0].Rows.Add(new string[] { "D_HUYBANLL" });
                ads.Tables[0].Rows.Add(new string[] { "D_KIEMTRA" });
                ads.Tables[0].Rows.Add(new string[] { "D_NGTRUCT" });
                ads.Tables[0].Rows.Add(new string[] { "D_NGTRULL" });
                ads.Tables[0].Rows.Add(new string[] { "D_NHAPCT" });
                ads.Tables[0].Rows.Add(new string[] { "D_NHAPCT2" });
                ads.Tables[0].Rows.Add(new string[] { "D_NHAPLL" });
                ads.Tables[0].Rows.Add(new string[] { "D_NHAPSLCT" });
                ads.Tables[0].Rows.Add(new string[] { "D_NHAPSLLL" });
                ads.Tables[0].Rows.Add(new string[] { "D_PHIEUXUAT" });
                ads.Tables[0].Rows.Add(new string[] { "D_SOPHIEU" });
                ads.Tables[0].Rows.Add(new string[] { "D_THANHTOAN" });
                ads.Tables[0].Rows.Add(new string[] { "D_THEODOI" });
                ads.Tables[0].Rows.Add(new string[] { "D_THEODOIGIA" });
                ads.Tables[0].Rows.Add(new string[] { "D_THEODOITSCD" });
                ads.Tables[0].Rows.Add(new string[] { "D_THUCBUCSTT" });
                ads.Tables[0].Rows.Add(new string[] { "D_THUCXUAT" });
                ads.Tables[0].Rows.Add(new string[] { "D_THUCXUAT2" });
                ads.Tables[0].Rows.Add(new string[] { "D_TIENTHUOC" });
                ads.Tables[0].Rows.Add(new string[] { "D_TONKHOCT" });
                ads.Tables[0].Rows.Add(new string[] { "D_TONKHOKEMTHEO" });
                ads.Tables[0].Rows.Add(new string[] { "D_TONKHOTH" });
                ads.Tables[0].Rows.Add(new string[] { "D_TUTRUCCT" });
                ads.Tables[0].Rows.Add(new string[] { "D_TUTRUCKEMTHEO" });
                ads.Tables[0].Rows.Add(new string[] { "D_TUTRUCTH" });
                ads.Tables[0].Rows.Add(new string[] { "D_XUATCT" });
                ads.Tables[0].Rows.Add(new string[] { "D_XUATLL" });
                ads.Tables[0].Rows.Add(new string[] { "D_XUATSDCT" });
                ads.Tables[0].Rows.Add(new string[] { "D_XUATSDLL" });
                return ads;
            }
        }
        public DataSet s_all_field_name
        {
            get
            {
                DataSet ads = new DataSet();
                ads.Tables.Add("Tables");
                ads.Tables[0].Columns.Add("loai");
                ads.Tables[0].Columns.Add("table_name");
                ads.Tables[0].Columns.Add("field_name");
                ads.Tables[0].Rows.Add(new string[] { "VP", "V_BHYT", "id,sothe,maphu,mabv,noigioithieu" });
                ads.Tables[0].Rows.Add(new string[] { "VP", "V_CHIDINH", "id,mabn,maql,idkhoa,ngay,loai,makp,madoituong,mavp,soluong,dongia,paid,done,userid,ngayud,vattu,tinhtrang,thuchien,computer" });
                ads.Tables[0].Rows.Add(new string[] { "VP", "V_CONGNO", "mabn,maql,idkhoa,mavp,sotien,dathu" });
                ads.Tables[0].Rows.Add(new string[] { "VP", "V_ERROR", "message,computer,tables,ngayud" });
                ads.Tables[0].Rows.Add(new string[] { "VP", "V_GIUONG", "id,mavp,ngay,dongia" });
                ads.Tables[0].Rows.Add(new string[] { "VP", "V_HOANTRA", "id,quyenso,sobienlai,ngay,mabn,hoten,sotien,ghichu,userid,ngayud,loai,loaibn" });
                ads.Tables[0].Rows.Add(new string[] { "VP", "V_HOANTRACT", "id,loaivp,sotien" });
                ads.Tables[0].Rows.Add(new string[] { "VP", "V_MIENNGTRU", "id,sotien,ghichu,maduyet,lydo" });
                ads.Tables[0].Rows.Add(new string[] { "VP", "V_MIENNOITRU", "id,lydo,ghichu,maduyet" });
                ads.Tables[0].Rows.Add(new string[] { "VP", "V_NHOM", "id,ma,sotien" });
                ads.Tables[0].Rows.Add(new string[] { "VP", "V_PHIEUCHICT", "id,stt,mavp,sotien" });
                ads.Tables[0].Rows.Add(new string[] { "VP", "V_PHIEUCHILL", "id,quyenso,sobienlai,ngay,mabn,maql,idkhoa,makp,hoten,loai,loaibn,userid,ngayud" });
                ads.Tables[0].Rows.Add(new string[] { "VP", "V_TAMUNG", "id,mabn,maql,idkhoa,quyenso,sobienlai,ngay,loai,makp,madoituong,sotien,userid,ngayud,done,lanin,loaibn,idttrv" });
                ads.Tables[0].Rows.Add(new string[] { "VP", "V_TAMUNGCT", "id,loaivp,sotien" });
                ads.Tables[0].Rows.Add(new string[] { "VP", "V_THNGAYCT", "id,ngay,mavp,soluong,dongia,sotien" });
                ads.Tables[0].Rows.Add(new string[] { "VP", "V_THNGAYLL", "id,madoituong,mabn,maql,ngayvao,tu,den,giuong,makp,conlai,sotien,datra,done" });
                ads.Tables[0].Rows.Add(new string[] { "VP", "V_THVPBHYT", "id,sothe,maphu,noigioithieu,noicap" });
                ads.Tables[0].Rows.Add(new string[] { "VP", "V_THVPCT", "id,ngay,makp,madoituong,mavp,soluong,dongia,sotien,vattu" });
                ads.Tables[0].Rows.Add(new string[] { "VP", "V_THVPLL", "id,mabn,maql,idkhoa,ngayvao,ngayra,giuong,makp,chandoan,maicd,sotien,tamung,bhyt,mien,done" });
                ads.Tables[0].Rows.Add(new string[] { "VP", "V_TRONGOI", "id,sotien,tamung,hoantra,pm,yc,ghichu" });
                ads.Tables[0].Rows.Add(new string[] { "VP", "V_TTRVBHYT", "id,sothe,maphu,tungay,ngay,mabv,noigioithieu" });
                ads.Tables[0].Rows.Add(new string[] { "VP", "V_TTRVCT", "id,stt,ngay,makp,madoituong,mavp,soluong,dongia,vat,vattu,sotien" });
                ads.Tables[0].Rows.Add(new string[] { "VP", "V_TTRVDS", "id,mabn,maql,idkhoa,giuong,ngayvao,ngayra,chandoan,maicd" });
                ads.Tables[0].Rows.Add(new string[] { "VP", "V_TTRVLL", "ngay,makp,sotien,tamung,mien,bhyt,userid,ngayud,lanin,id,loaibn,loai,quyenso,sobienlai" });//,nopthem,thieu,vattu,chenhlech,idtonghop"});
                ads.Tables[0].Rows.Add(new string[] { "VP", "V_TTRVNHOM", "id,ma,sotien" });
                ads.Tables[0].Rows.Add(new string[] { "VP", "V_TTRVPTTT", "id,ngay,songay_tpt,songay_spt,mavp,so,loaipt,tenpt" });
                ads.Tables[0].Rows.Add(new string[] { "VP", "V_TTRVPTTTCT", "id,stt,songay,dongia,loaipt" });
                ads.Tables[0].Rows.Add(new string[] { "VP", "V_VIENPHICT", "id,stt,madoituong,mavp,soluong,dongia,mien,thieu,vattu,mabs,makp" });
                ads.Tables[0].Rows.Add(new string[] { "VP", "V_VIENPHILL", "id,quyenso,sobienlai,ngay,mabn,maql,idkhoa,makp,hoten,namsinh,diachi,loai,loaibn,lanin,userid,ngayud" });
                ads.Tables[0].Rows.Add(new string[] { "VP", "V_VPKHOA", "id,mabn,maql,idkhoa,ngay,makp,madoituong,mavp,soluong,dongia,done,userid,ngayud,vattu" });
                ads.Tables[0].Rows.Add(new string[] { "D", "BHYTCLS", "id,stt,mavp,soluong,dongia,idchidinh" });
                ads.Tables[0].Rows.Add(new string[] { "D", "BHYTDS", "mabn,hoten,namsinh,diachi" });
                ads.Tables[0].Rows.Add(new string[] { "D", "BHYTKB", "mabn,maql,makp,chandoan,maicd,mabs,sothe,maphu,mabv,congkham,thuoc,cls,bntra,bhyttra,mmyy,userid,ngayud,done,sotoa,id,nhom,quyenso,sobienlai,ngay" });
                ads.Tables[0].Rows.Add(new string[] { "D", "BHYTTHUOC", "id,stt,sttt,makho,manguon,nhomcc,mabd,handung,losx,soluong,sotien,giaban,giamua,cachdung" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_BIENLAI", "id,sohieu,sobienlai,sotien" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_BUCSTT", "id,stt,sttt,makho,manguon,nhomcc,mabd,handung,losx,soluong,sotien,giaban,giamua,sttduyet" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_CAPSOTOA", "id,ngay,loai,sotoa" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_CHANDOAN", "id,loai,maicd,chandoan" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_CHUYENCT", "id,stt,sttt,makho,manguon,nhomcc,mabd,handung,losx,soluong,sotien,giaban,giamua,nguonchuyen,stttchuyen" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_CHUYENLL", "id,nhom,sophieu,ngay,lydo,mmyy,userid,ngayud" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_CTGHISOCT", "id,makho,makp,no,co,sotien,diengiai" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_CTGHISOLL", "id,nhom,soct,ngay,mmyy,userid,ngayud" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_DUTRUCAPCT", "id,manguon,mabd,slyeucau,slthuc" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_DUTRUCAPLL", "id,nhom,sophieu,ngay,loai,khox,khon,userid,ngayud,done" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_ERROR", "message,computer,tables,ngayud" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_HUYBANCT", "id,stt,sttt,makho,manguon,nhomcc,mabd,handung,losx,soluong,sotien,giaban,giamua" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_HUYBANLL", "id,nhom,mabn,hoten,namsinh,ngay,mabs,makp,loai,mmyy,done,userid,ngayud,lanin,sotoa,maql" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_KIEMTRA", "nhom,ngay,userid,ngayud" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_NGTRUCT", "id,stt,sttt,makho,manguon,nhomcc,mabd,handung,losx,soluong,sotien,giaban,giamua" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_NGTRULL", "id,nhom,mabn,hoten,namsinh,ngay,mabs,makp,loai,mmyy,done,userid,ngayud,lanin,sotoa,maql" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_NHAPCT", "vat,soluong,dongia,sotien,giaban,giamua,sl1,sl2,tyle,cuocvc,chaythu,namsx,tailieu,baohanh,nguongoc,tinhtrang,sothe,giabancu,id,stt,mabd,handung,losx" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_NHAPCT2", "id,stt,mabd,soluong,sotien" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_NHAPLL", "id,nhom,sophieu,ngaysp,sohd,ngayhd,bbkiem,ngaykiem,loai,nguoigiao,madv,makho,manguon,nhomcc,no,co,mmyy,userid,ngayud,paid,lydo" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_NHAPSLCT", "id,stt,mabd,handung,losx,soluong,sl1,sl2" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_NHAPSLLL", "id,nhom,sophieu,ngaysp,sohd,ngayhd,loai,nguoigiao,madv,makho,mmyy,done,userid,ngayud" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_PHIEUXUAT", "id,soct,ngay,makp,nhom,loai,phieu,kho,sotien,no,co,diengiai,mmyy,userid,ngayud" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_SOPHIEU", "mmyy,nhom,ngay,makp,loai,phieu,loaiin,makho,madoituong,so,lanin,manguon,nguoilinh" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_THANHTOAN", "ngay,no,co,sotien,datra,mmyy,userid,ngayud,id" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_THEODOI", "id,mabd,manguon,nhomcc,handung,losx,sothe,namsx,namsd,baohanh,nguongoc,tinhtrang,giamua,giaban,ngayud" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_THEODOIGIA", "mabd,ngay,dongia,ngayud" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_THEODOITSCD", "makho,sttt,nam,namsx,namsd,tyle,phanloai,baohanh,nguongoc,tinhtrang,sothe" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_THUCBUCSTT", "id,sttt,makho,manguon,nhomcc,mabd,handung,losx,soluong,sotien,giaban,giamua,stt" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_THUCXUAT", "id,sttt,madoituong,makho,manguon,nhomcc,mabd,handung,losx,soluong,sotien,giaban,giamua,sothe,namsx,namsd,stt" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_THUCXUAT2", "id,sttt,makho,mabd,soluong,sotien,giamua,stt" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_TIENTHUOC", "mabn,maql,idkhoa,ngay,makp,madoituong,mabd,soluong,sotien,giaban,giamua,done" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_TONKHOCT", "mmyy,makho,manguon,nhomcc,stt,idn,sttn,mabd,handung,losx,tondau,sttondau,slnhap,stnhap,slxuat,stxuat,giaban,giamua" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_TONKHOKEMTHEO", "makhot,sttt,makho,stt,idn,sttn,mabd,tondau,sttondau,slnhap,stnhap,slxuat,stxuat,giamua" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_TONKHOTH", "mmyy,makho,mabd,tondau,slnhap,slxuat,slyeucau,manguon" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_TUTRUCCT", "mmyy,makp,makho,manguon,nhomcc,stt,mabd,handung,losx,tondau,sttondau,slnhap,stnhap,slxuat,stxuat,giaban,giamua" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_TUTRUCKEMTHEO", "makhot,sttt,makp,makho,stt,mabd,tondau,sttondau,slnhap,stnhap,slxuat,stxuat,giamua" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_TUTRUCTH", "mmyy,makp,makho,mabd,tondau,slnhap,slxuat,slyeucau,manguon" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_XUATCT", "sothe,mabs,hotenbn,id,stt,sttt,manguon,nhomcc,mabd,handung,losx,soluong,sotien,giaban,giamua" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_XUATLL", "id,nhom,sophieu,ngay,loai,khox,khon,lydo,mmyy,userid,ngayud,idduyet" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_XUATSDCT", "id,stt,sttt,madoituong,makho,manguon,nhomcc,mabd,handung,losx,soluong,sotien,giaban,giamua,sttduyet,sothe,namsx,namsd" });
                ads.Tables[0].Rows.Add(new string[] { "D", "D_XUATSDLL", "id,nhom,mabn,maql,idkhoa,ngay,loai,phieu,makp,mmyy,userid,ngayud,idduyet,thuoc,makhoa,lydo,lk,ghichu" });
                return ads;
            }
        }
        public string s_schema_mmyy(string v_mmyy)
        {
            return (m_db_schemaroot + "" + v_mmyy);
        }
        public DataSet get_shemaname_mmyy(string v_schemaroot)
        {
            m_ds = get_data("select distinct schemaname from pg_tables where schemaname like '" + v_schemaroot + "____'");
            return m_ds;
        }
        public DataSet get_shemaname_mmyy()
        {
            m_ds = get_data("select distinct schemaname from pg_tables where schemaname like '" + s_schemaroot + "____'");
            return m_ds;
        }
        public DataSet get_tablename(string v_schemaname)
        {
            m_ds = get_data("select tablename from pg_tables where schemaname ='" + v_schemaname + "' group by tablename");
            return m_ds;
        }
        public DataSet get_tablename_root()
        {
            return get_tablename(s_schemaroot);
        }
        public string get_field_vp(string v_table)
        {
            string rt = "";
            try
            {
                rt = s_all_field_name.Tables[0].Select("table_name='" + v_table.ToUpper() + "' and loai='VP'")[0]["field_name"].ToString();
            }
            catch
            {
                rt = "*";
            }
            if (rt.Trim() == "") rt = "*";
            return rt;
        }
        public string get_field_d(string v_table)
        {
            string rt = "";
            try
            {
                rt = s_all_field_name.Tables[0].Select("table_name='" + v_table.ToUpper() + "' and loai='D'")[0]["field_name"].ToString();
            }
            catch
            {
                rt = "*";
            }
            if (rt.Trim() == "") rt = "*";
            return rt;
        }
        public void f_write_error(string v_error)
        {
            try
            {
                System.IO.StreamWriter ast = System.IO.File.AppendText("..//..//..//xml//v_tables_sql.txt");
                ast.WriteLine(v_error);
                ast.WriteLine("");
                ast.Close();
            }
            catch
            {
            }
        }

        public void execute_data(bool bLuuErr, string sql)
        {
            sql = sql.Replace("medibv.", m_db_schemaroot + ".");
            try
            {
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }

                con = new NpgsqlConnection(sConn);
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.ExecuteNonQuery();
            }
            catch (Exception ex)
            {
                //MessageBox.Show(ex.ToString());
                if (bLuuErr) upd_error("sql: " + sql + "; " + ex.Message, m_computername, "");
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
        }
        public void execute_data(string sql)
        {
            sql = sql.Replace("medibv.", m_db_schemaroot + ".");
            try
            {
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }

                con = new NpgsqlConnection(sConn);
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.ExecuteNonQuery();
            }
            catch (Exception ex)
            {
                //MessageBox.Show(ex.ToString());
                upd_error("sql: " + sql + "; " + ex.Message, m_computername, "");
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
        }
        public void execute_data_mmyy(string v_mmyy, string sql)
        {
            try
            {
                sql = sql.Replace("medibvmmyy.", s_schema_mmyy(v_mmyy) + ".");
                sql = sql.Replace("medibv.", m_db_schemaroot + ".");
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.ExecuteNonQuery();
                //cmd.Dispose();
                //con.Dispose();
            }
            catch (Exception ex)
            {
                //MessageBox.Show(ex.ToString());
                upd_error("sql: " + sql + "; " + ex.Message, m_computername, "");
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
        }
        public void upd_error(string m_message, string m_computer, string m_table)
        {
            sql = "insert into " + user + ".v_error(message,computer,tables) values (:m_message,:m_computer,:m_table)";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }

            con = new NpgsqlConnection(sConn);
            try
            {

                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_message", NpgsqlDbType.Text).Value = m_message;
                cmd.Parameters.Add("m_computer", NpgsqlDbType.Varchar, 20).Value = m_computer;
                cmd.Parameters.Add("m_table", NpgsqlDbType.Varchar, 20).Value = m_table;
                cmd.ExecuteNonQuery();
            }
            catch //(Exception ex)
            {
                //MessageBox.Show(ex.ToString());
                //upd_error("sql: " + sql + "; " + ex.Message, m_computername, "");
            }
            finally
            {
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
        }
        public void tao_view()
        {
            string ammyy = "";
            ammyy = m_cur_mmyy;
            string sql = "CREATE OR REPLACE VIEW " + m_db_schemaroot + ".vv_bienlaithuvienphi_" + get_dmcomputer().ToString().PadLeft(4, '0') + " AS ";
            sql += "(( SELECT DISTINCT v_vienphill.quyenso, v_vienphill.sobienlai";
            sql += " FROM "+m_db_schemaroot + ammyy +".v_vienphill";
            sql += " ORDER BY v_vienphill.quyenso, v_vienphill.sobienlai)";
            sql +=" UNION ALL ";
            sql += "( SELECT DISTINCT v_ttrvll.quyenso, v_ttrvll.sobienlai";
            sql += " FROM " + m_db_schemaroot + ammyy + ".v_ttrvll";
            sql += " ORDER BY v_ttrvll.quyenso, v_ttrvll.sobienlai))";
            sql += " UNION ALL ";
            sql += " ( SELECT DISTINCT v_tamung.quyenso, v_tamung.sobienlai";
            sql += " FROM " + m_db_schemaroot + ammyy + ".v_tamung";
            sql += " ORDER BY v_tamung.quyenso, v_tamung.sobienlai);";

            sql += " ALTER TABLE " + m_db_schemaroot + ".vv_bienlaithuvienphi_" + get_dmcomputer().ToString().PadLeft(4, '0') + " OWNER TO " + m_db_schemaroot + ";";
            execute_data(sql);

        }
        public DataSet get_data(string sql)
        {
            string ammyy = "";
            ammyy = m_cur_mmyy;
            m_ds = null;
            try
            {
                sql = sql.Replace("medibvmmyy.", m_db_schemaroot + ammyy + ".");
                sql = sql.Replace("medibv.", m_db_schemaroot + ".");
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                dest = new NpgsqlDataAdapter(cmd);
                m_ds = new DataSet();
                dest.Fill(m_ds);

            }
            catch (NpgsqlException ex)
            {
                upd_error(sql + ";- " + ex.Message, System.Environment.MachineName, "?");
                m_ds = null;

            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
                con.Close();
            }
            return m_ds;
        }
        public DataSet get_data_all(string str)
        {
            try
            {
                string sql = "", sql1 = "";
                DataSet ads = null, adst = null, adsschema = null;
                if (sql.IndexOf(":medibvmmyy") >= 0)
                {
                    adsschema = get_shemaname_mmyy();
                    foreach (DataRow r in adsschema.Tables[0].Rows)
                    {
                        sql1 = str;
                        sql = sql1.Replace(":medibvmmyy", r["schemaname"].ToString());
                        sql = sql.Replace(":medibv", s_schemaroot);
                        adst = get_data(sql);
                        if (ads == null)
                        {
                            if (adst != null)
                            {
                                ads = adst;
                            }
                        }
                        else
                        {
                            if (adst != null)
                            {
                                ads.Merge(adst);
                            }
                        }
                    }
                }
                else
                {
                    sql = str.Replace(":medibv", s_schemaroot);
                    ads = get_data(sql);
                }
                return ads;
            }
            catch (Exception ex)
            {

                upd_error("sql: " + sql + "; " + ex.Message, m_computername, "");
                return null;
            }
        }
        public DataSet get_data_all(DateTime v_tn, DateTime v_dn, string str)
        {
            try
            {
                string sql = "", sql1 = "";
                DataSet ads = null, adst = null, adsschema = null;
                if (sql.IndexOf(":medibvmmyy") >= 0)
                {
                    adsschema = get_shemaname_mmyy();
                    int atu = v_tn.Month + int.Parse(v_tn.Year.ToString().Substring(2)) * 12;
                    int aden = v_dn.Month + int.Parse(v_dn.Year.ToString().Substring(2)) * 12;
                    foreach (DataRow r in adsschema.Tables[0].Rows)
                    {
                        int ahientai = int.Parse(r["schemaname"].ToString().Substring(r["schemaname"].ToString().Length - 4, 2)) + int.Parse(r["schemaname"].ToString().Substring(r["schemaname"].ToString().Length - 2, 2)) * 12;
                        if (ahientai >= atu && ahientai <= aden)
                        {
                            sql1 = str;
                            sql = sql1.Replace(":medibvmmyy", r["schemaname"].ToString());
                            sql = sql.Replace(":medibv", s_schemaroot);
                            adst = get_data(sql);
                            if (ads == null)
                            {
                                if (adst != null)
                                {
                                    ads = adst;
                                }
                            }
                            else
                            {
                                if (adst != null)
                                {
                                    ads.Merge(adst);
                                }
                            }
                        }
                    }
                }
                else
                {
                    sql = str.Replace(":medibv", s_schemaroot);
                    ads = get_data(sql);
                }
                return ads;
            }
            catch
            {
                return null;
            }
        }
        public DataRow getrowbyid(DataTable dt, string exp)
        {
            try
            {
                DataRow[] r = dt.Select(exp);
                return r[0];
            }
            catch { return null; }
        }
        public string s_doituong_giadv
        {
            get
            {
                try
                {
                    string ar = "";
                    foreach (DataRow r in get_data("select madoituong from " + s_schemaroot + ".d_doituong where loai=1").Tables[0].Rows)
                    {
                        ar = ar.Trim() + r[0].ToString() + ",";
                    }
                    return ar;
                }
                catch
                {
                    return "";
                }
            }
        }

        #endregion CÁC HÀM DÙNG CHUNG HỆ THỐNG

        #region CAPID
        public string get_cap_mabn(string v_yy)
        {

            string amabn = "";
            decimal ayy = 0, astt = 0, auserid = 1;

            try
            {
                ayy = decimal.Parse(v_yy);
            }
            catch
            {
                ayy = decimal.Parse(DateTime.Now.Year.ToString().Substring(2));
            }
            try
            {
                astt = decimal.Parse(get_data("select stt+1 from medibv.capmabn where yy=" + ayy.ToString() + " and loai=7 and userid=" + auserid.ToString()).Tables[0].Rows[0][0].ToString());
                execute_data("update medibv.capmabn set stt=stt+1 where yy=" + ayy.ToString() + " and loai=7 and userid=" + auserid.ToString() + " and stt<" + astt.ToString());
            }
            catch
            {
                astt = 1;
                execute_data("insert into medibv.capmabn(yy,stt,loai,userid) values(" + ayy.ToString() + ",700000,7," + auserid.ToString() + ")");
            }
            if (bQuanly_Theo_Chinhanh)
            {
                amabn = ayy.ToString().PadLeft(2, '0') + astt.ToString().PadLeft(i_maxlength_mabn - 2, '0');
            }
            else
            {
                amabn = ayy.ToString().PadLeft(2, '0') + astt.ToString().PadLeft(6, '0');
            }
            return amabn;
        }

        /*		
                1 : quyenso
                2 : loaivp
                3 : giavp - 1 : d_dmbd
                4 : dlogin
                5 : vienphi
                6 : tamung
                7 : nhomvp
                8 : hoantra
                9 : chidinh
                10: thanh toan ra vien
        */
        private int get_computerid()
        {
            int art = 1;
            try
            {
                art = int.Parse(get_data("select id, computer from " + m_db_schemaroot + ".dmcomputer").Tables[0].Select("computer='" + m_computername + "'")[0][0].ToString());
            }
            catch
            {
                upd_dmcomputer();
                try
                {
                    art = int.Parse(get_data("select id, computer from " + m_db_schemaroot + ".dmcomputer").Tables[0].Select("computer='" + m_computername + "'")[0][0].ToString().Trim());
                }
                catch
                {
                    art = 1;
                }
            }
            return art;
        }
        private decimal get_xn_capid(decimal v_ma)
        {
            decimal art = 1;
            try
            {
                sql = "update " + m_db_schemaroot + ".xn_capid set id=id+1 where ma=:v_ma";
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("v_ma", NpgsqlDbType.Numeric).Value = v_ma;
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + m_db_schemaroot + ".xn_capid(ma,ten,id,computer) values (:v_ma,:v_ten,1,'????')";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_ma", NpgsqlDbType.Numeric).Value = v_ma;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Varchar, 20).Value = "????";
                    cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
                con.Dispose();
                art = decimal.Parse(get_data("select id from xn_capid where ma=" + v_ma).Tables[0].Rows[0][0].ToString());
            }
            catch
            {
                return art = 1;
            }
            return art;
        }
        private decimal get_xn_capid_may(decimal v_ma, string v_computer)
        {
            decimal art = 1;
            try
            {
                sql = "update " + m_db_schemaroot + ".xn_capid set id=id+1 where ma=:v_ma and computer=:v_computer";
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("v_ma", NpgsqlDbType.Numeric).Value = v_ma;
                cmd.Parameters.Add("v_computer", NpgsqlDbType.Varchar, 20).Value = v_computer;
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + m_db_schemaroot + ".xn_capid(ma,ten,id,computer,ngayud) values (:v_ma,:v_ten,1,:v_computer,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_ma", NpgsqlDbType.Numeric).Value = v_ma;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Varchar, 20).Value = v_computer;
                    cmd.Parameters.Add("v_computer", NpgsqlDbType.Varchar, 20).Value = v_computer;
                    cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
                sql = "select id from " + m_db_schemaroot + ".xn_capid where ma=:v_ma and computer=:v_computer";
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("v_ma", NpgsqlDbType.Numeric).Value = v_ma;
                cmd.Parameters.Add("v_computer", NpgsqlDbType.Varchar, 20).Value = v_computer;
                dest = new NpgsqlDataAdapter(cmd);
                m_ds = new DataSet();
                dest.Fill(m_ds);
                cmd.Dispose();
                con.Dispose();
                art = decimal.Parse(m_ds.Tables[0].Rows[0][0].ToString());
            }
            catch
            {
                art = 1;
            }
            return art;
        }
        private decimal get_d_capid_may(decimal v_ma, string v_computer)
        {
            decimal art = 1;
            try
            {
                sql = "update " + m_db_schemaroot + ".d_capid set id=id+1 where ma=:v_ma and computer=:v_computer";
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("v_ma", NpgsqlDbType.Numeric).Value = v_ma;
                cmd.Parameters.Add("v_computer", NpgsqlDbType.Varchar, 20).Value = v_computer;
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + m_db_schemaroot + ".d_capid(ma,ten,id,computer,ngayud) values (:m_ma,:m_ten,1,:m_computer,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_ma", NpgsqlDbType.Numeric).Value = v_ma;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Varchar, 20).Value = "????";
                    cmd.Parameters.Add("v_computer", NpgsqlDbType.Varchar, 20).Value = v_computer;
                    cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
                sql = "select id from " + m_db_schemaroot + ".d_capid where ma=:v_ma and computer=:v_computer";
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("v_ma", NpgsqlDbType.Numeric).Value = v_ma;
                cmd.Parameters.Add("v_computer", NpgsqlDbType.Varchar, 20).Value = v_computer;
                dest = new NpgsqlDataAdapter(cmd);
                m_ds = new DataSet();
                dest.Fill(m_ds);
                cmd.Dispose();
                con.Dispose();
                art = decimal.Parse(m_ds.Tables[0].Rows[0][0].ToString());
            }
            catch
            {
                art = 1;
            }
            return art;
        }
        private decimal get_v_capid(decimal v_ma)
        {
            decimal art = 1;
            try
            {
                sql = "update " + m_db_schemaroot + ".v_capid set id=id+1 where ma=:v_ma";
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("v_ma", NpgsqlDbType.Numeric).Value = v_ma;
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + m_db_schemaroot + ".v_capid(ma,ten,id,computer) values (:v_ma,:v_ten,1,'????')";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_ma", NpgsqlDbType.Numeric).Value = v_ma;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Varchar, 20).Value = "????";
                    cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
                con.Dispose();
                art = decimal.Parse(get_data("select id from " + m_db_schemaroot + ".v_capid where ma=" + v_ma).Tables[0].Rows[0][0].ToString());
            }
            catch
            {
                sql = "alter table medibv.v_capid alter column ma type int";
                execute_data(sql);
                return art = 1;
            }
            return art;
        }

        public decimal get_v_capsokham(decimal v_id, string v_ddmmyy, string v_loai, int v_chinhanh)
        {
            //v_loai='BH':BHYT
            //v_loai='DV':BHYT
            decimal art = 1;
            try
            {
                sql = "update " + m_db_schemaroot + ".v_capsokham set stt=stt+1 where id=" + v_id + " and ddmmyy='" + v_ddmmyy + "' and loai='" + v_loai + "' and chinhanh=" + v_chinhanh;
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + m_db_schemaroot + ".v_capsokham(id,ddmmyy,loai, chinhanh,stt) values (" + v_id + ",'" + v_ddmmyy + "','" + v_loai + "'," + v_chinhanh + ",1)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
                con.Dispose();
                art = decimal.Parse(get_data("select stt from " + m_db_schemaroot + ".v_capsokham where id=" + v_id + " and ddmmyy='" + v_ddmmyy + "' and loai='" + v_loai + "'").Tables[0].Rows[0][0].ToString());
            }
            catch
            {
                return art = 1;
            }
            return art;
        }
        
        private decimal get_v_capid_may(decimal v_ma, string v_computer)
        {
            decimal art = 1;
            try
            {
                decimal d_IDTemp = decimal.Parse(get_data("select to_char(now(),'yymmddhh24miss')").Tables[0].Rows[0][0].ToString());
                int i_Randome = getRandom();
                art = decimal.Parse(d_IDTemp + i_Randome.ToString().PadLeft(3, '0'));
                return art;
                //sql = "update " + m_db_schemaroot + ".v_capid set id=id+1 where ma=:v_ma and computer=:v_computer";
                //if (con != null)
                //{
                //    con.Close(); con.Dispose();
                //}
                //con = new NpgsqlConnection(sConn);
                //cmd = new NpgsqlCommand(sql, con);
                //cmd.CommandType = CommandType.Text;
                //cmd.Parameters.Add("v_ma", NpgsqlDbType.Numeric).Value = v_ma;
                //cmd.Parameters.Add("v_computer", NpgsqlDbType.Varchar, 20).Value = v_computer;
                //con.Open();
                //int irec = cmd.ExecuteNonQuery();
                //cmd.Dispose();
                //if (irec == 0)
                //{
                //    sql = "insert into " + m_db_schemaroot + ".v_capid(ma,ten,id,computer,ngayud) values (:v_ma,:v_ten,1,:v_computer,now())";
                //    cmd = new NpgsqlCommand(sql, con);
                //    cmd.CommandType = CommandType.Text;
                //    cmd.Parameters.Add("v_ma", NpgsqlDbType.Numeric).Value = v_ma;
                //    cmd.Parameters.Add("v_ten", NpgsqlDbType.Varchar, 20).Value = "????";
                //    cmd.Parameters.Add("v_computer", NpgsqlDbType.Varchar, 20).Value = v_computer;
                //    cmd.ExecuteNonQuery();
                //    cmd.Dispose();
                //}
                //sql = "select id from " + m_db_schemaroot + ".v_capid where ma=:v_ma and computer=:v_computer";
                //cmd = new NpgsqlCommand(sql, con);
                //cmd.CommandType = CommandType.Text;
                //cmd.Parameters.Add("v_ma", NpgsqlDbType.Numeric).Value = v_ma;
                //cmd.Parameters.Add("v_computer", NpgsqlDbType.Varchar, 20).Value = v_computer;
                //dest = new NpgsqlDataAdapter(cmd);
                //m_ds = new DataSet();
                //dest.Fill(m_ds);
                //cmd.Dispose();
                //con.Dispose();
                //art = decimal.Parse(m_ds.Tables[0].Rows[0][0].ToString());
            }
            catch
            {
                art = 1;
            }
            return art;
        }
        private decimal get_v_capid(string v_table, int v_ma)
        {
            decimal art = 1;
            try
            {
                sql = "update " + m_db_schemaroot + "." + v_table + " set id=id+1 where ma=:v_ma";
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("v_ma", NpgsqlDbType.Numeric).Value = v_ma;
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + m_db_schemaroot + "." + v_table + "(ma,ten,id) values (:v_ma,:v_ten,1)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_ma", NpgsqlDbType.Numeric).Value = v_ma;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Varchar, 20).Value = "????";
                    cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
                con.Dispose();
                art = decimal.Parse(get_data("select id from " + m_db_schemaroot + "." + v_table + " where ma=" + v_ma).Tables[0].Rows[0][0].ToString());
            }
            catch
            {
                art = 1;
            }
            return art;
        }
        private decimal get_capid(decimal v_ma)
        {
            decimal art = 1;
            try
            {
                sql = "update " + m_db_schemaroot + ".capid set id=id+1 where ma=:v_ma";
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("v_ma", NpgsqlDbType.Numeric).Value = v_ma;
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + m_db_schemaroot + ".capid(ma,yy,loai,id,ngayud) values (:v_ma,'??','??',1,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_ma", NpgsqlDbType.Numeric).Value = v_ma;
                    cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
                con.Dispose();
                art = decimal.Parse(get_data("select id from " + m_db_schemaroot + ".capid where ma=" + v_ma).Tables[0].Rows[0][0].ToString());
            }
            catch
            {
                return art = 1;
            }
            return art;
        }
        //haison 30/05/2008
        private decimal get_capid_moi(int m_ma)
        {
            sql = "update " + user + ".d_capid" + s_dblink + " set id=id+1 where ma=:m_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            con.Open();
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;
            cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
            int irec = cmd.ExecuteNonQuery();
            cmd.Dispose();
            if (irec == 0)
            {
                sql = "insert into " + user + ".d_capid" + s_dblink + "(ma,ten,id,computer) values (:m_ma,:m_ten,1,:m_computer)";
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Varchar, 20).Value = m_computername;
                cmd.Parameters.Add("m_computer", NpgsqlDbType.Varchar, 20).Value = m_computername;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            sql = "select id from " + user + ".d_capid" + s_dblink + " where ma=" + m_ma;
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;
            dest = new NpgsqlDataAdapter(cmd);
            m_ds = new DataSet();
            dest.Fill(m_ds);
            cmd.Dispose();
            con.Close();
            con.Dispose();
            return decimal.Parse(m_ds.Tables[0].Rows[0][0].ToString());
        }

        public decimal get_id_v_quyenso { get { return get_v_capid(1); } }
        public decimal get_id_v_nhomdlogin
        {
            get
            {
                decimal art = 1;
                try
                {
                    decimal i = 0;
                    DataSet ads = get_data("select id from " + s_schemaroot + ".v_nhomdlogin" + s_dblink + " order by id asc");
                    while (i < 99999)
                    {
                        i++;
                        if (ads.Tables[0].Select("id=" + i.ToString()).Length <= 0)
                        {
                            break;
                        }
                    }
                    art = decimal.Parse(i.ToString());
                }
                catch
                {
                    art = 1;
                }
                return art;
            }
        }
        public decimal get_id_v_dlogin { get { return get_v_capid(4); } }
        public decimal get_id_bhytkb { get { return decimal.Parse(m_computerid.ToString() + get_v_capid_may(12, m_computername).ToString().PadLeft(9, '0')); } }
        public decimal get_id_v_vienphill { get { return decimal.Parse(m_computerid.ToString() + get_v_capid_may(5, m_computername).ToString().PadLeft(9, '0')); } }
        public decimal get_id_v_inbienlaitaichinhll { get { return decimal.Parse(m_computerid.ToString() + get_v_capid_may(5, m_computername).ToString().PadLeft(9, '0')); } }
        public decimal get_id_v_tamung { get { return decimal.Parse(m_computerid.ToString() + get_v_capid_may(6, m_computername).ToString().PadLeft(9, '0')); } }
        public decimal get_id_v_hoantra { get { return decimal.Parse(m_computerid.ToString() + get_v_capid_may(8, m_computername).ToString().PadLeft(9, '0')); } }
        public decimal get_id_v_chidinh { get { return decimal.Parse(m_computerid.ToString() + get_v_capid_may(9, m_computername).ToString().PadLeft(9, '0')); } }
        public decimal get_id_v_ttrvll { get { return decimal.Parse(m_computerid.ToString() + get_v_capid_may(10, m_computername).ToString().PadLeft(9, '0')); } }
        public decimal get_id_v_vpkhoa { get { return decimal.Parse(m_computerid.ToString() + get_v_capid_may(11, m_computername).ToString().PadLeft(9, '0')); } }
        public decimal get_id_v_phieuchi { get { return decimal.Parse(m_computerid.ToString() + get_v_capid_may(12, m_computername).ToString().PadLeft(9, '0')); } }
        public decimal get_id_v_thvp { get { return decimal.Parse(m_computerid.ToString() + get_v_capid_may(13, m_computername).ToString().PadLeft(9, '0')); } }
        public decimal get_id_v_dmghe
        {
            get
            {
                try
                {
                    return decimal.Parse(get_data("select max(id)+1 from v_dmghe").Tables[0].Rows[0][0].ToString());
                }
                catch
                {
                    return 1;
                }
            }
        }
        public decimal get_id_v_thutheonhom
        {
            get
            {
                try
                {
                    return decimal.Parse(get_data("select max(id)+1 from v_option_thutheonhom").Tables[0].Rows[0][0].ToString());
                }
                catch
                {
                    return 1;
                }
            }
        }
        public decimal get_id_v_bhyt { get { return decimal.Parse(m_computerid.ToString() + get_d_capid_may(12, m_computername).ToString().PadLeft(9, '0')); } }
        public decimal get_id_v_treebaocao
        {
            get
            {
                decimal art = 1;
                try
                {
                    decimal i = 0;
                    DataSet ads = get_data("select id from " + s_schemaroot + ".v_treebaocao order by id asc");
                    while (i < 999999999999)
                    {
                        i = i + 1;
                        if (ads.Tables[0].Select("id=" + i.ToString()).Length <= 0)
                        {
                            break;
                        }
                    }
                    art = decimal.Parse(i.ToString());
                }
                catch
                {
                    art = 1;
                }
                return art;
            }
        }
        public decimal get_id_v_lydomien
        {
            get
            {
                decimal art = 1;
                try
                {
                    int i = 0;
                    DataSet ads = get_data("select id from " + s_schemaroot + ".v_lydomien order by id asc");
                    while (i < 99)
                    {
                        i = i + 1;
                        if (ads.Tables[0].Select("id=" + i.ToString()).Length <= 0)
                        {
                            break;
                        }
                    }
                    art = decimal.Parse(i.ToString());
                }
                catch
                {
                    art = 1;
                }
                return art;
            }
        }
        public decimal get_id_v_dmlydonopthem
        {
            get
            {
                decimal art = 1;
                try
                {
                    int i = 0;
                    DataSet ads = get_data("select id from " + s_schemaroot + ".v_dmlydonopthem order by id asc");
                    while (i < 99)
                    {
                        i = i + 1;
                        if (ads.Tables[0].Select("id=" + i.ToString()).Length <= 0)
                        {
                            break;
                        }
                    }
                    art = decimal.Parse(i.ToString());
                }
                catch
                {
                    art = 1;
                }
                return art;
            }
        }
        public decimal get_id_v_dmlydothieu
        {
            get
            {
                decimal art = 1;
                try
                {
                    int i = 0;
                    DataSet ads = get_data("select id from " + s_schemaroot + ".v_dmlydothieu order by id asc");
                    while (i < 99)
                    {
                        i = i + 1;
                        if (ads.Tables[0].Select("id=" + i.ToString()).Length <= 0)
                        {
                            break;
                        }
                    }
                    art = decimal.Parse(i.ToString());
                }
                catch
                {
                    art = 1;
                }
                return art;
            }
        }
        public decimal get_id_v_loaibn
        {
            get
            {
                decimal art = 1;
                try
                {
                    decimal i = 0;
                    DataSet ads = get_data("select id from " + s_schemaroot + ".v_loaibn order by id asc");
                    while (i < 9)
                    {
                        i = i + 1;
                        if (ads.Tables[0].Select("id=" + i.ToString()).Length <= 0)
                        {
                            break;
                        }
                    }
                    art = decimal.Parse(i.ToString());
                }
                catch
                {
                    art = 1;
                }
                return art;
            }
        }
        public decimal get_id_v_tenloaivp
        {
            get
            {
                decimal art = 1;
                try
                {
                    int i = 0;
                    DataSet ads = get_data("select ma from " + s_schemaroot + ".v_tenloaivp order by ma asc");
                    while (i < 99)
                    {
                        i = i + 1;
                        if (ads.Tables[0].Select("ma=" + i.ToString()).Length <= 0)
                        {
                            break;
                        }
                    }
                    art = decimal.Parse(i.ToString());
                }
                catch
                {
                    art = 1;
                }
                return art;
            }
        }
        public decimal get_id_v_dsduyet
        {
            get
            {
                decimal art = 1;
                try
                {
                    int i = 0;
                    DataSet ads = get_data("select ma from " + s_schemaroot + ".v_dsduyet order by ma asc");
                    while (i < 9999)
                    {
                        i = i + 1;
                        if (ads.Tables[0].Select("ma=" + i.ToString()).Length <= 0)
                        {
                            break;
                        }
                    }
                    art = decimal.Parse(i.ToString());
                }
                catch
                {
                    art = 1;
                }
                return art;
            }
        }
        public decimal get_stt_v_nhombhyt
        {
            get
            {
                decimal art = 1;
                try
                {
                    decimal i = 0;
                    DataSet ads = get_data("select distinct stt from " + s_schemaroot + ".v_nhombhyt order by stt asc");
                    while (i < 99)
                    {
                        i = i + 1;
                        if (ads.Tables[0].Select("id=" + i.ToString()).Length <= 0)
                        {
                            break;
                        }
                    }
                    art = decimal.Parse(i.ToString());
                }
                catch
                {
                    art = 1;
                }
                return art;
            }
        }
        public decimal get_id_v_nhombhyt
        {
            get
            {
                decimal art = 1;
                try
                {
                    decimal i = 0;
                    DataSet ads = get_data("select id from " + s_schemaroot + ".v_nhombhyt order by id asc");
                    while (i < 99)
                    {
                        i = i + 1;
                        if (ads.Tables[0].Select("id=" + i.ToString()).Length <= 0)
                        {
                            break;
                        }
                    }
                    art = decimal.Parse(i.ToString());
                }
                catch
                {
                    art = 1;
                }
                return art;
            }
        }
        public decimal get_stt_v_nhomvp
        {
            get
            {
                decimal art = 1;
                try
                {
                    decimal i = 0;
                    DataSet ads = get_data("select distinct stt from " + s_schemaroot + ".v_nhomvp order by stt asc");
                    while (i < 999)
                    {
                        i = i + 1;
                        if (ads.Tables[0].Select("id=" + i.ToString()).Length <= 0)
                        {
                            break;
                        }
                    }
                    art = decimal.Parse(i.ToString());
                }
                catch
                {
                    art = 1;
                }
                return art;
            }
        }
        public decimal get_id_v_nhomvp
        {
            get
            {
                decimal art = 1;
                try
                {
                    decimal i = 0;
                    DataSet ads = get_data("select ma from " + s_schemaroot + ".v_nhomvp order by ma asc");
                    while (i < 999)
                    {
                        i = i + 1;
                        if (ads.Tables[0].Select("ma=" + i.ToString()).Length <= 0)
                        {
                            break;
                        }
                    }
                    art = decimal.Parse(i.ToString());
                }
                catch
                {
                    art = 1;
                }
                return art;
            }
        }
        public decimal get_stt_v_loaivp
        {
            get
            {
                decimal art = 1;
                try
                {
                    decimal i = 0;
                    DataSet ads = get_data("select distinct stt from " + s_schemaroot + ".v_loaivp order by stt asc");
                    while (i < 999)
                    {
                        i = i + 1;
                        if (ads.Tables[0].Select("id=" + i.ToString()).Length <= 0)
                        {
                            break;
                        }
                    }
                    art = decimal.Parse(i.ToString());
                }
                catch
                {
                    art = 1;
                }
                return art;
            }
        }
        public decimal f_get_stt_v_loaivp(string v_id_nhom)
        {
            try
            {
                decimal art = 1;
                try
                {
                    decimal i = 0;
                    DataSet ads = get_data("select distinct stt from " + s_schemaroot + ".v_loaivp where id_nhom=" + v_id_nhom + " order by stt asc");
                    while (i < 999)
                    {
                        i = i + 1;
                        if (ads.Tables[0].Select("id=" + i.ToString()).Length <= 0)
                        {
                            break;
                        }
                    }
                    art = decimal.Parse(i.ToString());
                }
                catch
                {
                    art = 1;
                }
                return art;
            }
            catch
            {
                return 1;
            }
        }
        public decimal get_id_v_loaivp
        {
            get
            {
                decimal art = 1;
                try
                {
                    decimal i = 0;
                    DataSet ads = get_data("select id from " + s_schemaroot + ".v_loaivp order by id asc");
                    while (i < 999)
                    {
                        i = i + 1;
                        if (ads.Tables[0].Select("id=" + i.ToString()).Length <= 0)
                        {
                            break;
                        }
                    }
                    art = decimal.Parse(i.ToString());
                }
                catch
                {
                    art = 1;
                }
                return art;
            }
        }

        public decimal get_id_v_giavp
        {
            get
            {
                return get_capid_moi(1);
            }
        }
        public decimal get_stt_v_giavp
        {
            get
            {
                decimal art = 1;
                try
                {
                    decimal i = 0;
                    DataSet ads = get_data("select distinct stt from " + s_schemaroot + ".v_giavp order by stt asc");
                    while (i < 9999999)
                    {
                        i = i + 1;
                        if (ads.Tables[0].Select("id=" + i.ToString()).Length <= 0)
                        {
                            break;
                        }
                    }
                    art = decimal.Parse(i.ToString());
                }
                catch
                {
                    art = 1;
                }
                return art;
            }
        }
        public decimal f_get_stt_v_giavp(string v_id_loai)
        {
            try
            {
                decimal art = 1;
                try
                {
                    decimal i = 0;
                    DataSet ads = get_data("select distinct stt from " + s_schemaroot + ".v_giavp" + s_dblink + " where id_loai=" + v_id_loai + " order by stt asc");
                    while (i < 9999999)
                    {
                        i = i + 1;
                        if (ads.Tables[0].Select("id=" + i.ToString()).Length <= 0)
                        {
                            break;
                        }
                    }
                    art = decimal.Parse(i.ToString());
                }
                catch
                {
                    art = 1;
                }
                return art;
            }
            catch
            {
                return 1;
            }
        }

        public decimal get_maql { get { return decimal.Parse(get_capid(1).ToString()); } }
        //cap maql moi
        public int getRandom()
        {
            Thread.Sleep(1);
            Random r = new Random();
            return r.Next(999);
        }

        public string getyymmddhhmiss()
        {
            return get_data("select to_char(now(),'yymmddhh24miss')").Tables[0].Rows[0][0].ToString();
        }

        public decimal getidyymmddhhmiss_stt_computer
        {
            get
            {
                return decimal.Parse(getyymmddhhmiss() + getRandom().ToString().PadLeft(3, '0') + m_computerid.ToString().PadLeft(3, '0'));
            }
        }
        //end


        #endregion CAPID

        #region KIỂM TRA DANH MỤC ĐÃ DÙNG
        public int dadung_v_dlogin(string v_id)
        {
            try
            {
                //if (get_data("select readonly from " + s_schemaroot + ".v_dlogin where id=" + v_id + " and readonly=1").Tables[0].Rows.Count > 0) return -1;
                if (get_data("select id from " + s_schemaroot + ".v_quyenso where userid=" + v_id + " limit 1").Tables[0].Rows.Count > 0) return 1;
                if (get_data("select id from " + s_schemaroot + ".v_nhomvp where userid=" + v_id + " limit 1").Tables[0].Rows.Count > 0) return 1;
                if (get_data("select id from " + s_schemaroot + ".v_loaivp where userid=" + v_id + " limit 1").Tables[0].Rows.Count > 0) return 1;
                if (get_data("select id from " + s_schemaroot + ".v_giavp where userid=" + v_id + " limit 1").Tables[0].Rows.Count > 0) return 1;
                foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
                {
                    if (get_data("select id from " + r["schamaname"].ToString() + ".v_vienphill where userid=" + v_id + " limit 1").Tables[0].Rows.Count > 0) return 1;
                    if (get_data("select id from " + r["schamaname"].ToString() + ".v_ttrvll where userid=" + v_id + " limit 1").Tables[0].Rows.Count > 0) return 1;
                    if (get_data("select id from " + r["schamaname"].ToString() + ".v_tamung where userid=" + v_id + " limit 1").Tables[0].Rows.Count > 0) return 1;
                    if (get_data("select id from " + r["schamaname"].ToString() + ".v_hoantra where userid=" + v_id + " limit 1").Tables[0].Rows.Count > 0) return 1;
                }
                return 0;
            }
            catch
            {
                return 0;
            }
        }
        public int dadung_v_nhomdlogin(string v_id)
        {
            try
            {
                if (get_data("select readonly from " + s_schemaroot + ".v_nhomdlogin where id=" + v_id + " and readonly=1 limit 1").Tables[0].Rows.Count > 0) return -1;
                if (get_data("select id from " + s_schemaroot + ".v_dlogin where id_nhom=" + v_id + " limit 1").Tables[0].Rows.Count > 0) return 1;
                return 0;
            }
            catch
            {
                return 0;
            }
        }
        public int dadung_v_treebaocao(string v_id)
        {
            try
            {
                if (get_data("select readonly from " + s_schemaroot + ".v_treebaocao where id=" + v_id + " and readonly=1 limit 1").Tables[0].Rows.Count > 0) return -1;
                if (get_data("select id from " + s_schemaroot + ".v_treebaocao where id_cha=" + v_id + " limit 1").Tables[0].Rows.Count > 0) return 1;
                return 0;
            }
            catch
            {
                return 0;
            }
        }
        public int dadung_v_quyenso(string v_id)
        {
            try
            {
                foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
                {
                    if (get_data("select id from " + r["schemaname"].ToString() + ".v_vienphill where quyenso=" + v_id + " limit 1").Tables[0].Rows.Count > 0) return 1;
                    if (get_data("select id from " + r["schemaname"].ToString() + ".v_ttrvll where quyenso=" + v_id + " limit 1").Tables[0].Rows.Count > 0) return 1;
                    if (get_data("select id from " + r["schemaname"].ToString() + ".v_tamung where quyenso=" + v_id + " limit 1").Tables[0].Rows.Count > 0) return 1;
                    if (get_data("select id from " + r["schemaname"].ToString() + ".v_phieuchill where quyenso=" + v_id + " limit 1").Tables[0].Rows.Count > 0) return 1;
                }
                return 0;
            }
            catch
            {
                return 0;
            }
        }
        public int dadung_v_dsduyet(string v_id)
        {
            try
            {
                if (get_data("select readonly from " + s_schemaroot + ".v_dsduyet where ma=" + v_id + " and readonly=1 limit 1").Tables[0].Rows.Count > 0) return -1;
                foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
                {
                    if (get_data("select maduyet from " + r["schamaname"].ToString() + ".v_mienngtru where maduyet=" + v_id + " limit 1").Tables[0].Rows.Count > 0) return 1;
                    if (get_data("select maduyet from " + r["schamaname"].ToString() + ".v_miennoitru where maduyet=" + v_id + " limit 1").Tables[0].Rows.Count > 0) return 1;
                }
                return 0;
            }
            catch
            {
                return 0;
            }
        }
        public int dadung_v_lydomien(string v_id)
        {
            try
            {
                if (get_data("select readonly from " + s_schemaroot + ".v_lydomien where id=" + v_id + " and readonly=1 limit 1").Tables[0].Rows.Count > 0) return -1;
                foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
                {
                    if (get_data("select lydo from " + r["schamaname"].ToString() + ".v_mienngtru where lydo=" + v_id + " limit 1").Tables[0].Rows.Count > 0) return 1;
                    if (get_data("select lydo from " + r["schamaname"].ToString() + ".v_miennoitru where lydo=" + v_id + " limit 1").Tables[0].Rows.Count > 0) return 1;
                }
                return 0;
            }
            catch
            {
                return 0;
            }
        }
        public int dadung_v_dmlydonopthem(string v_id)
        {
            try
            {
                if (get_data("select readonly from " + s_schemaroot + ".v_dmlydonopthem where id=" + v_id + " and readonly=1 limit 1").Tables[0].Rows.Count > 0) return -1;
                if (get_data("select id_lydo from " + s_schemaroot + ".v_lydonopthem where id_lydo=" + v_id + " limit 1").Tables[0].Rows.Count > 0) return 1;
                return 0;
            }
            catch
            {
                return 0;
            }
        }
        public int dadung_v_dmlydothieu(string v_id)
        {
            try
            {
                if (get_data("select readonly from " + s_schemaroot + ".v_dmlydothieu where id=" + v_id + " and readonly=1 limit 1").Tables[0].Rows.Count > 0) return -1;
                if (get_data("select id_lydo from " + s_schemaroot + ".v_lydothieu where id_lydo=" + v_id + " limit 1").Tables[0].Rows.Count > 0) return 1;
                return 0;
            }
            catch
            {
                return 0;
            }
        }
        public int dadung_v_loaibn(string v_id)
        {
            try
            {
                if (get_data("select readonly from " + s_schemaroot + ".v_loaibn where id=" + v_id + " and readonly=1 limit 1").Tables[0].Rows.Count > 0) return -1;
                foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
                {
                    if (get_data("select loai from " + r["schamaname"].ToString() + ".v_phieuchill where loaibn=" + v_id + " limit 1").Tables[0].Rows.Count > 0) return 1;
                    if (get_data("select loai from " + r["schamaname"].ToString() + ".v_vienphill where loaibn=" + v_id + " limit 1").Tables[0].Rows.Count > 0) return 1;
                    if (get_data("select loai from " + r["schamaname"].ToString() + ".v_ttrvll where loaibn=" + v_id + " limit 1").Tables[0].Rows.Count > 0) return 1;
                    if (get_data("select loai from " + r["schamaname"].ToString() + ".v_tamung where loaibn=" + v_id + " limit 1").Tables[0].Rows.Count > 0) return 1;
                }
                return 0;
            }
            catch
            {
                return 0;
            }
        }
        public int dadung_v_tenloaivp(string v_ma)
        {
            try
            {
                if (get_data("select readonly from " + s_schemaroot + ".v_tenloaivp where ma=" + v_ma + " and readonly=1 limit 1").Tables[0].Rows.Count > 0) return -1;
                foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
                {
                    if (get_data("select loai from " + r["schamaname"].ToString() + ".v_phieuchill where loai=" + v_ma + " limit 1").Tables[0].Rows.Count > 0) return 1;
                    if (get_data("select loai from " + r["schamaname"].ToString() + ".v_vienphill where loai=" + v_ma + " limit 1").Tables[0].Rows.Count > 0) return 1;
                    if (get_data("select loai from " + r["schamaname"].ToString() + ".v_ttrvll where loai=" + v_ma + " limit 1").Tables[0].Rows.Count > 0) return 1;
                    if (get_data("select loai from " + r["schamaname"].ToString() + ".v_tamung where loai=" + v_ma + " limit 1").Tables[0].Rows.Count > 0) return 1;
                }
                return 0;
            }
            catch
            {
                return 0;
            }
        }
        public int dadung_v_nhombhyt(string v_id)
        {
            try
            {
                if (get_data("select readonly from " + s_schemaroot + ".v_nhombhyt where id=" + v_id + " and readonly=1 limit 1").Tables[0].Rows.Count > 0) return -1;
                if (get_data("select idnhombhyt from " + s_schemaroot + ".v_nhomvp where idnhombhyt=" + v_id + " limit 1").Tables[0].Rows.Count > 0) return 1;
                return 0;
            }
            catch
            {
                return 0;
            }
        }
        public int dadung_v_giavp(string v_id)
        {
            try
            {
                if (get_data("select readonly from " + s_schemaroot + ".v_giavp" + s_dblink + " where id=" + v_id + " and readonly=1").Tables[0].Rows.Count > 0) return -1;
                foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
                {
                    if (get_data("select id from " + r["schemaname"].ToString() + ".v_vpkhoa" + s_dblink + " where mavp=" + v_id + " limit 1").Tables[0].Rows.Count > 0) return 1;
                    if (get_data("select id from " + r["schemaname"].ToString() + ".v_vienphict" + s_dblink + " where mavp=" + v_id + " limit 1 ").Tables[0].Rows.Count > 0) return 1;
                    if (get_data("select id from " + r["schemaname"].ToString() + ".v_ttrvct" + s_dblink + " where mavp=" + v_id + " limit 1").Tables[0].Rows.Count > 0) return 1;
                    if (get_data("select id from " + r["schemaname"].ToString() + ".v_chidinh" + s_dblink + " where mavp=" + v_id + " limit 1").Tables[0].Rows.Count > 0) return 1;
                }
                return 0;
            }
            catch
            {
                return 0;
            }
        }
        public int dadung_v_loaivp(string v_id)
        {
            try
            {
                if (get_data("select readonly from " + s_schemaroot + ".v_loaivp where id=" + v_id + " and readonly=1 limit 1").Tables[0].Rows.Count > 0) return -1;
                if (get_data("select id from " + s_schemaroot + ".v_giavp where id_loai=" + v_id + " limit 1").Tables[0].Rows.Count > 0) return 1;

                foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
                {
                    if (get_data("select id from " + r["schemaname"].ToString() + ".v_tamungct where loaivp=" + v_id + " limit 1").Tables[0].Rows.Count > 0) return 1;
                }
                return 0;
            }
            catch
            {
                return 0;
            }
        }
        public int dadung_v_nhomvp(string v_id)
        {
            try
            {
                if (get_data("select readonly from " + s_schemaroot + ".v_nhomvp" + s_dblink + " where ma=" + v_id + " and readonly=1 limit 1").Tables[0].Rows.Count > 0) return -1;
                if (get_data("select id from " + s_schemaroot + ".v_loaivp where" + s_dblink + " id_nhom=" + v_id + " limit 1").Tables[0].Rows.Count > 0) return 1;
                if (get_data("select id from " + s_schemaroot + ".d_dmnhom" + s_dblink + " where nhomvp=" + v_id + " limit 1").Tables[0].Rows.Count > 0) return 1;

                return 0;
            }
            catch
            {
                return 0;
            }
        }
        public decimal min_sobienlai(string v_quyensoid)
        {
            try
            {
                decimal amin = 0, atmp = 0;
                foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
                {
                    atmp = decimal.Parse(get_data("select min(sobienlai) sobienlai from (select min(sobienlai) sobienlai from " + r["schamaname"].ToString() + ".v_vienphill where quyenso=" + v_quyensoid + " and sobienlai>0 union all select min(sobienlai) sobienlai from " + r["schamaname"].ToString() + ".v_ttrvll where quyenso=" + v_quyensoid + " and sobienlai>0 union all select min(sobienlai) sobienlai from " + r["schamaname"].ToString() + ".v_tamung where quyenso=" + v_quyensoid + " and sobienlai>0)").Tables[0].Rows[0][0].ToString());
                    if (atmp < amin) amin = atmp;
                }
                return amin;
            }
            catch
            {
                return 0;
            }
        }
        public decimal max_sobienlai(string v_quyensoid)
        {
            try
            {
                decimal amax = 0, atmp = 0;
                foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
                {
                    atmp = decimal.Parse(get_data("select max(sobienlai) from (select max(sobienlai) sobienlai from " + r["schamaname"].ToString() + ".v_vienphill where quyenso=" + v_quyensoid + " and sobienlai>0 union all select max(sobienlai) sobienlai from " + r["schamaname"].ToString() + ".v_ttrvll where quyenso=" + v_quyensoid + " and sobienlai>0 union all select max(sobienlai) sobienlai from " + r["schamaname"].ToString() + ".v_tamung where quyenso=" + v_quyensoid + " and sobienlai>0)").Tables[0].Rows[0][0].ToString());
                    if (atmp > amax) amax = atmp;
                }
                return amax;
            }
            catch
            {
                return 0;
            }
        }
        public int dadung_v_vienphill(string v_mmyy, string v_id)
        {
            try
            {
                if (get_data_mmyy(v_mmyy, "select lanin from medibvmmyy.v_vienphill where lanin <> 0 and id=" + v_id + "").Tables[0].Rows.Count > 0) return 1;
                if (get_data_mmyy(v_mmyy, "select id from medibvmmyy.v_vienphict where lanin <> 0 and id=" + v_id + "").Tables[0].Rows.Count > 0) return 1;

                return 0;
            }
            catch
            {
                return 0;
            }
        }
        public int dadung_v_ttrvll(string v_mmyy, string v_id)
        {
            try
            {
                if (get_data_mmyy(v_mmyy, "select lanin from medibvmmyy.v_ttrvll where lanin <> 0 and id=" + v_id + "").Tables[0].Rows.Count > 0) return 1;

                return 0;
            }
            catch
            {
                return 0;
            }
        }
        public int dadung_v_tamung(string v_mmyy, string v_id)
        {
            try
            {
                if (get_data_mmyy(v_mmyy, "select lanin from medibvmmyy.v_tamung where lanin <> 0 and id=" + v_id + "").Tables[0].Rows.Count > 0) return 1;

                return 0;
            }
            catch
            {
                return 0;
            }
        }
        public int dadung_bhytkb(string v_mmyy, string v_id)
        {
            try
            {
                if (get_data_mmyy(v_mmyy, "select sotoa from medibvmmyy.bhytkb where sotoa <> 0 and id=" + v_id + "").Tables[0].Rows.Count > 0) return 1;

                return 0;
            }
            catch
            {
                return 0;
            }
        }

        #endregion KIỂM TRA DANH MỤC ĐÃ DÙNG

        #region CÁC HÀM THÔNG DỤNG

        public string f_kytuso(string v_so)
        {
            string ret = "", s1 = " 0123456789";
            try
            {
                for (int i = 0; i < v_so.Length; i++)
                    if (s1.IndexOf(v_so.Substring(i, 1)) != -1) ret += v_so.Substring(i, 1);
            }
            catch
            {
                ret = "";
            }
            return ret;
        }
        public string f_caps(string v_s)
        {
            string art = "";
            try
            {
                if (v_s.Length == 0) return null;
                System.Text.StringBuilder sb = new System.Text.StringBuilder(v_s.ToLower());
                sb[0] = Char.ToUpper(sb[0]);
                int num = 0; int ispace = 0;
                while (num < sb.Length)
                {
                    if (Char.IsWhiteSpace(sb[num])) ispace++;
                    if (!Char.IsWhiteSpace(sb[num]))
                    {
                        if (ispace > 0 && num > 0)
                        {
                            sb[num] = Char.ToUpper(sb[num]);
                            ispace = 0;
                        }
                    }
                    num++;
                }
                num = 0;
                ispace = 0;
                while (num < sb.Length)
                {
                    if (Char.IsWhiteSpace(sb[num]))
                    {
                        if (ispace < 1 && num > 0)
                        {
                            art += sb[num];
                        }
                        ispace++;
                    }
                    else
                    {
                        art += sb[num];
                        ispace = 0;
                    }
                    num++;
                }
            }
            catch
            {
                art = v_s;
            }
            return art;
        }
        public string f_writexml(string v_path, DataSet v_ds)
        {
            string art = v_path;
            try
            {
                v_ds.WriteXml(v_path, XmlWriteMode.WriteSchema);
            }
            catch
            {
                art = "";
            }
            return art;
        }
        public string f_write_option_history(string v_filename, string v_value)
        {
            string art = "..//..//option//" + v_filename;
            try
            {
                m_ds = new DataSet();
                m_ds.Tables.Add("table");
                m_ds.Tables[0].Columns.Add("val");
                m_ds.Tables[0].Rows.Add(new string[] { v_value });
                m_ds.WriteXml("..//..//option//" + v_filename, XmlWriteMode.WriteSchema);
            }
            catch
            {
                art = "";
            }
            return art;
        }
        public string f_get_option_history(string v_filename)
        {
            string art = "";
            try
            {
                m_ds = new DataSet();
                m_ds.ReadXml("..//..//option//" + v_filename);
                art = m_ds.Tables[0].Rows[0][0].ToString();
            }
            catch
            {
                art = "";
            }
            return art;
        }
        public string f_khongdau(string s)
        {
            try
            {
                m_ds = new DataSet();
                m_ds.ReadXml("..//..//..//xml//khongdau.xml");
                string s1 = s.Trim().ToUpper(), s2 = "";
                DataRow r;
                for (int i = 0; i < s1.Length; i++)
                {
                    if (s1[i].ToString().Trim() != "")
                    {
                        try
                        {
                            r = m_ds.Tables[0].Select("codau='" + s1[i].ToString() + "'")[0];
                        }
                        catch
                        {
                            r = null;
                        }

                        if (r != null) s2 += r[1].ToString();
                        else s2 += s1[i];
                    }
                }
                return s2;
            }
            catch
            {
                return "";
            }
        }

        #endregion CÁC HÀM THÔNG DỤNG

        #region BIẾN TOÀN CỤC
        public int s_loaibn_tiepdon
        {
            get
            {
                return 0;
            }
        }
        public int s_loaibn_noitru
        {
            get
            {
                return 1;
            }
        }
        public int s_loaibn_ngoaitru
        {
            get
            {
                return 2;
            }
        }
        public int s_loaibn_phongkham
        {
            get
            {
                return 3;
            }
        }
        public int s_loaibn_phongluu
        {
            get
            {
                return 4;
            }
        }
        public bool s_bienlainoitru_inchitiet
        {
            get
            {
                return false;
            }
        }
        public string s_diachi
        {
            get
            {
                string art = "";
                try
                {
                    XmlDocument doc = new XmlDocument();
                    doc.Load("..//..//..//xml//maincode.xml");
                    XmlNodeList nodeLst = doc.GetElementsByTagName("Diachi");
                    art = nodeLst.Item(0).InnerText;
                }
                catch
                {
                    art = "";
                }
                return art;
            }
        }
        public string s_masothue
        {
            get
            {
                return "";
            }
        }
        public string s_maubienlai
        {
            get
            {
                return "";
            }
        }
        public bool is_dba_admin(string v_userid)
        {
            try
            {
                return get_data("select a.id from medibv.v_dlogin" + s_dblink + " a left join medibv.v_nhomdlogin" + s_dblink + " b on a.id_nhom=b.id where a.id=" + v_userid + " and b.nhom=1").Tables[0].Rows.Count > 0;
            }
            catch
            {
                return false;
            }
        }
        public bool is_app_admin(string v_userid)
        {
            try
            {
                return get_data("select a.id from medibv.v_dlogin a left join medibv.v_nhomdlogin b on a.id_nhom=b.id where a.id=" + v_userid + " and b.nhom in(1,2)").Tables[0].Rows.Count > 0;
            }
            catch
            {
                return false;
            }
        }
        public bool is_dep_admin(string v_userid)
        {
            try
            {
                return get_data("select a.id from medibv.v_dlogin a left join medibv.v_nhomdlogin b on a.id_nhom=b.id where a.id=" + v_userid + " and b.nhom=3").Tables[0].Rows.Count > 0;
            }
            catch
            {
                return false;
            }
        }
        public bool is_admin(string v_userid)
        {
            try
            {
                return get_data("select a.id from medibv.v_dlogin a left join medibv.v_nhomdlogin b on a.id_nhom=b.id where a.id=" + v_userid + " and b.nhom in(1,2,3)").Tables[0].Rows.Count > 0;
            }
            catch
            {
                return false;
            }
        }
        #endregion

        #region THÔNG SỐ HỆ THỐNG

        public string f_thongso_soyte
        {
            get
            {
                string art = "";
                try
                {
                    art = get_data("select giatri from " + s_schemaroot + ".v_systhongso where ma = ''").Tables[0].Rows[0][0].ToString();
                }
                catch
                {
                    art = "";
                }
                return art;
            }
        }
        public string f_thongso_benhvien
        {
            get
            {
                string art = "";
                try
                {
                    art = get_data("select giatri from " + s_schemaroot + ".v_systhongso where ma = ''").Tables[0].Rows[0][0].ToString();
                }
                catch
                {
                    art = "";
                }
                return art;
            }
        }

        #endregion THÔNG SỐ HỆ THỐNG

        #region CẬP NHẬT DATA TABLES
        //New
        public bool upd_dmcomputer(string m_computer)
        {
            string aid = "1";
            try
            {
                aid = get_data("select max(id)+1 from " + m_db_schemaroot + ".dmcomputer").Tables[0].Rows[0][0].ToString();
            }
            catch
            {
                aid = "1";
            }
            sql = "update " + m_db_schemaroot + ".dmcomputer set computer=:m_computer where computer=:m_computer";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;
            cmd.Parameters.Add("m_computer", NpgsqlDbType.Varchar, 20).Value = m_computer;
            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    if (aid == "") aid = "1";
                    sql = "insert into " + m_db_schemaroot + ".dmcomputer(id,computer,ngayud) values (" + aid + ",:m_computer,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_computer", NpgsqlDbType.Varchar, 20).Value = m_computer;
                    cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_v_error(ex.Message, m_computername, "dmcomputer");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_dmcomputer()
        {
            return upd_dmcomputer(m_computername);
        }
        public void upd_table()
        {
            try
            {
                DataSet ads = get_data("select trim(mmyy) as mmyy from " + s_schemaroot + ".table");
                foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
                {
                    string atmp = r["schemaname"].ToString();
                    if (ads.Tables[0].Select("mmyy='" + r["schemaname"].ToString().Trim().Replace(s_schemaroot, "") + "'").Length < 0)
                    {
                        execute_data("insert into " + s_schemaroot + ".table (mmyy,userid,ngayud,computer) values('" + r["schemaname"].ToString().Replace(s_schemaroot, "") + "',1,now(),'" + m_computername + "')");
                    }
                }
            }
            catch
            {
            }
        }
        public bool upd_v_option(string v_ma, string v_giatri)
        {
            sql = "update " + m_db_schemaroot + ".v_option set giatri=:v_giatri where ma=:v_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_ma", NpgsqlDbType.Text).Value = v_ma;
            cmd.Parameters.Add("v_giatri", NpgsqlDbType.Text).Value = v_giatri;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + m_db_schemaroot + ".v_option(ma, giatri) values(:v_ma, :v_giatri)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_ma", NpgsqlDbType.Text).Value = v_ma;
                    cmd.Parameters.Add("v_giatri", NpgsqlDbType.Text).Value = v_giatri;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_option");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_v_treebaocao(decimal v_id, decimal v_id_cha, decimal v_stt, string v_ten, string sql, string v_tenreport, decimal v_readonly)
        {
            sql = "update " + m_db_schemaroot + ".v_treebaocao set id_cha=:v_id_cha, stt=:v_stt,ten=:v_ten, sql=:sql,tenreport=:v_tenreport, readonly=:v_readonly where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_id_cha", NpgsqlDbType.Numeric).Value = v_id_cha;
            cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
            cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
            cmd.Parameters.Add("sql", NpgsqlDbType.Text).Value = sql;
            cmd.Parameters.Add("v_tenreport", NpgsqlDbType.Text).Value = v_tenreport;
            cmd.Parameters.Add("v_readonly", NpgsqlDbType.Numeric).Value = v_readonly;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + m_db_schemaroot + ".v_treebaocao(id,id_cha,stt,ten,sql,tenreport,readonly) values(:v_id,:v_id_cha,:v_stt,:v_ten,:sql,:v_tenreport,:v_readonly)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_id_cha", NpgsqlDbType.Numeric).Value = v_id_cha;
                    cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
                    cmd.Parameters.Add("sql", NpgsqlDbType.Text).Value = sql;
                    cmd.Parameters.Add("v_tenreport", NpgsqlDbType.Text).Value = v_tenreport;
                    cmd.Parameters.Add("v_readonly", NpgsqlDbType.Numeric).Value = v_readonly;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_treebaocao");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public void upd_v_error(string v_message, string v_computer, string v_table)
        {
            sql = "insert into " + s_schemaroot + ".v_error(message,computer,tables,ngayud) values (:v_message,:v_computer,:v_table,now())";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_message", NpgsqlDbType.Varchar, 254).Value = v_message;
            cmd.Parameters.Add("v_computer", NpgsqlDbType.Varchar, 20).Value = v_computer;
            cmd.Parameters.Add("v_table", NpgsqlDbType.Varchar, 20).Value = v_table;
            try
            {
                con.Open();
                cmd.ExecuteNonQuery();
            }
            catch { }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
        }
        public void upd_v_error_client(string v_message, string v_computer, string v_table, string stendatabase)
        {
            sql = "insert into " + s_schemaroot + ".v_error" + stendatabase + "(message,computer,tables,ngayud) values (:v_message,:v_computer,:v_table,now())";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_message", NpgsqlDbType.Varchar, 254).Value = v_message;
            cmd.Parameters.Add("v_computer", NpgsqlDbType.Varchar, 20).Value = v_computer;
            cmd.Parameters.Add("v_table", NpgsqlDbType.Varchar, 20).Value = v_table;
            try
            {
                con.Open();
                cmd.ExecuteNonQuery();
            }
            catch { }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
        }
        public void upd_v_error(string v_mmyy, string m_message, string m_computer, string m_table)
        {
            sql = "insert into " + s_schema_mmyy(v_mmyy) + ".v_error(message,computer,tables,ngayud) values (:m_message,:m_computer,:m_table,now())";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("m_message", NpgsqlDbType.Varchar, 254).Value = m_message;
            cmd.Parameters.Add("m_computer", NpgsqlDbType.Varchar, 20).Value = m_computer;
            cmd.Parameters.Add("m_table", NpgsqlDbType.Varchar, 20).Value = m_table;
            try
            {
                con.Open();
                cmd.ExecuteNonQuery();
            }
            catch { }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
        }
        public bool upd_v_phanquyen(decimal v_userid, string v_menuname, decimal v_chon, string v_chitiet)
        {
            sql = "update " + m_db_schemaroot + ".v_phanquyen set chon=:v_chon, chitiet=:v_chitiet where userid=:v_userid and menuname=:v_menuname";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
            cmd.Parameters.Add("v_menuname", NpgsqlDbType.Text).Value = v_menuname;
            cmd.Parameters.Add("v_chon", NpgsqlDbType.Numeric).Value = v_chon;
            cmd.Parameters.Add("v_chitiet", NpgsqlDbType.Text).Value = v_chitiet;
            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + m_db_schemaroot + ".v_phanquyen(userid,menuname,chon,chitiet) values (:v_userid,:v_menuname,:v_chon,:v_chitiet)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                    cmd.Parameters.Add("v_menuname", NpgsqlDbType.Text).Value = v_menuname;
                    cmd.Parameters.Add("v_chon", NpgsqlDbType.Numeric).Value = v_chon;
                    cmd.Parameters.Add("v_chitiet", NpgsqlDbType.Text).Value = v_chitiet;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_v_error(ex.Message, m_computername, "v_phanquyen");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_v_phanquyennhom(decimal v_id_nhom, string v_menuname, decimal v_chon, string v_chitiet)
        {
            sql = "update " + m_db_schemaroot + ".v_phanquyennhom set chon=:v_chon, chitiet=:v_chitiet where id_nhom=:v_id_nhom and menuname=:v_menuname";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id_nhom", NpgsqlDbType.Numeric).Value = v_id_nhom;
            cmd.Parameters.Add("v_menuname", NpgsqlDbType.Text).Value = v_menuname;
            cmd.Parameters.Add("v_chon", NpgsqlDbType.Numeric).Value = v_chon;
            cmd.Parameters.Add("v_chitiet", NpgsqlDbType.Text).Value = v_chitiet;
            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + m_db_schemaroot + ".v_phanquyennhom(id_nhom,menuname,chon,chitiet) values (:v_id_nhom,:v_menuname,:v_chon,:v_chitiet)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id_nhom", NpgsqlDbType.Numeric).Value = v_id_nhom;
                    cmd.Parameters.Add("v_menuname", NpgsqlDbType.Text).Value = v_menuname;
                    cmd.Parameters.Add("v_chon", NpgsqlDbType.Numeric).Value = v_chon;
                    cmd.Parameters.Add("v_chitiet", NpgsqlDbType.Text).Value = v_chitiet;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_v_error(ex.Message, m_computername, "v_phanquyennhom");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_v_viettat(decimal v_stt, string v_ma, string v_ten, decimal v_readonly)
        {
            sql = "update " + m_db_schemaroot + ".v_viettat set stt=:v_stt,ten=:v_ten, readonly=:v_readonly where ma=:v_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
            cmd.Parameters.Add("v_ma", NpgsqlDbType.Text).Value = v_ma;
            cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
            cmd.Parameters.Add("v_readonly", NpgsqlDbType.Numeric).Value = v_readonly;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + m_db_schemaroot + ".v_viettat(stt,ma,ten,readonly) values(:v_stt,:v_ma,:v_ten,:v_readonly)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
                    cmd.Parameters.Add("v_ma", NpgsqlDbType.Text).Value = v_ma;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
                    cmd.Parameters.Add("v_readonly", NpgsqlDbType.Numeric).Value = v_readonly;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_viettat");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public string Viettat(string matat)
        {
            try
            {
                sql = "select daydu from medibv.btdvt where trim(matat)=:matat";
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("matat", NpgsqlDbType.Text).Value = matat.Trim().ToLower();
                dest = new NpgsqlDataAdapter(cmd);
                m_ds = new DataSet();
                dest.Fill(m_ds);
                cmd.Dispose();
                con.Close(); con.Dispose();
                return m_ds.Tables[0].Rows[0][0].ToString();
            }
            catch { return ""; }
        }
        //New
        public bool upd_v_bhyt(string v_mmyy, decimal v_id, string v_sothe, decimal v_maphu, string v_mabv, string v_noigioithieu)
        {
            sql = "update " + s_schemaroot + v_mmyy + ".v_bhyt set sothe=:v_sothe, maphu=:v_maphu, mabv=:v_mabv, noigioithieu=:v_noigioithieu where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_sothe", NpgsqlDbType.Varchar, 16).Value = v_sothe;
            cmd.Parameters.Add("v_maphu", NpgsqlDbType.Numeric).Value = v_maphu;
            cmd.Parameters.Add("v_mabv", NpgsqlDbType.Varchar, 8).Value = v_mabv;
            cmd.Parameters.Add("v_noigioithieu", NpgsqlDbType.Varchar, 8).Value = v_noigioithieu;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schema_mmyy(v_mmyy) + ".v_bhyt(id,sothe,maphu,mabv,noigioithieu) values(:v_id,:v_sothe,:v_maphu,:v_mabv,:v_noigioithieu)";
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_sothe", NpgsqlDbType.Varchar, 16).Value = v_sothe;
                    cmd.Parameters.Add("v_maphu", NpgsqlDbType.Numeric).Value = v_maphu;
                    cmd.Parameters.Add("v_mabv", NpgsqlDbType.Varchar, 8).Value = v_mabv;
                    cmd.Parameters.Add("v_noigioithieu", NpgsqlDbType.Varchar, 8).Value = v_noigioithieu;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(v_mmyy, ex.Message, m_computername, "v_bhyt");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_v_bhyt(string v_mmyy, decimal v_id, decimal v_maql)
        {
            string v_sothe = "", v_ngay = "", v_mabv = "", v_noigioithieu = "";
            int v_maphu = 0;
            try
            {
                m_ds = get_data("select sothe,to_char(denngay,'dd/mm/yyyy hh24:mi') denngay,mabv,maphu from " + s_schema_mmyy(v_mmyy) + ".bhyt where maql=" + v_maql);
                v_sothe = m_ds.Tables[0].Rows[0]["sothe"].ToString().Trim();
                v_ngay = m_ds.Tables[0].Rows[0]["denngay"].ToString().Trim();
                v_mabv = m_ds.Tables[0].Rows[0]["mabv"].ToString().Trim();
                v_noigioithieu = v_mabv;
                v_maphu = int.Parse(m_ds.Tables[0].Rows[0]["maphu"].ToString().Trim());
            }
            catch
            {
                return false;
            }
            return upd_v_bhyt(v_mmyy, v_id, v_sothe, v_maphu, v_mabv, v_noigioithieu);
        }
        public bool upd_v_chidinh(string v_mmyy, decimal v_id, string v_mabn, decimal v_mavaovien, decimal v_maql, decimal v_idkhoa, string v_ngay, decimal v_loai, string v_makp, decimal v_madoituong, decimal v_mavp, decimal v_soluong, decimal v_dongia, decimal v_userid)
        {
            sql = "update " + s_schema_mmyy(v_mmyy) + ".v_chidinh set mabn=:v_mabn, mavaovien=:v_mavaovien, maql=:v_maql, idkhoa=:v_idkhoa, ngay=to_date(:v_ngay,'dd/mm/yyyy hh24:mi'), loai=:v_loai, makp=:v_makp, madoituong=:v_madoituong,mavp=:v_mavp,soluong=:v_soluong, dongia=:v_dongia,userid=:v_userid where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
            cmd.Parameters.Add("v_mavaovien", NpgsqlDbType.Numeric).Value = v_mavaovien;
            cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
            cmd.Parameters.Add("v_idkhoa", NpgsqlDbType.Numeric).Value = v_idkhoa;
            cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 16).Value = v_ngay;
            cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
            cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar,i_maxlength_makp).Value = v_makp;
            cmd.Parameters.Add("v_madoituong", NpgsqlDbType.Numeric).Value = v_madoituong;
            cmd.Parameters.Add("v_mavp", NpgsqlDbType.Numeric).Value = v_mavp;
            cmd.Parameters.Add("v_soluong", NpgsqlDbType.Numeric).Value = v_soluong;
            cmd.Parameters.Add("v_dongia", NpgsqlDbType.Numeric).Value = v_dongia;
            cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schema_mmyy(v_mmyy) + ".v_chidinh(id,mabn,mavaovien,maql,idkhoa,ngay,loai,makp,madoituong,mavp,soluong,dongia,userid,ngayud) values(:v_id,:v_mabn,:v_mavaovien,:v_maql,:v_idkhoa,to_date(:v_ngay,'dd/mm/yyyy hh24:mi'),:v_loai,:v_makp,:v_madoituong,:v_mavp,:v_soluong,:v_dongia,:v_userid,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
                    cmd.Parameters.Add("v_mavaovien", NpgsqlDbType.Numeric).Value = v_mavaovien;
                    cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
                    cmd.Parameters.Add("v_idkhoa", NpgsqlDbType.Numeric).Value = v_idkhoa;
                    cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 16).Value = v_ngay;
                    cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
                    cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar,i_maxlength_makp).Value = v_makp;
                    cmd.Parameters.Add("v_madoituong", NpgsqlDbType.Numeric).Value = v_madoituong;
                    cmd.Parameters.Add("v_mavp", NpgsqlDbType.Numeric).Value = v_mavp;
                    cmd.Parameters.Add("v_soluong", NpgsqlDbType.Numeric).Value = v_soluong;
                    cmd.Parameters.Add("v_dongia", NpgsqlDbType.Numeric).Value = v_dongia;
                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(v_mmyy, ex.Message, m_computername, "v_chidinh");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_v_chidinh_tt(string v_mmyy, decimal v_id, string v_mabn, decimal v_mavaovien, decimal v_maql, decimal v_idkhoa, string v_ngay, int v_loai, string v_makp, int v_madoituong, int v_mavp, decimal v_soluong, decimal v_dongia, decimal v_paid, decimal v_vattu, int v_userid, int v_tinhtrang, int v_thuchien, int v_hide, int v_done, decimal v_idttrv)
        {
            sql = "update " + s_schema_mmyy(v_mmyy) + ".v_chidinh set mabn=:v_mabn,mavaovien=:v_mavaovien,maql=:v_maql,idkhoa=:v_idkhoa,ngay=to_timestamp(:v_ngay,'dd/mm/yyyy hh24:mi'),loai=:v_loai,makp=:v_makp,madoituong=:v_madoituong,mavp=:v_mavp,soluong=:v_soluong,dongia=:v_dongia,paid=:v_paid,vattu=:v_vattu,userid=:v_userid,tinhtrang=:v_tinhtrang,thuchien=:v_thuchien,computer=:v_computer,hide=:v_hide,done=:v_done,idttrv=:v_idttrv where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
                cmd.Parameters.Add("v_mavaovien", NpgsqlDbType.Numeric).Value = v_mavaovien;
                cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
                cmd.Parameters.Add("v_idkhoa", NpgsqlDbType.Numeric).Value = v_idkhoa;
                cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 16).Value = v_ngay;
                cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
                cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = v_makp;
                cmd.Parameters.Add("v_madoituong", NpgsqlDbType.Numeric).Value = v_madoituong;
                cmd.Parameters.Add("v_mavp", NpgsqlDbType.Numeric).Value = v_mavp;
                cmd.Parameters.Add("v_soluong", NpgsqlDbType.Numeric).Value = v_soluong;
                cmd.Parameters.Add("v_dongia", NpgsqlDbType.Numeric).Value = v_dongia;
                cmd.Parameters.Add("v_paid", NpgsqlDbType.Numeric).Value = v_paid;
                cmd.Parameters.Add("v_vattu", NpgsqlDbType.Numeric).Value = v_vattu;
                cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                cmd.Parameters.Add("v_tinhtrang", NpgsqlDbType.Numeric).Value = v_tinhtrang;
                cmd.Parameters.Add("v_thuchien", NpgsqlDbType.Numeric).Value = v_thuchien;
                cmd.Parameters.Add("v_computer", NpgsqlDbType.Varchar, 20).Value = m_computername;
                cmd.Parameters.Add("v_hide", NpgsqlDbType.Numeric).Value = v_hide;
                cmd.Parameters.Add("v_done", NpgsqlDbType.Numeric).Value = v_done;
                cmd.Parameters.Add("v_idttrv", NpgsqlDbType.Numeric).Value = v_idttrv;

                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schema_mmyy(v_mmyy) + ".v_chidinh(id,mabn,mavaovien,maql,idkhoa,ngay,loai,makp,madoituong,mavp,soluong,dongia,paid,vattu,userid,tinhtrang,thuchien,computer,hide,done,idttrv) values (:v_id,:v_mabn,:v_mavaovien,:v_maql,:v_idkhoa,to_timestamp(:v_ngay,'dd/mm/yyyy hh24:mi'),:v_loai,:v_makp,:v_madoituong,:v_mavp,:v_soluong,:v_dongia,:v_paid,:v_vattu,:v_userid,:v_tinhtrang,:v_thuchien,:v_computer,:v_hide,:v_done,:v_idttrv)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
                    cmd.Parameters.Add("v_mavaovien", NpgsqlDbType.Numeric).Value = v_mavaovien;
                    cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
                    cmd.Parameters.Add("v_idkhoa", NpgsqlDbType.Numeric).Value = v_idkhoa;
                    cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 16).Value = v_ngay;
                    cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
                    cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar,i_maxlength_makp).Value = v_makp;
                    cmd.Parameters.Add("v_madoituong", NpgsqlDbType.Numeric).Value = v_madoituong;
                    cmd.Parameters.Add("v_mavp", NpgsqlDbType.Numeric).Value = v_mavp;
                    cmd.Parameters.Add("v_soluong", NpgsqlDbType.Numeric).Value = v_soluong;
                    cmd.Parameters.Add("v_dongia", NpgsqlDbType.Numeric).Value = v_dongia;
                    cmd.Parameters.Add("v_paid", NpgsqlDbType.Numeric).Value = v_paid;
                    cmd.Parameters.Add("v_vattu", NpgsqlDbType.Numeric).Value = v_vattu;
                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                    cmd.Parameters.Add("v_tinhtrang", NpgsqlDbType.Numeric).Value = v_tinhtrang;
                    cmd.Parameters.Add("v_thuchien", NpgsqlDbType.Numeric).Value = v_thuchien;
                    cmd.Parameters.Add("v_computer", NpgsqlDbType.Varchar, 20).Value = m_computername;
                    cmd.Parameters.Add("v_hide", NpgsqlDbType.Numeric).Value = v_hide;
                    cmd.Parameters.Add("v_done", NpgsqlDbType.Numeric).Value = v_done;
                    cmd.Parameters.Add("v_idttrv", NpgsqlDbType.Numeric).Value = v_idttrv;

                    cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_v_error(v_ngay, ex.Message, m_computername, "v_chidinh");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }
        public bool upd_v_congno(string v_mmyy, string v_mabn, decimal v_maql, decimal v_idkhoa, decimal v_mavp, decimal v_sotien, decimal v_dathu)
        {
            sql = "update " + s_schema_mmyy(v_mmyy) + ".v_congno set maql=:v_maql, idkhoa=:v_idkhoa, sotien=:v_sotien, dathu=:v_dathu where mabn=:v_mabn and mavp=:v_mavp";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
            cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
            cmd.Parameters.Add("v_idkhoa", NpgsqlDbType.Numeric).Value = v_idkhoa;
            cmd.Parameters.Add("v_mavp", NpgsqlDbType.Numeric).Value = v_mavp;
            cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
            cmd.Parameters.Add("v_dathu", NpgsqlDbType.Numeric).Value = v_dathu;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schema_mmyy(v_mmyy) + ".v_congno(mabn,maql,idkhoa,mavp,sotien,dathu) values(:v_mabn,:v_maql,:v_idkhoa,:v_mavp,:v_sotien,:v_dathu)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
                    cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
                    cmd.Parameters.Add("v_idkhoa", NpgsqlDbType.Numeric).Value = v_idkhoa;
                    cmd.Parameters.Add("v_mavp", NpgsqlDbType.Numeric).Value = v_mavp;
                    cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
                    cmd.Parameters.Add("v_dathu", NpgsqlDbType.Numeric).Value = v_dathu;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(v_mmyy, ex.Message, m_computername, "v_congno");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;

        }
        public string upd_v_hoantra(string v_mmyy, decimal v_id, decimal v_quyenso, decimal v_sobienlai, string v_ngay10, string v_ngaythu10, string v_mabn, decimal v_mavaovien, decimal v_maql, string v_hoten, string v_makp, decimal v_sotien, string v_ghichu, decimal v_userid, decimal v_loai, decimal v_loaibn)
        {
            if (v_id == 0)
            {
                v_id = get_id_v_hoantra;
            }
            if (v_mmyy == "")
            {
                v_mmyy = get_mmyy(v_ngay10);
            }
            sql = "update " + s_schema_mmyy(v_mmyy) + ".v_hoantra set quyenso=:v_quyenso, sobienlai=:v_sobienlai, ngay=to_date(:v_ngay,'dd/mm/yyyy'), mabn=:v_mabn, mavaovien=:v_mavaovien, maql=:v_maql, hoten=:v_hoten, makp=:v_makp,sotien=:v_sotien,ghichu=:v_ghichu, userid=:v_userid, loai=:v_loai, loaibn=:v_loaibn,ngayud=to_date(:v_ngaythu,'dd/mm/yyyy') where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_quyenso", NpgsqlDbType.Numeric).Value = v_quyenso;
            cmd.Parameters.Add("v_sobienlai", NpgsqlDbType.Numeric).Value = v_sobienlai;
            cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 10).Value = v_ngay10;
            cmd.Parameters.Add("v_ngaythu", NpgsqlDbType.Varchar, 10).Value = v_ngaythu10;
            cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
            cmd.Parameters.Add("v_mavaovien", NpgsqlDbType.Numeric).Value = v_mavaovien;
            cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
            cmd.Parameters.Add("v_hoten", NpgsqlDbType.Text).Value = v_hoten;
            cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = v_makp;
            cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
            cmd.Parameters.Add("v_ghichu", NpgsqlDbType.Text).Value = v_ghichu;
            cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
            cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
            cmd.Parameters.Add("v_loaibn", NpgsqlDbType.Numeric).Value = v_loaibn;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schema_mmyy(v_mmyy) + ".v_hoantra(id,quyenso,sobienlai,ngay,mabn,mavaovien,maql,hoten,makp,sotien,ghichu,userid,loai,loaibn,ngayud) values(:v_id,:v_quyenso,:v_sobienlai,to_date(:v_ngay,'dd/mm/yyyy'),:v_mabn,:v_mavaovien,:v_maql,:v_hoten,:v_makp,:v_sotien,:v_ghichu,:v_userid,:v_loai,:v_loaibn,to_date(:v_ngaythu,'dd/mm/yyyy'))";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_quyenso", NpgsqlDbType.Numeric).Value = v_quyenso;
                    cmd.Parameters.Add("v_sobienlai", NpgsqlDbType.Numeric).Value = v_sobienlai;
                    cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 10).Value = v_ngay10;
                    cmd.Parameters.Add("v_ngaythu", NpgsqlDbType.Varchar, 10).Value = v_ngaythu10;
                    cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
                    cmd.Parameters.Add("v_mavaovien", NpgsqlDbType.Numeric).Value = v_mavaovien;
                    cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
                    cmd.Parameters.Add("v_hoten", NpgsqlDbType.Text).Value = v_hoten;
                    cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = v_makp;
                    cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
                    cmd.Parameters.Add("v_ghichu", NpgsqlDbType.Text).Value = v_ghichu;
                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                    cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
                    cmd.Parameters.Add("v_loaibn", NpgsqlDbType.Numeric).Value = v_loaibn;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(v_mmyy, ex.Message, m_computername, "v_hoantra");
                v_id = 0;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return v_id.ToString();
        }
        public bool upd_v_hoantract(string v_mmyy, decimal v_id, decimal v_loaivp, decimal v_sotien)
        {
            sql = "update " + s_schema_mmyy(v_mmyy) + ".v_hoantract set sotien=:v_sotien where id=:v_id and loaivp=:v_loaivp";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_loaivp", NpgsqlDbType.Numeric).Value = v_loaivp;
            cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schema_mmyy(v_mmyy) + ".v_hoantract(id,loaivp,sotien) values(:v_id,:v_loaivp,:v_sotien)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_loaivp", NpgsqlDbType.Numeric).Value = v_loaivp;
                    cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(v_mmyy, ex.Message, m_computername, "v_hoantract");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_v_mienngtru(string v_mmyy, decimal v_id, decimal v_lydo, decimal v_sotien, string v_ghichu, decimal v_maduyet)
        {
            sql = "update " + s_schema_mmyy(v_mmyy) + ".v_mienngtru set lydo=:v_lydo,sotien=:v_sotien, ghichu=:v_ghichu, maduyet=:v_maduyet where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_lydo", NpgsqlDbType.Numeric).Value = v_lydo;
            cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
            cmd.Parameters.Add("v_ghichu", NpgsqlDbType.Text, 100).Value = v_ghichu;
            cmd.Parameters.Add("v_maduyet", NpgsqlDbType.Numeric).Value = v_maduyet;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schema_mmyy(v_mmyy) + ".v_mienngtru(id,lydo,sotien,ghichu,maduyet) values(:v_id,:v_lydo,:v_sotien,:v_ghichu,:v_maduyet)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_lydo", NpgsqlDbType.Numeric).Value = v_lydo;
                    cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
                    cmd.Parameters.Add("v_ghichu", NpgsqlDbType.Text, 100).Value = v_ghichu;
                    cmd.Parameters.Add("v_maduyet", NpgsqlDbType.Numeric).Value = v_maduyet;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(v_mmyy, ex.Message, m_computername, "v_mienngtru");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_v_miennoitru(string v_mmyy, decimal v_id, decimal v_lydo, string v_ghichu, decimal v_maduyet)
        {
            sql = "update " + s_schema_mmyy(v_mmyy) + ".v_miennoitru set lydo=:v_lydo,ghichu=:v_ghichu, maduyet=:v_maduyet where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_lydo", NpgsqlDbType.Numeric).Value = v_lydo;
            cmd.Parameters.Add("v_ghichu", NpgsqlDbType.Text, 100).Value = v_ghichu;
            cmd.Parameters.Add("v_maduyet", NpgsqlDbType.Numeric).Value = v_maduyet;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schema_mmyy(v_mmyy) + ".v_miennoitru(id,lydo,ghichu,maduyet) values(:v_id,:v_lydo,:v_ghichu,:v_maduyet)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_lydo", NpgsqlDbType.Numeric).Value = v_lydo;
                    cmd.Parameters.Add("v_ghichu", NpgsqlDbType.Text, 100).Value = v_ghichu;
                    cmd.Parameters.Add("v_maduyet", NpgsqlDbType.Numeric).Value = v_maduyet;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(v_mmyy, ex.Message, m_computername, "v_miennoitru");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public string upd_v_phieuchill(string v_mmyy, decimal v_id, decimal v_quyenso, decimal v_sobienlai, string v_ngay10, string v_mabn, decimal v_maql, decimal v_idkhoa, string v_makp, string v_hoten, decimal v_loai, decimal v_loaibn, decimal v_userid)
        {
            if (v_id == 0)
            {
                v_id = get_id_v_phieuchi;
            }
            if (v_mmyy == "")
            {
                v_mmyy = get_mmyy(v_ngay10);
            }
            sql = "update " + s_schema_mmyy(v_mmyy) + ".v_phieuchill set quyenso=:v_quyenso,sobienlai=:v_sobienlai, ngay=to_date(:v_ngay,'dd/mm/yyyy'), mabn=:v_mabn,maql=:v_maql,idkhoa=:v_idkhoa,makp=:v_makp,hoten=:v_hoten, loai=:v_loai,loaibn=:v_loaibn,userid=:v_userid where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_quyenso", NpgsqlDbType.Numeric).Value = v_quyenso;
            cmd.Parameters.Add("v_sobienlai", NpgsqlDbType.Numeric).Value = v_sobienlai;
            cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 10).Value = v_ngay10;
            cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
            cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
            cmd.Parameters.Add("v_idkhoa", NpgsqlDbType.Numeric).Value = v_idkhoa;
            cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = v_makp;
            cmd.Parameters.Add("v_hoten", NpgsqlDbType.Text, 50).Value = v_hoten;
            cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
            cmd.Parameters.Add("v_loaibn", NpgsqlDbType.Numeric).Value = v_loaibn;
            cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schema_mmyy(v_mmyy) + ".v_phieuchill(id,quyenso,sobienlai,ngay,mabn,maql,idkhoa,makp,hoten,loai,loaibn,userid) values(:v_id,:v_quyenso,:v_sobienlai,to_date(:v_ngay,'dd/mm/yyyy'),:v_mabn,:v_maql,:v_idkhoa,:v_makp,:v_hoten,:v_loai,:v_loaibn,:v_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_quyenso", NpgsqlDbType.Numeric).Value = v_quyenso;
                    cmd.Parameters.Add("v_sobienlai", NpgsqlDbType.Numeric).Value = v_sobienlai;
                    cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 10).Value = v_ngay10;
                    cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
                    cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
                    cmd.Parameters.Add("v_idkhoa", NpgsqlDbType.Numeric).Value = v_idkhoa;
                    cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = v_makp;
                    cmd.Parameters.Add("v_hoten", NpgsqlDbType.Text, 50).Value = v_hoten;
                    cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
                    cmd.Parameters.Add("v_loaibn", NpgsqlDbType.Numeric).Value = v_loaibn;
                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(v_mmyy, ex.Message, m_computername, "v_phieuchill");
                v_id = 0;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return v_id.ToString();
        }
        public string upd_v_phieuchict(string v_mmyy, decimal v_id, decimal v_stt, decimal v_mavp, decimal v_sotien)
        {
            sql = "update " + s_schema_mmyy(v_mmyy) + ".v_phieuchict set mavp=:v_mavp,sotien=:v_sotien where id=:v_id and stt=:v_stt";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
            cmd.Parameters.Add("v_mavp", NpgsqlDbType.Numeric).Value = v_mavp;
            cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schema_mmyy(v_mmyy) + ".v_phieuchict(id,stt,mavp,sotien) values(:v_id,:v_stt,:v_mavp,:v_sotien)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
                    cmd.Parameters.Add("v_mavp", NpgsqlDbType.Numeric).Value = v_mavp;
                    cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(v_mmyy, ex.Message, m_computername, "v_phieuchict");
                v_id = 0;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return v_id.ToString();
        }
        public string upd_v_tamung(string v_mmyy, decimal v_id, string v_mabn, decimal v_mavaovien, decimal v_maql, decimal v_idkhoa, decimal v_quyenso, decimal v_sobienlai, string v_ngay10, decimal v_loai, string v_makp, decimal v_madoituong, decimal v_loaibn, decimal v_sotien, decimal v_userid)
        {
            if (v_id == 0)
            {
                v_id = decimal.Parse(getidyymmddhhmiss_stt_computer.ToString());
            }
            if (v_mmyy == "")
            {
                v_mmyy = get_mmyy(v_ngay10.Substring(0, 10));
            }
            sql = "update " + s_schema_mmyy(v_mmyy) + ".v_tamung set mabn=:v_mabn,mavaovien=:v_mavaovien,maql=:v_maql,idkhoa=:v_idkhoa,quyenso=:v_quyenso,sobienlai=:v_sobienlai,ngay=to_date(:v_ngay,'dd/mm/yyyy hh24:mi'),loai=:v_loai, makp=:v_makp,madoituong=:v_madoituong,sotien=:v_sotien,loaibn=:v_loaibn,userid=:v_userid where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
            cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
            cmd.Parameters.Add("v_mavaovien", NpgsqlDbType.Numeric).Value = v_mavaovien;
            cmd.Parameters.Add("v_idkhoa", NpgsqlDbType.Numeric).Value = v_idkhoa;
            cmd.Parameters.Add("v_quyenso", NpgsqlDbType.Numeric).Value = v_quyenso;
            cmd.Parameters.Add("v_sobienlai", NpgsqlDbType.Numeric).Value = v_sobienlai;
            cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 16).Value = v_ngay10;
            cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
            cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = v_makp;
            cmd.Parameters.Add("v_madoituong", NpgsqlDbType.Numeric).Value = v_madoituong;
            cmd.Parameters.Add("v_loaibn", NpgsqlDbType.Numeric).Value = v_loaibn;
            cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
            cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schema_mmyy(v_mmyy) + ".v_tamung(id,mabn,mavaovien,maql,idkhoa,quyenso,sobienlai,ngay,loai,makp,madoituong,loaibn,sotien,userid) values(:v_id,:v_mabn,:v_mavaovien,:v_maql,:v_idkhoa,:v_quyenso,:v_sobienlai,to_date(:v_ngay,'dd/mm/yyyy hh24:mi'),:v_loai,:v_makp,:v_madoituong,:v_loaibn,:v_sotien,:v_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
                    cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
                    cmd.Parameters.Add("v_mavaovien", NpgsqlDbType.Numeric).Value = v_mavaovien;
                    cmd.Parameters.Add("v_idkhoa", NpgsqlDbType.Numeric).Value = v_idkhoa;
                    cmd.Parameters.Add("v_quyenso", NpgsqlDbType.Numeric).Value = v_quyenso;
                    cmd.Parameters.Add("v_sobienlai", NpgsqlDbType.Numeric).Value = v_sobienlai;
                    cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 16).Value = v_ngay10;
                    cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
                    cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, 2).Value = v_makp;
                    cmd.Parameters.Add("v_madoituong", NpgsqlDbType.Numeric).Value = v_madoituong;
                    cmd.Parameters.Add("v_loaibn", NpgsqlDbType.Numeric).Value = v_loaibn;
                    cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(v_mmyy, ex.Message, m_computername, "v_tamung");
                v_id = 0;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return v_id.ToString();
        }
        public string upd_v_tamung(decimal v_id, string v_mabn, decimal v_mavaovien, decimal v_maql, decimal v_idkhoa, decimal v_quyenso, decimal v_sobienlai, string v_ngay10, decimal v_loai, string v_makp, decimal v_madoituong, decimal v_loaibn, decimal v_sotien, decimal v_userid)
        {
            if (v_id == 0)
            {
                v_id = decimal.Parse(getidyymmddhhmiss_stt_computer.ToString());
            }
            sql = "update "+user+".v_tamung set mabn=:v_mabn,mavaovien=:v_mavaovien,maql=:v_maql,idkhoa=:v_idkhoa,quyenso=:v_quyenso,sobienlai=:v_sobienlai,ngay=to_date(:v_ngay,'dd/mm/yyyy hh24:mi'),loai=:v_loai, makp=:v_makp,madoituong=:v_madoituong,sotien=:v_sotien,loaibn=:v_loaibn,userid=:v_userid where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
            cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
            cmd.Parameters.Add("v_mavaovien", NpgsqlDbType.Numeric).Value = v_mavaovien;
            cmd.Parameters.Add("v_idkhoa", NpgsqlDbType.Numeric).Value = v_idkhoa;
            cmd.Parameters.Add("v_quyenso", NpgsqlDbType.Numeric).Value = v_quyenso;
            cmd.Parameters.Add("v_sobienlai", NpgsqlDbType.Numeric).Value = v_sobienlai;
            cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 16).Value = v_ngay10;
            cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
            cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, i_maxlength_makp).Value = v_makp;
            cmd.Parameters.Add("v_madoituong", NpgsqlDbType.Numeric).Value = v_madoituong;
            cmd.Parameters.Add("v_loaibn", NpgsqlDbType.Numeric).Value = v_loaibn;
            cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
            cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".v_tamung(id,mabn,mavaovien,maql,idkhoa,quyenso,sobienlai,ngay,loai,makp,madoituong,loaibn,sotien,userid,useridtt,ngaytt) values(:v_id,:v_mabn,:v_mavaovien,:v_maql,:v_idkhoa,:v_quyenso,:v_sobienlai,to_date(:v_ngay,'dd/mm/yyyy hh24:mi'),:v_loai,:v_makp,:v_madoituong,:v_loaibn,:v_sotien,:v_userid,0,null)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
                    cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
                    cmd.Parameters.Add("v_mavaovien", NpgsqlDbType.Numeric).Value = v_mavaovien;
                    cmd.Parameters.Add("v_idkhoa", NpgsqlDbType.Numeric).Value = v_idkhoa;
                    cmd.Parameters.Add("v_quyenso", NpgsqlDbType.Numeric).Value = v_quyenso;
                    cmd.Parameters.Add("v_sobienlai", NpgsqlDbType.Numeric).Value = v_sobienlai;
                    cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 16).Value = v_ngay10;
                    cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
                    cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, 2).Value = v_makp;
                    cmd.Parameters.Add("v_madoituong", NpgsqlDbType.Numeric).Value = v_madoituong;
                    cmd.Parameters.Add("v_loaibn", NpgsqlDbType.Numeric).Value = v_loaibn;
                    cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_tamung");
                v_id = 0;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return v_id.ToString();
        }
        public bool upd_v_tamungct(string v_mmyy, decimal v_id, decimal v_loaivp, decimal v_sotien)
        {
            sql = "update " + s_schema_mmyy(v_mmyy) + ".v_tamungct set sotien=:v_sotien where id=:v_id and loaivp=:v_loaivp";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_loaivp", NpgsqlDbType.Numeric).Value = v_loaivp;
            cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schema_mmyy(v_mmyy) + ".v_tamungct(id,loaivp,sotien) values(:v_id,:v_loaivp,:v_sotien)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_loaivp", NpgsqlDbType.Numeric).Value = v_loaivp;
                    cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(v_mmyy, ex.Message, m_computername, "v_tamungct");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public string upd_v_ttrvll(string v_mmyy, decimal v_id, decimal v_loaibn, decimal v_loai, decimal v_quyenso,
            decimal v_sobienlai, string v_ngay10, string v_makp, decimal v_sotien, decimal v_tamung, decimal v_mien,
            decimal v_bhyt, decimal v_thieu, decimal v_nopthem, decimal v_chenhlech, decimal v_vattu, decimal v_thua,
            decimal v_idtonghop, decimal v_userid, decimal v_quyensodv, decimal v_sobienlaidv, int v_chinhsach, int v_madoituong, decimal v_miengdduyet)//Thuy 15.12.2012 them field mien giam doc duyet
        {
            if (v_id == 0)
            {
                return "0";
            }
            if (v_mmyy == "")
            {
                v_mmyy = get_mmyy(v_ngay10.Substring(0, 10));
            }
            s_dblink = s_dblink == "" ? "" : "@" + s_dblink.Trim('@');
            sql = "update " + s_schema_mmyy(v_mmyy) + ".v_ttrvll" + s_dblink + " set loaibn=:v_loaibn, loai=:v_loai,quyenso=:v_quyenso,";
            sql += "sobienlai=:v_sobienlai,ngay=to_date(:v_ngay,'dd/mm/yyyy hh24:mi'), makp=:v_makp,sotien=:v_sotien,";
            sql += "tamung=:v_tamung,mien=:v_mien,bhyt=:v_bhyt, thieu=:v_thieu, nopthem=:v_nopthem, chenhlech=:v_chenhlech,";
            sql += "thua=:v_thua, vattu=:v_vattu, idtonghop=:v_idtonghop, userid=:v_userid,quyensodv=" + v_quyensodv +
                ",sobienlaidv=" + v_sobienlaidv + ",chinhsach=:v_chinhsach,madoituong=:v_madoituong,mien_gdduyet=:v_miengdduyet where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;


            cmd.Parameters.Add("v_loaibn", NpgsqlDbType.Numeric).Value = v_loaibn;
            cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
            cmd.Parameters.Add("v_quyenso", NpgsqlDbType.Numeric).Value = v_quyenso;
            cmd.Parameters.Add("v_sobienlai", NpgsqlDbType.Numeric).Value = v_sobienlai;
            cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 16).Value = v_ngay10;
            cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, 2).Value = v_makp;
            cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
            cmd.Parameters.Add("v_tamung", NpgsqlDbType.Numeric).Value = v_tamung;
            cmd.Parameters.Add("v_mien", NpgsqlDbType.Numeric).Value = v_mien;
            cmd.Parameters.Add("v_bhyt", NpgsqlDbType.Numeric).Value = v_bhyt;
            cmd.Parameters.Add("v_thieu", NpgsqlDbType.Numeric).Value = v_thieu;
            cmd.Parameters.Add("v_nopthem", NpgsqlDbType.Numeric).Value = v_nopthem;
            cmd.Parameters.Add("v_chenhlech", NpgsqlDbType.Numeric).Value = v_chenhlech;
            cmd.Parameters.Add("v_thua", NpgsqlDbType.Numeric).Value = v_thua;
            cmd.Parameters.Add("v_vattu", NpgsqlDbType.Numeric).Value = v_vattu;
            cmd.Parameters.Add("v_idtonghop", NpgsqlDbType.Numeric).Value = v_idtonghop;
            cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
            cmd.Parameters.Add("v_chinhsach", NpgsqlDbType.Numeric).Value = v_chinhsach;
            cmd.Parameters.Add("v_madoituong", NpgsqlDbType.Numeric).Value = v_madoituong;
            cmd.Parameters.Add("v_miengdduyet", NpgsqlDbType.Numeric).Value = v_miengdduyet;
            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schema_mmyy(v_mmyy) + ".v_ttrvll" + s_dblink + "(id,loaibn,loai,quyenso,sobienlai,ngay,makp,sotien,";
                    sql += "tamung,mien,bhyt,thieu,nopthem,chenhlech,thua,vattu,idtonghop,userid,quyensodv,sobienlaidv,chinhsach,madoituong,mien_gdduyet) ";
                    sql += " values(:v_id,:v_loaibn,:v_loai,:v_quyenso,:v_sobienlai,to_date(:v_ngay,'dd/mm/yyyy hh24:mi'),";
                    sql += ":v_makp,:v_sotien,:v_tamung,:v_mien,:v_bhyt,:v_thieu,:v_nopthem,:v_chenhlech,:v_thua,:v_vattu,";
                    sql += ":v_idtonghop,:v_userid," + v_quyensodv + "," + v_sobienlaidv + ",:v_chinhsach,:v_madoituong,:v_miengdduyet)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_loaibn", NpgsqlDbType.Numeric).Value = v_loaibn;
                    cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
                    cmd.Parameters.Add("v_quyenso", NpgsqlDbType.Numeric).Value = v_quyenso;
                    cmd.Parameters.Add("v_sobienlai", NpgsqlDbType.Numeric).Value = v_sobienlai;
                    cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 16).Value = v_ngay10;
                    cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, 2).Value = v_makp;
                    cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
                    cmd.Parameters.Add("v_tamung", NpgsqlDbType.Numeric).Value = v_tamung;
                    cmd.Parameters.Add("v_mien", NpgsqlDbType.Numeric).Value = v_mien;
                    cmd.Parameters.Add("v_bhyt", NpgsqlDbType.Numeric).Value = v_bhyt;
                    cmd.Parameters.Add("v_thieu", NpgsqlDbType.Numeric).Value = v_thieu;
                    cmd.Parameters.Add("v_nopthem", NpgsqlDbType.Numeric).Value = v_nopthem;
                    cmd.Parameters.Add("v_chenhlech", NpgsqlDbType.Numeric).Value = v_chenhlech;
                    cmd.Parameters.Add("v_thua", NpgsqlDbType.Numeric).Value = v_thua;
                    cmd.Parameters.Add("v_vattu", NpgsqlDbType.Numeric).Value = v_vattu;
                    cmd.Parameters.Add("v_idtonghop", NpgsqlDbType.Numeric).Value = v_idtonghop;
                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                    cmd.Parameters.Add("v_chinhsach", NpgsqlDbType.Numeric).Value = v_chinhsach;
                    cmd.Parameters.Add("v_madoituong", NpgsqlDbType.Numeric).Value = v_madoituong;
                    cmd.Parameters.Add("v_miengdduyet", NpgsqlDbType.Numeric).Value = v_miengdduyet;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(v_mmyy, ex.Message, m_computername, "v_ttrvll");
                v_id = 0;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return v_id.ToString();
        }
        public string upd_v_ttrvll(string v_mmyy, decimal v_id, decimal v_loaibn, decimal v_loai, decimal v_quyenso,
            decimal v_sobienlai, string v_ngay10, string v_makp, decimal v_sotien, decimal v_tamung, decimal v_mien,
            decimal v_bhyt, decimal v_thieu, decimal v_nopthem, decimal v_chenhlech, decimal v_vattu, decimal v_thua,
            decimal v_idtonghop, decimal v_userid, decimal v_quyensodv, decimal v_sobienlaidv,int v_chinhsach, int v_madoituong)
        {
            if (v_id == 0)
            {
                return "0";
            }
            if (v_mmyy == "")
            {
                v_mmyy = get_mmyy(v_ngay10.Substring(0, 10));
            }
            s_dblink = s_dblink == "" ? "" : "@" + s_dblink.Trim('@');
            sql = "update " + s_schema_mmyy(v_mmyy) + ".v_ttrvll" + s_dblink + " set loaibn=:v_loaibn, loai=:v_loai,quyenso=:v_quyenso,";
            sql += "sobienlai=:v_sobienlai,ngay=to_date(:v_ngay,'dd/mm/yyyy hh24:mi'), makp=:v_makp,sotien=:v_sotien,";
            sql += "tamung=:v_tamung,mien=:v_mien,bhyt=:v_bhyt, thieu=:v_thieu, nopthem=:v_nopthem, chenhlech=:v_chenhlech,";
            sql += "thua=:v_thua, vattu=:v_vattu, idtonghop=:v_idtonghop, userid=:v_userid,quyensodv=" + v_quyensodv + 
                ",sobienlaidv=" + v_sobienlaidv + ",chinhsach=:v_chinhsach,madoituong=:v_madoituong where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            
            cmd.Parameters.Add("v_loaibn", NpgsqlDbType.Numeric).Value = v_loaibn;
            cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
            cmd.Parameters.Add("v_quyenso", NpgsqlDbType.Numeric).Value = v_quyenso;
            cmd.Parameters.Add("v_sobienlai", NpgsqlDbType.Numeric).Value = v_sobienlai;
            cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 16).Value = v_ngay10;
            cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, 2).Value = v_makp;
            cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
            cmd.Parameters.Add("v_tamung", NpgsqlDbType.Numeric).Value = v_tamung;
            cmd.Parameters.Add("v_mien", NpgsqlDbType.Numeric).Value = v_mien;
            cmd.Parameters.Add("v_bhyt", NpgsqlDbType.Numeric).Value = v_bhyt;
            cmd.Parameters.Add("v_thieu", NpgsqlDbType.Numeric).Value = v_thieu;
            cmd.Parameters.Add("v_nopthem", NpgsqlDbType.Numeric).Value = v_nopthem;
            cmd.Parameters.Add("v_chenhlech", NpgsqlDbType.Numeric).Value = v_chenhlech;
            cmd.Parameters.Add("v_thua", NpgsqlDbType.Numeric).Value = v_thua;
            cmd.Parameters.Add("v_vattu", NpgsqlDbType.Numeric).Value = v_vattu;
            cmd.Parameters.Add("v_idtonghop", NpgsqlDbType.Numeric).Value = v_idtonghop;
            cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
            cmd.Parameters.Add("v_chinhsach", NpgsqlDbType.Numeric).Value = v_chinhsach;
            cmd.Parameters.Add("v_madoituong", NpgsqlDbType.Numeric).Value = v_madoituong;
            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schema_mmyy(v_mmyy) + ".v_ttrvll" + s_dblink + "(id,loaibn,loai,quyenso,sobienlai,ngay,makp,sotien,";
                    sql += "tamung,mien,bhyt,thieu,nopthem,chenhlech,thua,vattu,idtonghop,userid,quyensodv,sobienlaidv,chinhsach,madoituong) ";
                    sql += " values(:v_id,:v_loaibn,:v_loai,:v_quyenso,:v_sobienlai,to_date(:v_ngay,'dd/mm/yyyy hh24:mi'),";
                    sql += ":v_makp,:v_sotien,:v_tamung,:v_mien,:v_bhyt,:v_thieu,:v_nopthem,:v_chenhlech,:v_thua,:v_vattu,";
                    sql += ":v_idtonghop,:v_userid," + v_quyensodv + "," + v_sobienlaidv + ",:v_chinhsach,:v_madoituong)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_loaibn", NpgsqlDbType.Numeric).Value = v_loaibn;
                    cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
                    cmd.Parameters.Add("v_quyenso", NpgsqlDbType.Numeric).Value = v_quyenso;
                    cmd.Parameters.Add("v_sobienlai", NpgsqlDbType.Numeric).Value = v_sobienlai;
                    cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 16).Value = v_ngay10;
                    cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, 2).Value = v_makp;
                    cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
                    cmd.Parameters.Add("v_tamung", NpgsqlDbType.Numeric).Value = v_tamung;
                    cmd.Parameters.Add("v_mien", NpgsqlDbType.Numeric).Value = v_mien;
                    cmd.Parameters.Add("v_bhyt", NpgsqlDbType.Numeric).Value = v_bhyt;
                    cmd.Parameters.Add("v_thieu", NpgsqlDbType.Numeric).Value = v_thieu;
                    cmd.Parameters.Add("v_nopthem", NpgsqlDbType.Numeric).Value = v_nopthem;
                    cmd.Parameters.Add("v_chenhlech", NpgsqlDbType.Numeric).Value = v_chenhlech;
                    cmd.Parameters.Add("v_thua", NpgsqlDbType.Numeric).Value = v_thua;
                    cmd.Parameters.Add("v_vattu", NpgsqlDbType.Numeric).Value = v_vattu;
                    cmd.Parameters.Add("v_idtonghop", NpgsqlDbType.Numeric).Value = v_idtonghop;
                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                    cmd.Parameters.Add("v_chinhsach", NpgsqlDbType.Numeric).Value = v_chinhsach;
                    cmd.Parameters.Add("v_madoituong", NpgsqlDbType.Numeric).Value = v_madoituong;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(v_mmyy, ex.Message, m_computername, "v_ttrvll");
                v_id = 0;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return v_id.ToString();
        }

        public bool upd_v_ttrvct(string table, string v_mmyy, decimal v_id, decimal v_stt, string v_ngay10,
             string v_makp, decimal v_madoituong, decimal v_mavp, decimal v_soluong, decimal v_dongia,
             decimal v_vat, decimal v_vattu, decimal v_sotien, decimal v_giamua, decimal v_bhyttra,
             decimal v_gia_bh, string v_mabs, decimal v_idtonghop, int v_stttonghop)
        {
            s_dblink = s_dblink == "" ? "" : "@" + s_dblink.Trim('@');
            sql = "update " + s_schema_mmyy(v_mmyy) + "." + table + s_dblink + " set ngay=to_date(:v_ngay,'dd/mm/yyyy'),";
            sql += "makp=:v_makp,madoituong=:v_madoituong,mavp=:v_mavp,soluong=:v_soluong, dongia=:v_dongia,";
            sql += "vat=:v_vat, vattu=:v_vattu, sotien=:v_sotien,giamua=:v_giamua,bhyttra=:v_bhyttra,gia_bh=" + v_gia_bh;
            sql += ",mabs=:v_mabs ";
            sql += ", idtonghop=" + v_idtonghop + ", sttduyet=" + v_stttonghop;
            sql += " where id=:v_id and stt=:v_stt";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 10).Value = v_ngay10;
            cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, 2).Value = v_makp;
            cmd.Parameters.Add("v_madoituong", NpgsqlDbType.Numeric).Value = v_madoituong;
            cmd.Parameters.Add("v_mavp", NpgsqlDbType.Numeric).Value = v_mavp;
            cmd.Parameters.Add("v_soluong", NpgsqlDbType.Numeric).Value = v_soluong;
            cmd.Parameters.Add("v_dongia", NpgsqlDbType.Numeric).Value = v_dongia;
            cmd.Parameters.Add("v_vat", NpgsqlDbType.Numeric).Value = v_vat;
            cmd.Parameters.Add("v_vattu", NpgsqlDbType.Numeric).Value = v_vattu;
            cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
            cmd.Parameters.Add("v_giamua", NpgsqlDbType.Numeric).Value = v_giamua;
            cmd.Parameters.Add("v_bhyttra", NpgsqlDbType.Numeric).Value = v_bhyttra;
            cmd.Parameters.Add("v_mabs", NpgsqlDbType.Varchar, 4).Value = v_mabs;
            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schema_mmyy(v_mmyy) + "." + table + s_dblink +
                        "(id,stt,ngay,makp,madoituong,mavp,soluong,dongia,vat,vattu,sotien,giamua," +
                        "bhyttra,gia_bh,mabs,idtonghop, sttduyet) values(:v_id,:v_stt,to_date(:v_ngay,'dd/mm/yyyy'),:v_makp," +
                        ":v_madoituong,:v_mavp,:v_soluong,:v_dongia,:v_vat,:v_vattu,:v_sotien,:v_giamua," +
                        ":v_bhyttra," + v_gia_bh + ",:v_mabs," + v_idtonghop + "," + v_stttonghop + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
                    cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 10).Value = v_ngay10;
                    cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, 2).Value = v_makp;
                    cmd.Parameters.Add("v_madoituong", NpgsqlDbType.Numeric).Value = v_madoituong;
                    cmd.Parameters.Add("v_mavp", NpgsqlDbType.Numeric).Value = v_mavp;
                    cmd.Parameters.Add("v_soluong", NpgsqlDbType.Numeric).Value = v_soluong;
                    cmd.Parameters.Add("v_dongia", NpgsqlDbType.Numeric).Value = v_dongia;
                    cmd.Parameters.Add("v_vat", NpgsqlDbType.Numeric).Value = v_vat;
                    cmd.Parameters.Add("v_vattu", NpgsqlDbType.Numeric).Value = v_vattu;
                    cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
                    cmd.Parameters.Add("v_giamua", NpgsqlDbType.Numeric).Value = v_giamua;
                    cmd.Parameters.Add("v_bhyttra", NpgsqlDbType.Numeric).Value = v_bhyttra;
                    cmd.Parameters.Add("v_mabs", NpgsqlDbType.Varchar, 4).Value = v_mabs;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(v_mmyy, ex.Message, m_computername, table);
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }



        public bool upd_v_ttrvct(string table, string v_mmyy, decimal v_id, decimal v_stt, string v_ngay10,
            string v_makp, decimal v_madoituong, decimal v_mavp, decimal v_soluong, decimal v_dongia,
            decimal v_vat, decimal v_vattu, decimal v_sotien, decimal v_giamua, decimal v_bhyttra,
            decimal v_gia_bh, decimal v_mien, string v_mabs, decimal v_idtonghop, int v_stttonghop)
        {
            s_dblink = s_dblink == "" ? "" : "@" + s_dblink.Trim('@');
            sql = "update " + s_schema_mmyy(v_mmyy) + "." + table + s_dblink + " set ngay=to_date(:v_ngay,'dd/mm/yyyy'),";
            sql += "makp=:v_makp,madoituong=:v_madoituong,mavp=:v_mavp,soluong=:v_soluong, dongia=:v_dongia,";
            sql += "vat=:v_vat, vattu=:v_vattu, sotien=:v_sotien,giamua=:v_giamua,bhyttra=:v_bhyttra,gia_bh=" + v_gia_bh;
            sql += " , mien=:v_mien, mabs=:v_mabs";
            sql += ", idtonghop=" + v_idtonghop + ", sttduyet=" + v_stttonghop;
            sql += " where id=:v_id and stt=:v_stt";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 10).Value = v_ngay10;
            cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, 2).Value = v_makp;
            cmd.Parameters.Add("v_madoituong", NpgsqlDbType.Numeric).Value = v_madoituong;
            cmd.Parameters.Add("v_mavp", NpgsqlDbType.Numeric).Value = v_mavp;
            cmd.Parameters.Add("v_soluong", NpgsqlDbType.Numeric).Value = v_soluong;
            cmd.Parameters.Add("v_dongia", NpgsqlDbType.Numeric).Value = v_dongia;
            cmd.Parameters.Add("v_vat", NpgsqlDbType.Numeric).Value = v_vat;
            cmd.Parameters.Add("v_vattu", NpgsqlDbType.Numeric).Value = v_vattu;
            cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
            cmd.Parameters.Add("v_giamua", NpgsqlDbType.Numeric).Value = v_giamua;
            cmd.Parameters.Add("v_bhyttra", NpgsqlDbType.Numeric).Value = v_bhyttra;
            cmd.Parameters.Add("v_mien", NpgsqlDbType.Numeric).Value = v_mien;
            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
            cmd.Parameters.Add("v_mabs", NpgsqlDbType.Varchar, 4).Value = v_mabs;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schema_mmyy(v_mmyy) + "." + table + s_dblink + "(id,stt,ngay,makp,madoituong,mavp,soluong,dongia,vat,vattu,sotien,giamua,bhyttra,gia_bh,mien,mabs, idtonghop, sttduyet) ";
                    sql += " values(:v_id,:v_stt,to_date(:v_ngay,'dd/mm/yyyy'),:v_makp,:v_madoituong,:v_mavp,:v_soluong,:v_dongia,:v_vat,:v_vattu,:v_sotien,:v_giamua,:v_bhyttra," + v_gia_bh + ",:v_mien,:v_mabs," + v_idtonghop + "," + v_stttonghop + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
                    cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 10).Value = v_ngay10;
                    cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, 2).Value = v_makp;
                    cmd.Parameters.Add("v_madoituong", NpgsqlDbType.Numeric).Value = v_madoituong;
                    cmd.Parameters.Add("v_mavp", NpgsqlDbType.Numeric).Value = v_mavp;
                    cmd.Parameters.Add("v_soluong", NpgsqlDbType.Numeric).Value = v_soluong;
                    cmd.Parameters.Add("v_dongia", NpgsqlDbType.Numeric).Value = v_dongia;
                    cmd.Parameters.Add("v_vat", NpgsqlDbType.Numeric).Value = v_vat;
                    cmd.Parameters.Add("v_vattu", NpgsqlDbType.Numeric).Value = v_vattu;
                    cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
                    cmd.Parameters.Add("v_giamua", NpgsqlDbType.Numeric).Value = v_giamua;
                    cmd.Parameters.Add("v_bhyttra", NpgsqlDbType.Numeric).Value = v_bhyttra;
                    cmd.Parameters.Add("v_mien", NpgsqlDbType.Numeric).Value = v_mien;
                    cmd.Parameters.Add("v_mabs", NpgsqlDbType.Varchar, 4).Value = v_mabs;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(v_mmyy, ex.Message, m_computername, table);
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }

        public bool upd_v_ttrvct(string table, string v_mmyy, decimal v_id, decimal v_stt, string v_ngay10,
           string v_makp, decimal v_madoituong, decimal v_mavp, decimal v_soluong, decimal v_dongia,
           decimal v_vat, decimal v_vattu, decimal v_sotien, decimal v_giamua, decimal v_bhyttra,
            decimal v_gia_bh, string v_ngaygiodangky, int v_idloaitg, string v_mabs)
        {
            s_dblink = s_dblink == "" ? "" : "@" + s_dblink.Trim('@');
            sql = "update " + s_schema_mmyy(v_mmyy) + "." + table + s_dblink + " set ngay=to_date(:v_ngay,'dd/mm/yyyy'),";
            sql += "makp=:v_makp,madoituong=:v_madoituong,mavp=:v_mavp,soluong=:v_soluong, dongia=:v_dongia,";
            sql += "vat=:v_vat, vattu=:v_vattu, sotien=:v_sotien,giamua=:v_giamua,bhyttra=:v_bhyttra,gia_bh=" + v_gia_bh;
            sql += ", ngaygiodangky=to_date(:v_ngaygiodangky,'dd/mm/yyyy hh24:mi'),idloaitg=:v_idloaitg, mabs=:v_mabs ";
            sql += " where id=:v_id and stt=:v_stt";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 10).Value = v_ngay10;
            cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, 2).Value = v_makp;
            cmd.Parameters.Add("v_madoituong", NpgsqlDbType.Numeric).Value = v_madoituong;
            cmd.Parameters.Add("v_mavp", NpgsqlDbType.Numeric).Value = v_mavp;
            cmd.Parameters.Add("v_soluong", NpgsqlDbType.Numeric).Value = v_soluong;
            cmd.Parameters.Add("v_dongia", NpgsqlDbType.Numeric).Value = v_dongia;
            cmd.Parameters.Add("v_vat", NpgsqlDbType.Numeric).Value = v_vat;
            cmd.Parameters.Add("v_vattu", NpgsqlDbType.Numeric).Value = v_vattu;
            cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
            cmd.Parameters.Add("v_giamua", NpgsqlDbType.Numeric).Value = v_giamua;
            cmd.Parameters.Add("v_bhyttra", NpgsqlDbType.Numeric).Value = v_bhyttra;
            cmd.Parameters.Add("v_ngaygiodangky", NpgsqlDbType.Varchar, 16).Value = v_ngaygiodangky;
            cmd.Parameters.Add("v_idloaitg", NpgsqlDbType.Numeric).Value = v_idloaitg;
            cmd.Parameters.Add("v_mabs", NpgsqlDbType.Varchar, 4).Value = v_mabs;
            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
            

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schema_mmyy(v_mmyy) + "." + table + s_dblink + "(id,stt,ngay,makp,madoituong,mavp,soluong,dongia,vat,vattu,sotien,giamua,bhyttra,gia_bh, ngaygiodangky, idloaitg, mabs ) ";
                    sql += " values(:v_id,:v_stt,to_date(:v_ngay,'dd/mm/yyyy'),:v_makp,:v_madoituong,:v_mavp,:v_soluong,:v_dongia,:v_vat,:v_vattu,:v_sotien,:v_giamua,:v_bhyttra," + v_gia_bh + ",to_date(:v_ngaygiodangky,'dd/mm/yyyy hh24:mi'), :v_idloaitg, :v_mabs )";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
                    cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 10).Value = v_ngay10;
                    cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, 2).Value = v_makp;
                    cmd.Parameters.Add("v_madoituong", NpgsqlDbType.Numeric).Value = v_madoituong;
                    cmd.Parameters.Add("v_mavp", NpgsqlDbType.Numeric).Value = v_mavp;
                    cmd.Parameters.Add("v_soluong", NpgsqlDbType.Numeric).Value = v_soluong;
                    cmd.Parameters.Add("v_dongia", NpgsqlDbType.Numeric).Value = v_dongia;
                    cmd.Parameters.Add("v_vat", NpgsqlDbType.Numeric).Value = v_vat;
                    cmd.Parameters.Add("v_vattu", NpgsqlDbType.Numeric).Value = v_vattu;
                    cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
                    cmd.Parameters.Add("v_giamua", NpgsqlDbType.Numeric).Value = v_giamua;
                    cmd.Parameters.Add("v_bhyttra", NpgsqlDbType.Numeric).Value = v_bhyttra;
                    cmd.Parameters.Add("v_ngaygiodangky", NpgsqlDbType.Varchar, 16).Value = v_ngaygiodangky;
                    cmd.Parameters.Add("v_idloaitg", NpgsqlDbType.Numeric).Value = v_idloaitg;
                    cmd.Parameters.Add("v_mabs", NpgsqlDbType.Varchar, 4).Value = v_mabs;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(v_mmyy, ex.Message, m_computername, table);
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_v_ttrvnhom(string v_mmyy, decimal v_id, decimal v_ma, decimal v_sotien)
        {
            sql = "update " + s_schema_mmyy(v_mmyy) + ".v_ttrvnhom set sotien=:v_sotien where id=:v_id and ma=:v_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_ma", NpgsqlDbType.Numeric).Value = v_ma;
            cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schema_mmyy(v_mmyy) + ".v_ttrvnhom(id,ma,sotien) values(:v_id,:v_ma,:v_sotien)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_ma", NpgsqlDbType.Numeric).Value = v_ma;
                    cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(v_mmyy, ex.Message, m_computername, "v_ttrvnhom");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_v_ttrvpttt(string v_mmyy, decimal v_id, string v_ngay16, decimal v_songay_tpt, decimal v_songay_spt, decimal v_mavp, decimal v_mamau, decimal v_so, decimal v_loaipt, string v_ghichu)
        {
            sql = "update " + s_schema_mmyy(v_mmyy) + ".v_ttrvpttt set ngay=to_date(:v_ngay,'dd/mm/yyyy hh24:mi'), songay_tpt=:v_songay_tpt,songay_spt=:v_songay_spt,mavp=:v_mavp,mamau=:v_mamau,so=:v_so, loaipt=:v_loaipt, ghichu=:v_ghichu where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 16).Value = v_ngay16;
            cmd.Parameters.Add("v_songay_tpt", NpgsqlDbType.Numeric).Value = v_songay_tpt;
            cmd.Parameters.Add("v_songay_spt", NpgsqlDbType.Numeric).Value = v_songay_spt;
            cmd.Parameters.Add("v_mavp", NpgsqlDbType.Numeric).Value = v_mavp;
            cmd.Parameters.Add("v_mamau", NpgsqlDbType.Numeric).Value = v_mamau;
            cmd.Parameters.Add("v_so", NpgsqlDbType.Numeric).Value = v_so;
            cmd.Parameters.Add("v_loaipt", NpgsqlDbType.Numeric).Value = v_loaipt;
            cmd.Parameters.Add("v_ghichu", NpgsqlDbType.Text, 50).Value = v_ghichu;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schema_mmyy(v_mmyy) + ".v_ttrvpttt(id,ngay,songay_tpt,songay_spt,mavp,mamau,so,loaipt,ghichu) values(:v_id,to_date(:v_ngay,'dd/mm/yyyy hh24:mi'),:v_songay_tpt,:v_songay_spt,:v_mavp,:v_mamau,:v_so,:v_loaipt,:v_ghichu)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 16).Value = v_ngay16;
                    cmd.Parameters.Add("v_songay_tpt", NpgsqlDbType.Numeric).Value = v_songay_tpt;
                    cmd.Parameters.Add("v_songay_spt", NpgsqlDbType.Numeric).Value = v_songay_spt;
                    cmd.Parameters.Add("v_mavp", NpgsqlDbType.Numeric).Value = v_mavp;
                    cmd.Parameters.Add("v_mamau", NpgsqlDbType.Numeric).Value = v_mamau;
                    cmd.Parameters.Add("v_so", NpgsqlDbType.Numeric).Value = v_so;
                    cmd.Parameters.Add("v_loaipt", NpgsqlDbType.Numeric).Value = v_loaipt;
                    cmd.Parameters.Add("v_ghichu", NpgsqlDbType.Text, 50).Value = v_ghichu;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(v_mmyy, ex.Message, m_computername, "v_ttrvpttt");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public string upd_v_ttrvds(string v_mmyy, decimal v_id, string v_mabn, decimal v_mavaovien, decimal v_maql, decimal v_idkhoa, string v_giuong, string v_ngayvao, string v_ngayra, string v_chandoan, string v_maicd)
        {
            if (v_id == 0)
            {
                v_id = get_id_v_ttrvll;
            }
            if (v_mmyy == "")
            {
                v_mmyy = get_mmyy(v_ngayra);
            }
            if (v_ngayvao.Length > 10)
            {
                v_ngayvao = v_ngayvao.Substring(0, 16);
            }
            if (v_ngayra.Length > 10)
            {
                v_ngayra = v_ngayra.Substring(0, 16);
            }
            s_dblink = s_dblink == "" ? "" : "@" + s_dblink.Trim('@');
            sql = "update " + s_schema_mmyy(v_mmyy) + ".v_ttrvds" + s_dblink + " set mabn=:v_mabn,mavaovien=:v_mavaovien,maql=:v_maql, idkhoa=:v_idkhoa, giuong=:v_giuong";
            if (v_ngayvao.Length == 16) sql += ",ngayvao=to_date(:v_ngayvao,'dd/mm/yyyy hh24:mi')";
            if (v_ngayra.Length == 16) sql += ",ngayra=to_date(:v_ngayra,'dd/mm/yyyy hh24:mi')";
            sql += ",chandoan=:v_chandoan, maicd=:v_maicd where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
            cmd.Parameters.Add("v_mavaovien", NpgsqlDbType.Numeric).Value = v_mavaovien;
            cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
            cmd.Parameters.Add("v_idkhoa", NpgsqlDbType.Numeric).Value = v_idkhoa;
            cmd.Parameters.Add("v_giuong", NpgsqlDbType.Varchar, 10).Value = v_giuong;
            if (v_ngayvao.Length == 16) cmd.Parameters.Add("v_ngayvao", NpgsqlDbType.Varchar, 16).Value = v_ngayvao;
            if (v_ngayra.Length == 16) cmd.Parameters.Add("v_ngayra", NpgsqlDbType.Varchar, 16).Value = v_ngayra;
            cmd.Parameters.Add("v_chandoan", NpgsqlDbType.Text).Value = v_chandoan;
            cmd.Parameters.Add("v_maicd", NpgsqlDbType.Varchar, 9).Value = v_maicd;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schema_mmyy(v_mmyy) + ".v_ttrvds" + s_dblink + "(id,mabn,mavaovien,maql,idkhoa,giuong";
                    if (v_ngayvao.Length == 16) sql += ",ngayvao";
                    if (v_ngayra.Length == 16) sql += ",ngayra";
                    sql += ",chandoan,maicd)";
                    sql += " values (:v_id,:v_mabn,:v_mavaovien,:v_maql,:v_idkhoa,:v_giuong";
                    if (v_ngayvao.Length == 16) sql += ",to_date(:v_ngayvao,'dd/mm/yyyy hh24:mi')";
                    if (v_ngayra.Length == 16) sql += ",to_date(:v_ngayra,'dd/mm/yyyy hh24:mi')";
                    sql += ",:v_chandoan,:v_maicd)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
                    cmd.Parameters.Add("v_mavaovien", NpgsqlDbType.Numeric).Value = v_mavaovien;
                    cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
                    cmd.Parameters.Add("v_idkhoa", NpgsqlDbType.Numeric).Value = v_idkhoa;
                    cmd.Parameters.Add("v_giuong", NpgsqlDbType.Varchar, 10).Value = v_giuong;
                    if (v_ngayvao.Length == 16) cmd.Parameters.Add("v_ngayvao", NpgsqlDbType.Varchar, 16).Value = v_ngayvao;
                    if (v_ngayra.Length == 16) cmd.Parameters.Add("v_ngayra", NpgsqlDbType.Varchar, 16).Value = v_ngayra;
                    cmd.Parameters.Add("v_chandoan", NpgsqlDbType.Text).Value = v_chandoan;
                    cmd.Parameters.Add("v_maicd", NpgsqlDbType.Varchar, 9).Value = v_maicd;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(v_mmyy, ex.Message, m_computername, "v_ttrvds");
                v_id = 0;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return v_id.ToString();
        }

        public bool upd_v_ttrvds(string v_mmyy, decimal v_id, string v_chandoan, string v_maicd)
        {
            s_dblink = s_dblink == "" ? "" : "@" + s_dblink.Trim('@');
            sql = "update " + s_schema_mmyy(v_mmyy) + ".v_ttrvds" + s_dblink + " set chandoan=:v_chandoan, maicd=:v_maicd where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_chandoan", NpgsqlDbType.Text, 254).Value = v_chandoan;
            cmd.Parameters.Add("v_maicd", NpgsqlDbType.Varchar, 9).Value = v_maicd;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            catch (Exception ex)
            {
                upd_v_error(v_mmyy, ex.Message, m_computername, "v_ttrvds");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_v_ttrvbhyt(string v_mmyy, decimal v_id, string v_sothe, decimal v_maphu, string v_ngay10,
            string v_tungay10, string v_mabv, string v_noigioithieu, int v_traituyen)
        {
            s_dblink = s_dblink == "" ? "" : "@" + s_dblink.Trim('@');
            sql = "update " + s_schema_mmyy(v_mmyy) + ".v_ttrvbhyt" + s_dblink + " set sothe=:v_sothe,maphu=:v_maphu,";
            sql += "ngay=to_date(:v_ngay,'dd/mm/yyyy'),tungay=to_date(:v_tungay,'dd/mm/yyyy'),mabv=:v_mabv,";
            sql += "noigioithieu=:v_noigioithieu,traituyen=" + v_traituyen + " where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_sothe", NpgsqlDbType.Varchar, 18).Value = v_sothe;
            cmd.Parameters.Add("v_maphu", NpgsqlDbType.Numeric).Value = v_maphu;
            cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 10).Value = v_ngay10 == "" ? null : v_ngay10;
            cmd.Parameters.Add("v_tungay", NpgsqlDbType.Varchar, 10).Value = v_tungay10 == "" ? null : v_tungay10;
            cmd.Parameters.Add("v_mabv", NpgsqlDbType.Varchar, 8).Value = v_mabv;
            cmd.Parameters.Add("v_noigioithieu", NpgsqlDbType.Varchar, 8).Value = v_noigioithieu;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schema_mmyy(v_mmyy) + ".v_ttrvbhyt" + s_dblink + "(id,sothe,maphu,tungay,ngay,mabv,noigioithieu,traituyen) values(:v_id,:v_sothe,:v_maphu,to_date(:v_tungay,'dd/mm/yyyy'),to_date(:v_ngay,'dd/mm/yyyy'),:v_mabv,:v_noigioithieu," + v_traituyen + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_sothe", NpgsqlDbType.Varchar, 18).Value = v_sothe;
                    cmd.Parameters.Add("v_maphu", NpgsqlDbType.Numeric).Value = v_maphu;
                    cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 10).Value = v_ngay10 == "" ? null : v_ngay10;
                    cmd.Parameters.Add("v_tungay", NpgsqlDbType.Varchar, 10).Value = v_tungay10 == "" ? null : v_tungay10;
                    cmd.Parameters.Add("v_mabv", NpgsqlDbType.Varchar, 8).Value = v_mabv;
                    cmd.Parameters.Add("v_noigioithieu", NpgsqlDbType.Varchar, 8).Value = v_noigioithieu;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(v_mmyy, ex.Message, m_computername, "v_ttrvbhyt");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }

        public string upd_v_vienphill(string v_mmyy, decimal v_id, decimal v_quyenso, decimal v_sobienlai, string v_ngay10,
            string v_mabn, decimal v_mavaovien, decimal v_maql, decimal v_idkhoa, string v_makp, string v_hoten,
            string v_namsinh, string v_diachi, decimal v_loai, decimal v_loaibn, decimal v_userid, decimal v_phai,
            string v_ghichu, string v_tenbs, decimal v_done, decimal v_quyensodv, decimal v_sobienlaidv, string v_masothue)
        {
            if (v_id == 0)
            {
                v_id = get_id_v_vienphill;
            }
            if (v_mmyy == "")
            {
                v_mmyy = get_mmyy(v_ngay10.Substring(0, 10));
            }
            sql = "update " + s_schema_mmyy(v_mmyy) + ".v_vienphill set quyenso=:v_quyenso,sobienlai=:v_sobienlai,";
            sql += "ngay=to_date(:v_ngay,'dd/MM/yyyy hh24:mi'),mabn=:v_mabn,mavaovien=:v_mavaovien,maql=:v_maql, ";
            sql += "idkhoa=:v_idkhoa,makp=:v_makp,hoten=:v_hoten,namsinh=:v_namsinh,diachi=:v_diachi,loai=:v_loai,";
            sql += "loaibn=:v_loaibn,userid=:v_userid,phai=:v_phai,ghichu=:v_ghichu,bacsi=:v_tenbs,done=:v_done,";
            sql += "quyensodv=" + v_quyensodv + ",sobienlaidv=" + v_sobienlaidv + ",masothue=:v_masothue where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_quyenso", NpgsqlDbType.Numeric).Value = v_quyenso;
            cmd.Parameters.Add("v_sobienlai", NpgsqlDbType.Numeric).Value = v_sobienlai;
            cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 16).Value = v_ngay10;
            cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
            cmd.Parameters.Add("v_mavaovien", NpgsqlDbType.Numeric).Value = v_mavaovien;
            cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
            cmd.Parameters.Add("v_idkhoa", NpgsqlDbType.Numeric).Value = v_idkhoa;
            cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, 2).Value = v_makp;
            cmd.Parameters.Add("v_hoten", NpgsqlDbType.Text).Value = v_hoten;
            cmd.Parameters.Add("v_namsinh", NpgsqlDbType.Varchar, 4).Value = v_namsinh;
            cmd.Parameters.Add("v_diachi", NpgsqlDbType.Text).Value = v_diachi;
            cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
            cmd.Parameters.Add("v_loaibn", NpgsqlDbType.Numeric).Value = v_loaibn;
            cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
            cmd.Parameters.Add("v_phai", NpgsqlDbType.Numeric).Value = v_phai;
            cmd.Parameters.Add("v_ghichu", NpgsqlDbType.Text).Value = v_ghichu;
            cmd.Parameters.Add("v_tenbs", NpgsqlDbType.Text).Value = v_tenbs;
            cmd.Parameters.Add("v_done", NpgsqlDbType.Numeric).Value = v_done;
            cmd.Parameters.Add("v_masothue", NpgsqlDbType.Text, 20).Value = v_masothue;
            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schema_mmyy(v_mmyy) + ".v_vienphill(id,quyenso,sobienlai,ngay,mabn,mavaovien,maql,";
                    sql += "idkhoa,makp,hoten,phai,namsinh,diachi,loai,loaibn,userid,ghichu,bacsi,done,quyensodv,sobienlaidv,masothue) ";
                    sql += "values(:v_id,:v_quyenso,:v_sobienlai,to_date(:v_ngay,'dd/MM/yyyy hh24:mi'),:v_mabn,:v_mavaovien,";
                    sql += ":v_maql,:v_idkhoa,:v_makp,:v_hoten,:v_phai,:v_namsinh,:v_diachi,:v_loai,:v_loaibn,:v_userid,";
                    sql += ":v_ghichu,:v_tenbs,:v_done," + v_quyensodv + "," + v_sobienlaidv + ",:v_masothue)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_quyenso", NpgsqlDbType.Numeric).Value = v_quyenso;
                    cmd.Parameters.Add("v_sobienlai", NpgsqlDbType.Numeric).Value = v_sobienlai;
                    cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 16).Value = v_ngay10;
                    cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
                    cmd.Parameters.Add("v_mavaovien", NpgsqlDbType.Numeric).Value = v_mavaovien;
                    cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
                    cmd.Parameters.Add("v_idkhoa", NpgsqlDbType.Numeric).Value = v_idkhoa;
                    cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, 2).Value = v_makp;
                    cmd.Parameters.Add("v_hoten", NpgsqlDbType.Text).Value = v_hoten;
                    cmd.Parameters.Add("v_phai", NpgsqlDbType.Numeric).Value = v_phai;
                    cmd.Parameters.Add("v_namsinh", NpgsqlDbType.Varchar, 4).Value = v_namsinh;
                    cmd.Parameters.Add("v_diachi", NpgsqlDbType.Text).Value = v_diachi;
                    cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
                    cmd.Parameters.Add("v_loaibn", NpgsqlDbType.Numeric).Value = v_loaibn;
                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                    cmd.Parameters.Add("v_ghichu", NpgsqlDbType.Text).Value = v_ghichu;
                    cmd.Parameters.Add("v_tenbs", NpgsqlDbType.Text).Value = v_tenbs;
                    cmd.Parameters.Add("v_done", NpgsqlDbType.Numeric).Value = v_done;
                    cmd.Parameters.Add("v_masothue", NpgsqlDbType.Text, 20).Value = v_masothue;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(v_mmyy, ex.Message, m_computername, "v_vienphill");
                return "0";
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return v_id.ToString();
        }

        public bool upd_v_vienphict(string v_table, string v_mmyy, decimal v_id, decimal v_stt, decimal v_madoituong, string v_makp,
            string v_ten, decimal v_mavp, decimal v_soluong, decimal v_dongia, decimal v_vat, decimal v_mien, decimal v_thieu,
            decimal v_vattu, string v_mabs, decimal v_idchidinh, decimal v_done)
        {
            sql = "update " + s_schema_mmyy(v_mmyy) + "." + v_table + " set madoituong=:v_madoituong,makp=:v_makp,ten=:v_ten,";
            sql += "mavp=:v_mavp,soluong=:v_soluong, dongia=:v_dongia,vat=" + v_vat + ",mien=:v_mien,thieu=:v_thieu, vattu=:v_vattu,";
            sql += "mabs=:v_mabs,done=:v_done where id=:v_id and stt=:v_stt and idchidinh=:v_idchidinh";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
            cmd.Parameters.Add("v_madoituong", NpgsqlDbType.Numeric).Value = v_madoituong;
            cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, 2).Value = v_makp;
            cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
            cmd.Parameters.Add("v_mavp", NpgsqlDbType.Numeric).Value = v_mavp;
            cmd.Parameters.Add("v_soluong", NpgsqlDbType.Numeric).Value = v_soluong;
            cmd.Parameters.Add("v_dongia", NpgsqlDbType.Numeric).Value = v_dongia;
            cmd.Parameters.Add("v_mien", NpgsqlDbType.Numeric).Value = v_mien;
            cmd.Parameters.Add("v_thieu", NpgsqlDbType.Numeric).Value = v_thieu;
            cmd.Parameters.Add("v_vattu", NpgsqlDbType.Numeric).Value = v_vattu;
            cmd.Parameters.Add("v_mabs", NpgsqlDbType.Varchar, 4).Value = v_mabs;
            cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, 2).Value = v_makp;
            cmd.Parameters.Add("v_idchidinh", NpgsqlDbType.Numeric).Value = v_idchidinh;
            cmd.Parameters.Add("v_done", NpgsqlDbType.Numeric).Value = v_done;
            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schema_mmyy(v_mmyy) + "." + v_table + "(id,stt,madoituong,makp,ten,mavp,soluong,dongia,";
                    sql += "vat,mien,thieu,vattu,mabs,idchidinh,done) values(:v_id,:v_stt,:v_madoituong,:v_makp,:v_ten,:v_mavp,";
                    sql += ":v_soluong,:v_dongia," + v_vat + ",:v_mien,:v_thieu,:v_vattu,:v_mabs,:v_idchidinh,:v_done)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
                    cmd.Parameters.Add("v_madoituong", NpgsqlDbType.Numeric).Value = v_madoituong;
                    cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, 2).Value = v_makp;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
                    cmd.Parameters.Add("v_mavp", NpgsqlDbType.Numeric).Value = v_mavp;
                    cmd.Parameters.Add("v_soluong", NpgsqlDbType.Numeric).Value = v_soluong;
                    cmd.Parameters.Add("v_dongia", NpgsqlDbType.Numeric).Value = v_dongia;
                    cmd.Parameters.Add("v_mien", NpgsqlDbType.Numeric).Value = v_mien;
                    cmd.Parameters.Add("v_thieu", NpgsqlDbType.Numeric).Value = v_thieu;
                    cmd.Parameters.Add("v_vattu", NpgsqlDbType.Numeric).Value = v_vattu;
                    cmd.Parameters.Add("v_mabs", NpgsqlDbType.Varchar, 4).Value = v_mabs;
                    cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, 2).Value = v_makp;
                    cmd.Parameters.Add("v_idchidinh", NpgsqlDbType.Numeric).Value = v_idchidinh;
                    cmd.Parameters.Add("v_done", NpgsqlDbType.Numeric).Value = v_done;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(v_mmyy, ex.Message, m_computername, v_table);
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }

        public string upd_v_tylegiamll(decimal v_id, string v_mabn, decimal v_mavaovien, string v_ngayvao, string v_makp, decimal v_maduyet, decimal v_userid)
        {
            if (v_id == 0)
            {
                v_id = get_id_v_vienphill;
            }

            sql = "update " + s_schemaroot + ".v_tylegiamll set mabn=:v_mabn,mavaovien=:v_mavaovien,ngayvao=to_date(:v_ngayvao,'dd/MM/yyyy'),makp=:v_makp,maduyet=:v_maduyet,userid=:v_userid where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
            cmd.Parameters.Add("v_mavaovien", NpgsqlDbType.Numeric).Value = v_mavaovien;
            cmd.Parameters.Add("v_ngayvao", NpgsqlDbType.Varchar, 10).Value = v_ngayvao;
            cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, 2).Value = v_makp;
            cmd.Parameters.Add("v_maduyet", NpgsqlDbType.Numeric).Value = v_maduyet;
            cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schemaroot + ".v_tylegiamll(id,mabn,mavaovien,ngayvao,makp,maduyet,userid) values(:v_id,:v_mabn,:v_mavaovien,to_date(:v_ngayvao,'dd/MM/yyyy'),:v_makp,:v_maduyet,:v_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
                    cmd.Parameters.Add("v_mavaovien", NpgsqlDbType.Numeric).Value = v_mavaovien;
                    cmd.Parameters.Add("v_ngayvao", NpgsqlDbType.Varchar, 10).Value = v_ngayvao;
                    cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, 2).Value = v_makp;
                    cmd.Parameters.Add("v_maduyet", NpgsqlDbType.Numeric).Value = v_maduyet;
                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_tylegiamll");
                return "0";
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return v_id.ToString();
        }
        public string upd_v_tylegiamct(decimal v_id, decimal v_id_loaivp, decimal v_tyle)
        {
            sql = "update " + s_schemaroot + ".v_tylegiamct set tyle=:v_tyle where id=:v_id and id_loaivp=:v_id_loaivp";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_id_loaivp", NpgsqlDbType.Numeric).Value = v_id_loaivp;
            cmd.Parameters.Add("v_tyle", NpgsqlDbType.Numeric).Value = v_tyle;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schemaroot + ".v_tylegiamct(id,id_loaivp,tyle) values(:v_id,:v_id_loaivp,:v_tyle)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_id_loaivp", NpgsqlDbType.Numeric).Value = v_id_loaivp;
                    cmd.Parameters.Add("v_tyle", NpgsqlDbType.Numeric).Value = v_tyle;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_tylegiamct");
                return "0";
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return v_id.ToString();
        }

        public string upd_v_miendtloaivp(decimal v_madoituong, decimal v_id_loaivp, decimal v_tyle, decimal v_sotien, decimal v_userid)
        {
            sql = "update " + s_schemaroot + ".v_miendtloaivp set tyle=:v_tyle,sotien=:v_sotien,userid=:v_userid where madoituong=:v_madoituong and idloaivp=:v_id_loaivp";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_madoituong", NpgsqlDbType.Numeric).Value = v_madoituong;
            cmd.Parameters.Add("v_id_loaivp", NpgsqlDbType.Numeric).Value = v_id_loaivp;
            cmd.Parameters.Add("v_tyle", NpgsqlDbType.Numeric).Value = v_tyle;
            cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
            cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schemaroot + ".v_miendtloaivp(madoituong,idloaivp,tyle,sotien,userid) values(:v_madoituong,:v_id_loaivp,:v_tyle,:v_sotien,:v_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_madoituong", NpgsqlDbType.Numeric).Value = v_madoituong;
                    cmd.Parameters.Add("v_id_loaivp", NpgsqlDbType.Numeric).Value = v_id_loaivp;
                    cmd.Parameters.Add("v_tyle", NpgsqlDbType.Numeric).Value = v_tyle;
                    cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_miendtloaivp");
                return "0";
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return v_madoituong.ToString();
        }

        public DataSet v_get_timmabn(string m_hoten, string m_ngaysinh, string m_namsinh, string m_mabn)
        {
            string sql = "";
            m_hoten = f_khongdau(m_hoten);
            sql = "select a.mabn,a.hoten,a.namsinh,case when a.phai=0 then 'Nam' else 'Nữ' end as phai,a.sonha,a.thon,b.tentt,c.tenquan,d.tenpxa";
            sql += " from medibv.btdbn a,medibv.btdtt b,medibv.btdquan c,medibv.btdpxa d where a.matt=b.matt and a.maqu=c.maqu";
            sql += " and a.maphuongxa=d.maphuongxa";
            if (m_hoten != "") sql += " and a.hotenkdau='" + m_hoten + "'";
            if (m_ngaysinh != "") sql += " and to_char(a.ngaysinh,'dd/mm/yyyy')='" + m_ngaysinh + "'";
            if (m_namsinh != "") sql += " and a.namsinh='" + m_namsinh + "'";
            if (m_mabn != "") sql += " and a.mabn<>'" + m_mabn + "'";
            return get_data(sql);
        }
        public string upd_v_bienlaitaichinhll(string v_mmyy, decimal v_id, string v_quyenso, string v_sobienlai,
            string v_ngayhd, string v_noidung, string v_tendv, string v_masothue, string v_sotaikhoan, string v_diachi,
            decimal v_sotien, decimal v_vat, decimal v_tkno, decimal v_tkco, decimal v_userid, string v_nguoinhan,
            string v_dcnhan, int v_done, string v_mabn, int v_loai, decimal v_traituyen, decimal v_tamung,string v_ngayhen,decimal v_mien,decimal v_bhyt)
        {
            if (v_id == 0)
            {
                v_id = get_id_v_inbienlaitaichinhll;
            }

            sql = "update " + s_schema_mmyy(v_mmyy) + ".v_bienlaitaichinhll set quyenso=:v_quyenso,sobienlai=:v_sobienlai," +
                "ngayhd=to_date(:v_ngayhd,'dd/mm/yyyy'),noidung=:v_noidung,tendv=:v_tendv,masothue=:v_masothue," +//"ngayhd=to_date(:v_ngayhd,'dd/mm/yyyy'),noidung=:v_noidung,tendv=:v_tendv,masothue=:v_masothue," +
                "sotaikhoan=:v_sotaikhoan,diachi=:v_diachi,sotien=:v_sotien,vat=:v_vat,tkno=:v_tkno,tkco=:v_tkco," +
                "userid=:v_userid,nguoinhan=:v_nguoinhan,dcnhan=:v_dcnhan,done=:v_done,mabn=:v_mabn,loai=:v_loai," +
                "traituyen=:v_traituyen,tamung=:v_tamung,ngayhen=to_date(:v_ngayhen,'dd/mm/yyyy'),mien=:v_mien,bhyt=:v_bhyt where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_quyenso", NpgsqlDbType.Varchar, 30).Value = v_quyenso;
            cmd.Parameters.Add("v_sobienlai", NpgsqlDbType.Varchar, 20).Value = v_sobienlai;
            cmd.Parameters.Add("v_ngayhd", NpgsqlDbType.Varchar).Value = v_ngayhd;
            cmd.Parameters.Add("v_noidung", NpgsqlDbType.Text).Value = v_noidung;
            cmd.Parameters.Add("v_tendv", NpgsqlDbType.Text).Value = v_tendv;
            cmd.Parameters.Add("v_masothue", NpgsqlDbType.Varchar, 20).Value = v_masothue;
            cmd.Parameters.Add("v_sotaikhoan", NpgsqlDbType.Varchar, 30).Value = v_sotaikhoan;
            cmd.Parameters.Add("v_diachi", NpgsqlDbType.Text).Value = v_diachi;
            cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
            cmd.Parameters.Add("v_vat", NpgsqlDbType.Numeric).Value = v_vat;
            cmd.Parameters.Add("v_tkno", NpgsqlDbType.Numeric).Value = v_tkno;
            cmd.Parameters.Add("v_tkco", NpgsqlDbType.Numeric).Value = v_tkco;
            cmd.Parameters.Add("v_nguoinhan", NpgsqlDbType.Text).Value = v_nguoinhan;
            cmd.Parameters.Add("v_dcnhan", NpgsqlDbType.Text).Value = v_dcnhan;
            cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
            cmd.Parameters.Add("v_done", NpgsqlDbType.Numeric).Value = v_done;
            cmd.Parameters.Add("v_mabn", NpgsqlDbType.Text).Value = v_mabn;
            cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
            cmd.Parameters.Add("v_traituyen", NpgsqlDbType.Numeric).Value = v_traituyen;
            cmd.Parameters.Add("v_tamung", NpgsqlDbType.Numeric).Value = v_tamung;
            cmd.Parameters.Add("v_ngayhen", NpgsqlDbType.Varchar, 10).Value = v_ngayhen;
            cmd.Parameters.Add("v_mien", NpgsqlDbType.Numeric).Value = v_mien;
            cmd.Parameters.Add("v_bhyt", NpgsqlDbType.Numeric).Value = v_bhyt;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schema_mmyy(v_mmyy) + ".v_bienlaitaichinhll(id, quyenso," +
                        "sobienlai,ngayHD,noidung,tenDV,masothue,sotaikhoan,diachi,sotien,vat,tkno,tkco," +
                        "userid,nguoinhan,dcnhan,done,mabn,loai,traituyen,tamung,ngayhen,mien,bhyt) values(:v_id,:v_quyenso,:v_sobienlai," +
                        "to_date(:v_ngayhd,'dd/mm/yyyy'),:v_noidung,:v_tendv,:v_masothue,:v_sotaikhoan," +
                        ":v_diachi,:v_sotien,:v_vat,:v_tkno,:v_tkco,:v_userid,:v_nguoinhan,:v_dcnhan," +
                        ":v_done,:v_mabn,:v_loai,:v_traituyen,:v_tamung,to_date(:v_ngayhen,'dd/mm/yyyy'),:v_mien,:v_bhyt)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_quyenso", NpgsqlDbType.Varchar, 30).Value = v_quyenso;
                    cmd.Parameters.Add("v_sobienlai", NpgsqlDbType.Varchar, 20).Value = v_sobienlai;
                    cmd.Parameters.Add("v_ngayhd", NpgsqlDbType.Varchar, 10).Value = v_ngayhd;// gam 14-07-2011
                    cmd.Parameters.Add("v_noidung", NpgsqlDbType.Text).Value = v_noidung;
                    cmd.Parameters.Add("v_tendv", NpgsqlDbType.Text).Value = v_tendv;
                    cmd.Parameters.Add("v_masothue", NpgsqlDbType.Varchar, 20).Value = v_masothue;
                    cmd.Parameters.Add("v_sotaikhoan", NpgsqlDbType.Varchar, 30).Value = v_sotaikhoan;
                    cmd.Parameters.Add("v_diachi", NpgsqlDbType.Text).Value = v_diachi;
                    cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
                    cmd.Parameters.Add("v_vat", NpgsqlDbType.Numeric).Value = v_vat;
                    cmd.Parameters.Add("v_tkno", NpgsqlDbType.Numeric).Value = v_tkno;
                    cmd.Parameters.Add("v_tkco", NpgsqlDbType.Numeric).Value = v_tkco;
                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                    cmd.Parameters.Add("v_nguoinhan", NpgsqlDbType.Text).Value = v_nguoinhan;
                    cmd.Parameters.Add("v_dcnhan", NpgsqlDbType.Text).Value = v_dcnhan;
                    cmd.Parameters.Add("v_done", NpgsqlDbType.Numeric).Value = v_done;
                    cmd.Parameters.Add("v_mabn", NpgsqlDbType.Text).Value = v_mabn;
                    cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
                    cmd.Parameters.Add("v_traituyen", NpgsqlDbType.Numeric).Value = v_traituyen;
                    cmd.Parameters.Add("v_tamung", NpgsqlDbType.Numeric).Value = v_tamung;
                    cmd.Parameters.Add("v_ngayhen", NpgsqlDbType.Varchar, 10).Value = v_ngayhen;
                    cmd.Parameters.Add("v_mien", NpgsqlDbType.Numeric).Value = v_mien;
                    cmd.Parameters.Add("v_bhyt", NpgsqlDbType.Numeric).Value = v_bhyt;



                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(v_mmyy, ex.Message, m_computername, "v_bienlaitaichinhll");
                return "0";
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return v_id.ToString();
        }
        public bool upd_v_bienlaitaichinhct(string v_mmyy, decimal v_id, decimal v_stt, string v_mabn,
            string v_makp, decimal v_chiphi, decimal v_bhyt, decimal v_mien, decimal v_tamung,
            decimal v_done, decimal v_loai, string v_idvienphi, decimal v_soluong, decimal v_dongia,
            decimal v_vat, decimal v_sotien, decimal v_mavp, decimal v_madoituong)
        {
            sql = "update " + s_schema_mmyy(v_mmyy) + ".v_bienlaitaichinhct set mabn=:v_mabn," +
                "makp=:v_makp,chiphi=:v_chiphi,bhyt=:v_bhyt, mien=:v_mien,tamung=:v_tamung, " +
                "done=:v_done, loai=:v_loai,idvienphi=:v_idvienphi,soluong=:v_soluong,dongia=:v_dongia," +
                "vat=:v_vat,sotien=:v_sotien,mavp=:v_mavp,madoituong=:v_madoituong where id=:v_id and stt=:v_stt";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;


            cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
            cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, 2).Value = v_makp;
            cmd.Parameters.Add("v_chiphi", NpgsqlDbType.Numeric).Value = v_chiphi;
            cmd.Parameters.Add("v_bhyt", NpgsqlDbType.Numeric).Value = v_bhyt;
            cmd.Parameters.Add("v_mien", NpgsqlDbType.Numeric).Value = v_mien;
            cmd.Parameters.Add("v_tamung", NpgsqlDbType.Numeric).Value = v_tamung;
            cmd.Parameters.Add("v_done", NpgsqlDbType.Numeric).Value = v_done;
            cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
            cmd.Parameters.Add("v_idvienphi", NpgsqlDbType.Text).Value = v_idvienphi;
            cmd.Parameters.Add("v_soluong", NpgsqlDbType.Numeric).Value = v_soluong;
            cmd.Parameters.Add("v_dongia", NpgsqlDbType.Numeric).Value = v_dongia;
            cmd.Parameters.Add("v_vat", NpgsqlDbType.Numeric).Value = v_vat;
            cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
            cmd.Parameters.Add("v_mavp", NpgsqlDbType.Numeric).Value = v_mavp;
            cmd.Parameters.Add("v_madoituong", NpgsqlDbType.Numeric).Value = v_madoituong;
            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schema_mmyy(v_mmyy) + ".v_bienlaitaichinhct(id,stt,mabn,makp," +
                        "chiphi,bhyt,mien,tamung,done,loai,idvienphi,soluong,dongia,vat,sotien,mavp,madoituong) " +
                        "values(:v_id,:v_stt,:v_mabn,:v_makp,:v_chiphi,:v_bhyt,:v_mien,:v_tamung,:v_done," +
                        ":v_loai,:v_idvienphi,:v_soluong,:v_dongia,:v_vat,:v_sotien,:v_mavp,:v_madoituong)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
                    cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
                    cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, 2).Value = v_makp;
                    cmd.Parameters.Add("v_chiphi", NpgsqlDbType.Numeric).Value = v_chiphi;
                    cmd.Parameters.Add("v_bhyt", NpgsqlDbType.Numeric).Value = v_bhyt;
                    cmd.Parameters.Add("v_mien", NpgsqlDbType.Numeric).Value = v_mien;
                    cmd.Parameters.Add("v_tamung", NpgsqlDbType.Numeric).Value = v_tamung;
                    cmd.Parameters.Add("v_done", NpgsqlDbType.Numeric).Value = v_done;
                    cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
                    cmd.Parameters.Add("v_idvienphi", NpgsqlDbType.Text).Value = v_idvienphi;
                    cmd.Parameters.Add("v_soluong", NpgsqlDbType.Numeric).Value = v_soluong;
                    cmd.Parameters.Add("v_dongia", NpgsqlDbType.Numeric).Value = v_dongia;
                    cmd.Parameters.Add("v_vat", NpgsqlDbType.Numeric).Value = v_vat;
                    cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
                    cmd.Parameters.Add("v_mavp", NpgsqlDbType.Numeric).Value = v_mavp;
                    cmd.Parameters.Add("v_madoituong", NpgsqlDbType.Numeric).Value = v_madoituong;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(v_mmyy, ex.Message, m_computername, "v_bienlaitaichinhct");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_maubaocao(decimal v_id, string v_ma, string v_ten, int v_loai)
        {

            sql = "update " + user + ".v_maubaocao set ma=:v_ma,ten=:v_ten,loai=:v_loai where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_ma", NpgsqlDbType.Varchar, 100).Value = v_ma;
            cmd.Parameters.Add("v_ten", NpgsqlDbType.Varchar, 100).Value = v_ten;
            cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".v_maubaocao(id,ma,ten,loai) values(:v_id,:v_ma,:v_ten,:v_loai)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_ma", NpgsqlDbType.Varchar, 100).Value = v_ma;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Varchar, 100).Value = v_ten;
                    cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_maubaocao");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }

        public bool upd_dmbschidinh(string v_ten, string v_benhvien, string v_khoa)
        {

            sql = "update " + user + ".dmbschidinh set khoa=:v_khoa where ten=:v_ten and benhvien=:v_benhvien";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
            cmd.Parameters.Add("v_benhvien", NpgsqlDbType.Text).Value = v_benhvien;
            cmd.Parameters.Add("v_khoa", NpgsqlDbType.Text).Value = v_khoa;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".dmbschidinh(ten,benhvien,khoa) values (:v_ten,:v_benhvien,:v_khoa)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
                    cmd.Parameters.Add("v_benhvien", NpgsqlDbType.Text).Value = v_benhvien;
                    cmd.Parameters.Add("v_khoa", NpgsqlDbType.Text).Value = v_khoa;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "dmbschidinh");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }

        public bool upd_v_nhomkhoabvll(int d_id, string d_ma, string d_ten, int d_stt, string d_makp)
        {
            sql = " update " + user + ".v_nhomkhoabvll set ma=:d_ma,ten=:d_ten,stt=:d_stt,makp=:d_makp where id=:d_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("d_id", NpgsqlDbType.Numeric).Value = d_id;
                cmd.Parameters.Add("d_ma", NpgsqlDbType.Text).Value = d_ma;
                cmd.Parameters.Add("d_ten", NpgsqlDbType.Text).Value = d_ten;
                cmd.Parameters.Add("d_stt", NpgsqlDbType.Numeric).Value = d_stt;
                cmd.Parameters.Add("d_makp", NpgsqlDbType.Text).Value = d_makp;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".v_nhomkhoabvll(id,ma,ten,stt,makp) values (:d_id,:d_ma,:d_ten,:d_stt,:d_makp)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("d_id", NpgsqlDbType.Numeric).Value = d_id;
                    cmd.Parameters.Add("d_ma", NpgsqlDbType.Text).Value = d_ma;
                    cmd.Parameters.Add("d_ten", NpgsqlDbType.Text).Value = d_ten;
                    cmd.Parameters.Add("d_stt", NpgsqlDbType.Numeric).Value = d_stt;
                    cmd.Parameters.Add("d_makp", NpgsqlDbType.Text).Value = d_makp;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_v_error(ex.Message, m_computername, "v_nhomkhoabvll");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public void upd_v_nhomkhoabvct(int d_id, string d_makp, string d_tenkp)
        {
            sql = " update " + user + ".v_nhomkhoabvct set tenkp=:d_tenkp where id=:d_id and makp=:d_makp";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("d_id", NpgsqlDbType.Numeric).Value = d_id;
                cmd.Parameters.Add("d_makp", NpgsqlDbType.Varchar, 3).Value = d_makp;
                cmd.Parameters.Add("d_tenkp", NpgsqlDbType.Text).Value = d_tenkp;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".v_nhomkhoabvct(id,makp,tenkp) values (:d_id,:d_makp,:d_tenkp)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("d_id", NpgsqlDbType.Numeric).Value = d_id;
                    cmd.Parameters.Add("d_makp", NpgsqlDbType.Varchar, 3).Value = d_makp;
                    cmd.Parameters.Add("d_tenkp", NpgsqlDbType.Text).Value = d_tenkp;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_v_error(ex.Message, m_computername, "v_nhomkhoabvct");
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
        }

        public bool upd_v_nhomkhoabv1ll(int d_id, string d_ma, string d_ten, int d_stt, string d_makp)
        {
            sql = " update " + user + ".v_nhomkhoabv1ll set ma=:d_ma,ten=:d_ten,stt=:d_stt,mavp=:d_makp where id=:d_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("d_id", NpgsqlDbType.Numeric).Value = d_id;
                cmd.Parameters.Add("d_ma", NpgsqlDbType.Text).Value = d_ma;
                cmd.Parameters.Add("d_ten", NpgsqlDbType.Text).Value = d_ten;
                cmd.Parameters.Add("d_stt", NpgsqlDbType.Numeric).Value = d_stt;
                cmd.Parameters.Add("d_makp", NpgsqlDbType.Text).Value = d_makp;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".v_nhomkhoabv1ll(id,ma,ten,stt,mavp) values (:d_id,:d_ma,:d_ten,:d_stt,:d_makp)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("d_id", NpgsqlDbType.Numeric).Value = d_id;
                    cmd.Parameters.Add("d_ma", NpgsqlDbType.Text).Value = d_ma;
                    cmd.Parameters.Add("d_ten", NpgsqlDbType.Text).Value = d_ten;
                    cmd.Parameters.Add("d_stt", NpgsqlDbType.Numeric).Value = d_stt;
                    cmd.Parameters.Add("d_makp", NpgsqlDbType.Text).Value = d_makp;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_v_error(ex.Message, m_computername, "v_nhomkhoabv1ll");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public void upd_v_nhomkhoabv1ct(int d_id, string d_mavp, string d_tenvp)
        {
            sql = " update " + user + ".v_nhomkhoabv1ct set tenvp=:d_tenvp where id=:d_id and mavp=:d_mavp";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("d_id", NpgsqlDbType.Numeric).Value = d_id;
                cmd.Parameters.Add("d_mavp", NpgsqlDbType.Varchar, 10).Value = d_mavp;
                cmd.Parameters.Add("d_tenvp", NpgsqlDbType.Text).Value = d_tenvp;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".v_nhomkhoabv1ct(id,mavp,tenvp) values (:d_id,:d_mavp,:d_tenvp)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("d_id", NpgsqlDbType.Numeric).Value = d_id;
                    cmd.Parameters.Add("d_mavp", NpgsqlDbType.Varchar, 10).Value = d_mavp;
                    cmd.Parameters.Add("d_tenvp", NpgsqlDbType.Text).Value = d_tenvp;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_v_error(ex.Message, m_computername, "v_nhomkhoabv1ct");
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
        }

        public bool upd_trongoi(decimal v_id, decimal v_stt, decimal v_id_nhom, decimal v_id_loai, decimal v_id_gia, decimal v_sotien)
        {
            sql = "update " + user + ".v_trongoi set stt=:v_stt,sotien=:v_sotien where id=:v_id and id_nhom=:v_id_nhom and id_loai=:v_id_loai and id_gia=:v_id_gia";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
                cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
                cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                cmd.Parameters.Add("v_id_nhom", NpgsqlDbType.Numeric).Value = v_id_nhom;
                cmd.Parameters.Add("v_id_loai", NpgsqlDbType.Numeric).Value = v_id_loai;
                cmd.Parameters.Add("v_id_gia", NpgsqlDbType.Numeric).Value = v_id_gia;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".v_trongoi(id,stt,id_nhom,id_loai,id_gia,sotien) values (:v_id,:v_stt,:v_id_nhom,:v_id_loai,:v_id_gia,:v_sotien)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
                    cmd.Parameters.Add("v_id_nhom", NpgsqlDbType.Numeric).Value = v_id_nhom;
                    cmd.Parameters.Add("v_id_loai", NpgsqlDbType.Numeric).Value = v_id_loai;
                    cmd.Parameters.Add("v_id_gia", NpgsqlDbType.Numeric).Value = v_id_gia;
                    cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_v_error(ex.Message, m_computername, "v_trongoi");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }
        public void upd_v_trongoipk(decimal v_id, string v_makp, decimal v_sotien, decimal v_stt, decimal v_id_gia_goc)
        {
            sql = " update " + user + ".v_trongoipk set stt=:v_stt,sotien=:v_sotien where id=:v_id and makp=:v_makp and idgiavp=:v_id_gia_goc";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, 2).Value = v_makp;
                cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
                cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
                cmd.Parameters.Add("v_id_gia_goc", NpgsqlDbType.Numeric).Value = v_id_gia_goc;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".v_trongoipk(id,makp,sotien,stt,idgiavp) values (:v_id,:v_makp,:v_sotien,:v_stt,:v_id_gia_goc)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, 2).Value = v_makp;
                    cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
                    cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
                    cmd.Parameters.Add("v_id_gia_goc", NpgsqlDbType.Numeric).Value = v_id_gia_goc;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_v_error(ex.Message, m_computername, "v_trongoipk");
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
        }

        public bool upd_huybienlai(string v_mmyy, decimal v_id, string v_tables, int v_loai, string v_mabn, string v_hoten, string v_makp, string v_ngay, decimal v_quyenso, decimal v_sobienlai, string v_lydo, int v_userid, decimal v_sotien)
        {
            try
            {
                string xxx = s_schemaroot + v_mmyy;

                sql = "update " + xxx + ".v_huybienlai set loai=:v_loai, mabn=:v_mabn, hoten=:v_hoten, makp=:v_makp, ngay=to_date(:v_ngay,'dd/mm/yyyy hh24:mi'), quyenso=:v_quyenso, sobienlai=:v_sobienlai, lydo=:v_lydo, userid=:v_userid, sotien=:v_sotien where id=:v_id and tables=:v_tables";
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                cmd.Parameters.Add("v_tables", NpgsqlDbType.Varchar, 20).Value = v_tables;
                cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
                cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
                cmd.Parameters.Add("v_hoten", NpgsqlDbType.Text).Value = v_hoten;
                cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, 2).Value = v_makp;
                cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 16).Value = v_ngay;
                cmd.Parameters.Add("v_quyenso", NpgsqlDbType.Numeric).Value = v_quyenso;
                cmd.Parameters.Add("v_sobienlai", NpgsqlDbType.Numeric).Value = v_sobienlai;
                cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                cmd.Parameters.Add("v_lydo", NpgsqlDbType.Text).Value = v_lydo;
                cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;

                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".v_huybienlai(id, tables, loai, mabn, hoten, makp, ngay, quyenso, sobienlai, lydo, userid, sotien) values (:v_id, :v_tables, :v_loai, :v_mabn, :v_hoten, :v_makp, to_date(:v_ngay,'dd/mm/yyyy hh24:mi'), :v_quyenso, :v_sobienlai, :v_lydo, :v_userid, :v_sotien)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_tables", NpgsqlDbType.Varchar, 20).Value = v_tables;
                    cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
                    cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
                    cmd.Parameters.Add("v_hoten", NpgsqlDbType.Text).Value = v_hoten;
                    cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, 2).Value = v_makp;
                    cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 16).Value = v_ngay;
                    cmd.Parameters.Add("v_quyenso", NpgsqlDbType.Numeric).Value = v_quyenso;
                    cmd.Parameters.Add("v_sobienlai", NpgsqlDbType.Numeric).Value = v_sobienlai;
                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                    cmd.Parameters.Add("v_lydo", NpgsqlDbType.Text).Value = v_lydo;
                    cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(v_mmyy, ex.Message, m_computername, "v_huybienlai");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }

        public bool upd_bienlaitaichinhhuy(decimal v_id, string v_ngay, string v_quyenso, decimal v_sobienlai,int v_userid, decimal v_idbienlai)
        {
            try
            {

                sql = "update medibv.v_bienlaitaichinhhuy set ngay=to_date(:v_ngay,'dd/mm/yyyy'), quyenso=:v_quyenso, sobienlai=:v_sobienlai, userid=:v_userid,idbienlai=:v_idbienlai where id=:v_id ";
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 16).Value = v_ngay;
                cmd.Parameters.Add("v_quyenso", NpgsqlDbType.Varchar).Value = v_quyenso;
                cmd.Parameters.Add("v_sobienlai", NpgsqlDbType.Numeric).Value = v_sobienlai;         
                cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                cmd.Parameters.Add("v_idbienlai", NpgsqlDbType.Numeric).Value = v_idbienlai;
                cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;

                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into medibv.v_bienlaitaichinhhuy(id,ngay, quyenso, sobienlai, userid,idbienlai) ";
                    sql += "values (:v_id,to_date(:v_ngay,'dd/mm/yyyy hh24:mi'), :v_quyenso, :v_sobienlai,:v_userid,:v_idbienlai)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 16).Value = v_ngay;
                    cmd.Parameters.Add("v_quyenso", NpgsqlDbType.Varchar).Value = v_quyenso;
                    cmd.Parameters.Add("v_sobienlai", NpgsqlDbType.Numeric).Value = v_sobienlai;
                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                    cmd.Parameters.Add("v_idbienlai", NpgsqlDbType.Numeric).Value = v_idbienlai;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_bienlaitaichinhhuy");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }

        public string upd_v_trongoi(string v_mmyy, decimal v_id, decimal v_sotien, decimal v_tamung, decimal v_hoantra, decimal v_pm, decimal v_yc, string v_ghichu)
        {
            if (v_id == 0)
            {
                return "0";
            }
            if (v_mmyy == "")
            {
                v_mmyy = s_curmmyy;
            }
            sql = "update " + s_schema_mmyy(v_mmyy) + ".v_trongoi set sotien=:v_sotien,tamung=:v_tamung,hoantra=:v_hoantra,pm=:v_pm,yc=:v_yc, ghichu=:v_ghichu where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
            cmd.Parameters.Add("v_tamung", NpgsqlDbType.Numeric).Value = v_tamung;
            cmd.Parameters.Add("v_hoantra", NpgsqlDbType.Numeric).Value = v_hoantra;
            cmd.Parameters.Add("v_pm", NpgsqlDbType.Numeric).Value = v_pm;
            cmd.Parameters.Add("v_yc", NpgsqlDbType.Numeric).Value = v_yc;
            cmd.Parameters.Add("v_ghichu", NpgsqlDbType.Text).Value = v_ghichu;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schema_mmyy(v_mmyy) + ".v_trongoi(id,sotien,tamung,hoantra,pm,yc,ghichu) values(:v_id,:v_sotien,:v_tamung,:v_hoantra,:v_pm,:v_yc,:v_ghichu)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
                    cmd.Parameters.Add("v_tamung", NpgsqlDbType.Numeric).Value = v_tamung;
                    cmd.Parameters.Add("v_hoantra", NpgsqlDbType.Numeric).Value = v_hoantra;
                    cmd.Parameters.Add("v_pm", NpgsqlDbType.Numeric).Value = v_pm;
                    cmd.Parameters.Add("v_yc", NpgsqlDbType.Numeric).Value = v_yc;
                    cmd.Parameters.Add("v_ghichu", NpgsqlDbType.Text).Value = v_ghichu;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(v_mmyy, ex.Message, m_computername, "v_trongoi");
                return "0";
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return v_id.ToString();
        }
        public string upd_v_nhom(string v_mmyy, decimal v_id, decimal v_id_loaivp, decimal v_sotien)
        {
            if (v_id == 0)
            {
                return "0";
            }
            if (v_mmyy == "")
            {
                v_mmyy = s_curmmyy;
            }
            sql = "update " + s_schema_mmyy(v_mmyy) + ".v_nhom set sotien=:v_sotien where id=:v_id and  ma=:v_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_ma", NpgsqlDbType.Numeric).Value = v_id_loaivp;
            cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schema_mmyy(v_mmyy) + ".v_nhom(id,ma,sotien) values(:v_id,:v_ma,:v_sotien)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_ma", NpgsqlDbType.Numeric).Value = v_id_loaivp;
                    cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(v_mmyy, ex.Message, m_computername, "v_nhom");
                return "0";
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return v_id.ToString();
        }
        public bool upd_v_giuong(string v_mmyy, decimal v_id, decimal v_mavp, string v_ngay10, decimal v_dongia)
        {
            sql = "update " + s_schema_mmyy(v_mmyy) + ".v_giuong set dongia=:v_dongia where id=:v_id and mavp=:v_mavp and to_char(ngay,'dd/mm/yyyy')=:v_ngay";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_mavp", NpgsqlDbType.Numeric).Value = v_mavp;
            cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 10).Value = v_ngay10;
            cmd.Parameters.Add("v_dongia", NpgsqlDbType.Numeric).Value = v_dongia;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schema_mmyy(v_mmyy) + ".v_giuong(id,mavp,ngay,dongia) values(:v_id,:v_mavp,to_date(:v_ngay,'dd/mm/yyyy'),:v_dongia)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_mavp", NpgsqlDbType.Numeric).Value = v_mavp;
                    cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 10).Value = v_ngay10;
                    cmd.Parameters.Add("v_dongia", NpgsqlDbType.Numeric).Value = v_dongia;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(v_mmyy, ex.Message, m_computername, "v_giuong");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_v_suatan(string v_mmyy, decimal v_id, decimal v_mavp, string v_ngay16, decimal v_dongia)
        {
            sql = "update " + s_schema_mmyy(v_mmyy) + ".v_suatan set dongia=:v_dongia where id=:v_id and mavp=:v_mavp and to_char(ngay,'dd/mm/yyyy hh24:mi')=:v_ngay";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_mavp", NpgsqlDbType.Numeric).Value = v_mavp;
            cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 16).Value = v_ngay16;
            cmd.Parameters.Add("v_dongia", NpgsqlDbType.Numeric).Value = v_dongia;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schema_mmyy(v_mmyy) + ".v_suatan(id,mavp,ngay,dongia) values(:v_id,:v_mavp,to_date(:v_ngay,'dd/mm/yyyy hh24:mi'),:v_dongia)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_mavp", NpgsqlDbType.Numeric).Value = v_mavp;
                    cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 16).Value = v_ngay16;
                    cmd.Parameters.Add("v_dongia", NpgsqlDbType.Numeric).Value = v_dongia;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(v_mmyy, ex.Message, m_computername, "v_suatan");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_v_vpkhoa(string v_mmyy, decimal v_id, string v_mabn, decimal v_maql, decimal v_idkhoa, string v_ngay16, string v_makp, decimal v_madoituong, decimal v_mavp, decimal v_soluong, decimal v_dongia, decimal v_vattu, decimal v_userid)
        {
            sql = "update " + s_schema_mmyy(v_mmyy) + ".v_vpkhoa set mabn=:v_mabn,maql=:v_maql,idkhoa=:v_idkhoa,ngay=to_date(:v_ngay,'dd/mm/yyyy hh24:mi'), makp=:v_makp, madoituong=:v_madoituong,mavp=:v_mavp,soluong=:v_soluong,dongia=:v_dongia,vattu=:v_vattu,userid=:v_userid where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
            cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
            cmd.Parameters.Add("v_idkhoa", NpgsqlDbType.Numeric).Value = v_idkhoa;
            cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 16).Value = v_ngay16;
            cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, 2).Value = v_makp;
            cmd.Parameters.Add("v_madoituong", NpgsqlDbType.Numeric).Value = v_madoituong;
            cmd.Parameters.Add("v_mavp", NpgsqlDbType.Numeric).Value = v_mavp;
            cmd.Parameters.Add("v_soluong", NpgsqlDbType.Numeric).Value = v_soluong;
            cmd.Parameters.Add("v_dongia", NpgsqlDbType.Numeric).Value = v_dongia;
            cmd.Parameters.Add("v_vattu", NpgsqlDbType.Numeric).Value = v_vattu;
            cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schema_mmyy(v_mmyy) + ".v_vpkhoa(id,mabn, maql, idkhoa,ngay,makp,madoituong,mavp,soluong,dongia,vattu,userid,done) values(:v_id,:v_mabn,:v_maql,:v_idkhoa, to_date(:v_ngay,'dd/mm/yyyy hh24:mi'),:v_makp,:v_madoituong,:v_mavp,:v_soluong,:v_dongia,:v_vattu,:v_userid,0)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
                    cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
                    cmd.Parameters.Add("v_idkhoa", NpgsqlDbType.Numeric).Value = v_idkhoa;
                    cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 16).Value = v_ngay16;
                    cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, 2).Value = v_makp;
                    cmd.Parameters.Add("v_madoituong", NpgsqlDbType.Numeric).Value = v_madoituong;
                    cmd.Parameters.Add("v_mavp", NpgsqlDbType.Numeric).Value = v_mavp;
                    cmd.Parameters.Add("v_soluong", NpgsqlDbType.Numeric).Value = v_soluong;
                    cmd.Parameters.Add("v_dongia", NpgsqlDbType.Numeric).Value = v_dongia;
                    cmd.Parameters.Add("v_vattu", NpgsqlDbType.Numeric).Value = v_vattu;
                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(v_mmyy, ex.Message, m_computername, "v_vpkhoa");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public string upd_bhytkb(string v_mmyy, decimal v_id, decimal v_nhom, decimal v_quyenso, decimal v_sobienlai, string v_ngay10,
            string v_mabn, decimal v_mavaovien, decimal v_maql, string v_makp, string v_chandoan, string v_maicd, string v_mabs,
            string v_sothe, decimal v_maphu, string v_mabv, decimal v_congkham, decimal v_thuoc, decimal v_cls,
            decimal v_bntra, decimal v_bhyttra, decimal v_loaiba, decimal v_userid, int v_traituyen)
        {
            if (v_id == 0) v_id = get_id_bhytkb;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            sql = "update " + s_schema_mmyy(v_mmyy) + ".bhytkb set quyenso=:v_quyenso,sobienlai=:v_sobienlai,bntra=:v_bntra,bhyttra=:v_bhyttra,traituyen=" + v_traituyen + " where id=:v_id";
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_quyenso", NpgsqlDbType.Numeric).Value = v_quyenso;
            cmd.Parameters.Add("v_sobienlai", NpgsqlDbType.Numeric).Value = v_sobienlai;
            cmd.Parameters.Add("v_bntra", NpgsqlDbType.Numeric).Value = v_bntra;
            cmd.Parameters.Add("v_bhyttra", NpgsqlDbType.Numeric).Value = v_bhyttra;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schema_mmyy(v_mmyy) + ".bhytkb(id,nhom,quyenso,sobienlai,ngay,mabn,mavaovien,maql,makp,chandoan,maicd,mabs,sothe,maphu,mabv,congkham,thuoc,cls,bntra,bhyttra,loaiba,traituyen,userid) values(:v_id,:v_nhom,:v_quyenso,:v_sobienlai,to_date(:v_ngay,'dd/mm/yyyy hh24:mi'),:v_mabn,:v_mavaovien,:v_maql,:v_makp,:v_chandoan,:v_maicd,:v_mabs,:v_sothe,:v_maphu,:v_mabv,:v_congkham,:v_thuoc,:v_cls,:v_bntra,:v_bhyttra,:v_loaiba," + v_traituyen + ",:v_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_nhom", NpgsqlDbType.Numeric).Value = v_nhom;
                    cmd.Parameters.Add("v_quyenso", NpgsqlDbType.Numeric).Value = v_quyenso;
                    cmd.Parameters.Add("v_sobienlai", NpgsqlDbType.Numeric).Value = v_sobienlai;
                    cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 16).Value = v_ngay10;
                    cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
                    cmd.Parameters.Add("v_mavaovien", NpgsqlDbType.Numeric).Value = v_mavaovien;
                    cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
                    cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, 2).Value = v_makp;
                    cmd.Parameters.Add("v_chandoan", NpgsqlDbType.Text).Value = v_chandoan;
                    cmd.Parameters.Add("v_maicd", NpgsqlDbType.Varchar, 9).Value = v_maicd;
                    cmd.Parameters.Add("v_mabs", NpgsqlDbType.Varchar, 4).Value = v_mabs;
                    cmd.Parameters.Add("v_sothe", NpgsqlDbType.Varchar, 20).Value = v_sothe;
                    cmd.Parameters.Add("v_maphu", NpgsqlDbType.Numeric).Value = v_maphu;
                    cmd.Parameters.Add("v_mabv", NpgsqlDbType.Varchar, 8).Value = v_mabv;
                    cmd.Parameters.Add("v_congkham", NpgsqlDbType.Numeric).Value = v_congkham;
                    cmd.Parameters.Add("v_thuoc", NpgsqlDbType.Numeric).Value = v_thuoc;
                    cmd.Parameters.Add("v_cls", NpgsqlDbType.Numeric).Value = v_cls;
                    cmd.Parameters.Add("v_bntra", NpgsqlDbType.Numeric).Value = v_bntra;
                    cmd.Parameters.Add("v_bhyttra", NpgsqlDbType.Numeric).Value = v_bhyttra;
                    cmd.Parameters.Add("v_loaiba", NpgsqlDbType.Numeric).Value = v_loaiba;
                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(v_mmyy, ex.Message, m_computername, "mmyy.bhytkb");
                v_id = 0;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return v_id.ToString();
        }
        public bool upd_bhytkb(string v_mmyy, decimal v_quyenso, decimal v_sobienlai, string v_ngaythu, string v_mabn)
        {
            try
            {
                string sql = "";
                sql = "update " + s_schema_mmyy(v_mmyy) + ".bhytkb set quyenso=" + v_quyenso + ",sobienlai=" + v_sobienlai + " where to_char(ngay,'dd/mm/yyyy')='" + v_ngaythu + "' and mabn='" + v_mabn + "'";
                execute_data(sql);
            }
            catch (Exception ex)
            {
                upd_v_error(v_mmyy, ex.Message, m_computername, "bhytkb");
                return false;
            }
            return true;
        }

        public bool upd_bhytcls(string v_mmyy, decimal v_id, decimal v_stt, decimal v_mavp, decimal v_soluong, decimal v_dongia, decimal v_idchidinh)
        {
            sql = "update " + s_schema_mmyy(v_mmyy) + ".bhytcls set mavp=:v_mavp,soluong=:v_soluong,dongia=:v_dongia where id=:v_id and stt=:v_stt";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
            cmd.Parameters.Add("v_mavp", NpgsqlDbType.Numeric).Value = v_mavp;
            cmd.Parameters.Add("v_soluong", NpgsqlDbType.Numeric).Value = v_soluong;
            cmd.Parameters.Add("v_dongia", NpgsqlDbType.Numeric).Value = v_dongia;
            //cmd.Parameters.Add("v_idchidinh", NpgsqlDbType.Numeric).Value = v_idchidinh;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schema_mmyy(v_mmyy) + ".bhytcls(id,stt,mavp,soluong,dongia) values(:v_id,:v_stt,:v_mavp,:v_soluong,:v_dongia)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
                    cmd.Parameters.Add("v_mavp", NpgsqlDbType.Numeric).Value = v_mavp;
                    cmd.Parameters.Add("v_soluong", NpgsqlDbType.Numeric).Value = v_soluong;
                    cmd.Parameters.Add("v_dongia", NpgsqlDbType.Numeric).Value = v_dongia;
                    // cmd.Parameters.Add("v_idchidinh", NpgsqlDbType.Numeric).Value = v_idchidinh;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(v_mmyy, ex.Message, m_computername, "bhytcls");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_bhytds(string v_mmyy, string v_mabn, string v_hoten, string v_namsinh, string v_diachi)
        {
            sql = "update " + s_schema_mmyy(v_mmyy) + ".bhytds set hoten=:v_hoten,namsinh=:v_namsinh,diachi=:v_diachi where mabn=:v_mabn";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
            cmd.Parameters.Add("v_hoten", NpgsqlDbType.Text).Value = v_hoten;
            cmd.Parameters.Add("v_namsinh", NpgsqlDbType.Varchar, 4).Value = v_namsinh;
            cmd.Parameters.Add("v_diachi", NpgsqlDbType.Text).Value = v_diachi;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schema_mmyy(v_mmyy) + ".bhytds(mabn,hoten,namsinh,diachi) values(:v_mabn,:v_hoten,:v_namsinh,:v_diachi)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
                    cmd.Parameters.Add("v_hoten", NpgsqlDbType.Text).Value = v_hoten;
                    cmd.Parameters.Add("v_namsinh", NpgsqlDbType.Varchar, 4).Value = v_namsinh;
                    cmd.Parameters.Add("v_diachi", NpgsqlDbType.Text).Value = v_diachi;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(v_mmyy, ex.Message, m_computername, "bhytds");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public void upd_done_d_tienthuoc(string v_mabn, string v_maql, string v_mabd, string v_denngay)
        {
            try
            {
                string sql = "";
                foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
                {
                    sql = "update " + r["schemaname"].ToString() + ".d_tienthuoc set done=1 where mabn='" + v_mabn + "' and maql=" + v_maql + " and mabd in(" + v_mabd.Trim(',') + ")";
                    if (v_denngay.Trim().Length == 10)
                    {
                        sql += " and to_date(to_char(ngay,'dd/mm/yyyy'),'dd/mm/yyyy')<=to_date('" + v_denngay + "','dd/mm/yyyy')";
                    }
                    execute_data(sql);
                }
            }
            catch
            {
            }
        }
        public void upd_done_d_tienthuoc(string v_mabn, string v_maql, string v_mabd, string v_denngay, DateTime v_tn, DateTime v_dn)
        {
            try
            {
                string sql = "";
                foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
                {
                    v_tn = v_tn.AddMonths(-1);
                    v_dn = v_dn.AddMonths(1);
                    while (DateTime.Compare(v_tn, v_dn) <= 0)// (v_tn  <= v_dn )
                    {
                        if (s_schema_mmyy(v_tn.Month.ToString().PadLeft(2, '0') + v_tn.Year.ToString().PadLeft(4, '0').Substring(2)).ToLower().Trim() == r["schemaname"].ToString().ToLower().Trim())
                        {
                            sql = "update " + r["schemaname"].ToString() + ".d_tienthuoc set done=1 where mabn='" + v_mabn + "' and maql=" + v_maql + " and mabd in(" + v_mabd.Trim(',') + ")";
                            if (v_denngay.Trim().Length == 10)
                            {
                                sql += " and to_date(to_char(ngay,'dd/mm/yyyy'),'dd/mm/yyyy')<=to_date('" + v_denngay + "','dd/mm/yyyy')";
                            }
                            execute_data(sql);
                        }
                        v_tn = v_tn.AddMonths(1);
                    }
                }
            }
            catch
            {
            }
        }
        public void upd_done_d_tienthuoc_maql(string v_mabn, string v_maql, string v_denngay)
        {
            try
            {
                string sql = "";
                foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
                {
                    try
                    {
                        sql = "update " + r["schemaname"].ToString() + ".d_tienthuoc set done=1 where mabn='" + v_mabn + "' and maql=" + v_maql;
                        if (v_denngay.Trim().Length == 10)
                        {
                            sql += " and to_date(to_char(ngay,'dd/mm/yyyy'),'dd/mm/yyyy')<=to_date('" + v_denngay + "','dd/mm/yyyy')";
                        }
                        execute_data(sql);
                    }
                    catch
                    {
                    }
                }
            }
            catch
            {
            }
        }
        public void upd_done_d_tienthuoc_maql(string v_mabn, string v_maql, string v_denngay, DateTime v_tn, DateTime v_dn)
        {
            try
            {
                string sql = "update d_tienthuoc set done=1 where mabn='" + v_mabn + "' and maql=" + v_maql;
                if (v_denngay.Trim().Length == 10)
                {
                    sql += " and to_date(to_char(ngay,'dd/mm/yyyy'),'dd/mm/yyyy')<=to_date('" + v_denngay + "','dd/mm/yyyy')";
                }
                foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
                {
                    v_tn = v_tn.AddMonths(-1);
                    v_dn = v_dn.AddMonths(1);
                    while (DateTime.Compare(v_tn, v_dn) <= 0)//(v_tn  <= v_dn )
                    {
                        if (s_schema_mmyy(v_tn.Month.ToString().PadLeft(2, '0') + v_tn.Year.ToString().PadLeft(4, '0').Substring(2)).ToLower().Trim() == r["schemaname"].ToString().ToLower().Trim())
                        {
                            sql = "update " + r["schemaname"].ToString() + ".d_tienthuoc set done=1 where mabn='" + v_mabn + "' and maql=" + v_maql;
                            if (v_denngay.Trim().Length == 10)
                            {
                                sql += " and to_date(to_char(ngay,'dd/mm/yyyy'),'dd/mm/yyyy')<=to_date('" + v_denngay + "','dd/mm/yyyy')";
                            }
                            execute_data(sql);
                        }
                        v_tn = v_tn.AddMonths(1);
                    }
                }
            }
            catch
            {
            }
        }
        public void upd_done_d_tienthuoc_in(string v_mabn, string v_maql, string v_mabd, string v_rowid, string v_mmyy, DateTime v_tn, DateTime v_dn)
        {
            try
            {
                string sql = "";
                foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
                {
                    while (DateTime.Compare(v_tn, v_dn) <= 0)//(v_tn  <= v_dn )
                    {
                        if (s_schema_mmyy(v_tn.Month.ToString().PadLeft(2, '0') + v_tn.Year.ToString().PadLeft(4, '0').Substring(2)).ToLower().Trim() == r["schemaname"].ToString().ToLower().Trim())
                        {
                            sql = "update " + r["schemaname"].ToString() + ".d_tienthuoc set done=1 where mabn='" + v_mabn + "' and maql=" + v_maql + " and mabd in(" + v_mabd.Trim(',') + ")";
                            if (v_rowid != "")
                            {
                                sql += " and rowid in (" + v_rowid + ")";
                            }
                            if (v_mmyy != "")
                            {
                                sql += " and to_char(ngay,'mmyy') in (" + v_mmyy + ")";
                            }
                            execute_data(sql);
                        }
                        v_tn = v_tn.AddMonths(1);
                    }
                }
            }
            catch
            {
            }
        }
        public void upd_done_v_vpkhoa(string v_mabn, string v_maql, string v_mavp, string v_denngay)
        {
            try
            {
                string sql = "";
                foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
                {
                    try
                    {
                        sql = "update v_vpkhoa set done=1 where mabn='" + v_mabn + "' and maql=" + v_maql + " and mavp in(" + v_mavp.Trim(',') + ")";
                        if (v_denngay.Length == 10)
                        {
                            sql += " and to_date(to_char(ngay,'dd/mm/yyyy'),'dd/mm/yyyy')<=to_date('" + v_denngay + "','dd/mm/yyyy')";
                        }
                        execute_data(sql);
                    }
                    catch
                    {
                    }
                }
            }
            catch
            {
            }
        }
        public void upd_done_v_vpkhoa_maql(string v_mabn, string v_maql, string v_denngay)
        {
            try
            {
                string sql = "";
                foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
                {
                    try
                    {
                        sql = "update " + r["schemaname"].ToString() + ".v_vpkhoa set done=1 where mabn='" + v_mabn + "' and maql=" + v_maql;
                        if (v_denngay.Length == 10)
                        {
                            sql += " and to_date(to_char(ngay,'dd/mm/yyyy'),'dd/mm/yyyy')<=to_date('" + v_denngay + "','dd/mm/yyyy')";
                        }
                        execute_data(sql);
                    }
                    catch
                    {
                    }
                }
            }
            catch
            {
            }
        }
        public void upd_done_v_vpkhoa_in(string v_mabn, string v_maql, string v_mavp, string v_rowid, string v_mmyy)
        {
            try
            {
                string sql = "";
                foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
                {
                    try
                    {
                        sql = "update " + r["schemaname"].ToString() + ".v_vpkhoa set done=1 where mabn='" + v_mabn + "' and maql=" + v_maql + " and mavp in(" + v_mavp.Trim(',') + ")";
                        if (v_rowid != "")
                        {
                            sql += " and rowid in (" + v_rowid + ")";
                        }
                        if (v_mmyy != "")
                        {
                            sql += " and to_char(ngay,'mmyy') in (" + v_mmyy + ")";
                        }
                        execute_data(sql);
                    }
                    catch
                    {
                    }
                }
            }
            catch
            {
            }
        }
        public void upd_paid_v_chidinh(string v_mabn, string v_maql, string v_mavp, string v_denngay)
        {
            try
            {
                string sql = "";
                foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
                {
                    try
                    {
                        sql = "update " + r["schemaname"].ToString() + ".v_chidinh set paid=1 where mabn='" + v_mabn + "' and maql=" + v_maql + " and mavp in(" + v_mavp.Trim(',') + ")";
                        if (v_denngay.Length == 10)
                        {
                            sql += " and to_date(to_char(ngay,'dd/mm/yyyy'),'dd/mm/yyyy')<=to_date('" + v_denngay + "','dd/mm/yyyy')";
                        }
                        execute_data(sql);
                    }
                    catch
                    {
                    }
                }
            }
            catch
            {
            }
        }
        public void upd_tamung_v_ttrvll(string v_id_tamung, string v_id_ttrv_delimiter)
        {
            try
            {
                if (v_id_tamung.Trim() == "" || v_id_ttrv_delimiter.Trim() == "") return;
                string sql = "";
                foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
                {
                    sql = "update " + r["schemaname"].ToString() + ".v_tamung set done=1, idttrv=" + v_id_ttrv_delimiter + " where id in(" + v_id_tamung.Trim(',') + ")";
                    execute_data(sql);
                }
            }
            catch
            {
            }
        }
        public bool upd_v_thongso(decimal v_id, string v_loai, string v_ten)
        {
            sql = "update " + s_schemaroot + ".v_thongso set loai=:v_loai, ten=:v_ten where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_loai", NpgsqlDbType.Text, 50).Value = v_loai;
            cmd.Parameters.Add("v_ten", NpgsqlDbType.Text, 100).Value = v_ten;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schemaroot + ".v_thongso(id,loai,ten) values(:v_id,:v_loai,:v_ten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_loai", NpgsqlDbType.Text, 50).Value = v_loai;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text, 100).Value = v_ten;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_thongso");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_v_quyenso(decimal v_id, string v_sohieubl, string v_sohieu, decimal v_tu, decimal v_den, decimal v_soghi, string v_loai, decimal v_khambenh, decimal v_dangsd, decimal v_userid, string v_ngaylinh10,decimal v_hide)
        {
            sql = "update " + m_db_schemaroot + ".v_quyenso set sohieubl=:v_sohieubl, sohieu=:v_sohieu, tu=:v_tu, den=:v_den, soghi=:v_soghi,loai=:v_loai,khambenh=:v_khambenh,dangsd=:v_dangsd, ngaylinh=to_date(:v_ngaylinh,'dd/mm/yyyy'),userid=:v_userid, ngayud=now(),hide=:v_hide where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_sohieubl", NpgsqlDbType.Varchar, 20).Value = v_sohieubl;
            cmd.Parameters.Add("v_sohieu", NpgsqlDbType.Varchar, 20).Value = v_sohieu;
            cmd.Parameters.Add("v_tu", NpgsqlDbType.Numeric).Value = v_tu;
            cmd.Parameters.Add("v_den", NpgsqlDbType.Numeric).Value = v_den;
            cmd.Parameters.Add("v_soghi", NpgsqlDbType.Numeric).Value = v_soghi;
            cmd.Parameters.Add("v_dangsd", NpgsqlDbType.Numeric).Value = v_dangsd;
            cmd.Parameters.Add("v_loai", NpgsqlDbType.Varchar).Value = v_loai;
            cmd.Parameters.Add("v_khambenh", NpgsqlDbType.Numeric).Value = v_khambenh;
            cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
            cmd.Parameters.Add("v_ngaylinh", NpgsqlDbType.Varchar, 10).Value = v_ngaylinh10;
            cmd.Parameters.Add("v_hide", NpgsqlDbType.Numeric).Value = v_hide;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + m_db_schemaroot + ".v_quyenso(id,sohieu,sohieubl,tu,den,soghi,dangsd,loai,khambenh,ngaylinh,userid,ngayud,hide) values(:v_id,:v_sohieu,:v_sohieubl,:v_tu,:v_den,:v_soghi,:v_dangsd,:v_loai,:v_khambenh,to_date(:v_ngaylinh,'dd/mm/yyyy'),:v_userid,now(),:v_hide)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_sohieubl", NpgsqlDbType.Varchar, 20).Value = v_sohieubl;
                    cmd.Parameters.Add("v_sohieu", NpgsqlDbType.Varchar, 20).Value = v_sohieu;
                    cmd.Parameters.Add("v_tu", NpgsqlDbType.Numeric).Value = v_tu;
                    cmd.Parameters.Add("v_den", NpgsqlDbType.Numeric).Value = v_den;
                    cmd.Parameters.Add("v_soghi", NpgsqlDbType.Numeric).Value = v_soghi;
                    cmd.Parameters.Add("v_dangsd", NpgsqlDbType.Numeric).Value = v_dangsd;
                    cmd.Parameters.Add("v_loai", NpgsqlDbType.Varchar).Value = v_loai;
                    cmd.Parameters.Add("v_khambenh", NpgsqlDbType.Numeric).Value = v_khambenh;
                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                    cmd.Parameters.Add("v_ngaylinh", NpgsqlDbType.Varchar, 10).Value = v_ngaylinh10;
                    cmd.Parameters.Add("v_hide", NpgsqlDbType.Numeric).Value = v_hide;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_quyenso");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public void upd_v_quyenso(decimal v_id, decimal v_soghi, bool v_valid)
        {
            try
            {
                string sql = "update medibv.v_quyenso set soghi = " + v_soghi + " where id = " + v_id.ToString();
                if (v_valid)
                {
                    sql += " and soghi <" + v_soghi.ToString();
                }
                execute_data(sql);
            }
            catch
            {
            }
        }
        public bool upd_v_loaivp(decimal v_id, decimal v_id_nhom, decimal v_stt, string v_ma, string v_ten, string v_viettat, decimal v_userid, string v_computer, decimal v_readonly, string v_comguuTN)
        {
            sql = "update " + m_db_schemaroot + ".v_loaivp set id_nhom=:v_id_nhom, stt=:v_stt, ma=:v_ma,ten=:v_ten,viettat=:v_viettat,userid=:v_userid, computer=:v_computer,computervp=:v_comguuTN, readonly=:v_readonly,ngayud=now() where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_id_nhom", NpgsqlDbType.Numeric).Value = v_id_nhom;
            cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
            cmd.Parameters.Add("v_ma", NpgsqlDbType.Text).Value = v_ma;
            cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
            cmd.Parameters.Add("v_viettat", NpgsqlDbType.Text).Value = v_viettat;
            cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
            cmd.Parameters.Add("v_computer", NpgsqlDbType.Varchar, 20).Value = v_computer;
            cmd.Parameters.Add("v_readonly", NpgsqlDbType.Numeric).Value = v_readonly;
            cmd.Parameters.Add("v_comguuTN", NpgsqlDbType.Varchar, 20).Value = v_comguuTN;
            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + m_db_schemaroot + ".v_loaivp(id,id_nhom,stt,ma,ten,viettat,userid,computer,readonly,ngayud,computervp) values(:v_id,:v_id_nhom,:v_stt,:v_ma,:v_ten,:v_viettat,:v_userid,:v_computer,:v_readonly,now(),:v_comguuTN)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_id_nhom", NpgsqlDbType.Numeric).Value = v_id_nhom;
                    cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
                    cmd.Parameters.Add("v_ma", NpgsqlDbType.Text).Value = v_ma;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
                    cmd.Parameters.Add("v_viettat", NpgsqlDbType.Text).Value = v_viettat;
                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                    cmd.Parameters.Add("v_computer", NpgsqlDbType.Varchar, 20).Value = v_computer;
                    cmd.Parameters.Add("v_readonly", NpgsqlDbType.Numeric).Value = v_readonly;
                    cmd.Parameters.Add("v_comguuTN", NpgsqlDbType.Varchar, 20).Value = v_comguuTN;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_loaivp");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_v_loaivp(decimal v_id, string v_computer)
        {
            sql = "update " + m_db_schemaroot + ".v_loaivp set computer=:v_computer where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_computer", NpgsqlDbType.Varchar, 20).Value = v_computer;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_loaivp");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_v_giavp(decimal v_id, decimal v_id_loai, decimal v_stt, string v_ma, string v_ten, string v_dvt, decimal v_gia_th, decimal v_gia_bh, decimal v_gia_dv, decimal v_gia_nn, decimal v_gia_cs, decimal v_vattu_th, decimal v_vattu_bh, decimal v_vattu_dv, decimal v_vattu_nn, decimal v_vattu_cs, decimal v_bhyt, decimal v_loaibn, decimal v_theobs, decimal v_thuong, decimal v_trongoi, decimal v_loaitrongoi, decimal v_chenhlech, decimal v_ndm, string v_locthe, decimal v_readonly, decimal v_userid, decimal v_tylekhuyenmai, decimal v_gia_ksk, decimal v_vattu_ksk, decimal v_hide, decimal v_kythuat, string v_sothe)
        {
            sql = "update " + m_db_schemaroot + ".v_giavp" + s_dblink + " set id_loai=:v_id_loai, stt=:v_stt, ma=:v_ma,ten=:v_ten,dvt=:v_dvt,gia_th=:v_gia_th,gia_bh=:v_gia_bh,gia_dv=:v_gia_dv, gia_nn=:v_gia_nn, gia_cs=:v_gia_cs, vattu_th=:v_vattu_th,vattu_bh=:v_vattu_bh,vattu_dv=:v_vattu_dv,vattu_nn=:v_vattu_nn,vattu_cs=:v_vattu_cs,bhyt=:v_bhyt,loaibn=:v_loaibn,theobs=:v_theobs,thuong=:v_thuong,trongoi=:v_trongoi,chenhlech=:v_chenhlech,ndm=:v_ndm, locthe=:v_locthe,readonly=:v_readonly, userid=:v_userid,tylekhuyenmai=:v_tylekhuyenmai,gia_ksk=:v_gia_ksk,vattu_ksk=:v_vattu_ksk,hide=:v_hide,kythuat=:v_kythuat,ngayud=now(), sothe=:v_sothe where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id_loai", NpgsqlDbType.Numeric).Value = v_id_loai;
            cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
            cmd.Parameters.Add("v_ma", NpgsqlDbType.Text, 50).Value = v_ma;
            cmd.Parameters.Add("v_ten", NpgsqlDbType.Text, 100).Value = v_ten;
            cmd.Parameters.Add("v_dvt", NpgsqlDbType.Text, 20).Value = v_dvt;
            cmd.Parameters.Add("v_gia_th", NpgsqlDbType.Numeric).Value = v_gia_th;
            cmd.Parameters.Add("v_gia_bh", NpgsqlDbType.Numeric).Value = v_gia_bh;
            cmd.Parameters.Add("v_gia_dv", NpgsqlDbType.Numeric).Value = v_gia_dv;
            cmd.Parameters.Add("v_gia_nn", NpgsqlDbType.Numeric).Value = v_gia_nn;
            cmd.Parameters.Add("v_gia_cs", NpgsqlDbType.Numeric).Value = v_gia_cs;
            cmd.Parameters.Add("v_gia_ksk", NpgsqlDbType.Numeric).Value = v_gia_ksk;
            cmd.Parameters.Add("v_vattu_th", NpgsqlDbType.Numeric).Value = v_vattu_th;
            cmd.Parameters.Add("v_vattu_bh", NpgsqlDbType.Numeric).Value = v_vattu_bh;
            cmd.Parameters.Add("v_vattu_dv", NpgsqlDbType.Numeric).Value = v_vattu_dv;
            cmd.Parameters.Add("v_vattu_nn", NpgsqlDbType.Numeric).Value = v_vattu_nn;
            cmd.Parameters.Add("v_vattu_cs", NpgsqlDbType.Numeric).Value = v_vattu_cs;
            cmd.Parameters.Add("v_vattu_ksk", NpgsqlDbType.Numeric).Value = v_vattu_ksk;
            cmd.Parameters.Add("v_bhyt", NpgsqlDbType.Numeric).Value = v_bhyt;
            cmd.Parameters.Add("v_loaibn", NpgsqlDbType.Numeric).Value = v_loaibn;
            cmd.Parameters.Add("v_theobs", NpgsqlDbType.Numeric).Value = v_theobs;
            cmd.Parameters.Add("v_thuong", NpgsqlDbType.Numeric).Value = v_thuong;
            cmd.Parameters.Add("v_trongoi", NpgsqlDbType.Numeric).Value = v_trongoi;
            cmd.Parameters.Add("v_loaitrongoi", NpgsqlDbType.Numeric).Value = v_loaitrongoi;
            cmd.Parameters.Add("v_chenhlech", NpgsqlDbType.Numeric).Value = v_chenhlech;
            cmd.Parameters.Add("v_locthe", NpgsqlDbType.Text).Value = v_locthe;
            cmd.Parameters.Add("v_ndm", NpgsqlDbType.Numeric).Value = v_ndm;
            cmd.Parameters.Add("v_readonly", NpgsqlDbType.Numeric).Value = v_readonly;
            cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
            cmd.Parameters.Add("v_tylekhuyenmai", NpgsqlDbType.Numeric).Value = v_tylekhuyenmai;
            cmd.Parameters.Add("v_hide", NpgsqlDbType.Numeric).Value = v_hide;
            cmd.Parameters.Add("v_kythuat", NpgsqlDbType.Numeric).Value = v_kythuat;
            cmd.Parameters.Add("v_sothe", NpgsqlDbType.Text, 100).Value = v_sothe;
            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + m_db_schemaroot + ".v_giavp" + s_dblink + "(id,id_loai,stt,ma,ten,dvt,gia_th,gia_bh,gia_dv,gia_nn,gia_cs,vattu_th,vattu_bh,vattu_dv,vattu_nn,vattu_cs,bhyt,loaibn,theobs,thuong,trongoi,loaitrongoi,locthe,chenhlech,ndm,readonly,userid,tylekhuyenmai,gia_ksk,vattu_ksk,hide,kythuat, sothe) values(:v_id,:v_id_loai,:v_stt,:v_ma,:v_ten,:v_dvt,:v_gia_th,:v_gia_bh,:v_gia_dv,:v_gia_nn,:v_gia_cs,:v_vattu_th,:v_vattu_bh,:v_vattu_dv,:v_vattu_nn,:v_vattu_cs,:v_bhyt,:v_loaibn,:v_theobs,:v_thuong,:v_trongoi,:v_loaitrongoi,:v_locthe,:v_chenhlech,:v_ndm,:v_readonly,:v_userid,:v_tylekhuyenmai,:v_gia_ksk,:v_vattu_ksk,:v_hide,:v_kythuat,:v_sothe)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_id_loai", NpgsqlDbType.Numeric).Value = v_id_loai;
                    cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
                    cmd.Parameters.Add("v_ma", NpgsqlDbType.Text, 50).Value = v_ma;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text, 100).Value = v_ten;
                    cmd.Parameters.Add("v_dvt", NpgsqlDbType.Text, 20).Value = v_dvt;
                    cmd.Parameters.Add("v_gia_th", NpgsqlDbType.Numeric).Value = v_gia_th;
                    cmd.Parameters.Add("v_gia_bh", NpgsqlDbType.Numeric).Value = v_gia_bh;
                    cmd.Parameters.Add("v_gia_dv", NpgsqlDbType.Numeric).Value = v_gia_dv;
                    cmd.Parameters.Add("v_gia_nn", NpgsqlDbType.Numeric).Value = v_gia_nn;
                    cmd.Parameters.Add("v_gia_cs", NpgsqlDbType.Numeric).Value = v_gia_cs;
                    cmd.Parameters.Add("v_gia_ksk", NpgsqlDbType.Numeric).Value = v_gia_ksk;
                    cmd.Parameters.Add("v_vattu_th", NpgsqlDbType.Numeric).Value = v_vattu_th;
                    cmd.Parameters.Add("v_vattu_bh", NpgsqlDbType.Numeric).Value = v_vattu_bh;
                    cmd.Parameters.Add("v_vattu_dv", NpgsqlDbType.Numeric).Value = v_vattu_dv;
                    cmd.Parameters.Add("v_vattu_nn", NpgsqlDbType.Numeric).Value = v_vattu_nn;
                    cmd.Parameters.Add("v_vattu_cs", NpgsqlDbType.Numeric).Value = v_vattu_cs;
                    cmd.Parameters.Add("v_vattu_ksk", NpgsqlDbType.Numeric).Value = v_vattu_ksk;
                    cmd.Parameters.Add("v_bhyt", NpgsqlDbType.Numeric).Value = v_bhyt;
                    cmd.Parameters.Add("v_loaibn", NpgsqlDbType.Numeric).Value = v_loaibn;
                    cmd.Parameters.Add("v_theobs", NpgsqlDbType.Numeric).Value = v_theobs;
                    cmd.Parameters.Add("v_thuong", NpgsqlDbType.Numeric).Value = v_thuong;
                    cmd.Parameters.Add("v_trongoi", NpgsqlDbType.Numeric).Value = v_trongoi;
                    cmd.Parameters.Add("v_loaitrongoi", NpgsqlDbType.Numeric).Value = v_loaitrongoi;
                    cmd.Parameters.Add("v_chenhlech", NpgsqlDbType.Numeric).Value = v_chenhlech;
                    cmd.Parameters.Add("v_locthe", NpgsqlDbType.Text).Value = v_locthe;
                    cmd.Parameters.Add("v_ndm", NpgsqlDbType.Numeric).Value = v_ndm;
                    cmd.Parameters.Add("v_readonly", NpgsqlDbType.Numeric).Value = v_readonly;
                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                    cmd.Parameters.Add("v_tylekhuyenmai", NpgsqlDbType.Numeric).Value = v_tylekhuyenmai;
                    cmd.Parameters.Add("v_hide", NpgsqlDbType.Numeric).Value = v_hide;
                    cmd.Parameters.Add("v_kythuat", NpgsqlDbType.Numeric).Value = v_kythuat;
                    cmd.Parameters.Add("v_sothe", NpgsqlDbType.Text, 100).Value = v_sothe;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_giavp");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            //execute_data("update medibv.v_giavp set locthe=null where locthe=''");
            return true;
        }
        public bool upd_v_giavp(decimal v_id, decimal v_id_loai, decimal v_stt, string v_ma, string v_ten, string v_dvt, decimal v_gia_th, decimal v_gia_bh, decimal v_gia_dv, decimal v_gia_nn, decimal v_gia_cs, decimal v_vattu_th, decimal v_vattu_bh, decimal v_vattu_dv, decimal v_vattu_nn, decimal v_vattu_cs, decimal v_bhyt, decimal v_loaibn, decimal v_theobs, decimal v_thuong, decimal v_trongoi, decimal v_loaitrongoi, decimal v_chenhlech, decimal v_ndm, string v_locthe, decimal v_readonly, decimal v_userid, decimal v_tylekhuyenmai, decimal v_gia_ksk, decimal v_vattu_ksk, decimal v_hide, decimal v_kythuat, string v_sothe, decimal v_vat, decimal v_kcct, decimal v_bhyt_tt, decimal v_tuyentw, decimal v_tuyentinh, decimal v_tuyenhuyen, decimal v_tuyenxa, decimal v_dichvu, decimal v_hoichan, decimal v_giaycamdoan, string v_tgtrakq, string v_gioitinh, decimal v_tutuoi, decimal v_dentuoi, decimal v_batbuocthutien, decimal v_coso, string v_cosothay, string v_phongthuchiencls)
        {
            sql = "update " + m_db_schemaroot + ".v_giavp" + s_dblink + " set id_loai=:v_id_loai, stt=:v_stt, ma=:v_ma,"+
                "ten=:v_ten,dvt=:v_dvt,gia_th=:v_gia_th,gia_bh=:v_gia_bh,gia_dv=:v_gia_dv, gia_nn=:v_gia_nn, "+
            "gia_cs=:v_gia_cs, vattu_th=:v_vattu_th,vattu_bh=:v_vattu_bh,vattu_dv=:v_vattu_dv,vattu_nn=:v_vattu_nn,"+
            "vattu_cs=:v_vattu_cs,bhyt=:v_bhyt,loaibn=:v_loaibn,theobs=:v_theobs,thuong=:v_thuong,trongoi=:v_trongoi,loaitrongoi=:v_loaitrongoi," +//binh 120711
            "chenhlech=:v_chenhlech,ndm=:v_ndm, locthe=:v_locthe,readonly=:v_readonly, userid=:v_userid,"+
            "tylekhuyenmai=:v_tylekhuyenmai,gia_ksk=:v_gia_ksk,vattu_ksk=:v_vattu_ksk,hide=:v_hide,"+
            "kythuat=:v_kythuat,sothe=:v_sothe,vat=:v_vat,kcct=:v_kcct,bhyt_tt=:v_bhyt_tt,"+
            "tuyentw=:v_tuyentw,tuyentinh=:v_tuyentinh,tuyenhuyen=:v_tuyenhuyen,tuyenxa=:v_tuyenxa,"+
            "dichvu=:v_dichvu,hoichan=:v_hoichan,giaycamdoan=:v_giaycamdoan,tgtrakq=:v_tgtrakq,"+
            "gioitinh=:v_gioitinh,tutuoi=:v_tutuoi,dentuoi=:v_dentuoi,batbuocthutien=:v_batbuocthutien,"+
            "coso=:v_coso,cosothay=:v_cosothay,phongthuchiencls=:v_phongthuchiencls where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;
            cmd.Parameters.Add("v_id_loai", NpgsqlDbType.Numeric,22).Value = v_id_loai;
            cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric,5).Value = v_stt;
            cmd.Parameters.Add("v_ma", NpgsqlDbType.Text, 50).Value = v_ma;
            cmd.Parameters.Add("v_ten", NpgsqlDbType.Text, 100).Value = v_ten;
            cmd.Parameters.Add("v_dvt", NpgsqlDbType.Varchar, 20).Value = v_dvt;
            cmd.Parameters.Add("v_gia_th", NpgsqlDbType.Numeric,10).Value = v_gia_th;
            cmd.Parameters.Add("v_gia_bh", NpgsqlDbType.Numeric, 10).Value = v_gia_bh;
            cmd.Parameters.Add("v_gia_dv", NpgsqlDbType.Numeric, 10).Value = v_gia_dv;
            cmd.Parameters.Add("v_gia_nn", NpgsqlDbType.Numeric, 10).Value = v_gia_nn;
            cmd.Parameters.Add("v_gia_cs", NpgsqlDbType.Numeric, 10).Value = v_gia_cs;
            cmd.Parameters.Add("v_gia_ksk", NpgsqlDbType.Numeric, 10).Value = v_gia_ksk;
            cmd.Parameters.Add("v_vattu_th", NpgsqlDbType.Numeric, 10).Value = v_vattu_th;
            cmd.Parameters.Add("v_vattu_bh", NpgsqlDbType.Numeric, 10).Value = v_vattu_bh;
            cmd.Parameters.Add("v_vattu_dv", NpgsqlDbType.Numeric, 10).Value = v_vattu_dv;
            cmd.Parameters.Add("v_vattu_nn", NpgsqlDbType.Numeric, 10).Value = v_vattu_nn;
            cmd.Parameters.Add("v_vattu_cs", NpgsqlDbType.Numeric, 10).Value = v_vattu_cs;
            cmd.Parameters.Add("v_vattu_ksk", NpgsqlDbType.Numeric, 10).Value = v_vattu_ksk;
            cmd.Parameters.Add("v_bhyt", NpgsqlDbType.Numeric, 3).Value = v_bhyt;
            cmd.Parameters.Add("v_loaibn", NpgsqlDbType.Numeric, 1).Value = v_loaibn;
            cmd.Parameters.Add("v_theobs", NpgsqlDbType.Numeric, 1).Value = v_theobs;
            cmd.Parameters.Add("v_thuong", NpgsqlDbType.Numeric, 1).Value = v_thuong;
            cmd.Parameters.Add("v_trongoi", NpgsqlDbType.Numeric, 1).Value = v_trongoi;
            cmd.Parameters.Add("v_loaitrongoi", NpgsqlDbType.Numeric, 1).Value = v_loaitrongoi;
            cmd.Parameters.Add("v_chenhlech", NpgsqlDbType.Numeric, 1).Value = v_chenhlech;
            cmd.Parameters.Add("v_locthe", NpgsqlDbType.Text).Value = v_locthe;
            cmd.Parameters.Add("v_ndm", NpgsqlDbType.Numeric,1).Value = v_ndm;
            cmd.Parameters.Add("v_readonly", NpgsqlDbType.Numeric,1).Value = v_readonly;
            cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric,7).Value = v_userid;
            cmd.Parameters.Add("v_tylekhuyenmai", NpgsqlDbType.Numeric,3).Value = v_tylekhuyenmai;
            cmd.Parameters.Add("v_hide", NpgsqlDbType.Numeric,1).Value = v_hide;
            cmd.Parameters.Add("v_kythuat", NpgsqlDbType.Numeric,1).Value = v_kythuat;
            cmd.Parameters.Add("v_sothe", NpgsqlDbType.Varchar, 100).Value = v_sothe;
            
            cmd.Parameters.Add("v_vat", NpgsqlDbType.Numeric,3).Value = v_vat;
            cmd.Parameters.Add("v_kcct", NpgsqlDbType.Numeric,1).Value = v_kcct;
            cmd.Parameters.Add("v_bhyt_tt", NpgsqlDbType.Numeric,1).Value = v_bhyt_tt;
            cmd.Parameters.Add("v_tuyentw", NpgsqlDbType.Numeric,1).Value = v_tuyentw;
            cmd.Parameters.Add("v_tuyentinh", NpgsqlDbType.Numeric,1).Value = v_tuyentinh;
            cmd.Parameters.Add("v_tuyenhuyen", NpgsqlDbType.Numeric,1).Value = v_tuyenhuyen;
            cmd.Parameters.Add("v_tuyenxa", NpgsqlDbType.Numeric,1).Value = v_tuyenxa;
            cmd.Parameters.Add("v_dichvu", NpgsqlDbType.Numeric,1).Value = v_dichvu;
            cmd.Parameters.Add("v_hoichan", NpgsqlDbType.Numeric,1).Value = v_hoichan;
            cmd.Parameters.Add("v_giaycamdoan", NpgsqlDbType.Numeric,1).Value = v_giaycamdoan;
            cmd.Parameters.Add("v_tgtrakq", NpgsqlDbType.Varchar, 5).Value = v_tgtrakq;
            cmd.Parameters.Add("v_gioitinh", NpgsqlDbType.Varchar, 1).Value = v_gioitinh;
            cmd.Parameters.Add("v_tutuoi", NpgsqlDbType.Numeric,3).Value = v_tutuoi;
            cmd.Parameters.Add("v_dentuoi", NpgsqlDbType.Numeric,3).Value = v_dentuoi;
            cmd.Parameters.Add("v_batbuocthutien", NpgsqlDbType.Numeric,1).Value = v_batbuocthutien;
            cmd.Parameters.Add("v_coso", NpgsqlDbType.Numeric,2).Value = v_coso;
            cmd.Parameters.Add("v_cosothay", NpgsqlDbType.Varchar, 50).Value = v_cosothay;
            cmd.Parameters.Add("v_phongthuchiencls", NpgsqlDbType.Varchar, 50).Value = v_phongthuchiencls;
            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric,22).Value = v_id;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + m_db_schemaroot + ".v_giavp" + s_dblink + "(id,id_loai,stt,ma,ten,dvt,gia_th,gia_bh,"+
                    "gia_dv,gia_nn,gia_cs,vattu_th,vattu_bh,vattu_dv,vattu_nn,vattu_cs,bhyt,loaibn,theobs,thuong,trongoi,loaitrongoi,"+
                    "locthe,chenhlech,ndm,readonly,userid,tylekhuyenmai,gia_ksk,vattu_ksk,hide,kythuat, sothe,vat,kcct,bhyt_tt,tuyentw,"+
                    "tuyentinh,tuyenhuyen,tuyenxa,dichvu,hoichan,giaycamdoan,tgtrakq,gioitinh,tutuoi,dentuoi,batbuocthutien,coso,cosothay,"+
                    "phongthuchiencls) values(:v_id,:v_id_loai,:v_stt,:v_ma,:v_ten,:v_dvt,:v_gia_th,:v_gia_bh,:v_gia_dv,:v_gia_nn,"+
                    ":v_gia_cs,:v_vattu_th,:v_vattu_bh,:v_vattu_dv,:v_vattu_nn,:v_vattu_cs,:v_bhyt,:v_loaibn,:v_theobs,:v_thuong,"+
                    ":v_trongoi,:v_loaitrongoi,:v_locthe,:v_chenhlech,:v_ndm,:v_readonly,:v_userid,:v_tylekhuyenmai,:v_gia_ksk,"+
                    ":v_vattu_ksk,:v_hide,:v_kythuat,:v_sothe,:v_vat,:v_kcct,:v_bhyt_tt,:v_tuyentw,:v_tuyentinh,:v_tuyenhuyen,"+
                    ":v_tuyenxa,:v_dichvu,:v_hoichan,:v_giaycamdoan,:v_tgtrakq,:v_gioitinh,:v_tutuoi,:v_dentuoi,:v_batbuocthutien,"+
                    ":v_coso,:v_cosothay,:v_phongthuchiencls)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_id_loai", NpgsqlDbType.Numeric).Value = v_id_loai;
                    cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
                    cmd.Parameters.Add("v_ma", NpgsqlDbType.Text, 20).Value = v_ma;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text, 100).Value = v_ten;
                    cmd.Parameters.Add("v_dvt", NpgsqlDbType.Text, 20).Value = v_dvt;
                    cmd.Parameters.Add("v_gia_th", NpgsqlDbType.Numeric).Value = v_gia_th;
                    cmd.Parameters.Add("v_gia_bh", NpgsqlDbType.Numeric).Value = v_gia_bh;
                    cmd.Parameters.Add("v_gia_dv", NpgsqlDbType.Numeric).Value = v_gia_dv;
                    cmd.Parameters.Add("v_gia_nn", NpgsqlDbType.Numeric).Value = v_gia_nn;
                    cmd.Parameters.Add("v_gia_cs", NpgsqlDbType.Numeric).Value = v_gia_cs;
                    cmd.Parameters.Add("v_gia_ksk", NpgsqlDbType.Numeric).Value = v_gia_ksk;
                    cmd.Parameters.Add("v_vattu_th", NpgsqlDbType.Numeric).Value = v_vattu_th;
                    cmd.Parameters.Add("v_vattu_bh", NpgsqlDbType.Numeric).Value = v_vattu_bh;
                    cmd.Parameters.Add("v_vattu_dv", NpgsqlDbType.Numeric).Value = v_vattu_dv;
                    cmd.Parameters.Add("v_vattu_nn", NpgsqlDbType.Numeric).Value = v_vattu_nn;
                    cmd.Parameters.Add("v_vattu_cs", NpgsqlDbType.Numeric).Value = v_vattu_cs;
                    cmd.Parameters.Add("v_vattu_ksk", NpgsqlDbType.Numeric).Value = v_vattu_ksk;
                    cmd.Parameters.Add("v_bhyt", NpgsqlDbType.Numeric).Value = v_bhyt;
                    cmd.Parameters.Add("v_loaibn", NpgsqlDbType.Numeric).Value = v_loaibn;
                    cmd.Parameters.Add("v_theobs", NpgsqlDbType.Numeric).Value = v_theobs;
                    cmd.Parameters.Add("v_thuong", NpgsqlDbType.Numeric).Value = v_thuong;
                    cmd.Parameters.Add("v_trongoi", NpgsqlDbType.Numeric).Value = v_trongoi;
                    cmd.Parameters.Add("v_loaitrongoi", NpgsqlDbType.Numeric).Value = v_loaitrongoi;
                    cmd.Parameters.Add("v_chenhlech", NpgsqlDbType.Numeric).Value = v_chenhlech;
                    cmd.Parameters.Add("v_locthe", NpgsqlDbType.Text).Value = v_locthe;
                    cmd.Parameters.Add("v_ndm", NpgsqlDbType.Numeric).Value = v_ndm;
                    cmd.Parameters.Add("v_readonly", NpgsqlDbType.Numeric).Value = v_readonly;
                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                    cmd.Parameters.Add("v_tylekhuyenmai", NpgsqlDbType.Numeric).Value = v_tylekhuyenmai;
                    cmd.Parameters.Add("v_hide", NpgsqlDbType.Numeric).Value = v_hide;
                    cmd.Parameters.Add("v_kythuat", NpgsqlDbType.Numeric).Value = v_kythuat;
                    cmd.Parameters.Add("v_sothe", NpgsqlDbType.Text, 100).Value = v_sothe;

                    cmd.Parameters.Add("v_vat", NpgsqlDbType.Numeric).Value = v_vat;
                    cmd.Parameters.Add("v_kcct", NpgsqlDbType.Numeric).Value = v_kcct;
                    cmd.Parameters.Add("v_bhyt_tt", NpgsqlDbType.Numeric).Value = v_bhyt_tt;
                    cmd.Parameters.Add("v_tuyentw", NpgsqlDbType.Numeric).Value = v_tuyentw;
                    cmd.Parameters.Add("v_tuyentinh", NpgsqlDbType.Numeric).Value = v_tuyentinh;
                    cmd.Parameters.Add("v_tuyenhuyen", NpgsqlDbType.Numeric).Value = v_tuyenhuyen;
                    cmd.Parameters.Add("v_tuyenxa", NpgsqlDbType.Numeric).Value = v_tuyenxa;
                    cmd.Parameters.Add("v_dichvu", NpgsqlDbType.Numeric).Value = v_dichvu;
                    cmd.Parameters.Add("v_hoichan", NpgsqlDbType.Numeric).Value = v_hoichan;
                    cmd.Parameters.Add("v_giaycamdoan", NpgsqlDbType.Numeric).Value = v_giaycamdoan;
                    cmd.Parameters.Add("v_tgtrakq", NpgsqlDbType.Text, 10).Value = v_tgtrakq;
                    cmd.Parameters.Add("v_gioitinh", NpgsqlDbType.Text, 10).Value = v_gioitinh;
                    cmd.Parameters.Add("v_tutuoi", NpgsqlDbType.Numeric).Value = v_tutuoi;
                    cmd.Parameters.Add("v_dentuoi", NpgsqlDbType.Numeric).Value = v_dentuoi;
                    cmd.Parameters.Add("v_batbuocthutien", NpgsqlDbType.Numeric).Value = v_batbuocthutien;
                    cmd.Parameters.Add("v_coso", NpgsqlDbType.Numeric).Value = v_coso;
                    cmd.Parameters.Add("v_cosothay", NpgsqlDbType.Text, 50).Value = v_cosothay;
                    cmd.Parameters.Add("v_phongthuchiencls", NpgsqlDbType.Text, 50).Value = v_phongthuchiencls;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_giavp");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_v_giavp_client(decimal v_id, decimal v_id_loai, decimal v_stt, string v_ma, string v_ten, string v_dvt, decimal v_gia_th, decimal v_gia_bh, decimal v_gia_dv, decimal v_gia_nn, decimal v_gia_cs, decimal v_vattu_th, decimal v_vattu_bh, decimal v_vattu_dv, decimal v_vattu_nn, decimal v_vattu_cs, decimal v_bhyt, decimal v_loaibn, decimal v_theobs, decimal v_thuong, decimal v_trongoi, decimal v_loaitrongoi, decimal v_chenhlech, decimal v_ndm, string v_locthe, decimal v_readonly, decimal v_userid, decimal v_tylekhuyenmai, decimal v_gia_ksk, decimal v_vattu_ksk, decimal v_hide, decimal v_kythuat, string v_sothe, decimal v_vat, decimal v_kcct, decimal v_bhyt_tt, decimal v_tuyentw, decimal v_tuyentinh, decimal v_tuyenhuyen, decimal v_tuyenxa, decimal v_dichvu, decimal v_hoichan, decimal v_giaycamdoan, string v_tgtrakq, string v_gioitinh, decimal v_tutuoi, decimal v_dentuoi, decimal v_batbuocthutien, decimal v_coso, string v_cosothay, string v_phongthuchiencls, string stendatabase)
        {
            sql = "update " + m_db_schemaroot + ".v_giavp" + stendatabase + " set id_loai=:v_id_loai, stt=:v_stt, ma=:v_ma,ten=:v_ten,dvt=:v_dvt,gia_th=:v_gia_th,gia_bh=:v_gia_bh,gia_dv=:v_gia_dv, gia_nn=:v_gia_nn, gia_cs=:v_gia_cs, vattu_th=:v_vattu_th,vattu_bh=:v_vattu_bh,vattu_dv=:v_vattu_dv,vattu_nn=:v_vattu_nn,vattu_cs=:v_vattu_cs,bhyt=:v_bhyt,loaibn=:v_loaibn,theobs=:v_theobs,thuong=:v_thuong,trongoi=:v_trongoi,chenhlech=:v_chenhlech,ndm=:v_ndm, locthe=:v_locthe,readonly=:v_readonly, userid=:v_userid,tylekhuyenmai=:v_tylekhuyenmai,gia_ksk=:v_gia_ksk,vattu_ksk=:v_vattu_ksk,hide=:v_hide,kythuat=:v_kythuat,ngayud=now(), sothe=:v_sothe,vat=:v_vat,kcct=:v_kcct,bhyt_tt=:v_bhyt_tt,tuyentw=:v_tuyentw,tuyentinh=:v_tuyentinh,tuyenhuyen=:v_tuyenhuyen,tuyenxa=:v_tuyenxa,dichvu=:v_dichvu,hoichan=:v_hoichan,giaycamdoan=:v_giaycamdoan,tgtrakq=:v_tgtrakq,gioitinh=:v_gioitinh,tutuoi=:v_tutuoi,dentuoi=:v_dentuoi,batbuocthutien=:v_batbuocthutien,coso=:v_coso,cosothay=:v_cosothay,phongthuchiencls=:v_phongthuchiencls where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;
            cmd.Parameters.Add("v_id_loai", NpgsqlDbType.Numeric).Value = v_id_loai;
            cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
            cmd.Parameters.Add("v_ma", NpgsqlDbType.Text, 50).Value = v_ma;
            cmd.Parameters.Add("v_ten", NpgsqlDbType.Text, 100).Value = v_ten;
            cmd.Parameters.Add("v_dvt", NpgsqlDbType.Text, 20).Value = v_dvt;
            cmd.Parameters.Add("v_gia_th", NpgsqlDbType.Numeric).Value = v_gia_th;
            cmd.Parameters.Add("v_gia_bh", NpgsqlDbType.Numeric).Value = v_gia_bh;
            cmd.Parameters.Add("v_gia_dv", NpgsqlDbType.Numeric).Value = v_gia_dv;
            cmd.Parameters.Add("v_gia_nn", NpgsqlDbType.Numeric).Value = v_gia_nn;
            cmd.Parameters.Add("v_gia_cs", NpgsqlDbType.Numeric).Value = v_gia_cs;
            cmd.Parameters.Add("v_gia_ksk", NpgsqlDbType.Numeric).Value = v_gia_ksk;
            cmd.Parameters.Add("v_vattu_th", NpgsqlDbType.Numeric).Value = v_vattu_th;
            cmd.Parameters.Add("v_vattu_bh", NpgsqlDbType.Numeric).Value = v_vattu_bh;
            cmd.Parameters.Add("v_vattu_dv", NpgsqlDbType.Numeric).Value = v_vattu_dv;
            cmd.Parameters.Add("v_vattu_nn", NpgsqlDbType.Numeric).Value = v_vattu_nn;
            cmd.Parameters.Add("v_vattu_cs", NpgsqlDbType.Numeric).Value = v_vattu_cs;
            cmd.Parameters.Add("v_vattu_ksk", NpgsqlDbType.Numeric).Value = v_vattu_ksk;
            cmd.Parameters.Add("v_bhyt", NpgsqlDbType.Numeric).Value = v_bhyt;
            cmd.Parameters.Add("v_loaibn", NpgsqlDbType.Numeric).Value = v_loaibn;
            cmd.Parameters.Add("v_theobs", NpgsqlDbType.Numeric).Value = v_theobs;
            cmd.Parameters.Add("v_thuong", NpgsqlDbType.Numeric).Value = v_thuong;
            cmd.Parameters.Add("v_trongoi", NpgsqlDbType.Numeric).Value = v_trongoi;
            cmd.Parameters.Add("v_loaitrongoi", NpgsqlDbType.Numeric).Value = v_loaitrongoi;
            cmd.Parameters.Add("v_chenhlech", NpgsqlDbType.Numeric).Value = v_chenhlech;
            cmd.Parameters.Add("v_locthe", NpgsqlDbType.Text).Value = v_locthe;
            cmd.Parameters.Add("v_ndm", NpgsqlDbType.Numeric).Value = v_ndm;
            cmd.Parameters.Add("v_readonly", NpgsqlDbType.Numeric).Value = v_readonly;
            cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
            cmd.Parameters.Add("v_tylekhuyenmai", NpgsqlDbType.Numeric).Value = v_tylekhuyenmai;
            cmd.Parameters.Add("v_hide", NpgsqlDbType.Numeric).Value = v_hide;
            cmd.Parameters.Add("v_kythuat", NpgsqlDbType.Numeric).Value = v_kythuat;
            cmd.Parameters.Add("v_sothe", NpgsqlDbType.Text, 100).Value = v_sothe;

            cmd.Parameters.Add("v_vat", NpgsqlDbType.Numeric).Value = v_vat;
            cmd.Parameters.Add("v_kcct", NpgsqlDbType.Numeric).Value = v_kcct;
            cmd.Parameters.Add("v_bhyt_tt", NpgsqlDbType.Numeric).Value = v_bhyt_tt;
            cmd.Parameters.Add("v_tuyentw", NpgsqlDbType.Numeric).Value = v_tuyentw;
            cmd.Parameters.Add("v_tuyentinh", NpgsqlDbType.Numeric).Value = v_tuyentinh;
            cmd.Parameters.Add("v_tuyenhuyen", NpgsqlDbType.Numeric).Value = v_tuyenhuyen;
            cmd.Parameters.Add("v_tuyenxa", NpgsqlDbType.Numeric).Value = v_tuyenxa;
            cmd.Parameters.Add("v_dichvu", NpgsqlDbType.Numeric).Value = v_dichvu;
            cmd.Parameters.Add("v_hoichan", NpgsqlDbType.Numeric).Value = v_hoichan;
            cmd.Parameters.Add("v_giaycamdoan", NpgsqlDbType.Numeric).Value = v_giaycamdoan;
            cmd.Parameters.Add("v_tgtrakq", NpgsqlDbType.Text, 10).Value = v_tgtrakq;
            cmd.Parameters.Add("v_gioitinh", NpgsqlDbType.Text, 10).Value = v_gioitinh;
            cmd.Parameters.Add("v_tutuoi", NpgsqlDbType.Numeric).Value = v_tutuoi;
            cmd.Parameters.Add("v_dentuoi", NpgsqlDbType.Numeric).Value = v_dentuoi;
            cmd.Parameters.Add("v_batbuocthutien", NpgsqlDbType.Numeric).Value = v_batbuocthutien;
            cmd.Parameters.Add("v_coso", NpgsqlDbType.Numeric).Value = v_coso;
            cmd.Parameters.Add("v_cosothay", NpgsqlDbType.Text, 50).Value = v_cosothay;
            cmd.Parameters.Add("v_phongthuchiencls", NpgsqlDbType.Text, 50).Value = v_phongthuchiencls;
            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + m_db_schemaroot + ".v_giavp" + stendatabase + "(id,id_loai,stt,ma,ten,dvt,gia_th,gia_bh,gia_dv,gia_nn,gia_cs,vattu_th,vattu_bh,vattu_dv,vattu_nn,vattu_cs,bhyt,loaibn,theobs,thuong,trongoi,loaitrongoi,locthe,chenhlech,ndm,readonly,userid,tylekhuyenmai,gia_ksk,vattu_ksk,hide,kythuat, sothe,vat,kcct,bhyt_tt,tuyentw,tuyentinh,tuyenhuyen,tuyenxa,dichvu,hoichan,giaycamdoan,tgtrakq,gioitinh,tutuoi,dentuoi,batbuocthutien,coso,cosothay,phongthuchiencls) values(:v_id,:v_id_loai,:v_stt,:v_ma,:v_ten,:v_dvt,:v_gia_th,:v_gia_bh,:v_gia_dv,:v_gia_nn,:v_gia_cs,:v_vattu_th,:v_vattu_bh,:v_vattu_dv,:v_vattu_nn,:v_vattu_cs,:v_bhyt,:v_loaibn,:v_theobs,:v_thuong,:v_trongoi,:v_loaitrongoi,:v_locthe,:v_chenhlech,:v_ndm,:v_readonly,:v_userid,:v_tylekhuyenmai,:v_gia_ksk,:v_vattu_ksk,:v_hide,:v_kythuat,:v_sothe,:v_vat,:v_kcct,:v_bhyt_tt,:v_tuyentw,:v_tuyentinh,:v_tuyenhuyen,:v_tuyenxa,:v_dichvu,:v_hoichan,:v_giaycamdoan,:v_tgtrakq,:v_gioitinh,:v_tutuoi,:v_dentuoi,:v_batbuocthutien,:v_coso,:v_cosothay,:v_phongthuchiencls)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_id_loai", NpgsqlDbType.Numeric).Value = v_id_loai;
                    cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
                    cmd.Parameters.Add("v_ma", NpgsqlDbType.Text, 50).Value = v_ma;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text, 100).Value = v_ten;
                    cmd.Parameters.Add("v_dvt", NpgsqlDbType.Text, 20).Value = v_dvt;
                    cmd.Parameters.Add("v_gia_th", NpgsqlDbType.Numeric).Value = v_gia_th;
                    cmd.Parameters.Add("v_gia_bh", NpgsqlDbType.Numeric).Value = v_gia_bh;
                    cmd.Parameters.Add("v_gia_dv", NpgsqlDbType.Numeric).Value = v_gia_dv;
                    cmd.Parameters.Add("v_gia_nn", NpgsqlDbType.Numeric).Value = v_gia_nn;
                    cmd.Parameters.Add("v_gia_cs", NpgsqlDbType.Numeric).Value = v_gia_cs;
                    cmd.Parameters.Add("v_gia_ksk", NpgsqlDbType.Numeric).Value = v_gia_ksk;
                    cmd.Parameters.Add("v_vattu_th", NpgsqlDbType.Numeric).Value = v_vattu_th;
                    cmd.Parameters.Add("v_vattu_bh", NpgsqlDbType.Numeric).Value = v_vattu_bh;
                    cmd.Parameters.Add("v_vattu_dv", NpgsqlDbType.Numeric).Value = v_vattu_dv;
                    cmd.Parameters.Add("v_vattu_nn", NpgsqlDbType.Numeric).Value = v_vattu_nn;
                    cmd.Parameters.Add("v_vattu_cs", NpgsqlDbType.Numeric).Value = v_vattu_cs;
                    cmd.Parameters.Add("v_vattu_ksk", NpgsqlDbType.Numeric).Value = v_vattu_ksk;
                    cmd.Parameters.Add("v_bhyt", NpgsqlDbType.Numeric).Value = v_bhyt;
                    cmd.Parameters.Add("v_loaibn", NpgsqlDbType.Numeric).Value = v_loaibn;
                    cmd.Parameters.Add("v_theobs", NpgsqlDbType.Numeric).Value = v_theobs;
                    cmd.Parameters.Add("v_thuong", NpgsqlDbType.Numeric).Value = v_thuong;
                    cmd.Parameters.Add("v_trongoi", NpgsqlDbType.Numeric).Value = v_trongoi;
                    cmd.Parameters.Add("v_loaitrongoi", NpgsqlDbType.Numeric).Value = v_loaitrongoi;
                    cmd.Parameters.Add("v_chenhlech", NpgsqlDbType.Numeric).Value = v_chenhlech;
                    cmd.Parameters.Add("v_locthe", NpgsqlDbType.Text).Value = v_locthe;
                    cmd.Parameters.Add("v_ndm", NpgsqlDbType.Numeric).Value = v_ndm;
                    cmd.Parameters.Add("v_readonly", NpgsqlDbType.Numeric).Value = v_readonly;
                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                    cmd.Parameters.Add("v_tylekhuyenmai", NpgsqlDbType.Numeric).Value = v_tylekhuyenmai;
                    cmd.Parameters.Add("v_hide", NpgsqlDbType.Numeric).Value = v_hide;
                    cmd.Parameters.Add("v_kythuat", NpgsqlDbType.Numeric).Value = v_kythuat;
                    cmd.Parameters.Add("v_sothe", NpgsqlDbType.Text, 100).Value = v_sothe;

                    cmd.Parameters.Add("v_vat", NpgsqlDbType.Numeric).Value = v_vat;
                    cmd.Parameters.Add("v_kcct", NpgsqlDbType.Numeric).Value = v_kcct;
                    cmd.Parameters.Add("v_bhyt_tt", NpgsqlDbType.Numeric).Value = v_bhyt_tt;
                    cmd.Parameters.Add("v_tuyentw", NpgsqlDbType.Numeric).Value = v_tuyentw;
                    cmd.Parameters.Add("v_tuyentinh", NpgsqlDbType.Numeric).Value = v_tuyentinh;
                    cmd.Parameters.Add("v_tuyenhuyen", NpgsqlDbType.Numeric).Value = v_tuyenhuyen;
                    cmd.Parameters.Add("v_tuyenxa", NpgsqlDbType.Numeric).Value = v_tuyenxa;
                    cmd.Parameters.Add("v_dichvu", NpgsqlDbType.Numeric).Value = v_dichvu;
                    cmd.Parameters.Add("v_hoichan", NpgsqlDbType.Numeric).Value = v_hoichan;
                    cmd.Parameters.Add("v_giaycamdoan", NpgsqlDbType.Numeric).Value = v_giaycamdoan;
                    cmd.Parameters.Add("v_tgtrakq", NpgsqlDbType.Text, 10).Value = v_tgtrakq;
                    cmd.Parameters.Add("v_gioitinh", NpgsqlDbType.Text, 10).Value = v_gioitinh;
                    cmd.Parameters.Add("v_tutuoi", NpgsqlDbType.Numeric).Value = v_tutuoi;
                    cmd.Parameters.Add("v_dentuoi", NpgsqlDbType.Numeric).Value = v_dentuoi;
                    cmd.Parameters.Add("v_batbuocthutien", NpgsqlDbType.Numeric).Value = v_batbuocthutien;
                    cmd.Parameters.Add("v_coso", NpgsqlDbType.Numeric).Value = v_coso;
                    cmd.Parameters.Add("v_cosothay", NpgsqlDbType.Text, 50).Value = v_cosothay;
                    cmd.Parameters.Add("v_phongthuchiencls", NpgsqlDbType.Text, 50).Value = v_phongthuchiencls;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error_client(ex.Message, m_computername, "v_giavp", stendatabase);
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_v_giavp_new(decimal v_id, decimal v_id_loai, decimal v_stt, string v_ma, string v_ten, string v_dvt, decimal v_bhyt, decimal v_gia_th, decimal v_gia_bh, decimal v_gia_dv, decimal v_gia_nn, decimal v_gia_ksk, decimal v_gia_cs, decimal v_vattu_th, decimal v_vattu_bh, decimal v_vattu_dv, decimal v_vattu_nn, decimal v_vattu_cs, decimal v_vattu_ksk, decimal v_userid, decimal v_idloaitg)
        {
            sql = "update " + m_db_schemaroot + ".v_giavp_new set id_loai=:v_id_loai, stt=:v_stt, ma=:v_ma,ten=:v_ten,dvt=:v_dvt,bhyt=:v_bhyt,gia_th=:v_gia_th,gia_bh=:v_gia_bh,gia_cs=:v_gia_cs,gia_dv=:v_gia_dv,gia_nn=:v_gia_nn,gia_ksk=:v_gia_ksk, vattu_th=:v_vattu_th,vattu_bh=:v_vattu_bh,vattu_dv=:v_vattu_dv,vattu_nn=:v_vattu_nn,vattu_cs=:v_vattu_cs,vattu_ksk=:v_vattu_ksk,userid=:v_userid,ngayud=now() where id=:v_id and idloaitg=:v_idloaitg ";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;
            cmd.Parameters.Add("v_id_loai", NpgsqlDbType.Numeric).Value = v_id_loai;
            cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
            cmd.Parameters.Add("v_ma", NpgsqlDbType.Text, 50).Value = v_ma;
            cmd.Parameters.Add("v_ten", NpgsqlDbType.Text, 100).Value = v_ten;
            cmd.Parameters.Add("v_dvt", NpgsqlDbType.Text, 20).Value = v_dvt;
            cmd.Parameters.Add("v_bhyt", NpgsqlDbType.Numeric).Value = v_bhyt;

            cmd.Parameters.Add("v_gia_th", NpgsqlDbType.Numeric).Value = v_gia_th;
            cmd.Parameters.Add("v_gia_bh", NpgsqlDbType.Numeric).Value = v_gia_bh;
            cmd.Parameters.Add("v_gia_cs", NpgsqlDbType.Numeric).Value = v_gia_cs;
            cmd.Parameters.Add("v_gia_dv", NpgsqlDbType.Numeric).Value = v_gia_dv;
            cmd.Parameters.Add("v_gia_nn", NpgsqlDbType.Numeric).Value = v_gia_nn;
            cmd.Parameters.Add("v_gia_ksk", NpgsqlDbType.Numeric).Value = v_gia_ksk;

            cmd.Parameters.Add("v_vattu_th", NpgsqlDbType.Numeric).Value = v_vattu_th;
            cmd.Parameters.Add("v_vattu_bh", NpgsqlDbType.Numeric).Value = v_vattu_bh;
            cmd.Parameters.Add("v_vattu_dv", NpgsqlDbType.Numeric).Value = v_vattu_dv;
            cmd.Parameters.Add("v_vattu_nn", NpgsqlDbType.Numeric).Value = v_vattu_nn;
            cmd.Parameters.Add("v_vattu_cs", NpgsqlDbType.Numeric).Value = v_vattu_cs;
            cmd.Parameters.Add("v_vattu_ksk", NpgsqlDbType.Numeric).Value = v_vattu_ksk;
            cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
            cmd.Parameters.Add("v_idloaitg", NpgsqlDbType.Numeric).Value = v_idloaitg;
            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + m_db_schemaroot + ".v_giavp_new(id,id_loai,stt,ma,ten,dvt,bhyt,gia_th,gia_bh,gia_cs,gia_dv,gia_nn,gia_ksk,vattu_th,vattu_bh,vattu_dv,vattu_nn,vattu_cs,vattu_ksk,userid,idloaitg,ngayud) values(:v_id,:v_id_loai,:v_stt,:v_ma,:v_ten,:v_dvt,:v_bhyt,:v_gia_th,:v_gia_bh,:v_gia_cs,:v_gia_dv,:v_gia_nn,:v_gia_ksk,:v_vattu_th,:v_vattu_bh,:v_vattu_dv,:v_vattu_nn,:v_vattu_cs,:v_vattu_ksk,:v_userid,:v_idloaitg,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_id_loai", NpgsqlDbType.Numeric).Value = v_id_loai;
                    cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
                    cmd.Parameters.Add("v_ma", NpgsqlDbType.Text, 50).Value = v_ma;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text, 100).Value = v_ten;
                    cmd.Parameters.Add("v_dvt", NpgsqlDbType.Text, 20).Value = v_dvt;
                    cmd.Parameters.Add("v_bhyt", NpgsqlDbType.Numeric).Value = v_bhyt;
                    cmd.Parameters.Add("v_gia_th", NpgsqlDbType.Numeric).Value = v_gia_th;
                    cmd.Parameters.Add("v_gia_bh", NpgsqlDbType.Numeric).Value = v_gia_bh;
                    cmd.Parameters.Add("v_gia_cs", NpgsqlDbType.Numeric).Value = v_gia_cs;
                    cmd.Parameters.Add("v_gia_dv", NpgsqlDbType.Numeric).Value = v_gia_dv;
                    cmd.Parameters.Add("v_gia_nn", NpgsqlDbType.Numeric).Value = v_gia_nn;
                    cmd.Parameters.Add("v_gia_ksk", NpgsqlDbType.Numeric).Value = v_gia_ksk;
                    cmd.Parameters.Add("v_vattu_th", NpgsqlDbType.Numeric).Value = v_vattu_th;
                    cmd.Parameters.Add("v_vattu_bh", NpgsqlDbType.Numeric).Value = v_vattu_bh;
                    cmd.Parameters.Add("v_vattu_dv", NpgsqlDbType.Numeric).Value = v_vattu_dv;
                    cmd.Parameters.Add("v_vattu_nn", NpgsqlDbType.Numeric).Value = v_vattu_nn;
                    cmd.Parameters.Add("v_vattu_cs", NpgsqlDbType.Numeric).Value = v_vattu_cs;
                    cmd.Parameters.Add("v_vattu_ksk", NpgsqlDbType.Numeric).Value = v_vattu_ksk;
                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                    cmd.Parameters.Add("v_idloaitg", NpgsqlDbType.Numeric).Value = v_idloaitg;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_giavp_new");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_v_giavp_phuthu(decimal v_id, decimal v_id_loai, decimal v_stt, string v_ma, string v_ten, string v_dvt, decimal v_bhyt, decimal v_gia_th, decimal v_gia_bh, decimal v_gia_dv, decimal v_gia_nn, decimal v_gia_ksk, decimal v_gia_cs, decimal v_vattu_th, decimal v_vattu_bh, decimal v_vattu_dv, decimal v_vattu_nn, decimal v_vattu_cs, decimal v_vattu_ksk, decimal v_userid, decimal v_idloaitg)
        {
            sql = "update " + m_db_schemaroot + ".v_giavp_phuthu set id_loai=:v_id_loai, stt=:v_stt, ma=:v_ma,ten=:v_ten,dvt=:v_dvt,bhyt=:v_bhyt,gia_th=:v_gia_th,gia_bh=:v_gia_bh,gia_cs=:v_gia_cs,gia_dv=:v_gia_dv,gia_nn=:v_gia_nn,gia_ksk=:v_gia_ksk, vattu_th=:v_vattu_th,vattu_bh=:v_vattu_bh,vattu_dv=:v_vattu_dv,vattu_nn=:v_vattu_nn,vattu_cs=:v_vattu_cs,vattu_ksk=:v_vattu_ksk,userid=:v_userid,ngayud=now() where id=:v_id and idloaitg=:v_idloaitg ";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;
            cmd.Parameters.Add("v_id_loai", NpgsqlDbType.Numeric).Value = v_id_loai;
            cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
            cmd.Parameters.Add("v_ma", NpgsqlDbType.Text, 50).Value = v_ma;
            cmd.Parameters.Add("v_ten", NpgsqlDbType.Text, 100).Value = v_ten;
            cmd.Parameters.Add("v_dvt", NpgsqlDbType.Text, 20).Value = v_dvt;
            cmd.Parameters.Add("v_bhyt", NpgsqlDbType.Numeric).Value = v_bhyt;

            cmd.Parameters.Add("v_gia_th", NpgsqlDbType.Numeric).Value = v_gia_th;
            cmd.Parameters.Add("v_gia_bh", NpgsqlDbType.Numeric).Value = v_gia_bh;
            cmd.Parameters.Add("v_gia_cs", NpgsqlDbType.Numeric).Value = v_gia_cs;
            cmd.Parameters.Add("v_gia_dv", NpgsqlDbType.Numeric).Value = v_gia_dv;
            cmd.Parameters.Add("v_gia_nn", NpgsqlDbType.Numeric).Value = v_gia_nn;
            cmd.Parameters.Add("v_gia_ksk", NpgsqlDbType.Numeric).Value = v_gia_ksk;

            cmd.Parameters.Add("v_vattu_th", NpgsqlDbType.Numeric).Value = v_vattu_th;
            cmd.Parameters.Add("v_vattu_bh", NpgsqlDbType.Numeric).Value = v_vattu_bh;
            cmd.Parameters.Add("v_vattu_dv", NpgsqlDbType.Numeric).Value = v_vattu_dv;
            cmd.Parameters.Add("v_vattu_nn", NpgsqlDbType.Numeric).Value = v_vattu_nn;
            cmd.Parameters.Add("v_vattu_cs", NpgsqlDbType.Numeric).Value = v_vattu_cs;
            cmd.Parameters.Add("v_vattu_ksk", NpgsqlDbType.Numeric).Value = v_vattu_ksk;
            cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
            cmd.Parameters.Add("v_idloaitg", NpgsqlDbType.Numeric).Value = v_idloaitg;
            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + m_db_schemaroot + ".v_giavp_phuthu(id,id_loai,stt,ma,ten,dvt,bhyt,gia_th,gia_bh,gia_cs,gia_dv,gia_nn,gia_ksk,vattu_th,vattu_bh,vattu_dv,vattu_nn,vattu_cs,vattu_ksk,userid,idloaitg,ngayud) values(:v_id,:v_id_loai,:v_stt,:v_ma,:v_ten,:v_dvt,:v_bhyt,:v_gia_th,:v_gia_bh,:v_gia_cs,:v_gia_dv,:v_gia_nn,:v_gia_ksk,:v_vattu_th,:v_vattu_bh,:v_vattu_dv,:v_vattu_nn,:v_vattu_cs,:v_vattu_ksk,:v_userid,:v_idloaitg,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_id_loai", NpgsqlDbType.Numeric).Value = v_id_loai;
                    cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
                    cmd.Parameters.Add("v_ma", NpgsqlDbType.Text, 50).Value = v_ma;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text, 100).Value = v_ten;
                    cmd.Parameters.Add("v_dvt", NpgsqlDbType.Text, 20).Value = v_dvt;
                    cmd.Parameters.Add("v_bhyt", NpgsqlDbType.Numeric).Value = v_bhyt;
                    cmd.Parameters.Add("v_gia_th", NpgsqlDbType.Numeric).Value = v_gia_th;
                    cmd.Parameters.Add("v_gia_bh", NpgsqlDbType.Numeric).Value = v_gia_bh;
                    cmd.Parameters.Add("v_gia_cs", NpgsqlDbType.Numeric).Value = v_gia_cs;
                    cmd.Parameters.Add("v_gia_dv", NpgsqlDbType.Numeric).Value = v_gia_dv;
                    cmd.Parameters.Add("v_gia_nn", NpgsqlDbType.Numeric).Value = v_gia_nn;
                    cmd.Parameters.Add("v_gia_ksk", NpgsqlDbType.Numeric).Value = v_gia_ksk;
                    cmd.Parameters.Add("v_vattu_th", NpgsqlDbType.Numeric).Value = v_vattu_th;
                    cmd.Parameters.Add("v_vattu_bh", NpgsqlDbType.Numeric).Value = v_vattu_bh;
                    cmd.Parameters.Add("v_vattu_dv", NpgsqlDbType.Numeric).Value = v_vattu_dv;
                    cmd.Parameters.Add("v_vattu_nn", NpgsqlDbType.Numeric).Value = v_vattu_nn;
                    cmd.Parameters.Add("v_vattu_cs", NpgsqlDbType.Numeric).Value = v_vattu_cs;
                    cmd.Parameters.Add("v_vattu_ksk", NpgsqlDbType.Numeric).Value = v_vattu_ksk;
                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                    cmd.Parameters.Add("v_idloaitg", NpgsqlDbType.Numeric).Value = v_idloaitg;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_giavp_new");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_v_giavp_luu(decimal v_id, decimal v_id_loai, decimal v_stt, string v_ma, string v_ten, string v_dvt, decimal v_gia_th, decimal v_gia_bh, decimal v_gia_dv, decimal v_gia_nn, decimal v_gia_cs, decimal v_vattu_th, decimal v_vattu_bh, decimal v_vattu_dv, decimal v_vattu_nn, decimal v_vattu_cs, decimal v_bhyt, decimal v_loaibn, decimal v_theobs, decimal v_thuong, decimal v_trongoi, decimal v_loaitrongoi, decimal v_chenhlech, decimal v_ndm, string v_locthe, decimal v_readonly, decimal v_userid, decimal v_tylekhuyenmai, decimal v_gia_ksk, decimal v_vattu_ksk, decimal v_hide, decimal v_kythuat)
        {
            sql = "insert into " + m_db_schemaroot + ".v_giavp_luu" + s_dblink + "(id,id_loai,stt,ma,ten,dvt,gia_th,gia_bh,gia_dv,gia_nn,gia_cs,vattu_th,vattu_bh,vattu_dv,vattu_nn,vattu_cs,bhyt,loaibn,theobs,thuong,trongoi,loaitrongoi,locthe,chenhlech,ndm,readonly,userid,tylekhuyenmai,gia_ksk,vattu_ksk,hide,kythuat) values(:v_id,:v_id_loai,:v_stt,:v_ma,:v_ten,:v_dvt,:v_gia_th,:v_gia_bh,:v_gia_dv,:v_gia_nn,:v_gia_cs,:v_vattu_th,:v_vattu_bh,:v_vattu_dv,:v_vattu_nn,:v_vattu_cs,:v_bhyt,:v_loaibn,:v_theobs,:v_thuong,:v_trongoi,:v_loaitrongoi,:v_locthe,:v_chenhlech,:v_ndm,:v_readonly,:v_userid,:v_tylekhuyenmai,:v_gia_ksk,:v_vattu_ksk,:v_hide,:v_kythuat)";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;
            try
            {
                con.Open();
                cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                cmd.Parameters.Add("v_id_loai", NpgsqlDbType.Numeric).Value = v_id_loai;
                cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
                cmd.Parameters.Add("v_ma", NpgsqlDbType.Text, 50).Value = v_ma;
                cmd.Parameters.Add("v_ten", NpgsqlDbType.Text, 100).Value = v_ten;
                cmd.Parameters.Add("v_dvt", NpgsqlDbType.Text, 20).Value = v_dvt;
                cmd.Parameters.Add("v_gia_th", NpgsqlDbType.Numeric).Value = v_gia_th;
                cmd.Parameters.Add("v_gia_bh", NpgsqlDbType.Numeric).Value = v_gia_bh;
                cmd.Parameters.Add("v_gia_dv", NpgsqlDbType.Numeric).Value = v_gia_dv;
                cmd.Parameters.Add("v_gia_nn", NpgsqlDbType.Numeric).Value = v_gia_nn;
                cmd.Parameters.Add("v_gia_cs", NpgsqlDbType.Numeric).Value = v_gia_cs;
                cmd.Parameters.Add("v_gia_ksk", NpgsqlDbType.Numeric).Value = v_gia_ksk;
                cmd.Parameters.Add("v_vattu_th", NpgsqlDbType.Numeric).Value = v_vattu_th;
                cmd.Parameters.Add("v_vattu_bh", NpgsqlDbType.Numeric).Value = v_vattu_bh;
                cmd.Parameters.Add("v_vattu_dv", NpgsqlDbType.Numeric).Value = v_vattu_dv;
                cmd.Parameters.Add("v_vattu_nn", NpgsqlDbType.Numeric).Value = v_vattu_nn;
                cmd.Parameters.Add("v_vattu_cs", NpgsqlDbType.Numeric).Value = v_vattu_cs;
                cmd.Parameters.Add("v_vattu_ksk", NpgsqlDbType.Numeric).Value = v_vattu_ksk;
                cmd.Parameters.Add("v_bhyt", NpgsqlDbType.Numeric).Value = v_bhyt;
                cmd.Parameters.Add("v_loaibn", NpgsqlDbType.Numeric).Value = v_loaibn;
                cmd.Parameters.Add("v_theobs", NpgsqlDbType.Numeric).Value = v_theobs;
                cmd.Parameters.Add("v_thuong", NpgsqlDbType.Numeric).Value = v_thuong;
                cmd.Parameters.Add("v_trongoi", NpgsqlDbType.Numeric).Value = v_trongoi;
                cmd.Parameters.Add("v_loaitrongoi", NpgsqlDbType.Numeric).Value = v_loaitrongoi;
                cmd.Parameters.Add("v_chenhlech", NpgsqlDbType.Numeric).Value = v_chenhlech;
                cmd.Parameters.Add("v_locthe", NpgsqlDbType.Text).Value = v_locthe;
                cmd.Parameters.Add("v_ndm", NpgsqlDbType.Numeric).Value = v_ndm;
                cmd.Parameters.Add("v_readonly", NpgsqlDbType.Numeric).Value = v_readonly;
                cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                cmd.Parameters.Add("v_tylekhuyenmai", NpgsqlDbType.Numeric).Value = v_tylekhuyenmai;
                cmd.Parameters.Add("v_hide", NpgsqlDbType.Numeric).Value = v_hide;
                cmd.Parameters.Add("v_kythuat", NpgsqlDbType.Numeric).Value = v_kythuat;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_giavp_luu");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_v_giavp_luu_client(decimal v_id, decimal v_id_loai, decimal v_stt, string v_ma, string v_ten, string v_dvt, decimal v_gia_th, decimal v_gia_bh, decimal v_gia_dv, decimal v_gia_nn, decimal v_gia_cs, decimal v_vattu_th, decimal v_vattu_bh, decimal v_vattu_dv, decimal v_vattu_nn, decimal v_vattu_cs, decimal v_bhyt, decimal v_loaibn, decimal v_theobs, decimal v_thuong, decimal v_trongoi, decimal v_loaitrongoi, decimal v_chenhlech, decimal v_ndm, string v_locthe, decimal v_readonly, decimal v_userid, decimal v_tylekhuyenmai, decimal v_gia_ksk, decimal v_vattu_ksk, decimal v_hide, decimal v_kythuat, string stendatabase)
        {
            sql = "insert into " + m_db_schemaroot + ".v_giavp_luu" + stendatabase + "(id,id_loai,stt,ma,ten,dvt,gia_th,gia_bh,gia_dv,gia_nn,gia_cs,vattu_th,vattu_bh,vattu_dv,vattu_nn,vattu_cs,bhyt,loaibn,theobs,thuong,trongoi,loaitrongoi,locthe,chenhlech,ndm,readonly,userid,tylekhuyenmai,gia_ksk,vattu_ksk,hide,kythuat) values(:v_id,:v_id_loai,:v_stt,:v_ma,:v_ten,:v_dvt,:v_gia_th,:v_gia_bh,:v_gia_dv,:v_gia_nn,:v_gia_cs,:v_vattu_th,:v_vattu_bh,:v_vattu_dv,:v_vattu_nn,:v_vattu_cs,:v_bhyt,:v_loaibn,:v_theobs,:v_thuong,:v_trongoi,:v_loaitrongoi,:v_locthe,:v_chenhlech,:v_ndm,:v_readonly,:v_userid,:v_tylekhuyenmai,:v_gia_ksk,:v_vattu_ksk,:v_hide,:v_kythuat)";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;
            try
            {
                con.Open();
                cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                cmd.Parameters.Add("v_id_loai", NpgsqlDbType.Numeric).Value = v_id_loai;
                cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
                cmd.Parameters.Add("v_ma", NpgsqlDbType.Text, 50).Value = v_ma;
                cmd.Parameters.Add("v_ten", NpgsqlDbType.Text, 100).Value = v_ten;
                cmd.Parameters.Add("v_dvt", NpgsqlDbType.Text, 20).Value = v_dvt;
                cmd.Parameters.Add("v_gia_th", NpgsqlDbType.Numeric).Value = v_gia_th;
                cmd.Parameters.Add("v_gia_bh", NpgsqlDbType.Numeric).Value = v_gia_bh;
                cmd.Parameters.Add("v_gia_dv", NpgsqlDbType.Numeric).Value = v_gia_dv;
                cmd.Parameters.Add("v_gia_nn", NpgsqlDbType.Numeric).Value = v_gia_nn;
                cmd.Parameters.Add("v_gia_cs", NpgsqlDbType.Numeric).Value = v_gia_cs;
                cmd.Parameters.Add("v_gia_ksk", NpgsqlDbType.Numeric).Value = v_gia_ksk;
                cmd.Parameters.Add("v_vattu_th", NpgsqlDbType.Numeric).Value = v_vattu_th;
                cmd.Parameters.Add("v_vattu_bh", NpgsqlDbType.Numeric).Value = v_vattu_bh;
                cmd.Parameters.Add("v_vattu_dv", NpgsqlDbType.Numeric).Value = v_vattu_dv;
                cmd.Parameters.Add("v_vattu_nn", NpgsqlDbType.Numeric).Value = v_vattu_nn;
                cmd.Parameters.Add("v_vattu_cs", NpgsqlDbType.Numeric).Value = v_vattu_cs;
                cmd.Parameters.Add("v_vattu_ksk", NpgsqlDbType.Numeric).Value = v_vattu_ksk;
                cmd.Parameters.Add("v_bhyt", NpgsqlDbType.Numeric).Value = v_bhyt;
                cmd.Parameters.Add("v_loaibn", NpgsqlDbType.Numeric).Value = v_loaibn;
                cmd.Parameters.Add("v_theobs", NpgsqlDbType.Numeric).Value = v_theobs;
                cmd.Parameters.Add("v_thuong", NpgsqlDbType.Numeric).Value = v_thuong;
                cmd.Parameters.Add("v_trongoi", NpgsqlDbType.Numeric).Value = v_trongoi;
                cmd.Parameters.Add("v_loaitrongoi", NpgsqlDbType.Numeric).Value = v_loaitrongoi;
                cmd.Parameters.Add("v_chenhlech", NpgsqlDbType.Numeric).Value = v_chenhlech;
                cmd.Parameters.Add("v_locthe", NpgsqlDbType.Text).Value = v_locthe;
                cmd.Parameters.Add("v_ndm", NpgsqlDbType.Numeric).Value = v_ndm;
                cmd.Parameters.Add("v_readonly", NpgsqlDbType.Numeric).Value = v_readonly;
                cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                cmd.Parameters.Add("v_tylekhuyenmai", NpgsqlDbType.Numeric).Value = v_tylekhuyenmai;
                cmd.Parameters.Add("v_hide", NpgsqlDbType.Numeric).Value = v_hide;
                cmd.Parameters.Add("v_kythuat", NpgsqlDbType.Numeric).Value = v_kythuat;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_giavp_luu");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_dasuamadt(string v_mmyy, decimal v_maql, decimal v_idkhoa)
        {
            sql = "update " + m_db_schemaroot + v_mmyy + ".dasuamadt set maql=:v_maql,idkhoa=:v_idkhoa where maql=:v_maql and idkhoa=:v_idkhoa";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
            cmd.Parameters.Add("v_idkhoa", NpgsqlDbType.Numeric).Value = v_idkhoa;
            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + m_db_schemaroot + v_mmyy + ".dasuamadt (maql,idkhoa) values (:v_maql,:v_idkhoa)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
                    cmd.Parameters.Add("v_idkhoa", NpgsqlDbType.Numeric).Value = v_idkhoa;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_v_error(ex.Message, m_computername, "v_dasuamadt");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_hoten_hotenkdau(bool v_all)
        {
            string v_mabn = "", v_hoten = "", v_hotenkdau = "", aexp = "";
            if (!v_all) aexp = " where hotenkdau is null";
            foreach (DataRow r in get_data("select mabn,hoten from " + m_db_schemaroot + ".btdbn" + aexp).Tables[0].Rows)
            {
                v_mabn = r["mabn"].ToString();
                v_hoten = r["hoten"].ToString().ToUpper().Trim();
                v_hotenkdau = f_khongdau(v_hoten);
                try
                {
                    sql = "update " + s_schemaroot + ".btdbn set hoten=:v_hoten ";
                    if (v_hotenkdau.Trim() != "")
                        sql += " ,hotenkdau=:v_hotenkdau";
                    sql += " where mabn=:v_mabn";
                    if (con != null)
                    {
                        con.Close(); con.Dispose();
                    }
                    con = new NpgsqlConnection(sConn);
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
                    cmd.Parameters.Add("v_hoten", NpgsqlDbType.Text, 50).Value = v_hoten;
                    if (v_hotenkdau.Trim() != "")
                        cmd.Parameters.Add("v_hotenkdau", NpgsqlDbType.Varchar, 50).Value = v_hotenkdau;
                    try
                    {
                        con.Open();
                        int irec = cmd.ExecuteNonQuery();
                        cmd.Dispose();
                    }
                    catch (Exception ex)
                    {
                        upd_v_error(ex.Message, m_computername, "v_hotenkdau");
                        //return false;
                    }
                    finally
                    {
                        cmd.Dispose();
                        con.Dispose();
                    }
                }
                catch
                {
                    return false;
                }
            }
            return true;
        }
        public bool upd_tygia(string v_ngay, decimal v_tygia, decimal v_userid)
        {
            sql = "update " + m_db_schemaroot + ".v_tygia set tygia=:v_tygia, userid=:v_userid where to_char(ngay,'dd/mm/yyyy') =:v_ngay";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_ngay", NpgsqlDbType.Text, 10).Value = v_ngay;
            cmd.Parameters.Add("v_tygia", NpgsqlDbType.Numeric).Value = v_tygia;
            cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + m_db_schemaroot + ".v_tygia(ngay,tygia,userid) values(to_date(:v_ngay,'dd/mm/yyyy'),:v_tygia,:v_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 10).Value = v_ngay;
                    cmd.Parameters.Add("v_tygia", NpgsqlDbType.Numeric).Value = v_tygia;
                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_tygia");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_v_nhomdlogin(decimal v_id, decimal v_nhom, string v_ma, string v_ten, string v_diengiai, string v_id_bv_so, string v_right_)
        {
            sql = "update " + m_db_schemaroot + ".v_nhomdlogin set nhom=:v_nhom, ma=:v_ma,ten=:v_ten,diengiai=:v_diengiai, id_bv_so=:v_id_bv_so, right_=:v_right_ where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_nhom", NpgsqlDbType.Numeric).Value = v_nhom;
            cmd.Parameters.Add("v_ma", NpgsqlDbType.Varchar, 20).Value = v_ma;
            cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
            cmd.Parameters.Add("v_diengiai", NpgsqlDbType.Text).Value = v_diengiai;
            cmd.Parameters.Add("v_id_bv_so", NpgsqlDbType.Varchar, 4000).Value = v_id_bv_so;
            cmd.Parameters.Add("v_right_", NpgsqlDbType.Varchar, 4000).Value = v_right_;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + m_db_schemaroot + ".v_nhomdlogin(id,nhom,ma,ten,diengiai,id_bv_so,right_) values(:v_id,:v_nhom,:v_ma,:v_ten,:v_diengiai,:v_id_bv_so,:v_right_)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_nhom", NpgsqlDbType.Numeric).Value = v_nhom;
                    cmd.Parameters.Add("v_ma", NpgsqlDbType.Varchar, 20).Value = v_ma;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
                    cmd.Parameters.Add("v_diengiai", NpgsqlDbType.Text).Value = v_diengiai;
                    cmd.Parameters.Add("v_id_bv_so", NpgsqlDbType.Varchar, 4000).Value = v_id_bv_so;
                    cmd.Parameters.Add("v_right_", NpgsqlDbType.Varchar, 4000).Value = v_right_;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();

                    execute_data("insert into " + s_schemaroot + ".v_phanquyennhom(id_nhom,menuname,chon,chitiet) select " + v_id + ",menuname,chon,chitiet from " + s_schemaroot + ".v_phanquyennhom where id_nhom=" + (v_nhom * -1).ToString());
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_nhomdlogin");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_v_dlogin(decimal v_id, decimal v_id_nhom, string v_hoten, string v_userid, string v_password_, string v_right_, string v_loaivp)
        {
            sql = "update " + m_db_schemaroot + ".v_dlogin set hoten=:v_hoten,userid=:v_userid,password_=:v_password_,right_=:v_right_,loaivp=:v_loaivp,id_nhom=:v_id_nhom where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_id_nhom", NpgsqlDbType.Numeric).Value = v_id_nhom;
            cmd.Parameters.Add("v_hoten", NpgsqlDbType.Text, 50).Value = v_hoten;
            cmd.Parameters.Add("v_userid", NpgsqlDbType.Varchar, 20).Value = v_userid;
            cmd.Parameters.Add("v_password_", NpgsqlDbType.Varchar, 20).Value = v_password_;
            cmd.Parameters.Add("v_right_", NpgsqlDbType.Varchar, 4000).Value = v_right_;
            cmd.Parameters.Add("v_loaivp", NpgsqlDbType.Varchar, 254).Value = v_loaivp;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + m_db_schemaroot + ".v_dlogin(id,id_nhom,hoten,userid,password_,right_,loaivp) values(:v_id,:v_id_nhom,:v_hoten,:v_userid,:v_password_,:v_right_,:v_loaivp)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_id_nhom", NpgsqlDbType.Numeric).Value = v_id_nhom;
                    cmd.Parameters.Add("v_hoten", NpgsqlDbType.Text, 50).Value = v_hoten;
                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Varchar, 20).Value = v_userid;
                    cmd.Parameters.Add("v_password_", NpgsqlDbType.Varchar, 20).Value = v_password_;
                    cmd.Parameters.Add("v_right_", NpgsqlDbType.Varchar, 1000).Value = v_right_;
                    cmd.Parameters.Add("v_loaivp", NpgsqlDbType.Varchar, 254).Value = v_loaivp;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_dlogin");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        //Tu:20/05/2011 them chi nhanh
        public bool upd_v_dlogin(decimal v_id, decimal v_id_nhom, string v_hoten, string v_userid, string v_password_, string v_right_, string v_loaivp, int v_chinhanh)
        {
            sql = "update " + m_db_schemaroot + ".v_dlogin set hoten=:v_hoten,userid=:v_userid,password_=:v_password_,right_=:v_right_,loaivp=:v_loaivp,id_nhom=:v_id_nhom,chinhanh=:v_chinhanh where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_id_nhom", NpgsqlDbType.Numeric).Value = v_id_nhom;
            cmd.Parameters.Add("v_hoten", NpgsqlDbType.Text, 50).Value = v_hoten;
            cmd.Parameters.Add("v_userid", NpgsqlDbType.Varchar, 20).Value = v_userid;
            cmd.Parameters.Add("v_password_", NpgsqlDbType.Varchar, 20).Value = v_password_;
            cmd.Parameters.Add("v_right_", NpgsqlDbType.Varchar, 4000).Value = v_right_;
            cmd.Parameters.Add("v_loaivp", NpgsqlDbType.Varchar, 254).Value = v_loaivp;
            cmd.Parameters.Add("v_chinhanh", NpgsqlDbType.Numeric).Value = v_chinhanh;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + m_db_schemaroot + ".v_dlogin(id,id_nhom,hoten,userid,password_,right_,loaivp,chinhanh) values(:v_id,:v_id_nhom,:v_hoten,:v_userid,:v_password_,:v_right_,:v_loaivp,:v_chinhanh)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_id_nhom", NpgsqlDbType.Numeric).Value = v_id_nhom;
                    cmd.Parameters.Add("v_hoten", NpgsqlDbType.Text, 50).Value = v_hoten;
                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Varchar, 20).Value = v_userid;
                    cmd.Parameters.Add("v_password_", NpgsqlDbType.Varchar, 20).Value = v_password_;
                    cmd.Parameters.Add("v_right_", NpgsqlDbType.Varchar, 1000).Value = v_right_;
                    cmd.Parameters.Add("v_loaivp", NpgsqlDbType.Varchar, 254).Value = v_loaivp;
                    cmd.Parameters.Add("v_chinhanh", NpgsqlDbType.Numeric).Value = v_chinhanh;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_dlogin");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        //end Tu
        public void upd_v_khongdau()
        {
            try
            {
                execute_data("delete from v_khongdau");
                string acodau = "", akhongdau = "";
                acodau = "ÁÀẢÃÂẠẬẤẦẨẪĂẮẰẲẴẶĐÉÈẺẼẸÊẾỀỂỄỆÍÌỈĨỊÓÒỎÕỌÔỐỒỔỖỘÝỲỶỸỴƯỨỪỬỮỰƠỚỜỞỠỢÚÙỦŨỤ";
                akhongdau = "AAAAAAAAAAAAAAAAADEEEEEEEEEEEIIIIIOOOOOOOOOOOYYYYYUUUUUUOOOOOOUUUUU";
                for (int i = 0; i < acodau.Length; i++)
                {
                    upd_v_khongdau(acodau[i].ToString(), akhongdau[i].ToString());
                }
            }
            catch
            {
            }
        }
        public bool upd_v_khongdau(string v_codau, string v_khongdau)
        {
            sql = "update " + m_db_schemaroot + ".v_khongdau set khongdau=:v_khongdau where codau=:v_codau";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_codau", NpgsqlDbType.Text).Value = v_codau;
            cmd.Parameters.Add("v_khongdau", NpgsqlDbType.Text).Value = v_khongdau;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + m_db_schemaroot + ".v_khongdau(codau,khongdau) values(:v_codau,:v_khongdau)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_codau", NpgsqlDbType.Text).Value = v_codau;
                    cmd.Parameters.Add("v_khongdau", NpgsqlDbType.Text).Value = v_khongdau;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_khongdau");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_v_dlogin_right(decimal v_id, string v_right_)
        {
            sql = "update " + m_db_schemaroot + ".v_dlogin set right_=:v_right_ where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_right_", NpgsqlDbType.Varchar, 1000).Value = v_right_;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_giavp_right");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_v_dlogin_loaivp(decimal v_id, string v_loaivp)
        {
            sql = "update " + m_db_schemaroot + ".v_dlogin set loaivp=:v_loaivp where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_loaivp", NpgsqlDbType.Varchar, 254).Value = v_loaivp;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_dlogin_loaivp");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_v_tenloaivp(decimal v_ma, string v_ten, decimal v_readonly)
        {
            sql = "update " + s_schemaroot + ".v_tenloaivp set ten=:v_ten,readonly=:v_readonly,ngayud=now() where ma=:v_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_ma", NpgsqlDbType.Numeric).Value = v_ma;
            cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
            cmd.Parameters.Add("v_readonly", NpgsqlDbType.Numeric).Value = v_readonly;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schemaroot + ".v_tenloaivp(ma,ten,readonly,ngayud) values(:v_ma,:v_ten,:v_readonly,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_ma", NpgsqlDbType.Numeric).Value = v_ma;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
                    cmd.Parameters.Add("v_readonly", NpgsqlDbType.Numeric).Value = v_readonly;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_tenloaivp");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_v_dmlydothieu(decimal v_id, string v_ten, decimal v_readonly)
        {
            sql = "update " + s_schemaroot + ".v_dmlydothieu set ten=:v_ten,readonly=:v_readonly,ngayud=now() where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
            cmd.Parameters.Add("v_readonly", NpgsqlDbType.Numeric).Value = v_readonly;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schemaroot + ".v_dmlydothieu(id,ten,readonly,ngayud) values(:v_id,:v_ten,:v_readonly,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
                    cmd.Parameters.Add("v_readonly", NpgsqlDbType.Numeric).Value = v_readonly;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_dmlydothieu");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_v_dmlydonopthem(decimal v_id, string v_ten, decimal v_readonly)
        {
            sql = "update " + s_schemaroot + ".v_dmlydonopthem set ten=:v_ten,readonly=:v_readonly,ngayud=now() where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
            cmd.Parameters.Add("v_readonly", NpgsqlDbType.Numeric).Value = v_readonly;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schemaroot + ".v_dmlydonopthem(id,ten,readonly,ngayud) values(:v_id,:v_ten,:v_readonly,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
                    cmd.Parameters.Add("v_readonly", NpgsqlDbType.Numeric).Value = v_readonly;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_dmlydonopthem");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_v_dsduyet(string v_ma, string v_ten, decimal v_readonly, string v_mabs)
        {
            sql = "update " + s_schemaroot + ".v_dsduyet set ten=:v_ten, readonly=:v_readonly,ngayud=now(),mabs=:v_mabs where ma=:v_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_ma", NpgsqlDbType.Varchar, 4).Value = v_ma;
            cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
            cmd.Parameters.Add("v_readonly", NpgsqlDbType.Numeric).Value = v_readonly;
            cmd.Parameters.Add("v_mabs", NpgsqlDbType.Text).Value = v_mabs;//Khuong 24/05/2011:them ma bs ung voi ma bs trong dmbs

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schemaroot + ".v_dsduyet(ma,ten,readonly,ngayud,mabs) values(:v_ma,:v_ten,:v_readonly,now(),:v_mabs)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_ma", NpgsqlDbType.Varchar, 4).Value = v_ma;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
                    cmd.Parameters.Add("v_readonly", NpgsqlDbType.Numeric).Value = v_readonly;
                    cmd.Parameters.Add("v_mabs", NpgsqlDbType.Text).Value = v_mabs;


                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_dsduyet");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_v_nhomvp(decimal v_ma, decimal v_stt, string v_ten, string v_matat, string v_viettat, decimal v_idnhombhyt, decimal v_readonly)
        {
            sql = "update " + s_schemaroot + ".v_nhomvp set ten=:v_ten, stt=:v_stt, idnhombhyt=:v_idnhombhyt, matat=:v_matat, viettat=:v_viettat, readonly=:v_readonly, ngayud=now() where ma=:v_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_ma", NpgsqlDbType.Numeric).Value = v_ma;
            cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
            cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
            cmd.Parameters.Add("v_matat", NpgsqlDbType.Varchar, 20).Value = v_matat;
            cmd.Parameters.Add("v_viettat", NpgsqlDbType.Text).Value = v_viettat;
            cmd.Parameters.Add("v_idnhombhyt", NpgsqlDbType.Numeric).Value = v_idnhombhyt;
            cmd.Parameters.Add("v_readonly", NpgsqlDbType.Numeric).Value = v_readonly;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schemaroot + ".v_nhomvp(ma,stt,ten,matat,viettat,idnhombhyt,readonly,ngayud) values(:v_ma,:v_stt,:v_ten,:v_matat,:v_viettat,:v_idnhombhyt,:v_readonly,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_ma", NpgsqlDbType.Numeric).Value = v_ma;
                    cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
                    cmd.Parameters.Add("v_matat", NpgsqlDbType.Varchar, 20).Value = v_matat;
                    cmd.Parameters.Add("v_viettat", NpgsqlDbType.Text).Value = v_viettat;
                    cmd.Parameters.Add("v_idnhombhyt", NpgsqlDbType.Numeric).Value = v_idnhombhyt;
                    cmd.Parameters.Add("v_readonly", NpgsqlDbType.Numeric).Value = v_readonly;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_nhomvp");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_v_nhombhyt(decimal v_id, decimal v_stt, string v_ten, string v_viettat, decimal v_readonly)
        {
            sql = "update " + s_schemaroot + ".v_nhombhyt set ten=:v_ten,stt=:v_stt,viettat=:v_viettat,readonly=:v_readonly where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
            cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
            cmd.Parameters.Add("v_viettat", NpgsqlDbType.Text).Value = v_viettat;
            cmd.Parameters.Add("v_readonly", NpgsqlDbType.Numeric).Value = v_readonly;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schemaroot + ".v_nhombhyt(id,stt,ten,viettat,readonly,ngayud) values(:v_id,:v_stt,:v_ten,:v_viettat,:v_readonly,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
                    cmd.Parameters.Add("v_viettat", NpgsqlDbType.Text).Value = v_viettat;
                    cmd.Parameters.Add("v_readonly", NpgsqlDbType.Numeric).Value = v_readonly;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_nhombhyt");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_v_lydomien(decimal v_id, string v_ten, decimal v_readonly)
        {
            sql = "update " + s_schemaroot + ".v_lydomien set ten=:v_ten,readonly=:v_readonly,ngayud=now() where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
            cmd.Parameters.Add("v_readonly", NpgsqlDbType.Numeric).Value = v_readonly;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schemaroot + ".v_lydomien(id,ten,readonly,ngayud) values(:v_id,:v_ten,:v_readonly,now())";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
                    cmd.Parameters.Add("v_readonly", NpgsqlDbType.Numeric).Value = v_readonly;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_lydomien");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_v_loaibn(decimal v_id, string v_ten, decimal v_readonly, int v_stt)
        {
            sql = "update " + s_schemaroot + ".v_loaibn set ten=:v_ten, readonly=:v_readonly, stt=:v_stt where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_ten", NpgsqlDbType.Text, 50).Value = v_ten;
            cmd.Parameters.Add("v_readonly", NpgsqlDbType.Numeric).Value = v_readonly;
            cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric, 2).Value = v_stt;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schemaroot + ".v_loaibn(id, ten, readonly, stt) values(:v_id, :v_ten, :v_readonly, :v_stt)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text, 50).Value = v_ten;
                    cmd.Parameters.Add("v_readonly", NpgsqlDbType.Numeric).Value = v_readonly;
                    cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric, 2).Value = v_stt;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_loaibn");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_btdvt(string v_matat, string v_daydu)
        {
            sql = "update " + s_schemaroot + ".btdvt set daydu=:v_daydu where trim(matat)=trim(:v_matat)";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_matat", NpgsqlDbType.Text, 30).Value = v_matat.Trim();
            cmd.Parameters.Add("v_daydu", NpgsqlDbType.Text, 100).Value = v_daydu.Trim();

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schemaroot + ".btdvt(matat,daydu) values(:v_matat,:v_daydu)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_matat", NpgsqlDbType.Text, 30).Value = v_matat.Trim();
                    cmd.Parameters.Add("v_daydu", NpgsqlDbType.Text, 100).Value = v_daydu.Trim();

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "btdvt");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_dmphu(decimal v_id, string v_ten, decimal v_tyle)
        {
            sql = "update " + s_schemaroot + ".dmphu set ten=:v_ten,tyle=:v_tyle where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_ten", NpgsqlDbType.Text, 50).Value = v_ten;
            cmd.Parameters.Add("v_tyle", NpgsqlDbType.Numeric).Value = v_tyle;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schemaroot + ".dmphu(id,ten,tyle) values(:v_id,:v_ten,:v_tyle)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text, 50).Value = v_ten;
                    cmd.Parameters.Add("v_tyle", NpgsqlDbType.Numeric).Value = v_tyle;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "dmphu");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }

        public bool hoantra_ttrvll(string v_mmyy, string v_id)
        {
            try
            {
                execute_data("update " + s_schema_mmyy(v_mmyy) + ".v_thvpll set done=0 where id in (select idtonghop from v_ttrvll where idtonghop<> 0 and id=" + v_id + ")");
                execute_data("update " + s_schema_mmyy(v_mmyy) + ".v_tamung set idttrv=0, done=0 where idttrv=" + v_id + "");
                return true;
            }
            catch
            {
                return false;
            }
        }
        public bool del_ttrvll(string v_mmyy, string v_id)
        {
            try
            {
                execute_data("update " + s_schema_mmyy(v_mmyy) + ".v_thvpll set done=0 where id in (select idtonghop from " + s_schema_mmyy(v_mmyy) + ".v_ttrvll where idtonghop<> 0 and id=" + v_id + ")");
                execute_data("delete from " + s_schema_mmyy(v_mmyy) + ".v_ttrvds where id=" + v_id + "");
                execute_data("delete from " + s_schema_mmyy(v_mmyy) + ".v_ttrvbhyt where id=" + v_id + "");
                execute_data("delete from " + s_schema_mmyy(v_mmyy) + ".v_ttrvll where id=" + v_id + "");
                execute_data("delete from " + s_schema_mmyy(v_mmyy) + ".v_ttrvct where id=" + v_id + "");
                execute_data("delete from " + s_schema_mmyy(v_mmyy) + ".v_miennoitru where id=" + v_id + "");
                execute_data("update " + s_schema_mmyy(v_mmyy) + ".v_tamung set idttrv=0, done=0 where idttrv=" + v_id + "");
                return true;
            }
            catch
            {
                return false;
            }
        }

        public bool upd_v_maubaocao(decimal v_id, string v_ma, string v_ten, decimal v_loai)
        {
            sql = "update " + s_schemaroot + ".v_maubaocao set ma=:v_ma,ten=:v_ten,loai=:v_loai where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_ma", NpgsqlDbType.Text, 100).Value = v_ma;
            cmd.Parameters.Add("v_ten", NpgsqlDbType.Text, 100).Value = v_ten;
            cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schemaroot + ".v_maubaocao(id,ma,ten,loai) values(:v_id,:v_ma,:v_ten,:v_loai)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_ma", NpgsqlDbType.Text, 100).Value = v_ma;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text, 100).Value = v_ten;
                    cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_maubaocao");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_v_dmghe(decimal v_id, decimal v_stt, string v_makp, string v_ma, string v_ten)
        {
            sql = "update " + s_schemaroot + ".v_dmghe set stt=:v_stt,makp=:v_makp,ma=:v_ma,ten=:v_ten where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
            cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, 2).Value = v_makp;
            cmd.Parameters.Add("v_ma", NpgsqlDbType.Text, 50).Value = v_ma;
            cmd.Parameters.Add("v_ten", NpgsqlDbType.Text, 100).Value = v_ten;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schemaroot + ".v_dmghe(id,stt,makp,ma,ten) values(:v_id,:v_stt,:v_makp,:v_ma,:v_ten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
                    cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, 2).Value = v_makp;
                    cmd.Parameters.Add("v_ma", NpgsqlDbType.Text, 50).Value = v_ma;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text, 100).Value = v_ten;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_maubaocao");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_v_sdghe(decimal v_id, decimal v_loai, decimal v_ghe)
        {
            sql = "update " + s_schemaroot + ".v_sdghe set id=:v_id,loai=:v_loai,ghe=:v_ghe where id=:v_id and loai=:v_loai and ghe=:v_ghe";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
            cmd.Parameters.Add("v_ghe", NpgsqlDbType.Numeric).Value = v_ghe;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schemaroot + ".v_sdghe(id,loai,ghe) values(:v_id,:v_loai,:v_ghe)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
                    cmd.Parameters.Add("v_ghe", NpgsqlDbType.Numeric).Value = v_ghe;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_sdghe");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_v_loaitu(decimal v_id, decimal v_sotien, string v_ten, decimal v_ktt)
        {
            sql = "update " + s_schemaroot + ".v_loaitu set sotien=:v_sotien,ten=:v_ten,ktt=:v_ktt where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
            cmd.Parameters.Add("v_ten", NpgsqlDbType.Text, 50).Value = v_ten;
            cmd.Parameters.Add("v_ktt", NpgsqlDbType.Numeric).Value = v_ktt;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schemaroot + ".v_loaitu(id,sotien,ten,ktt) values(:v_id,:v_sotien,:v_ten,:v_ktt)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text, 50).Value = v_ten;
                    cmd.Parameters.Add("v_ktt", NpgsqlDbType.Numeric).Value = v_ktt;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_loaitu");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_v_loaithn(decimal v_id, decimal v_id_gia, decimal v_stt, string v_ten)
        {
            sql = "update " + s_schemaroot + ".v_loaithn set id_gia=:v_id_gia,stt=:v_stt,ten=:v_ten where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_id_gia", NpgsqlDbType.Numeric).Value = v_id_gia;
            cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
            cmd.Parameters.Add("v_ten", NpgsqlDbType.Text, 50).Value = v_ten;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schemaroot + ".v_loaithn(id,id_gia,stt,ten) values(:v_id,:v_id_gia,:v_stt,:v_ten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_id_gia", NpgsqlDbType.Numeric).Value = v_id_gia;
                    cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text, 50).Value = v_ten;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_loaithn");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_v_option_locgiavp(decimal v_userid, decimal v_loai, string v_ten, string v_id_vp)
        {
            sql = "update " + s_schemaroot + ".v_option_locgiavp set ten=:v_ten,id_vp=:v_id_vp where userid=:v_userid and loai=:v_loai";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
            cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
            cmd.Parameters.Add("v_ten", NpgsqlDbType.Text, 50).Value = v_ten;
            cmd.Parameters.Add("v_id_vp", NpgsqlDbType.Varchar, 3000).Value = v_id_vp;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schemaroot + ".v_option_locgiavp(userid,loai,ten,id_vp) values(:v_userid,:v_loai,:v_ten,:v_id_vp)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                    cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text, 50).Value = v_ten;
                    cmd.Parameters.Add("v_id_vp", NpgsqlDbType.Varchar, 3000).Value = v_id_vp;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_option_locgiavp");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_v_option_thutheonhom(decimal v_id, decimal v_userid, decimal v_stt, string v_ten, string v_id_vp)
        {
            sql = "update " + s_schemaroot + ".v_option_thutheonhom set stt=:v_stt,ten=:v_ten,id_vp=:v_id_vp where userid=:v_userid and id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
            cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
            cmd.Parameters.Add("v_ten", NpgsqlDbType.Text, 50).Value = v_ten;
            cmd.Parameters.Add("v_id_vp", NpgsqlDbType.Varchar, 1000).Value = v_id_vp;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schemaroot + ".v_option_thutheonhom(id,userid,stt,ten,id_vp) values(:v_id,:v_userid,:v_stt,:v_ten,:v_id_vp)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                    cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text, 50).Value = v_ten;
                    cmd.Parameters.Add("v_id_vp", NpgsqlDbType.Varchar, 1000).Value = v_id_vp;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_option_thutheonhom");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_v_optionform(decimal v_userid, decimal v_loai, string v_ma, string v_ten, string v_giatri)
        {
            bool art = false;
            sql = "update " + s_schemaroot + ".v_optionform set ten=:v_ten,giatri=:v_giatri where userid=:v_userid and loai=:v_loai and ma=:v_ma";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
            cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
            cmd.Parameters.Add("v_ma", NpgsqlDbType.Text).Value = v_ma;
            cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
            cmd.Parameters.Add("v_giatri", NpgsqlDbType.Text).Value = v_giatri;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schemaroot + ".v_optionform(userid,loai,ma,ten,giatri) values(:v_userid,:v_loai,:v_ma,:v_ten,:v_giatri)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                    cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
                    cmd.Parameters.Add("v_ma", NpgsqlDbType.Text).Value = v_ma;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
                    cmd.Parameters.Add("v_giatri", NpgsqlDbType.Text).Value = v_giatri;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                    art = true;
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_optionform");
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return art;
        }
        public bool upd_v_optionhotkey(decimal v_userid, decimal v_loai, string v_hotkey, decimal v_id, string v_ghichu)
        {
            bool art = false;
            sql = "update " + s_schemaroot + ".v_optionhotkey set ghichu=:v_ghichu where userid=:v_userid and loai=:v_loai and hotkey=:v_hotkey and id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
            cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
            cmd.Parameters.Add("v_hotkey", NpgsqlDbType.Varchar, 10).Value = v_hotkey;
            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_ghichu", NpgsqlDbType.Text).Value = v_ghichu;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schemaroot + ".v_optionhotkey(userid,loai,hotkey,id,ghichu) values(:v_userid,:v_loai,:v_hotkey,:v_id,:v_ghichu)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                    cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
                    cmd.Parameters.Add("v_hotkey", NpgsqlDbType.Varchar, 10).Value = v_hotkey;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_ghichu", NpgsqlDbType.Text).Value = v_ghichu;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                    art = true;
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_optionhotkey");
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return art;
        }
        public bool upd_v_optionhotkey_ksk(decimal v_userid, decimal v_loai, string v_hotkey, decimal v_id, string v_ghichu)
        {
            bool art = false;
            sql = "update " + s_schemaroot + ".v_optionhotkey_ksk set ghichu=:v_ghichu where userid=:v_userid and loai=:v_loai and hotkey=:v_hotkey and id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
            cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
            cmd.Parameters.Add("v_hotkey", NpgsqlDbType.Varchar, 10).Value = v_hotkey;
            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_ghichu", NpgsqlDbType.Text).Value = v_ghichu;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schemaroot + ".v_optionhotkey_ksk(userid,loai,hotkey,id,ghichu) values(:v_userid,:v_loai,:v_hotkey,:v_id,:v_ghichu)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                    cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
                    cmd.Parameters.Add("v_hotkey", NpgsqlDbType.Varchar, 10).Value = v_hotkey;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_ghichu", NpgsqlDbType.Text).Value = v_ghichu;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                    art = true;
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_optionhotkey_ksk");
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return art;
        }

        public bool upd_v_optionlien(decimal v_stt, string v_ten, string v_tenreport)
        {
            bool art = false;
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                sql = "insert into " + s_schemaroot + ".v_optionlien(stt,ten,tenreport) values(:v_stt,:v_ten,:v_tenreport)";
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
                cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
                cmd.Parameters.Add("v_tenreport", NpgsqlDbType.Text).Value = v_tenreport;

                cmd.ExecuteNonQuery();
                cmd.Dispose();
                art = true;
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_optionlien");
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return art;
        }
        //Tiepdon
        public bool upd_btdbn(string v_mabn, string v_hoten, string v_ngaysinh, string v_namsinh, decimal v_phai, string v_mann, string v_madantoc, string v_sonha, string v_thon, string v_cholam, string v_matt, string v_maqu, string v_maphuongxa, decimal v_userid, string v_nam, string v_khongdau)
        {
            bool art = true;
            sql = "update " + s_schemaroot + ".btdbn set hoten=:v_hoten";
            if (v_ngaysinh.Trim().Length == 10)
            {
                sql += ", ngaysinh=to_date(:v_ngaysinh,'dd/mm/yyyy')";
            }

            sql += ",namsinh=:v_namsinh, phai=:v_phai, mann=:v_mann,madantoc=:v_madantoc,sonha=:v_sonha, thon=:v_thon,cholam=:v_cholam,matt=:v_matt, maqu=:v_maqu,maphuongxa=:v_maphuongxa,userid=:v_userid,nam=:v_nam,hotenkdau=:v_khongdau,ngayud=now() where mabn=:v_mabn";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn.Trim();
            cmd.Parameters.Add("v_hoten", NpgsqlDbType.Text).Value = v_hoten.Trim();
            if (v_ngaysinh.Trim().Length == 10)
            {
                cmd.Parameters.Add("v_ngaysinh", NpgsqlDbType.Varchar, 10).Value = v_ngaysinh.Trim();
            }
            cmd.Parameters.Add("v_namsinh", NpgsqlDbType.Varchar, 4).Value = v_namsinh.Trim();
            cmd.Parameters.Add("v_phai", NpgsqlDbType.Numeric).Value = v_phai;
            cmd.Parameters.Add("v_mann", NpgsqlDbType.Varchar, 2).Value = v_mann.Trim();
            cmd.Parameters.Add("v_madantoc", NpgsqlDbType.Varchar, 2).Value = v_madantoc.Trim();
            cmd.Parameters.Add("v_sonha", NpgsqlDbType.Varchar, 15).Value = v_sonha.Trim();
            cmd.Parameters.Add("v_thon", NpgsqlDbType.Text).Value = v_thon;
            cmd.Parameters.Add("v_cholam", NpgsqlDbType.Text).Value = v_cholam;
            cmd.Parameters.Add("v_matt", NpgsqlDbType.Varchar, 3).Value = v_matt;
            cmd.Parameters.Add("v_maqu", NpgsqlDbType.Varchar, 5).Value = v_maqu;
            cmd.Parameters.Add("v_maphuongxa", NpgsqlDbType.Varchar, 7).Value = v_maphuongxa;
            cmd.Parameters.Add("v_nam", NpgsqlDbType.Text).Value = v_nam;
            cmd.Parameters.Add("v_khongdau", NpgsqlDbType.Text).Value = v_khongdau;
            cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    if (v_ngaysinh.Trim().Length == 10)
                    {
                        sql = "insert into " + s_schemaroot + ".btdbn(mabn,hoten,ngaysinh,namsinh,phai,mann,madantoc,sonha,thon,cholam,matt,maqu,maphuongxa,userid,hotenkdau,nam,ngayud) values(:v_mabn,:v_hoten,to_date(:v_ngaysinh,'dd/mm/yyyy'),:v_namsinh,:v_phai,:v_mann,:v_madantoc,:v_sonha,:v_thon,:v_cholam,:v_matt,:v_maqu,:v_maphuongxa,:v_userid,:v_khongdau,:v_nam,now())";
                    }
                    else
                    {
                        sql = "insert into " + s_schemaroot + ".btdbn(mabn,hoten,namsinh,phai,mann,madantoc,sonha,thon,cholam,matt,maqu,maphuongxa,userid,hotenkdau,nam,ngayud) values(:v_mabn,:v_hoten,:v_namsinh,:v_phai,:v_mann,:v_madantoc,:v_sonha,:v_thon,:v_cholam,:v_matt,:v_maqu,:v_maphuongxa,:v_userid,:v_khongdau,:v_nam,now())";
                    }

                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
                    cmd.Parameters.Add("v_hoten", NpgsqlDbType.Text).Value = v_hoten;
                    if (v_ngaysinh.Trim().Length == 10)
                    {
                        cmd.Parameters.Add("v_ngaysinh", NpgsqlDbType.Varchar, 10).Value = v_ngaysinh.Trim();
                    }
                    cmd.Parameters.Add("v_namsinh", NpgsqlDbType.Varchar, 4).Value = v_namsinh;
                    cmd.Parameters.Add("v_phai", NpgsqlDbType.Numeric).Value = v_phai;
                    cmd.Parameters.Add("v_mann", NpgsqlDbType.Varchar, 2).Value = v_mann;
                    cmd.Parameters.Add("v_madantoc", NpgsqlDbType.Varchar, 2).Value = v_madantoc;
                    cmd.Parameters.Add("v_sonha", NpgsqlDbType.Varchar, 15).Value = v_sonha;
                    cmd.Parameters.Add("v_thon", NpgsqlDbType.Text).Value = v_thon;
                    cmd.Parameters.Add("v_cholam", NpgsqlDbType.Text).Value = v_cholam;
                    cmd.Parameters.Add("v_matt", NpgsqlDbType.Varchar, 3).Value = v_matt;
                    cmd.Parameters.Add("v_maqu", NpgsqlDbType.Varchar, 5).Value = v_maqu;
                    cmd.Parameters.Add("v_maphuongxa", NpgsqlDbType.Varchar, 7).Value = v_maphuongxa;
                    cmd.Parameters.Add("v_khongdau", NpgsqlDbType.Text).Value = v_khongdau;
                    cmd.Parameters.Add("v_nam", NpgsqlDbType.Text).Value = v_nam;
                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.ToString(), m_computername, s_schemaroot + ".btdbn");
                art = false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return art;
        }
        public decimal upd_tiepdon(string v_mabn, decimal v_mavaovien, decimal v_maql, string v_makp, string v_ngay16, decimal v_madoituong, string v_sovaovien, string v_tuoivao, decimal v_benhnhanmoi, decimal v_noitiepdon, decimal v_loai, decimal v_userid)
        {
            try
            {
                if (v_maql == 0)
                {
                    // v_maql = get_maql;
                    v_maql = getidyymmddhhmiss_stt_computer;
                }
                string ammyy = "";
                ammyy = v_ngay16.Split('/')[1] + v_ngay16.Split('/')[2].Substring(2, 2);
                if (ammyy.Length < 4)
                {
                    ammyy = s_curmmyy;
                }
                if (v_ngay16.Length < 16)
                {
                    v_ngay16 = v_ngay16.Substring(0, 10);
                    v_ngay16 = v_ngay16 + " " + DateTime.Now.Hour.ToString().PadLeft(2, '0') + ":" + DateTime.Now.Minute.ToString().PadLeft(2, '0');
                }
                sql = "update " + s_schema_mmyy(ammyy) + ".tiepdon set mabn=:v_mabn,mavaovien=:v_mavaovien,makp=:v_makp, ngay=to_date(:v_ngay,'dd/mm/yyyy hh24:mi'), madoituong=:v_madoituong, sovaovien=:v_sovaovien, tuoivao=:v_tuoivao,bnmoi=:v_bnmoi,noitiepdon=:v_noitiepdon,loai=:v_loai,userid=:v_userid where maql=:v_maql";
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
                cmd.Parameters.Add("v_mavaovien", NpgsqlDbType.Numeric).Value = v_maql;
                cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
                cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, 2).Value = v_makp;
                cmd.Parameters.Add("v_ngay", NpgsqlDbType.Text).Value = v_ngay16;
                cmd.Parameters.Add("v_madoituong", NpgsqlDbType.Numeric).Value = v_madoituong;
                cmd.Parameters.Add("v_sovaovien", NpgsqlDbType.Varchar, 10).Value = v_sovaovien;
                cmd.Parameters.Add("v_tuoivao", NpgsqlDbType.Varchar, 4).Value = v_tuoivao;
                cmd.Parameters.Add("v_bnmoi", NpgsqlDbType.Numeric).Value = v_benhnhanmoi;
                cmd.Parameters.Add("v_noitiepdon", NpgsqlDbType.Numeric).Value = v_noitiepdon;
                cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
                cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;

                try
                {
                    con.Open();
                    int irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                    if (irec == 0)
                    {
                        sql = "insert into " + s_schema_mmyy(ammyy) + ".tiepdon(mabn,mavaovien,maql,makp,ngay,madoituong,sovaovien,tuoivao,bnmoi,noitiepdon,loai,done,userid,ngayud) values(:v_mabn,:v_mavaovien,:v_maql,:v_makp,to_date(:v_ngay,'dd/mm/yyyy hh24:mi'),:v_madoituong,:v_sovaovien,:v_tuoivao,:v_bnmoi,:v_noitiepdon,:v_loai,0,:v_userid,now())";
                        cmd = new NpgsqlCommand(sql, con);
                        cmd.CommandType = CommandType.Text;

                        cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
                        cmd.Parameters.Add("v_mavaovien", NpgsqlDbType.Numeric).Value = v_maql;
                        cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
                        cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, 2).Value = v_makp;
                        cmd.Parameters.Add("v_ngay", NpgsqlDbType.Text).Value = v_ngay16;
                        cmd.Parameters.Add("v_madoituong", NpgsqlDbType.Numeric).Value = v_madoituong;
                        cmd.Parameters.Add("v_sovaovien", NpgsqlDbType.Varchar, 10).Value = v_sovaovien;
                        cmd.Parameters.Add("v_tuoivao", NpgsqlDbType.Varchar, 4).Value = v_tuoivao;
                        cmd.Parameters.Add("v_bnmoi", NpgsqlDbType.Numeric).Value = v_benhnhanmoi;
                        cmd.Parameters.Add("v_noitiepdon", NpgsqlDbType.Numeric).Value = v_noitiepdon;
                        cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
                        cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;

                        irec = cmd.ExecuteNonQuery();
                        cmd.Dispose();
                    }
                }
                catch (Exception ex)
                {
                    upd_v_error(ammyy, ex.Message, m_computername, s_schema_mmyy(ammyy) + ".tiepdon");
                    return 0;
                }
                finally
                {
                    cmd.Dispose();
                    con.Dispose();
                }
                return v_maql;
            }
            catch
            {
                return 0;
            }
        }
        public bool upd_lienhe_mmyy(string v_mmyy, decimal v_maql, string v_sonha, string v_thon, string v_cholam, string v_matt, string v_maqu, string v_maphuongxa, string v_tuoivao, string v_soluutru, decimal v_honnhan, string v_mabs, decimal v_loai, decimal v_bnmoi)
        {
            if (v_maql == 0)
            {
                return false;
            }
            if (v_mmyy.Length < 4)
            {
                v_mmyy = s_curmmyy;
            }
            sql = "update " + s_schema_mmyy(v_mmyy) + ".lienhe set sonha=:v_sonha, thon=:v_thon, cholam=:v_cholam, matt=:v_matt, maqu=:v_maqu, maphuongxa=:v_maphuongxa, tuoivao=:v_tuoivao, soluutru=:v_soluutru, honnhan=:v_honnhan, mabs=:v_mabs, loai=:v_loai, bnmoi=:v_bnmoi where maql=:v_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
            cmd.Parameters.Add("v_sonha", NpgsqlDbType.Varchar, 15).Value = v_sonha;
            cmd.Parameters.Add("v_thon", NpgsqlDbType.Text).Value = v_thon;
            cmd.Parameters.Add("v_cholam", NpgsqlDbType.Text).Value = v_cholam;
            cmd.Parameters.Add("v_matt", NpgsqlDbType.Varchar, 3).Value = v_matt;
            cmd.Parameters.Add("v_maqu", NpgsqlDbType.Varchar, 5).Value = v_maqu;
            cmd.Parameters.Add("v_maphuongxa", NpgsqlDbType.Varchar, 7).Value = v_maphuongxa;
            cmd.Parameters.Add("v_tuoivao", NpgsqlDbType.Varchar, 4).Value = v_tuoivao;
            cmd.Parameters.Add("v_soluutru", NpgsqlDbType.Varchar, 10).Value = v_soluutru;
            cmd.Parameters.Add("v_honnhan", NpgsqlDbType.Numeric).Value = v_honnhan;
            cmd.Parameters.Add("v_mabs", NpgsqlDbType.Varchar, 4).Value = v_mabs;
            cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
            cmd.Parameters.Add("v_bnmoi", NpgsqlDbType.Numeric).Value = v_bnmoi;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schema_mmyy(v_mmyy) + ".lienhe(maql,sonha,thon,cholam,matt,maqu,maphuongxa,tuoivao,soluutru,honnhan,mabs,loai,bnmoi) values(:v_maql,:v_sonha,:v_thon,:v_cholam,:v_matt,:v_maqu,:v_maphuongxa,:v_tuoivao,:v_soluutru,:v_honnhan,:v_mabs,:v_loai,:v_bnmoi)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
                    cmd.Parameters.Add("v_sonha", NpgsqlDbType.Varchar, 15).Value = v_sonha;
                    cmd.Parameters.Add("v_thon", NpgsqlDbType.Text).Value = v_thon;
                    cmd.Parameters.Add("v_cholam", NpgsqlDbType.Text).Value = v_cholam;
                    cmd.Parameters.Add("v_matt", NpgsqlDbType.Varchar, 3).Value = v_matt;
                    cmd.Parameters.Add("v_maqu", NpgsqlDbType.Varchar, 5).Value = v_maqu;
                    cmd.Parameters.Add("v_maphuongxa", NpgsqlDbType.Varchar, 7).Value = v_maphuongxa;
                    cmd.Parameters.Add("v_tuoivao", NpgsqlDbType.Varchar, 4).Value = v_tuoivao;
                    cmd.Parameters.Add("v_soluutru", NpgsqlDbType.Varchar, 10).Value = v_soluutru;
                    cmd.Parameters.Add("v_honnhan", NpgsqlDbType.Numeric).Value = v_honnhan;
                    cmd.Parameters.Add("v_mabs", NpgsqlDbType.Varchar, 4).Value = v_mabs;
                    cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
                    cmd.Parameters.Add("v_bnmoi", NpgsqlDbType.Numeric).Value = v_bnmoi;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(v_mmyy, ex.Message, m_computername, "lienhe");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_lienhe(decimal v_maql, string v_sonha, string v_thon, string v_cholam, string v_matt, string v_maqu, string v_maphuongxa, string v_tuoivao, string v_soluutru, decimal v_honnhan, string v_mabs, decimal v_loai, decimal v_bnmoi)
        {
            if (v_maql == 0)
            {
                return false;
            }
            sql = "update " + s_schemaroot + ".lienhe set sonha=:v_sonha, thon=:v_thon, cholam=:v_cholam, matt=:v_matt, maqu=:v_maqu, maphuongxa=:v_maphuongxa, tuoivao=:v_tuoivao, soluutru=:v_soluutru, honnhan=:v_honnhan, mabs=:v_mabs, loai=:v_loai, bnmoi=:v_bnmoi where maql=:v_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
            cmd.Parameters.Add("v_sonha", NpgsqlDbType.Varchar, 15).Value = v_sonha;
            cmd.Parameters.Add("v_thon", NpgsqlDbType.Text).Value = v_thon;
            cmd.Parameters.Add("v_cholam", NpgsqlDbType.Text).Value = v_cholam;
            cmd.Parameters.Add("v_matt", NpgsqlDbType.Varchar, 3).Value = v_matt;
            cmd.Parameters.Add("v_maqu", NpgsqlDbType.Varchar, 5).Value = v_maqu;
            cmd.Parameters.Add("v_maphuongxa", NpgsqlDbType.Varchar, 7).Value = v_maphuongxa;
            cmd.Parameters.Add("v_tuoivao", NpgsqlDbType.Varchar, 4).Value = v_tuoivao;
            cmd.Parameters.Add("v_soluutru", NpgsqlDbType.Varchar, 10).Value = v_soluutru;
            cmd.Parameters.Add("v_honnhan", NpgsqlDbType.Numeric).Value = v_honnhan;
            cmd.Parameters.Add("v_mabs", NpgsqlDbType.Varchar, 4).Value = v_mabs;
            cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
            cmd.Parameters.Add("v_bnmoi", NpgsqlDbType.Numeric).Value = v_bnmoi;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schemaroot + ".lienhe(maql,sonha,thon,cholam,matt,maqu,maphuongxa,tuoivao,soluutru,honnhan,mabs,loai,bnmoi) values(:v_maql,:v_sonha,:v_thon,:v_cholam,:v_matt,:v_maqu,:v_maphuongxa,:v_tuoivao,:v_soluutru,:v_honnhan,:v_mabs,:v_loai,:v_bnmoi)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
                    cmd.Parameters.Add("v_sonha", NpgsqlDbType.Varchar, 15).Value = v_sonha;
                    cmd.Parameters.Add("v_thon", NpgsqlDbType.Text).Value = v_thon;
                    cmd.Parameters.Add("v_cholam", NpgsqlDbType.Text).Value = v_cholam;
                    cmd.Parameters.Add("v_matt", NpgsqlDbType.Varchar, 3).Value = v_matt;
                    cmd.Parameters.Add("v_maqu", NpgsqlDbType.Varchar, 5).Value = v_maqu;
                    cmd.Parameters.Add("v_maphuongxa", NpgsqlDbType.Varchar, 7).Value = v_maphuongxa;
                    cmd.Parameters.Add("v_tuoivao", NpgsqlDbType.Varchar, 4).Value = v_tuoivao;
                    cmd.Parameters.Add("v_soluutru", NpgsqlDbType.Varchar, 10).Value = v_soluutru;
                    cmd.Parameters.Add("v_honnhan", NpgsqlDbType.Numeric).Value = v_honnhan;
                    cmd.Parameters.Add("v_mabs", NpgsqlDbType.Varchar, 4).Value = v_mabs;
                    cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
                    cmd.Parameters.Add("v_bnmoi", NpgsqlDbType.Numeric).Value = v_bnmoi;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "lienhe");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_quanhe_mmyy(string v_mmyy, decimal v_maql, string v_quanhe, string v_hoten, string v_diachi, string v_dienthoai)
        {
            if (v_maql == 0)
            {
                return false;
            }
            if (v_mmyy.Length < 4)
            {
                v_mmyy = s_curmmyy;
            }
            sql = "update " + s_schema_mmyy(v_mmyy) + ".quanhe set quanhe=:v_quanhe, hoten=:v_hoten, diachi=:v_diachi, dienthoai=:v_dienthoai where maql=:v_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
            cmd.Parameters.Add("v_quanhe", NpgsqlDbType.Varchar, 30).Value = v_quanhe;
            cmd.Parameters.Add("v_hoten", NpgsqlDbType.Text).Value = v_hoten;
            cmd.Parameters.Add("v_diachi", NpgsqlDbType.Text).Value = v_diachi;
            cmd.Parameters.Add("v_dienthoai", NpgsqlDbType.Varchar, 20).Value = v_dienthoai;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schema_mmyy(v_mmyy) + ".quanhe(maql,quanhe,hoten,diachi,dienthoai) values(:v_maql,:v_quanhe,:v_hoten,:v_diachi,:v_dienthoai)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
                    cmd.Parameters.Add("v_quanhe", NpgsqlDbType.Varchar, 30).Value = v_quanhe;
                    cmd.Parameters.Add("v_hoten", NpgsqlDbType.Text).Value = v_hoten;
                    cmd.Parameters.Add("v_diachi", NpgsqlDbType.Text).Value = v_diachi;
                    cmd.Parameters.Add("v_dienthoai", NpgsqlDbType.Varchar, 20).Value = v_dienthoai;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(v_mmyy, ex.Message, m_computername, "quanhe");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_quanhe(decimal v_maql, string v_quanhe, string v_hoten, string v_diachi, string v_dienthoai)
        {
            if (v_maql == 0)
            {
                return false;
            }
            sql = "update " + s_schemaroot + ".quanhe set quanhe=:v_quanhe, hoten=:v_hoten, diachi=:v_diachi, dienthoai=:v_dienthoai where maql=:v_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
            cmd.Parameters.Add("v_quanhe", NpgsqlDbType.Varchar, 30).Value = v_quanhe;
            cmd.Parameters.Add("v_hoten", NpgsqlDbType.Text).Value = v_hoten;
            cmd.Parameters.Add("v_diachi", NpgsqlDbType.Text).Value = v_diachi;
            cmd.Parameters.Add("v_dienthoai", NpgsqlDbType.Varchar, 20).Value = v_dienthoai;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schemaroot + ".quanhe(maql,quanhe,hoten,diachi,dienthoai) values(:v_maql,:v_quanhe,:v_hoten,:v_diachi,:v_dienthoai)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
                    cmd.Parameters.Add("v_quanhe", NpgsqlDbType.Varchar, 30).Value = v_quanhe;
                    cmd.Parameters.Add("v_hoten", NpgsqlDbType.Text).Value = v_hoten;
                    cmd.Parameters.Add("v_diachi", NpgsqlDbType.Text).Value = v_diachi;
                    cmd.Parameters.Add("v_dienthoai", NpgsqlDbType.Varchar, 20).Value = v_dienthoai;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "quanhe");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_bhyt_mmyy(string v_mmyy, string v_mabn, decimal v_maql, string v_sothe, string v_tn, string v_dn,
            string v_mabv, decimal v_maphu, int v_traituyen)
        {
            if (v_maql == 0) return false;
            if (v_mmyy.Length < 4) v_mmyy = s_curmmyy;
            sql = "update " + s_schema_mmyy(v_mmyy) + ".bhyt set mabn=:v_mabn, sothe=:v_sothe";
            if (v_tn.Length == 10) sql += ", tungay=to_date(:v_tn,'dd/mm/yyyy')";
            if (v_dn.Length == 10) sql += ", denngay=to_date(:v_dn,'dd/mm/yyyy')";
            sql += ",mabv=:v_mabv,maphu=:v_maphu,traituyen=" + v_traituyen + " where maql=:v_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
            cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
            cmd.Parameters.Add("v_sothe", NpgsqlDbType.Varchar, 20).Value = v_sothe;
            if (v_tn.Length == 10) cmd.Parameters.Add("v_tn", NpgsqlDbType.Varchar, 10).Value = v_tn;
            if (v_dn.Length == 10) cmd.Parameters.Add("v_dn", NpgsqlDbType.Varchar, 10).Value = v_dn;
            cmd.Parameters.Add("v_mabv", NpgsqlDbType.Varchar, 9).Value = v_mabv;
            cmd.Parameters.Add("v_maphu", NpgsqlDbType.Numeric).Value = v_maphu;
            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schema_mmyy(v_mmyy) + ".bhyt(mabn,maql,sothe,tungay,denngay,mabv,maphu,traituyen) values(:v_mabn,:v_maql,:v_sothe," + (v_tn.Length == 10 ? "to_date(:v_tn,'dd/mm/yyyy')" : "null") + "," + (v_dn.Length == 10 ? "to_date(:v_dn,'dd/mm/yyyy')" : "null") + ",:v_mabv,:v_maphu," + v_traituyen + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
                    cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
                    cmd.Parameters.Add("v_sothe", NpgsqlDbType.Varchar, 20).Value = v_sothe;
                    if (v_tn.Length == 10) cmd.Parameters.Add("v_tn", NpgsqlDbType.Varchar, 10).Value = v_tn;
                    if (v_dn.Length == 10) cmd.Parameters.Add("v_dn", NpgsqlDbType.Varchar, 10).Value = v_dn;
                    cmd.Parameters.Add("v_mabv", NpgsqlDbType.Varchar, 9).Value = v_mabv;
                    cmd.Parameters.Add("v_maphu", NpgsqlDbType.Numeric).Value = v_maphu;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(v_mmyy, ex.Message, m_computername, "bhyt");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_bhyt(string v_mabn, decimal v_maql, string v_sothe, string v_tn, string v_dn, string v_mabv,
            decimal v_maphu, int v_traituyen)
        {
            if (v_maql == 0) return false;
            sql = "update " + s_schemaroot + ".bhyt set mabn=:v_mabn, sothe=:v_sothe";
            if (v_tn.Length == 10) sql += ", tungay=to_date(:v_tn,'dd/mm/yyyy')";
            if (v_dn.Length == 10) sql += ", denngay=to_date(:v_dn,'dd/mm/yyyy')";
            sql += ",mabv=:v_mabv,maphu=:v_maphu,traituyen=" + v_traituyen + " where maql=:v_maql";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
            cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
            cmd.Parameters.Add("v_sothe", NpgsqlDbType.Varchar, 20).Value = v_sothe;
            if (v_tn.Length == 10) cmd.Parameters.Add("v_tn", NpgsqlDbType.Varchar, 10).Value = v_tn;
            if (v_dn.Length == 10) cmd.Parameters.Add("v_dn", NpgsqlDbType.Varchar, 10).Value = v_dn;
            cmd.Parameters.Add("v_mabv", NpgsqlDbType.Varchar, 9).Value = v_mabv;
            cmd.Parameters.Add("v_maphu", NpgsqlDbType.Numeric).Value = v_maphu;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schemaroot + ".bhyt(mabn,maql,sothe,tungay,denngay,mabv,maphu,traituyen) values(:v_mabn,:v_maql,:v_sothe," + (v_tn.Length == 10 ? "to_date(:v_tn,'dd/mm/yyyy')" : "null") + "," + (v_dn.Length == 10 ? "to_date(:v_dn,'dd/mm/yyyy')" : "null") + ",:v_mabv,:v_maphu," + v_traituyen + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
                    cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
                    cmd.Parameters.Add("v_sothe", NpgsqlDbType.Varchar, 20).Value = v_sothe;
                    if (v_tn.Length == 10) cmd.Parameters.Add("v_tn", NpgsqlDbType.Varchar, 10).Value = v_tn;
                    if (v_dn.Length == 10) cmd.Parameters.Add("v_dn", NpgsqlDbType.Varchar, 10).Value = v_dn;
                    cmd.Parameters.Add("v_mabv", NpgsqlDbType.Varchar, 8).Value = v_mabv;
                    cmd.Parameters.Add("v_maphu", NpgsqlDbType.Numeric).Value = v_maphu;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "bhyt");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_dienthoai(string v_mabn, string v_nha, string v_coquan, string v_didong, string v_email)
        {
            if (v_mabn.Length < 8) return false;
            sql = "update " + s_schemaroot + ".dienthoai set nha=:v_nha, coquan=:v_coquan, didong=:v_didong, email=:v_email where mabn=:v_mabn";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
            cmd.Parameters.Add("v_nha", NpgsqlDbType.Varchar, 8).Value = v_nha;
            cmd.Parameters.Add("v_coquan", NpgsqlDbType.Varchar, 20).Value = v_coquan;
            cmd.Parameters.Add("v_didong", NpgsqlDbType.Varchar, 15).Value = v_didong;
            cmd.Parameters.Add("v_email", NpgsqlDbType.Text).Value = v_email;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schemaroot + ".dienthoai(mabn,nha,coquan,didong,email) values(:v_mabn,:v_nha,:v_coquan,:v_didong,:v_email)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
                    cmd.Parameters.Add("v_nha", NpgsqlDbType.Varchar, 8).Value = v_nha;
                    cmd.Parameters.Add("v_coquan", NpgsqlDbType.Varchar, 20).Value = v_coquan;
                    cmd.Parameters.Add("v_didong", NpgsqlDbType.Varchar, 15).Value = v_didong;
                    cmd.Parameters.Add("v_email", NpgsqlDbType.Text).Value = v_email;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "dienthoai");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_nuocngoai(string m_mabn, string m_id_nuoc)
        {
            sql = "update " + user + ".nuocngoai set id_nuoc=:m_id_nuoc where mabn=:m_mabn";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_id_nuoc", NpgsqlDbType.Varchar, 2).Value = m_id_nuoc;
                cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".nuocngoai(mabn,id_nuoc) values (:m_mabn,:m_id_nuoc)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("m_mabn", NpgsqlDbType.Varchar).Value = m_mabn;
                    cmd.Parameters.Add("m_id_nuoc", NpgsqlDbType.Varchar, 2).Value = m_id_nuoc;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_v_error(ex.Message, m_computername, "nuocngoai");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
                con.Dispose();
            }
            return true;
        }

        public string upd_v_ttrvthatthu(decimal v_id, decimal v_loai, decimal v_quyenso, decimal v_sobienlai, string v_mabn, decimal v_mavaovien, decimal v_maql, decimal v_idkhoa, string v_ngayvao, string v_ngayra, string v_ngaythu, decimal v_sotien, decimal v_tamung, decimal v_userid, decimal v_sotientra, decimal v_useridtra, string v_ngaytra)
        {
            if (v_ngayvao.Length > 10)
            {
                v_ngayvao = v_ngayvao.Substring(0, 16);
            }
            if (v_ngayra.Length > 10)
            {
                v_ngayra = v_ngayra.Substring(0, 16);
            }

            sql = "update " + user + ".v_ttrvthatthu set loai=:v_loai,quyenso=:v_quyenso,sobienlai=:v_sobienlai,mabn=:v_mabn,mavaovien=:v_mavaovien,maql=:v_maql, idkhoa=:v_idkhoa";
            if (v_ngayvao.Length == 16) sql += ",ngayvao=to_date(:v_ngayvao,'dd/mm/yyyy hh24:mi')";
            if (v_ngayra.Length == 16) sql += ",ngayra=to_date(:v_ngayra,'dd/mm/yyyy hh24:mi')";
            if (v_ngaythu.Length == 16) sql += ",ngaythu=to_date(:v_ngaythu,'dd/mm/yyyy hh24:mi')";
            sql += ",sotien=:v_sotien,tamung=:v_tamung,userid=:v_userid,sotientra=:v_sotientra,useridtra=:v_useridtra";
            if (v_ngaytra.Length == 16) sql += ",ngaytra=to_date(:v_ngaytra,'dd/mm/yyyy hh24:mi') ";
            sql += " where id=:v_id ";

            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
            cmd.Parameters.Add("v_quyenso", NpgsqlDbType.Numeric).Value = v_quyenso;
            cmd.Parameters.Add("v_sobienlai", NpgsqlDbType.Numeric).Value = v_sobienlai;
            cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
            cmd.Parameters.Add("v_mavaovien", NpgsqlDbType.Numeric).Value = v_mavaovien;
            cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
            cmd.Parameters.Add("v_idkhoa", NpgsqlDbType.Numeric).Value = v_idkhoa;
            if (v_ngayvao.Length == 16) cmd.Parameters.Add("v_ngayvao", NpgsqlDbType.Varchar, 16).Value = v_ngayvao;
            if (v_ngayra.Length == 16) cmd.Parameters.Add("v_ngayra", NpgsqlDbType.Varchar, 16).Value = v_ngayra;
            if (v_ngaythu.Length == 16) cmd.Parameters.Add("v_ngaythu", NpgsqlDbType.Varchar, 16).Value = v_ngaythu;

            cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
            cmd.Parameters.Add("v_tamung", NpgsqlDbType.Numeric).Value = v_tamung;
            cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
            cmd.Parameters.Add("v_sotientra", NpgsqlDbType.Numeric).Value = v_sotientra;
            cmd.Parameters.Add("v_useridtra", NpgsqlDbType.Numeric).Value = v_useridtra;
            if (v_ngaytra.Length == 16) cmd.Parameters.Add("v_ngaytra", NpgsqlDbType.Varchar, 16).Value = v_ngaytra;
            // cmd.Parameters.Add("v_idttrv", NpgsqlDbType.Numeric).Value = v_idttrv;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".v_ttrvthatthu(id,loai,quyenso,sobienlai,mabn,mavaovien,maql,idkhoa";
                    if (v_ngayvao.Length == 16) sql += ",ngayvao";
                    if (v_ngayra.Length == 16) sql += ",ngayra";
                    if (v_ngaythu.Length == 16) sql += ",ngaythu";
                    sql += ",sotien,tamung,userid,sotientra,useridtra";
                    if (v_ngaytra.Length == 16) sql += ",ngaytra";
                    sql += ") values (:v_id,:v_loai,:v_quyenso,:v_sobienlai,:v_mabn,:v_mavaovien,:v_maql,:v_idkhoa";
                    if (v_ngayvao.Length == 16) sql += ",to_date(:v_ngayvao,'dd/mm/yyyy hh24:mi')";
                    if (v_ngayra.Length == 16) sql += ",to_date(:v_ngayra,'dd/mm/yyyy hh24:mi')";
                    if (v_ngaythu.Length == 16) sql += ",to_date(:v_ngaythu,'dd/mm/yyyy hh24:mi')";

                    sql += ",:v_sotien,:v_tamung,:v_userid,:v_sotientra,:v_useridtra";
                    if (v_ngaytra.Length == 16) sql += ",to_date(:v_ngaytra,'dd/mm/yyyy hh24:mi') ";
                    sql += ")";

                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
                    cmd.Parameters.Add("v_quyenso", NpgsqlDbType.Numeric).Value = v_quyenso;
                    cmd.Parameters.Add("v_sobienlai", NpgsqlDbType.Numeric).Value = v_sobienlai;
                    cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
                    cmd.Parameters.Add("v_mavaovien", NpgsqlDbType.Numeric).Value = v_mavaovien;
                    cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
                    cmd.Parameters.Add("v_idkhoa", NpgsqlDbType.Numeric).Value = v_idkhoa;
                    if (v_ngayvao.Length == 16) cmd.Parameters.Add("v_ngayvao", NpgsqlDbType.Varchar, 16).Value = v_ngayvao;
                    if (v_ngayra.Length == 16) cmd.Parameters.Add("v_ngayra", NpgsqlDbType.Varchar, 16).Value = v_ngayra;
                    if (v_ngaythu.Length == 16) cmd.Parameters.Add("v_ngaythu", NpgsqlDbType.Varchar, 16).Value = v_ngaythu;
                    cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
                    cmd.Parameters.Add("v_tamung", NpgsqlDbType.Numeric).Value = v_tamung;
                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                    cmd.Parameters.Add("v_sotientra", NpgsqlDbType.Numeric).Value = v_sotientra;
                    cmd.Parameters.Add("v_useridtra", NpgsqlDbType.Numeric).Value = v_useridtra;
                    if (v_ngaytra.Length == 16) cmd.Parameters.Add("v_ngaytra", NpgsqlDbType.Varchar, 16).Value = v_ngaytra;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_ttrvthatthu");
                v_id = 0;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return v_id.ToString();
        }
        public string upd_v_ttrvthua(decimal v_id, decimal v_loai, decimal v_quyenso, decimal v_sobienlai, string v_mabn, decimal v_mavaovien, decimal v_maql, decimal v_idkhoa, string v_ngayvao, string v_ngayra, string v_ngaythu, decimal v_sotien, decimal v_tamung, decimal v_userid, decimal v_sotientra, decimal v_useridtra, string v_ngaytra)
        {
            if (v_ngayvao.Length > 10)
            {
                v_ngayvao = v_ngayvao.Substring(0, 16);
            }
            if (v_ngayra.Length > 10)
            {
                v_ngayra = v_ngayra.Substring(0, 16);
            }

            sql = "update " + user + ".v_ttrvthua set loai=:v_loai,quyenso=:v_quyenso,sobienlai=:v_sobienlai,mabn=:v_mabn,mavaovien=:v_mavaovien,maql=:v_maql, idkhoa=:v_idkhoa";
            if (v_ngayvao.Length == 16) sql += ",ngayvao=to_date(:v_ngayvao,'dd/mm/yyyy hh24:mi')";
            if (v_ngayra.Length == 16) sql += ",ngayra=to_date(:v_ngayra,'dd/mm/yyyy hh24:mi')";
            if (v_ngaythu.Length == 16) sql += ",ngaythu=to_date(:v_ngaythu,'dd/mm/yyyy hh24:mi')";
            sql += ",sotien=:v_sotien,tamung=:v_tamung,userid=:v_userid,sotientra=:v_sotientra,useridtra=:v_useridtra";
            if (v_ngaytra.Length == 16) sql += ",ngaytra=to_date(:v_ngaytra,'dd/mm/yyyy hh24:mi') ";
            sql += " where id=:v_id ";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }

            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
            cmd.Parameters.Add("v_quyenso", NpgsqlDbType.Numeric).Value = v_quyenso;
            cmd.Parameters.Add("v_sobienlai", NpgsqlDbType.Numeric).Value = v_sobienlai;
            cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
            cmd.Parameters.Add("v_mavaovien", NpgsqlDbType.Numeric).Value = v_mavaovien;
            cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
            cmd.Parameters.Add("v_idkhoa", NpgsqlDbType.Numeric).Value = v_idkhoa;
            if (v_ngayvao.Length == 16) cmd.Parameters.Add("v_ngayvao", NpgsqlDbType.Varchar, 16).Value = v_ngayvao;
            if (v_ngayra.Length == 16) cmd.Parameters.Add("v_ngayra", NpgsqlDbType.Varchar, 16).Value = v_ngayra;
            if (v_ngaythu.Length == 16) cmd.Parameters.Add("v_ngaythu", NpgsqlDbType.Varchar, 16).Value = v_ngaythu;

            cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
            cmd.Parameters.Add("v_tamung", NpgsqlDbType.Numeric).Value = v_tamung;
            cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
            cmd.Parameters.Add("v_sotientra", NpgsqlDbType.Numeric).Value = v_sotientra;
            cmd.Parameters.Add("v_useridtra", NpgsqlDbType.Numeric).Value = v_useridtra;
            if (v_ngaytra.Length == 16) cmd.Parameters.Add("v_ngaytra", NpgsqlDbType.Varchar, 16).Value = v_ngaytra;
            // cmd.Parameters.Add("v_idttrv", NpgsqlDbType.Numeric).Value = v_idttrv;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".v_ttrvthua(id,loai,quyenso,sobienlai,mabn,mavaovien,maql,idkhoa";
                    if (v_ngayvao.Length == 16) sql += ",ngayvao";
                    if (v_ngayra.Length == 16) sql += ",ngayra";
                    if (v_ngaythu.Length == 16) sql += ",ngaythu";
                    sql += ",sotien,tamung,userid,sotientra,useridtra";
                    if (v_ngaytra.Length == 16) sql += ",ngaytra";
                    sql += ") values (:v_id,:v_loai,:v_quyenso,:v_sobienlai,:v_mabn,:v_mavaovien,:v_maql,:v_idkhoa";
                    if (v_ngayvao.Length == 16) sql += ",to_date(:v_ngayvao,'dd/mm/yyyy hh24:mi')";
                    if (v_ngayra.Length == 16) sql += ",to_date(:v_ngayra,'dd/mm/yyyy hh24:mi')";
                    if (v_ngaythu.Length == 16) sql += ",to_date(:v_ngaythu,'dd/mm/yyyy hh24:mi')";

                    sql += ",:v_sotien,:v_tamung,:v_userid,:v_sotientra,:v_useridtra";
                    if (v_ngaytra.Length == 16) sql += ",to_date(:v_ngaytra,'dd/mm/yyyy hh24:mi') ";
                    sql += ")";

                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
                    cmd.Parameters.Add("v_quyenso", NpgsqlDbType.Numeric).Value = v_quyenso;
                    cmd.Parameters.Add("v_sobienlai", NpgsqlDbType.Numeric).Value = v_sobienlai;
                    cmd.Parameters.Add("v_mabn", NpgsqlDbType.Varchar).Value = v_mabn;
                    cmd.Parameters.Add("v_mavaovien", NpgsqlDbType.Numeric).Value = v_mavaovien;
                    cmd.Parameters.Add("v_maql", NpgsqlDbType.Numeric).Value = v_maql;
                    cmd.Parameters.Add("v_idkhoa", NpgsqlDbType.Numeric).Value = v_idkhoa;
                    if (v_ngayvao.Length == 16) cmd.Parameters.Add("v_ngayvao", NpgsqlDbType.Varchar, 16).Value = v_ngayvao;
                    if (v_ngayra.Length == 16) cmd.Parameters.Add("v_ngayra", NpgsqlDbType.Varchar, 16).Value = v_ngayra;
                    if (v_ngaythu.Length == 16) cmd.Parameters.Add("v_ngaythu", NpgsqlDbType.Varchar, 16).Value = v_ngaythu;
                    cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
                    cmd.Parameters.Add("v_tamung", NpgsqlDbType.Numeric).Value = v_tamung;
                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                    cmd.Parameters.Add("v_sotientra", NpgsqlDbType.Numeric).Value = v_sotientra;
                    cmd.Parameters.Add("v_useridtra", NpgsqlDbType.Numeric).Value = v_useridtra;
                    if (v_ngaytra.Length == 16) cmd.Parameters.Add("v_ngaytra", NpgsqlDbType.Varchar, 16).Value = v_ngaytra;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_ttrvthua");
                v_id = 0;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return v_id.ToString();
        }
        #endregion CẬP NHẬT DATA TABLE

        #region GIỚI HẠN QUYỀN MENU TẮT
        public void f_create_table_ghquyen()
        {
            try
            {
                execute_data("create table " + s_schemaroot + ".v_ghquyen_danhmuc(id numeric(5),loai numeric(2), ma varchar2(20), ten text, ghichu text,dung numeric(1) default 1, constraint pk_v_ghquyen_dmquyen primary key(id,loai)) with oids");
                execute_data("alter table " + m_db_schemaroot + ".v_ghquyen owner to " + m_db_database + "");
                execute_data("create table " + s_schemaroot + ".v_ghquyen_phanquyen(userid numeric(5),loai numeric(2), id_quyen numeric(5), nhap numeric(1) default 0, constraint pk_v_ghquyen_phanquyen primary key(userid,loai,id_quyen)) with oids");
                execute_data("alter table " + m_db_schemaroot + ".v_ghquyen owner to " + m_db_database + "");
                upd_v_ghquyen_danhmuc();
            }
            catch
            {
            }
        }
        public void upd_v_ghquyen_danhmuc()
        {
            try
            {
                execute_data("delete from v_ghquyen_danhmuc");
                //Thu truc tiep: loai=1
                upd_v_ghquyen_danhmuc(2, 1, "2", "Hoàn trả biên lai (Menu tắt)", "", 1);
                upd_v_ghquyen_danhmuc(3, 1, "3", "Sửa ngày, quyển sổ, số biên lai (Menu tắt)", "", 1);
                upd_v_ghquyen_danhmuc(4, 1, "4", "Nhập biên lai bổ sung (Menu tắt)", "", 1);
                upd_v_ghquyen_danhmuc(5, 1, "5", "Số biên lai tăng tự động (Menu tắt)", "", 1);
                upd_v_ghquyen_danhmuc(6, 1, "6", "Lấy ngày chỉ định chưa thu viện phí (Menu tắt)", "", 1);

                //Thu BHYT: loai=2
                upd_v_ghquyen_danhmuc(2, 2, "2", "Hoàn trả biên lai (Menu tắt)", "", 1);
                upd_v_ghquyen_danhmuc(3, 2, "3", "Sửa ngày, quyển sổ, số biên lai (Menu tắt)", "", 1);
                upd_v_ghquyen_danhmuc(4, 2, "4", "Nhập biên lai bổ sung (Menu tắt)", "", 1);
                upd_v_ghquyen_danhmuc(4, 2, "5", "Lấy lại chi phí đã in (Menu tắt)", "", 1);

                //Thu tamung: loai=3
                upd_v_ghquyen_danhmuc(2, 3, "2", "Hoàn trả biên lai (Menu tắt)", "", 1);
                upd_v_ghquyen_danhmuc(3, 3, "3", "Sửa ngày, quyển sổ, số biên lai (Menu tắt)", "", 1);
                upd_v_ghquyen_danhmuc(4, 3, "4", "Nhập bổ sung (cho nhập số biên lai) (Menu tắt)", "", 1);

                //Thanh toan ra vien: loai=4
                upd_v_ghquyen_danhmuc(2, 4, "2", "Hoàn trả biên lai (Menu tắt)", "", 1);
                upd_v_ghquyen_danhmuc(3, 4, "3", "Sửa ngày, quyển sổ, số biên lai (Menu tắt)", "", 1);
                upd_v_ghquyen_danhmuc(4, 4, "4", "Nhập biên lai bổ sung (Menu tắt)", "", 1);
                upd_v_ghquyen_danhmuc(5, 4, "5", "Lấy lại chi phí đã in (Menu tắt)", "", 1);
                upd_v_ghquyen_danhmuc(6, 4, "6", "Tổng hợp lại số liệu khoa chưa chuyển thanh toán (Menu tắt)", "", 1);
                upd_v_ghquyen_danhmuc(7, 4, "7", "Tự động tổng hợp lại số liệu nếu khoa chưa chuyển thanh toán (Menu tắt)", "", 1);

                //Hoan tra bien lai: loai=5
                upd_v_ghquyen_danhmuc(2, 5, "HT", "Xoá biên lai hoàn trả)", "", 1);
            }
            catch
            {
            }
        }
        private bool upd_v_ghquyen_danhmuc(decimal v_id, decimal v_loai, string v_ma, string v_ten, string v_ghichu, decimal v_dung)
        {
            sql = "update " + s_schemaroot + ".v_ghquyen_danhmuc set ma=:v_ma, ten=:v_ten,ghichu=:v_ghichu,dung=:v_dung where id=:v_id and loai=:v_loai";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
            cmd.Parameters.Add("v_ma", NpgsqlDbType.Varchar, 20).Value = v_ma;
            cmd.Parameters.Add("v_ten", NpgsqlDbType.Text, 255).Value = v_ten;
            cmd.Parameters.Add("v_ghichu", NpgsqlDbType.Text, 50).Value = v_ghichu;
            cmd.Parameters.Add("v_dung", NpgsqlDbType.Numeric).Value = v_dung;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schemaroot + ".v_ghquyen_danhmuc(id,loai,ma,ten,ghichu,dung) values(:v_id,:v_loai,:v_ma,:v_ten,:v_ghichu,:v_dung)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_loai", NpgsqlDbType.Numeric).Value = v_loai;
                    cmd.Parameters.Add("v_ma", NpgsqlDbType.Varchar, 20).Value = v_ma;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text, 255).Value = v_ten;
                    cmd.Parameters.Add("v_ghichu", NpgsqlDbType.Text, 50).Value = v_ghichu;
                    cmd.Parameters.Add("v_dung", NpgsqlDbType.Numeric).Value = v_dung;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_ghquyen_danhmuc");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }

        public DataSet frmDMQuyencapnhat_f_load_dg0(string v_userid)
        {
            try
            {
                string sql = "select a.id, a.ma, a.ten, c.nhap from v_ghquyen_danhmuc a, (select * from v_ghquyen_phanquyen where loai=1 and userid=" + v_userid + ") c where a.loai=1 and a.id=c.id_quyen(+)";
                return get_data(sql);
            }
            catch
            {
                return null;
            }
        }
        public DataSet frmDMQuyencapnhat_f_load_dg1(string v_userid)
        {
            try
            {
                string sql = "select a.id, a.ma, a.ten, c.nhap from v_ghquyen_danhmuc a, (select * from v_ghquyen_phanquyen where loai=2 and userid=" + v_userid + ") c where a.loai=2 and a.id=c.id_quyen(+)";
                return get_data(sql);
            }
            catch
            {
                return null;
            }
        }
        public DataSet frmDMQuyencapnhat_f_load_dg2(string v_userid)
        {
            try
            {
                string sql = "select a.id, a.ma, a.ten, c.nhap from v_ghquyen_danhmuc a, (select * from v_ghquyen_phanquyen where loai=3 and userid=" + v_userid + ") c where a.loai=3 and a.id=c.id_quyen(+)";
                return get_data(sql);
            }
            catch
            {
                return null;
            }
        }
        public DataSet frmDMQuyencapnhat_f_load_dg3(string v_userid)
        {
            try
            {
                string sql = "select a.id, a.ma, a.ten, c.nhap from v_ghquyen_danhmuc a, (select * from v_ghquyen_phanquyen where loai=4 and userid=" + v_userid + ") c where a.loai=4 and a.id=c.id_quyen(+)";
                return get_data(sql);
            }
            catch
            {
                return null;
            }
        }
        public DataSet frmDMQuyencapnhat_f_load_dg4(string v_userid)
        {
            try
            {
                string sql = "select a.id, a.ma, a.ten, c.nhap from " + m_db_schemaroot + ".v_ghquyen_danhmuc a, (select * from " + m_db_schemaroot + ".v_ghquyen_phanquyen where loai=5 and userid=" + v_userid + ") c where a.loai=5 and a.id=c.id_quyen(+)";
                return get_data(sql);
            }
            catch
            {
                return null;
            }
        }
        public DataSet frmDMQuyencapnhat_f_load_dg5(string v_userid)
        {
            try
            {
                string sql = "select a.id, a.ma, a.ten, nhap from " + m_db_schemaroot + ".v_ghquyen_danhmuc a, (select * from " + m_db_schemaroot + ".v_ghquyen_phanquyen where loai=6 and userid=" + v_userid + ") c where a.loai=6 and a.id=c.id_quyen(+)";
                return get_data(sql);
            }
            catch
            {
                return null;
            }
        }
        private bool f_ghquyen_thutructiep_nhap(string v_userid, string v_id_quyen, bool v_default)
        {
            bool r = v_default;
            try
            {
                r = get_data("select nhap from " + m_db_schemaroot + ".v_ghquyen_phanquyen where loai=1 and userid=" + v_userid + " and id_quyen=" + v_id_quyen + "").Tables[0].Rows[0][0].ToString().Trim() == "1";
            }
            catch
            {
                r = v_default;
            }
            return r;
        }
        public bool f_ghquyen_thutructiep_hoantra(string v_userid)
        {
            return f_ghquyen_thutructiep_nhap(v_userid, "2", true);
        }
        public bool f_ghquyen_thutructiep_sua_ngay_quyenso_sobienlai(string v_userid)
        {
            return f_ghquyen_thutructiep_nhap(v_userid, "3", true);
        }
        public bool f_ghquyen_thutructiep_nhapbosung(string v_userid)
        {
            return f_ghquyen_thutructiep_nhap(v_userid, "4", true);
        }
        public bool f_ghquyen_thutructiep_sobienlaitangtudong(string v_userid)
        {
            return f_ghquyen_thutructiep_nhap(v_userid, "5", true);
        }
        public bool f_ghquyen_thutructiep_layngaychidinhchuathu(string v_userid)
        {
            return f_ghquyen_thutructiep_nhap(v_userid, "6", true);
        }
        private bool f_ghquyen_thubhyt_nhap(string v_userid, string v_id_quyen, bool v_default)
        {
            bool r = v_default;
            try
            {
                r = get_data("select nhap from " + m_db_schemaroot + ".v_ghquyen_phanquyen where loai=2 and userid=" + v_userid + " and id_quyen=" + v_id_quyen + "").Tables[0].Rows[0][0].ToString().Trim() == "1";
            }
            catch
            {
                r = v_default;
            }
            return r;
        }
        public bool f_ghquyen_thubhyt_hoantra(string v_userid)
        {
            return f_ghquyen_thubhyt_nhap(v_userid, "2", true);
        }
        public bool f_ghquyen_thubhyt_sua_ngay_quyenso_sobienlai(string v_userid)
        {
            return f_ghquyen_thubhyt_nhap(v_userid, "3", true);
        }
        public bool f_ghquyen_thubhyt_nhapbosung(string v_userid)
        {
            return f_ghquyen_thubhyt_nhap(v_userid, "4", true);
        }
        public bool f_ghquyen_thubhyt_laylaichiphidain(string v_userid)
        {
            return f_ghquyen_thubhyt_nhap(v_userid, "5", true);
        }
        private bool f_ghquyen_thutamung_nhap(string v_userid, string v_id_quyen, bool v_default)
        {
            bool r = v_default;
            try
            {
                r = get_data("select nhap from " + m_db_schemaroot + ".v_ghquyen_phanquyen where loai=3 and userid=" + v_userid + " and id_quyen=" + v_id_quyen + "").Tables[0].Rows[0][0].ToString().Trim() == "1";
            }
            catch
            {
                r = v_default;
            }
            return r;
        }
        public bool f_ghquyen_thutamung_hoantra(string v_userid)
        {
            return f_ghquyen_thutamung_nhap(v_userid, "2", true);
        }
        public bool f_ghquyen_thutamung_sua_ngay_quyenso_sobienlai(string v_userid)
        {
            return f_ghquyen_thutamung_nhap(v_userid, "3", true);
        }
        public bool f_ghquyen_thutamung_nhapbosung(string v_userid)
        {
            return f_ghquyen_thutamung_nhap(v_userid, "4", true);
        }
        private bool f_ghquyen_thanhtoanravien_nhap(string v_userid, string v_id_quyen, bool v_default)
        {
            bool r = v_default;
            try
            {
                r = get_data("select nhap nhap from " + m_db_schemaroot + ".v_ghquyen_phanquyen where loai=4 and userid=" + v_userid + " and id_quyen=" + v_id_quyen + "").Tables[0].Rows[0][0].ToString().Trim() == "1";
            }
            catch
            {
                r = v_default;
            }
            return r;
        }
        public bool f_ghquyen_thanhtoanravien_hoantra(string v_userid)
        {
            return f_ghquyen_thanhtoanravien_nhap(v_userid, "2", true);
        }
        public bool f_ghquyen_thanhtoanravien_sua_ngay_quyenso_sobienlai(string v_userid)
        {
            return f_ghquyen_thanhtoanravien_nhap(v_userid, "3", true);
        }
        public bool f_ghquyen_thanhtoanravien_nhapbosung(string v_userid)
        {
            return f_ghquyen_thanhtoanravien_nhap(v_userid, "4", true);
        }
        public bool f_ghquyen_thanhtoanravien_laylaichiphi(string v_userid)
        {
            return f_ghquyen_thanhtoanravien_nhap(v_userid, "5", true);
        }
        public bool f_ghquyen_thanhtoanravien_tonghoplaineukhoachuachuyen(string v_userid)
        {
            return f_ghquyen_thanhtoanravien_nhap(v_userid, "6", true);
        }
        public bool f_ghquyen_thanhtoanravien_tutonghoplaineukhoachuachuyen(string v_userid)
        {
            return f_ghquyen_thanhtoanravien_nhap(v_userid, "7", true);
        }
        private bool f_ghquyen_hoantra_nhap(string v_userid, string v_id_quyen, bool v_default)
        {
            bool r = v_default;
            try
            {
                r = get_data("select nhap from " + m_db_schemaroot + ".v_ghquyen_phanquyen where loai=5 and userid=" + v_userid + " and id_quyen=" + v_id_quyen + "").Tables[0].Rows[0][0].ToString().Trim() == "1";
            }
            catch
            {
                r = v_default;
            }
            return r;
        }
        public bool f_ghquyen_hoantra_xoa(string v_userid)
        {
            return f_ghquyen_hoantra_nhap(v_userid, "2", true);
        }
        #endregion GIỚI HẠN QUYỀN MENU TẮT

        #region KẾT XUẤT EXCEL

        public string f_export_excel(DataTable dset, string tenfile)
        {
            try
            {

                string dirPath = AppDomain.CurrentDomain.BaseDirectory + "Excel";
                string filePath = dirPath + "\\" + tenfile + ".xls";
                if (!System.IO.Directory.Exists(dirPath)) System.IO.Directory.CreateDirectory(dirPath);
                System.IO.StreamWriter sw = new System.IO.StreamWriter(filePath, false, System.Text.Encoding.Unicode);
                string astr = "";
                astr = "<Table>";//"<Table border=1>";
                astr = astr + "<tr>";
                for (int i = 0; i < dset.Columns.Count; i++)
                {
                    astr = astr + "<th>";
                    astr = astr + dset.Columns[i].ColumnName;
                    astr = astr + "</th>";
                }
                astr = astr + "</tr>";
                sw.Write(astr);
                for (int i = 0; i < dset.Rows.Count; i++)
                {
                    astr = "<tr>";
                    for (int j = 0; j < dset.Columns.Count; j++)
                    {
                        astr = astr + "<td>";
                        astr = astr + dset.Rows[i][j].ToString();
                        astr = astr + "</td>";
                    }
                    astr = astr + "</tr>";
                    sw.Write(astr);
                }
                astr = "</Table>";
                sw.Write(astr);
                sw.Close();
                return filePath;
            }
            catch
            {
                return "";
            }
        }
        public string f_export_excel(DataSet v_ds, string v_file, string v_field, string v_caption, string v_title, string v_ghichu)
        {
            try
            {
                if (v_file.ToLower().IndexOf(".xls") != v_file.Length - 4)
                {
                    v_file = v_file + ".xls";
                }
                System.IO.StreamWriter sw = new System.IO.StreamWriter(v_file, false, System.Text.Encoding.UTF8);
                string astr = "";
                astr = "<Table>";
                foreach (string atmp in v_title.Split(','))
                {
                    astr = astr + "<tr>";
                    astr = astr + "<th colspan=\"" + v_caption.Split(',').Length.ToString() + "\" style=\"font-family: Tahoma; font-weight: bold\" valign=\"middle\" align=\"center\">";
                    astr = astr + atmp.Trim();
                    astr = astr + "</th>";
                    astr = astr + "</tr>";
                }
                foreach (string atmp in v_ghichu.Split(','))
                {
                    astr = astr + "<tr>";
                    astr = astr + "<th colspan=\"" + v_caption.Split(',').Length.ToString() + "\" style=\"font-family: Tahoma; font-weight: bold\" valign=\"middle\" align=\"left\">";
                    astr = astr + "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" + atmp.Trim();
                    astr = astr + "</th>";
                    astr = astr + "</tr>";
                }
                sw.Write(astr);

                astr = "<tr>";
                int aindex = 0;
                foreach (string atmp in v_field.Split(','))
                {
                    for (int i = 0; i < v_ds.Tables[0].Columns.Count; i++)
                    {
                        if (v_ds.Tables[0].Columns[i].ColumnName.ToLower() == atmp)
                        {
                            astr = astr + "<th>";
                            astr = astr + v_caption.Split(',')[aindex].Trim();
                            astr = astr + "</th>";
                            aindex++;
                        }
                    }
                }
                astr = astr + "</tr>";
                sw.Write(astr);
                for (int i = 0; i < v_ds.Tables[0].Rows.Count; i++)
                {
                    astr = "<tr>";
                    foreach (string atmp in v_field.Split(','))
                    {
                        for (int j = 0; j < v_ds.Tables[0].Columns.Count; j++)
                        {
                            if (v_ds.Tables[0].Columns[j].ColumnName.ToLower() == atmp)
                            {
                                astr = astr + "<td>";
                                astr = astr + v_ds.Tables[0].Rows[i][j].ToString();
                                astr = astr + "</td>";
                            }
                        }
                    }
                    astr = astr + "</tr>";
                    sw.Write(astr);
                }
                astr = "</Table>";
                sw.Write(astr);
                sw.Close();
                return v_file;
            }
            catch
            {
                return "";
            }
        }
        public void check_process_Excel()
        {
            Process[] processes = Process.GetProcesses();

            if (processes.Length > 1)
            {
                int i = 0;
                for (int n = 0; n <= processes.Length - 1; n++)
                {
                    if (((Process)processes[n]).ProcessName == "EXCEL")
                    {
                        i++;
                        ((Process)processes[n]).Kill();
                    }
                }
            }
        }
        public string getIndex(int i)
        {
            string[] map = {"A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P", "Q", "R", "S", "T", "U", "V", "W", "X", "Y", "Z",
							   "AA", "AB", "AC", "AD", "AE", "AF", "AG", "AH", "AI", "AJ", "AK", "AL", "AM", "AN", "AO", "AP", "AQ", "AR", "AS", "AT", "AU", "AV", "AW", "AX", "AY", "AZ",
							   "BA", "BB", "BC", "BD", "BE", "BF", "BG", "BH", "BI", "BJ", "BK", "BL", "BM", "BN", "BO", "BP", "BQ", "BR", "BS", "BT", "BU", "BV", "BW", "BX", "BY", "BZ",
							   "CA", "CB", "CC", "CD", "CE", "CF", "CG", "CH", "CI", "CJ", "CK", "CL", "CM", "CN", "CO", "CP", "CQ", "CR", "CS", "CT", "CU", "CV", "CW", "CX", "CY", "CZ",
							   "DA", "DB", "DC", "DD", "DE", "DF", "DG", "DH", "DI", "DJ", "DK", "DL", "DM", "DN", "DO", "DP", "DQ", "DR", "DS", "DT", "DU", "DV", "DW", "DX", "DY", "DZ",
							   "EA", "EB", "EC", "ED", "EE", "EF", "EG", "EH", "EI", "EJ", "EK", "EL", "EM", "EN", "EO", "EP", "EQ", "ER", "ES", "ET", "EU", "EV", "EW", "EX", "EY", "EZ",
							   "FA", "FB", "FC", "FD", "FE", "FF", "FG", "FH", "FI", "FJ", "FK", "FL", "FM", "FN", "FO", "FP", "FQ", "FR", "FS", "FT", "FU", "FV", "FW", "FX", "FY", "FZ",
							   "GA", "GB", "GC", "GD", "GE", "GF", "GG", "GH", "GI", "GJ", "GK", "GL", "GM", "GN", "GO", "GP", "GQ", "GR", "GS", "GT", "GU", "GV", "GW", "GX", "GY", "GZ",
							   "HA", "HB", "HC", "HD", "HE", "HF", "HG", "HH", "HI", "HJ", "HK", "HL", "HM", "HN", "HO", "HP", "HQ", "HR", "HS", "HT", "HU", "HV", "HW", "HX", "HY", "HZ",
							   "IA", "IB", "IC", "ID", "IE", "IF", "IG", "IH", "II", "IJ", "IK", "IL", "IM", "IN", "IO", "IP", "IQ", "IR", "IS", "IT", "IU", "IV", "IW", "IX", "IY", "IZ",
							   "JA", "JB", "JC", "JD", "JE", "JF", "JG", "JH", "JI", "JJ", "JK", "JL", "JM", "JN", "JO", "JP", "JQ", "JR", "JS", "JT", "JU", "JV", "JW", "JX", "JY", "JZ",
							   "KA", "KB", "KC", "KD", "KE", "KF", "KG", "KH", "KI", "KJ", "KK", "KL", "KM", "KN", "KO", "KP", "KQ", "KR", "KS", "KT", "KU", "KV", "KW", "KX", "KY", "KZ",
							   "LA", "LB", "LC", "LD", "LE", "LF", "LG", "LH", "LI", "LJ", "LK", "LL", "LM", "LN", "LO", "LP", "LQ", "LR", "LS", "LT", "LU", "LV", "LW", "LX", "LY", "LZ",
							   "MA", "MB", "MC", "MD", "ME", "MF", "MG", "MH", "MI", "MJ", "MK", "ML", "MM", "MN", "MO", "MP", "MQ", "MR", "MS", "MT", "MU", "MV", "MW", "MX", "MY", "MZ",
							   "NA", "NB", "NC", "ND", "NE", "NF", "NG", "NH", "NI", "NJ", "NK", "NL", "NM", "NN", "NO", "NP", "NQ", "NR", "NS", "NT", "NU", "NV", "NW", "NX", "NY", "NZ",
							   "OA", "OB", "OC", "OD", "OE", "OF", "OG", "OH", "OI", "OJ", "OK", "OL", "OM", "ON", "OO", "OP", "OQ", "OR", "OS", "OT", "OU", "OV", "OW", "OX", "OY", "OZ",
							   "PA", "PB", "PC", "PD", "PE", "PF", "PG", "PH", "PI", "PJ", "PK", "PL", "PM", "PN", "PO", "PP", "PQ", "PR", "PS", "PT", "PU", "PV", "PW", "PX", "PY", "PZ",
							   "QA", "QB", "QC", "QD", "QE", "QF", "QG", "QH", "QI", "QJ", "QK", "QL", "QM", "QN", "QO", "QP", "QQ", "QR", "QS", "QT", "QU", "QV", "QW", "QX", "QY", "QZ",
							   "RA", "RB", "RC", "RD", "RE", "RF", "RG", "RH", "RI", "RJ", "RK", "RL", "RM", "RN", "RO", "RP", "RQ", "RR", "RS", "RT", "RU", "RV", "RW", "RX", "RY", "RZ",
							   "SA", "SB", "SC", "SD", "SE", "SF", "SG", "SH", "SI", "SJ", "SK", "SL", "SM", "SN", "SO", "SP", "SQ", "SR", "SS", "ST", "SU", "SV", "SW", "SX", "SY", "SZ",
							   "TA", "TB", "TC", "TD", "TE", "TF", "TG", "TH", "TI", "TJ", "TK", "TL", "TM", "TN", "TO", "TP", "TQ", "TR", "TS", "TT", "TU", "TV", "TW", "TX", "TY", "TZ",
							   "UA", "UB", "UC", "UD", "UE", "UF", "UG", "UH", "UI", "UJ", "UK", "UL", "UM", "UN", "UO", "UP", "UQ", "UR", "US", "UT", "UU", "UV", "UW", "UX", "UY", "UZ",
							   "VA", "VB", "VC", "VD", "VE", "VF", "VG", "VH", "VI", "VJ", "VK", "VL", "VM", "VN", "VO", "VP", "VQ", "VR", "VS", "VT", "VU", "VV", "VW", "VX", "VY", "VZ",
							   "WA", "WB", "WC", "WD", "WE", "WF", "WG", "WH", "WI", "WJ", "WK", "WL", "WM", "WN", "WO", "WP", "WQ", "WR", "WS", "WT", "WU", "WV", "WW", "WX", "WY", "WZ",
							   "XA", "XB", "XC", "XD", "XE", "XF", "XG", "XH", "XI", "XJ", "XK", "XL", "XM", "XN", "XO", "XP", "XQ", "XR", "XS", "XT", "XU", "XV", "XW", "XX", "XY", "XZ",
							   "YA", "YB", "YC", "YD", "YE", "YF", "YG", "YH", "YI", "YJ", "YK", "YL", "YM", "YN", "YO", "YP", "YQ", "YR", "YS", "YT", "YU", "YV", "YW", "YX", "YY", "YZ",
							   "ZA", "ZB", "ZC", "ZD", "ZE", "ZF", "ZG", "ZH", "ZI", "ZJ", "ZK", "ZL", "ZM", "ZN", "ZO", "ZP", "ZQ", "ZR", "ZS", "ZT", "ZU", "ZV", "ZW", "ZX", "ZY", "ZZ"};

            return map[i];
        }
        #endregion

        #region TÙY CHỌN
        public string get_report_name(string v_reportgoc)
        {
            string amabv = Mabv;
            if (System.IO.File.Exists("..\\..\\..\\Report\\" + amabv + "_" + v_reportgoc))
            {
                return amabv + "_" + v_reportgoc;
            }
            return v_reportgoc;
        }
        public string Mabv
        {
            get
            {
                string art = "";
                try
                {
                    XmlDocument doc = new XmlDocument();
                    doc.Load("..//..//..//xml//maincode.xml");
                    XmlNodeList nodeLst = doc.GetElementsByTagName("Mabv");
                    art = (nodeLst.Item(0).InnerText == "") ? "701.1.01" : nodeLst.Item(0).InnerText;
                }
                catch
                {
                    art = "";
                }
                return art;
            }
        }
        public string Tenbv
        {
            get
            {
                string art = "";
                try
                {
                    XmlDocument doc = new XmlDocument();
                    doc.Load("..//..//..//xml//maincode.xml");
                    XmlNodeList nodeLst = doc.GetElementsByTagName("Tenbv");
                    art = nodeLst.Item(0).InnerText;
                }
                catch
                {
                    art = "";
                }
                return art;
            }
        }
        public string Syte
        {
            get
            {
                string art = "";
                try
                {
                    XmlDocument doc = new XmlDocument();
                    doc.Load("..//..//..//xml//maincode.xml");
                    XmlNodeList nodeLst = doc.GetElementsByTagName("Syte");
                    art = nodeLst.Item(0).InnerText;
                }
                catch
                {
                    art = "";
                }
                return art;
            }
        }
        public string Dienthoai
        {
            get
            {
                string art = "";
                try
                {
                    XmlDocument doc = new XmlDocument();
                    doc.Load("..//..//..//xml//maincode.xml");
                    XmlNodeList nodeLst = doc.GetElementsByTagName("Dienthoai");
                    art = nodeLst.Item(0).InnerText;
                }
                catch
                {
                    art = "";
                }
                return art;
            }
        }
        public int Mabv_so
        {
            get
            {
                string s = "";
                for (int i = 0; i < Mabv.Length; i++)
                    s += (Mabv.Substring(i, 1) == ".") ? "" : Mabv.Substring(i, 1);
                return int.Parse(s);
            }
        }
        public DataSet Tqx(string s)
        {
            return get_data("select a.tentt||' - '||b.tenquan||' - '||c.tenpxa as TEN,c.MAPHUONGXA,c.VIETTAT from " + s_schemaroot + ".btdtt a," + s_schemaroot + ".btdquan b," + s_schemaroot + ".btdpxa c where a.matt=b.matt and b.maqu=c.maqu and upper(c.viettat) like '" + s.Trim().ToUpper() + "%'" + " order by c.maphuongxa");
        }
        /*
		public int get_maphu(string sothe)
		{
			if (sothe.Trim().Length>13) return (get_ma16.IndexOf(sothe.Trim().Substring(4,2))==-1)?0:1;
			else return (get_ma13.IndexOf(sothe.Trim().Substring(4,1))==-1)?0:1;
		}
        */

        public string mathecu_95
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=442");
                    if (ds.Tables[0].Rows.Count == 0) return "GL+JL+HN+HL";
                    else return ds.Tables[0].Rows[0]["ten"].ToString();
                }
                catch
                {
                    return "GL+JL+HN+HL";
                }
            }
        }

        public int get_maphu(string sothe)
        {
            try
            {
                string ma13 = ma13_vitri.ToString(), ma16 = ma16_vitri.ToString();
                int m131 = 4, m132 = 1, m161 = 4, m162 = 2, pos = 0;
                try
                {
                    if (ma13 != "")
                    {
                        pos = ma13.IndexOf(",");
                        if (pos != -1)
                        {
                            m131 = int.Parse(ma13.Substring(0, pos)) - 1;
                            m132 = int.Parse(ma13.Substring(pos + 1));
                        }
                    }
                    if (ma16 != "")
                    {
                        pos = ma16.IndexOf(",");
                        if (pos != -1)
                        {
                            m161 = int.Parse(ma16.Substring(0, pos)) - 1;
                            m162 = int.Parse(ma16.Substring(pos + 1));
                        }
                    }
                }
                catch { m131 = 4; m132 = 1; m161 = 4; m162 = 2; }
                if (sothe.Trim().Length == 18 || sothe.Trim().Length == 13)
                {
                    string _mathecu_95 = mathecu_95;
                    return (_mathecu_95.IndexOf(sothe.Trim().Substring(m161, m162)) != -1) ? 2 : (get_ma16.IndexOf(sothe.Trim().Substring(m161, m162)) != -1) ? 1 : 0;
                }
                else if (sothe.Trim().Length == 16)
                    return 0;
                else
                    return (get_ma13.IndexOf(sothe.Trim().Substring(m131, m132)) != -1) ? 1 : (get_ma16_95.IndexOf(sothe.Trim().Substring(m131, m132)) != -1) ? 2 : 0;
            }
            catch { return 0; }
        }
        public string get_ma13 { get { return get_data("select ten from " + s_schemaroot + ".thongso where id=49").Tables[0].Rows[0][0].ToString(); } }
        public string get_ma16 { get { return get_data("select ten from " + s_schemaroot + ".thongso where id=50").Tables[0].Rows[0][0].ToString(); } }
        public string get_ma16_95 { get { return get_data("select ten from " + s_schemaroot + ".thongso where id=-50").Tables[0].Rows[0][0].ToString(); } }
        private string f_mavp(string s, int so)
        {
            DataSet m_ds = new DataSet();
            try
            {
                if (!System.IO.File.Exists("..//..//..//xml//v_khongdau.xml"))
                {
                    upd_v_khongdau();
                    m_ds = f_get_v_khongdau();
                    m_ds.WriteXml("..//..//..//xml//v_khongdau.xml", XmlWriteMode.WriteSchema);
                    //System.IO.File.Copy("..//..//..//xml//khongdau.xml","..//..//..//xml//v_khongdau.xml",false);
                }
            }
            catch
            {
            }
            m_ds = new DataSet();
            m_ds.ReadXml("..//..//..//xml//v_khongdau.xml");
            string s1 = s.Trim().ToUpper(), s2 = "";
            DataRow r;
            for (int i = 0; i < s1.Length; i++)
            {
                if (s1[i].ToString() != " ")
                {
                    try
                    {
                        r = m_ds.Tables[0].Select("codau='" + s1[i].ToString() + "'")[0];
                    }
                    catch
                    {
                        r = null;
                    }
                    if (r != null) s2 += r[1].ToString();
                    else s2 += s1[i];
                }
                if (s2.Length == so) break;
            }
            return s2;
        }
        public string f_get_mavp(string s)
        {
            string ret = "", s1 = f_mavp(s, 3);
            try
            {
                sql = "select max(substr(ma,4)) ";
                sql += " from " + s_schemaroot + ".v_giavp" + s_dblink + " where substr(ma,1,3)='" + s1.ToUpper() + "'  and length(ma)=6 ";
                sql += " and substr(ma,4,1) in('0','1','2','3','4','5','6','7','8','9')";
                sql += " and substr(ma,5,1) in('0','1','2','3','4','5','6','7','8','9')";
                sql += " and substr(ma,6,1) in('0','1','2','3','4','5','6','7','8','9')";
                int i = int.Parse(get_data(sql).Tables[0].Rows[0][0].ToString()) + 1;
                ret = s1 + i.ToString().PadLeft(3, '0');
            }
            catch { ret = s1 + "001"; }
            return ret;
        }
        public void f_reset_mavp()
        {
            try
            {
                execute_data("update " + s_schemaroot + ".v_giavp set ma=''");
                DataSet ads = get_data("select trim(to_char(id,999999)) id, trim(ten) ten from " + s_schemaroot + ".v_giavp order by ten asc,id asc");
                for (int i = 0; i < ads.Tables[0].Rows.Count; i++)
                {
                    try
                    {
                        execute_data("update " + s_schemaroot + ".v_giavp set ma='" + f_get_mavp(ads.Tables[0].Rows[i]["ten"].ToString().Trim()) + "' where id=" + ads.Tables[0].Rows[i]["id"].ToString() + "");
                    }
                    catch
                    {
                    }
                }
            }
            catch
            {
            }
        }
        public string f_ngaykhoaso(string v_userid)
        {
            string art = "";
            try
            {
                art = get_data("select ngay from medibv.v_khoaso where userid=" + v_userid).Tables[0].Rows[0][0].ToString();
            }
            catch
            {
            }
            return art;
        }
        public int iTreem6
        {
            get
            {
                try
                {
                    return int.Parse(get_data("select ten from " + user + ".thongso where id=42").Tables[0].Rows[0][0].ToString());
                }
                catch { return 6; }
            }
        }
        public int iTreem15
        {
            get
            {
                try
                {
                    return int.Parse(get_data("select ten from " + user + ".thongso where id=43").Tables[0].Rows[0][0].ToString());
                }
                catch { return 15; }
            }
        }
        public int Namsinh(string ngayvao, int ituoi, int iloai)
        {
            int namht = (ngayvao != "") ? int.Parse(ngayvao.Substring(6, 4)) : DateTime.Now.Year;
            int iNamsinh = 0;
            if (iloai == 1 && ituoi <= 12)
            {
                if (bNgay(DateTime.Now.Day.ToString().PadLeft(2, '0') + "/" + ituoi.ToString().PadLeft(2, '0') + "/" + namht.ToString().PadLeft(4, '0'), DateTime.Now.Day.ToString().PadLeft(2, '0') + "/" + DateTime.Now.Month.ToString().PadLeft(2, '0') + "/" + namht.ToString().PadLeft(4, '0')))
                    iNamsinh = namht - 1;
                else iNamsinh = namht;
            }
            else
            {
                switch (iloai)
                {
                    case 0: iNamsinh = namht - ituoi;
                        break;
                    case 1: iNamsinh = namht - ituoi / 12;
                        break;
                    case 2: iNamsinh = namht - ituoi / 365;
                        break;
                    default: iNamsinh = namht;
                        break;
                }
            }
            return iNamsinh;
        }
        public string Tuoivao(string ngayvao, string ngaysinh)
        {
            string tuoi = "";
            int namht = DateTime.Now.Year;
            int thanght = DateTime.Now.Month;
            int ngayht = DateTime.Now.Day;
            int gioht = DateTime.Now.Hour;

            int nam = int.Parse(ngaysinh.Substring(6, 4));
            int thang = int.Parse(ngaysinh.Substring(3, 2));
            int ngay = int.Parse(ngaysinh.Substring(0, 2));
            int gio = (ngaysinh.Length > 10) ? int.Parse(ngaysinh.Substring(11, 2)) : 0;
            if (ngayvao != "")
            {
                namht = int.Parse(ngayvao.Substring(6, 4));
                thanght = int.Parse(ngayvao.Substring(3, 2));
                ngayht = int.Parse(ngayvao.Substring(0, 2));
                gioht = int.Parse(ngayvao.Substring(11, 2));
            }
            if (nam == namht)
            {
                if (thang == thanght)
                {
                    if (ngay == ngayht) tuoi = "3/" + (gioht - gio);
                    else tuoi = "2/" + (ngayht - ngay);
                }
                else tuoi = "1/" + (thanght - thang);
            }
            else tuoi = "0/" + (namht - nam);
            return tuoi;
        }
        public int Namsinh(string ngaysinh)
        {
            return int.Parse(ngaysinh.Substring(6, 4));
        }
        public int iTuoi_nguoibenh
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=107");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 120; }
            }
        }
        public string Thongso(string sql)
        {
            try
            {
                XmlDocument doc = new XmlDocument();
                doc.Load("..//..//..//xml//thongso.xml");
                XmlNodeList nodeLst = doc.GetElementsByTagName(sql);
                return nodeLst.Item(0).InnerText;
            }
            catch
            {
                return "";
            }
        }
        #endregion TÙY CHỌN

        #region TÌM KIẾM
        public DataSet v_find_bienlaithuvienphi(DateTime v_tu, DateTime v_den, string v_mabn, string v_hoten, string v_namsinh, string v_diachi, string v_ngaythu, string v_nguoithu, string v_quyenso, string v_sobienlai, string v_tuso, string v_denso, string v_loaibn, string v_loaibl)
        {
            try
            {
                string sql1 = "", sql2 = "", sql3 = "";
                // truc tiep
                sql1 = "select a.id, decode(aa.id,null,0,1) huy, c.mabn, c.hoten, nvl(to_char(c.ngaysinh,'dd/mm/yyyy'),c.namsinh) namsinh, to_char(a.ngay,'dd/mm/yyyy')||' '||to_char(a.ngayud,'hh24:mi') ngay, d.sohieu quyenso, d.id quyensoid, a.sobienlai, d.sohieu||' - '||to_char(a.sobienlai) sochungtu, sum(nvl(b.soluong,0)*nvl(b.dongia,0)-nvl(b.thieu,0))- nvl(f.sotien,sum(nvl(b.mien,0))) sotien, e.hoten tennguoithu, c.sonha,c.thon,i.tenpxa xa,h.tenquan quan, g.tentt tinh, a.userid, '1' loaihd, a.loaibn, a.loai ";
                sql1 += "from v_vienphill a, v_hoantra aa, v_vienphict b, btdbn c, v_quyenso d, v_dlogin e, v_mienngtru f, btdtt g, btdquan h, btdpxa i ";
                sql1 += "where (a.id=b.id(+)) ";
                sql1 += "and (a.id=f.id(+)) ";
                sql1 += "and (a.quyenso=aa.quyenso(+) and a.sobienlai=aa.sobienlai(+)) ";
                sql1 += "and (a.mabn=c.mabn(+)) ";
                sql1 += "and (a.quyenso=d.id(+)) ";
                sql1 += "and (a.userid=e.id(+)) ";
                sql1 += "and (c.matt=g.matt(+))";
                sql1 += "and (c.maqu=h.maqu(+))";
                sql1 += "and (c.maphuongxa=i.maphuongxa(+)) ";
                if (v_mabn.Trim() != "")
                {
                    sql1 += "and (trim(c.mabn) like '%'||trim(:v_mabn)||'%') ";
                }
                if (v_hoten.Trim() != "")
                {
                    sql1 += "and (trim(c.hoten) like '%'||trim(:v_hoten)||'%') ";
                }
                if (v_diachi.Trim() != "")
                {
                    sql1 += "and (upper(trim(c.sonha)) like '%'||upper(trim(:v_diachi))||'%' ";
                    sql1 += "or upper(trim(c.thon)) like '%'||upper(trim(:v_diachi))||'%' ";
                    sql1 += "or upper(trim(i.tenpxa)) like '%'||upper(trim(:v_diachi))||'%' ";
                    sql1 += "or upper(trim(h.tenquan)) like '%'||upper(trim(:v_diachi))||'%' ";
                    sql1 += "or upper(trim(g.tentt)) like '%'||upper(trim(:v_diachi))||'%') ";
                }

                if (v_namsinh.Trim() != "")
                {
                    sql1 += "and (trim(c.namsinh) like '%'||trim(:v_namsinh)||'%') ";
                    sql1 += "and (to_char(c.ngaysinh,'dd/mm/yyyy hh24:mi') like '%'||:v_namsinh||'%' or c.ngaysinh is null) ";
                }
                if (v_ngaythu.Trim() != "")
                {
                    sql1 += "and (to_char(a.ngay,'dd/mm/yyyy hh24:mi') like '%'||:v_ngaythu||'%') ";
                }
                if (v_nguoithu.Trim() != "")
                {
                    sql1 += "and (trim(e.hoten) like '%'||trim(:v_nguoithu)||'%') ";
                }
                if (v_quyenso.Trim() != "")
                {
                    sql1 += "and (trim(d.sohieu) like '%'||trim(:v_quyenso)||'%') ";
                }
                if (v_sobienlai.Trim() != "")
                {
                    sql1 += "and (to_char(a.sobienlai) like '%'||trim(:v_sobienlai)||'%') ";
                }
                if (v_tuso.Trim() != "")
                {
                    sql1 += "and (a.sobienlai>=to_number(:v_tuso)) ";
                }
                if (v_denso.Trim() != "")
                {
                    sql1 += "and (a.sobienlai<=to_number(:v_denso)) ";
                }
                sql1 += "group by a.id, decode(aa.id,null,0,1), c.mabn, c.hoten, nvl(to_char(c.ngaysinh,'dd/mm/yyyy'),c.namsinh), to_char(a.ngay,'dd/mm/yyyy')||' '||to_char(a.ngayud,'hh24:mi'), d.sohieu, d.id, a.sobienlai, d.sohieu||' - '||to_char(a.sobienlai), f.sotien, e.hoten, c.sonha,c.thon,i.tenpxa,h.tenquan,g.tentt, a.userid, a.loai,a.loaibn";

                //Tam ung

                sql2 = "select a.id, decode(aa.id,null,0,1) huy, c.mabn, c.hoten, nvl(to_char(c.ngaysinh,'dd/mm/yyyy'),c.namsinh) namsinh, to_char(a.ngay,'dd/mm/yyyy')||' '||to_char(a.ngayud,'hh24:mi') ngay, d.sohieu quyenso, d.id quyensoid, a.sobienlai, d.sohieu||' - '||to_char(a.sobienlai) sochungtu, a.sotien, e.hoten tennguoithu, c.sonha,c.thon,i.tenpxa xa,h.tenquan quan, g.tentt tinh, a.userid, '2' loaihd, a.loaibn, a.loai ";
                sql2 += "from v_tamung a, v_hoantra aa, btdbn c, v_quyenso d, v_dlogin e, btdtt g, btdquan h, btdpxa i ";
                sql2 += "where (a.mabn=c.mabn(+)) ";
                sql2 += "and (a.quyenso=d.id(+)) ";
                sql2 += "and (a.quyenso=aa.quyenso(+) and a.sobienlai=aa.sobienlai(+)) ";
                sql2 += "and (a.userid=e.id(+)) ";
                sql2 += "and (c.matt=g.matt(+)) ";
                sql2 += "and (c.maqu=h.maqu(+)) ";
                sql2 += "and (c.maphuongxa=i.maphuongxa(+)) ";

                if (v_mabn.Trim() != "")
                {
                    sql2 += "and (trim(c.mabn) like '%'||trim(:v_mabn)||'%') ";
                }
                if (v_hoten.Trim() != "")
                {
                    sql2 += "and (trim(c.hoten) like '%'||trim(:v_hoten)||'%') ";
                }
                if (v_diachi.Trim() != "")
                {
                    sql2 += "and (upper(trim(c.sonha)) like '%'||upper(trim(:v_diachi))||'%' ";
                    sql2 += "or upper(trim(c.thon)) like '%'||upper(trim(:v_diachi))||'%' ";
                    sql2 += "or upper(trim(i.tenpxa)) like '%'||upper(trim(:v_diachi))||'%' ";
                    sql2 += "or upper(trim(h.tenquan)) like '%'||upper(trim(:v_diachi))||'%' ";
                    sql2 += "or upper(trim(g.tentt)) like '%'||upper(trim(:v_diachi))||'%') ";
                }

                if (v_namsinh.Trim() != "")
                {
                    sql2 += "and (trim(c.namsinh) like '%'||trim(:v_namsinh)||'%') ";
                    sql2 += "and (to_char(c.ngaysinh,'dd/mm/yyyy hh24:mi') like '%'||:v_namsinh||'%' or c.ngaysinh is null) ";
                }
                if (v_ngaythu.Trim() != "")
                {
                    sql2 += "and (to_char(a.ngay,'dd/mm/yyyy hh24:mi') like '%'||:v_ngaythu||'%') ";
                }
                if (v_nguoithu.Trim() != "")
                {
                    sql2 += "and (trim(e.hoten) like '%'||trim(:v_nguoithu)||'%') ";
                }
                if (v_quyenso.Trim() != "")
                {
                    sql2 += "and (trim(d.sohieu) like '%'||trim(:v_quyenso)||'%') ";
                }
                if (v_sobienlai.Trim() != "")
                {
                    sql2 += "and (to_char(a.sobienlai) like '%'||:v_sobienlai||'%') ";
                }
                if (v_tuso.Trim() != "")
                {
                    sql2 += "and (a.sobienlai>=to_number(:v_tuso)) ";
                }
                if (v_denso.Trim() != "")
                {
                    sql2 += "and (a.sobienlai<=to_number(:v_denso));";
                }

                //Thanh toán ra viện
                sql3 = "select a.id, decode(aa.id,null,0,1) huy, c.mabn, c.hoten, nvl(to_char(c.ngaysinh,'dd/mm/yyyy'),c.namsinh) namsinh, to_char(b.ngay,'dd/mm/yyyy')||' '||to_char(b.ngayud,'hh24:mi') ngay, d.sohieu quyenso, d.id quyensoid, b.sobienlai, d.sohieu||' - '||to_char(b.sobienlai) sochungtu, b.sotien, e.hoten tennguoithu, c.sonha,c.thon,i.tenpxa xa,h.tenquan quan, g.tentt tinh, b.userid, '3' loaihd, b.loaibn, b.loai ";
                sql3 += "from v_ttrvds a, v_hoantra aa, v_ttrvll b, btdbn c, v_quyenso d, v_dlogin e, btdtt g, btdquan h, btdpxa i ";
                sql3 += "where (a.id=b.id(+)) ";
                sql3 += "and (a.mabn=c.mabn(+)) ";
                sql3 += "and (b.quyenso=d.id(+)) ";
                sql3 += "and (b.quyenso=aa.quyenso(+) and b.sobienlai=aa.sobienlai(+)) ";
                sql3 += "and (b.userid=e.id(+)) ";
                sql3 += "and (c.matt=g.matt(+)) ";
                sql3 += "and (c.maqu=h.maqu(+)) ";
                sql3 += "and (c.maphuongxa=i.maphuongxa(+)) ";

                if (v_mabn.Trim() != "")
                {
                    sql3 += "and (trim(c.mabn) like '%'||trim(:v_mabn)||'%') ";
                }
                if (v_hoten.Trim() != "")
                {
                    sql3 += "and (trim(c.hoten) like '%'||trim(:v_hoten)||'%') ";
                }
                if (v_diachi.Trim() != "")
                {
                    sql3 += "and (upper(trim(c.sonha)) like '%'||upper(trim(:v_diachi))||'%' ";
                    sql3 += "or upper(trim(c.thon)) like '%'||upper(trim(:v_diachi))||'%' ";
                    sql3 += "or upper(trim(i.tenpxa)) like '%'||upper(trim(:v_diachi))||'%' ";
                    sql3 += "or upper(trim(h.tenquan)) like '%'||upper(trim(:v_diachi))||'%' ";
                    sql3 += "or upper(trim(g.tentt)) like '%'||upper(trim(:v_diachi))||'%') ";
                }
                if (v_namsinh.Trim() != "")
                {
                    sql3 += "and (trim(c.namsinh) like '%'||trim(:v_namsinh)||'%') ";
                    sql3 += "and (to_char(c.ngaysinh,'dd/mm/yyyy hh24:mi') like '%'||:v_namsinh||'%' or c.ngaysinh is null) ";
                }
                if (v_ngaythu.Trim() != "")
                {
                    sql3 += "and (to_char(b.ngay,'dd/mm/yyyy hh24:mi') like '%'||:v_ngaythu||'%') ";
                }
                if (v_nguoithu.Trim() != "")
                {
                    sql3 += "and (trim(e.hoten) like '%'||trim(:v_nguoithu)||'%') ";
                }
                if (v_quyenso.Trim() != "")
                {
                    sql3 += "and (trim(d.sohieu) like '%'||trim(:v_quyenso)||'%') ";
                }
                if (v_sobienlai.Trim() != "")
                {
                    sql3 += "and (to_char(b.sobienlai) like '%'||:v_sobienlai||'%') ";
                }
                if (v_tuso.Trim() != "")
                {
                    sql3 += "and (b.sobienlai>=to_number(:v_tuso)) ";
                }
                if (v_denso.Trim() != "")
                {
                    sql3 += "and (b.sobienlai<=to_number(:v_denso))";
                }

                switch (v_loaibl)
                {
                    case "1":
                        sql = sql1.Trim();
                        break;
                    case "2":
                        sql = sql2.Trim();
                        break;
                    case "3":
                        sql = sql3.Trim();
                        break;
                    case "0":
                    default:
                        sql = sql1.Trim() + " union all " + sql2.Trim() + " union all " + sql3.Trim();
                        break;
                }
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }

                con = new NpgsqlConnection(sConn);
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                if (v_mabn.Trim() != "")
                {
                    cmd.Parameters.Add("v_mabn", NpgsqlDbType.Text, 8).Value = v_mabn;
                }
                if (v_hoten.Trim() != "")
                {
                    cmd.Parameters.Add("v_hoten", NpgsqlDbType.Text, 100).Value = v_hoten;
                }
                if (v_namsinh.Trim() != "")
                {
                    cmd.Parameters.Add("v_namsinh", NpgsqlDbType.Text, 20).Value = v_namsinh;
                }
                if (v_diachi.Trim() != "")
                {
                    cmd.Parameters.Add("v_diachi", NpgsqlDbType.Text, 200).Value = v_diachi;
                }
                if (v_ngaythu.Trim() != "")
                {
                    cmd.Parameters.Add("v_ngaythu", NpgsqlDbType.Text, 20).Value = v_ngaythu;
                }
                if (v_nguoithu.Trim() != "")
                {
                    cmd.Parameters.Add("v_nguoithu", NpgsqlDbType.Text, 100).Value = v_nguoithu;
                }
                if (v_quyenso.Trim() != "")
                {
                    cmd.Parameters.Add("v_quyenso", NpgsqlDbType.Text, 100).Value = v_quyenso;
                }
                if (v_sobienlai.Trim() != "")
                {
                    cmd.Parameters.Add("v_sobienlai", NpgsqlDbType.Text, 10).Value = v_sobienlai;
                }
                if (v_tuso.Trim() != "")
                {
                    cmd.Parameters.Add("v_tuso", NpgsqlDbType.Text, 10).Value = v_tuso;
                }
                if (v_denso.Trim() != "")
                {
                    cmd.Parameters.Add("v_denso", NpgsqlDbType.Text, 10).Value = v_denso;
                }
                dest = new NpgsqlDataAdapter(cmd);
                m_ds = new DataSet();
                dest.Fill(m_ds);
                cmd.Dispose();
                con.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_v_error(ex.Message.ToString().Trim(), m_computername, "v_find_bienlaivienphi");
            }
            return m_ds;
        }
        public DataSet v_find_benhnhan(string v_mabn1, string v_mabn2, string v_hoten, string v_namsinh, string v_gioitinh, string v_diachi, string v_mabhyt, string v_dienthoai, string v_email)
        {
            try
            {
                sql = "select a.mabn, a.hoten, nvl(to_char(a.ngaysinh,'dd/mm/yyyy'),a.namsinh) ngaysinh, b.ten phai, trim(f.sothe) mabhyt, to_char(f.denngay,'dd/mm/yyyy') denngay, trim(a.sonha) sonha, trim(a.thon) thon, trim(c.tenpxa) xa, trim(d.tenquan) quan, trim(e.tentt) tinh, g.nha, g.coquan, g.didong, g.email,'' ngay,'' makp,'' tenkp ";
                sql += "from btdbn a, dmphai b, btdpxa c, btdquan d, btdtt e, bhyt f, dienthoai g ";
                sql += "where (a.phai=b.ma(+)) ";
                sql += "and (a.mabn=g.mabn(+)) ";
                sql += "and (a.mabn=f.mabn(+)) ";
                sql += "and (a.maphuongxa=c.maphuongxa(+)) ";
                sql += "and (a.maqu=d.maqu(+)) ";
                sql += "and (a.matt=e.matt(+)) ";
                if (v_mabn1.Trim() != "")
                {
                    sql += "and (substr(trim(a.mabn),1,2) like '%'||trim(:v_mabn1)||'%') ";
                }
                if (v_mabn2.Trim() != "")
                {
                    sql += "and (substr(trim(a.mabn),3) like '%'||trim(:v_mabn2)||'%') ";
                }
                if (v_mabhyt.Trim() != "")
                {
                    sql += "and (trim(f.sothe) like '%'||trim(:v_mabhyt)||'%') ";
                }
                if (v_hoten.Trim() != "")
                {
                    sql += "and (trim(a.hoten) like '%'||trim(:v_hoten)||'%') ";
                }
                if (v_namsinh.Trim() != "")
                {
                    sql += "and (trim(a.namsinh) like '%'||trim(:v_namsinh)||'%') ";
                    sql += "and (to_char(a.ngaysinh,'dd/mm/yyyy hh24:mi') like '%'||:v_namsinh||'%' or a.ngaysinh is null) ";
                }
                if (v_gioitinh.Trim() != "")
                {
                    sql += "and (to_char(a.phai) like '%'||trim(:v_gioitinh)||'%') ";
                }
                if (v_dienthoai.Trim() != "")
                {
                    sql += "and (trim(g.nha) like '%'||trim(:v_dienthoai)||'%' or trim(g.coquan) like '%'||trim(:v_dienthoai)||'%' or trim(g.didong) like '%'||trim(:v_dienthoai)||'%') ";
                }
                if (v_email.Trim() != "")
                {
                    sql += "and (trim(g.email) like '%'||trim(:v_email)||'%') ";
                }
                if (v_diachi.Trim() != "")
                {
                    sql += "and (upper(trim(a.sonha)) like '%'||upper(trim(:v_diachi))||'%' ";
                    sql += "or upper(trim(a.thon)) like '%'||upper(trim(:v_diachi))||'%' ";
                    sql += "or upper(trim(c.tenpxa)) like '%'||upper(trim(:v_diachi))||'%' ";
                    sql += "or upper(trim(d.tenquan)) like '%'||upper(trim(:v_diachi))||'%' ";
                    sql += "or upper(trim(e.tentt)) like '%'||upper(trim(:v_diachi))||'%') ";
                }
                sql += "group by a.mabn, a.hoten, nvl(to_char(a.ngaysinh,'dd/mm/yyyy'),a.namsinh), b.ten, trim(f.sothe), to_char(f.denngay,'dd/mm/yyyy'), trim(a.sonha), trim(a.thon), trim(c.tenpxa), trim(d.tenquan), trim(e.tentt),g.nha,g.coquan,g.didong,g.email";

                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                if (v_mabn1.Trim() != "")
                {
                    cmd.Parameters.Add("v_mabn1", NpgsqlDbType.Text, 2).Value = v_mabn1;
                }
                if (v_mabn2.Trim() != "")
                {
                    cmd.Parameters.Add("v_mabn2", NpgsqlDbType.Text, 6).Value = v_mabn2;
                }
                if (v_hoten.Trim() != "")
                {
                    cmd.Parameters.Add("v_hoten", NpgsqlDbType.Text, 100).Value = v_hoten;
                }
                if (v_namsinh.Trim() != "")
                {
                    cmd.Parameters.Add("v_namsinh", NpgsqlDbType.Text, 20).Value = v_namsinh;
                }
                if (v_gioitinh.Trim() != "")
                {
                    cmd.Parameters.Add("v_gioitinh", NpgsqlDbType.Text, 2).Value = v_gioitinh;
                }
                if (v_diachi.Trim() != "")
                {
                    cmd.Parameters.Add("v_diachi", NpgsqlDbType.Text, 200).Value = v_diachi;
                }
                if (v_mabhyt.Trim() != "")
                {
                    cmd.Parameters.Add("v_mabhyt", NpgsqlDbType.Text, 20).Value = v_mabhyt;
                }
                if (v_dienthoai.Trim() != "")
                {
                    cmd.Parameters.Add("v_dienthoai", NpgsqlDbType.Text, 20).Value = v_dienthoai;
                }
                if (v_email.Trim() != "")
                {
                    cmd.Parameters.Add("v_email", NpgsqlDbType.Text, 50).Value = v_email;
                }

                dest = new NpgsqlDataAdapter(cmd);
                m_ds = new DataSet();
                dest.Fill(m_ds);
                cmd.Dispose();
                con.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_v_error(ex.Message.ToString().Trim(), m_computername, "v_find_benhnhan");
            }
            return m_ds;
        }
        public DataSet v_find_hiendien()
        {
            sql = "select a.mabn, a.hoten, nvl(to_char(a.ngaysinh,'dd/mm/yyyy'),a.namsinh) ngaysinh, b.ten phai, trim(f.sothe) mabhyt, to_char(f.denngay,'dd/mm/yyyy') denngay, trim(a.sonha) sonha, trim(a.thon) thon, trim(c.tenpxa) xa, trim(d.tenquan) quan, trim(e.tentt) tinh, g.nha, g.coquan, g.didong, g.email, to_char(h.ngay,'dd/mm/yyyy hh24:mi') ngay, i.makp, i.tenkp ";
            sql += "from btdbn a, dmphai b, btdpxa c, btdquan d, btdtt e, bhyt f, dienthoai g, hiendien h, btdkp_bv i ";
            sql += "where (a.phai=b.ma(+)) ";
            sql += "and (a.mabn=g.mabn(+)) ";
            sql += "and (a.mabn=f.mabn(+)) ";
            sql += "and (a.maphuongxa=c.maphuongxa(+)) ";
            sql += "and (a.maqu=d.maqu(+)) ";
            sql += "and (a.matt=e.matt(+)) ";
            sql += "and (h.makp=i.makp(+)) ";
            sql += "and (a.mabn=h.mabn and h.nhapkhoa=1 and h.xuatkhoa=0) ";
            sql += "group by a.mabn, a.hoten, nvl(to_char(a.ngaysinh,'dd/mm/yyyy'),a.namsinh), b.ten, trim(f.sothe), to_char(f.denngay,'dd/mm/yyyy'), trim(a.sonha), trim(a.thon), trim(c.tenpxa), trim(d.tenquan), trim(e.tentt),g.nha,g.coquan,g.didong,g.email,to_char(h.ngay,'dd/mm/yyyy hh24:mi'), i.makp, i.tenkp";
            return get_data(sql);
        }
        public DataSet v_find_viettat(string v_matat)
        {
            try
            {
                sql = "select trim(matat) matat, trim(daydu) daydu from " + s_schemaroot + ".btdvt";
                if (v_matat.Trim() != "")
                {
                    sql += " where lower(trim(matat))=lower(trim(:v_matat))";
                }
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                if (v_matat.Trim() != "")
                {
                    cmd.Parameters.Add("v_matat", NpgsqlDbType.Text, 30).Value = v_matat;
                }

                dest = new NpgsqlDataAdapter(cmd);
                m_ds = new DataSet();
                dest.Fill(m_ds);
                cmd.Dispose();
                con.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_v_error(ex.Message.ToString().Trim(), m_computername, "?");
            }
            return m_ds;
        }
        public string v_viettat(string v_matat)
        {
            string r = "";
            try
            {
                sql = "select trim(matat) matat, trim(daydu) daydu from " + s_schemaroot + ".btdvt";
                if (v_matat.Trim() != "")
                {
                    sql += " where lower(trim(matat))=lower(trim(:v_matat))";
                }
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                if (v_matat.Trim() != "")
                {
                    cmd.Parameters.Add("v_matat", NpgsqlDbType.Text, 30).Value = v_matat;
                }

                dest = new NpgsqlDataAdapter(cmd);
                m_ds = new DataSet();
                dest.Fill(m_ds);
                r = m_ds.Tables[0].Rows[0]["daydu"].ToString();
                cmd.Dispose();
                con.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_v_error(ex.Message.ToString().Trim(), m_computername, "?");
            }
            return r;
        }
        public DataSet v_find_daydu(string v_daydu)
        {
            try
            {
                sql = "select trim(matat) matat, trim(daydu) daydu from " + s_schemaroot + ".btdvt ";
                if (v_daydu.Trim() != "")
                {
                    sql += "where lower(trim(daydu))=lower(trim(:v_daydu))";
                }

                if (con != null)
                {
                    con.Close(); con.Dispose();
                }
                con = new NpgsqlConnection(sConn);
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                if (v_daydu.Trim() != "")
                {
                    cmd.Parameters.Add("v_daydu", NpgsqlDbType.Text, 100).Value = v_daydu;
                }

                dest = new NpgsqlDataAdapter(cmd);
                m_ds = new DataSet();
                dest.Fill(m_ds);
                cmd.Dispose();
                con.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_v_error(ex.Message.ToString().Trim(), m_computername, "?");
            }
            return m_ds;
        }
        public string v_daydu(string v_daydu)
        {
            string r = "";
            try
            {
                sql = "select trim(matat) matat, trim(daydu) daydu from " + s_schemaroot + ".btdvt";
                if (v_daydu.Trim() != "")
                {
                    sql += " where lower(trim(daydu))=lower(trim(:v_daydu))";
                }
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }

                con = new NpgsqlConnection(sConn);
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                if (v_daydu.Trim() != "")
                {
                    cmd.Parameters.Add("v_daydu", NpgsqlDbType.Text, 100).Value = v_daydu;
                }

                dest = new NpgsqlDataAdapter(cmd);
                m_ds = new DataSet();
                dest.Fill(m_ds);
                r = m_ds.Tables[0].Rows[0]["matat"].ToString();
                cmd.Dispose();
                con.Dispose();
            }
            catch (NpgsqlException ex)
            {
                upd_v_error(ex.Message.ToString().Trim(), m_computername, "?");
            }
            return r;
        }
        public bool v_kiemtrauserid(string v_userid)
        {
            bool r = false;
            try
            {
                sql = "select id from " + s_schemaroot + ".v_dlogin ";
                if (v_userid.Trim() != "")
                {
                    sql += "where lower(trim(userid))=lower(trim(:v_userid))";
                }
                if (con != null)
                {
                    con.Close(); con.Dispose();
                }

                con = new NpgsqlConnection(sConn);
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                if (v_userid.Trim() != "")
                {
                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Text, 100).Value = v_userid;
                }

                dest = new NpgsqlDataAdapter(cmd);
                m_ds = new DataSet();
                dest.Fill(m_ds);
                cmd.Dispose();
                con.Dispose();
                r = m_ds.Tables[0].Rows.Count > 0;
            }
            catch (NpgsqlException ex)
            {
                upd_v_error(ex.Message.ToString().Trim(), m_computername, "kiemtrauserid");
            }
            return r;
        }
        #endregion

        #region DELETE DATA TABLE
        public bool del_v_viettat(string v_ma)
        {
            bool art = false;
            try
            {
                execute_data("delete from " + s_schemaroot + ".v_viettat where ma='" + v_ma.Replace("'", "''") + "' and readonly!=1");
                art = (get_data("select id from " + s_schemaroot + ".v_viettat where ma='" + v_ma.Replace("'", "''") + "'").Tables[0].Rows.Count == 0);
            }
            catch
            {
                art = false;
            }
            return art;
        }
        public bool del_v_viettat()
        {
            bool art = false;
            try
            {
                execute_data("delete from " + s_schemaroot + ".v_viettat where readonly!=1");
                art = (get_data("select id from " + s_schemaroot + ".v_viettat").Tables[0].Rows.Count == 0);
            }
            catch
            {
                art = false;
            }
            return art;
        }
        public bool del_v_treebaocao(string v_id)
        {
            bool art = false;
            try
            {
                if (dadung_v_treebaocao(v_id) == 0)
                {
                    execute_data("delete from " + s_schemaroot + ".v_treebaocao where id=" + v_id);
                    art = (get_data("select id from " + s_schemaroot + ".v_treebaocao where id=" + v_id).Tables[0].Rows.Count == 0);
                }
            }
            catch
            {
                art = false;
            }
            return art;
        }
        public bool del_v_dlogin(string v_id)
        {
            bool art = false;
            try
            {
                if (dadung_v_dlogin(v_id) == 0)
                {
                    execute_data("delete from " + s_schemaroot + ".v_dlogin where id=" + v_id);
                    art = (get_data("select id from " + s_schemaroot + ".v_dlogin where id=" + v_id).Tables[0].Rows.Count == 0);
                    if (art)
                    {
                        execute_data("delete from " + s_schemaroot + ".v_phanquyen where userid=" + v_id);
                    }
                }
            }
            catch
            {
                art = false;
            }
            return art;
        }
        public bool del_v_nhomdlogin(string v_id)
        {
            bool art = false;
            try
            {
                if (dadung_v_nhomdlogin(v_id) == 0)
                {
                    execute_data("delete from " + s_schemaroot + ".v_nhomdlogin where id=" + v_id + " and id not in (select disctinct id_nhom from " + s_schemaroot + ".v_dlogin where id_nhom = " + v_id + ")");
                    art = (get_data("select id from " + s_schemaroot + ".v_nhomdlogin where id=" + v_id).Tables[0].Rows.Count == 0);
                    if (art)
                    {
                        execute_data("delete from " + s_schemaroot + ".v_phanquyennhom where id_nhom=" + v_id);
                    }
                }
            }
            catch
            {
                art = false;
            }
            return art;
        }
        public void del_v_phanquyen(string v_userid)
        {
            execute_data("delete from " + s_schemaroot + ".v_phanquyen where userid=" + v_userid);
        }
        public void del_v_phanquyennhom(string v_id_nhom)
        {
            execute_data("delete from " + s_schemaroot + ".v_phanquyennhom where id_nhom=" + v_id_nhom);
        }
        public void copy_treebaocao(string v_id_copy, string v_id_cha_dest)
        {
            try
            {
                decimal aid = get_id_v_treebaocao, astt = get_stt_v_treebaocao(v_id_cha_dest);
                execute_data("insert into " + s_schemaroot + ".v_treebaocao(id,id_cha,stt,ten,sql,tenreport,readonly) select " + aid.ToString() + "," + v_id_cha_dest + "," + astt.ToString() + ",ten,sql,tenreport,readonly from " + s_schemaroot + ".v_treebaocao where id=" + v_id_copy + "");
            }
            catch
            {
            }
        }
        public void copy_phanquyen(string v_id_copy, string v_loai_copy, string v_id_dest, string v_loai_dest)
        {
            try
            {
                if (v_loai_dest == "U")
                {
                    execute_data("delete from " + s_schemaroot + ".v_phanquyen where userid=" + v_id_dest + " and userid <>" + v_id_copy);
                }
                else
                {
                    execute_data("delete from " + s_schemaroot + ".v_phanquyennhom where id_nhom=" + v_id_dest + " and id_nhom <>" + v_id_copy);
                }
                if (v_loai_dest == "N")
                {
                    if (v_loai_copy == "U")
                    {
                        execute_data("insert into " + s_schemaroot + ".v_phanquyennhom(id_nhom,menuname,chon,chitiet) select " + v_id_dest.ToString() + ",menuname,chon,chitiet from " + s_schemaroot + ".v_phanquyen where userid=" + v_id_copy + "");
                    }
                    else
                    {
                        execute_data("insert into " + s_schemaroot + ".v_phanquyennhom(id_nhom,menuname,chon,chitiet) select " + v_id_dest.ToString() + ",menuname,chon,chitiet from " + s_schemaroot + ".v_phanquyennhom where id_nhom=" + v_id_copy + "");
                    }
                }
                else
                {
                    if (v_loai_copy == "U")
                    {
                        execute_data("insert into " + s_schemaroot + ".v_phanquyen(userid,menuname,chon,chitiet) select " + v_id_dest.ToString() + ",menuname,chon,chitiet from " + s_schemaroot + ".v_phanquyen where userid=" + v_id_copy + "");
                    }
                    else
                    {
                        execute_data("insert into " + s_schemaroot + ".v_phanquyen(userid,menuname,chon,chitiet) select " + v_id_dest.ToString() + ",menuname,chon,chitiet from " + s_schemaroot + ".v_phanquyennhom where id_nhom=" + v_id_copy + "");
                    }
                }
            }
            catch
            {
            }
        }
        public bool del_v_dsduyet(string v_ma)
        {
            bool art = false;
            try
            {
                if (dadung_v_dsduyet(v_ma) == 0)
                {
                    execute_data("delete from " + s_schemaroot + ".v_dsduyet where ma=" + v_ma.Replace("'", "''") + "");
                    art = (get_data("select ma from " + s_schemaroot + ".v_dsduyet where ma=" + v_ma.Replace("'", "''") + "").Tables[0].Rows.Count == 0);
                }
            }
            catch
            {
                art = false;
            }
            return art;
        }
        public bool del_v_lydomien(string v_id)
        {
            bool art = false;
            try
            {
                if (dadung_v_lydomien(v_id) == 0)
                {
                    execute_data("delete from " + s_schemaroot + ".v_lydomien where id=" + v_id + "");
                    art = (get_data("select id from " + s_schemaroot + ".v_lydomien where id=" + v_id + "").Tables[0].Rows.Count == 0);
                }
            }
            catch
            {
                art = false;
            }
            return art;
        }
        public bool del_v_dmlydonopthem(string v_id)
        {
            bool art = false;
            try
            {
                if (dadung_v_dmlydonopthem(v_id) == 0)
                {
                    execute_data("delete from " + s_schemaroot + ".v_dmlydonopthem where id=" + v_id + "");
                    art = (get_data("select id from " + s_schemaroot + ".v_dmlydonopthem where id=" + v_id + "").Tables[0].Rows.Count == 0);
                }
            }
            catch
            {
                art = false;
            }
            return art;
        }
        public bool del_v_dmlydothieu(string v_id)
        {
            bool art = false;
            try
            {
                if (dadung_v_dmlydothieu(v_id) == 0)
                {
                    execute_data("delete from " + s_schemaroot + ".v_dmlydothieu where id=" + v_id + "");
                    art = (get_data("select id from " + s_schemaroot + ".v_dmlydothieu where id=" + v_id + "").Tables[0].Rows.Count == 0);
                }
            }
            catch
            {
                art = false;
            }
            return art;
        }
        public bool del_v_loaibn(string v_id)
        {
            bool art = false;
            try
            {
                if (dadung_v_loaibn(v_id) == 0)
                {
                    execute_data("delete from " + s_schemaroot + ".v_loaibn where id=" + v_id + "");
                    art = (get_data("select id from " + s_schemaroot + ".v_loaibn where id=" + v_id + "").Tables[0].Rows.Count == 0);
                }
            }
            catch
            {
                art = false;
            }
            return art;
        }
        public bool del_v_tenloaivp(string v_ma)
        {
            bool art = false;
            try
            {
                if (dadung_v_dsduyet(v_ma) == 0)
                {
                    execute_data("delete from " + s_schemaroot + ".v_tenloaivp where ma=" + v_ma + "");
                    art = (get_data("select ma from " + s_schemaroot + ".v_tenloaivp where ma=" + v_ma + "").Tables[0].Rows.Count == 0);
                }
            }
            catch
            {
                art = false;
            }
            return art;
        }
        public bool del_v_nhombhyt(string v_id)
        {
            bool art = false;
            try
            {
                if (dadung_v_nhombhyt(v_id) == 0)
                {
                    execute_data("delete from " + s_schemaroot + ".v_nhombhyt where id=" + v_id + "");
                    art = (get_data("select id from " + s_schemaroot + ".v_nhombhyt where id=" + v_id + "").Tables[0].Rows.Count == 0);
                }
            }
            catch
            {
                art = false;
            }
            return art;
        }
        public bool del_v_nhomvp(string v_id)
        {
            bool art = false;
            try
            {
                if (dadung_v_nhomvp(v_id) == 0)
                {
                    execute_data("delete from " + s_schemaroot + ".v_nhomvp" + s_dblink + " where ma=" + v_id + "");
                    art = (get_data("select ma from " + s_schemaroot + ".v_nhomvp" + s_dblink + " where ma=" + v_id + "").Tables[0].Rows.Count == 0);
                }
            }
            catch
            {
                art = false;
            }
            return art;
        }
        public bool del_v_loaivp(string v_id)
        {
            bool art = false;
            try
            {
                if (dadung_v_loaivp(v_id) == 0)
                {
                    execute_data("delete from " + s_schemaroot + ".v_loaivp" + s_dblink + " where id=" + v_id + "");
                    art = (get_data("select id from " + s_schemaroot + ".v_loaivp" + s_dblink + " where id=" + v_id + "").Tables[0].Rows.Count == 0);
                }
            }
            catch
            {
                art = false;
            }
            return art;
        }
        public bool del_v_giavp(string v_id)
        {
            bool art = false;
            try
            {
                if (dadung_v_giavp(v_id) == 0)
                {
                    execute_data("delete from " + s_schemaroot + ".v_giavp" + s_dblink + " where id=" + v_id + "");
                    art = (get_data("select id from " + s_schemaroot + ".v_giavp" + s_dblink + " where id=" + v_id + "").Tables[0].Rows.Count == 0);
                }
            }
            catch
            {
                art = false;
            }
            return art;
        }
        public bool del_v_giavp_client(string v_id, string stendatabase)
        {
            bool art = false;
            try
            {
                if (dadung_v_giavp(v_id) == 0)
                {
                    execute_data("delete from " + s_schemaroot + ".v_giavp" + stendatabase + " where id=" + v_id + "");
                    art = (get_data("select id from " + s_schemaroot + ".v_giavp" + stendatabase + " where id=" + v_id + "").Tables[0].Rows.Count == 0);
                }
            }
            catch
            {
                art = false;
            }
            return art;
        }
        public bool del_v_error()
        {
            bool art = false;
            try
            {
                execute_data("delete from " + s_schemaroot + ".v_error");
                foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
                {
                    execute_data("delete from " + r["schemaname"].ToString() + ".v_error");
                }
            }
            catch
            {
                art = false;
            }
            return art;
        }
        public bool del_v_quyenso(string v_id)
        {
            bool art = false;
            try
            {
                if (dadung_v_quyenso(v_id) == 0)
                {
                    execute_data("delete from " + s_schemaroot + ".v_quyenso where id=" + v_id + "");
                    art = (get_data("select id from " + s_schemaroot + ".v_quyenso where id=" + v_id + "").Tables[0].Rows.Count == 0);
                }
            }
            catch
            {
                art = false;
            }
            return art;
        }
        public bool del_v_vienphill(string v_mmyy, string v_id)
        {
            bool art = false;
            try
            {
                if (dadung_v_vienphill(v_mmyy, v_id) == 0)
                {
                    //foreach (DataRow r in m_dsxoa.Tables[0].Rows)
                    //{
                    //    execute_data_mmyy(v_mmyy, "update medimmyy.v_chidinh set paid=0 where id="+r["idcd"].ToString()+"");
                    //}
                    execute_data_mmyy(v_mmyy, "delete from medibvmmyy.v_vienphict where lanin=0 and id=" + v_id + "");
                    execute_data_mmyy(v_mmyy, "delete from medibvmmyy.v_mienngtru where id=" + v_id + "");
                    execute_data_mmyy(v_mmyy, "delete from medibvmmyy.v_vienphill where lanin=0 and id=" + v_id + "");

                    art = (get_data("select id from medibvmmyy.v_vienphill where id=" + v_id + "").Tables[0].Rows.Count == 0);
                }
            }
            catch
            {
                art = false;
            }
            return art;
        }
        // sua 13/10/2007
        public void del_v_vienphill_new(string v_mmyy, string v_id, string m_maql, string m_makp, string m_mabn)
        {
            try
            {
                //if (dadung_v_vienphill(v_mmyy, v_id) == 0)
                //{
                execute_data_mmyy(v_mmyy, "update medibvmmyy.v_chidinh set paid=0,idttrv=0 where mavp in(select mavp from medibvmmyy.v_vienphict where  id=" + v_id + ") and mabn='" + m_mabn + "'");
                execute_data_mmyy(v_mmyy, "delete from medibvmmyy.v_vienphict where id=" + v_id + "");
                execute_data_mmyy(v_mmyy, "delete from medibvmmyy.v_mienngtru where id=" + v_id + "");
                execute_data_mmyy(v_mmyy, "delete from medibvmmyy.v_vienphill where id=" + v_id + "");

                // }
            }
            catch
            {

            }

        }

        public void del_v_ttrvll(string v_mmyy, string v_ngayvv, string v_ngayrv, string v_id, string v_mabn, string v_maql, string v_makp, string v_doituongthu)
        {
            try
            {
                execute_data_mmyy(v_mmyy, "delete from medibvmmyy.v_ttrvct where id=" + v_id + "");
                execute_data_mmyy(v_mmyy, "delete from medibvmmyy.v_ttrvbhyt where id=" + v_id + "");
                execute_data_mmyy(v_mmyy, "delete from medibvmmyy.v_ttrvnhom where id=" + v_id + "");
                execute_data_mmyy(v_mmyy, "delete from medibvmmyy.v_ttrvpttt where id=" + v_id + "");
                execute_data_mmyy(v_mmyy, "delete from medibvmmyy.v_ttrvptttct where id=" + v_id + "");
                execute_data_mmyy(v_mmyy, "delete from medibvmmyy.v_ttrvll where id=" + v_id + "");
                execute_data_mmyy(v_mmyy, "delete from medibvmmyy.v_ttrvds where id=" + v_id + "");
                if (v_doituongthu != "")
                {
                    //execute_data_mmyy(v_mmyy, "delete from medibvmmyy.v_ttrvll where id=" + v_id + "");???
                    //execute_data_mmyy(v_mmyy, "delete from medibvmmyy.v_ttrvds where id=" + v_id + "");???
                    //if (get_data_mmyy(v_mmyy, "select * from medibvmmyy.v_ttrvds where maql=" + v_maql + " and mabn='" + v_mabn + "'").Tables[0].Rows.Count < 0)
                    //{
                    execute_data(v_ngayvv, v_ngayrv, "update medibvmmyy.v_thvpll set done = 0,idttrv=0 where idttrv=" + v_id + "");
                    //}???
                    execute_data(v_ngayvv, v_ngayrv, "update medibvmmyy.v_thvpct set done = 0,idttrv=0 where idttrv=" + v_id + " and madoituong in(" + v_doituongthu + ")");
                    execute_data(v_ngayvv, v_ngayrv, "update medibvmmyy.d_tienthuoc set done=0,idttrv=0 where mabn='" + v_mabn + "' and idttrv=" + v_id + " and madoituong in(" + v_doituongthu + ")");
                    execute_data(v_ngayvv, v_ngayrv, "update medibvmmyy.d_ngtruct set paid=0,idttrv=0 where idttrv=" + v_id + " and id in(select id from medibvmmyy.d_ngtrull where mabn='" + v_mabn + "' and  maql=" + v_maql + ")");
                    execute_data(v_ngayvv, v_ngayrv, "update medibvmmyy.d_ngtrull set idttrv=0, quyenso=0, sobienlai=0 where idttrv=" + v_id + " and id in(select id from medibvmmyy.d_ngtrull where mabn='" + v_mabn + "' and  maql=" + v_maql + ")");//binh 300711
                    execute_data(v_ngayvv, v_ngayrv, "delete from medibvmmyy.v_miennoitru where id=" + v_id + "");

                    execute_data(v_ngayvv, v_ngayrv, "update medibvmmyy.v_tamung set done=0,idttrv=0 where mabn='" + v_mabn + "' and idttrv=" + v_id + "");
                    execute_data(v_ngayvv, v_ngayrv, "update medibvmmyy.v_vpkhoa set done=0,idttrv=0  where mabn='" + v_mabn + "' and idttrv=" + v_id + " and madoituong in(" + v_doituongthu + ")");
                    execute_data(v_ngayvv, v_ngayrv, "update medibvmmyy.v_chidinh set paid=0,idttrv=0  where mabn='" + v_mabn + "' and idttrv=" + v_id + " and madoituong in(" + v_doituongthu + ")");
                    execute_data("delete from medibv.v_ttrvthatthu where id=" + v_id + " and sotientra=0");
                }
                else
                {
                    execute_data(v_ngayvv, v_ngayrv, "update medibvmmyy.v_thvpll set done = 0,idttrv=0 where idttrv=" + v_id + "");
                    execute_data(v_ngayvv, v_ngayrv, "update medibvmmyy.v_thvpct set done = 0,idttrv=0 where idttrv=" + v_id + "");

                    execute_data(v_ngayvv, v_ngayrv, "update medibvmmyy.d_tienthuoc set done=0,idttrv=0 where mabn='" + v_mabn + "' and idttrv=" + v_id + "");

                    execute_data(v_ngayvv, v_ngayrv, "update medibvmmyy.d_ngtruct set paid=0,idttrv=0 where idttrv=" + v_id + " and id in(select id from medibvmmyy.d_ngtrull where mabn='" + v_mabn + "' and  maql=" + v_maql + ")");

                    execute_data(v_ngayvv, v_ngayrv, "delete from medibvmmyy.v_miennoitru where id=" + v_id + "");
                    execute_data(v_ngayvv, v_ngayrv, "delete from medibvmmyy.v_ttrvll where id=" + v_id + "");
                    execute_data(v_ngayvv, v_ngayrv, "delete from medibvmmyy.v_ttrvds where id=" + v_id + "");

                    execute_data(v_ngayvv, v_ngayrv, "update medibvmmyy.v_tamung set done=0,idttrv=0 where mabn='" + v_mabn + "' and idttrv=" + v_id + "");
                    execute_data(v_ngayvv, v_ngayrv, "update medibvmmyy.v_vpkhoa set done=0,idttrv=0  where mabn='" + v_mabn + "' and idttrv=" + v_id + "");
                    execute_data(v_ngayvv, v_ngayrv, "update medibvmmyy.v_chidinh set paid=0,idttrv=0  where mabn='" + v_mabn + "' and idttrv=" + v_id + "");
                    execute_data(v_ngayvv, v_ngayrv, "update medibvmmyy.d_ngtruct set idttrv=0  where idttrv=" + v_id + "");//binh 130711
                    execute_data(v_ngayvv, v_ngayrv, "update medibvmmyy.d_ngtrull set idttrv=0, quyenso=0, sobienlai=0  where idttrv=" + v_id + "");//binh 130711
                    execute_data("delete from medibv.v_ttrvthatthu where id=" + v_id + " and sotientra=0");
                }
                execute_data(v_ngayvv, v_ngayrv, "update medibvmmyy.bhytkb set quyenso=0,sobienlai=0 where mabn='" + v_mabn + "' and maql=" + v_maql + "");
                //
                //
            }
            catch
            {

            }

        }
        //#end 
        public bool del_v_tamung(string v_mmyy, string v_id)
        {
            bool art = false;
            try
            {
                execute_data("delete from medibv.v_tamung where lanin=0 and id=" + v_id + "");
                execute_data_mmyy(v_mmyy, "delete from medibvmmyy.v_tamung where lanin=0 and id=" + v_id + "");
                execute_data_mmyy(v_mmyy, "delete from medibvmmyy.v_tamungct where id=" + v_id + "");
                art = (get_data("select id from medibvmmyy.v_tamung where id=" + v_id + "").Tables[0].Rows.Count == 0);
            }
            catch
            {
                art = false;
            }
            return art;
        }

        #endregion

        #region GET DATA TABLE
        public DataSet f_get_v_error()
        {
            try
            {
                DataSet ads = null, adst = null;
                string sql = "";
                sql = "select message, computer,tables, to_char(ngayud,'dd/mm/yyyy hh24:mi') as ngayud,'' as blank from " + s_schemaroot + ".v_error order by ngayud desc";
                ads = get_data(sql);

                foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
                {
                    sql = "select message, computer,'" + r["schemaname"].ToString() + ".' || tables as tables, to_char(ngayud,'dd/mm/yyyy hh24:mi') as ngayud,'' as blank from " + r["schemaname"].ToString() + ".v_error order by ngayud desc";
                    adst = get_data(sql);
                    if (ads == null)
                    {
                        if (adst != null)
                        {
                            ads = adst;
                        }
                    }
                    else
                    {
                        if (adst != null)
                        {
                            ads.Merge(adst);
                        }
                    }
                }
                return ads;
            }
            catch
            {
                return null;
            }
        }
        public DataSet f_get_v_khongdau()
        {
            string sql = "";
            sql = "select codau,khongdau from " + s_schemaroot + ".v_khongdau order by codau";
            return get_data(sql);
        }
        public DataSet f_get_dmcomputer()
        {
            string sql = "select a.id, a.computer,'' as ip, '' as status, to_char(a.ngayud,'dd/mm/yyyy hh24:mi') as ngayud from " + s_schemaroot + ".dmcomputer a order by a.computer";
            return get_data(sql);
        }
        public int get_dmcomputer()
        {
            string sql = "update " + user + ".dmcomputer set computer=:m_computer where computer=:m_computer";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            con.Open();
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;
            cmd.Parameters.Add("m_computer", NpgsqlDbType.Varchar, 20).Value = m_computername;
            int irec = cmd.ExecuteNonQuery();
            cmd.Dispose();
            con.Close(); con.Dispose();
            if (irec == 0)
            {
                sql = "insert into " + user + ".dmcomputer(id,computer) values (" + get_computerid() + ",'" + m_computername + "')";
                execute_data(sql);
            }
            return int.Parse(get_data("select id from " + user + ".dmcomputer where computer='" + m_computername + "'").Tables[0].Rows[0][0].ToString());
        }
        public DataSet f_get_v_dmcapnhat_frmMedisoftcenterupdate()
        {
            try
            {
                DataSet ads = new DataSet();
                ads.Tables.Add("Table");
                ads.Tables[0].Columns.Add("id", typeof(Decimal));
                ads.Tables[0].Columns.Add("chon", typeof(Decimal));
                ads.Tables[0].Columns.Add("ten");
                ads.Tables[0].Columns.Add("status");
                DataRow r;

                r = ads.Tables[0].NewRow();
                r["id"] = 1;
                r["chon"] = 0;
                r["ten"] = Change_language_MessageText("Danh mục xét nghiệm");
                r["status"] = "OK";
                ads.Tables[0].Rows.Add(r.ItemArray);

                r = ads.Tables[0].NewRow();
                r["id"] = 2;
                r["chon"] = 0;
                r["ten"] = Change_language_MessageText("Danh mục vi trùng");
                r["status"] = "OK";
                ads.Tables[0].Rows.Add(r.ItemArray);

                r = ads.Tables[0].NewRow();
                r["id"] = 3;
                r["chon"] = 0;
                r["ten"] = Change_language_MessageText("Danh mục mẫu bệnh phẩm");
                r["status"] = "OK";
                ads.Tables[0].Rows.Add(r.ItemArray);

                r = ads.Tables[0].NewRow();
                r["id"] = 4;
                r["chon"] = 0;
                r["ten"] = Change_language_MessageText("Danh mục vị trí lấy mẫu trên cơ thể");
                r["status"] = "OK";
                ads.Tables[0].Rows.Add(r.ItemArray);

                r = ads.Tables[0].NewRow();
                r["id"] = 5;
                r["chon"] = 0;
                r["ten"] = Change_language_MessageText("Danh mục kháng sinh");
                r["status"] = "OK";
                ads.Tables[0].Rows.Add(r.ItemArray);

                r = ads.Tables[0].NewRow();
                r["id"] = 6;
                r["chon"] = 0;
                r["ten"] = "ICD 10-CM";
                r["status"] = "OK";
                ads.Tables[0].Rows.Add(r.ItemArray);

                r = ads.Tables[0].NewRow();
                r["id"] = 7;
                r["chon"] = 0;
                r["ten"] = Change_language_MessageText("Bộ kháng sinh tương ứng với từng loại vi trùng");
                r["status"] = "OK";
                ads.Tables[0].Rows.Add(r.ItemArray);

                r = ads.Tables[0].NewRow();
                r["id"] = 8;
                r["chon"] = 0;
                r["ten"] = Change_language_MessageText("Bộ kháng sinh mẫu thử theo xét nghiệm");
                r["status"] = "OK";
                ads.Tables[0].Rows.Add(r.ItemArray);

                r = ads.Tables[0].NewRow();
                r["id"] = 9;
                r["chon"] = 0;
                r["ten"] = Change_language_MessageText("Bộ hoá chất định mức theo xét nghiệm");
                r["status"] = "OK";
                ads.Tables[0].Rows.Add(r.ItemArray);

                r = ads.Tables[0].NewRow();
                r["id"] = 10;
                r["chon"] = 0;
                r["ten"] = Change_language_MessageText("Danh mục đơn vị đo");
                r["status"] = "OK";
                ads.Tables[0].Rows.Add(r.ItemArray);

                r = ads.Tables[0].NewRow();
                r["id"] = 11;
                r["chon"] = 0;
                r["ten"] = Change_language_MessageText("Danh mục đơn vị đo (HL7)");
                r["status"] = "OK";
                ads.Tables[0].Rows.Add(r.ItemArray);

                r = ads.Tables[0].NewRow();
                r["id"] = 12;
                r["chon"] = 0;
                r["ten"] = Change_language_MessageText("Bộ từ điển viết tắt kết quả xét nghiệm");
                r["status"] = "OK";
                ads.Tables[0].Rows.Add(r.ItemArray);

                r = ads.Tables[0].NewRow();
                r["id"] = 13;
                r["chon"] = 0;
                r["ten"] = Change_language_MessageText("Bộ từ điển viết tắt");
                r["status"] = "OK";
                ads.Tables[0].Rows.Add(r.ItemArray);

                return ads;
            }
            catch
            {
                return null;
            }
        }
        public DataSet f_get_v_phanquyen(string v_userid)
        {
            string auserid = "";

            try
            {
                auserid = int.Parse(v_userid).ToString();
            }
            catch
            {
                auserid = "-99999";
            }
            return get_data("select userid,menuname,chon,chitiet from " + s_schemaroot + ".v_phanquyen where userid=" + auserid);
        }
        public DataSet f_get_v_phanquyennhom(string v_id_nhom)
        {
            string aid = "";

            try
            {
                aid = int.Parse(v_id_nhom).ToString();
            }
            catch
            {
                aid = "-99999";
            }
            return get_data("select id_nhom,menuname,chon,chitiet from " + s_schemaroot + ".v_phanquyennhom where id_nhom=" + aid);
        }
        public DataSet f_get_v_nhomdlogin(string v_id, string v_nhom, string v_ma, string v_ten, string v_diengiai)
        {
            string sql = "", aexp = "";
            v_ma = v_ma.Replace("'", "''");
            v_ten = v_ten.Replace("'", "''");
            v_diengiai = v_diengiai.Replace("'", "''");
            sql = "select a.id,a.nhom,a.ma,a.ten,a.diengiai,a.id_bv_so,a.right_,a.readonly,'' as blank from " + s_schemaroot + ".v_nhomdlogin a";
            if (v_id != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.id=" + v_id;
            }
            if (v_nhom != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.nhom=" + v_nhom + "";
            }
            if (v_ma != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.ma='" + v_ma.Replace("'", "''") + "'";
            }
            if (v_ten != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.ten='" + v_ten.Replace("'", "''") + "'";
            }
            if (v_diengiai != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.diengiai='" + v_diengiai.Replace("'", "''") + "'";
            }

            if (aexp != "")
            {
                aexp = " where " + aexp;
            }
            sql += aexp;
            sql += " order by a.ten";
            return get_data(sql);
        }
        public DataSet f_get_v_dlogin(string v_id, string v_id_nhom, string v_hoten, string v_userid, string v_password_)
        {
            string sql = "", aexp = "";
            sql = "select a.id,a.id_nhom,a.hoten,a.userid,a.password_,right_,loaivp,'' as blank,admin,chinhanh from " + s_schemaroot + ".v_dlogin a";
            if (v_id != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.id=" + v_id;
            }
            if (v_id_nhom != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.id_nhom=" + v_id_nhom;
            }
            if (v_hoten != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.hoten='" + v_hoten + "'";
            }
            if (v_userid != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.userid='" + v_userid + "'";
            }
            if (v_password_ != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.password_='" + v_password_ + "'";
            }

            if (aexp != "")
            {
                aexp = " where " + aexp;
            }
            sql += aexp;
            sql += " order by a.hoten";
            return get_data(sql);
        }
        public DataSet f_get_v_viettat()
        {
            string sql = "select a.stt, a.ma, a.ten,a.readonly from " + s_schemaroot + ".v_viettat a order by a.stt";
            return get_data(sql);
        }
        public DataSet f_get_v_treebaocao(string v_id, string v_id_cha, string v_stt, string v_ten, string str, string v_tenreport, string v_readonly)
        {
            string sql = "", aexp = "";
            sql = "select a.id,a.id_cha,a.stt,a.ten,a.sql,a.tenreport,a.readonly from " + s_schemaroot + ".v_treebaocao a";
            if (v_id != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.id=" + v_id;
            }
            if (v_id_cha != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.id_cha=" + v_id_cha;
            }
            if (v_stt != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.stt=" + v_stt;
            }
            if (v_ten != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.ten='" + v_ten.Replace("'", "''") + "'";
            }
            if (sql != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.sql='" + sql.Replace("'", "''") + "'";
            }
            if (v_tenreport != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.tenreport='" + v_tenreport.Replace("'", "''") + "'";
            }
            if (v_readonly != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.readonly=" + v_readonly + "";
            }

            if (aexp != "")
            {
                aexp = " where " + aexp;
            }
            sql += aexp;
            sql += " order by a.stt,a.ten";
            return get_data(sql);
        }
        public decimal get_stt_v_treebaocao(string v_id_cha)
        {
            decimal art = 1;
            try
            {
                decimal i = 0;
                DataSet ads = get_data("select distinct stt from " + s_schemaroot + ".v_treebaocao where id_cha=" + v_id_cha + " order by stt asc");
                while (i < 999999999999)
                {
                    i = i + 1;
                    if (ads.Tables[0].Select("stt=" + i.ToString()).Length <= 0)
                    {
                        break;
                    }
                }
                art = decimal.Parse(i.ToString());
            }
            catch
            {
                art = 1;
            }
            return art;
        }
        public DataSet f_get_v_dsduyet(string v_ma, string v_ten, string v_readonly)
        {
            string sql = "", aexp = "";
            sql = "select a.ma,a.ten,to_char(a.ngayud,'dd/mm/yyyy hh24:mi') as ngayud,a.readonly,'' as blank,a.mabs from " + s_schemaroot + ".v_dsduyet a";
            if (v_ma != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.ma=" + v_ma.Replace("'", "''") + "";
            }
            if (v_ten != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.ten='" + v_ten.Replace("'", "''") + "'";
            }
            if (v_readonly != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.readonly=" + v_readonly + "";
            }

            if (aexp != "")
            {
                aexp = " where " + aexp;
            }
            sql += aexp;
            sql += " order by a.ten";
            return get_data(sql);
        }
        public DataSet f_get_v_lydomien(string v_id, string v_ten, string v_readonly)
        {
            string sql = "", aexp = "";
            sql = "select a.id,a.ten,to_char(a.ngayud,'dd/mm/yyyy hh24:mi') as ngayud,a.readonly,'' as blank from " + s_schemaroot + ".v_lydomien a";
            if (v_id != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.id=" + v_id;
            }
            if (v_ten != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.ten='" + v_ten.Replace("'", "''") + "'";
            }
            if (v_readonly != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.readonly=" + v_readonly + "";
            }

            if (aexp != "")
            {
                aexp = " where " + aexp;
            }
            sql += aexp;
            sql += " order by a.ten";
            return get_data(sql);
        }
        public DataSet f_get_v_dmlydonopthem(string v_id, string v_ten, string v_readonly)
        {
            string sql = "", aexp = "";
            sql = "select a.id,a.ten,to_char(a.ngayud,'dd/mm/yyyy hh24:mi') as ngayud,a.readonly,'' as blank from " + s_schemaroot + ".v_dmlydonopthem a";
            if (v_id != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.id=" + v_id;
            }
            if (v_ten != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.ten='" + v_ten.Replace("'", "''") + "'";
            }
            if (v_readonly != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.readonly=" + v_readonly + "";
            }

            if (aexp != "")
            {
                aexp = " where " + aexp;
            }
            sql += aexp;
            sql += " order by a.ten";
            return get_data(sql);
        }
        public DataSet f_get_v_dmlydothieu(string v_id, string v_ten, string v_readonly)
        {
            string sql = "", aexp = "";
            sql = "select a.id,a.ten,to_char(a.ngayud,'dd/mm/yyyy hh24:mi') as ngayud,a.readonly,'' as blank from " + s_schemaroot + ".v_dmlydothieu a";
            if (v_id != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.id=" + v_id;
            }
            if (v_ten != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.ten='" + v_ten.Replace("'", "''") + "'";
            }
            if (v_readonly != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.readonly=" + v_readonly + "";
            }

            if (aexp != "")
            {
                aexp = " where " + aexp;
            }
            sql += aexp;
            sql += " order by a.ten";
            return get_data(sql);
        }
        public DataSet f_get_v_loaibn(string v_id, string v_ten, string v_readonly)
        {
            string sql = "", aexp = "";
            sql = "select a.id,a.stt,a.ten,to_char(a.ngayud,'dd/mm/yyyy hh24:mi') as ngayud,a.readonly,'' as blank from " + s_schemaroot + ".v_loaibn a";
            if (v_id != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.id=" + v_id;
            }
            if (v_ten != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.ten='" + v_ten.Replace("'", "''") + "'";
            }
            if (v_readonly != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.readonly=" + v_readonly + "";
            }

            if (aexp != "")
            {
                aexp = " where " + aexp;
            }
            sql += aexp;
            sql += " order by a.stt";
            return get_data(sql);
        }
        public DataSet f_get_v_tenloaivp(string v_ma, string v_ten, string v_readonly)
        {
            string sql = "", aexp = "";
            sql = "select a.ma,a.ten,to_char(a.ngayud,'dd/mm/yyyy hh24:mi') as ngayud,a.readonly,'' as blank from " + s_schemaroot + ".v_tenloaivp a";
            if (v_ma != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.ma=" + v_ma;
            }
            if (v_ten != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.ten='" + v_ten.Replace("'", "''") + "'";
            }
            if (v_readonly != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.readonly=" + v_readonly + "";
            }

            if (aexp != "")
            {
                aexp = " where " + aexp;
            }
            sql += aexp;
            sql += " order by a.ten";
            return get_data(sql);
        }
        public DataSet f_get_v_nhombhyt(string v_id, string v_stt, string v_ten, string v_viettat, string v_readonly)
        {
            string sql = "", aexp = "";
            sql = "select a.id,a.stt,a.ten,a.viettat, to_char(a.ngayud,'dd/mm/yyyy hh24:mi') as ngayud,a.readonly,'' as blank from " + s_schemaroot + ".v_nhombhyt a";
            if (v_id != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.id=" + v_id;
            }
            if (v_stt != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.stt=" + v_stt;
            }
            if (v_ten != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.ten='" + v_ten.Replace("'", "''") + "'";
            }
            if (v_viettat != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.viettat='" + v_viettat.Replace("'", "''") + "'";
            }
            if (v_readonly != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.readonly=" + v_readonly + "";
            }

            if (aexp != "")
            {
                aexp = " where " + aexp;
            }
            sql += aexp;
            sql += " order by a.ten";
            return get_data(sql);
        }
        public DataSet f_get_v_nhomvp(string v_ma, string v_id_nhombhyt, string v_stt, string v_ten, string v_matat, string v_viettat, string v_readonly)
        {
            string sql = "", aexp = "";
            sql = "select a.ma,a.idnhombhyt, a.stt,a.matat,a.ten,a.viettat, to_char(a.ngayud,'dd/mm/yyyy hh24:mi') as ngayud,a.readonly,'' as blank from " + s_schemaroot + ".v_nhomvp a";
            if (v_ma != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.ma=" + v_ma;
            }
            if (v_id_nhombhyt != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.idnhombhyt=" + v_id_nhombhyt;
            }
            if (v_stt != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.stt=" + v_stt;
            }
            if (v_ten != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.ten='" + v_ten.Replace("'", "''") + "'";
            }
            if (v_matat != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.matat='" + v_matat.Replace("'", "''") + "'";
            }
            if (v_viettat != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.viettat='" + v_viettat.Replace("'", "''") + "'";
            }
            if (v_readonly != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.readonly=" + v_readonly + "";
            }

            if (aexp != "")
            {
                aexp = " where " + aexp;
            }
            sql += aexp;
            sql += " order by a.ten";
            return get_data(sql);
        }
        public DataSet f_get_v_nhomvp_frmnhomvp()
        {
            string sql = "";
            sql = "select a.ma, a.stt, a.matat, a.ten, a.viettat, case when b.id is null then -999 else b.id end as idnhombhyt, b.ten as ten_nhombhyt, to_char(a.ngayud,'dd/mm/yyyy hh24:mi') as ngayud, a.readonly, '' as blank from " + s_schemaroot + ".v_nhomvp a left join " + s_schemaroot + ".v_nhombhyt b on a.idnhombhyt=b.id order by a.stt, a.ten";
            return get_data(sql);
        }
        public DataSet f_get_v_loaivp(string v_id, string v_id_nhom, string v_stt, string v_ma, string v_ten, string v_viettat, string v_readonly)
        {
            string sql = "", aexp = "";
            sql = "select a.id,a.id_vdt,a.id_nhom,a.stt,a.ma,a.ten,a.viettat,a.computer,to_char(a.ngayud,'dd/mm/yyyy hh24:mi') as ngayud,a.readonly,'' as blank from " + s_schemaroot + ".v_loaivp a";
            if (v_id != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.id=" + v_id;
            }
            if (v_id_nhom != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.id_nhom=" + v_id;
            }
            if (v_stt != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.stt=" + v_stt;
            }
            if (v_ma != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.ma='" + v_ma.Replace("'", "''") + "'";
            }
            if (v_ten != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.ten='" + v_ten.Replace("'", "''") + "'";
            }
            if (v_viettat != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.viettat='" + v_viettat.Replace("'", "''") + "'";
            }
            if (v_readonly != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.readonly=" + v_readonly + "";
            }

            if (aexp != "")
            {
                aexp = " where " + aexp;
            }
            sql += aexp;
            sql += " order by a.ten";
            return get_data(sql);
        }
        public DataSet f_get_v_loaivp_frmloaivp()
        {
            string sql = "";
            sql = "select a.readonly,a.id,a.id_vdt,a.stt,a.ma,a.ten,a.viettat, a.computer,to_char(a.ngayud,'dd/mm/yyyy hh24:mi') as ngayud, b.ten as ten_nhom, c.ten as ten_nhombhyt,'' as blank, case when b.ma is null then -999 else b.ma end as id_nhom, case when c.id is null then -999 else c.id end as idnhombhyt,computervp from " + s_schemaroot + ".v_loaivp a left join " + s_schemaroot + ".v_nhomvp b on a.id_nhom=b.ma left join " + s_schemaroot + ".v_nhombhyt c on b.idnhombhyt=c.id order by a.stt,a.ten";
            return get_data(sql);
        }
        public DataSet f_get_v_giavp(string v_id, string v_id_loai, string v_stt, string v_ma, string v_ten, string v_dvt, string v_readonly)
        {
            string sql = "", aexp = "";
            sql = "select a.id,a.id_loai,a.stt,a.ma,a.ten,a.dvt,to_char(a.ngayud,'dd/mm/yyyy hh24:mi') as ngayud,a.readonly,'' as blank from " +
                s_schemaroot + ".v_giavp" + s_dblink + " a";
            if (v_id != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.id=" + v_id;
            }
            if (v_id_loai != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.id_loai=" + v_id;
            }
            if (v_stt != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.stt=" + v_stt;
            }
            if (v_ma != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.ma='" + v_ma.Replace("'", "''") + "'";
            }
            if (v_ten != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.ten='" + v_ten.Replace("'", "''") + "'";
            }
            if (v_dvt != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.dvt='" + v_dvt.Replace("'", "''") + "'";
            }
            if (v_readonly != "")
            {
                if (aexp != "")
                {
                    aexp += " and ";
                }
                aexp += "a.readonly=" + v_readonly + "";
            }

            if (aexp != "")
            {
                aexp = " where " + aexp;
            }
            sql += aexp;
            sql += " order by a.ten";
            return get_data(sql);
        }
        public DataSet f_get_v_nhombhyt_frmgiavp()
        {
            string sql = "";
            sql = "select a.id, a.stt, a.ten from " + s_schemaroot + ".v_nhombhyt a order by a.ten";
            return get_data(sql);
        }
        public DataSet f_get_v_nhomvp_frmgiavp()
        {
            string sql = "";
            sql = "select a.ma, a.stt, a.ten, a.idnhombhyt from " + s_schemaroot + ".v_nhomvp a order by a.ten";
            return get_data(sql);
        }
        public DataSet f_get_v_loaivp_frmgiavp()
        {
            string sql = "";
            sql = "select a.id, a.stt, a.ten, a.id_nhom from " + s_schemaroot + ".v_loaivp a order by a.ten";
            return get_data(sql);
        }
        public DataSet f_get_v_giavp_frmgiavp()
        {
            string sql = "";
            sql = "select a.readonly,a.id,a.stt,a.ma,a.ten,a.dvt,a.gia_th,a.gia_bh,a.gia_dv,a.gia_nn,a.gia_cs,a.vattu_th,a.vattu_bh,a.vattu_dv,a.vattu_nn,a.vattu_cs,case when a.bhyt is null then 0 else a.bhyt end as bhyt,b.ten as ten_loaivp, d.ten as ten_nhomvp,'' as tenloaitrongoi,e.ten as ten_nhombhyt, c.ten as ten_loaibn,case when a.theobs is null then 0 else a.theobs end as theobs, case when a.trongoi is null then 0 else a.trongoi end as trongoi,case when a.chenhlech is null then 0 else a.chenhlech end as chenhlech,case when a.chenhlech is null then 0 else a.chenhlech end as thuong,case when a.ndm is null then 0 else a.ndm end as ndm,a.locthe,to_char(a.ngayud,'dd/mm/yyyy hh24:mi') as ngayud,case when a.loaibn is null then 0 else a.loaibn end as loaibn,a.loaitrongoi,case when b.id is null then -999 else b.id end as id_loai,b.id_nhom,'' as blank from medibv.v_giavp a left join medibv.v_loaivp b on a.id_loai=b.id left join medibv.v_loaibn c on a.loaibn=c.id left join medibv.v_nhomvp d on b.id_nhom=d.ma left join medibv.v_nhombhyt e on d.idnhombhyt=e.id order by a.stt,a.ten";
            sql = sql.Replace("medibv.", s_schemaroot + ".");
            return get_data(sql);
        }
        public DataSet f_get_v_loaibn_frmgiavp()
        {
            try
            {
                DataSet ads = new DataSet();
                ads.Tables.Add("Table");
                ads.Tables[0].Columns.Add("id");
                ads.Tables[0].Columns.Add("ten");
                DataRow r;

                r = ads.Tables[0].NewRow();
                r["id"] = "0";
                r["ten"] = "Tất cả";
                ads.Tables[0].Rows.Add(r.ItemArray);

                r = ads.Tables[0].NewRow();
                r["id"] = "1";
                r["ten"] = "Nội trú";
                ads.Tables[0].Rows.Add(r.ItemArray);

                r = ads.Tables[0].NewRow();
                r["id"] = "2";
                r["ten"] = "Ngoại trú";
                ads.Tables[0].Rows.Add(r.ItemArray);
                return ads;
            }
            catch
            {
                return null;
            }
        }
        public DataSet f_get_d_loaikho_frmphannhomduoc()
        {
            string sql = "";
            sql = "select a.id,a.ten,to_char(a.ngayud,'dd/mm/yyyy hh24:mi') as ngayud,'' as blank from medibv.d_loaikho a order by a.ten";
            sql = sql.Replace("medibv.", s_schemaroot + ".");
            return get_data(sql);
        }
        public DataSet f_get_d_dmnhom_frmphannhomduoc()
        {
            string sql = "";
            sql = "select a.id,a.nhom,case when b.ma is null then -999 else b.ma end as nhomvp, b.ten as ten_nhomvp,case when b.ma is null then -999 else b.idnhombhyt end as idnhombhyt,a.stt,a.ten,to_char(a.ngayud,'dd/mm/yyyy hh24:mi') as ngayud,'' as blank from medibv.d_dmnhom a left join medibv.v_nhomvp b on a.nhomvp=b.ma order by a.stt,a.ten";
            sql = sql.Replace("medibv.", s_schemaroot + ".");
            return get_data(sql);
        }
        public DataSet f_get_dmtuoi()
        {
            DataSet ads = new DataSet();
            ads.Tables.Add("Table");
            ads.Tables[0].Columns.Add("id");
            ads.Tables[0].Columns.Add("ten");
            ads.Tables[0].Rows.Add(new string[] { "1", Change_language_MessageText("Tuổi") });
            ads.Tables[0].Rows.Add(new string[] { "2", Change_language_MessageText("Tháng") });
            ads.Tables[0].Rows.Add(new string[] { "3", Change_language_MessageText("Ngày") });
            return ads;
        }
        public void f_set_d_dmnhom_nhomvp_frmphannhomduoc(string v_id_d_dmnhom, string v_id_v_nhomvp)
        {
            execute_data("update " + s_schemaroot + ".d_dmnhom set nhomvp=" + v_id_v_nhomvp + " where id=" + v_id_d_dmnhom);
        }
        public string field_gia(string madoituong)
        {
            string fie = "gia_th";
            if (madoituong != "")
            {
                try
                {
                    DataTable tmp = get_data("select field_gia from medibv.doituong where madoituong=" + int.Parse(madoituong)).Tables[0];
                    if (tmp.Rows.Count > 0) return tmp.Rows[0]["field_gia"].ToString().Trim();
                }
                catch
                {
                }
            }
            return fie;
        }
        #endregion

        #region GET DATA BÁO CÁO
        public int iNgaykiemke
        {
            get
            {
                ds_ngaykk = get_data("select ten from " + user + ".d_thongso where id=105");
                if (ds_ngaykk.Tables[0].Rows.Count > 0) return int.Parse(ds_ngaykk.Tables[0].Rows[0]["ten"].ToString());
                else return 7;
            }
        }
        public DataSet get_data_mmyy(string str, string tu, string den, bool khoangcach)
        {
            DataSet tmp = new DataSet();
            try
            {
                DateTime dt1 = (khoangcach) ? StringToDate(tu).AddDays(-iNgaykiemke) : StringToDate(tu);
                DateTime dt2 = (khoangcach) ? StringToDate(den).AddDays(iNgaykiemke) : StringToDate(den);
                if (dt1 > dt2) dt1 = dt2;
                int y1 = dt1.Year, m1 = dt1.Month;
                int y2 = dt2.Year, m2 = dt2.Month;
                int itu, iden;
                string mmyy = "", sql = "";
                bool be = true;
                for (int i = y1; i <= y2; i++)
                {
                    itu = (i == y1) ? m1 : 1;
                    iden = (i == y2) ? m2 : 12;
                    for (int j = itu; j <= iden; j++)
                    {
                        mmyy = j.ToString().PadLeft(2, '0') + i.ToString().Substring(2, 2);
                        if (bMmyy(mmyy))
                        {
                            sql = str.Replace("medibvmmyy.", m_db_schemaroot + "" + mmyy + ".");
                            sql = sql.Replace("medibv.", m_db_schemaroot + ".");
                            if (be || tmp == null || tmp.Tables.Count <= 0 || tmp.Tables[0].Rows.Count <=0)
                            {
                                tmp = get_data(sql);
                                be = false;
                            }
                            else tmp.Merge(get_data(sql));
                        }
                    }
                }
                return tmp;
            }
            catch
            {
                return tmp;
            }

        }
        public DataSet get_data_bc(DateTime v_tn, DateTime v_dn, string str)
        {
            try
            {
                string sql = "", ammyy = "";
                DataSet ads = null, ads1 = null;
                if (v_tn > v_dn)
                {
                    v_tn = v_dn;
                }
                if (str.IndexOf("medibvmmyy.") >= 0)
                {
                    while (DateTime.Compare(v_tn, v_dn) <= 0)//(v_dn>= v_tn)
                    {
                        ammyy = v_dn.Month.ToString().PadLeft(2, '0') + v_dn.Year.ToString().Substring(2);
                        sql = str.Replace("medibvmmyy.", m_db_schemaroot + ammyy + ".");
                        sql = sql.Replace("medibv.", m_db_schemaroot + ".");
                        ads1 = get_data(sql);
                        if (ads1 != null)
                        {
                            if (ads == null)
                            {
                                ads = ads1;
                            }
                            else
                            {
                                ads.Merge(ads1);
                            }
                        }
                        v_dn = v_dn.AddMonths(-1);
                    }
                }
                else
                {
                    sql = str.Replace("medibv.", m_db_schemaroot + ".");
                    ads = get_data(sql);
                }
                return ads;
            }
            catch
            {
                return null;
            }
        }
        public DataSet get_data_bc(DateTime v_tn, DateTime v_dn, string str, int v_limit)
        {
            try
            {
                if (v_tn > v_dn)
                {
                    v_tn = v_dn;
                }

                string sql = "", ammyy = "", alimit = "";
                if (v_limit > 0)
                {
                    alimit = " limit " + v_limit.ToString();
                }
                DataSet ads = null, ads1 = null;
                if (str.IndexOf("medibvmmyy.") >= 0)
                {
                    while (DateTime.Compare(v_tn, v_dn) <= 0)//(v_dn >= v_tn )
                    {
                        ammyy = v_dn.Month.ToString().PadLeft(2, '0') + v_dn.Year.ToString().Substring(2);
                        sql = str.Replace("medibvmmyy.", m_db_schemaroot + ammyy + ".");
                        sql = sql.Replace("medibv.", m_db_schemaroot + ".");
                        if (sql.IndexOf("limit") < 0 && alimit != "")
                        {
                            sql += alimit;
                        }
                        ads1 = get_data(sql);
                        if (ads1 != null)
                        {
                            if (ads == null)
                            {
                                ads = ads1;
                            }
                            else
                            {
                                ads.Merge(ads1);
                            }
                            if (ads != null)
                            {
                                if (alimit != "" && ads.Tables[0].Rows.Count >= v_limit)
                                {
                                    return ads;
                                }
                            }
                        }
                        v_dn = v_dn.AddMonths(-1);
                    }
                }
                else
                {
                    sql = str.Replace("medibv.", m_db_schemaroot + ".");
                    if (sql.IndexOf("limit") < 0 && alimit != "")
                    {
                        sql += alimit;
                    }
                    ads = get_data(sql);
                }
                return ads;
            }
            catch
            {
                return null;
            }
        }
        public DataSet get_data_bc_1(string v_tn10, string v_dn10, string str)
        {
            string sql = "", ammyy = "";
            try
            {                
                DataSet ads = null, adst = null;
                sql = str;
                if (v_tn10.Length < 10)
                {
                    v_tn10 = s_curdd_mm_yyyy;
                }
                else
                {
                    v_tn10 = v_tn10.Substring(0, 10);
                }
                if (v_dn10.Length < 10)
                {
                    v_dn10 = s_curdd_mm_yyyy;
                }
                else
                {
                    v_dn10 = v_dn10.Substring(0, 10);
                }
                if (sql.IndexOf("medibvmmyy.") >= 0)
                {
                    if (v_tn10.Length == 10 && v_dn10.Length == 10)
                    {
                        DateTime atu = f_parse_date(v_tn10);
                        DateTime aden = f_parse_date(v_dn10);
                        atu = atu.AddMonths(-1);
                        aden = aden.AddMonths(1);

                        if (atu > aden)
                        {
                            atu = aden;
                        }

                        while (DateTime.Compare(atu, aden.AddMonths(1)) <= 0)//(aden >= atu )
                        {
                            ammyy = aden.Month.ToString().PadLeft(2, '0') + aden.Year.ToString().Substring(2);
                            sql = str.Replace("medibvmmyy.", m_db_schemaroot + "" + ammyy + ".");
                            sql = sql.Replace("medibv.", m_db_schemaroot + ".");
                            if (s_iscreated_mmyy(ammyy))
                            {
                                adst = get_data(sql);
                                if (adst != null)
                                {
                                    if (ads == null)
                                    {
                                        ads = adst;
                                    }
                                    else
                                    {
                                        ads.Merge(adst);
                                    }
                                }
                            }
                            aden = aden.AddMonths(-1);
                        }
                    }
                }
                else
                {
                    sql = str.Replace("medibv.", m_db_schemaroot + ".");
                    ads = get_data(sql);
                }
                return ads;
            }
            catch(Exception ex)
            {
                upd_error(sql + " - " + ex.ToString(), System.Environment.MachineName, "?");
                return null;
            }
        }
        public DataSet get_data_bc_1(string v_tn10, string v_dn10, string str, int v_limit)
        {
            try
            {
                string sql = "", ammyy = "", alimit = "";
                if (v_limit > 0)
                {
                    alimit = " limit " + v_limit.ToString();
                }
                DataSet ads = null, adst = null;
                sql = str;
                if (v_tn10.Length < 10)
                {
                    v_tn10 = s_curdd_mm_yyyy;
                }
                else
                {
                    v_tn10 = v_tn10.Substring(0, 10);
                }
                if (v_dn10.Length < 10)
                {
                    v_dn10 = s_curdd_mm_yyyy;
                }
                else
                {
                    v_dn10 = v_dn10.Substring(0, 10);
                }
                if (sql.IndexOf("medibvmmyy.") >= 0)
                {
                    if (v_tn10.Length == 10 && v_dn10.Length == 10)
                    {
                        DateTime atu = f_parse_date(v_tn10);
                        DateTime aden = f_parse_date(v_dn10);
                        atu = atu.AddMonths(-1);
                        aden = aden.AddMonths(1);

                        while (DateTime.Compare(atu, aden) <= 0)//(aden  >= atu )
                        {
                            ammyy = aden.Month.ToString().PadLeft(2, '0') + aden.Year.ToString().Substring(2);
                            sql = str.Replace("medibvmmyy.", m_db_schemaroot + "" + ammyy + ".");
                            sql = sql.Replace("medibv.", m_db_schemaroot + ".");
                            if (sql.IndexOf("limit") < 0 && alimit != "")
                            {
                                sql += alimit;
                            }
                            if (s_iscreated_mmyy(ammyy))
                            {
                                adst = get_data(sql);
                                if (adst != null)
                                {
                                    if (ads == null)
                                    {
                                        ads = adst;
                                    }
                                    else
                                    {
                                        ads.Merge(adst);
                                    }
                                    if (ads != null)
                                    {
                                        if (alimit != "" && ads.Tables[0].Rows.Count >= v_limit)
                                        {
                                            return ads;
                                        }
                                    }
                                }
                            }
                            aden = aden.AddMonths(-1);
                        }
                    }
                }
                else
                {
                    sql = str.Replace("medibv.", m_db_schemaroot + ".");
                    ads = get_data(sql);
                }
                return ads;
            }
            catch
            {
                return null;
            }
        }
        public DataSet get_data_mmyy(string v_mmyy, string sql)
        {
            sql = sql.Replace("medibvmmyy.", m_db_schemaroot + v_mmyy + ".");
            sql = sql.Replace("medibv.", m_db_schemaroot + ".");
            return get_data(sql);
        }
        public DataSet get_data_mmyy(string v_mmyy, string sql, int v_limit)
        {
            sql = sql.Replace("medibvmmyy.", m_db_schemaroot + v_mmyy + ".");
            sql = sql.Replace("medibv.", m_db_schemaroot + ".");
            if (sql.IndexOf("limit") < 0 && v_limit > 0)
            {
                sql += " limit " + v_limit.ToString();
            }
            return get_data(sql);
        }
        public void execute_data(string v_tn10, string v_dn10, string str)
        {
            try
            {
                string sql = "", ammyy = "";
                sql = str;
                if (v_tn10.Length < 10)
                {
                    v_tn10 = s_curdd_mm_yyyy;
                }
                else
                {
                    v_tn10 = v_tn10.Substring(0, 10);
                }
                if (v_dn10.Length < 10)
                {
                    v_dn10 = s_curdd_mm_yyyy;
                }
                else
                {
                    v_dn10 = v_dn10.Substring(0, 10);
                }

                if (sql.IndexOf("medibvmmyy.") >= 0)
                {
                    if (v_tn10.Length == 10 && v_dn10.Length == 10)
                    {
                        DateTime atu = f_parse_date(v_tn10);
                        DateTime aden = f_parse_date(v_dn10);
                        atu = atu.AddMonths(-1);
                        aden = aden.AddMonths(1);

                        while (DateTime.Compare(atu, aden) <= 0)//(aden >= atu )
                        {
                            ammyy = aden.Month.ToString().PadLeft(2, '0') + aden.Year.ToString().Substring(2);
                            sql = str.Replace("medibvmmyy.", m_db_schemaroot + "" + ammyy + ".");
                            sql = sql.Replace("medibv.", m_db_schemaroot + ".");
                            if (s_iscreated_mmyy(ammyy))
                            {
                                execute_data(sql);
                            }
                            aden = aden.AddMonths(-1);
                        }
                    }
                }
                else
                {
                    ammyy = s_curmmyy;
                    sql = str.Replace("medibvmmyy.", m_db_schemaroot + "" + ammyy + ".");
                    sql = sql.Replace("medibv.", m_db_schemaroot + ".");
                    execute_data(sql);
                }
            }
            catch
            {
            }
        }
        public void execute_data(string v_tn10, string v_dn10, string str, bool bluuerror)
        {
            try
            {
                string sql = "", ammyy = "";
                sql = str;
                if (v_tn10.Length < 10)
                {
                    v_tn10 = s_curdd_mm_yyyy;
                }
                else
                {
                    v_tn10 = v_tn10.Substring(0, 10);
                }
                if (v_dn10.Length < 10)
                {
                    v_dn10 = s_curdd_mm_yyyy;
                }
                else
                {
                    v_dn10 = v_dn10.Substring(0, 10);
                }

                if (sql.IndexOf("medibvmmyy.") >= 0)
                {
                    if (v_tn10.Length == 10 && v_dn10.Length == 10)
                    {
                        DateTime atu = f_parse_date(v_tn10);
                        DateTime aden = f_parse_date(v_dn10);
                        atu = atu.AddMonths(-1);
                        aden = aden.AddMonths(1);

                        while (DateTime.Compare(aden, atu) <= 0)//(aden >= atu)
                        {
                            ammyy = aden.Month.ToString().PadLeft(2, '0') + aden.Year.ToString().Substring(2);
                            sql = str.Replace("medibvmmyy.", m_db_schemaroot + "" + ammyy + ".");
                            sql = sql.Replace("medibv.", m_db_schemaroot + ".");
                            if (s_iscreated_mmyy(ammyy))
                            {
                                execute_data(bluuerror, sql);
                            }
                            aden = aden.AddMonths(-1);
                        }
                    }
                }
                else
                {
                    ammyy = s_curmmyy;
                    sql = str.Replace("medibvmmyy.", m_db_schemaroot + "" + ammyy + ".");
                    sql = sql.Replace("medibv.", m_db_schemaroot + ".");
                    execute_data(sql);
                }
            }
            catch
            {
            }
        }
        public DataSet merge(DataSet ds1, DataSet ds2)
        {
            DataRow r1;
            foreach (DataRow r in ds2.Tables[0].Rows)
            {
                r1 = ds1.Tables[0].NewRow();
                for (int i = 0; i < ds2.Tables[0].Columns.Count; i++) r1[i] = r[i].ToString();
                ds1.Tables[0].Rows.Add(r1);
            }
            return ds1;
        }
        public DataSet merge(DataSet ds1, DataRow[] dr)
        {
            DataRow r1;
            r1 = ds1.Tables[0].NewRow();
            for (int i = 0; i < dr.Length; i++) r1[i] = dr[0][i].ToString();
            ds1.Tables[0].Rows.Add(r1);
            return ds1;
        }
        #endregion

        #region CÁC SỰ KIỆN WINDOWS
        public void f_SetEvent(System.Windows.Forms.Control v_c)
        {
            try
            {
                if (v_c.Controls.Count > 0)
                {
                    foreach (Control c in v_c.Controls)
                    {
                        if (c.Controls.Count > 0)
                        {
                            f_SetEvent(c);
                        }
                        else
                        {
                            c.Leave += new System.EventHandler(this.f_Control_Leave);
                            c.Enter += new System.EventHandler(this.f_Control_Enter);
                        }
                    }
                }
                else
                {
                    v_c.Leave += new System.EventHandler(this.f_Control_Leave);
                    v_c.Enter += new System.EventHandler(this.f_Control_Enter);
                }
            }
            catch
            {
            }
        }
        public void f_SetEvent_Keydown(System.Windows.Forms.Control v_c)
        {
            try
            {
                if (v_c.Controls.Count > 0)
                {
                    foreach (Control c in v_c.Controls)
                    {
                        if (c.Controls.Count > 0)
                        {
                            f_SetEvent_Keydown(c);
                        }
                        else
                        {
                            c.Leave += new System.EventHandler(this.f_Control_Leave);
                            c.Enter += new System.EventHandler(this.f_Control_Enter);
                            c.KeyDown += new System.Windows.Forms.KeyEventHandler(this.f_Control_KeyDown);
                        }
                    }
                }
                else
                {
                    v_c.Leave += new System.EventHandler(this.f_Control_Leave);
                    v_c.Enter += new System.EventHandler(this.f_Control_Enter);
                    v_c.KeyDown += new System.Windows.Forms.KeyEventHandler(this.f_Control_KeyDown);
                }
            }
            catch
            {
            }
        }
        public void f_Control_Enter(object sender, System.EventArgs e)
            {
            try
            {
                System.Windows.Forms.Control c = (System.Windows.Forms.Control)(sender);
                if (c.GetType().ToString() == "System.Windows.Forms.Button")
                {
                    c.ForeColor = Color.Red;
                }
                else
                    if ((c.GetType().ToString() == "System.Windows.Forms.TextBox") || (c.GetType().ToString() == "System.Windows.Forms.MaskedTextBox") || (c.GetType().ToString() == "System.Windows.Forms.ComboBox") || (c.GetType().ToString() == "AsYetUnnamed.MultiColumnListBox") || (c.GetType().ToString() == "System.Windows.Forms.TreeView") || (c.GetType().ToString() == "System.Windows.Forms.DataGrid") || (c.GetType().ToString() == "System.Windows.Forms.DateTimePicker") || (c.GetType().ToString() == "System.Windows.Forms.CheckedListBox") || (c.GetType().ToString() == "System.Windows.Forms.NumericUpDown"))
                    {
                        c.BackColor = Color.LightYellow;
                        if (c.ForeColor != Color.Black)
                        {
                            //c.ForeColor=SystemColors.InfoText;
                        }
                        if (c.GetType().ToString() == "System.Windows.Forms.DataGrid")
                        {
                            System.Windows.Forms.DataGrid c1 = (System.Windows.Forms.DataGrid)(sender);
                            c1.BackgroundColor = Color.LightYellow;
                        }
                        else
                        {
                            if (c.GetType().ToString() == "System.Windows.Forms.DataGridView")
                            {
                                System.Windows.Forms.DataGridView c2 = (System.Windows.Forms.DataGridView)(sender);
                                c2.BackgroundColor = Color.LightYellow;
                            }
                            else
                                if (c.GetType().ToString() == "System.Windows.Forms.RichTextBox")
                                {
                                    System.Windows.Forms.RichTextBox c3 = (System.Windows.Forms.RichTextBox)(sender);
                                    c3.BackColor = Color.LightYellow;
                                }
                                else
                                    if (c.GetType().ToString() == "System.Windows.Forms.ComboBox")
                                    {
                                        /*
                                        System.Windows.Forms.ComboBox c1 = (System.Windows.Forms.ComboBox)(sender);
                                        if (c1.SelectedIndex < 0)
                                        {
                                            c1.SelectedIndex = 0;
                                        }
                                        */
                                    }
                        }
                    }
            }
            catch
            {
            }
        }
        public void f_Control_Leave(object sender, System.EventArgs e)
        {
            try
            {
                System.Windows.Forms.Control c = (System.Windows.Forms.Control)(sender);
                if (c.GetType().ToString() == "System.Windows.Forms.Button")
                {
                    c.ForeColor = Color.FromArgb(0, 51, 0);
                }
                else
                    if ((c.GetType().ToString() == "System.Windows.Forms.TextBox") || (c.GetType().ToString() == "System.Windows.Forms.MaskedTextBox") || (c.GetType().ToString() == "System.Windows.Forms.ComboBox") || (c.GetType().ToString() == "AsYetUnnamed.MultiColumnListBox") || (c.GetType().ToString() == "System.Windows.Forms.TreeView") || (c.GetType().ToString() == "System.Windows.Forms.DataGrid") || (c.GetType().ToString() == "System.Windows.Forms.DateTimePicker") || (c.GetType().ToString() == "System.Windows.Forms.CheckedListBox") || (c.GetType().ToString() == "System.Windows.Forms.NumericUpDown"))
                    {
                        c.BackColor = Color.White;//GhostWhite;
                        if (c.ForeColor != Color.Red && c.ForeColor != Color.DarkRed)
                        {
                            //c.ForeColor=SystemColors.ControlText;
                        }
                        if (c.GetType().ToString() == "System.Windows.Forms.TreeView")
                        {
                            c.BackColor = Color.MintCream;
                        }
                        else
                            if (c.GetType().ToString() == "System.Windows.Forms.DataGrid")
                            {
                                System.Windows.Forms.DataGrid c1 = (System.Windows.Forms.DataGrid)(sender);
                                c1.BackgroundColor = Color.MintCream;
                            }
                            else
                                if (c.GetType().ToString() == "System.Windows.Forms.DataGridView")
                                {
                                    System.Windows.Forms.DataGridView c2 = (System.Windows.Forms.DataGridView)(sender);
                                    c2.BackgroundColor = Color.MintCream;
                                }
                                else
                                    if (c.GetType().ToString() == "System.Windows.Forms.RichTextBox")
                                    {
                                        System.Windows.Forms.RichTextBox c3 = (System.Windows.Forms.RichTextBox)(sender);
                                        c3.BackColor = Color.White;
                                    }
                    }
            }
            catch
            {
            }
        }
        private void f_Control_KeyDown(object sender, KeyEventArgs e)
        {
            try
            {
                if (e.KeyCode == Keys.Enter)
                {
                    SendKeys.Send("{Tab}");
                }
            }
            catch
            {
            }
        }
        #endregion CÁC SỰ KIỆN WINDOWS

        #region VP_TREEMNU
        public DataSet get_vp_treemenu()
        {
            string sql = "select * from medibv.vp_treemenu";
            return get_data(sql);
        }
        public bool reorder_vp_treemenu(string v_id, int v_step)
        {
            try
            {
                DataRow r = get_data("select * from medibv.vp_treemenu where id=" + v_id + "").Tables[0].Rows[0];
                DataRow r1;
                if (v_step > 0)
                {
                    r1 = get_data("select * from medibv.vp_treemenu where id_cha=" + r["id_cha"].ToString() + " and stt>" + r["stt"].ToString() + " order by stt asc").Tables[0].Rows[0];
                }
                else
                {
                    r1 = get_data("select * from medibv.vp_treemenu where id_cha=" + r["id_cha"].ToString() + " and stt<" + r["stt"].ToString() + " order by stt desc").Tables[0].Rows[0];
                }
                execute_data("update medibv.vp_treemenu set stt=" + r1["stt"].ToString() + " where id=" + r["id"].ToString());
                execute_data("update medibv.vp_treemenu set stt=" + r["stt"].ToString() + " where id=" + r1["id"].ToString());
                return true;
            }
            catch
            {
                return false;
            }
        }
        public string get_stt_vp_treemenu(string v_id_cha)
        {
            try
            {
                if (v_id_cha == "") v_id_cha = "0";
                return get_data("select case when max(stt) is null then 0 else max(stt) end + 1 as stt from medibv.vp_treemenu where id_cha=" + v_id_cha + "").Tables[0].Rows[0][0].ToString();
            }
            catch
            {
                return "1";
            }
        }
        public string get_id_vp_treemenu()
        {
            try
            {
                return get_data("select case when max(id) is null then 0 else max(id) end + 1 as stt from medibv.vp_treemenu").Tables[0].Rows[0][0].ToString();
            }
            catch
            {
                return "1";
            }
        }
        public bool del_vp_treemenu(string v_id)
        {
            try
            {
                execute_data("delete medibv.vp_treemenu where id=" + v_id + " and readonly=0");
                return !(get_data("select id from medibv.vp_treemenu where id=" + v_id).Tables[0].Rows.Count > 0);
            }
            catch
            {
                return false;
            }
        }
        public bool upd_vp_null(string v_id, string v_ten)
        {
            sql = "update " + m_db_schemaroot + ".vp_null set ten=:v_ten where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Text).Value = v_id;
            cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + m_db_schemaroot + ".vp_null(id, ten) values(:v_id, :v_ten)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Text).Value = v_id;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "vp_null");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public bool upd_vp_treemenu(decimal v_id, decimal v_id_cha, decimal v_stt, string v_ten, string sql, string v_tenfield, string v_captionfield, string v_width, string v_report, decimal v_readonly)
        {
            sql = "update " + m_db_schemaroot + ".vp_treemenu set id_cha=:v_id_cha, stt=:v_stt,ten=:v_ten,sql=:sql, tenfield=:v_tenfield, captionfield=:v_captionfield, width=:v_width, report=:v_report, readonly=:v_readonly where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_id_cha", NpgsqlDbType.Numeric).Value = v_id_cha;
            cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
            cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
            cmd.Parameters.Add("sql", NpgsqlDbType.Text).Value = sql;
            cmd.Parameters.Add("v_tenfield", NpgsqlDbType.Text).Value = v_tenfield;
            cmd.Parameters.Add("v_captionfield", NpgsqlDbType.Text).Value = v_captionfield;
            cmd.Parameters.Add("v_width", NpgsqlDbType.Text).Value = v_width;
            cmd.Parameters.Add("v_report", NpgsqlDbType.Text).Value = v_report;
            cmd.Parameters.Add("v_readonly", NpgsqlDbType.Numeric).Value = v_readonly;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + m_db_schemaroot + ".vp_treemenu(id,id_cha,stt,ten,sql,tenfield,captionfield,width,report,readonly) values(:v_id,:v_id_cha,:v_stt,:v_ten,:sql,:v_tenfield,:v_captionfield,:v_width,:v_report,:v_readonly)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_id_cha", NpgsqlDbType.Numeric).Value = v_id_cha;
                    cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
                    cmd.Parameters.Add("sql", NpgsqlDbType.Text).Value = sql;
                    cmd.Parameters.Add("v_tenfield", NpgsqlDbType.Text).Value = v_tenfield;
                    cmd.Parameters.Add("v_captionfield", NpgsqlDbType.Text).Value = v_captionfield;
                    cmd.Parameters.Add("v_width", NpgsqlDbType.Text).Value = v_width;
                    cmd.Parameters.Add("v_report", NpgsqlDbType.Text).Value = v_report;
                    cmd.Parameters.Add("v_readonly", NpgsqlDbType.Numeric).Value = v_readonly;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "vp_treemenu");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        #endregion

        #region TỔNG HỢP SỐ LIỆU: CHUA CONVERT
        public DataSet get_v_chidinh(string v_mabn, string v_maql, string v_paid, string v_done)
        {
            string sql = "";
            string aexp = "";
            if (v_mabn == "" && v_maql == "")
            {
                return null;
            }

            if (v_mabn != "")
            {
                if (aexp == "")
                {
                    aexp = "a.mabn='" + v_mabn + "'";
                }
                else
                {
                    aexp += " and a.mabn='" + v_mabn + "'";
                }
            }
            if (v_maql != "")
            {
                if (aexp == "")
                {
                    aexp = "a.maql=" + v_maql;
                }
                else
                {
                    aexp += " and a.maql=" + v_maql;
                }
            }
            if (v_paid != "")
            {
                if (aexp == "")
                {
                    aexp = "a.paid=" + v_paid;
                }
                else
                {
                    aexp += " and a.paid=" + v_paid;
                }
            }
            if (v_done != "")
            {
                if (aexp == "")
                {
                    aexp = "a.done=" + v_done;
                }
                else
                {
                    aexp += " and a.done=" + v_done;
                }
            }
            aexp = aexp.Trim();
            if (aexp.Length > 0)
            {
                aexp = " where " + aexp;
            }
            foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
            {
                if (sql != "")
                {
                    sql += " union all ";
                }
                sql += "select a.id,a.mabn,a.maql,a.idkhoa,a.ngay,a.loai,a.makp,a.madoituong,a.mavp,a.soluong,a.dongia,a.paid,a.done,a.userid,a.ngayud,a.vattu,a.tinhtrang,a.thuchien,a.computer, to_char(a.ngay,'dd/mm/yyyy') ngaynhap from " + r["schemaname"].ToString() + ".v_chidinh a" + aexp;
            }
            return get_data(sql);
        }
        public DataSet get_v_vpkhoa(string v_mabn, string v_maql, string v_idkhoa, string v_done)
        {
            string sql = "";
            string aexp = "";
            if (v_mabn == "" && v_maql == "")
            {
                return null;
            }

            if (v_mabn != "")
            {
                if (aexp == "")
                {
                    aexp += "a.mabn='" + v_mabn + "'";
                }
                else
                {
                    aexp += " and a.mabn='" + v_mabn + "'";
                }
            }
            if (v_maql != "")
            {
                if (aexp == "")
                {
                    aexp += "a.maql=" + v_maql;
                }
                else
                {
                    aexp += " and a.maql=" + v_maql;
                }
            }
            if (v_idkhoa != "")
            {
                if (aexp == "")
                {
                    aexp += "a.idkhoa=" + v_idkhoa;
                }
                else
                {
                    aexp += " and a.idkhoa=" + v_idkhoa;
                }
            }
            if (v_done != "")
            {
                if (aexp == "")
                {
                    aexp += "a.done=" + v_done;
                }
                else
                {
                    aexp += " and a.done=" + v_done;
                }
            }
            aexp = aexp.Trim();
            if (aexp.Length > 0)
            {
                aexp = " where " + aexp;
            }

            foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
            {
                if (sql != "")
                {
                    sql += " union all ";
                }
                sql += "select a.id,a.mabn,a.maql,a.idkhoa,a.ngay,a.makp,a.madoituong,a.mavp,a.soluong,a.dongia,a.done,a.userid,a.ngayud,a.vattu,to_char(a.ngay,'dd/mm/yyyy') ngaynhap from " + r["schemaname"].ToString() + ".v_vpkhoa a" + aexp;
            }
            return get_data(sql);

        }
        public DataSet get_v_vpkhoa_in(string v_mabn, string v_maql, string v_idkhoa, string v_done, string v_ngayin)
        {
            string sql = "";
            string aexp = "";
            if (v_mabn == "" && v_maql == "")
            {
                return null;
            }
            if (v_mabn != "")
            {
                aexp += " and a.mabn='" + v_mabn + "'";
            }
            if (v_maql != "")
            {
                aexp += " and a.maql=" + v_maql;
            }
            if (v_idkhoa != "")
            {
                aexp += " and a.idkhoa=" + v_idkhoa;
            }
            if (v_ngayin != "")
            {
                aexp += " and trim(b.ngayin)='" + v_ngayin + "'";
            }
            if (v_done != "")
            {
                aexp += " and a.done=" + v_done;
            }
            aexp = aexp.Trim();
            if (aexp.Length > 0)
            {
                aexp = " " + aexp;
            }

            foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
            {
                if (sql != "")
                {
                    sql += " union all ";
                }
                sql += "select a.rowid, b.mmyy, a.id,a.mabn,a.maql,a.idkhoa,a.ngay,a.makp,a.madoituong,a.mavp,a.soluong,a.dongia,a.done,a.userid,a.ngayud,a.vattu,to_char(a.ngay,'dd/mm/yyyy') ngaynhap from " + r["schemaname"].ToString() + ".v_vpkhoa a, " + r["schemaname"].ToString() + ".v_tmpttrv b where a.rowid=b.row_id and b.loai=2 and to_char(a.ngay,'mmyy')=b.mmyy" + aexp;
            }
            return get_data(sql);
        }
        public DataSet get_v_tamung(string v_mabn, string v_maql, string v_idkhoa, string v_done, string v_hoan)
        {
            string sql = "";
            string aexp = "";
            if (v_mabn == "" && v_maql == "")
            {
                return null;
            }

            if (v_mabn != "")
            {
                if (aexp == "")
                {
                    aexp += "a.mabn='" + v_mabn + "'";
                }
                else
                {
                    aexp += " and a.mabn='" + v_mabn + "'";
                }
            }
            if (v_maql != "")
            {
                if (aexp == "")
                {
                    aexp += "a.maql=" + v_maql;
                }
                else
                {
                    aexp += " and a.maql=" + v_maql;
                }
            }
            if (v_idkhoa != "")
            {
                if (aexp == "")
                {
                    aexp += "a.idkhoa=" + v_idkhoa;
                }
                else
                {
                    aexp += " and a.idkhoa=" + v_idkhoa;
                }
            }
            if (v_done != "")
            {
                if (aexp == "")
                {
                    aexp += "a.done=" + v_done;
                }
                else
                {
                    aexp += " and a.done=" + v_done;
                }
            }
            if (v_hoan != "")
            {
                if (v_hoan == "1")
                {
                    if (aexp == "")
                    {
                        aexp += " and b.id is not null";
                    }
                    else
                    {
                        aexp += " and b.id is not null";
                    }
                }
                else
                {
                    if (aexp == "")
                    {
                        aexp += " and b.id is null";
                    }
                    else
                    {
                        aexp += " and b.id is null";
                    }
                }
            }
            aexp = aexp.Trim();
            if (aexp.Length > 0)
            {
                aexp = " and " + aexp;
            }

            foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
            {
                if (sql != "")
                {
                    sql += " union all ";
                }
                sql += "select a.id,a.mabn,a.maql,a.idkhoa,a.quyenso,a.sobienlai,a.ngay,a.loai,a.makp,a.madoituong,a.sotien,a.userid,a.ngayud,a.done,a.lanin,a.loaibn,a.idttrv,decode(b.id,null,0,1) hoan, to_char(a.ngay,'dd/mm/yyyy') ngaynhap from " + r["schemaname"].ToString() + ".v_tamung a, " + r["schemaname"].ToString() + ".v_hoantra b where a.quyenso=b.quyenso(+) and a.sobienlai=b.sobienlai(+)" + aexp;
            }
            return get_data(sql);
        }
        public DataSet get_v_tamungct(string v_mabn, string v_maql, string v_idkhoa, string v_done, string v_hoan)
        {
            string sql = "";
            string aexp = "";
            if (v_mabn == "" && v_maql == "")
            {
                return null;
            }

            if (v_mabn != "")
            {
                if (aexp == "")
                {
                    aexp += "a.mabn='" + v_mabn + "'";
                }
                else
                {
                    aexp += " and a.mabn='" + v_mabn + "'";
                }
            }
            if (v_maql != "")
            {
                if (aexp == "")
                {
                    aexp += "a.maql=" + v_maql;
                }
                else
                {
                    aexp += " and a.maql=" + v_maql;
                }
            }
            if (v_idkhoa != "")
            {
                if (aexp == "")
                {
                    aexp += "a.idkhoa=" + v_idkhoa;
                }
                else
                {
                    aexp += " and a.idkhoa=" + v_idkhoa;
                }
            }
            if (v_done != "")
            {
                if (aexp == "")
                {
                    aexp += "a.done=" + v_done;
                }
                else
                {
                    aexp += " and a.done=" + v_done;
                }
            }
            if (v_hoan != "")
            {
                if (v_hoan == "1")
                {
                    if (aexp == "")
                    {
                        aexp += " and b.id is not null";
                    }
                    else
                    {
                        aexp += " and b.id is not null";
                    }
                }
                else
                {
                    if (aexp == "")
                    {
                        aexp += " and b.id is null";
                    }
                    else
                    {
                        aexp += " and b.id is null";
                    }
                }
            }
            aexp = aexp.Trim();
            if (aexp.Length > 0)
            {
                aexp = " and " + aexp;
            }

            foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
            {
                if (sql != "")
                {
                    sql += " union all ";
                }
                sql += "select aa.id,aa.loaivp,aa.sotien, decode(b.id,null,0,1) hoan, to_char(a.ngay,'dd/mm/yyyy') ngaynhap from " + s_schemaroot + ".v_tamung a, " + r["schemaname"].ToString() + ".v_tamungct aa, " + r["schemaname"].ToString() + ".v_hoantra b where a.id=aa.id and a.quyenso=b.quyenso(+) and a.sobienlai=b.sobienlai(+)" + aexp;
            }
            return get_data(sql);
        }
        public DataSet get_v_vienphill(string v_mabn, string v_maql, string v_idkhoa, string v_hoan)
        {
            string sql = "";
            string aexp = "";
            if (v_mabn == "" && v_maql == "")
            {
                return null;
            }

            if (v_mabn != "")
            {
                if (aexp == "")
                {
                    aexp += "a.mabn='" + v_mabn + "'";
                }
                else
                {
                    aexp += " and a.mabn='" + v_mabn + "'";
                }
            }
            if (v_maql != "")
            {
                if (aexp == "")
                {
                    aexp += "a.maql=" + v_maql;
                }
                else
                {
                    aexp += " and a.maql=" + v_maql;
                }
            }
            if (v_idkhoa != "")
            {
                if (aexp == "")
                {
                    aexp += "a.idkhoa=" + v_idkhoa;
                }
                else
                {
                    aexp += " and a.idkhoa=" + v_idkhoa;
                }
            }
            if (v_hoan != "")
            {
                if (v_hoan == "1")
                {
                    if (aexp == "")
                    {
                        aexp += " and b.id is not null";
                    }
                    else
                    {
                        aexp += " and b.id is not null";
                    }
                }
                else
                {
                    if (aexp == "")
                    {
                        aexp += " and b.id is null";
                    }
                    else
                    {
                        aexp += " and b.id is null";
                    }
                }
            }
            aexp = aexp.Trim();
            if (aexp.Length > 0)
            {
                aexp = " and " + aexp;
            }

            foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
            {
                if (sql != "")
                {
                    sql += " union all ";
                }
                sql += "select a.id,a.quyenso,a.sobienlai,a.ngay,a.mabn,a.maql,a.idkhoa,a.makp,a.hoten,a.namsinh,a.diachi,a.loai,a.loaibn,a.lanin,a.userid,a.ngayud,decode(b.id,null,0,1) hoan, to_char(a.ngay,'dd/mm/yyyy') ngaynhap from " + r["schemaname"].ToString() + ".v_vienphill a, " + r["schemaname"].ToString() + ".v_hoantra b where a.quyenso=b.quyenso(+) and a.sobienlai=b.sobienlai(+)" + aexp;
            }
            return get_data(sql);
        }
        public DataSet get_v_vienphict(string v_mabn, string v_maql, string v_idkhoa, string v_hoan)
        {
            string sql = "";
            string aexp = "";
            if (v_mabn == "" && v_maql == "")
            {
                return null;
            }

            if (v_mabn != "")
            {
                if (aexp == "")
                {
                    aexp += "a.mabn='" + v_mabn + "'";
                }
                else
                {
                    aexp += " and a.mabn='" + v_mabn + "'";
                }
            }
            if (v_maql != "")
            {
                if (aexp == "")
                {
                    aexp += "a.maql=" + v_maql;
                }
                else
                {
                    aexp += " and a.maql=" + v_maql;
                }
            }
            if (v_idkhoa != "")
            {
                if (aexp == "")
                {
                    aexp += "a.idkhoa=" + v_idkhoa;
                }
                else
                {
                    aexp += " and a.idkhoa=" + v_idkhoa;
                }
            }
            if (v_hoan != "")
            {
                if (v_hoan == "1")
                {
                    if (aexp == "")
                    {
                        aexp += " and b.id is not null";
                    }
                    else
                    {
                        aexp += " and b.id is not null";
                    }
                }
                else
                {
                    if (aexp == "")
                    {
                        aexp += " and b.id is null";
                    }
                    else
                    {
                        aexp += " and b.id is null";
                    }
                }
            }
            aexp = aexp.Trim();
            if (aexp.Length > 0)
            {
                aexp = " and " + aexp;
            }

            foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
            {
                if (sql != "")
                {
                    sql += " union all ";
                }
                sql += "select aa.id,aa.stt,aa.madoituong,aa.mavp,aa.soluong,aa.dongia,aa.mien,aa.thieu,aa.vattu,aa.mabs,aa.makp, decode(b.id,null,0,1) hoan,to_char(a.ngay,'dd/mm/yyyy') ngaynhap from " + r["schemaname"].ToString() + ".v_vienphill a, " + r["schemaname"].ToString() + ".v_vienphict aa, " + r["schemaname"].ToString() + ".v_hoantra b where a.id=aa.id and a.quyenso=b.quyenso(+) and a.sobienlai=b.sobienlai(+)" + aexp;
            }
            return get_data(sql);
        }
        public DataSet get_v_phieuchill(string v_mabn, string v_maql, string v_idkhoa)
        {
            string sql = "";
            string aexp = "";
            if (v_mabn == "" && v_maql == "")
            {
                return null;
            }

            if (v_mabn != "")
            {
                if (aexp == "")
                {
                    aexp += "a.mabn='" + v_mabn + "'";
                }
                else
                {
                    aexp += " and a.mabn='" + v_mabn + "'";
                }
            }
            if (v_maql != "")
            {
                if (aexp == "")
                {
                    aexp += "a.maql=" + v_maql;
                }
                else
                {
                    aexp += " and a.maql=" + v_maql;
                }
            }
            if (v_idkhoa != "")
            {
                if (aexp == "")
                {
                    aexp += "a.idkhoa=" + v_idkhoa;
                }
                else
                {
                    aexp += " and a.idkhoa=" + v_idkhoa;
                }
            }
            aexp = aexp.Trim();
            if (aexp.Length > 0)
            {
                aexp = " and " + aexp;
            }

            foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
            {
                if (sql != "")
                {
                    sql += " union all ";
                }
                sql += "select a.id,a.quyenso,a.sobienlai,a.ngay,a.mabn,a.maql,a.idkhoa,a.makp,a.hoten,a.loai,a.loaibn,a.userid,a.ngayud,to_char(a.ngay,'dd/mm/yyyy') ngaynhap from " + r["schemaname"].ToString() + ".v_phieuchill a, " + r["schemaname"].ToString() + ".v_phieuchict b where a.id=b.id" + aexp;
            }
            return get_data(sql);
        }
        public DataSet get_v_phieuchict(string v_mabn, string v_maql, string v_idkhoa)
        {
            string sql = "";
            string aexp = "";
            if (v_mabn == "" && v_maql == "")
            {
                return null;
            }

            if (v_mabn != "")
            {
                if (aexp == "")
                {
                    aexp += "a.mabn='" + v_mabn + "'";
                }
                else
                {
                    aexp += " and a.mabn='" + v_mabn + "'";
                }
            }
            if (v_maql != "")
            {
                if (aexp == "")
                {
                    aexp += "a.maql=" + v_maql;
                }
                else
                {
                    aexp += " and a.maql=" + v_maql;
                }
            }
            if (v_idkhoa != "")
            {
                if (aexp == "")
                {
                    aexp += "a.idkhoa=" + v_idkhoa;
                }
                else
                {
                    aexp += " and a.idkhoa=" + v_idkhoa;
                }
            }
            aexp = aexp.Trim();
            if (aexp.Length > 0)
            {
                aexp = " and " + aexp;
            }

            foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
            {
                if (sql != "")
                {
                    sql += " union all ";
                }
                sql += "select a.id,a.stt,a.mavp,a.sotien from " + r["schemaname"].ToString() + ".v_phieuchict a, " + r["schemaname"].ToString() + ".v_phieuchill b where a.id=b.id" + aexp;
            }
            return get_data(sql);
        }
        public DataSet get_v_ttrvll(string v_mabn, string v_maql, string v_idkhoa, string v_hoan)
        {
            string sql = "";
            string aexp = "";
            if (v_mabn == "" && v_maql == "")
            {
                return null;
            }

            if (v_mabn != "")
            {
                if (aexp == "")
                {
                    aexp += "aa.mabn='" + v_mabn + "'";
                }
                else
                {
                    aexp += " and aa.mabn='" + v_mabn + "'";
                }
            }
            if (v_maql != "")
            {
                if (aexp == "")
                {
                    aexp += "aa.maql=" + v_maql;
                }
                else
                {
                    aexp += " and aa.maql=" + v_maql;
                }
            }
            if (v_idkhoa != "")
            {
                if (aexp == "")
                {
                    aexp += "aa.idkhoa=" + v_idkhoa;
                }
                else
                {
                    aexp += " and aa.idkhoa=" + v_idkhoa;
                }
            }
            if (v_hoan != "")
            {
                if (v_hoan == "1")
                {
                    if (aexp == "")
                    {
                        aexp += " and b.id is not null";
                    }
                    else
                    {
                        aexp += " and b.id is not null";
                    }
                }
                else
                {
                    if (aexp == "")
                    {
                        aexp += " and b.id is null";
                    }
                    else
                    {
                        aexp += " and b.id is null";
                    }
                }
            }
            aexp = aexp.Trim();
            if (aexp.Length > 0)
            {
                aexp = " and " + aexp;
            }

            foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
            {
                if (sql != "")
                {
                    sql += " union all ";
                }
                sql += "select a.id,a.loaibn,a.loai,a.quyenso,a.sobienlai,a.ngay,a.makp,a.sotien,a.tamung,a.mien,a.bhyt,a.userid,a.ngayud,a.nopthem,a.thieu,a.vattu,a.lanin,a.idtonghop,aa.mabn,aa.maql, decode(b.id,null,0,1) hoan,to_char(a.ngay,'dd/mm/yyyy') ngaynhap from " + r["schemaname"].ToString() + ".v_ttrvll a, " + r["schemaname"].ToString() + ".v_ttrvds aa," + r["schemaname"].ToString() + ".v_hoantra b where a.id=aa.id and a.quyenso=b.quyenso(+) and a.sobienlai=b.sobienlai(+)" + aexp;
            }
            return get_data(sql);
        }
        public DataSet get_v_ttrvct(string v_mabn, string v_maql, string v_idkhoa, string v_hoan)
        {
            string sql = "";
            string aexp = "";
            if (v_mabn == "" && v_maql == "")
            {
                return null;
            }

            if (v_mabn != "")
            {
                if (aexp == "")
                {
                    aexp += "a.mabn='" + v_mabn + "'";
                }
                else
                {
                    aexp += " and a.mabn='" + v_mabn + "'";
                }
            }
            if (v_maql != "")
            {
                if (aexp == "")
                {
                    aexp += "a.maql=" + v_maql;
                }
                else
                {
                    aexp += " and a.maql=" + v_maql;
                }
            }
            if (v_idkhoa != "")
            {
                if (aexp == "")
                {
                    aexp += "a.idkhoa=" + v_idkhoa;
                }
                else
                {
                    aexp += " and a.idkhoa=" + v_idkhoa;
                }
            }
            if (v_hoan != "")
            {
                if (v_hoan == "1")
                {
                    if (aexp == "")
                    {
                        aexp += " and b.id is not null";
                    }
                    else
                    {
                        aexp += " and b.id is not null";
                    }
                }
                else
                {
                    if (aexp == "")
                    {
                        aexp += " and b.id is null";
                    }
                    else
                    {
                        aexp += " and b.id is null";
                    }
                }
            }
            aexp = aexp.Trim();
            if (aexp.Length > 0)
            {
                aexp = " and " + aexp;
            }

            foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
            {
                if (sql != "")
                {
                    sql += " union all ";
                }
                sql += "select aaa.id,aaa.stt,aaa.ngay,aaa.makp,aaa.madoituong,aaa.mavp,aaa.soluong,aaa.dongia,aaa.vat,aaa.vattu,aaa.sotien,decode(b.id,null,0,1) hoan, to_char(aa.ngay,'dd/mm/yyyy') ngaynhap from v_ttrvds a, " + r["schemaname"].ToString() + ".v_ttrvll aa, " + r["schemaname"].ToString() + ".v_ttrvct aaa, " + r["schemaname"].ToString() + ".v_hoantra b where a.id=aa.id and a.id=aaa.id and aa.quyenso=b.quyenso(+) and aa.sobienlai=b.sobienlai(+)" + aexp;
            }
            return get_data(sql);
        }
        public DataSet get_v_mienngtru(string v_mabn, string v_maql, string v_idkhoa, string v_hoan)
        {
            string sql = "";
            string aexp = "";
            if (v_mabn == "" && v_maql == "")
            {
                return null;
            }

            if (v_mabn != "")
            {
                if (aexp == "")
                {
                    aexp += "a.mabn='" + v_mabn + "'";
                }
                else
                {
                    aexp += " and a.mabn='" + v_mabn + "'";
                }
            }
            if (v_maql != "")
            {
                if (aexp == "")
                {
                    aexp += "a.maql=" + v_maql;
                }
                else
                {
                    aexp += " and a.maql=" + v_maql;
                }
            }
            if (v_idkhoa != "")
            {
                if (aexp == "")
                {
                    aexp += "a.idkhoa=" + v_idkhoa;
                }
                else
                {
                    aexp += " and a.idkhoa=" + v_idkhoa;
                }
            }
            if (v_hoan != "")
            {
                if (v_hoan == "1")
                {
                    if (aexp == "")
                    {
                        aexp += " and b.id is not null";
                    }
                    else
                    {
                        aexp += " and b.id is not null";
                    }
                }
                else
                {
                    if (aexp == "")
                    {
                        aexp += " and b.id is null";
                    }
                    else
                    {
                        aexp += " and b.id is null";
                    }
                }
            }
            aexp = aexp.Trim();
            if (aexp.Length > 0)
            {
                aexp = " and " + aexp;
            }

            foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
            {
                if (sql != "")
                {
                    sql += " union all ";
                }
                sql += "select aa.id,aa.sotien,aa.ghichu,aa.maduyet,aa.lydo, decode(b.id,null,0,1) hoan, to_char(a.ngay,'dd/mm/yyyy') ngaynhap from " + r["schemaname"].ToString() + ".v_vienphill a, " + r["schemaname"].ToString() + ".v_mienngtru aa, " + r["schemaname"].ToString() + ".v_hoantra b where a.id=aa.id and a.quyenso=b.quyenso(+) and a.sobienlai=b.sobienlai(+)" + aexp;
            }
            return get_data(sql);
        }
        public DataSet get_v_hoantra(string v_mabn, string v_quyensoid, string v_sobienlai, string v_ngay10, string v_loai, string v_loaibn)
        {
            string sql = "";
            string aexp = "";
            if (v_mabn == "")
            {
                return null;
            }

            if (v_mabn != "")
            {
                if (aexp == "")
                {
                    aexp += "a.mabn='" + v_mabn + "'";
                }
                else
                {
                    aexp += " and a.mabn='" + v_mabn + "'";
                }
            }
            if (v_quyensoid != "")
            {
                if (aexp == "")
                {
                    aexp += "a.quyenso=" + v_quyensoid + "";
                }
                else
                {
                    aexp += " and a.quyenso=" + v_quyensoid + "";
                }
            }
            if (v_sobienlai != "")
            {
                if (aexp == "")
                {
                    aexp += "a.sobienlai=" + v_sobienlai + "";
                }
                else
                {
                    aexp += " and a.sobienlai=" + v_sobienlai + "";
                }
            }
            if (v_ngay10 != "")
            {
                if (aexp == "")
                {
                    aexp += "to_char(a.ngay,'dd/mm/yyyy')='" + v_ngay10 + "'";
                }
                else
                {
                    aexp += " and to_char(a.ngay,'dd/mm/yyyy')='" + v_ngay10 + "'";
                }
            }
            if (v_loai != "")
            {
                if (aexp == "")
                {
                    aexp += "a.loai=" + v_loai + "";
                }
                else
                {
                    aexp += " and a.loai=" + v_loai + "";
                }
            }
            if (v_loaibn != "")
            {
                if (aexp == "")
                {
                    aexp += "a.loaibn=" + v_loaibn + "";
                }
                else
                {
                    aexp += " and a.loaibn=" + v_loaibn + "";
                }
            }
            aexp = aexp.Trim();
            if (aexp.Length > 0)
            {
                aexp = " and " + aexp;
            }

            foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
            {
                if (sql != "")
                {
                    sql += " union all ";
                }
                sql += "select a.id,a.quyenso,a.sobienlai,a.ngay,a.mabn,a.hoten,a.sotien,a.ghichu,a.userid,a.ngayud,a.loai,a.loaibn,to_char(a.ngay,'dd/mm/yyyy') ngaynhap from " + r["schemaname"].ToString() + ".v_hoantra a where 1=1" + aexp;
            }
            return get_data(sql);
        }
        public DataSet get_d_tienthuoc(string v_mabn, string v_maql, string v_idkhoa, string v_done)
        {
            string sql = "";
            string aexp = "";
            if (v_mabn == "" && v_maql == "")
            {
                return null;
            }

            if (v_mabn != "")
            {
                if (aexp == "")
                {
                    aexp += "a.mabn='" + v_mabn + "'";
                }
                else
                {
                    aexp += " and a.mabn='" + v_mabn + "'";
                }
            }
            if (v_maql != "")
            {
                if (aexp == "")
                {
                    aexp += "a.maql=" + v_maql;
                }
                else
                {
                    aexp += " and a.maql=" + v_maql;
                }
            }
            if (v_idkhoa != "")
            {
                if (aexp == "")
                {
                    aexp += "a.idkhoa=" + v_idkhoa;
                }
                else
                {
                    aexp += " and a.idkhoa=" + v_idkhoa;
                }
            }
            if (v_done != "")
            {
                if (aexp == "")
                {
                    aexp += "a.done=" + v_done;
                }
                else
                {
                    aexp += " and a.done=" + v_done;
                }
            }
            aexp = aexp.Trim();
            if (aexp.Length > 0)
            {
                aexp = " where " + aexp;
            }

            foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
            {
                if (sql != "")
                {
                    sql += " union all ";
                }
                sql += "select a.mabn,a.maql,a.idkhoa,a.ngay,a.makp,a.madoituong,a.mabd,a.soluong,a.sotien,a.giaban,a.giamua,a.done,to_char(a.ngay,'dd/mm/yyyy') ngaynhap from " + r["schemaname"].ToString() + ".d_tienthuoc a" + aexp;
            }
            return get_data(sql);
        }
        public DataSet get_d_tienthuoc_in(string v_mabn, string v_maql, string v_idkhoa, string v_done, string v_ngayin)
        {
            string sql = "";
            string aexp = "";
            if (v_mabn == "" && v_maql == "")
            {
                return null;
            }

            if (v_mabn != "")
            {
                aexp += " and a.mabn='" + v_mabn + "'";
            }
            if (v_maql != "")
            {
                aexp += " and a.maql=" + v_maql;
            }
            if (v_idkhoa != "")
            {
                aexp += " and a.idkhoa=" + v_idkhoa;
            }
            if (v_ngayin != "")
            {
                aexp += " and trim(b.ngayin)='" + v_ngayin + "'";
            }
            if (v_done != "")
            {
                aexp += " and a.done=" + v_done;
            }
            aexp = aexp.Trim();
            if (aexp.Length > 0)
            {
                aexp = " " + aexp;
            }

            foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
            {
                if (sql != "")
                {
                    sql += " union all ";
                }
                sql += "select a.rowid,b.mmyy,a.mabn,a.maql,a.idkhoa,a.ngay,a.makp,a.madoituong,a.mabd,a.soluong,a.sotien,a.giaban,a.giamua,a.done,to_char(a.ngay,'dd/mm/yyyy') ngaynhap from " + r["schemaname"].ToString() + ".d_tienthuoc a, " + r["schemaname"].ToString() + ".v_tmpttrv b where a.rowid=b.row_id and b.loai=1 and to_char(a.ngay,'mmyy')=b.mmyy" + aexp;
            }
            return get_data(sql);
        }
        public DataSet get_d_tienthuoc(DateTime v_tu, DateTime v_den, string v_mabn, string v_maql, string v_idkhoa, string v_done)
        {
            string sql = "";
            string aexp = "";
            if (v_mabn == "" && v_maql == "")
            {
                return null;
            }

            if (v_mabn != "")
            {
                if (aexp == "")
                {
                    aexp += "a.mabn='" + v_mabn + "'";
                }
                else
                {
                    aexp += " and a.mabn='" + v_mabn + "'";
                }
            }
            if (v_maql != "")
            {
                if (aexp == "")
                {
                    aexp += "a.maql=" + v_maql;
                }
                else
                {
                    aexp += " and a.maql=" + v_maql;
                }
            }
            if (v_idkhoa != "")
            {
                if (aexp == "")
                {
                    aexp += "a.idkhoa=" + v_idkhoa;
                }
                else
                {
                    aexp += " and a.idkhoa=" + v_idkhoa;
                }
            }
            if (v_done != "")
            {
                if (aexp == "")
                {
                    aexp += "a.done=" + v_done;
                }
                else
                {
                    aexp += " and a.done=" + v_done;
                }
            }
            aexp = aexp.Trim();
            if (aexp.Length > 0)
            {
                aexp = " where " + aexp;
            }

            foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
            {
                if (sql != "")
                {
                    sql += " union all ";
                }
                sql += "select a.mabn,a.maql,a.idkhoa,a.ngay,a.makp,a.madoituong,a.mabd,a.soluong,a.sotien,a.giaban,a.giamua,a.done,to_char(a.ngay,'dd/mm/yyyy') ngaynhap from " + r["schemaname"].ToString() + ".d_tienthuoc a" + aexp;
            }
            return get_data(sql);
        }
        public DataSet get_d_tienthuoc_in(DateTime v_tu, DateTime v_den, string v_mabn, string v_maql, string v_idkhoa, string v_done, string v_ngayin)
        {
            string sql = "";
            string aexp = "";
            if (v_mabn == "" && v_maql == "")
            {
                return null;
            }

            if (v_mabn != "")
            {
                aexp += " and a.mabn='" + v_mabn + "'";
            }
            if (v_maql != "")
            {
                aexp += " and a.maql=" + v_maql;
            }
            if (v_idkhoa != "")
            {
                aexp += " and a.idkhoa=" + v_idkhoa;
            }
            if (v_ngayin != "")
            {
                aexp += " and trim(b.ngayin)='" + v_ngayin + "'";
            }
            if (v_done != "")
            {
                aexp += " and a.done=" + v_done;
            }
            aexp = aexp.Trim();
            if (aexp.Length > 0)
            {
                aexp = " " + aexp;
            }

            foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
            {
                if (sql != "")
                {
                    sql += " union all ";
                }
                sql += "select a.rowid,b.mmyy,a.mabn,a.maql,a.idkhoa,a.ngay,a.makp,a.madoituong,a.mabd,a.soluong,a.sotien,a.giaban,a.giamua,a.done,to_char(a.ngay,'dd/mm/yyyy') ngaynhap from " + r["schemaname"].ToString() + ".d_tienthuoc a, " + r["schemaname"].ToString() + ".v_tmpttrv b where a.rowid=b.row_id and b.loai=1 and to_char(a.ngay,'mmyy')=b.mmyy" + aexp;
            }
            return get_data(sql);
        }
        public DataSet get_bhytkb(string v_id, string v_mabn, string v_maql, string v_ngay, string v_quyenso, string v_sobienlai, string v_done)
        {
            string sql = "";
            string aexp = "";
            if (v_mabn == "" && v_maql == "" && v_id == "")
            {
                return null;
            }
            if (v_id != "")
            {
                if (aexp == "")
                {
                    aexp += "a.id=" + v_id;
                }
                else
                {
                    aexp += " and a.id=" + v_id;
                }
            }
            if (v_mabn != "")
            {
                if (aexp == "")
                {
                    aexp += "a.mabn='" + v_mabn + "'";
                }
                else
                {
                    aexp += " and a.mabn='" + v_mabn + "'";
                }
            }
            if (v_maql != "")
            {
                if (aexp == "")
                {
                    aexp += "a.maql=" + v_maql;
                }
                else
                {
                    aexp += " and a.maql=" + v_maql;
                }
            }
            if (v_ngay != "")
            {
                if (aexp == "")
                {
                    aexp += "to_char(a.ngay,'dd/mm/yyyy')='" + v_ngay + "'";
                }
                else
                {
                    aexp += " and to_char(a.ngay,'dd/mm/yyyy')='" + v_ngay + "'";
                }
            }
            if (v_quyenso != "")
            {
                if (aexp == "")
                {
                    aexp += "a.quyenso=" + v_quyenso;
                }
                else
                {
                    aexp += " and a.quyenso=" + v_quyenso;
                }
            }
            if (v_sobienlai != "")
            {
                if (aexp == "")
                {
                    aexp += "a.sobienlai=" + v_sobienlai;
                }
                else
                {
                    aexp += " and a.done=" + v_sobienlai;
                }
            }
            if (v_done != "")
            {
                if (aexp == "")
                {
                    aexp += "a.done=" + v_done;
                }
                else
                {
                    aexp += " and a.done=" + v_done;
                }
            }
            aexp = aexp.Trim();
            if (aexp.Length > 0)
            {
                aexp = " where " + aexp;
            }

            foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
            {
                if (sql != "")
                {
                    sql += " union all ";
                }
                sql += "select a.id,a.nhom,a.quyenso,a.sobienlai,a.ngay,a.mabn,a.maql,a.makp,a.chandoan,a.maicd,a.mabs,a.sothe,a.maphu,a.mabv,a.congkham,a.thuoc,a.cls,a.bntra,a.bhyttra,a.mmyy,a.userid,a.ngayud,a.done,a.sotoa from " + r["schemaname"].ToString() + ".bhytkb a" + aexp;
            }
            return get_data(sql);
        }
        public DataSet get_bhytthuoc(string v_id, string v_mabn, string v_maql, string v_ngay, string v_quyenso, string v_sobienlai, string v_done)
        {
            string sql = "";
            string aexp = "";
            if (v_mabn == "" && v_maql == "" && v_id == "")
            {
                return null;
            }

            if (v_id != "")
            {
                if (aexp == "")
                {
                    aexp += "a.id=" + v_id;
                }
                else
                {
                    aexp += " and a.id=" + v_id;
                }
            }
            if (v_mabn != "")
            {
                if (aexp == "")
                {
                    aexp += "a.mabn='" + v_mabn + "'";
                }
                else
                {
                    aexp += " and a.mabn='" + v_mabn + "'";
                }
            }
            if (v_maql != "")
            {
                if (aexp == "")
                {
                    aexp += "a.maql=" + v_maql;
                }
                else
                {
                    aexp += " and a.maql=" + v_maql;
                }
            }
            if (v_ngay != "")
            {
                if (aexp == "")
                {
                    aexp += "to_char(a.ngay,'dd/mm/yyyy')='" + v_ngay + "'";
                }
                else
                {
                    aexp += " and to_char(a.ngay,'dd/mm/yyyy')='" + v_ngay + "'";
                }
            }
            if (v_quyenso != "")
            {
                if (aexp == "")
                {
                    aexp += "a.quyenso=" + v_quyenso;
                }
                else
                {
                    aexp += " and a.quyenso=" + v_quyenso;
                }
            }
            if (v_sobienlai != "")
            {
                if (aexp == "")
                {
                    aexp += "a.sobienlai=" + v_sobienlai;
                }
                else
                {
                    aexp += " and a.done=" + v_sobienlai;
                }
            }
            if (v_done != "")
            {
                if (aexp == "")
                {
                    aexp += "a.done=" + v_done;
                }
                else
                {
                    aexp += " and a.done=" + v_done;
                }
            }
            aexp = aexp.Trim();
            if (aexp.Length > 0)
            {
                aexp = " and " + aexp;
            }

            foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
            {
                if (sql != "")
                {
                    sql += " union all ";
                }
                sql += "select b.id,b.stt,b.sttt,b.makho,b.manguon,b.nhomcc,b.mabd,b.handung,b.losx,b.soluong,b.sotien,b.giaban,b.cachdung,b.giamua, a.makp from " + r["schemaname"].ToString() + ".bhytkb a, " + r["schemaname"].ToString() + ".bhytthuoc b where a.id=b.id" + aexp;
            }
            return get_data(sql);
        }
        public DataSet get_bhytcls(string v_id, string v_mabn, string v_maql, string v_ngay, string v_quyenso, string v_sobienlai, string v_done)
        {
            string sql = "";
            string aexp = "";
            if (v_mabn == "" && v_maql == "" && v_id == "")
            {
                return null;
            }

            if (v_id != "")
            {
                if (aexp == "")
                {
                    aexp += "a.id=" + v_id;
                }
                else
                {
                    aexp += " and a.id=" + v_id;
                }
            }

            if (v_mabn != "")
            {
                if (aexp == "")
                {
                    aexp += "a.mabn='" + v_mabn + "'";
                }
                else
                {
                    aexp += " and a.mabn='" + v_mabn + "'";
                }
            }
            if (v_maql != "")
            {
                if (aexp == "")
                {
                    aexp += "a.maql=" + v_maql;
                }
                else
                {
                    aexp += " and a.maql=" + v_maql;
                }
            }
            if (v_ngay != "")
            {
                if (aexp == "")
                {
                    aexp += "to_char(a.ngay,'dd/mm/yyyy')='" + v_ngay + "'";
                }
                else
                {
                    aexp += " and to_char(a.ngay,'dd/mm/yyyy')='" + v_ngay + "'";
                }
            }
            if (v_quyenso != "")
            {
                if (aexp == "")
                {
                    aexp += "a.quyenso=" + v_quyenso;
                }
                else
                {
                    aexp += " and a.quyenso=" + v_quyenso;
                }
            }
            if (v_sobienlai != "")
            {
                if (aexp == "")
                {
                    aexp += "a.sobienlai=" + v_sobienlai;
                }
                else
                {
                    aexp += " and a.done=" + v_sobienlai;
                }
            }
            if (v_done != "")
            {
                if (aexp == "")
                {
                    aexp += "a.done=" + v_done;
                }
                else
                {
                    aexp += " and a.done=" + v_done;
                }
            }
            aexp = aexp.Trim();
            if (aexp.Length > 0)
            {
                aexp = " and " + aexp;
            }

            foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
            {
                if (sql != "")
                {
                    sql += " union all ";
                }
                sql += "select b.id,b.stt,b.mavp,b.soluong,b.dongia,b.idchidinh, a.makp from " + r["schemaname"].ToString() + ".bhytkb a, " + r["schemane"].ToString() + ".bhytcls b where a.id=b.id" + aexp;
            }
            return get_data(sql);
        }
        public DataSet get_d_ngtrull(string v_id, string v_mabn, string v_maql)
        {
            string sql = "";
            string aexp = "";
            if (v_mabn == "" && v_maql == "" && v_id == "")
            {
                return null;
            }

            if (v_id != "")
            {
                if (aexp == "")
                {
                    aexp += "a.id=" + v_id;
                }
                else
                {
                    aexp += " and a.id=" + v_id;
                }
            }

            if (v_mabn != "")
            {
                if (aexp == "")
                {
                    aexp += "a.mabn='" + v_mabn + "'";
                }
                else
                {
                    aexp += " and a.mabn='" + v_mabn + "'";
                }
            }
            if (v_maql != "")
            {
                if (aexp == "")
                {
                    aexp += "a.maql=" + v_maql;
                }
                else
                {
                    aexp += " and a.maql=" + v_maql;
                }
            }
            aexp = aexp.Trim();
            if (aexp.Length > 0)
            {
                aexp = " and " + aexp;
            }

            foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
            {
                if (sql != "")
                {
                    sql += " union all ";
                }
                sql += "select a.id,a.nhom,a.mabn,a.hoten,a.namsinh,a.ngay,a.mabs,a.makp,a.loai,a.mmyy,a.done,a.userid,a.ngayud,a.lanin,a.sotoa,a.maql, to_char(a.ngay,'dd/mm/yyyy') ngaynhap from " + r["schemaname"].ToString() + ".d_ngtrull a, " + r["schemaname"].ToString() + ".d_ngtruct b where a.id=b.id" + aexp;
            }
            return get_data(sql);
        }
        public DataSet get_d_ngtruct(string v_id, string v_mabn, string v_maql)
        {
            string sql = "";
            string aexp = "";
            if (v_mabn == "" && v_maql == "" && v_id == "")
            {
                return null;
            }

            if (v_id != "")
            {
                if (aexp == "")
                {
                    aexp += "a.id=" + v_id;
                }
                else
                {
                    aexp += " and a.id=" + v_id;
                }
            }

            if (v_mabn != "")
            {
                if (aexp == "")
                {
                    aexp += "a.mabn='" + v_mabn + "'";
                }
                else
                {
                    aexp += " and a.mabn='" + v_mabn + "'";
                }
            }
            if (v_maql != "")
            {
                if (aexp == "")
                {
                    aexp += "a.maql=" + v_maql;
                }
                else
                {
                    aexp += " and a.maql=" + v_maql;
                }
            }
            aexp = aexp.Trim();
            if (aexp.Length > 0)
            {
                aexp = " and " + aexp;
            }

            foreach (DataRow r in get_shemaname_mmyy().Tables[0].Rows)
            {
                if (sql != "")
                {
                    sql += " union all ";
                }
                sql += "select b.id,b.stt,b.sttt,b.makho,b.manguon,b.nhomcc,b.mabd,b.handung,b.losx,b.soluong,b.sotien,b.giaban,b.giamua, to_char(a.ngay,'dd/mm/yyyy') ngaynhap from " + r["schemaname"].ToString() + ".d_ngtrull a, " + r["schemaname"].ToString() + ".d_ngtruct b where a.id=b.id" + aexp;
            }
            return get_data(sql);
        }
        public DataSet get_v_danhsachchidinh(string v_tn, string v_dn, string v_paid, string v_done, string v_madoituong)
        {
            string sql = "";
            string aexp = "", ayy = "";
            if (v_tn == "" || v_dn == "")
            {
                return null;
            }
            ayy = v_tn.Substring(8, 2);

            if (v_tn != "")
            {
                if (aexp == "")
                {
                    aexp = "to_date(to_char(a.ngay,'dd/mm/yyyy hh24:mi'),'dd/mm/yyyy hh24:mi')>=to_date('" + v_tn + "','dd/mm/yyyy hh24:mi')";
                }
                else
                {
                    aexp += " and to_date(to_char(a.ngay,'dd/mm/yyyy hh24:mi'),'dd/mm/yyyy hh24:mi')>=to_date('" + v_tn + "','dd/mm/yyyy hh24:mi')";
                }
            }
            if (v_dn != "")
            {
                if (aexp == "")
                {
                    aexp = "to_date(to_char(a.ngay,'dd/mm/yyyy hh24:mi'),'dd/mm/yyyy hh24:mi')<=to_date('" + v_dn + "','dd/mm/yyyy hh24:mi')";
                }
                else
                {
                    aexp += " and to_date(to_char(a.ngay,'dd/mm/yyyy hh24:mi'),'dd/mm/yyyy hh24:mi')<=to_date('" + v_dn + "','dd/mm/yyyy hh24:mi')";
                }
            }
            if (v_paid != "")
            {
                if (aexp == "")
                {
                    aexp = "a.paid=" + v_paid;
                }
                else
                {
                    aexp += " and a.paid=" + v_paid;
                }
            }
            if (v_done != "")
            {
                if (aexp == "")
                {
                    aexp = "a.done=" + v_done;
                }
                else
                {
                    aexp += " and a.done=" + v_done;
                }
            }
            if (v_madoituong != "")
            {
                if (aexp == "")
                {
                    aexp = "a.madoituong in(" + v_madoituong + ")";
                }
                else
                {
                    aexp += " and a.madoituong in(" + v_madoituong + ")";
                }
            }
            aexp = aexp.Trim();
            if (aexp.Length > 0)
            {
                aexp = " and " + aexp;
            }

            sql = "select '0' chon, b.mabn, b.hoten, nvl(to_char(b.ngaysinh,'dd/mm/yyyy'),b.namsinh) namsinh, c.ten  gioitinh, d.sothe, to_char(d.denngay,'dd/mm/yyyy') denngay, trim(trim(b.sonha)||' '||trim(b.thon)) diachi, to_char(a.ngay,'dd/mm/yyyy hh24:mi') ngay, a.id, a.maql, a.mavp, e.ma, e.ten, e.dvt, a.madoituong, f.doituong, nvl(a.soluong,0) soluong, nvl(a.dongia,0) dongia, nvl(a.vattu,0) vattu, (a.soluong*a.dongia) sotien, 0 mien, 0 bhyt, 0 thucthu, 0 lydo, 0 maduyet from " + s_schema_mmyy(ayy) + ".v_chidinh a, btdbn b, dmphai c, bhyt d, v_giavp e, doituong f where a.mabn=b.mabn and b.phai=c.ma(+) and a.maql=d.maql(+) and a.mavp=e.id and a.madoituong=f.madoituong and nvl(a.soluong,0)>0 and nvl(a.dongia,0)>0 " + aexp;
            return get_data(sql);
        }
        public bool dahoantra(string v_mabn, string v_mavaovien, string v_maql, string v_quyenso, string v_sobienlai, string v_loai, string v_loaibn)
        {
            try
            {
                string sql = "";
                string aexp = "";
                aexp = "a.mabn='" + v_mabn + "' and a.mavaovien=" + v_mavaovien + " and a.maql=" + v_maql + " and a.quyenso=" + v_quyenso + " and a.sobienlai=" + v_sobienlai + " and a.loai=" + v_loai;// +" and a.loaibn=" + v_loaibn + "";
                DataSet adss = get_shemaname_mmyy();
                DataSet adst = null;
                foreach (DataRow r in adss.Tables[0].Rows)
                {
                    adst = null;
                    sql = "select a.id from " + r["schemaname"].ToString() + ".v_hoantra a where " + aexp + " limit 1";
                    adst = get_data(sql);
                    if (adst != null)
                    {
                        if (adst.Tables[0].Rows.Count > 0)
                        {
                            return true;
                        }
                    }
                }
                return false;
            }
            catch
            {
                return false;
            }
        }
        #endregion

        #region BARCODE
        //barcode
        string mbc_Msg = "";
        int mbc_I, mbc_StrLen, mbc_Sum, mbc_CurrSet, mbc_CurrChar, mbc_NextChar, mbc_Weight;
        //
        private void GeneralEncode(string mbc_Src)
        {

            int mbc_tmp = 0;
            bool mbc_CurrDone;
            mbc_I = 1;
            while (mbc_I <= mbc_StrLen)
            {
                mbc_CurrChar = Microsoft.VisualBasic.Strings.Asc(Microsoft.VisualBasic.Strings.Mid(mbc_Src, mbc_I, 1));
                mbc_CurrDone = false;
                if ((mbc_I + 1) <= mbc_StrLen)
                {
                    mbc_NextChar = Microsoft.VisualBasic.Strings.Asc(Microsoft.VisualBasic.Strings.Mid(mbc_Src, mbc_I + 1, 1));
                    if (mbc_CurrChar >= Microsoft.VisualBasic.Strings.Asc("0") &&
                        mbc_CurrChar <= Microsoft.VisualBasic.Strings.Asc("9") &&
                        mbc_NextChar >= Microsoft.VisualBasic.Strings.Asc("0") &&
                        mbc_NextChar <= Microsoft.VisualBasic.Strings.Asc("9"))
                    {
                        mbc_tmp = (mbc_CurrChar - Microsoft.VisualBasic.Strings.Asc("0")) * 10 + (mbc_NextChar - Microsoft.VisualBasic.Strings.Asc("0"));
                        if (mbc_CurrSet != 3)
                        {
                            mbc_Msg += Microsoft.VisualBasic.Strings.Chr(99 + 98);
                            mbc_Sum = mbc_Sum + mbc_Weight * 99;
                            mbc_Weight = mbc_Weight + 1;
                            mbc_CurrSet = 3;
                        }
                        if (mbc_tmp == 0)
                        {
                            mbc_Msg = mbc_Msg + Microsoft.VisualBasic.Strings.Chr(192);
                        }
                        else
                        {
                            if (mbc_tmp > 0 && mbc_tmp < 95)
                            {
                                mbc_Msg = mbc_Msg + Microsoft.VisualBasic.Strings.Chr(mbc_tmp + 32);
                            }
                            else
                            {
                                mbc_Msg = mbc_Msg + Microsoft.VisualBasic.Strings.Chr(mbc_tmp + 98);
                            }
                        }
                        mbc_Sum = mbc_Sum + mbc_Weight * mbc_tmp;
                        mbc_I = mbc_I + 2;
                        mbc_CurrDone = true;
                    }
                }
                if (!mbc_CurrDone)
                {
                    if (mbc_CurrChar >= 0 && mbc_CurrChar <= 31)
                    {
                        if (mbc_CurrSet != 1)
                        {
                            mbc_Msg = mbc_Msg + Microsoft.VisualBasic.Strings.Chr(101 + 98);
                            mbc_Sum = mbc_Sum + mbc_Weight * 101;
                            mbc_Weight = mbc_Weight + 1;
                            mbc_CurrSet = 1;
                        }
                        if (mbc_CurrChar == 31)
                        {
                            mbc_Msg = mbc_Msg + Microsoft.VisualBasic.Strings.Chr(193);
                            mbc_Sum = mbc_Sum + mbc_Weight * 95;
                        }
                        else
                        {
                            mbc_Msg = mbc_Msg + Microsoft.VisualBasic.Strings.Chr(mbc_CurrChar + 96);
                            mbc_Sum = mbc_Sum + mbc_Weight * (mbc_CurrChar + 64);
                        }
                    }
                    else
                    {
                        if (mbc_CurrSet != 2)
                        {
                            mbc_Msg = mbc_Msg + Microsoft.VisualBasic.Strings.Chr(100 + 98);
                            mbc_Sum = mbc_Sum + mbc_Weight * 100;
                            mbc_Weight = mbc_Weight + 1;
                            mbc_CurrSet = 2;
                        }
                        if (mbc_CurrChar == 32)
                        {
                            mbc_Msg = mbc_Msg + Microsoft.VisualBasic.Strings.Chr(192);
                        }
                        else
                        {
                            if (mbc_CurrChar == 127)
                            {
                                mbc_Msg = mbc_Msg + Microsoft.VisualBasic.Strings.Chr(193);
                                mbc_Sum = mbc_Sum + mbc_Weight * 95;
                            }
                            else
                            {
                                if (mbc_CurrChar < 127 && mbc_CurrChar > 32)
                                {
                                    mbc_Msg = mbc_Msg + Microsoft.VisualBasic.Strings.Chr(mbc_CurrChar);
                                    mbc_Sum = mbc_Sum + mbc_Weight * (mbc_CurrChar - 32);
                                }
                            }
                            mbc_I = mbc_I + 1;
                        }

                    }
                }
                mbc_Weight = mbc_Weight + 1;
            }
            mbc_Sum = mbc_Sum % 103;
            if (mbc_Sum == 0)
            {
                mbc_Msg = mbc_Msg + Microsoft.VisualBasic.Strings.Chr(192);
            }
            else
            {
                if (mbc_Sum <= 94)
                {
                    mbc_Msg = mbc_Msg + Microsoft.VisualBasic.Strings.Chr(mbc_Sum + 32);
                }
                else
                {
                    mbc_Msg = mbc_Msg + Microsoft.VisualBasic.Strings.Chr(mbc_Sum + 98);
                }
            }
            mbc_Msg = mbc_Msg + Microsoft.VisualBasic.Strings.Chr(204);
            //e
        }
        public string Code128Auto(string mbc_Src)
        {
            mbc_Msg = "";
            string mbc_gttv = "";
            mbc_StrLen = Microsoft.VisualBasic.Strings.Len(mbc_Src);
            mbc_Sum = 104;
            mbc_CurrSet = 2;
            mbc_Msg += "" + Microsoft.VisualBasic.Strings.Chr(202);
            mbc_CurrChar = Microsoft.VisualBasic.Strings.Asc(Microsoft.VisualBasic.Strings.Mid(mbc_Src, 1, 1));
            if (mbc_CurrChar <= 31 && mbc_CurrChar >= 0)
            {
                mbc_CurrSet = 1;
                //Message = ""  Chr(201);
                mbc_Msg += "" + Microsoft.VisualBasic.Strings.Chr(201);
                mbc_Sum = 103;
            }
            mbc_Weight = 1;
            GeneralEncode(mbc_Src);
            mbc_gttv = mbc_Msg;
            return mbc_gttv;
        }
        #endregion

        #region EVEN TABLE

        private int tableid()
        {
            ds_event = get_data("select max(id) as id from medibv.dmtables");
            if (ds_event.Tables[0].Rows[0]["id"].ToString() == "") return 1;
            else return int.Parse(ds_event.Tables[0].Rows[0]["id"].ToString()) + 1;
        }

        public int tableid(string mmyy, string tables)
        {
            int ret = 1;
            try
            {
                DataSet ds_event1 = new DataSet();
                ds_event = get_data("select * from medibv.dmtables where tables='" + tables + "'");
                if (ds_event.Tables[0].Rows.Count > 0) ret = int.Parse(ds_event.Tables[0].Rows[0]["id"].ToString());
                else
                {
                    ret = tableid();
                    string fie = "";

                    ds_event1 = get_data("select * from medibv" + mmyy + "." + tables + " limit 1 ");

                    for (int i = 0; i < ds_event1.Tables[0].Columns.Count; i++)
                    {
                        fie += ds_event1.Tables[0].Columns[i].ColumnName.ToString().Trim() + "^";
                    }
                    execute_data("insert into medibv.dmtables(id,tables,fields) values (" + ret + ",'" + tables + "','" + fie.Substring(0, fie.Length - 1) + "')");
                }
            }
            catch //(Exception ex)
            {
                // MessageBox.Show(ex.ToString());
            }
            return ret;
        }

        public string fields(string table, string dk)
        {
            string ret = "";
            DataTable dt = get_data("select * from " + table + " where " + dk).Tables[0];
            if (dt.Rows.Count > 0) for (int i = 0; i < dt.Columns.Count; i++) ret += dt.Rows[0][i].ToString().Trim() + "^";
            return (ret != "") ? ret.Substring(0, ret.Length - 1) : ret;
        }
        public bool upd_eve_tables(string m_ngay, int m_tableid, int m_userid, string s_command)
        {
            string ngay = Ngaygio_hienhanh.Substring(0, 10);
            int icomputerid = get_dmcomputer(), m_ins = 0, m_upd = 0, m_del = 0;
            switch (s_command)
            {
                case "upd": m_upd = 1; break;
                case "del": m_del = 1; break;
                default: m_ins = 1; break;
            }
            string schema = user + m_ngay + ".upd_eve_tables";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(schema, con);
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.Add("m_tableid", NpgsqlDbType.Numeric).Value = m_tableid;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 10).Value = ngay;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_computerid", NpgsqlDbType.Numeric).Value = icomputerid;
                cmd.Parameters.Add("m_ins", NpgsqlDbType.Numeric).Value = m_ins;
                cmd.Parameters.Add("m_upd", NpgsqlDbType.Numeric).Value = m_upd;
                cmd.Parameters.Add("m_del", NpgsqlDbType.Numeric).Value = m_del;
                cmd.ExecuteNonQuery();
            }
            catch (NpgsqlException ex)
            {
                upd_v_error(m_ngay, ex.Message, m_computername, "eve_tables");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_eve_upd_del(string m_ngay, int m_tableid, int m_userid, string m_cmd, string m_noidung)
        {
            int icomputerid = get_dmcomputer();
            string schema1 = user + m_ngay + ".upd_eve_upd_del";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(schema1, con);
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.Add("m_tableid", NpgsqlDbType.Numeric).Value = m_tableid;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_computerid", NpgsqlDbType.Numeric).Value = icomputerid;
                cmd.Parameters.Add("cmd", NpgsqlDbType.Varchar, 3).Value = m_cmd;
                cmd.Parameters.Add("m_noidung", NpgsqlDbType.Text).Value = m_noidung;
                cmd.ExecuteNonQuery();
            }
            catch (NpgsqlException ex)
            {
                upd_v_error(m_ngay, ex.Message, m_computername, "eve_upd_del");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_eve_tables(int m_tableid, int m_userid, string m_cmd)
        {
            string ngay = Ngaygio_hienhanh.Substring(0, 10);
            int icomputerid = get_dmcomputer(), m_ins = 0, m_upd = 0, m_del = 0;
            switch (m_cmd)
            {
                case "upd": m_upd = 1; break;
                case "del": m_del = 1; break;
                default: m_ins = 1; break;
            }
            string schema = user + ".upd_eve_tables";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(schema, con);
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.Add("m_tableid", NpgsqlDbType.Numeric).Value = m_tableid;
                cmd.Parameters.Add("m_ngay", NpgsqlDbType.Varchar, 10).Value = ngay;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_computerid", NpgsqlDbType.Numeric).Value = icomputerid;
                cmd.Parameters.Add("m_ins", NpgsqlDbType.Numeric).Value = m_ins;
                cmd.Parameters.Add("m_upd", NpgsqlDbType.Numeric).Value = m_upd;
                cmd.Parameters.Add("m_del", NpgsqlDbType.Numeric).Value = m_del;
                cmd.ExecuteNonQuery();
            }
            catch (NpgsqlException ex)
            {
                upd_v_error(ex.Message, m_computername, "eve_tables");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }

        public bool upd_eve_upd_del(int m_tableid, int m_userid, string m_cmd, string m_noidung)
        {
            int icomputerid = get_dmcomputer();
            string schema = user + ".upd_eve_upd_del";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(schema, con);
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.Add("m_tableid", NpgsqlDbType.Numeric).Value = m_tableid;
                cmd.Parameters.Add("m_userid", NpgsqlDbType.Numeric).Value = m_userid;
                cmd.Parameters.Add("m_computerid", NpgsqlDbType.Numeric).Value = icomputerid;
                cmd.Parameters.Add("cmd", NpgsqlDbType.Varchar, 3).Value = m_cmd;
                cmd.Parameters.Add("m_noidung", NpgsqlDbType.Text).Value = m_noidung;
                cmd.ExecuteNonQuery();
            }
            catch (NpgsqlException ex)
            {
                upd_v_error(ex.Message, m_computername, "eve_upd_del");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close();
            }
            return true;
        }


        #endregion

        #region LOAD DATA TO CONTROL
        public void f_Load_Tree(TreeView v_tree, DataSet v_ds)
        {
            try
            {
                TreeNode anode;
                v_tree.Nodes.Clear();
                v_tree.Sorted = false;
                for (int i = 0; i < v_ds.Tables[0].Rows.Count; i++)
                {
                    anode = new TreeNode(v_ds.Tables[0].Rows[i]["ten"].ToString());
                    anode.Tag = v_ds.Tables[0].Rows[i]["ma"].ToString();
                    v_tree.Nodes.Add(anode);
                }
            }
            catch
            {
            }
        }
        public void f_Set_CheckID(TreeView v_tree, bool v_b)
        {
            try
            {
                for (int i = 0; i < v_tree.Nodes.Count; i++)
                {
                    v_tree.Nodes[i].Checked = v_b;
                }
            }
            catch
            {
            }
        }
        public string f_Get_CheckID(TreeView v_tree)
        {
            try
            {
                string r = "";
                for (int i = 0; i < v_tree.Nodes.Count; i++)
                {
                    if (v_tree.Nodes[i].Checked) r = r.Trim().Trim(',') + "," + v_tree.Nodes[i].Tag.ToString();
                }
                r = r.Trim().Trim(',');
                return r;
            }
            catch
            {
                return "";
            }
        }
        public void f_Load_Tree(TreeView v_tree, DataSet v_ds, bool v_expand)
        {
            try
            {
                v_tree.ShowLines = true;
                v_tree.ShowPlusMinus = true;
                v_tree.ShowRootLines = true;
                v_tree.FullRowSelect = false;

                TreeNode anode, anoder;
                anode = new TreeNode("");
                anode.Tag = "";
                anoder = new TreeNode("");
                anoder.Tag = "";

                v_tree.Nodes.Clear();
                v_tree.Sorted = false;
                string amar = "";
                foreach (DataRow r in v_ds.Tables[0].Select("", "mar"))
                {
                    if (amar != r["mar"].ToString())
                    {
                        amar = r["mar"].ToString();
                        anoder = new TreeNode(r["tenr"].ToString());
                        anoder.Tag = r["mar"].ToString();
                        if (anoder.Tag.ToString() != "")
                        {
                            v_tree.Nodes.Add(anoder);
                        }
                    }
                    if (r["ma"].ToString().Trim() != "")
                    {
                        anode = new TreeNode(r["ten"].ToString());
                        anode.Tag = r["ma"].ToString();
                        anoder.Nodes.Add(anode);
                    }
                }
                if (anoder.Tag.ToString() != amar)
                {
                    v_tree.Nodes.Add(anoder);
                }
                if (v_expand)
                {
                    v_tree.ExpandAll();
                }
            }
            catch
            {
            }
        }

        #endregion

        #region XÁC ĐỊNH FILE
        public string f_modify(string tenfile)
        {
            return System.IO.File.GetLastWriteTime(tenfile).ToString("dd/MM/yyyy HH:mm");
        }
        public string f_size(string tenfile)
        {
            System.IO.FileInfo fi = new System.IO.FileInfo(tenfile);
            return (fi.Length / 1024).ToString();
        }
        public string file_exe(string tenfilegoc)
        {
            string ret = "";
            string[] files = System.IO.Directory.GetFiles(System.IO.Directory.GetCurrentDirectory());
            for (int i = 0; i < files.GetLength(0); i++)
            {
                if (files[i].ToString().ToUpper().IndexOf(".EXE") != -1 && tenfile_goc(files[i].ToString()) == tenfilegoc.ToLower())
                {
                    ret = files[i].ToString();
                    break;
                }
            }
            return ret;
        }
        public string file_exe(string path, string tenfilegoc)
        {
            string[] files = System.IO.Directory.GetFiles(path);
            for (int i = 0; i < files.GetLength(0); i++)
            {
                if ((files[i].ToString().ToUpper().IndexOf(".EXE") != -1) && (tenfile_goc(files[i].ToString()) == tenfilegoc.ToLower()))
                {
                    return files[i].ToString();
                }
            }
            return "";
        }
        public string tenfile_goc(string tenfile)
        {
            System.Reflection.Assembly asm = null;
            asm = System.Reflection.Assembly.LoadFrom(tenfile);
            return asm.GetName().Name.ToString().ToLower();
        }
        public string path_medisofthis()
        {
            string currentDirectory = System.IO.Directory.GetCurrentDirectory();
            int num = 0;
            int length = currentDirectory.Length;
            while (length > 0)
            {
                if (currentDirectory.Substring(length - 1, 1) == @"\")
                {
                    num++;
                }
                if (num == 3)
                {
                    break;
                }
                length--;
            }
            return currentDirectory.Substring(0, length - 1);

        }
        public void writeXml(string tenfile, string cot, string s)
        {
            DataSet ds = new DataSet();
            try
            {
                ds.ReadXml(@"..//..//..//xml//" + tenfile + ".xml");
                ds.Tables[0].Rows[0][cot] = s;
            }
            catch
            {
                DataColumn column = new DataColumn();
                column.ColumnName = cot;
                column.DataType = Type.GetType("System.String");
                ds.Tables[0].Columns.Add(column);
                ds.Tables[0].Rows[0][cot] = s;
            }
            ds.WriteXml(@"..//..//..//xml//" + tenfile + ".xml");
        }
        public bool bAutoupdate
        {
            get
            {
                try
                {
                    return (int.Parse(get_data("select ten from " + user + ".thongso where id=340").Tables[0].Rows[0][0].ToString()) == 1);
                }
                catch
                {
                    return false;
                }
            }
        }
        public string Path_medisoft
        {
            get
            {
                try
                {
                    return get_data("select ten from " + user + ".thongso where id=341").Tables[0].Rows[0][0].ToString();
                }
                catch
                {
                    return "";
                }
            }
        }
        public bool bUpdate(string p_localhost, string p_server, string file)
        {
            bool flag = f_modify(file_exe(p_localhost, file)) == f_modify(file_exe(p_server, file));
            bool flag2 = f_size(file_exe(p_localhost, file)) == f_size(file_exe(p_server, file));
            return (flag && flag2);
        }
        #endregion

        #region đổi số ->chữ
        public string Doiso_Unicode(string strp_so)
        {
            string[] strArray = new string[10];
            double number = Conversion.Val(strp_so);
            if (number > 0.0)
            {
                string str4;
                strArray[1] = "một ";
                strArray[2] = "hai ";
                strArray[3] = "ba ";
                strArray[4] = "bốn ";
                strArray[5] = "năm ";
                strArray[6] = "sáu ";
                strArray[7] = "bảy ";
                strArray[8] = "tám ";
                strArray[9] = "chín ";
                string expression = Strings.Trim(Conversion.Str(number));
                if (Strings.Len(expression) > 0x10)
                {
                    Interaction.MsgBox("Số quá lớn, không thể xử lý được! ", MsgBoxStyle.OkOnly, null);
                    return "";
                }
                int num2 = 0;
                int num = 0;
                int num10 = 0;
                int num6 = Strings.Len(expression);
                int start = num6;
                string str5 = "";
                while (start >= 1)
                {
                    int num8;
                    int num9;
                    int num5 = (num6 - start) + 1;
                    string str6 = "";
                    string str2 = "";
                    string str7 = StringType.FromDouble(Conversion.Val(Strings.Mid(expression, start, 1)));
                    string str8 = StringType.FromObject(Interaction.IIf(DoubleType.FromString(str7) == 0.0, "", strArray[IntegerType.FromString(str7)]));
                    if (start > 2)
                    {
                        num9 = IntegerType.FromString(Strings.Mid(expression, start - 2, 1));
                        num8 = IntegerType.FromString(Strings.Mid(expression, start - 1, 1));
                    }
                    else if (start > 1)
                    {
                        num8 = IntegerType.FromString(Strings.Mid(expression, start - 1, 1));
                        num9 = -1;
                    }
                    else
                    {
                        num8 = -1;
                        num9 = -1;
                    }
                    if ((((num5 - 1) % 3) == 0) & ((((num8 == DoubleType.FromString("0")) & (num9 == DoubleType.FromString("0"))) & (((num10 == 0) & (num == 0)) & (num2 == 0))) & (DoubleType.FromString(str7) == 0.0)))
                    {
                        str2 = "";
                    }
                    else if (((num5 - 2) % 3) == 0)
                    {
                        num = IntegerType.FromString(str7);
                        if ((DoubleType.FromString(str7) == 0.0) & (num2 == 0))
                        {
                            str2 = "";
                        }
                        else if (DoubleType.FromString(str7) == 0.0)
                        {
                            str2 = "linh ";
                        }
                        else if (DoubleType.FromString(str7) == 1.0)
                        {
                            str8 = "mười ";
                        }
                        else
                        {
                            str2 = "mươi ";
                        }
                    }
                    else if (((num5 - 3) % 3) == 0)
                    {
                        num10 = IntegerType.FromString(str7);
                        str2 = "trăm ";
                        if (((num10 == 0) & (num == 0)) & (num2 == 0))
                        {
                            str8 = "";
                            str2 = "";
                        }
                        else if (DoubleType.FromString(str7) == 0.0)
                        {
                            str8 = "không ";
                        }
                    }
                    else if (((num5 - 4) % 9) == 0)
                    {
                        str2 = "ngàn ";
                    }
                    else if (((num5 - 7) % 9) == 0)
                    {
                        str2 = "triệu ";
                    }
                    else if ((((num5 - 10) % 9) == 0) & (start != num6))
                    {
                        str2 = "tỷ ";
                    }
                    if (((num5 - 1) % 3) == 0)
                    {
                        num2 = IntegerType.FromString(str7);
                        if (start > 1)
                        {
                            num8 = IntegerType.FromString(Strings.Mid(expression, start - 1, 1));
                        }
                        else
                        {
                            num8 = -1;
                        }
                        if (((DoubleType.FromString(str7) == 1.0) & (Strings.InStr(1, "0/1", StringType.FromInteger(num8), CompareMethod.Binary) == 0)) & (start != 1))
                        {
                            str8 = "một ";
                        }
                    }
                    if (start > 1)
                    {
                        num8 = IntegerType.FromString(Strings.Mid(expression, start - 1, 1));
                    }
                    else
                    {
                        num8 = 0;
                    }
                    if ((((((num5 - 1) % 3) == 0) & (DoubleType.FromString(str7) == 5.0)) & (num8 != DoubleType.FromString("0"))) & (start > 1))
                    {
                        str8 = "lăm ";
                    }
                    str5 = str8 + str2 + str6 + str5;
                    start--;
                }
                if (Strings.InStr(" ", str5, CompareMethod.Binary) > 1)
                {
                    str4 = Strings.UCase(Strings.Left(str5, 1)) + Strings.Mid(str5, 2, Strings.InStr(" ", str5, CompareMethod.Binary) - 1);
                }
                else
                {
                    str4 = Strings.UCase(Strings.Left(str5, 1));
                }
                int num3 = Strings.Len(str4);
                return (str4 + Strings.Mid(str5, num3 + 1) + " đồng");
            }
            return "";
        }
        #endregion

        #region KIỂM TRA SO CHỮ
        public void MaskDigit(System.Windows.Forms.KeyPressEventArgs e)
        {
            if (Char.IsDigit(e.KeyChar) || e.KeyChar == 8) e.Handled = false;
            else e.Handled = true;
        }
        public void MaskDigit_dautru(System.Windows.Forms.KeyPressEventArgs e)
        {
            if (Char.IsDigit(e.KeyChar) || e.KeyChar == 8 || e.KeyChar == '-') e.Handled = false;
            else e.Handled = true;
        }
        public void MaskDecimal(System.Windows.Forms.KeyPressEventArgs e)
        {
            if (Char.IsDigit(e.KeyChar) || e.KeyChar == '.' || e.KeyChar == 8) e.Handled = false;
            else e.Handled = true;
        }
        #endregion

        #region LANGUAGE

        public string Change_language_MessageText(string s_text)
        {
            DataSet ds = new DataSet();
            string gttv = "";
            flag_language = int.Parse(Thongso("Ngonngu").ToString());
            ds.ReadXml(@"..//..//..//language_vp//Messagebox.xml");
            switch (flag_language)
            {
                case 0:
                    gttv = get_text(ds.Tables[0], "vviet='" + s_text + "'", "Vviet");
                    break;
                case 1:
                    gttv = get_text(ds.Tables[0], "vviet='" + s_text + "'", "Vanh");
                    break;
                case 2:
                    gttv = get_text(ds.Tables[0], "vviet='" + s_text + "'", "Vphap");
                    break;
            }
            return (gttv == "") ? s_text : gttv.Trim();
        }
        private string get_text(DataTable dt, string dkt, string anhviet)
        {
            string gttv = "";
            DataRow row = getrowbyid(dt, dkt);
            if (row != null)
            {
                gttv = row[anhviet].ToString();
            }
            return gttv.Trim();
        }
        private string get_text(DataTable dt, string dkt)
        {
            string gttv = "";
            flag_language = int.Parse(Thongso("Ngonngu").ToString());
            DataRow row = getrowbyid(dt, dkt);
            if (row != null)
            {
                switch (flag_language)
                {
                    case 0:
                        gttv = row["vviet"].ToString();
                        break;
                    case 1:
                        gttv = row["vanh"].ToString();
                        break;
                    case 2:
                        gttv = row["vphap"].ToString();
                        break;
                }
            }
            return gttv.Trim();
        }
        #endregion

        #region MA HOA MAT KHAU
        /// <summary>
        /// Cùi bắp
        /// </summary>
        /// <param name="s"></param>
        /// <returns></returns>
        public string encode(string s)
        {
            string s1 = "";
            char c;
            byte b;
            s = s.Trim();
            for (int i = 0; i < s.Length; i++)
            {
                c = Convert.ToChar(s.Substring(i, 1).ToUpper());
                b = (byte)(c);
                s1 = s1 + Convert.ToChar((b % 2 == 0) ? b + 128 : b + 96);
            }
            return s1;
        }
        /// <summary>
        /// Cùi bắp
        /// </summary>
        /// <param name="s"></param>
        /// <returns></returns>
        public string decode(string s)
        {
            string s1 = "";
            char c;
            byte b;
            s = s.Trim();
            for (int i = 0; i < s.Length; i++)
            {
                c = Convert.ToChar(s.Substring(i, 1));
                b = (byte)(c);
                byte ii = (byte)((b % 2 == 0) ? b - 128 : b - 96);
                s1 = s1 + Convert.ToChar(ii);
            }
            return s1;
        }
        #endregion

        public void updrec_ravien(DataSet ds, string mabn, decimal maql, decimal idkhoa, string hoten, string namsinh, string phai, string diachi, int madoituong, string doituong, string sothe,
        string tungay, string denngay, string noigioithieu, string noicap, string giuong, string makp, string tenkp, string ngayvao, string ngayra, string chandoan, string maicd, string nguoinha,
        int hinhthuc, int phuongphap, int ketqua, string soluutru, string mabs, string tenbs, string tenuser, bool b1khu, string ngay1, string ngay2, string ngay3)
        {
            DataRow r1 = ds.Tables[0].NewRow();
            r1["mabn"] = mabn;
            r1["maql"] = maql;
            r1["idkhoa"] = idkhoa;
            r1["hoten"] = hoten;
            r1["namsinh"] = namsinh;
            r1["phai"] = phai;
            r1["diachi"] = diachi;
            r1["madoituong"] = madoituong;
            r1["doituong"] = doituong;
            r1["sothe"] = sothe;
            //r1["tungay"] = tungay;
            r1["denngay"] = denngay;
            r1["noigioithieu"] = noigioithieu;
            r1["noicap"] = noicap;
            r1["giuong"] = giuong;
            r1["makp"] = makp;
            r1["tenkp"] = tenkp;
            r1["ngayvao"] = ngayvao;
            r1["ngayra"] = ngayra;
            r1["chandoan"] = chandoan;
            r1["maicd"] = maicd;
            r1["nguoinha"] = nguoinha;
            r1["hinhthuc"] = hinhthuc;
            r1["phuongphap"] = phuongphap;
            r1["ketqua"] = ketqua;
            r1["soluutru"] = soluutru;
            r1["mabs"] = mabs;
            r1["tenbs"] = tenbs;
            ds.Tables[0].Rows.Add(r1);
        }

        public bool get_done_thvp(string ngay, string mabn, decimal maql, decimal idkhoa, string ngayvao)
        {
            if (bMmyy(get_mmyy(ngay.Substring(0, 10))))
            {
                string sql = "select done from " + user + get_mmyy(ngay) + ".v_thvpll where mabn='" + mabn + "' and to_char(ngayvao,'dd/mm/yyyy hh24:mi')='" + ngayvao + "'";
                if (idkhoa != 0) sql += " and idkhoa=" + idkhoa;
                else sql += " and maql=" + maql;
                m_ds = get_data(sql);
                if (m_ds.Tables[0].Rows.Count > 0) return m_ds.Tables[0].Rows[0]["done"].ToString() == "1";
                else return false;
            }
            return false;
        }

        #region Cap nhat ton kho
        public decimal get_id_tonkho
        {
            get
            {
                return getidyymmdd(9);
            }
        }

        private decimal getidyymmdd(int id)
        {
            return decimal.Parse(getyymmdd() + get_capid_may(9, s_ComputerName).ToString().PadLeft(9, '0') + get_computerid().ToString().PadLeft(3, '0'));
        }

        private string getyymmdd()
        {
            return System.DateTime.Now.Year.ToString().Substring(2) + System.DateTime.Now.Month.ToString().PadLeft(2, '0') + System.DateTime.Now.Day.ToString().PadLeft(2, '0');//get_data("select to_char(now(),'yymmdd')").Tables[0].Rows[0][0].ToString();
        }

        private decimal get_capid_may(int m_ma, string m_computer)
        {
            DataSet ds;
            string sql = "update " + user + ".d_capid set id=id+1 where ma=:m_ma and computer=:m_computer";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            con.Open();
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;
            cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
            cmd.Parameters.Add("m_computer", NpgsqlDbType.Varchar, 20).Value = m_computer;
            int irec = cmd.ExecuteNonQuery();
            cmd.Dispose();
            if (irec == 0)
            {
                sql = "insert into " + user + ".d_capid(ma,ten,id,computer) values (:m_ma,:m_ten,1,:m_computer)";
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("m_ma", NpgsqlDbType.Numeric).Value = m_ma;
                cmd.Parameters.Add("m_ten", NpgsqlDbType.Varchar, 20).Value = m_computer;
                cmd.Parameters.Add("m_computer", NpgsqlDbType.Varchar, 20).Value = m_computer;
                cmd.ExecuteNonQuery();
                cmd.Dispose();
            }
            sql = "select id from " + user + ".d_capid where ma=" + m_ma + " and computer='" + m_computer + "'";
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;
            dest = new NpgsqlDataAdapter(cmd);
            ds = new DataSet();
            dest.Fill(ds);
            cmd.Dispose();
            con.Close(); con.Dispose();
            return decimal.Parse(ds.Tables[0].Rows[0][0].ToString());
        }

        public bool upd_theodoi(string d_mmyy, decimal d_id, int d_mabd, int d_manguon, int d_nhomcc, string d_handung, string d_losx, string d_sothe, string d_namsx, string d_namsd, int d_baohanh, int d_nguongoc, int d_tinhtrang, decimal d_giamua, decimal d_giaban, decimal d_chietkhau, decimal d_giaban2, decimal d_gianovat, decimal d_tyle_ggia, decimal d_st_ggia)
        {
            string schema = user + d_mmyy + ".upd_theodoi";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(schema, con);
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.Add("d_id", NpgsqlDbType.Numeric).Value = d_id;
                cmd.Parameters.Add("d_mabd", NpgsqlDbType.Numeric).Value = d_mabd;
                cmd.Parameters.Add("d_manguon", NpgsqlDbType.Numeric).Value = d_manguon;
                cmd.Parameters.Add("d_nhomcc", NpgsqlDbType.Numeric).Value = d_nhomcc;
                cmd.Parameters.Add("d_handung", NpgsqlDbType.Varchar, 10).Value = d_handung;
                cmd.Parameters.Add("d_losx", NpgsqlDbType.Varchar, 20).Value = d_losx;
                cmd.Parameters.Add("d_sothe", NpgsqlDbType.Varchar, 20).Value = d_sothe;
                cmd.Parameters.Add("d_namsx", NpgsqlDbType.Varchar, 10).Value = d_namsx;
                cmd.Parameters.Add("d_namsd", NpgsqlDbType.Varchar, 10).Value = d_namsd;
                cmd.Parameters.Add("d_baohanh", NpgsqlDbType.Numeric).Value = d_baohanh;
                cmd.Parameters.Add("d_nguongoc", NpgsqlDbType.Numeric).Value = d_nguongoc;
                cmd.Parameters.Add("d_tinhtrang", NpgsqlDbType.Numeric).Value = d_tinhtrang;
                cmd.Parameters.Add("d_giamua", NpgsqlDbType.Numeric).Value = d_giamua;
                cmd.Parameters.Add("d_giaban", NpgsqlDbType.Numeric).Value = d_giaban;
                cmd.Parameters.Add("d_chietkhau", NpgsqlDbType.Numeric).Value = d_chietkhau;
                cmd.Parameters.Add("d_giaban2", NpgsqlDbType.Numeric).Value = d_giaban2;
                cmd.Parameters.Add("d_gianovat", NpgsqlDbType.Numeric).Value = d_gianovat;
                cmd.Parameters.Add("d_tyle_ggia", NpgsqlDbType.Numeric).Value = d_tyle_ggia;
                cmd.Parameters.Add("d_st_ggia", NpgsqlDbType.Numeric).Value = d_st_ggia;
                cmd.ExecuteNonQuery();
            }
            catch (NpgsqlException ex)
            {
                upd_v_error(d_mmyy, ex.Message, s_ComputerName, "d_theodoi");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_theodoi(string d_mmyy, decimal d_id, int d_mabd, int d_manguon, int d_nhomcc, string d_handung, string d_losx, string d_sothe, string d_namsx, string d_namsd, int d_baohanh, int d_nguongoc, int d_tinhtrang, decimal d_giamua, decimal d_giaban, decimal d_gianovat, decimal d_tyle_ggia, decimal d_st_ggia)
        {
            string schema = user + d_mmyy + ".upd_theodoi";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(schema, con);
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.Add("d_id", NpgsqlDbType.Numeric).Value = d_id;
                cmd.Parameters.Add("d_mabd", NpgsqlDbType.Numeric).Value = d_mabd;
                cmd.Parameters.Add("d_manguon", NpgsqlDbType.Numeric).Value = d_manguon;
                cmd.Parameters.Add("d_nhomcc", NpgsqlDbType.Numeric).Value = d_nhomcc;
                cmd.Parameters.Add("d_handung", NpgsqlDbType.Varchar, 10).Value = d_handung;
                cmd.Parameters.Add("d_losx", NpgsqlDbType.Varchar, 20).Value = d_losx;
                cmd.Parameters.Add("d_sothe", NpgsqlDbType.Varchar, 20).Value = d_sothe;
                cmd.Parameters.Add("d_namsx", NpgsqlDbType.Varchar, 10).Value = d_namsx;
                cmd.Parameters.Add("d_namsd", NpgsqlDbType.Varchar, 10).Value = d_namsd;
                cmd.Parameters.Add("d_baohanh", NpgsqlDbType.Numeric).Value = d_baohanh;
                cmd.Parameters.Add("d_nguongoc", NpgsqlDbType.Numeric).Value = d_nguongoc;
                cmd.Parameters.Add("d_tinhtrang", NpgsqlDbType.Numeric).Value = d_tinhtrang;
                cmd.Parameters.Add("d_giamua", NpgsqlDbType.Numeric).Value = d_giamua;
                cmd.Parameters.Add("d_giaban", NpgsqlDbType.Numeric).Value = d_giaban;
                cmd.Parameters.Add("d_gianovat", NpgsqlDbType.Numeric).Value = d_gianovat;
                cmd.Parameters.Add("d_tyle_ggia", NpgsqlDbType.Numeric).Value = d_tyle_ggia;
                cmd.Parameters.Add("d_st_ggia", NpgsqlDbType.Numeric).Value = d_st_ggia;
                cmd.ExecuteNonQuery();
            }
            catch (NpgsqlException ex)
            {
                upd_v_error(d_mmyy, ex.Message, s_ComputerName, "d_theodoi");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_tonkhoct(string d_mmyy, int d_makho, decimal d_stt, int d_mabd, decimal d_tondau)
        {
            string schema = user + d_mmyy + ".upd_tonkhoct";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(schema, con);
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.Add("d_makho", NpgsqlDbType.Numeric).Value = d_makho;
                cmd.Parameters.Add("d_stt", NpgsqlDbType.Numeric).Value = d_stt;
                cmd.Parameters.Add("d_mabd", NpgsqlDbType.Numeric).Value = d_mabd;
                cmd.Parameters.Add("d_tondau", NpgsqlDbType.Numeric).Value = d_tondau;
                cmd.ExecuteNonQuery();
            }
            catch (NpgsqlException ex)
            {
                upd_v_error(d_mmyy, ex.Message, s_ComputerName, "d_tonkhoct");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_tonkhoct(string mmyy, int makho, decimal stt, int mabd, decimal soluong, string fie1)
        {
            string sql = "update " + user + mmyy + ".d_tonkhoct set " + fie1 + "=" + fie1 + "+:soluong,";
            sql += "mabd=:mabd where makho=:makho and stt=:stt";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("soluong", NpgsqlDbType.Numeric).Value = soluong;
                cmd.Parameters.Add("mabd", NpgsqlDbType.Numeric).Value = mabd;
                cmd.Parameters.Add("makho", NpgsqlDbType.Numeric).Value = makho;
                cmd.Parameters.Add("stt", NpgsqlDbType.Numeric).Value = stt;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + mmyy + ".d_tonkhoct(stt,mabd,makho," + fie1 + ",idn,sttn) values ";
                    sql += "(:stt,:mabd,:makho,:soluong,0,0)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("stt", NpgsqlDbType.Numeric).Value = stt;
                    cmd.Parameters.Add("mabd", NpgsqlDbType.Numeric).Value = mabd;
                    cmd.Parameters.Add("makho", NpgsqlDbType.Numeric).Value = makho;
                    cmd.Parameters.Add("soluong", NpgsqlDbType.Numeric).Value = soluong;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_v_error(mmyy, ex.Message, s_ComputerName, "d_tonkhoct");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        public bool upd_tonkhoth(string mmyy, int makho, int manguon, int mabd, decimal soluong, string fie)
        {
            string sql = "update " + user + mmyy + ".d_tonkhoth set " + fie + "=" + fie + "+:soluong where makho=:makho and manguon=:manguon and mabd=:mabd";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("soluong", NpgsqlDbType.Numeric).Value = soluong;
                cmd.Parameters.Add("makho", NpgsqlDbType.Numeric).Value = makho;
                cmd.Parameters.Add("manguon", NpgsqlDbType.Numeric).Value = manguon;
                cmd.Parameters.Add("mabd", NpgsqlDbType.Numeric).Value = mabd;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + mmyy + ".d_tonkhoth(makho,manguon,mabd," + fie + ") values ";
                    sql += "(:makho,:manguon,:mabd,:soluong)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("makho", NpgsqlDbType.Numeric).Value = makho;
                    cmd.Parameters.Add("manguon", NpgsqlDbType.Numeric).Value = manguon;
                    cmd.Parameters.Add("mabd", NpgsqlDbType.Numeric).Value = mabd;
                    cmd.Parameters.Add("soluong", NpgsqlDbType.Numeric).Value = soluong;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_v_error(mmyy, ex.Message, s_ComputerName, "d_tonkhoth");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        #endregion

        #region Cập nhật tủ trực
        public void upd_tutruc(int nhom, string mmyy)
        {
            if (!bMmyy(mmyy)) return;
            if (get_data("select a.* from " + user + mmyy + ".d_tutrucct a," + user + ".d_dmkho b where a.makho=b.id and b.nhom=" + nhom + " and a.tondau+a.slnhap-a.slxuat<0").Tables[0].Rows.Count == 0) return;
            upd_xuat(nhom, mmyy, "d_xuatsdll", "d_thucxuat", "b.makho", " and a.loai in (2)", 6);
            if (get_data("select a.* from " + user + mmyy + ".d_tutrucct a," + user + ".d_dmkho b where a.makho=b.id and b.nhom=" + nhom + " and a.tondau+a.slnhap-a.slxuat<0").Tables[0].Rows.Count == 0) return;
            upd_xuat(nhom, mmyy, "d_xuatll", "d_xuatct", "a.khon", "", 1);
        }

        private void upd_xuat(int nhom, string mmyy, string f1, string f2, string fie, string dk, int loai)
        {
            DataRow r1, r3, r4;
            DataTable dtct, dtth;
            string usr = user, xxx = usr + mmyy;

            dtth = get_data("select a.* from " + xxx + ".d_tutructh a," + usr + ".d_dmkho b where a.makho=b.id and b.nhom=" + nhom).Tables[0];

            sql = "select c.khott,c.stt as sttkho,a.stt,a.makp,a.makho,a.tondau,a.slnhap,a.slxuat,b.*,d.giaban as giaban_,d.giaban2 as giaban2_ ";
            sql += " from " + xxx + ".d_tutrucct a," + xxx + ".d_theodoi b," + usr + ".d_dmkho c," + usr + ".d_dmbd d ";
            sql += " where a.stt=b.id and a.makho=c.id and a.mabd=d.id and c.nhom=" + nhom;
            sql += " order by c.khott desc,a.stt";

            dtct = get_data(sql).Tables[0];
            int makho, manguon, mabd, makp; decimal sl;
            foreach (DataRow r in dtct.Select("tondau+slnhap-slxuat<0", "khott desc,stt"))
            {
                makho = int.Parse(r["makho"].ToString());
                manguon = int.Parse(r["manguon"].ToString());
                mabd = int.Parse(r["mabd"].ToString());
                makp = int.Parse(r["makp"].ToString());
                sql = "makho=" + makho + " and manguon=" + manguon + " and mabd=" + mabd;
                sql += " and tondau+slnhap-slxuat>=0";
                sql += " and makp=" + int.Parse(r["makp"].ToString());
                r1 = getrowbyid(dtth, sql);
                if (r1 != null)
                {
                    sql = "select b.*";
                    if (loai == 1) sql += ",a.loai,a.khox,a.khon";
                    else if (loai == 6) sql += ",a.makp,a.loai,a.thuoc";
                    sql += " ,t.manguon,t.nhomcc,t.giamua,t.handung,t.losx ";
                    sql += " from " + xxx + "." + f1 + " a, " + xxx + "." + f2 + " b, " + xxx + ".d_theodoi t ";
                    sql += " where a.id=b.id and b.sttt=t.id and " + fie + "=" + makho;
                    sql += " and b.sttt=" + decimal.Parse(r["stt"].ToString());
                    sql += " and a.nhom=" + nhom;
                    sql += dk;
                    if (loai == 6) sql += " and a.makp=" + makp;
                    else if (loai == 1) sql += " and a.khox=" + makp;
                    sql += " order by b.soluong";

                    foreach (DataRow r2 in get_data(sql).Tables[0].Rows)
                    {
                        sl = decimal.Parse(r2["soluong"].ToString());
                        sql = "makho=" + makho + " and manguon=" + manguon + " and mabd=" + mabd;
                        sql += " and tondau+slnhap-slxuat>=" + sl;

                        if (loai == 6) makp = int.Parse(r2["makp"].ToString());
                        else if (loai == 1) makp = int.Parse(r2["khox"].ToString());

                        sql += " and makp=" + makp;
                        r3 = getrowbyid(dtct, sql);
                        if (r3 != null)
                        {
                            upd_tutrucct_thucxuat("delete", mmyy, makp, decimal.Parse(r2["sttt"].ToString()), makho, manguon, mabd, sl);

                            sql = "update " + user + mmyy + "." + f2 + " set sttt=" + decimal.Parse(r3["stt"].ToString());
                            sql += " where id=" + decimal.Parse(r2["id"].ToString()) + " and stt=" + int.Parse(r2["stt"].ToString());
                            sql += " and sttt=" + decimal.Parse(r2["sttt"].ToString());
                            execute_data(sql);

                            if (decimal.Parse(r["tondau"].ToString()) + decimal.Parse(r["slnhap"].ToString()) - decimal.Parse(r["slxuat"].ToString()) >= 0) break;

                            upd_tutrucct_thucxuat("insert", mmyy, makp, decimal.Parse(r3["stt"].ToString()), makho, manguon, mabd, sl);

                            sql = "makho=" + int.Parse(r["makho"].ToString()) + " and stt=" + decimal.Parse(r3["stt"].ToString());

                            sql += " and makp=" + makp;

                            r4 = getrowbyid(dtct, sql);
                            if (r4 != null) r4["slxuat"] = decimal.Parse(r4["slxuat"].ToString()) + decimal.Parse(r2["soluong"].ToString());
                            r["slxuat"] = decimal.Parse(r["slxuat"].ToString()) - decimal.Parse(r2["soluong"].ToString());
                            dtct.AcceptChanges();
                        }
                    }
                }
            }
        }

        public void upd_tutrucct_thucxuat(string tt, string mmyy, int makp, decimal stt, int makho, int manguon, int mabd, decimal soluong)
        {
            if (tt == "delete")
            {
                execute_data("update " + user + mmyy + ".d_tutrucct set slxuat=slxuat-" + soluong + " where makp=" + makp + " and makho=" + makho + " and stt=" + stt);
                upd_tutructh(mmyy, makp, makho, mabd, manguon, soluong, "slxuat");
            }
            else if (tt == "insert")
            {
                execute_data("update " + user + mmyy + ".d_tutrucct set slxuat=slxuat+" + soluong + " where makp=" + makp + " and makho=" + makho + " and stt=" + stt);
                upd_tutructh(tt, mmyy, makp, makho, mabd, manguon, soluong, "slxuat");
            }
        }

        public void upd_tutructh(string tt, string mmyy, int makp, int makho, int mabd, int manguon, decimal soluong, string fie)
        {
            if (tt == "delete") execute_data("update " + user + mmyy + ".d_tutructh set " + fie + "=" + fie + "-" + soluong + " where makp=" + makp + " and makho=" + makho + " and mabd=" + mabd + " and manguon=" + manguon);
            else if (tt == "insert") upd_tutructh(mmyy, makp, makho, manguon, mabd, soluong, fie);
        }

        public bool upd_tutructh(string mmyy, int makp, int makho, int manguon, int mabd, decimal soluong, string fie)
        {
            sql = "update " + user + mmyy + ".d_tutructh set " + fie + "=" + fie + "+:soluong where makp=:makp and makho=:makho and manguon=:manguon and mabd=:mabd";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;
                cmd.Parameters.Add("soluong", NpgsqlDbType.Numeric).Value = soluong;
                cmd.Parameters.Add("makp", NpgsqlDbType.Numeric).Value = makp;
                cmd.Parameters.Add("makho", NpgsqlDbType.Numeric).Value = makho;
                cmd.Parameters.Add("manguon", NpgsqlDbType.Numeric).Value = manguon;
                cmd.Parameters.Add("mabd", NpgsqlDbType.Numeric).Value = mabd;
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + mmyy + ".d_tutructh(makp,makho,manguon,mabd," + fie + ") values ";
                    sql += "(:makp,:makho,:manguon,:mabd,:soluong)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("makp", NpgsqlDbType.Numeric).Value = makp;
                    cmd.Parameters.Add("makho", NpgsqlDbType.Numeric).Value = makho;
                    cmd.Parameters.Add("manguon", NpgsqlDbType.Numeric).Value = manguon;
                    cmd.Parameters.Add("mabd", NpgsqlDbType.Numeric).Value = mabd;
                    cmd.Parameters.Add("soluong", NpgsqlDbType.Numeric).Value = soluong;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_v_error(mmyy, ex.Message, s_ComputerName, "d_tutructh");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }
        #endregion

        public void Disconnect()
        {
            if (con != null)
            {
                con.Close();
                con.Dispose();
            }
        }
        public bool bDanhapvien(string smavaovien)
        {
            sql = "select mabn, maql, ngay from " + user + ".benhandt where mavaovien=" + smavaovien;
            return get_data(sql).Tables[0].Rows.Count > 0;
        }

        public bool bCLS(string amavp)
        {
            string asql = "select * from medibv.v_giavp where id=" + amavp + " and " + amavp + " in ( ";
            asql += "select distinct a.id from medibv.v_giavp a inner join medibv.v_loaivp b on a.id_loai=b.id ";
            asql += " inner join medibv.v_nhomvp_medisoft c on  b.id_nhom=c.id where c.id in (1,2,14)) ";//xet nghiem, CDHA, TDCN
            DataSet ads = get_data(asql);
            if (ads.Tables[0].Rows.Count > 0)
                return true;
            return false;
        }

        public bool bCongkham(string amavp)
        {
            string asql = " select * from medibv.v_giavp where id in(" + amavp.Trim().Trim(',') + ") and id in(";
            asql += "select distinct mavp from " + user + ".btdkp_bv ";
            asql += "union all select distinct mavptk from " + user + ".btdkp_bv ";
            asql += "union all select id_gia from " + user + ".v_trongoi ";
            asql += "where id in (select distinct mavp from " + user + ".btdkp_bv)";
            asql += " union all ";
            asql += "select a.id from medibv.v_giavp a inner join medibv.v_loaivp b on a.id_loai=b.id ";
            asql += "inner join medibv.v_nhomvp_medisoft c on  b.id_nhom=c.id where c.id=9";
            asql += " ) ";
            DataSet ads = get_data(asql);
            if (ads!=null && ads.Tables.Count>0 && ads.Tables[0].Rows.Count > 0)
            {
                return true;
            }
            return false;
        }


        public string f_get_v_phanquyen_chitiet(string v_userid, string v_menuname)
        {
            string aquyenchitiet = "";

            try
            {
                v_userid = int.Parse(v_userid).ToString();
            }
            catch
            {
                v_userid = "";
            }
            try
            {
                if (v_userid != "")
                {
                    aquyenchitiet = get_data("select userid,menuname,chon,chitiet from " + user + ".v_phanquyen where userid=" + v_userid).Tables[0].Select("menuname='" + v_menuname + "'")[0]["chitiet"].ToString();
                }
            }
            catch
            {
            }
            return aquyenchitiet.Trim().PadRight(6, '0');
        }

        public bool f_quyenchitiet_them(string v_quyenchitiet)
        {
            try
            {
                return v_quyenchitiet.Substring(0, 1) == "1";
            }
            catch
            {
                return false;
            }
        }
        public bool f_quyenchitiet_xoa(string v_quyenchitiet)
        {
            try
            {
                return v_quyenchitiet.Substring(1, 1) == "1";
            }
            catch
            {
                return false;
            }
        }
        public bool f_quyenchitiet_sua(string v_quyenchitiet)
        {
            try
            {
                return v_quyenchitiet.Substring(2, 1) == "1";
            }
            catch
            {
                return false;
            }
        }
        public bool f_quyenchitiet_xem(string v_quyenchitiet)
        {
            try
            {
                return v_quyenchitiet.Substring(3, 1) == "1";
            }
            catch
            {
                return false;
            }
        }
        public bool f_quyenchitiet_in(string v_quyenchitiet)
        {
            try
            {
                return v_quyenchitiet.Substring(4, 1) == "1";
            }
            catch
            {
                return false;
            }
        }
        public bool f_quyenchitiet_export(string v_quyenchitiet)
        {
            try
            {
                return v_quyenchitiet.Substring(5, 1) == "1";
            }
            catch
            {
                return false;
            }
        }

        public bool bThuchenhlechtruoc_duyettoasau(int d_nhom)
        {
            //tab5 - cot 1 - dong 1           

            try
            {
                DataSet ds = get_data("select ten from " + user + ".d_thongso where id=1009 and nhom=" + d_nhom);
                if (ds.Tables[0].Rows.Count > 0) return int.Parse(ds.Tables[0].Rows[0]["ten"].ToString()) == 1;
                else return false;
            }
            catch { return false; }

        }
        public string f_get_tendoituong(string madoituong)
        {
            try
            {
                return get_data("select doituong from " + user + ".doituong where madoituong=" + madoituong).Tables[0].Rows[0]["doituong"].ToString();
            }
            catch { return ""; }
        }

        public int TiLeGiam
        {
            get
            {
                try
                {
                    DataSet ds = get_data("select giatri from " + user + ".v_option where ma='nrcMienGiam'");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return 0; }
            }
            set
            {
                upd_v_option("nrcMienGiam", value.ToString());
            }
        }

        public bool bQuanly_theokhu
        {
            //A14.1
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1073");
                    return ds.Tables[0].Rows[0][0].ToString() == "1";
                }
                catch { return false; }
            }
        }
        //Khuong 24/05/2011 : cap nhat nhom mien
        public bool upd_v_nhommien(int v_id, string v_ten, string v_loaivp, int v_sudung)
        {
            sql = "update " + user + ".v_nhommien set ten=:v_ten,loaivp=:v_loaivp,sudung=:v_sudung where id=:v_id";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
                cmd.Parameters.Add("v_loaivp", NpgsqlDbType.Text).Value = v_loaivp;
                cmd.Parameters.Add("v_sudung", NpgsqlDbType.Numeric).Value = v_sudung;
                cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;

                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".v_nhommien(id,ten,loaivp,sudung) values ";
                    sql += "(:v_id,:v_ten,:v_loaivp,:v_sudung)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text).Value = v_ten;
                    cmd.Parameters.Add("v_loaivp", NpgsqlDbType.Text).Value = v_loaivp;
                    cmd.Parameters.Add("v_sudung", NpgsqlDbType.Numeric).Value = v_sudung;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_v_error(ex.Message, s_ComputerName, "v_nhommien");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        //cap nhat tyleduyetmien
        public bool upd_v_tyleduyetmien(int v_ma, int v_idnhommien, int v_tyle)
        {
            sql = "update " + user + ".v_tyleduyetmien set tyle=:v_tyle where ma=:v_ma and id_nhommien=:v_idnhommien";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("v_tyle", NpgsqlDbType.Numeric).Value = v_tyle;
                cmd.Parameters.Add("v_ma", NpgsqlDbType.Numeric).Value = v_ma;
                cmd.Parameters.Add("v_idnhommien", NpgsqlDbType.Numeric).Value = v_idnhommien;

                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".v_tyleduyetmien(ma,id_nhommien,tyle) values ";
                    sql += "(:v_ma,:v_idnhommien,:v_tyle)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_ma", NpgsqlDbType.Numeric).Value = v_ma;
                    cmd.Parameters.Add("v_idnhommien", NpgsqlDbType.Numeric).Value = v_idnhommien;
                    cmd.Parameters.Add("v_tyle", NpgsqlDbType.Numeric).Value = v_tyle;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_v_error(ex.Message, s_ComputerName, "v_tyleduyetmien");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        //End Khuong 24/05/2011

        //Khuong 26/05/2011 cap nhat v_km_nhommien
        public bool upd_v_km_nhommien(int v_iddot, int v_idnhommien, int v_tyle, int v_userid)
        {
            sql = "update " + user + ".v_km_nhommien set tyle=:v_tyle where iddot=:v_iddot and id_nhommien=:v_idnhommien";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            try
            {
                con.Open();
                cmd = new NpgsqlCommand(sql, con);
                cmd.CommandType = CommandType.Text;

                cmd.Parameters.Add("v_tyle", NpgsqlDbType.Numeric).Value = v_tyle;
                cmd.Parameters.Add("v_iddot", NpgsqlDbType.Numeric).Value = v_iddot;
                cmd.Parameters.Add("v_idnhommien", NpgsqlDbType.Numeric).Value = v_idnhommien;

                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + user + ".v_km_nhommien(iddot,id_nhommien,tyle,userid) values ";
                    sql += "(:v_iddot,:v_idnhommien,:v_tyle,:v_userid)";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_iddot", NpgsqlDbType.Numeric).Value = v_iddot;
                    cmd.Parameters.Add("v_idnhommien", NpgsqlDbType.Numeric).Value = v_idnhommien;
                    cmd.Parameters.Add("v_tyle", NpgsqlDbType.Numeric).Value = v_tyle;
                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (NpgsqlException ex)
            {
                upd_v_error(ex.Message, s_ComputerName, "v_km_nhommien");
                return false;
            }
            finally
            {
                con.Close(); con.Dispose();
            }
            return true;
        }

        //End Khuong 26/05/2011

        public void close()
        {
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
        }
        public bool upd_yeucauhoadonct(decimal v_id, decimal v_stt, string v_ngay10,
            string v_makp, decimal v_madoituong, decimal v_mavp, decimal v_soluong, decimal v_dongia,
            decimal v_vat, decimal v_sotien, decimal v_giamua, decimal v_bhyttra, decimal v_gia_bh)
        {
            sql = "update " + s_schemaroot + ".yeucauhoadonct set ngay=to_date(:v_ngay,'dd/mm/yyyy'),";
            sql += "makp=:v_makp,madoituong=:v_madoituong,mavp=:v_mavp,soluong=:v_soluong, dongia=:v_dongia,";
            sql += "vat=:v_vat, sotien=:v_sotien,giamua=:v_giamua,bhyttra=:v_bhyttra,gia_bh=" + v_gia_bh;
            sql += " where id=:v_id and stt=:v_stt";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;

            cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 10).Value = v_ngay10;
            cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, 2).Value = v_makp;
            cmd.Parameters.Add("v_madoituong", NpgsqlDbType.Numeric).Value = v_madoituong;
            cmd.Parameters.Add("v_mavp", NpgsqlDbType.Numeric).Value = v_mavp;
            cmd.Parameters.Add("v_soluong", NpgsqlDbType.Numeric).Value = v_soluong;
            cmd.Parameters.Add("v_dongia", NpgsqlDbType.Numeric).Value = v_dongia;
            cmd.Parameters.Add("v_vat", NpgsqlDbType.Numeric).Value = v_vat;
            //cmd.Parameters.Add("v_vattu", NpgsqlDbType.Numeric).Value = v_vattu;
            cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
            cmd.Parameters.Add("v_giamua", NpgsqlDbType.Numeric).Value = v_giamua;
            cmd.Parameters.Add("v_bhyttra", NpgsqlDbType.Numeric).Value = v_bhyttra;
            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;

            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + s_schemaroot + ".yeucauhoadonct(id,stt,ngay,makp,madoituong,mavp,soluong,dongia,vat,sotien,giamua,bhyttra,gia_bh) values(:v_id,:v_stt,to_date(:v_ngay,'dd/mm/yyyy'),:v_makp,:v_madoituong,:v_mavp,:v_soluong,:v_dongia,:v_vat,:v_sotien,:v_giamua,:v_bhyttra," + v_gia_bh + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
                    cmd.Parameters.Add("v_ngay", NpgsqlDbType.Varchar, 10).Value = v_ngay10;
                    cmd.Parameters.Add("v_makp", NpgsqlDbType.Varchar, 2).Value = v_makp;
                    cmd.Parameters.Add("v_madoituong", NpgsqlDbType.Numeric).Value = v_madoituong;
                    cmd.Parameters.Add("v_mavp", NpgsqlDbType.Numeric).Value = v_mavp;
                    cmd.Parameters.Add("v_soluong", NpgsqlDbType.Numeric).Value = v_soluong;
                    cmd.Parameters.Add("v_dongia", NpgsqlDbType.Numeric).Value = v_dongia;
                    cmd.Parameters.Add("v_vat", NpgsqlDbType.Numeric).Value = v_vat;
                    //cmd.Parameters.Add("v_vattu", NpgsqlDbType.Numeric).Value = v_vattu;
                    cmd.Parameters.Add("v_sotien", NpgsqlDbType.Numeric).Value = v_sotien;
                    cmd.Parameters.Add("v_giamua", NpgsqlDbType.Numeric).Value = v_giamua;
                    cmd.Parameters.Add("v_bhyttra", NpgsqlDbType.Numeric).Value = v_bhyttra;
                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "yeucauhoadonct");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }

        public void f_get_phongcls_stt(string v_ngay, string v_idgiacp, string v_phongcls, ref int v_id_phongcls, ref int v_stt_thcls)
        {
            string s_phongth_cls = v_phongcls;
            string s_user = user;
            if (v_phongcls == "")
            {
                sql = "select phongthuchiencls from " + s_user + ".v_giavp where id=" + v_idgiacp;
                try
                {
                    s_phongth_cls = get_data(sql).Tables[0].Rows[0]["phongthuchiencls"].ToString().Trim().Trim(',');
                }
                catch { s_phongth_cls = ""; }
            }
            if (s_phongth_cls.Trim().Trim(',') == "")
            {
                v_id_phongcls = 0;
                v_stt_thcls = 0;
            }
            else
            {
                string xxx = s_user + mmyy(v_ngay);
                string[] a_idphongcls = s_phongth_cls.Trim().Trim(',').Split(',');
                int i_minstt = 0;
                if (a_idphongcls.Length > 0)
                {
                    for (int i = 0; i < a_idphongcls.Length; i++)
                    {
                        //    sql = "select " + xxx + ".stt_phongcls where to_char(ngay,'dd/mm/yyyy')='" + v_ngay + "' and idphongcls=" + a_idphongcls[i];
                        //    ds1 = get_data(sql);
                        //    if (ds1 == null || ds1.Tables.Count <= 0)
                        //    {
                        //        sql = " insert into " + xxx + ".stt_phongcls(ngay, idphongcls, stt) values(to_date('" + v_ngay + "','dd/mm/yyyy')," + a_idphongcls[i] + ",0)";
                        //        execute_data(sql);
                        //    }

                        //}
                        sql = "select max(stt) stt, idphongcls from " + xxx + ".stt_phongcls where to_char(ngay,'dd/mm/yyyy')='" + v_ngay + "' and idphongcls in(" + a_idphongcls[i].Trim().Trim(',') + ") group by idphongcls ";
                        DataSet lds = get_data(sql);
                        if (lds == null || lds.Tables.Count <= 0 || lds.Tables[0].Rows.Count <= 0)
                        {
                            i_minstt = 1;
                            v_id_phongcls = int.Parse(s_phongth_cls.Split(',')[0]);
                            break;

                        }
                        else
                        {
                            if (i_minstt > int.Parse(lds.Tables[0].Rows[0]["stt"].ToString()))
                            {
                                i_minstt = int.Parse(lds.Tables[0].Rows[0]["stt"].ToString());
                                v_id_phongcls = int.Parse(lds.Tables[0].Rows[0]["idphongcls"].ToString());
                            }
                        }
                    }
                    upd_stt_phongcls(v_ngay, ref v_id_phongcls, ref v_stt_thcls);
                }
            }
        }

        public void upd_stt_phongcls(string v_ngay, ref int v_idphongcls, ref int v_stt)
        {
            string xxx = user + mmyy(v_ngay);
            //
            sql = "select stt, idphongcls from " + xxx + ".stt_phongcls where to_char(ngay,'dd/mm/yyyy')='" + v_ngay + "'";
            DataSet lds = get_data(sql);
            if (lds == null || lds.Tables.Count < 0 || lds.Tables[0].Rows.Count <= 0)
            {
                v_stt = 1;
            }
            else
            {
                v_stt = int.Parse(lds.Tables[0].Rows[0]["stt"].ToString()) + 1;
                v_idphongcls = int.Parse(lds.Tables[0].Rows[0]["idphongcls"].ToString()) + 1;
            }
            //
            lds.Dispose();
            sql = "update " + xxx + ".stt_phongcls set stt=" + v_stt + " where idphongcls=" + v_idphongcls + " and to_char(ngay,'dd/mm/yyyy')='" + v_ngay + "'";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;
            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + xxx + ".stt_phongcls(ngay,idphongcls,stt) values(to_date('" + v_ngay + "','dd/mm/yyyy'," + v_idphongcls + "," + v_stt + ")";
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_thongso");
                return;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
        }

        public bool bQuanly_Theo_Chinhanh
        {
            //A14.2: medisoft-kbht
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=998");
                    return ds.Tables[0].Rows[0][0].ToString() == "1";
                }
                catch { return false; }
            }
        }

        public bool bH19_CLS_Phanbiettronggio_ngoaigio
        {
            //H19: medisoft KBHT
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=1078");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString()) == 1;
                }
                catch { return false; }
            }
        }

        public string databaselinks_name
        {
            set
            {
                s_dblink = value;
                s_dblink = s_dblink == "" ? "" : "@" + s_dblink.Trim('@');
            }
        }

        public decimal get_sokham(string m_ngay, string m_makp, int m_sokham)
        {
            try
            {
                if (!bMmyy(mmyy(m_ngay))) return 0;
                sql = "select max(to_number(sovaovien)) from " + user + mmyy(m_ngay) + ".tiepdon where to_char(ngay,'dd/mm/yyyy')='" + m_ngay.Substring(0, 10) + "'";
                if (m_sokham == 2) sql += " and makp='" + m_makp + "'";
                sql += " and noitiepdon in (0,1,5,16) and sovaovien<>''";
                DataSet ds = get_data(sql);
                if (ds == null || ds.Tables.Count <= 0 || ds.Tables[0].Rows.Count == 0) return 1;
                else
                {
                    try
                    {
                        return decimal.Parse(ds.Tables[0].Rows[0][0].ToString()) + 1;
                    }
                    catch { return 1; }
                }
            }
            catch { return 1; }
        }

        /// <summary>
        /// Phương thức sư dụng để lấy id chi nhánh đến trong table v_ttrvct
        /// </summary>
        /// <param name="v_id"></param>
        /// <param name="_mmyy"></param>
        /// <returns></returns>
        public int get_idchinhanhden_vttrvct(string v_id, string _mmyy)
        {
            sql = "select idchinhanhden from " + user + _mmyy + ".v_ttrvct where idchinhanh<>idchinhanhden and id=" + v_id;
            try
            {
                DataSet tmp = get_data(sql);
                return int.Parse(tmp.Tables[0].Rows[0][0].ToString());
            }
            catch
            {
                return -1;
            }
        }
        public void del_thongtinvienphi(string v_id, string v_mmyy, string s_dblinks)
        {
            execute_data_mmyy(v_mmyy, "delete from medibvmmyy.v_ttrvct" + this.s_dblink + " where id=" + v_id + "");
            execute_data_mmyy(v_mmyy, "delete from medibvmmyy.v_ttrvbhyt" + this.s_dblink + " where id=" + v_id + "");
            //execute_data_mmyy(v_mmyy, "delete from medibvmmyy.v_ttrvnhom where id=" + v_id + "");
            //execute_data_mmyy(v_mmyy, "delete from medibvmmyy.v_ttrvpttt where id=" + v_id + "");
            //execute_data_mmyy(v_mmyy, "delete from medibvmmyy.v_ttrvptttct where id=" + v_id + "");
            execute_data_mmyy(v_mmyy, "delete from medibvmmyy.v_ttrvll" + this.s_dblink + " where id=" + v_id + "");
            execute_data_mmyy(v_mmyy, "delete from medibvmmyy.v_ttrvds" + this.s_dblink + " where id=" + v_id + "");
        }
        //gam 23/08/2011
        public int iNhombacsi
        {
           
            get
            {
                try
                {
                    DataSet ds = get_data("select ten from " + user + ".thongso where id=594");
                    return int.Parse(ds.Tables[0].Rows[0][0].ToString());
                }
                catch { return -1; }
            }
        }
        //end gam
        //Thuy 19.01.12
        public bool bchophepchondoituong(string v_userid)
        {
            try
            {
                return (get_data("select giatri from medibv.v_optionform" + s_dblink + " where userid=" + v_userid + " and loai=1 and ma='chkchondoituong'").Tables[0].Rows[0][0].ToString() == "1");
            }
            catch
            {
                return true;
            }
        }
        //end Thuy 19.01.12

        public int i_Chinhanh_hientai
        {
            get
            {
                try
                {
                    string s_ip_local = Maincode("Ip");
                    string s_database_local = Maincode("Database");
                    DataSet dsChinhanh = get_data(" select id from " + user +
                        ".dmchinhanh where ip='" + s_ip_local + "' and lower(database_local)='" + s_database_local + "' and port='" + Maincode("Post") + "'");
                    if (dsChinhanh == null || dsChinhanh.Tables.Count <= 0 || dsChinhanh.Tables[0].Rows.Count == 0)
                    {
                        DataSet dstmp = get_data("select ten from " + user + ".thongso where id=999");
                        return int.Parse(dstmp.Tables[0].Rows[0][0].ToString());
                    }
                    else
                    {
                        return int.Parse(dsChinhanh.Tables[0].Rows[0][0].ToString());
                    }
                }
                catch { return 0; }
            }
        }

        //Linh 25092012
        public bool upd_v_khunggia(int v_id, decimal v_gia_th, decimal v_gia_bh, decimal v_gia_dv, decimal v_gia_nn, decimal v_gia_ksk, decimal v_gia_cs,
           decimal v_vattu_th, decimal v_vattu_bh, decimal v_vattu_dv, decimal v_vattu_nn, decimal v_vattu_ksk, decimal v_vattu_cs,
           int v_thuong, decimal v_bhyt, int v_userid, int v_hide, string v_ngay)
        {
            string s_sql = "update " + user + ".v_khunggia set gia_th=" + v_gia_th.ToString() + ",gia_bh=" + v_gia_bh.ToString() + ",gia_dv=" + v_gia_dv.ToString() + ", " +
                "gia_ksk=" + v_gia_ksk.ToString() + ", gia_nn=" + v_gia_nn.ToString() + ", gia_cs=" + v_gia_cs.ToString() + "," +
                "vattu_th=" + v_vattu_th.ToString() + ",vattu_bh=" + v_vattu_bh.ToString() + ", vattu_dv=" + v_vattu_dv.ToString() + "," +
                "vattu_nn=" + v_vattu_nn.ToString() + ",vattu_cs=" + v_vattu_cs.ToString() + ",vattu_ksk=" + v_vattu_ksk.ToString() + "," +
                "bhyt=" + v_bhyt.ToString() + ",thuong=" + v_thuong.ToString() + "," +
                "userid=" + v_userid.ToString() + ",hide=" + v_hide.ToString() + ",computer='" + System.Environment.MachineName + "' " +
                " where id_vp=" + v_id.ToString() + " and to_char(ngay,'dd/mm/yyyy')='" + v_ngay + "'";
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(s_sql, con);
            cmd.CommandType = CommandType.Text;
            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    s_sql = "insert into " + user + ".v_khunggia(id_vp,gia_th,gia_bh,gia_dv,gia_nn,gia_cs,gia_ksk," +
                        "vattu_th,vattu_bh,vattu_dv,vattu_nn,vattu_cs,vattu_ksk,bhyt,thuong,userid,hide,computer,ngay) " +
                        "values(" + v_id + "," + v_gia_th + "," + v_gia_bh + "," + v_gia_dv + "," + v_gia_nn + "," +
                        v_gia_cs + "," + v_gia_ksk + "," + v_vattu_th + "," + v_vattu_bh + "," + v_vattu_dv + "," + v_vattu_nn + "," + v_vattu_cs + "," +
                        v_vattu_ksk + "," + v_bhyt + "," + v_thuong + "," + v_userid + "," + v_hide + ",'" + System.Environment.MachineName + "',to_date('" + v_ngay + "','dd/mm/yyyy'))";
                    cmd = new NpgsqlCommand(s_sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, System.Environment.MachineName, "v_khunggia");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        //thuy 02012013
        public string get_maql_phongkham(string v_tungay, string v_denngay, decimal v_mavaovien)
        {
            string s = "";
            if (v_mavaovien <= 0) return "";
            if (v_tungay.Trim().Length < 10) v_tungay = ngayhienhanh_server.Substring(0, 10);
            else v_tungay = v_tungay.Substring(0, 10);
            if (v_denngay.Trim().Length < 10) v_denngay = ngayhienhanh_server.Substring(0, 10);
            else v_denngay = v_denngay.Trim().Substring(0, 10);
            DataSet ds = get_data_mmyy("select maql from medibvmmyy.benhanpk where mavaovien=" + v_mavaovien, v_tungay, v_denngay, true);
            foreach (DataRow r in ds.Tables[0].Rows)
            {
                s += r["maql"].ToString() + ",";
            }
            return s;
        }
        //linh 02012013
        internal string PathXML = "..//..//..//xml";
        const string key = "Toancau@Medisoft.vn/03031952#0903937066.";

        internal string Key
        {
            get { return key; }
        }
        /// <summary>
        /// Dịch ngược mật khẩu
        /// </summary>
        /// <param name="values">Chuỗi đã bị mã hoá</param>
        /// <returns></returns>
        internal string DeCode(string values, string s_key)
        {
            string val = "";
            val = DeCrypt(values, s_key);
            return val;
        }

        string DeCrypt(string values, string s_key)
        {
            byte[] keyArray;
            byte[] toEncryptArray = Convert.FromBase64String(values);
            MD5CryptoServiceProvider hashmd5 = new MD5CryptoServiceProvider();
            keyArray = hashmd5.ComputeHash(UTF8Encoding.UTF8.GetBytes(s_key));
            TripleDESCryptoServiceProvider tdes = new TripleDESCryptoServiceProvider();
            tdes.Key = keyArray;
            tdes.Mode = CipherMode.ECB;
            tdes.Padding = PaddingMode.PKCS7;
            ICryptoTransform cTransform = tdes.CreateDecryptor();
            byte[] resultArray = cTransform.TransformFinalBlock(toEncryptArray, 0, toEncryptArray.Length);
            return UTF8Encoding.UTF8.GetString(resultArray);
        }

        /// <summary>
        /// Mã hoá mật khẩu
        /// </summary>
        /// <param name="values">Chuỗi cần được mã hoá</param>
        /// <returns></returns>
        internal string EnCode(string values)
        {
            string val = "";
            val = EnCrypt(values);
            return val;
        }

        string EnCrypt(string values)
        {
            byte[] keyArray;
            byte[] toEncryptArray = UTF8Encoding.UTF8.GetBytes(values);
            MD5CryptoServiceProvider hashmd5 = new MD5CryptoServiceProvider();
            keyArray = hashmd5.ComputeHash(UTF8Encoding.UTF8.GetBytes(Key));
            TripleDESCryptoServiceProvider tdes = new TripleDESCryptoServiceProvider();
            tdes.Key = keyArray;
            tdes.Mode = CipherMode.ECB;
            tdes.Padding = PaddingMode.PKCS7;
            ICryptoTransform cTransform = tdes.CreateEncryptor();
            byte[] resultArray = cTransform.TransformFinalBlock(toEncryptArray, 0, toEncryptArray.Length);
            return Convert.ToBase64String(resultArray, 0, resultArray.Length);
        }

        public decimal v_get_sobienlaiam()
        {
            string mmyy = ngayhienhanh_server.Substring(8, 2) + ngayhienhanh_server.Substring(3, 2);
            decimal d_id = get_v_capid(decimal.Parse(mmyy));
            return d_id;
        }
        // truong thuy 21052014 dung de khai bao dot gia moi 
        public bool upd_v_giavp_truoc(decimal v_id, decimal v_id_loai, decimal v_stt, string v_ma, string v_ten, string v_dvt, decimal v_bhyt, decimal v_gia_th, decimal v_gia_bh, decimal v_gia_dv, decimal v_gia_nn, decimal v_gia_ksk, decimal v_gia_cs, decimal v_phuthu_th, decimal v_phuthu_dv, decimal v_phuthu_nn, decimal v_phuthu_cs, decimal v_userid, string v_idchinhanh, string v_ngayhieuluc, int v_tuyen, string v_cnapdung, string v_tncv_1, string v_tncv_2, string v_tncv_3, string v_tncv_4, string v_tncv_5, string v_tncv_6, int v_bbhoichan, int v_giaycamdoan, int v_hsngoaitru, int v_kythuatcao, string v_dblink, string v_doituongapdung, string v_maluong)
        {
            string sql = "update " + m_db_schemaroot + ".v_giavp_truoc" + v_dblink + " set id_loai=:v_id_loai, stt=:v_stt";
            sql += ", ma=:v_ma,ten=:v_ten,dvt=:v_dvt,bhyt=:v_bhyt,gia_th=:v_gia_th,gia_bh=:v_gia_bh,gia_cs=:v_gia_cs,gia_dv=:v_gia_dv,gia_nn=:v_gia_nn, phuthu_th=:v_phuthu_th, phuthu_dv=:v_phuthu_dv,phuthu_nn=:v_phuthu_nn,phuthu_cs=:v_phuthu_cs,userid=:v_userid,ngayud=now() ";//gia_ksk=:v_gia_ksk,
            sql += ", tuyen=" + v_tuyen + ",cnapdung='" + v_cnapdung + "', tiepnhancv_cn1='" + v_tncv_1 + "', tiepnhancv_cn2='" + v_tncv_2 + "', tiepnhancv_cn3='" + v_tncv_3 + "', tiepnhancv_cn4='" + v_tncv_4 + "', tiepnhancv_cn5='" + v_tncv_5 + "', tiepnhancv_cn6='" + v_tncv_6 + "', hoichan=" + v_bbhoichan + ", giaycamdoan=" + v_giaycamdoan + ",hsngoaitru=" + v_hsngoaitru + ", kythuat=" + v_kythuatcao;
            sql += ", doituongapdung='" + v_doituongapdung + "', maluong='" + v_maluong + "'";
            sql += " where id=:v_id and idchinhanh=:v_idchinhanh and to_char(ngayhieuluc,'dd/mm/yyyy')=:v_ngayhieuluc";
            if (con != null)
            {
                con.Close(); con.Dispose();
            }
            con = new NpgsqlConnection(sConn);
            cmd = new NpgsqlCommand(sql, con);
            cmd.CommandType = CommandType.Text;
            cmd.Parameters.Add("v_id_loai", NpgsqlDbType.Numeric).Value = v_id_loai;
            cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
            cmd.Parameters.Add("v_ma", NpgsqlDbType.Text, 50).Value = v_ma;
            cmd.Parameters.Add("v_ten", NpgsqlDbType.Text, 255).Value = v_ten;
            cmd.Parameters.Add("v_dvt", NpgsqlDbType.Text, 20).Value = v_dvt;
            cmd.Parameters.Add("v_bhyt", NpgsqlDbType.Numeric).Value = v_bhyt;

            cmd.Parameters.Add("v_gia_th", NpgsqlDbType.Numeric).Value = v_gia_th;
            cmd.Parameters.Add("v_gia_bh", NpgsqlDbType.Numeric).Value = v_gia_bh;
            cmd.Parameters.Add("v_gia_cs", NpgsqlDbType.Numeric).Value = v_gia_cs;
            cmd.Parameters.Add("v_gia_dv", NpgsqlDbType.Numeric).Value = v_gia_dv;
            cmd.Parameters.Add("v_gia_nn", NpgsqlDbType.Numeric).Value = v_gia_nn;
            // cmd.Parameters.Add("v_gia_ksk", NpgsqlDbType.Numeric).Value = v_gia_ksk;

            cmd.Parameters.Add("v_phuthu_th", NpgsqlDbType.Numeric).Value = v_phuthu_th;
            cmd.Parameters.Add("v_phuthu_dv", NpgsqlDbType.Numeric).Value = v_phuthu_dv;
            cmd.Parameters.Add("v_phuthu_nn", NpgsqlDbType.Numeric).Value = v_phuthu_nn;
            cmd.Parameters.Add("v_phuthu_cs", NpgsqlDbType.Numeric).Value = v_phuthu_cs;

            cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
            cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
            cmd.Parameters.Add("v_idchinhanh", NpgsqlDbType.Numeric).Value = v_idchinhanh;
            cmd.Parameters.Add("v_ngayhieuluc", NpgsqlDbType.Varchar, 10).Value = v_ngayhieuluc;
            try
            {
                con.Open();
                int irec = cmd.ExecuteNonQuery();
                cmd.Dispose();
                if (irec == 0)
                {
                    sql = "insert into " + m_db_schemaroot + ".v_giavp_truoc" + v_dblink + "(id,id_loai,stt,ma,ten,dvt,bhyt,gia_th,gia_bh,gia_cs,gia_dv,gia_nn,phuthu_th,phuthu_dv,phuthu_nn,phuthu_cs,userid,idchinhanh,ngayhieuluc,ngayud, done, tuyen, cnapdung, tiepnhancv_cn1, tiepnhancv_cn2, tiepnhancv_cn3, tiepnhancv_cn4, tiepnhancv_cn5, tiepnhancv_cn6, hoichan, giaycamdoan, hsngoaitru,kythuat, doituongapdung, maluong) ";//gia_ksk
                    sql += " values(:v_id,:v_id_loai,:v_stt,:v_ma,:v_ten,:v_dvt,:v_bhyt,:v_gia_th,:v_gia_bh,:v_gia_cs,:v_gia_dv,:v_gia_nn,:v_phuthu_th,:v_phuthu_dv,:v_phuthu_nn,:v_phuthu_cs,:v_userid,:v_idchinhanh,to_date(:v_ngayhieuluc,'dd/mm/yyyy'),now(),0," + v_tuyen + ",'" + v_cnapdung + "','" + v_tncv_1 + "', '" + v_tncv_2 + "', '" + v_tncv_3 + "', '" + v_tncv_4 + "', '" + v_tncv_5 + "', '" + v_tncv_6 + "'," + v_bbhoichan + ", " + v_giaycamdoan + "," + v_hsngoaitru + "," + v_kythuatcao + ",'" + v_doituongapdung + "','" + v_maluong + "')";//:v_gia_ksk,
                    cmd = new NpgsqlCommand(sql, con);
                    cmd.CommandType = CommandType.Text;
                    cmd.Parameters.Add("v_id", NpgsqlDbType.Numeric).Value = v_id;
                    cmd.Parameters.Add("v_id_loai", NpgsqlDbType.Numeric).Value = v_id_loai;
                    cmd.Parameters.Add("v_stt", NpgsqlDbType.Numeric).Value = v_stt;
                    cmd.Parameters.Add("v_ma", NpgsqlDbType.Text, 50).Value = v_ma;
                    cmd.Parameters.Add("v_ten", NpgsqlDbType.Text, 255).Value = v_ten;
                    cmd.Parameters.Add("v_dvt", NpgsqlDbType.Text, 20).Value = v_dvt;
                    cmd.Parameters.Add("v_bhyt", NpgsqlDbType.Numeric).Value = v_bhyt;
                    cmd.Parameters.Add("v_gia_th", NpgsqlDbType.Numeric).Value = v_gia_th;
                    cmd.Parameters.Add("v_gia_bh", NpgsqlDbType.Numeric).Value = v_gia_bh;
                    cmd.Parameters.Add("v_gia_cs", NpgsqlDbType.Numeric).Value = v_gia_cs;
                    cmd.Parameters.Add("v_gia_dv", NpgsqlDbType.Numeric).Value = v_gia_dv;
                    cmd.Parameters.Add("v_gia_nn", NpgsqlDbType.Numeric).Value = v_gia_nn;
                    //cmd.Parameters.Add("v_gia_ksk", NpgsqlDbType.Numeric).Value = v_gia_ksk;
                    cmd.Parameters.Add("v_phuthu_th", NpgsqlDbType.Numeric).Value = v_phuthu_th;
                    cmd.Parameters.Add("v_phuthu_dv", NpgsqlDbType.Numeric).Value = v_phuthu_dv;
                    cmd.Parameters.Add("v_phuthu_nn", NpgsqlDbType.Numeric).Value = v_phuthu_nn;
                    cmd.Parameters.Add("v_phuthu_cs", NpgsqlDbType.Numeric).Value = v_phuthu_cs;

                    cmd.Parameters.Add("v_userid", NpgsqlDbType.Numeric).Value = v_userid;
                    cmd.Parameters.Add("v_idchinhanh", NpgsqlDbType.Numeric).Value = v_idchinhanh;
                    cmd.Parameters.Add("v_ngayhieuluc", NpgsqlDbType.Varchar, 10).Value = v_ngayhieuluc.Substring(0, 10);

                    irec = cmd.ExecuteNonQuery();
                    cmd.Dispose();
                }
            }
            catch (Exception ex)
            {
                upd_v_error(ex.Message, m_computername, "v_giavp_truoc");
                return false;
            }
            finally
            {
                cmd.Dispose();
                con.Dispose();
            }
            return true;
        }
        public DataSet f_get_v_nhomvp_frmgiavp_cochitiet()
        {
            string sql = "";
            sql = "select distinct a.ma, a.stt, a.ten, a.idnhombhyt from " + s_schemaroot + ".v_nhomvp a inner join medibv.v_loaivp b on a.ma=b.id_nhom inner join medibv.v_giavp c on b.id=c.id_loai order by a.ten";
            return get_data(sql);
        }
        public DataSet f_get_v_loaivp_frmgiavp_cochitiet()
        {
            string sql = "";
            sql = "select distinct a.id, a.stt, a.ten, a.id_nhom from " + s_schemaroot + ".v_loaivp a inner join medibv.v_giavp b on a.id=b.id_loai order by a.ten";
            return get_data(sql);
        }
        public bool bDblinkAlive(string d_dblinkname)
        {
            try
            {
                return get_data("select * from medibv.dmchinhanh@" + d_dblinkname).Tables[0].Rows.Count > 0;
            }
            catch
            {
                return false;
            }
        }
        public enum IDLoaiImport
        {
            Import_DMKT_gia = 1,
            Import_DMKT_MaLuong = 2,
            Import_DMKT_MaNhom_Machuyenkhoa = 3,
            Import_DMKT_Tenviettat = 4

        }
    }
}
