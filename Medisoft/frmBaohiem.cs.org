using System;
using System.Drawing;
using System.Collections;
using System.ComponentModel;
using System.Windows.Forms;
using System.IO;
using System.Data;
using LibDuoc;
using LibMedi;
using LibVienphi;

namespace Medisoft
{
	/// <summary>
	/// Summary description for frmDutru.
	/// </summary>
	public class frmBaohiem : System.Windows.Forms.Form
	{
        Language lan = new Language(); Bogotiengviet tv = new Bogotiengviet(); private System.Windows.Forms.TextBox textBox111 = new System.Windows.Forms.TextBox();
		private System.Windows.Forms.Label label1;
		private MaskedTextBox.MaskedTextBox mabn;
		private System.Windows.Forms.Label label2;
        private System.Windows.Forms.TextBox hoten;
		private System.Windows.Forms.TextBox tenbd;
		private System.Windows.Forms.TextBox tenhc;
		private System.Windows.Forms.Label lTenhc;
		private System.Windows.Forms.TextBox mabd;
		private System.Windows.Forms.Label lTen;
        private System.Windows.Forms.Label lMabd;
		private MaskedTextBox.MaskedTextBox soluong;
		private System.Windows.Forms.Label label16;
		private System.Windows.Forms.Label ldvt;
		private System.Windows.Forms.TextBox cachdung;
		private System.Windows.Forms.Label label25;
		private System.Windows.Forms.Button butKetthuc;
		private System.Windows.Forms.Button butHuy;
		private System.Windows.Forms.Button butBoqua;
		private System.Windows.Forms.Button butXoa;
		private System.Windows.Forms.Button butThem;
		private System.Windows.Forms.Button butLuu;
		private System.Windows.Forms.Button butSua;
		private System.Windows.Forms.Button butMoi;
		private System.Windows.Forms.Button butCholai;
		private System.Windows.Forms.ComboBox cmbMabn;
		private LibDuoc.AccessData d=new LibDuoc.AccessData();
		private LibMedi.AccessData m=new LibMedi.AccessData();
		private LibMedi.AccessData v=new LibMedi.AccessData();
        private int i_nhom, i_userid, i_old, i_loai, i_mabd, i_sudungthuoc, i_madoituong, i_bhyt_inrieng, i_loaiba, iUserid_duyet, itable, i_mabdcu, i_makhocu, i_manguoncu, iUserid_donve,i_tunguyen,iBhyt_songay,i_row,i_col,i_w,i_h,traituyen;
        private int iKhoangcachngaycaptoa_voingaykham = 0, iSotien_cancanhbao_khicaptoa=0;
        private string user, nam, s_makho, s_makho_kp, s_ngay, s_ngay_kham, sql, s_mmyy, s_manguon, s_msg, s_diachi, s_bhyt, s_ngayht, xxx, zzz, s_noidkkcb, s_madoituong, s_ngayvao, ngay1, ngay2, ngay3, ngay_reset_phieu38 = "";
        private string s_mabn, s_Hoten, s_Phai="", s_Namsinh, s_Sothe, s_Tenkp, s_Tenbs, s_Maicd, s_Chandoan, s_makp, s_mabs, s_doituong, s_ngaymakp = "", s_user, s_ngayvv = "", s_cholam = "", s_trieuchung = "", makhosave = "", f_soluong;
        private long l_id = 0, l_maql, l_mavaovien ;
        private decimal d_soluongcu, d_soluong, d_soluongton;
        private bool bNew, bEdit, bDiungthuoc, bDone, bChidinh, bKiemtrathuoc, bSolan, bLetet, bDieutringtr, bLuu_Donthuoc_bacsy, bDuyet = false, bInchitiet = false, bKhoaso, bCachdung, bMuangoai_tonkho, bTongtien_donduyet, bGiaban_theodot, bDonthuoc_stc, bGiaban, bAdmin, bAdminInlaidonthuoc, bChonkhoa, bNgoaitonkho, bDuyet_donve, bDuyet_donvepl, bBamhuyet, bTayy, bDutru_n_thuoc, bMabd_doituong, bNgayhienhanh_thuoc_chidinh, bThuphi_khongloadthuoc_BHYT, bCaptoa_theodanhmuc_duocketoa;
		private LibList.List listDmbd;
		private LibList.List listCachdung;
		private DataRow r;
        private DataTable dtngay = new DataTable();
        private DataTable dtdon = new DataTable();
		private DataTable dtton=new DataTable();
		private DataTable dtll=new DataTable();
		private DataTable dtct=new DataTable();
		private DataTable dtsave=new DataTable();
		private DataTable dtdmbd=new DataTable();
		private DataSet dsxoa=new DataSet();
        private DataTable dthoten=new DataTable();
        private DataTable dtbs = new DataTable();
        private DataTable dtkho = new DataTable();
        private DataTable dtnguon = new DataTable();
        private DataTable dthuyet = new DataTable();
		private System.Windows.Forms.Label label20;
		private System.Windows.Forms.ComboBox makho;
		private System.Windows.Forms.TextBox stt;
		private System.Windows.Forms.Label diung;
		private System.Windows.Forms.TextBox mahc;
		private System.Windows.Forms.Label label22;
		private System.Windows.Forms.ComboBox manguon;
		private System.Windows.Forms.TreeView treeView1;
		private System.Windows.Forms.TextBox namsinh;
		private System.Windows.Forms.TextBox sothe;
		private System.Windows.Forms.TextBox chandoan;
		private System.Windows.Forms.TextBox maicd;
		private System.Windows.Forms.TextBox tenpk;
		private System.Windows.Forms.TextBox tenbs;
		private System.Windows.Forms.Label label3;
		private System.Windows.Forms.Label label4;
		private System.Windows.Forms.Label label5;
		private System.Windows.Forms.Label label6;
		private System.Windows.Forms.Label lblbacsy;
		private System.Windows.Forms.Button butIn;
        private dllReportM.Print print = new dllReportM.Print();
        private System.Windows.Forms.Button butHen;
		private System.Windows.Forms.Label lghichu;
		private System.Windows.Forms.TextBox ghichu;
		private System.Windows.Forms.CheckBox chkVP;
		private System.Windows.Forms.NumericUpDown songay;
		private System.Windows.Forms.Label label9;
		private System.Windows.Forms.Label label10;
        private Label label11;
        private NumericUpDown solan;
        private TextBox makp;
        private TextBox mabs;
        private DataTable dtletet = new DataTable();
        private Label label12;
        private MaskedTextBox.MaskedTextBox moilan;
        private Label lbldvt;
        private ComboBox donthuoc;
        private CheckBox chkChon;
        private CheckBox chkDongia;
        private ToolTip toolTip1;
        private IContainer components;
        private byte[] image;
        private System.IO.MemoryStream memo;
        private System.IO.FileStream fstr;
        private CheckBox chkXML;
        private CheckBox chkXem;
        private MaskedTextBox.MaskedTextBox sum;
        private Label lblsum;
        private Panel p1;
        private Panel p2;
        private CheckBox chk2;
        private CheckBox chk1;
        private MaskedTextBox.MaskedTextBox c4;
        private Label label18;
        private MaskedTextBox.MaskedTextBox c3;
        private Label label17;
        private MaskedTextBox.MaskedTextBox c2;
        private Label label15;
        private MaskedTextBox.MaskedTextBox c1;
        private Label label14;
        private Label lblduongdung;
        private Label label19;
        private MaskedTextBox.MaskedTextBox soluong1;
        private Bitmap map;
        private bool bNgtru_dt_makp;
        private int dt_ngtru = 0, kho_ngtru;
        private LibList.List listHoten;
        private LibList.List listBS;
        private ComboBox madoituong;
        private Label label13;
        private CheckBox chkThuoc;
        private string makp_kho_dt;
        private bool bTinnhan_sound, bTinnhan;
        private Button butTuongtac;
        private Button butGoi;
        private TextBox dang;
        private CheckBox chkChitiet;
        private ComboBox huyet;
        private CheckBox chkHuyet;
        private TextBox tim;
        private Button butDongy;
        private Label label7;
        private NumericUpDown banin;
        private CheckBox chkLuuin;
        private DataGrid dataGrid1;
        private CheckBox chkDoituong;
        private bool bLocdichvu;
        private CheckBox chkTodieutri;
        private Label lbldungluc;
        private MaskedTextBox.MaskedTextBox txtgiaban;
        private MaskedTextBox.MaskedTextBox txtdongia;
        private bool bXemlai=false;

        public frmBaohiem(bool dieutringtr, string mabn, int loai, string mmyy, string ngay, int nhom, int userid, string title, long mavaovien, long lMaql, string sHoten, string sNamsinh, string sSothe, string sTenkp, string sTenbs, string sMaicd, string sChandoan, int madoituong, string makp, string _mabs, string doituong, string _cholam, string diachi, string _nam, string _t2, int loaiba, string _noidkkcb, bool chonkhoa, string _madoituong, string _ngayvao, string _trieuchung,int _traituyen,string _ngay1,string _ngay2,string _ngay3, string _phai, bool xemlai)
		{
			//
			// Required for Windows Form Designer support
			//
			InitializeComponent();
			lan.Read_Language_to_Xml(this.Name.ToString(),this);
            lan.Changelanguage_to_English(this.Name.ToString(), this); if (m.bBogo) tv.GanBogo(this, textBox111);
            s_mmyy = mmyy; s_ngay = ngay; s_ngay_kham = ngay; i_loai = loai; s_noidkkcb = _noidkkcb;
            s_mabn = mabn; l_maql = lMaql; i_loaiba = loaiba; bChonkhoa = chonkhoa; s_cholam = _cholam;
            s_Hoten = sHoten; bDieutringtr = dieutringtr; s_madoituong = _madoituong;
            s_Sothe = sSothe; s_Tenkp = sTenkp; s_Tenbs = sTenbs; maicd.Text=s_Maicd = sMaicd; s_Chandoan = sChandoan;
            i_userid = userid; s_makp = makp; mabs.Text=s_mabs = _mabs; l_mavaovien = mavaovien;
            i_nhom = nhom; i_madoituong = madoituong; s_doituong = doituong;
            s_trieuchung = _trieuchung; traituyen = _traituyen; ngay1 = _ngay1; ngay2 = _ngay2; ngay3 = _ngay3;
            s_Namsinh = sNamsinh;
            bXemlai = xemlai;
            s_Phai = _phai;
            this.Text = title; s_diachi = diachi; nam = _nam; s_bhyt = _t2; s_ngayvao = _ngayvao;
			//
			// TODO: Add any constructor code after InitializeComponent call
			//
		}

        public frmBaohiem(bool dieutringtr, string mabn, int loai, string mmyy, string ngay, int nhom, int userid, string title, long mavaovien, long lMaql, string sHoten, string sNamsinh, string sSothe, string sTenkp, string sTenbs, string sMaicd, string sChandoan, int madoituong, string makp, string _mabs, string doituong, string _cholam, string diachi, string _nam, string _t2, int loaiba, string _noidkkcb, bool chonkhoa, string _madoituong, string _ngayvao, string _trieuchung, int _traituyen, string _ngay1, string _ngay2, string _ngay3, string _phai)
        {
            //
            // Required for Windows Form Designer support
            //
            InitializeComponent();
            lan.Read_Language_to_Xml(this.Name.ToString(), this);
            lan.Changelanguage_to_English(this.Name.ToString(), this); if (m.bBogo) tv.GanBogo(this, textBox111);
            s_mmyy = mmyy; s_ngay = ngay; s_ngay_kham = ngay; i_loai = loai; s_noidkkcb = _noidkkcb;
            s_mabn = mabn; l_maql = lMaql; i_loaiba = loaiba; bChonkhoa = chonkhoa; s_cholam = _cholam;
            s_Hoten = sHoten; bDieutringtr = dieutringtr; s_madoituong = _madoituong;
            s_Sothe = sSothe; s_Tenkp = sTenkp; s_Tenbs = sTenbs; maicd.Text = s_Maicd = sMaicd; s_Chandoan = sChandoan;
            i_userid = userid; s_makp = makp; mabs.Text = s_mabs = _mabs; l_mavaovien = mavaovien;
            i_nhom = nhom; i_madoituong = madoituong; s_doituong = doituong;
            s_trieuchung = _trieuchung; traituyen = _traituyen; ngay1 = _ngay1; ngay2 = _ngay2; ngay3 = _ngay3;
            s_Namsinh = sNamsinh;
            s_Phai = _phai;
            this.Text = title; s_diachi = diachi; nam = _nam; s_bhyt = _t2; s_ngayvao = _ngayvao;
            //
            // TODO: Add any constructor code after InitializeComponent call
            //
        }
		/// <summary>
		/// Clean up any resources being used.
		/// </summary>
		protected override void Dispose( bool disposing )
		{
			if( disposing )
			{
				if(components != null)
				{
					components.Dispose();
				}
			}
			base.Dispose( disposing );
		}

		#region Windows Form Designer generated code
		/// <summary>
		/// Required method for Designer support - do not modify
		/// the contents of this method with the code editor.
		/// </summary>
		private void InitializeComponent()
		{
            this.components = new System.ComponentModel.Container();
            System.ComponentModel.ComponentResourceManager resources = new System.ComponentModel.ComponentResourceManager(typeof(frmBaohiem));
            this.label1 = new System.Windows.Forms.Label();
            this.mabn = new MaskedTextBox.MaskedTextBox();
            this.label2 = new System.Windows.Forms.Label();
            this.hoten = new System.Windows.Forms.TextBox();
            this.tenbd = new System.Windows.Forms.TextBox();
            this.tenhc = new System.Windows.Forms.TextBox();
            this.lTenhc = new System.Windows.Forms.Label();
            this.mabd = new System.Windows.Forms.TextBox();
            this.lTen = new System.Windows.Forms.Label();
            this.lMabd = new System.Windows.Forms.Label();
            this.soluong = new MaskedTextBox.MaskedTextBox();
            this.label16 = new System.Windows.Forms.Label();
            this.ldvt = new System.Windows.Forms.Label();
            this.cachdung = new System.Windows.Forms.TextBox();
            this.label25 = new System.Windows.Forms.Label();
            this.butKetthuc = new System.Windows.Forms.Button();
            this.butHuy = new System.Windows.Forms.Button();
            this.butBoqua = new System.Windows.Forms.Button();
            this.butXoa = new System.Windows.Forms.Button();
            this.butThem = new System.Windows.Forms.Button();
            this.butLuu = new System.Windows.Forms.Button();
            this.butSua = new System.Windows.Forms.Button();
            this.butMoi = new System.Windows.Forms.Button();
            this.butCholai = new System.Windows.Forms.Button();
            this.cmbMabn = new System.Windows.Forms.ComboBox();
            this.listDmbd = new LibList.List();
            this.listCachdung = new LibList.List();
            this.label20 = new System.Windows.Forms.Label();
            this.makho = new System.Windows.Forms.ComboBox();
            this.stt = new System.Windows.Forms.TextBox();
            this.diung = new System.Windows.Forms.Label();
            this.mahc = new System.Windows.Forms.TextBox();
            this.label22 = new System.Windows.Forms.Label();
            this.manguon = new System.Windows.Forms.ComboBox();
            this.treeView1 = new System.Windows.Forms.TreeView();
            this.namsinh = new System.Windows.Forms.TextBox();
            this.sothe = new System.Windows.Forms.TextBox();
            this.chandoan = new System.Windows.Forms.TextBox();
            this.maicd = new System.Windows.Forms.TextBox();
            this.tenpk = new System.Windows.Forms.TextBox();
            this.tenbs = new System.Windows.Forms.TextBox();
            this.label3 = new System.Windows.Forms.Label();
            this.label4 = new System.Windows.Forms.Label();
            this.label5 = new System.Windows.Forms.Label();
            this.label6 = new System.Windows.Forms.Label();
            this.lblbacsy = new System.Windows.Forms.Label();
            this.butIn = new System.Windows.Forms.Button();
            this.butHen = new System.Windows.Forms.Button();
            this.lghichu = new System.Windows.Forms.Label();
            this.ghichu = new System.Windows.Forms.TextBox();
            this.chkVP = new System.Windows.Forms.CheckBox();
            this.songay = new System.Windows.Forms.NumericUpDown();
            this.label9 = new System.Windows.Forms.Label();
            this.label10 = new System.Windows.Forms.Label();
            this.label11 = new System.Windows.Forms.Label();
            this.solan = new System.Windows.Forms.NumericUpDown();
            this.makp = new System.Windows.Forms.TextBox();
            this.mabs = new System.Windows.Forms.TextBox();
            this.label12 = new System.Windows.Forms.Label();
            this.moilan = new MaskedTextBox.MaskedTextBox();
            this.lbldvt = new System.Windows.Forms.Label();
            this.donthuoc = new System.Windows.Forms.ComboBox();
            this.chkChon = new System.Windows.Forms.CheckBox();
            this.chkDongia = new System.Windows.Forms.CheckBox();
            this.toolTip1 = new System.Windows.Forms.ToolTip(this.components);
            this.chkXML = new System.Windows.Forms.CheckBox();
            this.chkXem = new System.Windows.Forms.CheckBox();
            this.sum = new MaskedTextBox.MaskedTextBox();
            this.lblsum = new System.Windows.Forms.Label();
            this.p1 = new System.Windows.Forms.Panel();
            this.p2 = new System.Windows.Forms.Panel();
            this.c4 = new MaskedTextBox.MaskedTextBox();
            this.label19 = new System.Windows.Forms.Label();
            this.soluong1 = new MaskedTextBox.MaskedTextBox();
            this.chk2 = new System.Windows.Forms.CheckBox();
            this.chk1 = new System.Windows.Forms.CheckBox();
            this.label18 = new System.Windows.Forms.Label();
            this.c3 = new MaskedTextBox.MaskedTextBox();
            this.label17 = new System.Windows.Forms.Label();
            this.c2 = new MaskedTextBox.MaskedTextBox();
            this.label15 = new System.Windows.Forms.Label();
            this.c1 = new MaskedTextBox.MaskedTextBox();
            this.label14 = new System.Windows.Forms.Label();
            this.lblduongdung = new System.Windows.Forms.Label();
            this.listHoten = new LibList.List();
            this.listBS = new LibList.List();
            this.madoituong = new System.Windows.Forms.ComboBox();
            this.label13 = new System.Windows.Forms.Label();
            this.chkThuoc = new System.Windows.Forms.CheckBox();
            this.dang = new System.Windows.Forms.TextBox();
            this.butTuongtac = new System.Windows.Forms.Button();
            this.butGoi = new System.Windows.Forms.Button();
            this.chkChitiet = new System.Windows.Forms.CheckBox();
            this.huyet = new System.Windows.Forms.ComboBox();
            this.chkHuyet = new System.Windows.Forms.CheckBox();
            this.tim = new System.Windows.Forms.TextBox();
            this.butDongy = new System.Windows.Forms.Button();
            this.label7 = new System.Windows.Forms.Label();
            this.banin = new System.Windows.Forms.NumericUpDown();
            this.chkLuuin = new System.Windows.Forms.CheckBox();
            this.dataGrid1 = new System.Windows.Forms.DataGrid();
            this.chkDoituong = new System.Windows.Forms.CheckBox();
            this.chkTodieutri = new System.Windows.Forms.CheckBox();
            this.lbldungluc = new System.Windows.Forms.Label();
            this.txtgiaban = new MaskedTextBox.MaskedTextBox();
            this.txtdongia = new MaskedTextBox.MaskedTextBox();
            ((System.ComponentModel.ISupportInitialize)(this.songay)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.solan)).BeginInit();
            this.p1.SuspendLayout();
            this.p2.SuspendLayout();
            ((System.ComponentModel.ISupportInitialize)(this.banin)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.dataGrid1)).BeginInit();
            this.SuspendLayout();
            // 
            // label1
            // 
            this.label1.Location = new System.Drawing.Point(3, 5);
            this.label1.Name = "label1";
            this.label1.Size = new System.Drawing.Size(61, 23);
            this.label1.TabIndex = 25;
            this.label1.Text = "Mã BN :";
            this.label1.TextAlign = System.Drawing.ContentAlignment.MiddleRight;
            // 
            // mabn
            // 
            this.mabn.BackColor = System.Drawing.SystemColors.HighlightText;
            this.mabn.Enabled = false;
            this.mabn.Font = new System.Drawing.Font("Tahoma", 8.25F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.mabn.Location = new System.Drawing.Point(64, 4);
            this.mabn.Masked = MaskedTextBox.MaskedTextBox.Mask.None;
            this.mabn.MaxLength = 8;
            this.mabn.Name = "mabn";
            this.mabn.Size = new System.Drawing.Size(89, 21);
            this.mabn.TabIndex = 1;
            this.mabn.Validated += new System.EventHandler(this.mabn_Validated);
            // 
            // label2
            // 
            this.label2.Location = new System.Drawing.Point(151, 5);
            this.label2.Name = "label2";
            this.label2.Size = new System.Drawing.Size(48, 23);
            this.label2.TabIndex = 26;
            this.label2.Text = "Họ tên :";
            this.label2.TextAlign = System.Drawing.ContentAlignment.MiddleRight;
            // 
            // hoten
            // 
            this.hoten.BackColor = System.Drawing.SystemColors.HighlightText;
            this.hoten.Enabled = false;
            this.hoten.Font = new System.Drawing.Font("Tahoma", 8.25F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.hoten.Location = new System.Drawing.Point(200, 4);
            this.hoten.Name = "hoten";
            this.hoten.Size = new System.Drawing.Size(184, 21);
            this.hoten.TabIndex = 2;
            this.hoten.TextChanged += new System.EventHandler(this.hoten_TextChanged);
            this.hoten.KeyDown += new System.Windows.Forms.KeyEventHandler(this.hoten_KeyDown);
            // 
            // tenbd
            // 
            this.tenbd.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.tenbd.BackColor = System.Drawing.SystemColors.HighlightText;
            this.tenbd.Enabled = false;
            this.tenbd.Font = new System.Drawing.Font("Tahoma", 8.25F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.tenbd.Location = new System.Drawing.Point(269, 426);
            this.tenbd.Name = "tenbd";
            this.tenbd.Size = new System.Drawing.Size(243, 21);
            this.tenbd.TabIndex = 14;
            this.tenbd.TextChanged += new System.EventHandler(this.tenbd_TextChanged);
            this.tenbd.Validated += new System.EventHandler(this.tenbd_Validated);
            this.tenbd.KeyDown += new System.Windows.Forms.KeyEventHandler(this.tenbd_KeyDown);
            // 
            // tenhc
            // 
            this.tenhc.Anchor = ((System.Windows.Forms.AnchorStyles)(((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)
                        | System.Windows.Forms.AnchorStyles.Right)));
            this.tenhc.BackColor = System.Drawing.SystemColors.HighlightText;
            this.tenhc.Enabled = false;
            this.tenhc.Font = new System.Drawing.Font("Tahoma", 8.25F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.tenhc.Location = new System.Drawing.Point(568, 426);
            this.tenhc.Name = "tenhc";
            this.tenhc.Size = new System.Drawing.Size(144, 21);
            this.tenhc.TabIndex = 15;
            this.tenhc.KeyDown += new System.Windows.Forms.KeyEventHandler(this.tenhc_KeyDown);
            // 
            // lTenhc
            // 
            this.lTenhc.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.lTenhc.Location = new System.Drawing.Point(501, 424);
            this.lTenhc.Name = "lTenhc";
            this.lTenhc.Size = new System.Drawing.Size(69, 23);
            this.lTenhc.TabIndex = 56;
            this.lTenhc.Text = "Hoạt chất :";
            this.lTenhc.TextAlign = System.Drawing.ContentAlignment.MiddleRight;
            // 
            // mabd
            // 
            this.mabd.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.mabd.BackColor = System.Drawing.SystemColors.HighlightText;
            this.mabd.CharacterCasing = System.Windows.Forms.CharacterCasing.Upper;
            this.mabd.Enabled = false;
            this.mabd.Font = new System.Drawing.Font("Tahoma", 8.25F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.mabd.Location = new System.Drawing.Point(178, 426);
            this.mabd.Name = "mabd";
            this.mabd.Size = new System.Drawing.Size(60, 21);
            this.mabd.TabIndex = 13;
            this.mabd.TextChanged += new System.EventHandler(this.mabd_TextChanged);
            this.mabd.KeyDown += new System.Windows.Forms.KeyEventHandler(this.mabd_KeyDown);
            // 
            // lTen
            // 
            this.lTen.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.lTen.Location = new System.Drawing.Point(236, 427);
            this.lTen.Name = "lTen";
            this.lTen.Size = new System.Drawing.Size(32, 23);
            this.lTen.TabIndex = 55;
            this.lTen.Text = "Tên :";
            this.lTen.TextAlign = System.Drawing.ContentAlignment.MiddleRight;
            // 
            // lMabd
            // 
            this.lMabd.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.lMabd.Location = new System.Drawing.Point(143, 427);
            this.lMabd.Name = "lMabd";
            this.lMabd.Size = new System.Drawing.Size(31, 23);
            this.lMabd.TabIndex = 54;
            this.lMabd.Text = "Mã :";
            this.lMabd.TextAlign = System.Drawing.ContentAlignment.MiddleRight;
            // 
            // soluong
            // 
            this.soluong.BackColor = System.Drawing.SystemColors.HighlightText;
            this.soluong.Enabled = false;
            this.soluong.Font = new System.Drawing.Font("Tahoma", 8.25F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.soluong.Location = new System.Drawing.Point(401, 2);
            this.soluong.Masked = MaskedTextBox.MaskedTextBox.Mask.Decimal;
            this.soluong.Name = "soluong";
            this.soluong.Size = new System.Drawing.Size(66, 21);
            this.soluong.TabIndex = 12;
            this.soluong.TextAlign = System.Windows.Forms.HorizontalAlignment.Right;
            this.soluong.Validated += new System.EventHandler(this.soluong_Validated);
            // 
            // label16
            // 
            this.label16.Location = new System.Drawing.Point(346, 0);
            this.label16.Name = "label16";
            this.label16.Size = new System.Drawing.Size(56, 23);
            this.label16.TabIndex = 63;
            this.label16.Text = "Số lượng :";
            this.label16.TextAlign = System.Drawing.ContentAlignment.MiddleRight;
            // 
            // ldvt
            // 
            this.ldvt.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Right)));
            this.ldvt.Location = new System.Drawing.Point(707, 427);
            this.ldvt.Name = "ldvt";
            this.ldvt.Size = new System.Drawing.Size(39, 23);
            this.ldvt.TabIndex = 57;
            this.ldvt.Text = "ĐVT :";
            this.ldvt.TextAlign = System.Drawing.ContentAlignment.MiddleRight;
            // 
            // cachdung
            // 
            this.cachdung.Anchor = ((System.Windows.Forms.AnchorStyles)(((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)
                        | System.Windows.Forms.AnchorStyles.Right)));
            this.cachdung.BackColor = System.Drawing.SystemColors.HighlightText;
            this.cachdung.Enabled = false;
            this.cachdung.Font = new System.Drawing.Font("Tahoma", 8.25F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.cachdung.Location = new System.Drawing.Point(367, 474);
            this.cachdung.Name = "cachdung";
            this.cachdung.Size = new System.Drawing.Size(345, 21);
            this.cachdung.TabIndex = 19;
            this.cachdung.TextChanged += new System.EventHandler(this.cachdung_TextChanged);
            this.cachdung.Validated += new System.EventHandler(this.cachdung_Validated);
            this.cachdung.KeyDown += new System.Windows.Forms.KeyEventHandler(this.cachdung_KeyDown);
            // 
            // label25
            // 
            this.label25.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.label25.Location = new System.Drawing.Point(276, 474);
            this.label25.Name = "label25";
            this.label25.Size = new System.Drawing.Size(88, 21);
            this.label25.TabIndex = 64;
            this.label25.Text = "Cách dùng :";
            this.label25.TextAlign = System.Drawing.ContentAlignment.MiddleRight;
            // 
            // butKetthuc
            // 
            this.butKetthuc.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.butKetthuc.DialogResult = System.Windows.Forms.DialogResult.Cancel;
            this.butKetthuc.Image = ((System.Drawing.Image)(resources.GetObject("butKetthuc.Image")));
            this.butKetthuc.ImageAlign = System.Drawing.ContentAlignment.MiddleLeft;
            this.butKetthuc.Location = new System.Drawing.Point(725, 522);
            this.butKetthuc.Name = "butKetthuc";
            this.butKetthuc.Size = new System.Drawing.Size(68, 25);
            this.butKetthuc.TabIndex = 29;
            this.butKetthuc.Text = "&Kết thúc";
            this.butKetthuc.TextAlign = System.Drawing.ContentAlignment.MiddleRight;
            this.butKetthuc.Click += new System.EventHandler(this.butKetthuc_Click);
            // 
            // butHuy
            // 
            this.butHuy.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.butHuy.Image = ((System.Drawing.Image)(resources.GetObject("butHuy.Image")));
            this.butHuy.ImageAlign = System.Drawing.ContentAlignment.MiddleLeft;
            this.butHuy.Location = new System.Drawing.Point(536, 522);
            this.butHuy.Name = "butHuy";
            this.butHuy.Size = new System.Drawing.Size(55, 25);
            this.butHuy.TabIndex = 27;
            this.butHuy.Text = "     &Hủy";
            this.butHuy.Click += new System.EventHandler(this.butHuy_Click);
            // 
            // butBoqua
            // 
            this.butBoqua.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.butBoqua.Enabled = false;
            this.butBoqua.Image = ((System.Drawing.Image)(resources.GetObject("butBoqua.Image")));
            this.butBoqua.ImageAlign = System.Drawing.ContentAlignment.MiddleLeft;
            this.butBoqua.Location = new System.Drawing.Point(476, 522);
            this.butBoqua.Name = "butBoqua";
            this.butBoqua.Size = new System.Drawing.Size(60, 25);
            this.butBoqua.TabIndex = 23;
            this.butBoqua.Text = "&Bỏ qua";
            this.butBoqua.TextAlign = System.Drawing.ContentAlignment.MiddleRight;
            this.butBoqua.Click += new System.EventHandler(this.butBoqua_Click);
            // 
            // butXoa
            // 
            this.butXoa.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.butXoa.Enabled = false;
            this.butXoa.Image = ((System.Drawing.Image)(resources.GetObject("butXoa.Image")));
            this.butXoa.ImageAlign = System.Drawing.ContentAlignment.MiddleLeft;
            this.butXoa.Location = new System.Drawing.Point(421, 522);
            this.butXoa.Name = "butXoa";
            this.butXoa.Size = new System.Drawing.Size(55, 25);
            this.butXoa.TabIndex = 21;
            this.butXoa.Text = "    &Xóa";
            this.butXoa.Click += new System.EventHandler(this.butXoa_Click);
            // 
            // butThem
            // 
            this.butThem.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.butThem.Enabled = false;
            this.butThem.Image = ((System.Drawing.Image)(resources.GetObject("butThem.Image")));
            this.butThem.ImageAlign = System.Drawing.ContentAlignment.MiddleLeft;
            this.butThem.Location = new System.Drawing.Point(361, 522);
            this.butThem.Name = "butThem";
            this.butThem.Size = new System.Drawing.Size(60, 25);
            this.butThem.TabIndex = 20;
            this.butThem.Tag = "";
            this.butThem.Text = "&Thêm";
            this.butThem.TextAlign = System.Drawing.ContentAlignment.MiddleRight;
            this.butThem.Click += new System.EventHandler(this.butThem_Click);
            // 
            // butLuu
            // 
            this.butLuu.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.butLuu.Enabled = false;
            this.butLuu.Image = ((System.Drawing.Image)(resources.GetObject("butLuu.Image")));
            this.butLuu.ImageAlign = System.Drawing.ContentAlignment.MiddleLeft;
            this.butLuu.Location = new System.Drawing.Point(306, 522);
            this.butLuu.Name = "butLuu";
            this.butLuu.Size = new System.Drawing.Size(55, 25);
            this.butLuu.TabIndex = 22;
            this.butLuu.Text = "     &Lưu";
            this.butLuu.Click += new System.EventHandler(this.butLuu_Click);
            // 
            // butSua
            // 
            this.butSua.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.butSua.Image = ((System.Drawing.Image)(resources.GetObject("butSua.Image")));
            this.butSua.ImageAlign = System.Drawing.ContentAlignment.MiddleLeft;
            this.butSua.Location = new System.Drawing.Point(251, 522);
            this.butSua.Name = "butSua";
            this.butSua.Size = new System.Drawing.Size(55, 25);
            this.butSua.TabIndex = 26;
            this.butSua.Text = "    &Sửa";
            this.butSua.Click += new System.EventHandler(this.butSua_Click);
            // 
            // butMoi
            // 
            this.butMoi.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.butMoi.Image = ((System.Drawing.Image)(resources.GetObject("butMoi.Image")));
            this.butMoi.ImageAlign = System.Drawing.ContentAlignment.MiddleLeft;
            this.butMoi.Location = new System.Drawing.Point(57, 522);
            this.butMoi.Name = "butMoi";
            this.butMoi.Size = new System.Drawing.Size(60, 25);
            this.butMoi.TabIndex = 24;
            this.butMoi.Text = "Tây y";
            this.butMoi.TextAlign = System.Drawing.ContentAlignment.MiddleRight;
            this.butMoi.Click += new System.EventHandler(this.butMoi_Click);
            // 
            // butCholai
            // 
            this.butCholai.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.butCholai.Enabled = false;
            this.butCholai.Image = ((System.Drawing.Image)(resources.GetObject("butCholai.Image")));
            this.butCholai.ImageAlign = System.Drawing.ContentAlignment.MiddleLeft;
            this.butCholai.Location = new System.Drawing.Point(186, 522);
            this.butCholai.Name = "butCholai";
            this.butCholai.Size = new System.Drawing.Size(65, 25);
            this.butCholai.TabIndex = 25;
            this.butCholai.Text = "&Cho lại";
            this.butCholai.TextAlign = System.Drawing.ContentAlignment.MiddleRight;
            this.butCholai.Click += new System.EventHandler(this.butCholai_Click);
            // 
            // cmbMabn
            // 
            this.cmbMabn.BackColor = System.Drawing.SystemColors.HighlightText;
            this.cmbMabn.DropDownStyle = System.Windows.Forms.ComboBoxStyle.DropDownList;
            this.cmbMabn.Font = new System.Drawing.Font("Tahoma", 8.25F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.cmbMabn.Location = new System.Drawing.Point(64, 4);
            this.cmbMabn.Name = "cmbMabn";
            this.cmbMabn.Size = new System.Drawing.Size(89, 21);
            this.cmbMabn.TabIndex = 0;
            this.cmbMabn.SelectedIndexChanged += new System.EventHandler(this.cmbMabn_SelectedIndexChanged);
            this.cmbMabn.KeyDown += new System.Windows.Forms.KeyEventHandler(this.cmbMabn_KeyDown);
            // 
            // listDmbd
            // 
            this.listDmbd.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.listDmbd.BackColor = System.Drawing.SystemColors.Info;
            this.listDmbd.ColumnCount = 0;
            this.listDmbd.Location = new System.Drawing.Point(77, 560);
            this.listDmbd.MatchBufferTimeOut = 1000;
            this.listDmbd.MatchEntryStyle = AsYetUnnamed.MatchEntryStyle.FirstLetterInsensitive;
            this.listDmbd.Name = "listDmbd";
            this.listDmbd.Size = new System.Drawing.Size(75, 17);
            this.listDmbd.TabIndex = 89;
            this.listDmbd.TextIndex = -1;
            this.listDmbd.TextMember = null;
            this.listDmbd.ValueIndex = -1;
            this.listDmbd.Visible = false;
            this.listDmbd.DoubleClick += new System.EventHandler(this.listDmbd_DoubleClick);
            this.listDmbd.KeyDown += new System.Windows.Forms.KeyEventHandler(this.listDmbd_KeyDown);
            // 
            // listCachdung
            // 
            this.listCachdung.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.listCachdung.BackColor = System.Drawing.SystemColors.Info;
            this.listCachdung.ColumnCount = 0;
            this.listCachdung.Location = new System.Drawing.Point(28, 555);
            this.listCachdung.MatchBufferTimeOut = 1000;
            this.listCachdung.MatchEntryStyle = AsYetUnnamed.MatchEntryStyle.FirstLetterInsensitive;
            this.listCachdung.Name = "listCachdung";
            this.listCachdung.Size = new System.Drawing.Size(75, 17);
            this.listCachdung.TabIndex = 92;
            this.listCachdung.TextIndex = -1;
            this.listCachdung.TextMember = null;
            this.listCachdung.ValueIndex = -1;
            this.listCachdung.Visible = false;
            // 
            // label20
            // 
            this.label20.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.label20.Location = new System.Drawing.Point(25, 474);
            this.label20.Name = "label20";
            this.label20.Size = new System.Drawing.Size(34, 23);
            this.label20.TabIndex = 58;
            this.label20.Text = "Kho :";
            this.label20.TextAlign = System.Drawing.ContentAlignment.MiddleRight;
            // 
            // makho
            // 
            this.makho.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.makho.BackColor = System.Drawing.SystemColors.HighlightText;
            this.makho.DropDownStyle = System.Windows.Forms.ComboBoxStyle.DropDownList;
            this.makho.Enabled = false;
            this.makho.Font = new System.Drawing.Font("Tahoma", 8.25F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.makho.Location = new System.Drawing.Point(59, 474);
            this.makho.Name = "makho";
            this.makho.Size = new System.Drawing.Size(237, 21);
            this.makho.TabIndex = 15;
            // 
            // stt
            // 
            this.stt.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Top | System.Windows.Forms.AnchorStyles.Right)));
            this.stt.Enabled = false;
            this.stt.Location = new System.Drawing.Point(688, 231);
            this.stt.Name = "stt";
            this.stt.Size = new System.Drawing.Size(24, 20);
            this.stt.TabIndex = 53;
            // 
            // diung
            // 
            this.diung.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Top | System.Windows.Forms.AnchorStyles.Right)));
            this.diung.Font = new System.Drawing.Font("Microsoft Sans Serif", 8.25F, System.Drawing.FontStyle.Underline, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.diung.ForeColor = System.Drawing.Color.Blue;
            this.diung.ImageAlign = System.Drawing.ContentAlignment.MiddleLeft;
            this.diung.Location = new System.Drawing.Point(752, 4);
            this.diung.Name = "diung";
            this.diung.Size = new System.Drawing.Size(75, 23);
            this.diung.TabIndex = 33;
            this.diung.Text = "DỊ ỨNG";
            this.diung.TextAlign = System.Drawing.ContentAlignment.MiddleLeft;
            this.diung.Click += new System.EventHandler(this.diung_Click);
            // 
            // mahc
            // 
            this.mahc.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Top | System.Windows.Forms.AnchorStyles.Right)));
            this.mahc.Location = new System.Drawing.Point(701, 195);
            this.mahc.Name = "mahc";
            this.mahc.Size = new System.Drawing.Size(48, 20);
            this.mahc.TabIndex = 50;
            // 
            // label22
            // 
            this.label22.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.label22.Location = new System.Drawing.Point(3, 450);
            this.label22.Name = "label22";
            this.label22.Size = new System.Drawing.Size(56, 23);
            this.label22.TabIndex = 59;
            this.label22.Text = "Nguồn :";
            this.label22.TextAlign = System.Drawing.ContentAlignment.MiddleRight;
            // 
            // manguon
            // 
            this.manguon.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.manguon.BackColor = System.Drawing.SystemColors.HighlightText;
            this.manguon.DropDownStyle = System.Windows.Forms.ComboBoxStyle.DropDownList;
            this.manguon.Enabled = false;
            this.manguon.Font = new System.Drawing.Font("Tahoma", 8.25F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.manguon.Location = new System.Drawing.Point(59, 450);
            this.manguon.Name = "manguon";
            this.manguon.Size = new System.Drawing.Size(100, 21);
            this.manguon.TabIndex = 16;
            // 
            // treeView1
            // 
            this.treeView1.Anchor = ((System.Windows.Forms.AnchorStyles)(((System.Windows.Forms.AnchorStyles.Top | System.Windows.Forms.AnchorStyles.Bottom)
                        | System.Windows.Forms.AnchorStyles.Right)));
            this.treeView1.Font = new System.Drawing.Font("Tahoma", 8.25F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.treeView1.ItemHeight = 16;
            this.treeView1.Location = new System.Drawing.Point(628, 159);
            this.treeView1.Name = "treeView1";
            this.treeView1.Size = new System.Drawing.Size(161, 265);
            this.treeView1.TabIndex = 49;
            this.toolTip1.SetToolTip(this.treeView1, "F7 Cho lại");
            this.treeView1.AfterSelect += new System.Windows.Forms.TreeViewEventHandler(this.treeView1_AfterSelect);
            this.treeView1.KeyDown += new System.Windows.Forms.KeyEventHandler(this.treeView1_KeyDown);
            // 
            // namsinh
            // 
            this.namsinh.BackColor = System.Drawing.SystemColors.HighlightText;
            this.namsinh.Enabled = false;
            this.namsinh.Font = new System.Drawing.Font("Tahoma", 8.25F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.namsinh.Location = new System.Drawing.Point(496, 4);
            this.namsinh.Name = "namsinh";
            this.namsinh.Size = new System.Drawing.Size(32, 21);
            this.namsinh.TabIndex = 3;
            // 
            // sothe
            // 
            this.sothe.Anchor = ((System.Windows.Forms.AnchorStyles)(((System.Windows.Forms.AnchorStyles.Top | System.Windows.Forms.AnchorStyles.Left)
                        | System.Windows.Forms.AnchorStyles.Right)));
            this.sothe.BackColor = System.Drawing.SystemColors.HighlightText;
            this.sothe.Enabled = false;
            this.sothe.Font = new System.Drawing.Font("Tahoma", 8.25F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.sothe.Location = new System.Drawing.Point(568, 4);
            this.sothe.Name = "sothe";
            this.sothe.Size = new System.Drawing.Size(176, 21);
            this.sothe.TabIndex = 4;
            // 
            // chandoan
            // 
            this.chandoan.BackColor = System.Drawing.SystemColors.HighlightText;
            this.chandoan.Enabled = false;
            this.chandoan.Font = new System.Drawing.Font("Tahoma", 8.25F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.chandoan.Location = new System.Drawing.Point(64, 27);
            this.chandoan.Name = "chandoan";
            this.chandoan.Size = new System.Drawing.Size(320, 21);
            this.chandoan.TabIndex = 5;
            // 
            // maicd
            // 
            this.maicd.BackColor = System.Drawing.SystemColors.HighlightText;
            this.maicd.Enabled = false;
            this.maicd.Font = new System.Drawing.Font("Tahoma", 8.25F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.maicd.Location = new System.Drawing.Point(386, 27);
            this.maicd.Name = "maicd";
            this.maicd.Size = new System.Drawing.Size(38, 21);
            this.maicd.TabIndex = 6;
            // 
            // tenpk
            // 
            this.tenpk.BackColor = System.Drawing.SystemColors.HighlightText;
            this.tenpk.Enabled = false;
            this.tenpk.Font = new System.Drawing.Font("Tahoma", 8.25F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.tenpk.Location = new System.Drawing.Point(496, 27);
            this.tenpk.Name = "tenpk";
            this.tenpk.Size = new System.Drawing.Size(96, 21);
            this.tenpk.TabIndex = 7;
            // 
            // tenbs
            // 
            this.tenbs.Anchor = ((System.Windows.Forms.AnchorStyles)(((System.Windows.Forms.AnchorStyles.Top | System.Windows.Forms.AnchorStyles.Left)
                        | System.Windows.Forms.AnchorStyles.Right)));
            this.tenbs.BackColor = System.Drawing.SystemColors.HighlightText;
            this.tenbs.Enabled = false;
            this.tenbs.Font = new System.Drawing.Font("Tahoma", 8.25F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.tenbs.Location = new System.Drawing.Point(632, 27);
            this.tenbs.Name = "tenbs";
            this.tenbs.Size = new System.Drawing.Size(156, 21);
            this.tenbs.TabIndex = 8;
            this.tenbs.TextChanged += new System.EventHandler(this.tenbs_TextChanged);
            this.tenbs.KeyDown += new System.Windows.Forms.KeyEventHandler(this.tenbs_KeyDown);
            // 
            // label3
            // 
            this.label3.Location = new System.Drawing.Point(432, 5);
            this.label3.Name = "label3";
            this.label3.Size = new System.Drawing.Size(64, 23);
            this.label3.TabIndex = 29;
            this.label3.Text = "Năm sinh :";
            this.label3.TextAlign = System.Drawing.ContentAlignment.MiddleRight;
            // 
            // label4
            // 
            this.label4.Location = new System.Drawing.Point(524, 5);
            this.label4.Name = "label4";
            this.label4.Size = new System.Drawing.Size(48, 23);
            this.label4.TabIndex = 31;
            this.label4.Text = "Số thẻ :";
            this.label4.TextAlign = System.Drawing.ContentAlignment.MiddleRight;
            // 
            // label5
            // 
            this.label5.Location = new System.Drawing.Point(-11, 27);
            this.label5.Name = "label5";
            this.label5.Size = new System.Drawing.Size(75, 23);
            this.label5.TabIndex = 34;
            this.label5.Text = "Chẩn đoán :";
            this.label5.TextAlign = System.Drawing.ContentAlignment.MiddleRight;
            // 
            // label6
            // 
            this.label6.Location = new System.Drawing.Point(416, 27);
            this.label6.Name = "label6";
            this.label6.Size = new System.Drawing.Size(80, 23);
            this.label6.TabIndex = 37;
            this.label6.Text = "Khoa/phòng :";
            this.label6.TextAlign = System.Drawing.ContentAlignment.MiddleRight;
            // 
            // lblbacsy
            // 
            this.lblbacsy.Location = new System.Drawing.Point(593, 27);
            this.lblbacsy.Name = "lblbacsy";
            this.lblbacsy.Size = new System.Drawing.Size(45, 23);
            this.lblbacsy.TabIndex = 39;
            this.lblbacsy.Text = "Bác sỹ :";
            this.lblbacsy.TextAlign = System.Drawing.ContentAlignment.MiddleLeft;
            // 
            // butIn
            // 
            this.butIn.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.butIn.Image = ((System.Drawing.Image)(resources.GetObject("butIn.Image")));
            this.butIn.ImageAlign = System.Drawing.ContentAlignment.MiddleLeft;
            this.butIn.Location = new System.Drawing.Point(591, 522);
            this.butIn.Name = "butIn";
            this.butIn.Size = new System.Drawing.Size(55, 25);
            this.butIn.TabIndex = 28;
            this.butIn.Text = "     &In";
            this.butIn.Click += new System.EventHandler(this.butIn_Click);
            // 
            // butHen
            // 
            this.butHen.Image = ((System.Drawing.Image)(resources.GetObject("butHen.Image")));
            this.butHen.ImageAlign = System.Drawing.ContentAlignment.MiddleLeft;
            this.butHen.Location = new System.Drawing.Point(387, 3);
            this.butHen.Name = "butHen";
            this.butHen.Size = new System.Drawing.Size(50, 23);
            this.butHen.TabIndex = 28;
            this.butHen.Text = "Hẹn";
            this.butHen.TextAlign = System.Drawing.ContentAlignment.MiddleRight;
            this.butHen.Visible = false;
            this.butHen.Click += new System.EventHandler(this.butHen_Click);
            // 
            // lghichu
            // 
            this.lghichu.Location = new System.Drawing.Point(-8, 71);
            this.lghichu.Name = "lghichu";
            this.lghichu.Size = new System.Drawing.Size(71, 23);
            this.lghichu.TabIndex = 47;
            this.lghichu.Text = "Ghi chú :";
            this.lghichu.TextAlign = System.Drawing.ContentAlignment.MiddleRight;
            // 
            // ghichu
            // 
            this.ghichu.Anchor = ((System.Windows.Forms.AnchorStyles)(((System.Windows.Forms.AnchorStyles.Top | System.Windows.Forms.AnchorStyles.Left)
                        | System.Windows.Forms.AnchorStyles.Right)));
            this.ghichu.BackColor = System.Drawing.SystemColors.HighlightText;
            this.ghichu.Enabled = false;
            this.ghichu.Font = new System.Drawing.Font("Tahoma", 8.25F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.ghichu.Location = new System.Drawing.Point(64, 95);
            this.ghichu.Multiline = true;
            this.ghichu.Name = "ghichu";
            this.ghichu.ScrollBars = System.Windows.Forms.ScrollBars.Both;
            this.ghichu.Size = new System.Drawing.Size(725, 39);
            this.ghichu.TabIndex = 11;
            this.ghichu.TextChanged += new System.EventHandler(this.ghichu_TextChanged);
            // 
            // chkVP
            // 
            this.chkVP.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.chkVP.Location = new System.Drawing.Point(477, 500);
            this.chkVP.Name = "chkVP";
            this.chkVP.Size = new System.Drawing.Size(150, 17);
            this.chkVP.TabIndex = 48;
            this.chkVP.Text = "In kèm theo chỉ định";
            // 
            // songay
            // 
            this.songay.BackColor = System.Drawing.SystemColors.HighlightText;
            this.songay.Enabled = false;
            this.songay.Font = new System.Drawing.Font("Tahoma", 8.25F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.songay.Location = new System.Drawing.Point(64, 50);
            this.songay.Name = "songay";
            this.songay.Size = new System.Drawing.Size(39, 21);
            this.songay.TabIndex = 9;
            this.songay.ValueChanged += new System.EventHandler(this.songay_ValueChanged);
            this.songay.KeyDown += new System.Windows.Forms.KeyEventHandler(this.ghichu_KeyDown);
            // 
            // label9
            // 
            this.label9.Location = new System.Drawing.Point(104, 51);
            this.label9.Name = "label9";
            this.label9.Size = new System.Drawing.Size(49, 16);
            this.label9.TabIndex = 46;
            this.label9.Text = "ngày";
            this.label9.TextAlign = System.Drawing.ContentAlignment.MiddleLeft;
            // 
            // label10
            // 
            this.label10.Location = new System.Drawing.Point(3, 49);
            this.label10.Name = "label10";
            this.label10.Size = new System.Drawing.Size(61, 23);
            this.label10.TabIndex = 44;
            this.label10.Text = "Cấp :";
            this.label10.TextAlign = System.Drawing.ContentAlignment.MiddleRight;
            // 
            // label11
            // 
            this.label11.Location = new System.Drawing.Point(-4, 1);
            this.label11.Name = "label11";
            this.label11.Size = new System.Drawing.Size(41, 22);
            this.label11.TabIndex = 60;
            this.label11.Text = "Ngày :";
            this.label11.TextAlign = System.Drawing.ContentAlignment.MiddleRight;
            // 
            // solan
            // 
            this.solan.BackColor = System.Drawing.SystemColors.HighlightText;
            this.solan.Enabled = false;
            this.solan.Font = new System.Drawing.Font("Tahoma", 8.25F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.solan.Location = new System.Drawing.Point(38, 2);
            this.solan.Maximum = new decimal(new int[] {
            99,
            0,
            0,
            0});
            this.solan.Minimum = new decimal(new int[] {
            1,
            0,
            0,
            0});
            this.solan.Name = "solan";
            this.solan.Size = new System.Drawing.Size(33, 21);
            this.solan.TabIndex = 10;
            this.solan.Value = new decimal(new int[] {
            1,
            0,
            0,
            0});
            this.solan.Validated += new System.EventHandler(this.solan_Validated);
            this.solan.KeyDown += new System.Windows.Forms.KeyEventHandler(this.ghichu_KeyDown);
            // 
            // makp
            // 
            this.makp.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Top | System.Windows.Forms.AnchorStyles.Right)));
            this.makp.Enabled = false;
            this.makp.Location = new System.Drawing.Point(666, 205);
            this.makp.Name = "makp";
            this.makp.Size = new System.Drawing.Size(46, 20);
            this.makp.TabIndex = 51;
            // 
            // mabs
            // 
            this.mabs.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Top | System.Windows.Forms.AnchorStyles.Right)));
            this.mabs.Enabled = false;
            this.mabs.Location = new System.Drawing.Point(696, 205);
            this.mabs.Name = "mabs";
            this.mabs.Size = new System.Drawing.Size(33, 20);
            this.mabs.TabIndex = 52;
            // 
            // label12
            // 
            this.label12.Location = new System.Drawing.Point(73, 2);
            this.label12.Name = "label12";
            this.label12.Size = new System.Drawing.Size(123, 20);
            this.label12.TabIndex = 61;
            this.label12.Text = "lần , lần :";
            this.label12.TextAlign = System.Drawing.ContentAlignment.MiddleLeft;
            // 
            // moilan
            // 
            this.moilan.BackColor = System.Drawing.SystemColors.HighlightText;
            this.moilan.Enabled = false;
            this.moilan.Font = new System.Drawing.Font("Tahoma", 8.25F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.moilan.Location = new System.Drawing.Point(199, 2);
            this.moilan.Masked = MaskedTextBox.MaskedTextBox.Mask.Decimal;
            this.moilan.Name = "moilan";
            this.moilan.Size = new System.Drawing.Size(70, 21);
            this.moilan.TabIndex = 11;
            this.moilan.TextAlign = System.Windows.Forms.HorizontalAlignment.Right;
            this.moilan.Validated += new System.EventHandler(this.solan_Validated);
            // 
            // lbldvt
            // 
            this.lbldvt.Location = new System.Drawing.Point(275, 1);
            this.lbldvt.Name = "lbldvt";
            this.lbldvt.Size = new System.Drawing.Size(59, 21);
            this.lbldvt.TabIndex = 62;
            this.lbldvt.Text = "viên";
            this.lbldvt.TextAlign = System.Drawing.ContentAlignment.MiddleLeft;
            // 
            // donthuoc
            // 
            this.donthuoc.Anchor = ((System.Windows.Forms.AnchorStyles)(((System.Windows.Forms.AnchorStyles.Top | System.Windows.Forms.AnchorStyles.Left)
                        | System.Windows.Forms.AnchorStyles.Right)));
            this.donthuoc.BackColor = System.Drawing.SystemColors.HighlightText;
            this.donthuoc.DropDownStyle = System.Windows.Forms.ComboBoxStyle.DropDownList;
            this.donthuoc.Enabled = false;
            this.donthuoc.Font = new System.Drawing.Font("Tahoma", 8.25F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.donthuoc.Location = new System.Drawing.Point(150, 50);
            this.donthuoc.Name = "donthuoc";
            this.donthuoc.Size = new System.Drawing.Size(480, 21);
            this.donthuoc.TabIndex = 93;
            this.donthuoc.SelectedIndexChanged += new System.EventHandler(this.donthuoc_SelectedIndexChanged);
            // 
            // chkChon
            // 
            this.chkChon.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Top | System.Windows.Forms.AnchorStyles.Right)));
            this.chkChon.Appearance = System.Windows.Forms.Appearance.Button;
            this.chkChon.AutoSize = true;
            this.chkChon.Enabled = false;
            this.chkChon.Location = new System.Drawing.Point(747, 48);
            this.chkChon.Name = "chkChon";
            this.chkChon.Size = new System.Drawing.Size(42, 23);
            this.chkChon.TabIndex = 94;
            this.chkChon.Text = "Chọn";
            this.chkChon.UseVisualStyleBackColor = true;
            this.chkChon.CheckedChanged += new System.EventHandler(this.chkChon_CheckedChanged);
            // 
            // chkDongia
            // 
            this.chkDongia.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.chkDongia.AutoSize = true;
            this.chkDongia.Checked = true;
            this.chkDongia.CheckState = System.Windows.Forms.CheckState.Checked;
            this.chkDongia.Location = new System.Drawing.Point(316, 500);
            this.chkDongia.Name = "chkDongia";
            this.chkDongia.Size = new System.Drawing.Size(86, 17);
            this.chkDongia.TabIndex = 95;
            this.chkDongia.Text = "Kèm đơn giá";
            this.chkDongia.UseVisualStyleBackColor = true;
            // 
            // chkXML
            // 
            this.chkXML.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.chkXML.AutoSize = true;
            this.chkXML.Location = new System.Drawing.Point(704, 500);
            this.chkXML.Name = "chkXML";
            this.chkXML.Size = new System.Drawing.Size(85, 17);
            this.chkXML.TabIndex = 96;
            this.chkXML.Text = "Xuất ra XML";
            this.chkXML.UseVisualStyleBackColor = true;
            // 
            // chkXem
            // 
            this.chkXem.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.chkXem.AutoSize = true;
            this.chkXem.Location = new System.Drawing.Point(598, 500);
            this.chkXem.Name = "chkXem";
            this.chkXem.Size = new System.Drawing.Size(102, 17);
            this.chkXem.TabIndex = 97;
            this.chkXem.Text = "Xem trước khi in";
            this.chkXem.UseVisualStyleBackColor = true;
            // 
            // sum
            // 
            this.sum.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Right)));
            this.sum.BackColor = System.Drawing.SystemColors.HighlightText;
            this.sum.Enabled = false;
            this.sum.Font = new System.Drawing.Font("Tahoma", 9F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.sum.Location = new System.Drawing.Point(446, 402);
            this.sum.Masked = MaskedTextBox.MaskedTextBox.Mask.Decimal;
            this.sum.Name = "sum";
            this.sum.Size = new System.Drawing.Size(179, 22);
            this.sum.TabIndex = 98;
            this.sum.TextAlign = System.Windows.Forms.HorizontalAlignment.Right;
            // 
            // lblsum
            // 
            this.lblsum.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Right)));
            this.lblsum.Location = new System.Drawing.Point(360, 402);
            this.lblsum.Name = "lblsum";
            this.lblsum.Size = new System.Drawing.Size(88, 23);
            this.lblsum.TabIndex = 99;
            this.lblsum.Text = "Tổng số tiền :";
            this.lblsum.TextAlign = System.Drawing.ContentAlignment.MiddleRight;
            // 
            // p1
            // 
            this.p1.Anchor = ((System.Windows.Forms.AnchorStyles)(((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)
                        | System.Windows.Forms.AnchorStyles.Right)));
            this.p1.Controls.Add(this.soluong);
            this.p1.Controls.Add(this.label16);
            this.p1.Controls.Add(this.moilan);
            this.p1.Controls.Add(this.label11);
            this.p1.Controls.Add(this.solan);
            this.p1.Controls.Add(this.label12);
            this.p1.Controls.Add(this.lbldvt);
            this.p1.Location = new System.Drawing.Point(168, 449);
            this.p1.Name = "p1";
            this.p1.Size = new System.Drawing.Size(620, 24);
            this.p1.TabIndex = 17;
            // 
            // p2
            // 
            this.p2.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.p2.Controls.Add(this.c4);
            this.p2.Controls.Add(this.label19);
            this.p2.Controls.Add(this.soluong1);
            this.p2.Controls.Add(this.chk2);
            this.p2.Controls.Add(this.chk1);
            this.p2.Controls.Add(this.label18);
            this.p2.Controls.Add(this.c3);
            this.p2.Controls.Add(this.label17);
            this.p2.Controls.Add(this.c2);
            this.p2.Controls.Add(this.label15);
            this.p2.Controls.Add(this.c1);
            this.p2.Controls.Add(this.label14);
            this.p2.Controls.Add(this.lblduongdung);
            this.p2.Location = new System.Drawing.Point(166, 448);
            this.p2.Name = "p2";
            this.p2.Size = new System.Drawing.Size(673, 24);
            this.p2.TabIndex = 18;
            // 
            // c4
            // 
            this.c4.BackColor = System.Drawing.SystemColors.HighlightText;
            this.c4.Enabled = false;
            this.c4.Font = new System.Drawing.Font("Tahoma", 8.25F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.c4.Location = new System.Drawing.Point(340, 2);
            this.c4.Masked = MaskedTextBox.MaskedTextBox.Mask.Decimal;
            this.c4.Name = "c4";
            this.c4.Size = new System.Drawing.Size(35, 21);
            this.c4.TabIndex = 3;
            this.c4.TextAlign = System.Windows.Forms.HorizontalAlignment.Right;
            this.c4.Validated += new System.EventHandler(this.c4_Validated);
            // 
            // label19
            // 
            this.label19.Location = new System.Drawing.Point(365, 2);
            this.label19.Name = "label19";
            this.label19.Size = new System.Drawing.Size(66, 21);
            this.label19.TabIndex = 76;
            this.label19.Text = "Số lượng :";
            this.label19.TextAlign = System.Drawing.ContentAlignment.MiddleRight;
            // 
            // soluong1
            // 
            this.soluong1.BackColor = System.Drawing.SystemColors.HighlightText;
            this.soluong1.Enabled = false;
            this.soluong1.Font = new System.Drawing.Font("Tahoma", 8.25F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.soluong1.Location = new System.Drawing.Point(432, 2);
            this.soluong1.Masked = MaskedTextBox.MaskedTextBox.Mask.Decimal;
            this.soluong1.Name = "soluong1";
            this.soluong1.Size = new System.Drawing.Size(56, 21);
            this.soluong1.TabIndex = 4;
            this.soluong1.TextAlign = System.Windows.Forms.HorizontalAlignment.Right;
            this.soluong1.Validated += new System.EventHandler(this.soluong1_Validated);
            // 
            // chk2
            // 
            this.chk2.AutoSize = true;
            this.chk2.Enabled = false;
            this.chk2.Location = new System.Drawing.Point(566, 4);
            this.chk2.Name = "chk2";
            this.chk2.Size = new System.Drawing.Size(60, 17);
            this.chk2.TabIndex = 6;
            this.chk2.Text = "Sau ăn";
            this.chk2.UseVisualStyleBackColor = true;
            this.chk2.CheckedChanged += new System.EventHandler(this.chk2_CheckedChanged);
            this.chk2.KeyDown += new System.Windows.Forms.KeyEventHandler(this.ghichu_KeyDown);
            // 
            // chk1
            // 
            this.chk1.AutoSize = true;
            this.chk1.Enabled = false;
            this.chk1.Location = new System.Drawing.Point(494, 4);
            this.chk1.Name = "chk1";
            this.chk1.Size = new System.Drawing.Size(69, 17);
            this.chk1.TabIndex = 5;
            this.chk1.Text = "Trước ăn";
            this.chk1.UseVisualStyleBackColor = true;
            this.chk1.CheckedChanged += new System.EventHandler(this.chk1_CheckedChanged);
            this.chk1.KeyDown += new System.Windows.Forms.KeyEventHandler(this.ghichu_KeyDown);
            // 
            // label18
            // 
            this.label18.Location = new System.Drawing.Point(317, 2);
            this.label18.Name = "label18";
            this.label18.Size = new System.Drawing.Size(35, 21);
            this.label18.TabIndex = 70;
            this.label18.Text = "tối :";
            this.label18.TextAlign = System.Drawing.ContentAlignment.MiddleLeft;
            // 
            // c3
            // 
            this.c3.BackColor = System.Drawing.SystemColors.HighlightText;
            this.c3.Enabled = false;
            this.c3.Font = new System.Drawing.Font("Tahoma", 8.25F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.c3.Location = new System.Drawing.Point(280, 2);
            this.c3.Masked = MaskedTextBox.MaskedTextBox.Mask.Decimal;
            this.c3.Name = "c3";
            this.c3.Size = new System.Drawing.Size(35, 21);
            this.c3.TabIndex = 2;
            this.c3.TextAlign = System.Windows.Forms.HorizontalAlignment.Right;
            this.c3.Validated += new System.EventHandler(this.c3_Validated);
            // 
            // label17
            // 
            this.label17.Location = new System.Drawing.Point(241, 2);
            this.label17.Name = "label17";
            this.label17.Size = new System.Drawing.Size(53, 21);
            this.label17.TabIndex = 68;
            this.label17.Text = "chiều :";
            this.label17.TextAlign = System.Drawing.ContentAlignment.MiddleLeft;
            // 
            // c2
            // 
            this.c2.BackColor = System.Drawing.SystemColors.HighlightText;
            this.c2.Enabled = false;
            this.c2.Font = new System.Drawing.Font("Tahoma", 8.25F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.c2.Location = new System.Drawing.Point(201, 2);
            this.c2.Masked = MaskedTextBox.MaskedTextBox.Mask.Decimal;
            this.c2.Name = "c2";
            this.c2.Size = new System.Drawing.Size(35, 21);
            this.c2.TabIndex = 1;
            this.c2.TextAlign = System.Windows.Forms.HorizontalAlignment.Right;
            this.c2.Validated += new System.EventHandler(this.c2_Validated);
            // 
            // label15
            // 
            this.label15.Location = new System.Drawing.Point(170, 2);
            this.label15.Name = "label15";
            this.label15.Size = new System.Drawing.Size(53, 21);
            this.label15.TabIndex = 66;
            this.label15.Text = "trưa :";
            this.label15.TextAlign = System.Drawing.ContentAlignment.MiddleLeft;
            // 
            // c1
            // 
            this.c1.BackColor = System.Drawing.SystemColors.HighlightText;
            this.c1.Enabled = false;
            this.c1.Font = new System.Drawing.Font("Tahoma", 8.25F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.c1.Location = new System.Drawing.Point(132, 2);
            this.c1.Masked = MaskedTextBox.MaskedTextBox.Mask.Decimal;
            this.c1.Name = "c1";
            this.c1.Size = new System.Drawing.Size(35, 21);
            this.c1.TabIndex = 0;
            this.c1.TextAlign = System.Windows.Forms.HorizontalAlignment.Right;
            this.c1.Validated += new System.EventHandler(this.c1_Validated);
            // 
            // label14
            // 
            this.label14.Location = new System.Drawing.Point(96, 2);
            this.label14.Name = "label14";
            this.label14.Size = new System.Drawing.Size(49, 21);
            this.label14.TabIndex = 64;
            this.label14.Text = "sáng :";
            this.label14.TextAlign = System.Drawing.ContentAlignment.MiddleLeft;
            // 
            // lblduongdung
            // 
            this.lblduongdung.Location = new System.Drawing.Point(3, 2);
            this.lblduongdung.Name = "lblduongdung";
            this.lblduongdung.Size = new System.Drawing.Size(87, 21);
            this.lblduongdung.TabIndex = 63;
            this.lblduongdung.Text = "lblduongdung";
            this.lblduongdung.TextAlign = System.Drawing.ContentAlignment.MiddleLeft;
            // 
            // listHoten
            // 
            this.listHoten.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.listHoten.BackColor = System.Drawing.SystemColors.Info;
            this.listHoten.ColumnCount = 0;
            this.listHoten.Location = new System.Drawing.Point(550, 555);
            this.listHoten.MatchBufferTimeOut = 1000;
            this.listHoten.MatchEntryStyle = AsYetUnnamed.MatchEntryStyle.FirstLetterInsensitive;
            this.listHoten.Name = "listHoten";
            this.listHoten.Size = new System.Drawing.Size(75, 17);
            this.listHoten.TabIndex = 100;
            this.listHoten.TextIndex = -1;
            this.listHoten.TextMember = null;
            this.listHoten.ValueIndex = -1;
            this.listHoten.Visible = false;
            this.listHoten.KeyDown += new System.Windows.Forms.KeyEventHandler(this.listHoten_KeyDown);
            // 
            // listBS
            // 
            this.listBS.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.listBS.BackColor = System.Drawing.SystemColors.Info;
            this.listBS.ColumnCount = 0;
            this.listBS.Location = new System.Drawing.Point(701, 555);
            this.listBS.MatchBufferTimeOut = 1000;
            this.listBS.MatchEntryStyle = AsYetUnnamed.MatchEntryStyle.FirstLetterInsensitive;
            this.listBS.Name = "listBS";
            this.listBS.Size = new System.Drawing.Size(75, 17);
            this.listBS.TabIndex = 265;
            this.listBS.TextIndex = -1;
            this.listBS.TextMember = null;
            this.listBS.ValueIndex = -1;
            this.listBS.Visible = false;
            // 
            // madoituong
            // 
            this.madoituong.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.madoituong.BackColor = System.Drawing.SystemColors.HighlightText;
            this.madoituong.DropDownStyle = System.Windows.Forms.ComboBoxStyle.DropDownList;
            this.madoituong.Enabled = false;
            this.madoituong.Font = new System.Drawing.Font("Tahoma", 8.25F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.madoituong.Location = new System.Drawing.Point(59, 427);
            this.madoituong.Name = "madoituong";
            this.madoituong.Size = new System.Drawing.Size(86, 21);
            this.madoituong.TabIndex = 12;
            this.madoituong.KeyDown += new System.Windows.Forms.KeyEventHandler(this.madoituong_KeyDown);
            // 
            // label13
            // 
            this.label13.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.label13.Location = new System.Drawing.Point(-17, 424);
            this.label13.Name = "label13";
            this.label13.Size = new System.Drawing.Size(76, 23);
            this.label13.TabIndex = 267;
            this.label13.Text = "Đối tượng :";
            this.label13.TextAlign = System.Drawing.ContentAlignment.MiddleRight;
            // 
            // chkThuoc
            // 
            this.chkThuoc.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Top | System.Windows.Forms.AnchorStyles.Right)));
            this.chkThuoc.AutoSize = true;
            this.chkThuoc.Location = new System.Drawing.Point(630, 140);
            this.chkThuoc.Name = "chkThuoc";
            this.chkThuoc.Size = new System.Drawing.Size(134, 17);
            this.chkThuoc.TabIndex = 268;
            this.chkThuoc.Text = "Xem thuốc đã sử dụng";
            this.chkThuoc.UseVisualStyleBackColor = true;
            this.chkThuoc.CheckedChanged += new System.EventHandler(this.chkThuoc_CheckedChanged);
            // 
            // dang
            // 
            this.dang.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Right)));
            this.dang.BackColor = System.Drawing.SystemColors.HighlightText;
            this.dang.Enabled = false;
            this.dang.Font = new System.Drawing.Font("Tahoma", 8.25F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.dang.Location = new System.Drawing.Point(746, 425);
            this.dang.Name = "dang";
            this.dang.Size = new System.Drawing.Size(41, 21);
            this.dang.TabIndex = 15;
            this.dang.KeyDown += new System.Windows.Forms.KeyEventHandler(this.tenhc_KeyDown);
            // 
            // butTuongtac
            // 
            this.butTuongtac.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.butTuongtac.Image = ((System.Drawing.Image)(resources.GetObject("butTuongtac.Image")));
            this.butTuongtac.ImageAlign = System.Drawing.ContentAlignment.MiddleLeft;
            this.butTuongtac.Location = new System.Drawing.Point(646, 522);
            this.butTuongtac.Name = "butTuongtac";
            this.butTuongtac.Size = new System.Drawing.Size(79, 25);
            this.butTuongtac.TabIndex = 269;
            this.butTuongtac.Text = "Tương tác";
            this.butTuongtac.TextAlign = System.Drawing.ContentAlignment.MiddleRight;
            this.butTuongtac.Click += new System.EventHandler(this.butTuongtac_Click);
            // 
            // butGoi
            // 
            this.butGoi.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.butGoi.Enabled = false;
            this.butGoi.Image = ((System.Drawing.Image)(resources.GetObject("butGoi.Image")));
            this.butGoi.ImageAlign = System.Drawing.ContentAlignment.MiddleLeft;
            this.butGoi.Location = new System.Drawing.Point(2, 522);
            this.butGoi.Name = "butGoi";
            this.butGoi.Size = new System.Drawing.Size(55, 25);
            this.butGoi.TabIndex = 273;
            this.butGoi.Text = "     &Gói";
            this.butGoi.Click += new System.EventHandler(this.butGoi_Click);
            // 
            // chkChitiet
            // 
            this.chkChitiet.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Top | System.Windows.Forms.AnchorStyles.Right)));
            this.chkChitiet.Checked = true;
            this.chkChitiet.CheckState = System.Windows.Forms.CheckState.Checked;
            this.chkChitiet.Location = new System.Drawing.Point(680, 322);
            this.chkChitiet.Name = "chkChitiet";
            this.chkChitiet.Size = new System.Drawing.Size(45, 17);
            this.chkChitiet.TabIndex = 274;
            this.chkChitiet.Text = "Số ngày cấp đơn phân bổ chi tiết";
            this.chkChitiet.UseVisualStyleBackColor = true;
            this.chkChitiet.CheckedChanged += new System.EventHandler(this.chkChitiet_CheckedChanged);
            // 
            // huyet
            // 
            this.huyet.Anchor = ((System.Windows.Forms.AnchorStyles)(((System.Windows.Forms.AnchorStyles.Top | System.Windows.Forms.AnchorStyles.Left)
                        | System.Windows.Forms.AnchorStyles.Right)));
            this.huyet.BackColor = System.Drawing.SystemColors.HighlightText;
            this.huyet.DropDownStyle = System.Windows.Forms.ComboBoxStyle.DropDownList;
            this.huyet.Enabled = false;
            this.huyet.Font = new System.Drawing.Font("Tahoma", 8.25F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.huyet.Location = new System.Drawing.Point(64, 72);
            this.huyet.Name = "huyet";
            this.huyet.Size = new System.Drawing.Size(682, 21);
            this.huyet.TabIndex = 10;
            this.huyet.SelectedIndexChanged += new System.EventHandler(this.huyet_SelectedIndexChanged);
            // 
            // chkHuyet
            // 
            this.chkHuyet.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Top | System.Windows.Forms.AnchorStyles.Right)));
            this.chkHuyet.Appearance = System.Windows.Forms.Appearance.Button;
            this.chkHuyet.AutoSize = true;
            this.chkHuyet.Enabled = false;
            this.chkHuyet.Location = new System.Drawing.Point(747, 71);
            this.chkHuyet.Name = "chkHuyet";
            this.chkHuyet.Size = new System.Drawing.Size(42, 23);
            this.chkHuyet.TabIndex = 275;
            this.chkHuyet.Text = "Chọn";
            this.chkHuyet.UseVisualStyleBackColor = true;
            this.chkHuyet.CheckedChanged += new System.EventHandler(this.chkHuyet_CheckedChanged);
            // 
            // tim
            // 
            this.tim.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Top | System.Windows.Forms.AnchorStyles.Right)));
            this.tim.BackColor = System.Drawing.SystemColors.HighlightText;
            this.tim.Enabled = false;
            this.tim.Font = new System.Drawing.Font("Tahoma", 8.25F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.tim.ForeColor = System.Drawing.Color.Red;
            this.tim.Location = new System.Drawing.Point(632, 50);
            this.tim.Name = "tim";
            this.tim.Size = new System.Drawing.Size(114, 21);
            this.tim.TabIndex = 276;
            this.tim.Text = "Tìm kiếm";
            this.tim.TextAlign = System.Windows.Forms.HorizontalAlignment.Center;
            this.tim.TextChanged += new System.EventHandler(this.tim_TextChanged);
            this.tim.Enter += new System.EventHandler(this.tim_Enter);
            // 
            // butDongy
            // 
            this.butDongy.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.butDongy.Image = ((System.Drawing.Image)(resources.GetObject("butDongy.Image")));
            this.butDongy.ImageAlign = System.Drawing.ContentAlignment.MiddleLeft;
            this.butDongy.Location = new System.Drawing.Point(117, 522);
            this.butDongy.Name = "butDongy";
            this.butDongy.Size = new System.Drawing.Size(69, 25);
            this.butDongy.TabIndex = 277;
            this.butDongy.Text = "Đông y";
            this.butDongy.TextAlign = System.Drawing.ContentAlignment.MiddleRight;
            this.butDongy.Click += new System.EventHandler(this.butDongy_Click);
            // 
            // label7
            // 
            this.label7.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.label7.Location = new System.Drawing.Point(-8, 494);
            this.label7.Name = "label7";
            this.label7.Size = new System.Drawing.Size(67, 23);
            this.label7.TabIndex = 278;
            this.label7.Text = "Số bản in :";
            this.label7.TextAlign = System.Drawing.ContentAlignment.MiddleRight;
            // 
            // banin
            // 
            this.banin.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.banin.Font = new System.Drawing.Font("Tahoma", 8.25F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.banin.Location = new System.Drawing.Point(59, 497);
            this.banin.Name = "banin";
            this.banin.Size = new System.Drawing.Size(44, 21);
            this.banin.TabIndex = 279;
            // 
            // chkLuuin
            // 
            this.chkLuuin.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.chkLuuin.AutoSize = true;
            this.chkLuuin.Checked = true;
            this.chkLuuin.CheckState = System.Windows.Forms.CheckState.Checked;
            this.chkLuuin.Location = new System.Drawing.Point(239, 501);
            this.chkLuuin.Name = "chkLuuin";
            this.chkLuuin.Size = new System.Drawing.Size(70, 17);
            this.chkLuuin.TabIndex = 280;
            this.chkLuuin.Text = "Lưu và in";
            this.chkLuuin.UseVisualStyleBackColor = true;
            this.chkLuuin.CheckedChanged += new System.EventHandler(this.chkLuuin_CheckedChanged);
            // 
            // dataGrid1
            // 
            this.dataGrid1.AlternatingBackColor = System.Drawing.Color.Lavender;
            this.dataGrid1.Anchor = ((System.Windows.Forms.AnchorStyles)((((System.Windows.Forms.AnchorStyles.Top | System.Windows.Forms.AnchorStyles.Bottom)
                        | System.Windows.Forms.AnchorStyles.Left)
                        | System.Windows.Forms.AnchorStyles.Right)));
            this.dataGrid1.BackColor = System.Drawing.Color.WhiteSmoke;
            this.dataGrid1.BackgroundColor = System.Drawing.SystemColors.Control;
            this.dataGrid1.BorderStyle = System.Windows.Forms.BorderStyle.None;
            this.dataGrid1.CaptionBackColor = System.Drawing.SystemColors.Control;
            this.dataGrid1.CaptionFont = new System.Drawing.Font("Tahoma", 8.25F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.dataGrid1.CaptionForeColor = System.Drawing.Color.MidnightBlue;
            this.dataGrid1.DataMember = "";
            this.dataGrid1.FlatMode = true;
            this.dataGrid1.Font = new System.Drawing.Font("Tahoma", 8.25F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.dataGrid1.ForeColor = System.Drawing.Color.MidnightBlue;
            this.dataGrid1.GridLineColor = System.Drawing.Color.Gainsboro;
            this.dataGrid1.GridLineStyle = System.Windows.Forms.DataGridLineStyle.None;
            this.dataGrid1.HeaderFont = new System.Drawing.Font("Tahoma", 8F, System.Drawing.FontStyle.Bold);
            this.dataGrid1.HeaderForeColor = System.Drawing.Color.WhiteSmoke;
            this.dataGrid1.LinkColor = System.Drawing.Color.Teal;
            this.dataGrid1.Location = new System.Drawing.Point(9, 120);
            this.dataGrid1.Name = "dataGrid1";
            this.dataGrid1.ParentRowsBackColor = System.Drawing.Color.Gainsboro;
            this.dataGrid1.ParentRowsForeColor = System.Drawing.Color.MidnightBlue;
            this.dataGrid1.ReadOnly = true;
            this.dataGrid1.RowHeaderWidth = 10;
            this.dataGrid1.SelectionBackColor = System.Drawing.Color.CadetBlue;
            this.dataGrid1.SelectionForeColor = System.Drawing.Color.WhiteSmoke;
            this.dataGrid1.Size = new System.Drawing.Size(616, 279);
            this.dataGrid1.TabIndex = 281;
            this.dataGrid1.CurrentCellChanged += new System.EventHandler(this.dataGrid1_CurrentCellChanged);
            // 
            // chkDoituong
            // 
            this.chkDoituong.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.chkDoituong.AutoSize = true;
            this.chkDoituong.Location = new System.Drawing.Point(109, 501);
            this.chkDoituong.Name = "chkDoituong";
            this.chkDoituong.Size = new System.Drawing.Size(121, 17);
            this.chkDoituong.TabIndex = 282;
            this.chkDoituong.Text = "Chỉnh sửa đối tượng";
            this.chkDoituong.UseVisualStyleBackColor = true;
            this.chkDoituong.Click += new System.EventHandler(this.chkDoituong_Click);
            // 
            // chkTodieutri
            // 
            this.chkTodieutri.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.chkTodieutri.AutoSize = true;
            this.chkTodieutri.Location = new System.Drawing.Point(402, 500);
            this.chkTodieutri.Name = "chkTodieutri";
            this.chkTodieutri.Size = new System.Drawing.Size(74, 17);
            this.chkTodieutri.TabIndex = 283;
            this.chkTodieutri.Text = "Tờ điều trị";
            this.chkTodieutri.UseVisualStyleBackColor = true;
            // 
            // lbldungluc
            // 
            this.lbldungluc.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Right)));
            this.lbldungluc.Location = new System.Drawing.Point(718, 472);
            this.lbldungluc.Name = "lbldungluc";
            this.lbldungluc.Size = new System.Drawing.Size(71, 23);
            this.lbldungluc.TabIndex = 284;
            this.lbldungluc.TextAlign = System.Drawing.ContentAlignment.MiddleLeft;
            // 
            // txtgiaban
            // 
            this.txtgiaban.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Right)));
            this.txtgiaban.BackColor = System.Drawing.SystemColors.HighlightText;
            this.txtgiaban.Enabled = false;
            this.txtgiaban.Font = new System.Drawing.Font("Tahoma", 9F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.txtgiaban.Location = new System.Drawing.Point(57, 403);
            this.txtgiaban.Masked = MaskedTextBox.MaskedTextBox.Mask.Decimal;
            this.txtgiaban.Name = "txtgiaban";
            this.txtgiaban.Size = new System.Drawing.Size(179, 22);
            this.txtgiaban.TabIndex = 285;
            this.txtgiaban.TextAlign = System.Windows.Forms.HorizontalAlignment.Right;
            this.txtgiaban.Visible = false;
            // 
            // txtdongia
            // 
            this.txtdongia.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Right)));
            this.txtdongia.BackColor = System.Drawing.SystemColors.HighlightText;
            this.txtdongia.Enabled = false;
            this.txtdongia.Font = new System.Drawing.Font("Tahoma", 9F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.txtdongia.Location = new System.Drawing.Point(239, 403);
            this.txtdongia.Masked = MaskedTextBox.MaskedTextBox.Mask.Decimal;
            this.txtdongia.Name = "txtdongia";
            this.txtdongia.Size = new System.Drawing.Size(179, 22);
            this.txtdongia.TabIndex = 286;
            this.txtdongia.TextAlign = System.Windows.Forms.HorizontalAlignment.Right;
            this.txtdongia.Visible = false;
            // 
            // frmBaohiem
            // 
            this.AutoScaleBaseSize = new System.Drawing.Size(5, 13);
            this.ClientSize = new System.Drawing.Size(794, 575);
            this.Controls.Add(this.txtdongia);
            this.Controls.Add(this.txtgiaban);
            this.Controls.Add(this.lbldungluc);
            this.Controls.Add(this.chkTodieutri);
            this.Controls.Add(this.chkDoituong);
            this.Controls.Add(this.chkLuuin);
            this.Controls.Add(this.banin);
            this.Controls.Add(this.label7);
            this.Controls.Add(this.butDongy);
            this.Controls.Add(this.tim);
            this.Controls.Add(this.chkHuyet);
            this.Controls.Add(this.huyet);
            this.Controls.Add(this.butGoi);
            this.Controls.Add(this.butTuongtac);
            this.Controls.Add(this.dang);
            this.Controls.Add(this.chkThuoc);
            this.Controls.Add(this.makho);
            this.Controls.Add(this.madoituong);
            this.Controls.Add(this.label13);
            this.Controls.Add(this.listBS);
            this.Controls.Add(this.listHoten);
            this.Controls.Add(this.cachdung);
            this.Controls.Add(this.p2);
            this.Controls.Add(this.tenpk);
            this.Controls.Add(this.sum);
            this.Controls.Add(this.lblsum);
            this.Controls.Add(this.chkXem);
            this.Controls.Add(this.chkXML);
            this.Controls.Add(this.chkDongia);
            this.Controls.Add(this.label25);
            this.Controls.Add(this.sothe);
            this.Controls.Add(this.chkChon);
            this.Controls.Add(this.listCachdung);
            this.Controls.Add(this.donthuoc);
            this.Controls.Add(this.manguon);
            this.Controls.Add(this.songay);
            this.Controls.Add(this.label10);
            this.Controls.Add(this.label9);
            this.Controls.Add(this.treeView1);
            this.Controls.Add(this.chkVP);
            this.Controls.Add(this.ghichu);
            this.Controls.Add(this.lghichu);
            this.Controls.Add(this.butHen);
            this.Controls.Add(this.butIn);
            this.Controls.Add(this.namsinh);
            this.Controls.Add(this.maicd);
            this.Controls.Add(this.hoten);
            this.Controls.Add(this.chandoan);
            this.Controls.Add(this.tenbs);
            this.Controls.Add(this.lblbacsy);
            this.Controls.Add(this.label6);
            this.Controls.Add(this.label5);
            this.Controls.Add(this.label4);
            this.Controls.Add(this.label3);
            this.Controls.Add(this.label22);
            this.Controls.Add(this.diung);
            this.Controls.Add(this.tenhc);
            this.Controls.Add(this.label20);
            this.Controls.Add(this.listDmbd);
            this.Controls.Add(this.cmbMabn);
            this.Controls.Add(this.butCholai);
            this.Controls.Add(this.butKetthuc);
            this.Controls.Add(this.butHuy);
            this.Controls.Add(this.butBoqua);
            this.Controls.Add(this.butXoa);
            this.Controls.Add(this.butThem);
            this.Controls.Add(this.butLuu);
            this.Controls.Add(this.butSua);
            this.Controls.Add(this.butMoi);
            this.Controls.Add(this.ldvt);
            this.Controls.Add(this.tenbd);
            this.Controls.Add(this.lTenhc);
            this.Controls.Add(this.mabd);
            this.Controls.Add(this.lTen);
            this.Controls.Add(this.lMabd);
            this.Controls.Add(this.mabn);
            this.Controls.Add(this.label2);
            this.Controls.Add(this.label1);
            this.Controls.Add(this.p1);
            this.Controls.Add(this.mabs);
            this.Controls.Add(this.makp);
            this.Controls.Add(this.stt);
            this.Controls.Add(this.mahc);
            this.Controls.Add(this.chkChitiet);
            this.Controls.Add(this.dataGrid1);
            this.FormBorderStyle = System.Windows.Forms.FormBorderStyle.FixedSingle;
            this.Icon = ((System.Drawing.Icon)(resources.GetObject("$this.Icon")));
            this.KeyPreview = true;
            this.Name = "frmBaohiem";
            this.StartPosition = System.Windows.Forms.FormStartPosition.CenterScreen;
            this.Text = "Đơn thuốc";
            this.WindowState = System.Windows.Forms.FormWindowState.Maximized;
            this.Load += new System.EventHandler(this.frmBaohiem_Load);
            this.KeyDown += new System.Windows.Forms.KeyEventHandler(this.frmBaohiem_KeyDown);
            ((System.ComponentModel.ISupportInitialize)(this.songay)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.solan)).EndInit();
            this.p1.ResumeLayout(false);
            this.p1.PerformLayout();
            this.p2.ResumeLayout(false);
            this.p2.PerformLayout();
            ((System.ComponentModel.ISupportInitialize)(this.banin)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.dataGrid1)).EndInit();
            this.ResumeLayout(false);
            this.PerformLayout();

		}
		#endregion

		private void frmBaohiem_Load(object sender, System.EventArgs e)
		{
            f_soluong = d.format_soluong(i_nhom);
            user = d.user; bLuu_Donthuoc_bacsy = m.bLuu_Donthuoc_bacsy;
            iUserid_donve = m.iUserid_donve; i_tunguyen = m.iTunguyen;
            bDuyet_donve = m.bDuyet_donve; bLocdichvu = m.bLocThuocCaptoa_doituong;
            iKhoangcachngaycaptoa_voingaykham = m.iKhoangcachngaycaptoa_voingaykham;
            bDuyet_donvepl = m.bDuyet_donvepl;
            bBamhuyet = m.bBamhuyet; bDutru_n_thuoc = m.bDutru_n_thuoc;
            bMabd_doituong = d.bMabd_doituong(i_nhom);
            iBhyt_songay = m.iBhyt_songay;
            bCaptoa_theodanhmuc_duocketoa = m.bCaptoa_theodanhmuc_duocketoa;
            i_w = dataGrid1.Size.Width; i_h = dataGrid1.Size.Height;
            f_load_option();
            if (bBamhuyet)
            {
                lghichu.Text = "Huyệt :";
                sql = "select * from " + user + ".dmhuyet where mabs='" + mabs.Text + "' and maicd='" + maicd.Text + "' order by stt";
                dthuyet = m.get_data(sql).Tables[0];
                if (dthuyet.Rows.Count == 0)
                {
                    sql = "select * from " + user + ".dmhuyet where maicd='" + maicd.Text + "' order by stt";
                    dthuyet = m.get_data(sql).Tables[0];
                    if (dthuyet.Rows.Count == 0)
                    {
                        sql = "select * from " + user + ".dmhuyet where mabs='" + mabs.Text + "' order by stt";
                        dthuyet = m.get_data(sql).Tables[0];
                        if (dthuyet.Rows.Count == 0)
                        {
                            sql = "select * from " + user + ".dmhuyet order by stt";
                            dthuyet = m.get_data(sql).Tables[0];
                        }
                    }
                }
                huyet.DataSource = dthuyet;
                huyet.ValueMember = "ID";
                huyet.DisplayMember = "TEN";
            }
            bGiaban = d.get_data("select * from " + user + ".d_doituong where loai=1 and madoituong=" + i_madoituong).Tables[0].Rows.Count > 0;
            foreach (DataRow r in m.get_data("select * from " + user + ".dlogin where id=" + i_userid).Tables[0].Rows)
                s_user = r["hoten"].ToString();
            chkThuoc.Checked = m.Thongso("xemthuoc") == "1";
            bThuphi_khongloadthuoc_BHYT = m.bThuphi_khongloadthuoc_BHYT;
            if (bChonkhoa)
            {
            	sql ="select a.mabn,b.hoten,a.id,c.mavaovien,a.maql,c.madoituong,d.sothe as sothe,b.nam,to_char(c.ngay,'dd/mm/yyyy') as ngay,";
                sql += "to_char(d.denngay,'dd/mm/yyyy') as denngay,e.chandoan,e.maicd,e.mabs,f.hoten as tenbs,trim(b.sonha)||' '||b.thon||', '||px.tenpxa||', '||qu.tenquan||', '||tt.tentt as diachi,";
                sql += "b.namsinh,e.giuong,";
                sql += " to_char(d.tungay,'dd/mm/yyyy') as tungay,to_char(d.ngay1,'dd/mm/yyyy') as ngay1,";
                sql += " to_char(d.ngay2,'dd/mm/yyyy') as ngay2,to_char(d.ngay3,'dd/mm/yyyy') as ngay3,case when d.traituyen is null then 0 else d.traituyen end as traituyen,d.mabv";
                sql += ", to_char(b.ngaysinh,'dd/mm/yyyy') as ngaysinh ";
                sql += ", case when b.phai=0 then 'Nam' else 'Nữ' end phai";
                sql += " from " + user + ".hiendien a inner join " + user + ".btdbn b on a.mabn=b.mabn ";
                sql += " inner join " + user + ".benhandt c on a.maql=c.maql ";
                sql += " left join " + user + ".bhyt d on a.maql=d.maql ";
                sql += " inner join " + user + ".nhapkhoa e on a.id=e.id ";
                sql += " left join " + user + ".dmbs f on e.mabs=f.ma";
                sql += " inner join " + user + ".btdtt tt on b.matt=tt.matt ";
                sql += " inner join " + user + ".btdquan qu on b.maqu=qu.maqu ";
                sql += " inner join " + user + ".btdpxa px on b.maphuongxa=px.maphuongxa ";
                sql += " where a.nhapkhoa=1 and a.xuatkhoa=0 ";
                if (!m.ma_phongmo(s_makp)) sql += " and a.makp='" + s_makp + "'"; 
			    sql += " and substr(a.ngay,1,10)<=to_date('"+s_ngay+"','"+m.f_ngay+"')";
                sql += " and (d.sudung is null or d.sudung=1)";
			    sql += " order by a.id desc";
			    dthoten=m.get_data(sql).Tables[0];
			    listHoten.DisplayMember="MABN";
			    listHoten.ValueMember="HOTEN";
			    listHoten.DataSource=dthoten;
            }
            if (bChonkhoa || i_loaiba == 4 || i_loaiba==1)
            {
                dtbs = m.get_data("select * from " + user + ".dmbs where nhom not in (" + LibMedi.AccessData.nhanvien + ", " + LibMedi.AccessData.nghiviec + ") order by ma").Tables[0];
                listBS.DisplayMember = "MA";
                listBS.ValueMember = "HOTEN";
                listBS.DataSource = dtbs;
            }
            bDonthuoc_stc = m.bDonthuoc_stc;
            chkXem.Checked = m.bPreview;
            bAdmin = m.bAdmin(i_userid);
            bAdminInlaidonthuoc = m.bAdminInlaidonthuoc;
            p2.Visible = bDonthuoc_stc;
            p1.Visible = !bDonthuoc_stc;
            bNgayhienhanh_thuoc_chidinh = m.bNgayhienhanh_thuoc_chidinh;
            if (bNgayhienhanh_thuoc_chidinh && !bChonkhoa && bXemlai==false) s_ngay = m.ngayhienhanh_server;
            bGiaban_theodot = d.bGiaban_theodot(i_nhom);
            //
            f_capnhat_db();
            //
            xxx = user + m.mmyy(s_ngay); zzz = user + s_mmyy;
            bNgtru_dt_makp = m.bNgtru_dt_makp;
            dt_ngtru = m.dt_ngtru;
            makp_kho_dt = m.makp_kho_dt;
            kho_ngtru = m.kho_ngtru;
            if (((i_loaiba==2 && m.bDonngoaitru_auto) || i_loaiba == 3 || i_loaiba==4) && i_madoituong!=5)
            {
                bDuyet = (m.bDuyet_khambenh && i_loaiba != 4) || (bDuyet_donvepl && i_loaiba == 4);
                bInchitiet = (bDuyet)?m.bKham_inchiphi:false;
                iUserid_duyet = m.iUserid_duyet;
                bKhoaso = d.bKhoaso(i_nhom, s_mmyy);
            }
            else if (i_loaiba == 1 && bDuyet_donve)
            {
                bDuyet = bDuyet_donve;
                iUserid_duyet = iUserid_donve;
            }
            
            if (bDuyet)
            {
                d.upd_capsotoa(s_mmyy, -99, s_ngay.Substring(0,10), 0, -1);
                d.upd_capsotoa(s_mmyy, -99, s_ngay.Substring(0,10), 1, -1);
                d.upd_capsotoa(s_mmyy, 2, s_ngay.Substring(0,10), 0);
                d.upd_capsotoa(s_mmyy, 2, s_ngay.Substring(0,10), 1);
            }
            bTinnhan_sound = d.bTinnhan_sound(i_nhom);
            bTinnhan = d.bTinnhan(i_nhom);
            bTongtien_donduyet = m.bTongtien_donduyet;
            lblsum.Visible = bTongtien_donduyet;
            sum.Visible = bTongtien_donduyet;
            chkDongia.Visible = bDuyet;
            bMuangoai_tonkho = (i_loai==7)?m.bMuangoai_tonkho:true;
            bCachdung = m.bCachdung;
            if (bDuyet) d.upd_capsotoa(s_mmyy, 2, s_ngay.Substring(0,10), (i_madoituong == 1) ? 0 : 1);
            s_ngayht = m.ngayhienhanh_server;//s_ngay
            bSolan = m.bSolan_donthuoc;
            i_bhyt_inrieng = d.iBhyt_inrieng(i_nhom);
            bKiemtrathuoc = m.bThuoc_ngay;
            s_msg = LibMedi.AccessData.Msg;
            i_sudungthuoc = m.iSudungthuoc;
            s_manguon = d.get_manguon(i_loai).Trim();
            if (bDieutringtr)
            {
                string s = d.get_manguon_doituong(i_madoituong);
                s_manguon = (s != "") ? s : s_manguon;
            }
            s_makho = d.get_dmkho(i_loai).Trim();
            if (m.bCaptoa_loctheokho_khaibaokhoa_trongduoc) s_makho_kp = d.get_dmkho_khoa(s_makp);
            else s_makho_kp = "";
            bChidinh = m.bInchidinh_donthuoc;
            chkVP.Checked = bChidinh;
            if (i_loai == 7) bNgoaitonkho = m.bNgoaitonkho;
            if (!bDieutringtr)
            {
                if (i_nhom == m.nhom_duoc && bNgtru_dt_makp && (i_madoituong == dt_ngtru || dt_ngtru==0) && makp_kho_dt.IndexOf(s_makp) != -1)
                    s_makho = kho_ngtru.ToString()+",";
                else
                {
                    string kho = "";
                    dtletet = m.get_data("select * from " + user + ".letet").Tables[0];
                    r = m.getrowbyid(dtletet, "ngay='" + s_ngayht.Substring(0, 5) + "'");
                    bLetet = r != null;
                    int hh1, hh2, hh3, mm1, mm2, mm3;
                    hh1 = int.Parse(s_ngayht.Substring(11, 2));
                    mm1 = int.Parse(s_ngayht.Substring(14, 2));
                    hh3 = int.Parse(m.sGiobaocao.Substring(0, 2));
                    mm3 = int.Parse(m.sGiobaocao.Substring(3, 2));
                    DateTime dt = m.StringToDate(s_ngay.Substring(0, 10));
                    string ddd = dt.DayOfWeek.ToString().Substring(0, 3);
                    if (i_madoituong == m.iTreem6tuoi && i_nhom == m.nhom_duoc && s_makho != "" && m.gio_treem != "00:00")
                    {
                        hh2 = int.Parse(m.gio_treem.Substring(0, 2));
                        mm2 = int.Parse(m.gio_treem.Substring(3, 2));
                        kho = m.kho_treem;
                        if (kho != "") kho += ",";
                        if (bLetet || ddd == "Sat" || ddd == "Sun" || hh1 > hh2 || (hh1 == hh2 && mm1 > mm2) || hh1 < hh3 || (hh1 == hh3 && mm1 < mm3)) s_makho = kho;
                        else if (kho != "") s_makho = s_makho.Remove(s_makho.IndexOf(kho), kho.Length);
                    }
                    else if (i_madoituong == 1 && i_nhom == m.nhom_duoc && s_makho != "" && m.gio_bhyt != "00:00")
                    {
                        hh2 = int.Parse(m.gio_bhyt.Substring(0, 2));
                        mm2 = int.Parse(m.gio_bhyt.Substring(3, 2));
                        kho = m.kho_bhyt;
                        if (kho != "") kho += ",";
                        if (bLetet || ddd == "Sat" || ddd == "Sun" || hh1 > hh2 || (hh1 == hh2 && mm1 > mm2) || hh1 < hh3 || (hh1 == hh3 && mm1 < mm3)) s_makho = kho;
                        else if (kho != "") s_makho = s_makho.Remove(s_makho.IndexOf(kho), kho.Length);
                    }
                    else if (i_madoituong == 2 && m.bDanhmuc_nhathuoc && i_nhom == m.nhom_nhathuoc && s_makho != "" && m.gio_nhathuoc != "00:00") //nha thuoc
                    {
                        hh2 = int.Parse(m.gio_nhathuoc.Substring(0, 2));
                        mm2 = int.Parse(m.gio_nhathuoc.Substring(3, 2));
                        kho = m.kho_nhathuoc;
                        if (kho != "") kho += ",";
                        if (bLetet || ddd == "Sat" || ddd == "Sun" || hh1 > hh2 || (hh1 == hh2 && mm1 > mm2) || hh1 < hh3 || (hh1 == hh3 && mm1 < mm3)) s_makho = kho;
                        else if (kho != "") s_makho = s_makho.Remove(s_makho.IndexOf(kho), kho.Length);
                    }
                }
            }
			diung.Tag="";
			bDiungthuoc=m.bDiungthuoc;
			diung.Visible=bDiungthuoc;
			dtdmbd=d.get_data("select * from "+user+".d_dmbd where nhom="+i_nhom).Tables[0];

			listDmbd.DisplayMember="TEN";
			listDmbd.ValueMember="STT";

			listCachdung.DisplayMember="STT";
			listCachdung.ValueMember="TEN";

            if (!bChonkhoa) load_don();

            sql = "select * from "+user+".doituong";
            if (s_madoituong != "") sql += " where madoituong in (" + s_madoituong.Substring(0, s_madoituong.Length - 1) + ")";
            sql += " order by madoituong";
            madoituong.DisplayMember = "DOITUONG";
            madoituong.ValueMember = "MADOITUONG";
            madoituong.DataSource = m.get_data(sql).Tables[0];
            if (i_madoituong!=0) madoituong.SelectedValue = i_madoituong.ToString();

            dtnguon = d.get_data("select * from " + user + ".d_dmnguon").Tables[0];
            if (bNgoaitonkho)
            {
                DataRow r = dtnguon.NewRow();
                r["id"] = -1;
                r["ten"] = "Tự mua";
                r["nhom"] = i_nhom;
                r["stt"] = -1;
                r["loai"] = 0;
                r["loaibc"] = 0;
                dtnguon.Rows.Add(r);
                d.upd_dmhang(-1, "KXĐ", 0, i_nhom, -1);
                d.upd_dmnuoc(-1, "KXĐ", 0, i_nhom, -1);
                d.upd_dmnhom(-1, "KXĐ", 0, i_nhom, 0, 0, -1);
                d.upd_dmloai(-1, "KXĐ", 0, i_nhom, -1);
            }
			manguon.DisplayMember="TEN";
			manguon.ValueMember="ID";
			manguon.DataSource=dtnguon;

			makho.DisplayMember="TEN";
			makho.ValueMember="ID";
			sql="select * from "+user+".d_dmkho";
			if (s_makho!="") sql+=" where id in ("+s_makho.Substring(0,s_makho.Length-1)+")";
			sql+=" order by stt";
            dtkho = d.get_data(sql).Tables[0];
            if (bNgoaitonkho)
            {
                DataRow r1 = dtkho.NewRow();
                r1["id"] = -1;
                r1["ten"] = "Tự mua";
                dtkho.Rows.Add(r1);
            }            
			makho.DataSource=dtkho;
            cmbMabn.DisplayMember="MABN";
			cmbMabn.ValueMember="ID";

			sql="select a.id,a.mabn,b.hoten,a.maql,to_char(a.ngay,'dd/mm/yyyy') as ngay,a.done,";
			sql+=" b.namsinh,nullif(d.sothe,' ') as sothe,a.chandoan,a.maicd,e.tenkp,nullif(f.hoten,' ') as tenbs,";
            sql+="a.songay,a.ghichu,a.makp,a.mabs, to_char(b.ngaysinh,'dd/mm/yyyy') as ngaysinh, a.lanin ";
			sql+=" from "+xxx+".d_thuocbhytll a inner join "+user+".btdbn b on a.mabn=b.mabn ";
            sql+=" left join "+s_bhyt+" d on a.maql=d.maql ";
            sql+=" inner join "+user+".btdkp_bv e on a.makp=e.makp";
            sql+=" left join "+user+".dmbs f on a.mabs=f.ma";
            if (bChonkhoa) sql += " where a.makp='" + s_makp + "' and to_char(a.ngay,'dd/mm/yyyy')='" + s_ngay.Substring(0, 10) + "' and a.loaiba=" + i_loaiba;
            else
            {
                sql += " where a.mabn='" + s_mabn + "' and a.maql=" + l_maql + " and a.madoituong=" + i_madoituong;
                if (d.bLocbaohiem) sql += " and to_char(a.ngay,'dd/mm/yyyy')='" + s_ngay.Substring(0, 10) + "'";
            }
			sql+=" order by a.id";
			dtll=d.get_data(sql).Tables[0];
			cmbMabn.DataSource=dtll;
            bool bSkip = false;
            if (cmbMabn.Items.Count > 0)
            {
                l_id = long.Parse(cmbMabn.SelectedValue.ToString());
                sql = "select distinct f.dongy";
                sql += " from " + xxx + ".d_thuocbhytct a inner join " + user + ".d_dmbd b on a.mabd=b.id ";
                sql += " left join " + user + ".d_dmkho f on a.makho=f.id ";
                sql += " inner join " + user + ".doituong c on a.madoituong=c.madoituong ";
                sql += " where a.id=" + l_id;
                DataTable tmp = d.get_data(sql).Tables[0];
                if (tmp.Rows.Count > 0)
                {
                    if (tmp.Rows[0]["dongy"].ToString() == "1")
                    {
                        label9.Text = "thang";
                        bTayy = false;
                        chkChitiet.Checked = true;
                    }
                    else
                    {
                        label9.Text = "ngày";
                        bTayy = true;
                        chkChitiet.Checked = false;
                    }
                    bSkip = true;
                    load_control();
                }
            }
            else l_id = 0;
            if (l_id!=0 && i_loai==5 && i_loaiba==3 && !bDuyet && !bChonkhoa) kiemtra_duyet();
			load_head();
			if (!bSkip) AddGridTableStyle();
			lan.Read_dtgrid_to_Xml(dataGrid1, this.Name.ToString()+"_"+dataGrid1.Name.ToString());
			lan.Change_dtgrid_HeaderText_to_English(dataGrid1, this.Name.ToString()+"_"+dataGrid1.Name.ToString());
			ref_text();
			dsxoa.ReadXml("..//..//..//xml//d_dutruct.xml");
            //
            try { dsxoa.Tables[0].Columns.Add("dongia", typeof(decimal)).DefaultValue = 0; }
            catch { }
            try { dsxoa.Tables[0].Columns.Add("giaban", typeof(decimal)).DefaultValue = 0; }
            catch { }
            try { dsxoa.Tables[0].Columns.Add("sotien", typeof(decimal)).DefaultValue = 0; }
            catch { }
            try { dsxoa.Tables[0].Columns.Add("sotienban", typeof(decimal)).DefaultValue = 0; }
            catch { }
            //
            if (bChonkhoa) load_dm();
            chkChitiet.Checked=m.Thongso("ctcapdon")=="1";
            makhosave = s_makho;
            butMoi.Enabled = bDongy(makhosave, 0);
            butDongy.Enabled = bDongy(makhosave, 1);
            string sbanin = m.Thongso("banin_" + ((i_loai == 7) ? "7" : "1"));
            banin.Value = decimal.Parse((sbanin!="")?sbanin:"0");
            chkLuuin.Checked = m.Thongso("bhluuin") == "1";
            //else if (chkThuoc.Checked) load_treeview();
            dataGrid1.ReadOnly = true;
            //
            ngay_reset_phieu38 = s_ngay;
            if (d.bSophieu_mau38_tangtheonam(m.nhom_duoc))
            {
                ngay_reset_phieu38 = "31/12/20" + s_mmyy.Substring(2, 2);                
            }
            else if (d.bSophieu_mau38_tangtheonam_tinhtuthang12(m.nhom_duoc))
            {
                ngay_reset_phieu38 = d.get_ngaytao_solieu_thangmoi("01"+s_mmyy.Substring(2,2), m.nhom_duoc); //d.iNgaytinh_Sophieu_mau38_tangtheonam(i_nhom).ToString().PadLeft(2, '0') + "/12/20" + (int.Parse(s_mmyy.Substring(2, 2)) - 1).ToString().PadLeft(2, '0');                
            }
            else
            {
                if (d.bSophieu_mau38_tangtheothang(m.nhom_duoc)) ngay_reset_phieu38 = "01/" + s_mmyy.Substring(0, 2) + "/20" + s_mmyy.Substring(2, 2);
                else if (d.bSophieu_mau38_tangtheothang_tinhtuthangtruoc(m.nhom_duoc))
                {                    
                    ngay_reset_phieu38 = d.get_ngaytao_solieu_thangmoi(s_mmyy, m.nhom_duoc); //d.iNgaytinh_Sophieu_mau38_tangthang(i_nhom).ToString().PadLeft(2, '0') + "/" + tmp_mm.ToString().PadLeft(2, '0') + "/20" + tmp_yy.ToString().PadLeft(2, '0');
                }               
            }
            //
		}
        private void kiemtra_duyet()
        {
            if (d.get_done_thuocbhyt(s_ngay, l_id))
            {
                int songayduyet = d.iNgaykiemke;//.songayduyet(i_nhom);
                string s_tu = m.DateToString("dd/MM/yyyy", m.StringToDate(s_ngay).AddDays(-1 * songayduyet));
                string s_den = m.DateToString("dd/MM/yyyy", m.StringToDate(s_ngay).AddDays(songayduyet));
                if (d.get_data_mmyy("select * from xxx.bhytkb where id=" + l_id, s_tu, s_den, songayduyet).Tables[0].Rows.Count == 0)
                {
                    d.execute_data("update " + user + m.mmyy(s_ngay) + ".d_thuocbhytct set slthuc=0 where id=" + l_id);
                    d.execute_data("update " + user + m.mmyy(s_ngay) + ".d_thuocbhytll set done=0 where id=" + l_id);                    
                }
            }
        }

        private void load_don()
        {
            sql = "select a.*,' ' as hoten from " + user + ".d_theodonll a where a.mabs='" + mabs.Text + "' and a.maicd='" + maicd.Text + "' order by a.stt";
            dtdon = m.get_data(sql).Tables[0];
            if (dtdon.Rows.Count == 0)
            {
                sql = "select a.*,b.hoten from " + user + ".d_theodonll a," + user + ".dmbs b where a.mabs=b.ma and a.maicd='" + maicd.Text + "' order by a.stt";
                dtdon = m.get_data(sql).Tables[0];
            }
            string s = "";
            foreach (DataRow r in dtdon.Rows)
            {
				s=r["ghichu"].ToString().Trim();
                if (r["stt"].ToString() != "0")
                {
                    s = "";
                    sql = "select a.mabd,b.ma,trim(b.ten)||' '||b.hamluong as ten,b.hamluong,b.dang,b.mahc,b.tenhc,a.soluong,a.cachdung from " + user + ".d_theodonct a," + user + ".d_dmbd b";
                    sql += " where a.mabd=b.id and a.id=" + long.Parse(r["id"].ToString());
                    foreach (DataRow r3 in d.get_data(sql).Tables[0].Rows)
                        s += r3["ten"].ToString().Trim() + " " + r3["dang"].ToString().Trim() + ";";
                }
                r["ghichu"] = s;// r["stt"].ToString().Trim() + ". Đơn thuốc " + r["songay"].ToString().Trim() + " ngày , " + r["so"].ToString() + " loại " + ((r["hoten"].ToString().Trim() != "") ? "[" + r["hoten"].ToString().Trim() + "]" : "");
            }
            donthuoc.DisplayMember = "GHICHU";
            donthuoc.ValueMember = "ID";
            donthuoc.DataSource = dtdon;
        }

		private void load_grid()
		{
            sql = "select a.stt,c.doituong,a.mabd,b.ma,trim(b.ten)||' '||b.hamluong as ten,nullif(b.tenhc,' ') as tenhc,b.dang,f.ten as tenkho,";
            sql+=" a.slyeucau as soluong,a.madoituong,a.makho,nullif(a.cachdung,' ') as cachdung,b.mahc,' ' as diung,a.manguon,";
            sql+=" 0 as tutruc,0 as idvpkhoa,a.solan,a.lan,b.dongia,a.slyeucau*b.dongia as sotien,b.giaban,";
            sql+=" a.slyeucau*b.giaban as sotienban ";
			sql+=" from "+xxx+".d_thuocbhytct a inner join "+user+".d_dmbd b on a.mabd=b.id ";
            sql+=" left join "+user+".d_dmkho f on a.makho=f.id ";
            sql+=" inner join "+user+".doituong c on a.madoituong=c.madoituong ";
            sql+=" where a.id="+l_id+" order by a.stt";
			dtct=d.get_data(sql).Tables[0];
			if (bDiungthuoc) upd_diung();
			dataGrid1.DataSource=dtct;
            if (bTongtien_donduyet) tong();
            i_row = dataGrid1.CurrentRowIndex;
		}

        private void tong()
        {
            decimal st = 0;
            foreach (DataRow r in dtct.Rows) st += ((i_loai == 7 || bGiaban) ? decimal.Parse(r["sotienban"].ToString()) : decimal.Parse(r["sotien"].ToString()));
            sum.Text = st.ToString("###,###,###,###.00");
        }

		private void upd_diung()
		{
			if (diung.Tag.ToString()!="")
			{
				int i=0;
				foreach(DataRow r in dtct.Rows)
				{
					i=0;
					while (i<diung.Tag.ToString().Length)
					{
						if (r["mahc"].ToString().IndexOf(diung.Tag.ToString().Substring(i,7))!=-1)
						{
							r["diung"]="1";
							break;
						}
						i+=7;
					}
				}
				dtct.AcceptChanges();
			}
		}

		private void AddGridTableStyle()
		{
			DataGridColoredTextBoxColumn TextCol;
			delegateGetColorRowCol de = new delegateGetColorRowCol(MyGetColorRowCol);
			DataGridTableStyle ts =new DataGridTableStyle();
			ts.MappingName = dtct.TableName;
			ts.AlternatingBackColor = Color.Beige;
			ts.BackColor = Color.GhostWhite;
			ts.ForeColor = Color.MidnightBlue;
			ts.GridLineColor = Color.RoyalBlue;
			ts.HeaderBackColor = Color.MidnightBlue;
			ts.HeaderForeColor = Color.Lavender;
			ts.SelectionBackColor = Color.Teal;
			ts.SelectionForeColor = Color.PaleGreen;
			//ts.ReadOnly=false;
			ts.RowHeaderWidth=5;
						
			TextCol=new DataGridColoredTextBoxColumn(de, 0);
			TextCol.MappingName = "stt";
			TextCol.HeaderText = "Stt";
			TextCol.Width = 30;
            TextCol.ReadOnly = true;
			ts.GridColumnStyles.Add(TextCol);
			dataGrid1.TableStyles.Add(ts);

			TextCol=new DataGridColoredTextBoxColumn(de, 1);
			TextCol.MappingName = "doituong";
			TextCol.HeaderText = "Đối tượng";
			TextCol.Width = 80;
            TextCol.ReadOnly = true;
			ts.GridColumnStyles.Add(TextCol);
			dataGrid1.TableStyles.Add(ts);

			TextCol=new DataGridColoredTextBoxColumn(de, 2);
			TextCol.MappingName = "ma";
			TextCol.HeaderText = "Mã số";
			TextCol.Width = 45;
            TextCol.ReadOnly = true;
			ts.GridColumnStyles.Add(TextCol);
			dataGrid1.TableStyles.Add(ts);

			TextCol=new DataGridColoredTextBoxColumn(de, 3);
			TextCol.MappingName = "ten";
			TextCol.HeaderText = "Tên";
			TextCol.Width = (bTayy)?155:305;
            TextCol.ReadOnly = true;
			ts.GridColumnStyles.Add(TextCol);
			dataGrid1.TableStyles.Add(ts);

			TextCol=new DataGridColoredTextBoxColumn(de, 4);
			TextCol.MappingName = "tenhc";
			TextCol.HeaderText = (bTayy)?"Hoạt chất":"";
			TextCol.Width = (bTayy)?150:0;
            TextCol.ReadOnly = true;
			ts.GridColumnStyles.Add(TextCol);
			dataGrid1.TableStyles.Add(ts);

            TextCol = new DataGridColoredTextBoxColumn(de, 5);
            TextCol.MappingName = "dang";
            TextCol.HeaderText = "ĐVT";
            TextCol.Width = 34;
            TextCol.ReadOnly = true;
            ts.GridColumnStyles.Add(TextCol);
            dataGrid1.TableStyles.Add(ts);

            TextCol = new DataGridColoredTextBoxColumn(de, 6);
            TextCol.MappingName = "solan";
            TextCol.HeaderText = (bTayy)?"":"Số";
            TextCol.Width = (bTayy)?0:30;
            TextCol.ReadOnly = true;
            TextCol.Alignment = HorizontalAlignment.Right;
            ts.GridColumnStyles.Add(TextCol);
            dataGrid1.TableStyles.Add(ts);

            TextCol = new DataGridColoredTextBoxColumn(de, 7);
            TextCol.MappingName = "lan";
            TextCol.HeaderText = (bTayy)?"":"Số lượng";
            TextCol.Width = (bTayy)?0:50;
            if (bTayy) TextCol.ReadOnly = true;
            TextCol.Format = f_soluong;
            TextCol.Alignment = HorizontalAlignment.Right;
            ts.GridColumnStyles.Add(TextCol);
            dataGrid1.TableStyles.Add(ts);

			TextCol=new DataGridColoredTextBoxColumn(de, 8);
			TextCol.MappingName = "soluong";
            TextCol.HeaderText = (bTayy) ? "Số lượng" : "";//Tổng cộng
			TextCol.Width = (bTayy)?70:0;
            TextCol.Format = f_soluong;
            if (!bTayy) TextCol.ReadOnly = true;
			TextCol.Alignment=HorizontalAlignment.Right;
			ts.GridColumnStyles.Add(TextCol);
			dataGrid1.TableStyles.Add(ts);

			TextCol=new DataGridColoredTextBoxColumn(de, 9);
			TextCol.MappingName = "madoituong";
			TextCol.HeaderText = "";
			TextCol.Width = 0;
			ts.GridColumnStyles.Add(TextCol);
			dataGrid1.TableStyles.Add(ts);

			TextCol=new DataGridColoredTextBoxColumn(de, 10);
			TextCol.MappingName = "makho";
			TextCol.HeaderText = "";
			TextCol.Width = 0;
			ts.GridColumnStyles.Add(TextCol);
			dataGrid1.TableStyles.Add(ts);

			TextCol=new DataGridColoredTextBoxColumn(de, 11);
			TextCol.MappingName = "cachdung";
            TextCol.HeaderText = (bDonthuoc_stc || !bTayy) ? "" : "Cách dùng";
            TextCol.Width = (bDonthuoc_stc || !bTayy) ? 0 : 150;
            TextCol.ReadOnly = true;
			ts.GridColumnStyles.Add(TextCol);
			dataGrid1.TableStyles.Add(ts);

			TextCol=new DataGridColoredTextBoxColumn(de, 12);
			TextCol.MappingName = "mahc";
			TextCol.HeaderText = "";
			TextCol.Width = 0;
			ts.GridColumnStyles.Add(TextCol);
			dataGrid1.TableStyles.Add(ts);

			TextCol=new DataGridColoredTextBoxColumn(de, 13);
			TextCol.MappingName = "diung";
			TextCol.HeaderText = "";
			TextCol.Width = 0;
			ts.GridColumnStyles.Add(TextCol);
			dataGrid1.TableStyles.Add(ts);

			TextCol=new DataGridColoredTextBoxColumn(de, 14);
			TextCol.MappingName = "manguon";
			TextCol.HeaderText = "";
			TextCol.Width = 0;
			ts.GridColumnStyles.Add(TextCol);
			dataGrid1.TableStyles.Add(ts);

            TextCol = new DataGridColoredTextBoxColumn(de, 15);
            TextCol.MappingName = (i_loai==7 || bGiaban)?"giaban":"dongia";
            TextCol.HeaderText = (bTongtien_donduyet && bTayy)?"Đơn giá":"";
            TextCol.Width = (bTongtien_donduyet && bTayy)?70:0;
            TextCol.Alignment = HorizontalAlignment.Right;
            TextCol.ReadOnly = true;
            TextCol.Format = "### ### ##0.00";
            ts.GridColumnStyles.Add(TextCol);
            dataGrid1.TableStyles.Add(ts);

            TextCol = new DataGridColoredTextBoxColumn(de, 16);
            TextCol.MappingName = (i_loai==7 || bGiaban)?"sotienban":"sotien";
            TextCol.HeaderText = (bTongtien_donduyet && bTayy) ? "Số tiền" : "";
            TextCol.Width = (bTongtien_donduyet && bTayy) ? 80 : 0;
            TextCol.Alignment = HorizontalAlignment.Right;
            TextCol.ReadOnly = true;
            TextCol.Format = "### ### ##0.00";
            ts.GridColumnStyles.Add(TextCol);
            dataGrid1.TableStyles.Add(ts);            

		}

		public Color MyGetColorRowCol(int row, int col)
		{
            if (this.dataGrid1[row, 13].ToString().Trim() == "1") return Color.Red;
            else if (this.dataGrid1[row, 14].ToString().Trim() == "-1") return Color.Blue;
            else return Color.Black;
		}

		public delegate Color delegateGetColorRowCol(int row, int col);
		public class DataGridColoredTextBoxColumn : DataGridTextBoxColumn
		{
			private delegateGetColorRowCol _getColorRowCol;
			private int _column;
			public DataGridColoredTextBoxColumn(delegateGetColorRowCol getcolorRowCol, int column)
			{
				_getColorRowCol = getcolorRowCol;
				_column = column;
			}
			protected override void Paint(System.Drawing.Graphics g, System.Drawing.Rectangle bounds, System.Windows.Forms.CurrencyManager source, int rowNum, System.Drawing.Brush backBrush, System.Drawing.Brush foreBrush, bool alignToRight)
			{
				try
				{
					foreBrush = new SolidBrush(_getColorRowCol(rowNum, this._column));
					//backBrush = new SolidBrush(Color.GhostWhite);
				}
				catch{}
				finally
				{
					base.Paint(g, bounds, source, rowNum, backBrush, foreBrush, alignToRight);
				}
			}
		}

		private void ref_text()
		{
			try
			{
				int i=dataGrid1.CurrentCell.RowNumber;
				stt.Text=dataGrid1[i,0].ToString();
				mabd.Text=dataGrid1[i,2].ToString();
				tenbd.Text=dataGrid1[i,3].ToString();
				tenhc.Text=dataGrid1[i,4].ToString();
				dang.Text=dataGrid1[i,5].ToString();
				d_soluong=(dataGrid1[i,8].ToString()!="")?decimal.Parse(dataGrid1[i,8].ToString()):0;
				makho.SelectedValue=dataGrid1[i,10].ToString();
				mahc.Text=dataGrid1[i,12].ToString();
				manguon.SelectedValue=dataGrid1[i,14].ToString();
                madoituong.SelectedValue = dataGrid1[i,9].ToString();
                //
                txtdongia.Text = dataGrid1[i, 15].ToString();
                txtgiaban.Text = dataGrid1[i, 15].ToString();
                //
                d_soluongcu = d_soluong;
                DataRow r1 = m.getrowbyid(dtct, "stt=" + long.Parse(stt.Text));
                i_mabdcu = i_makhocu = i_manguoncu = 0;
                if (r1 != null)
                {
                    i_manguoncu = int.Parse(r1["manguon"].ToString());
                    i_makhocu = int.Parse(r1["makho"].ToString());
                    i_mabdcu = int.Parse(r1["mabd"].ToString());
                    try
                    {
                        DataRow dr = d.getrowbyid(dtdmbd, "id=" + r1["mabd"].ToString() + "");
                        if (dr != null)
                        {
                            lbldvt.Text = (dr["donvidung"].ToString().Trim()!="") ? dr["donvidung"].ToString() : dr["dang"].ToString(); 
                        }
                    }
                    catch { }
                }
                if (bDonthuoc_stc)
                {
                    r1 = d.getrowbyid(dtdmbd, "ma='" + mabd.Text + "'");
                    if (r1 != null)
                        lblduongdung.Text = r1["duongdung"].ToString().Trim();
                    soluong1.Text = d_soluong.ToString("###,###,##0.00");
                    string s = dataGrid1[i, 11].ToString().Trim();
                    if (s.IndexOf("^") != -1)
                    {
                        int k = 0; string s1 = "";
                        for (int j = 0; j < s.Length; j++)
                        {
                            if (s.Substring(j, 1) == "^")
                            {
                                k++;
                                if (k == 1) c1.Text = s1;
                                else if (k == 2) c2.Text = s1;
                                else if (k == 3) c3.Text = s1;
                                s1 = "";
                            }
                            else s1 += s.Substring(j, 1);
                        }
                        if (s1 != "") c4.Text = s1;
                        cachdung.Text = "";
                    }
                    else cachdung.Text = s;
                    chk1.Checked = decimal.Parse(dataGrid1[i, 6].ToString()) == 1;
                    chk2.Checked = !chk1.Checked;
                }
                else
                {
                    soluong.Text = d_soluong.ToString("###,###,##0.00");
                    cachdung.Text = dataGrid1[i, 11].ToString();
                    solan.Value = decimal.Parse(dataGrid1[i, 6].ToString());
                    decimal sl=decimal.Parse(dataGrid1[i, 7].ToString());
                    moilan.Text = sl.ToString("###,###,##0.00");
                    //lbldvt.Text = dang.Text;
                }
			}
			catch{}
		}

		private void ena_object(bool ena)
		{
			mabn.Visible=ena;
			cmbMabn.Visible=!ena;
			if (d.bNhapmaso) mabd.Enabled=ena;
            if (bBamhuyet) chkHuyet.Enabled=huyet.Enabled = ena;
			tim.Enabled=songay.Enabled=ena;
			ghichu.Enabled=ena;
			tenbd.Enabled=ena;            
            if (!bTayy)
            {
                if (bDonthuoc_stc)
                    c1.Enabled = c2.Enabled = c3.Enabled = c4.Enabled = chk1.Enabled = chk2.Enabled = false;
                else
                {
                    cachdung.Enabled= solan.Enabled = soluong.Enabled = false;
                    moilan.Enabled = ena;
                }
            }
            else
            {
                if (bDonthuoc_stc)
                    c1.Enabled = c2.Enabled = c3.Enabled = c4.Enabled = chk1.Enabled = chk2.Enabled = ena;
                else
                {
                    if (bSolan) solan.Enabled = ena;
                    moilan.Enabled = solan.Enabled;
                    soluong.Enabled = cachdung.Enabled = ena;
                }
            }
            if (i_loaiba == 4 || i_loaiba==1) tenbs.Enabled = ena;
            if (bChonkhoa) mabn.Enabled = hoten.Enabled = madoituong.Enabled = tenbs.Enabled = ena;
            else if (bNgoaitonkho) tenhc.Enabled = dang.Enabled = ena;
			butThem.Enabled=ena;
			butXoa.Enabled=ena;
			butLuu.Enabled=ena;
			butBoqua.Enabled=ena;
			butMoi.Enabled=!ena;
            butDongy.Enabled = (bDongy(makhosave, 1))?!ena:false;
			butCholai.Enabled=ena;
            butIn.Enabled=!ena;
			butHuy.Enabled=!ena;
			butSua.Enabled=!ena;
			butKetthuc.Enabled=!ena;
            donthuoc.Enabled = ena;            
            butGoi.Enabled=chkChon.Enabled = ena;
			i_old=cmbMabn.SelectedIndex;
			if (ena && !bChonkhoa) load_dm();
            if (ena) load_control();
            dataGrid1.ReadOnly = !ena;
		}

		private void emp_head()
		{
			if (bDiungthuoc)
			{
				diung.ForeColor=Color.FromArgb(0,0,128);
				diung.Tag="";
			}
            mabn.Text = s_mabn; hoten.Text = s_Hoten; hoten.Tag = s_Phai;
            string[] arr_nsinh = s_Namsinh.Split('^');
            namsinh.Text = arr_nsinh[0];
            if (arr_nsinh.Length > 1) namsinh.Tag = arr_nsinh[1];
            else namsinh.Tag = "";
			chandoan.Text=s_Chandoan;maicd.Text=s_Maicd;ghichu.Text="";
			tenpk.Text=s_Tenkp;tenbs.Text=s_Tenbs;sothe.Text=s_Sothe;
            makp.Text = s_makp; mabs.Text = s_mabs; s_ngayvv = s_ngay;
            l_id = 0; dsxoa.Clear(); s_ngaymakp = ""; songay.Value = iBhyt_songay;
            txtgiaban.Text  = txtdongia.Text = "0";
		}

		private void emp_detail()
		{
            solan.Value = (bTayy)?1:Math.Max(1,songay.Value); mabd.Text = ""; tenbd.Text = ""; tenhc.Text = ""; dang.Text = ""; cachdung.Text = ""; mahc.Text = "";
            moilan.Text=soluong.Text = ""; makho.SelectedIndex = -1; stt.Text = d.get_stt(dtct).ToString();
            if (!bChonkhoa)
            {
                try
                {
                    if (i_madoituong == 5) madoituong.SelectedValue = "2";
                    else madoituong.SelectedValue = i_madoituong.ToString();
                }
                catch { }
            }
            i_manguoncu = i_makhocu = i_mabdcu = 0; d_soluongcu = 0; lbldvt.Text = lblduongdung.Text = c1.Text = c2.Text = c3.Text = c4.Text = soluong1.Text = "";
            txtgiaban.Text = txtdongia.Text = "0";
            chk1.Checked = true; chk2.Checked = false;
		}

		private void load_dm()
		{
            dtton = d.get_tonkhoth_dutru_bhyt(i_nhom, s_mmyy, s_makho, s_makho_kp, s_manguon, (bDieutringtr) ? 0 : i_madoituong, bLocdichvu);
            if (bNgoaitonkho)
            {
                int irec = dtton.Rows.Count + 1;
                foreach (DataRow r in m.get_data("select * from " + user + ".d_dmbd where nhom=" + i_nhom + " and hide=-1 order by ten").Tables[0].Rows)
                    updrec(irec++, long.Parse(r["id"].ToString()),r["ma"].ToString(),r["ten"].ToString().Trim() + " " + r["hamluong"].ToString(), r["dang"].ToString(), r["tenhc"].ToString(), r["mahc"].ToString());
            }
			listDmbd.DataSource=dtton;
			listCachdung.DataSource=d.get_data("select ten as stt,ten from "+user+".d_dmcachdung order by ten").Tables[0];
		}

        private void updrec(int irec,long id,string ma,string ten,string dang,string tenhc,string mahc)
        {
            DataRow r1 = dtton.NewRow();
            r1["stt"] = irec;
            r1["tennguon"] = "Tự mua";
            r1["ma"] = ma;
            r1["ten"] = ten;
            r1["tenhc"] = tenhc;
            r1["dang"] = dang;
            r1["tenkho"] = "Tự mua";
            r1["soluong"] = 0;
            r1["id"] = id;
            r1["makho"] = -1;
            r1["bhyt"] = 0;
            r1["mahc"] = mahc;
            r1["manguon"] = -1;
            r1["tutruc"] = 0;
            dtton.Rows.Add(r1);
        }

        private void load_control()
        {
            foreach (System.Windows.Forms.Control c in this.Controls) if (c.Name == "dataGrid1") this.Controls.Remove(c);
            dataGrid1 = new System.Windows.Forms.DataGrid();
            this.dataGrid1.AlternatingBackColor = System.Drawing.Color.Lavender;
            this.dataGrid1.Anchor = ((System.Windows.Forms.AnchorStyles)((((System.Windows.Forms.AnchorStyles.Top | System.Windows.Forms.AnchorStyles.Bottom)
                        | System.Windows.Forms.AnchorStyles.Left)
                        | System.Windows.Forms.AnchorStyles.Right)));
            this.dataGrid1.BackColor = System.Drawing.Color.WhiteSmoke;
            this.dataGrid1.BackgroundColor = System.Drawing.SystemColors.Control;
            this.dataGrid1.BorderStyle = System.Windows.Forms.BorderStyle.None;
            this.dataGrid1.CaptionBackColor = System.Drawing.SystemColors.Control;
            this.dataGrid1.CaptionFont = new System.Drawing.Font("Tahoma", 8.25F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.dataGrid1.CaptionForeColor = System.Drawing.Color.MidnightBlue;
            this.dataGrid1.DataMember = "";
            this.dataGrid1.FlatMode = true;
            this.dataGrid1.Font = new System.Drawing.Font("Tahoma", 8.25F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.dataGrid1.ForeColor = System.Drawing.Color.MidnightBlue;
            this.dataGrid1.GridLineColor = System.Drawing.Color.Gainsboro;
            this.dataGrid1.GridLineStyle = System.Windows.Forms.DataGridLineStyle.None;
            this.dataGrid1.HeaderFont = new System.Drawing.Font("Tahoma", 8F, System.Drawing.FontStyle.Bold);
            this.dataGrid1.HeaderForeColor = System.Drawing.Color.WhiteSmoke;
            this.dataGrid1.LinkColor = System.Drawing.Color.Teal;
            this.dataGrid1.Location = new System.Drawing.Point(9, 120);
            this.dataGrid1.Name = "dataGrid1";
            this.dataGrid1.ParentRowsBackColor = System.Drawing.Color.Gainsboro;
            this.dataGrid1.ParentRowsForeColor = System.Drawing.Color.MidnightBlue;
            this.dataGrid1.ReadOnly = true;
            this.dataGrid1.RowHeaderWidth = 10;
            this.dataGrid1.SelectionBackColor = System.Drawing.Color.CadetBlue;
            this.dataGrid1.SelectionForeColor = System.Drawing.Color.WhiteSmoke;
            this.dataGrid1.Size = new System.Drawing.Size(i_w,i_h);//615,279
            this.dataGrid1.TabIndex = 281;
            this.dataGrid1.CurrentCellChanged += new System.EventHandler(this.dataGrid1_CurrentCellChanged);
            this.Controls.Add(dataGrid1);
            load_grid();
            AddGridTableStyle();
        }

        private bool moi()
        {
            if (!d.bMmyy(s_mmyy))
            {
                MessageBox.Show(lan.Change_language_MessageText("Số liệu tồn kho tháng ") + s_mmyy.Substring(0, 2) + lan.Change_language_MessageText(" năm 20") + s_mmyy.Substring(2) + lan.Change_language_MessageText(" chưa tạo !"), s_msg);
                return false;
            }
            
            DataRow r1;
            if (m.bDonthuoc_khambenh_1lan && i_loaiba != 1)
            {
                r1 = m.getrowbyid(dtll, "mabn='" + mabn.Text + "'");
                if (r1 != null)
                {
                    MessageBox.Show(lan.Change_language_MessageText("Đã nhập đơn thuốc !"), LibMedi.AccessData.Msg);
                    butSua.Focus();
                    return false;
                }
            }
            if (!(butMoi.Enabled && butDongy.Enabled))
            {
                r1 = m.getrowbyid(dtll, "mabn='" + mabn.Text + "' and done=0");
                if (r1 != null)
                {
                    MessageBox.Show(lan.Change_language_MessageText("Đã nhập đơn thuốc chưa duyệt !"), LibMedi.AccessData.Msg);
                    butSua.Focus();
                    return false;
                }
            }
            if (bKhoaso)
            {
                MessageBox.Show(lan.Change_language_MessageText("Số liệu tháng") + " " + s_mmyy.Substring(0, 2) + " " + lan.Change_language_MessageText("năm") + " " + s_mmyy.Substring(2, 2) + " " + lan.Change_language_MessageText("đã khóa !") + "\n" + lan.Change_language_MessageText("Nếu cần thay đổi thì vào mục khai báo hệ thống"), d.Msg);
                return false;
            }
            if (bInchitiet && i_loai != 7)
            {
                string tenkp = m.inchiphipk(s_ngay, l_mavaovien);
                if (tenkp != "")
                {
                    MessageBox.Show(lan.Change_language_MessageText("Đã in chi phí tại") + " " + tenkp + " !", s_msg);
                    return false;
                }
            }
            if (i_loaiba == 1 && !bChonkhoa && i_loai != 7)
            {
                if (m.get_thvpll(s_ngay, l_maql, s_ngayvao))
                {
                    MessageBox.Show(lan.Change_language_MessageText("Chi phí người bệnh đã chuyển xuống viện phí !"), LibMedi.AccessData.Msg);
                    return false;
                }
            }
            
            if (i_loaiba == 2)
            {
                if (m.get_data("select * from " + user + ".benhanngtr where maql=" + l_maql+" and ngayrv is not null").Tables[0].Rows.Count > 0)
                {
                    MessageBox.Show(lan.Change_language_MessageText("Người bệnh")+" "+s_Hoten+" "+lan.Change_language_MessageText("đã kết thúc điều trị !"), LibMedi.AccessData.Msg);
                    return false;
                }
            }
            
            string _ngay = m.ngayhienhanh_server.Substring(0, 10);
            if (bNgayhienhanh_thuoc_chidinh && s_ngay.Substring(0, 10) != _ngay && (bDuyet || i_madoituong == 5))//bDieutringtr)
            {
                MessageBox.Show(lan.Change_language_MessageText("Ngày cấp đơn không được khác ngày hiện hành") + " " + _ngay, LibMedi.AccessData.Msg);
                return false;
            }
            if (!m.ngay(m.StringToDate(s_ngayvao.Substring(0, 10)), m.StringToDate(_ngay), iKhoangcachngaycaptoa_voingaykham) && (i_loaiba == 3 || i_loaiba==4 || i_loaiba==2) && m.bAdminHethong(i_userid)==false)
            {
                if (iKhoangcachngaycaptoa_voingaykham>0)
                    MessageBox.Show(lan.Change_language_MessageText("Ngày cấp toa so với ngày khám vượt quá '") + iKhoangcachngaycaptoa_voingaykham.ToString() + "' ngày!", s_msg);
                else
                    MessageBox.Show(lan.Change_language_MessageText("Ngày cấp toa không được khác so với ngày khám !"), s_msg);
                return false;
            }
            //
            //
            if (bXemlai && s_ngay != m.ngayhienhanh_server && m.bAdminHethong(i_userid) == false)
            {
                MessageBox.Show(lan.Change_language_MessageText("Bạn chỉ được phép xem lại này chứ không được phép thêm mới."));
                return false;
            }
            //
            //
            bool bExit = false;
            decimal d_songay = 0;
            string ngay_cap = "";
            sql = "select songay,to_char(ngay,'dd/mm/yyyy') as ngay,to_char(ngay,'yyyymmdd') as yyyymmdd from xxx.d_thuocbhytll where mabn='" + s_mabn + "' and nhom=" + i_nhom + " and madoituong=" + i_madoituong;
            sql += " and ngay<to_timestamp('" + s_ngay.Substring(0, 10) + "','" + d.f_ngay + "')";
            sql += " order by ngay desc";
            foreach (DataRow r in d.get_thuoc(s_ngay, s_ngay, sql).Tables[0].Select("true", "yyyymmdd desc"))
            {
                ngay_cap = r["ngay"].ToString();
                d_songay = decimal.Parse(r["songay"].ToString());
                if (d_songay > 0) bExit = Math.Abs(m.songay(m.StringToDate(s_ngay.Substring(0, 10)), m.StringToDate(r["ngay"].ToString()), 0)) < d_songay;
                break;
            }
            if (bExit)
                if (MessageBox.Show(lan.Change_language_MessageText("Ngày") + " " + ngay_cap + " " + lan.Change_language_MessageText("cấp đơn thuốc") + " " + d_songay.ToString().Trim() + " " + lan.Change_language_MessageText("ngày") + "\n" + lan.Change_language_MessageText("Bạn có muốn cấp tiếp không ?"), LibMedi.AccessData.Msg, MessageBoxButtons.YesNo, MessageBoxIcon.Question, MessageBoxDefaultButton.Button2) == DialogResult.No) return false;

            ena_object(true);
            dtct.Clear();
            dtsave.Clear();

            emp_head();
            emp_detail();
            if (bDiungthuoc) load_diungthuoc(mabn.Text);
            bNew = true;
            bEdit = true;
            if (bChonkhoa) mabn.Focus();
            else if (tenbs.Enabled) tenbs.Focus();
            else songay.Focus();
            return true;
        }
        private void butDongy_Click(object sender, EventArgs e)
        {
            if (makhosave != "")
            {
                s_makho = "";
                sql = "select * from " + user + ".d_dmkho where dongy=1 and id in (" + makhosave.Substring(0, makhosave.Length - 1) + ")";
                foreach (DataRow r in m.get_data(sql).Tables[0].Rows) s_makho += r["id"].ToString().PadLeft(3,'0') + ",";
            }
            chkChitiet.Checked = true;
            label9.Text = " thang";
            bTayy = false;
            if (!moi()) return;
        }

		private void butMoi_Click(object sender, System.EventArgs e)
		{
            if (makhosave != "")
            {
                s_makho = "";
                sql = "select * from " + user + ".d_dmkho where dongy=0 and id in (" + makhosave.Substring(0, makhosave.Length - 1) + ")";
                foreach (DataRow r in m.get_data(sql).Tables[0].Rows) s_makho += r["id"].ToString().PadLeft(3,'0') + ",";
            }
            chkChitiet.Checked = false;
            label9.Text = " ngày";
            bTayy = true;        
            if (!moi()) return;
		}

		private void butSua_Click(object sender, System.EventArgs e)
		{
			if (dtll.Rows.Count==0) return;
            if (bXemlai && s_ngay != m.ngayhienhanh_server && m.bAdminHethong(i_userid)==false)
            {
                MessageBox.Show(lan.Change_language_MessageText("Bạn chỉ được phép xem lại toa này chứ không được phép sửa."));
                return;
            }
			l_id=long.Parse(cmbMabn.SelectedValue.ToString());
            if (bKhoaso)
            {
                MessageBox.Show(lan.Change_language_MessageText("Số liệu tháng")+" " + s_mmyy.Substring(0, 2) + " "+lan.Change_language_MessageText("năm")+" " + s_mmyy.Substring(2, 2) + " "+lan.Change_language_MessageText("đã khóa !")+"\n"+lan.Change_language_MessageText("Nếu cần thay đổi thì vào mục khai báo hệ thống"), d.Msg);
                return;
            }
            if (bInchitiet && i_loai!=7)
            {
                string tenkp = m.inchiphipk(s_ngay, l_mavaovien);
                if (tenkp != "")
                {
                    MessageBox.Show(lan.Change_language_MessageText("Đã in chi phí tại") + " " + tenkp + " !", s_msg);
                    return;
                }
            }
            else
            {
                bDone = d.get_done_thuocbhyt(s_ngay, l_id);
                if (bDone)
                {
                    MessageBox.Show(lan.Change_language_MessageText("Đã cập nhật !"), s_msg);
                    return;
                }
            }
            if (i_loaiba == 2)
            {
                if (m.get_data("select * from " + user + ".benhanngtr where maql=" + l_maql+" and ngayrv is not null").Tables[0].Rows.Count > 0)
                {
                    MessageBox.Show(lan.Change_language_MessageText("Người bệnh")+" " + s_Hoten + " "+lan.Change_language_MessageText("đã kết thúc điều trị !"), LibMedi.AccessData.Msg);
                    return;
                }
            }
            if (butMoi.Enabled && butDongy.Enabled)
            {
                if (makhosave != "")
                {
                    s_makho = "";
                    sql = "select * from " + user + ".d_dmkho where dongy="+((bTayy)?0:1)+" and id in (" + makhosave.Substring(0, makhosave.Length - 1) + ")";
                    foreach (DataRow r in m.get_data(sql).Tables[0].Rows) s_makho += r["id"].ToString().PadLeft(3, '0') + ",";
                }
            }
			ena_object(true);
			butCholai.Enabled=false;
			bNew=false;
			bEdit=true;
            s_ngaymakp = "";
			dtsave=dtct.Copy();
			dsxoa.Clear();
			ref_text();
			dataGrid1.Focus();
		}

		private bool kiemtra()
		{
			if (bKiemtrathuoc)
			{
				string ret=d.kiemtra_toathuoc(dtdmbd,dtct,mabn.Text,i_nhom,s_ngay,l_id);
				if (ret!="")
					if (MessageBox.Show(lan.Change_language_MessageText("Những thuốc sau đã kê toa :")+"\n"+ret+lan.Change_language_MessageText("Bạn có đồng ý kê toa này !"),LibMedi.AccessData.Msg,MessageBoxButtons.YesNo,MessageBoxIcon.Question,MessageBoxDefaultButton.Button2)==DialogResult.No) return false;
			}
            if (dtct.Rows.Count == 0)
            {
                MessageBox.Show(lan.Change_language_MessageText("Đề nghị nhập thuốc !"), LibMedi.AccessData.Msg);
                butThem.Focus();
                return false;
            }
            if (tenbs.Enabled && tenbs.Text == "")
            {
                MessageBox.Show(lan.Change_language_MessageText("Chọn bác sỹ điều trị !"), LibMedi.AccessData.Msg);
                tenbs.Focus();
                return false;
            }
            if (bTayy && sothe.Text != "" && songay.Value!=0)
            {
                string denngay = "";
                sql = "select to_char(a.tungay,'dd/mm/yyyy') as tungay,to_char(a.denngay,'dd/mm/yyyy') as denngay,b.tenbv ";
                sql += " from " + xxx + ".bhyt a left join " + user + ".dmnoicapbhyt b on a.mabv=b.mabv where a.maql=" + l_maql;
                foreach (DataRow r in m.get_data(sql).Tables[0].Rows)
                {
                    denngay = r["denngay"].ToString();
                    break;
                }
                if (denngay != "")
                {
                    long so = m.songay(m.StringToDate(denngay), m.StringToDate(s_ngay), 1);
                    if (songay.Value > so)
                    {
                        if (MessageBox.Show(lan.Change_language_MessageText("Hạn sử dụng thẻ đến ngày")+" " + denngay + ", còn lại " + so.ToString() + " ngày\nSố ngày cấp đơn " + songay.Value.ToString() + " vượt quá hạn sử dụng\nBạn có tiếp tục không ?", LibMedi.AccessData.Msg, MessageBoxButtons.YesNo, MessageBoxIcon.Question, MessageBoxDefaultButton.Button2) == DialogResult.No)
                        {
                            songay.Focus();
                            return false;
                        }
                    }
                }
            }
			return true;
		}
		private void butLuu_Click(object sender, System.EventArgs e)
		{
			bEdit=false;
			upd_table(dtct,"-");
			dtct.AcceptChanges();
			i_old=(bNew)?0:1;
			l_id=(bNew)?d.get_id_bhyt:l_id;
			if (!kiemtra()) return;
            itable = m.tableid(m.mmyy(s_ngay), "d_thuocbhytll");
            if (!bNew)
            {
                m.upd_eve_tables(s_ngay, itable, i_userid, "upd");
                m.upd_eve_upd_del(s_ngay, itable, i_userid, "upd",m.fields(xxx+".d_thuocbhytll","id="+l_id));
            }
            else m.upd_eve_tables(s_ngay, itable, i_userid, "ins");
			if (!d.upd_thuocbhytll(l_id,i_nhom,s_ngay,mabn.Text,l_mavaovien,l_maql,i_userid,(bChonkhoa)?5:i_madoituong,ghichu.Text,songay.Value,makp.Text,mabs.Text,chandoan.Text,maicd.Text,i_loaiba))
			{
				MessageBox.Show(lan.Change_language_MessageText("Không cập nhật được thông tin !"),s_msg);
				return;
			}
            if (i_loaiba == 1)
            {
                foreach (DataRow r in m.get_data("select mabv,sothe,to_char(denngay,'dd/mm/yyyy') as denngay,to_char(tungay,'dd/mm/yyyy') as tungay,maphu from " + user + ".bhyt where maql=" + l_maql).Tables[0].Rows)
                    m.upd_bhyt(s_ngay, mabn.Text, l_maql, r["sothe"].ToString(), r["denngay"].ToString(), r["mabv"].ToString(), int.Parse(r["maphu"].ToString()), r["tungay"].ToString(),ngay1,ngay2,ngay3,traituyen);
            }
			if (!bNew)
			{
                itable = m.tableid(m.mmyy(s_ngay), "d_thuocbhytct");
				foreach(DataRow r1 in dsxoa.Tables[0].Rows)
				{
                    m.upd_eve_tables(s_ngay, itable, i_userid, "del");
                    m.upd_eve_upd_del(s_ngay, itable, i_userid, "del",m.fields(xxx+".d_thuocbhytct","id="+l_id+" and stt="+long.Parse(r1["stt"].ToString())));
					d.execute_data("delete from "+xxx+".d_thuocbhytct where id="+l_id+" and stt="+long.Parse(r1["stt"].ToString()));
				}
                foreach (DataRow r1 in dtsave.Rows)
                {
                    d.upd_tonkhoth_dutru(d.delete, i_nhom, s_mmyy, int.Parse(r1["makho"].ToString()), int.Parse(r1["manguon"].ToString()), int.Parse(r1["mabd"].ToString()), decimal.Parse(r1["soluong"].ToString()));
                    m.upd_eve_tables(s_ngay, itable, i_userid, "upd");
                }
			}
            itable = m.tableid(m.mmyy(s_ngay), "d_thuocbhytct");
			foreach(DataRow r1 in dtct.Rows)
			{
                d.upd_thuocbhytct(s_ngay, l_id, int.Parse(r1["stt"].ToString()), int.Parse(r1["makho"].ToString()), int.Parse(r1["mabd"].ToString()), decimal.Parse(r1["soluong"].ToString()), r1["cachdung"].ToString(), int.Parse(r1["manguon"].ToString()), decimal.Parse(r1["solan"].ToString()), decimal.Parse(r1["lan"].ToString()),int.Parse(r1["madoituong"].ToString()));
				d.upd_tonkhoth_dutru(d.insert,i_nhom,s_mmyy,int.Parse(r1["makho"].ToString()),int.Parse(r1["manguon"].ToString()),int.Parse(r1["mabd"].ToString()),decimal.Parse(r1["soluong"].ToString()));
				if (r1["cachdung"].ToString()!="" && bCachdung) d.upd_dmcachdung(r1["cachdung"].ToString());
                if (bNew) m.upd_eve_tables(s_ngay, itable, i_userid, "ins");
			}
			d.updrec_thuocbhytll(dtll,l_id,s_ngay,mabn.Text,l_maql,hoten.Text,namsinh.Text,sothe.Text,chandoan.Text,maicd.Text,tenpk.Text,tenbs.Text,ghichu.Text,makp.Text,mabs.Text,songay.Value);
			try
			{
				if (i_old==0 && dtll.Rows.Count>0) cmbMabn.SelectedIndex=dtll.Rows.Count-1;
			}
			catch{}
			if (bDiungthuoc) upd_diung();
			load_grid();
            if (bNew && bLuu_Donthuoc_bacsy) luu_don();
            if (bDuyet) upd_duoc();
			ena_object(false);
            if (bDonthuoc_stc)
            {
                soluong1.Enabled = false;
                cachdung.Enabled = false;
            }
            if (bChonkhoa) netsend();
            tenhc.Enabled = dang.Enabled = false;
            if (chkLuuin.Checked) butIn_Click(sender, e);
            else butMoi.Focus();
		}

        private void netsend()
        {
            if (bTinnhan || bTinnhan_sound)
            {
                string _makho = "";
                foreach (DataRow r in dtct.Rows)
                    if (_makho.IndexOf(r["makho"].ToString() + ",") == -1) _makho += r["makho"].ToString() + ",";
                _makho = (_makho == "") ? _makho : _makho.Substring(0, _makho.Length - 1);
                sql = "true";
                if (_makho != "") sql += " and id in (" + _makho + ")";
                if (bTinnhan)
                {
                    foreach (DataRow r in dtkho.Select(sql))
                        if (r["computer"].ToString() != "")
                            d.netsend(d.sDomain(i_nhom), r["computer"].ToString().Trim(), "DON THUOC " + mabn.Text + " " + m.khongdau(hoten.Text));
                }
                if (bTinnhan_sound)
                {
                    foreach (DataRow r in dtkho.Select(sql))
                        if (r["computer"].ToString() != "")
                            m.upd_tinnhan(r["computer"].ToString().Trim(), "duoc",1);
                }
            }
        }

        private void upd_duoc()
        {
            itable = d.tableid(s_mmyy, "bhytthuoc");
            if (!bNew)            
            {
                sql = "select a.*,t.manguon,t.nhomcc,t.handung,t.losx,t.giamua,t.giaban,a.soluong*t.giamua as sotienmua from " + zzz + ".bhytthuoc a," + zzz + ".d_theodoi t where a.sttt=t.id and a.id=" + l_id;
                foreach (DataRow r1 in d.get_data(sql).Tables[0].Rows)
                {
                    d.upd_eve_tables(s_mmyy, itable, i_userid, "del");
                    d.upd_eve_upd_del(s_mmyy, itable, i_userid, "del", d.fields(zzz + ".bhytthuoc", "id=" + l_id + " and stt=" + long.Parse(r1["stt"].ToString())));
                    d.execute_data("delete from " + zzz + ".bhytthuoc where id=" + l_id + " and stt=" + long.Parse(r1["stt"].ToString()));
                    d.upd_tonkhoct_xuat(d.delete, s_mmyy, long.Parse(r1["sttt"].ToString()), int.Parse(r1["makho"].ToString()), int.Parse(r1["manguon"].ToString()), int.Parse(r1["nhomcc"].ToString()), int.Parse(r1["mabd"].ToString()), r1["handung"].ToString(), r1["losx"].ToString(), decimal.Parse(r1["soluong"].ToString()), decimal.Parse(r1["sotienmua"].ToString()), decimal.Parse(r1["giaban"].ToString()), decimal.Parse(r1["giamua"].ToString()));
                }
            }
            if (!d.upd_bhytds(s_mmyy, s_mabn, s_Hoten, s_Namsinh.Substring(0,4), s_diachi))
            {
                MessageBox.Show(lan.Change_language_MessageText("Không cập nhật được thông tin !"), LibMedi.AccessData.Msg);
                return;
            }
            itable = d.tableid(s_mmyy, "bhytkb");
            if (bNew) d.upd_eve_tables(s_mmyy, itable, i_userid, "ins");
            else
            {
                d.upd_eve_tables(s_mmyy, itable, i_userid, "upd");
                d.upd_eve_upd_del(s_mmyy, itable, i_userid, "upd", d.fields(zzz + ".bhytkb", "id=" + l_id));
            }
            if (!d.upd_bhytkb(s_mmyy, l_id, i_nhom, s_ngay, s_mabn, l_mavaovien, l_maql, s_makp, s_Chandoan, s_Maicd, s_mabs, s_Sothe, i_madoituong, s_noidkkcb, iUserid_duyet,i_loaiba,traituyen))
            {
                MessageBox.Show(lan.Change_language_MessageText("Không cập nhật được thông tin !"), LibMedi.AccessData.Msg);
                return;
            }
            DataTable tmp = d.get_bhytthuoc(s_mmyy, load_thuoc(l_id), l_id, (i_loaiba == 2) ? 0 : i_madoituong);
            d.execute_data("update " + xxx + ".d_thuocbhytll set done=1 where id=" + l_id);
            int d_toaso = d.get_sotoa_bhyt(s_mmyy, l_id, s_ngay.Substring(0,10), i_madoituong);
            d.execute_data("update " + zzz + ".bhytkb set sotoa=" + d_toaso + " where id=" + l_id);
        }

        private DataTable load_thuoc(long id)
        {
            sql = "select a.stt,0 as sttt,a.mabd,b.ma,trim(b.ten)||' '||b.hamluong as ten,";
            sql += " b.tenhc,b.dang,e.ten as tenkho,c.ten as tennguon,' ' as tennhomcc,";
            sql += " ' ' as handung,' ' as losx,ceiling(a.slyeucau) as soluong,0 as dongia,0 as sotien,0 as giaban,0 as sotienmua,";
            sql += " a.cachdung,a.makho,a.manguon,0 as nhomcc,0 as giamua ";
            sql += " from " + xxx + ".d_thuocbhytct a," + user + ".d_dmbd b," + user + ".d_dmnguon c," + user + ".d_dmkho e ";
            sql += " where a.mabd=b.id and a.manguon=c.id and a.makho=e.id ";
            sql += " and a.id=" + id + " order by a.stt";
            return d.get_data(sql).Tables[0];
        }

        private void luu_don()
        {
            string ma1 = "", ma2 = "";
            int so = dtct.Select("soluong>0").Length;
            DataTable tmp;
            bool bFound = false;
            foreach (DataRow r in dtct.Select("soluong>0", "mabd,soluong")) ma1 += r["mabd"].ToString().PadLeft(7, '0') + r["soluong"].ToString().Trim() + ",";
            foreach (DataRow r in m.get_data("select * from "+user+".d_theodonll where mabs='" + s_mabs + "' and maicd='" + s_Maicd + "'").Tables[0].Rows)
            {
                tmp = m.get_data("select * from "+user+".d_theodonct where id=" + long.Parse(r["id"].ToString())).Tables[0];
                if (so == tmp.Select("soluong>0").Length)
                {
                    ma2 = "";
                    foreach (DataRow r1 in tmp.Select("soluong>0", "mabd,soluong")) ma2 += r1["mabd"].ToString().PadLeft(7, '0') + r1["soluong"].ToString().Trim() + ",";
                    if (ma1 == ma2)
                    {
                        bFound = true; break;
                    }
                }
            }
            if (!bFound)
            {
                long id = d.get_id_donthuoc_bacsy();
                d.upd_theodonll(id, s_mabs, s_Maicd, s_Chandoan, m.stt(s_mabs, s_Maicd, id), so, songay.Value);
                int stt = 1;
                foreach (DataRow r in dtct.Select("soluong>0"))
                    d.upd_theodonct(id, int.Parse(r["mabd"].ToString()), decimal.Parse(r["soluong"].ToString()), r["cachdung"].ToString(),stt++);
            }
        }

		private void butBoqua_Click(object sender, System.EventArgs e)
		{
			bEdit=false;
			try
			{
				cmbMabn.SelectedIndex=i_old;
				if (cmbMabn.Items.Count>0) l_id=long.Parse(cmbMabn.SelectedValue.ToString());
				else l_id=0;
			}
			catch{l_id=0;}
            cmbMabn.SelectedValue = l_id.ToString();
            ena_object(false);
            if (butDongy.Enabled && butMoi.Enabled)
            {
                sql = "select distinct f.dongy";
                sql += " from " + xxx + ".d_thuocbhytct a inner join " + user + ".d_dmbd b on a.mabd=b.id ";
                sql += " left join " + user + ".d_dmkho f on a.makho=f.id ";
                sql += " inner join " + user + ".doituong c on a.madoituong=c.madoituong ";
                sql += " where a.id=" + l_id;
                DataTable tmp = d.get_data(sql).Tables[0];
                if (tmp.Rows.Count > 0)
                {
                    if (tmp.Rows[0]["dongy"].ToString() == "1")
                    {
                        label9.Text = "thang";
                        bTayy = false;
                        chkChitiet.Checked = true;
                    }
                    else
                    {
                        bTayy = true;
                        label9.Text = "ngày";
                        chkChitiet.Checked = false;
                    }
                    load_control();
                }
            }
			load_head();			
            load_control();
            tenhc.Enabled = dang.Enabled = false;
			butMoi.Focus();
		}

		private void Filter_cachdung(string ten)
		{
			try
			{
				CurrencyManager cm= (CurrencyManager)BindingContext[listCachdung.DataSource];
				DataView dv=(DataView)cm.List;
				dv.RowFilter="ten like '%"+ten.Trim()+"%'";
			}
			catch{}
		}

		private void butKetthuc_Click(object sender, System.EventArgs e)
		{
            m.writeXml("thongso", "banin_" + ((i_loai == 7) ? "7" : "1"), banin.Value.ToString());
			m.close();this.Close();
		}

		private void cachdung_TextChanged(object sender, System.EventArgs e)
		{
			if (this.ActiveControl==cachdung)
			{
				Filter_cachdung(cachdung.Text);
				listCachdung.BrowseToBtdkp(cachdung,cachdung,butThem);
			}
		}

		private void cachdung_KeyDown(object sender, System.Windows.Forms.KeyEventArgs e)
		{
			if(e.KeyCode==Keys.Down || e.KeyCode==Keys.Up) listCachdung.Focus(); 
			else if (e.KeyCode==Keys.Enter)
			{
				if (listCachdung.Visible) listCachdung.Focus();
				else SendKeys.Send("{Tab}");
			}		
			else if(e.KeyCode==Keys.F2)
			{				
				cachdung.Text=m.Viettat(cachdung.Text)+" ";
				SendKeys.Send("{END}");				
			}
		}

		private void Filter_mabd(string ma)
		{
			try
			{
				CurrencyManager cm= (CurrencyManager)BindingContext[listDmbd.DataSource];
				DataView dv=(DataView)cm.List;
				sql="ma like '%"+ma.Trim()+"%'";
                if (!bNgoaitonkho) sql += " and soluong>0";
                if (bThuphi_khongloadthuoc_BHYT && madoituong.SelectedValue.ToString() != "1") sql += " and bhyt=0 ";
                if (bCaptoa_theodanhmuc_duocketoa) sql += " and ketoa=1";
				dv.RowFilter=sql;
			}
			catch{}
		}

		private void Filter_dmbd(string ten)
		{
			try
			{
				CurrencyManager cm= (CurrencyManager)BindingContext[listDmbd.DataSource];
				DataView dv=(DataView)cm.List;
                sql="(ten like '%"+ten.Trim()+"%'"+" or tenhc like '%"+ten.Trim()+"%')";
                if (!bNgoaitonkho) sql+=" and (soluong>0)";
                if (madoituong.SelectedValue.ToString() == "1" && bLocdichvu) sql += " and (bhyt>0)";
                if (bThuphi_khongloadthuoc_BHYT && madoituong.SelectedValue.ToString() != "1") sql += " and bhyt=0 ";
                if (bCaptoa_theodanhmuc_duocketoa) sql += " and ketoa=1";
				dv.RowFilter=sql;
			}
			catch{}
		}


		private void mabd_TextChanged(object sender, System.EventArgs e)
		{
			if (this.ActiveControl==mabd)
			{
				if (butSua.Enabled) return;
				Filter_mabd(mabd.Text);
                if (chkChitiet.Checked) listDmbd.Tonkhoct(mabd, tenbd, moilan, madoituong.Location.X, mabd.Location.Y + mabd.Height - 2, mabd.Width + lTen.Width + tenbd.Width + lMabd.Width + lTenhc.Width + tenhc.Width + dang.Width + manguon.Width, mabd.Height + 5);
                else if (bDonthuoc_stc) listDmbd.Tonkhoct(mabd, tenbd, c1, madoituong.Location.X, mabd.Location.Y + mabd.Height - 2, mabd.Width + lTen.Width + tenbd.Width + lMabd.Width + lTenhc.Width + tenhc.Width + dang.Width + manguon.Width, mabd.Height + 5);
                else if (solan.Enabled) listDmbd.Tonkhoct(mabd, tenbd, solan, madoituong.Location.X, mabd.Location.Y + mabd.Height - 2, mabd.Width + lTen.Width + tenbd.Width + lMabd.Width + lTenhc.Width + tenhc.Width + dang.Width+manguon.Width, mabd.Height + 5);
                else listDmbd.Tonkhoct(mabd,tenbd,soluong,madoituong.Location.X,mabd.Location.Y + mabd.Height-2,mabd.Width+lTen.Width+tenbd.Width+lMabd.Width+lTenhc.Width+tenhc.Width+dang.Width+manguon.Width,mabd.Height+5);
			}
		}

		private void tenbd_TextChanged(object sender, System.EventArgs e)
		{
			if (this.ActiveControl==tenbd)
			{
				if (butSua.Enabled) return;
				Filter_dmbd(tenbd.Text);
                if (chkChitiet.Checked) listDmbd.Tonkhoct(tenbd, mabd, moilan, madoituong.Location.X, mabd.Location.Y + mabd.Height - 2, mabd.Width + lTen.Width + tenbd.Width + lMabd.Width + lTenhc.Width + tenhc.Width + dang.Width + manguon.Width, mabd.Height + 5);
                else if (bDonthuoc_stc) listDmbd.Tonkhoct(tenbd, mabd, c1, madoituong.Location.X, mabd.Location.Y + mabd.Height - 2, mabd.Width + lTen.Width + tenbd.Width + lMabd.Width + lTenhc.Width + tenhc.Width + dang.Width + manguon.Width, mabd.Height + 5);
                else if (solan.Enabled) listDmbd.Tonkhoct(tenbd, mabd, solan, madoituong.Location.X, mabd.Location.Y + mabd.Height - 2, mabd.Width + lTen.Width + tenbd.Width + lMabd.Width + lTenhc.Width + tenhc.Width + dang.Width+manguon.Width, mabd.Height + 5);
				else listDmbd.Tonkhoct(tenbd,mabd,soluong,madoituong.Location.X,mabd.Location.Y + mabd.Height-2,mabd.Width+lTen.Width+tenbd.Width+lMabd.Width+lTenhc.Width+tenhc.Width+dang.Width+manguon.Width,mabd.Height+5);
			}
		}

		private void tenbd_KeyDown(object sender, System.Windows.Forms.KeyEventArgs e)
		{
			if(e.KeyCode==Keys.Down || e.KeyCode==Keys.Up) listDmbd.Focus();
			else if (e.KeyCode==Keys.Enter)
			{
				if (listDmbd.Visible) listDmbd.Focus();
				else SendKeys.Send("{Tab}");
			}
		}

		private void tenbd_Validated(object sender, System.EventArgs e)
		{
			if(!listDmbd.Focused) listDmbd.Hide();
		}

		private void listDmbd_KeyDown(object sender, System.Windows.Forms.KeyEventArgs e)
		{
			if (e.KeyCode==Keys.Enter)
			{
				try
				{
					r=d.getrowbyid(dtton,"stt="+int.Parse(mabd.Text));
                    if (r != null)
                    {
                        mabd.Text = r["ma"].ToString();
                        tenbd.Text = r["ten"].ToString();
                        tenhc.Text = r["tenhc"].ToString();
                        lbldungluc.Text = r["dungluc"].ToString();
                        dang.Text = r["dang"].ToString();
                        dang.Tag = r["donvidung"].ToString();
                        makho.SelectedValue = r["makho"].ToString();
                        mahc.Text = r["mahc"].ToString().Trim();
                        manguon.SelectedValue = r["manguon"].ToString();
                        txtdongia.Text = r["dongia"].ToString();
                        txtgiaban.Text = r["giaban"].ToString();
                        if (!bTayy) solan.Value = Math.Max(1, songay.Value);
                        if (madoituong.SelectedValue.ToString() == "1" && !bLocdichvu)
                        {
                            if (d.getrowbyid(dtdmbd, "ma='" + mabd.Text + "' and bhyt>0")==null)
                            {
                                madoituong.SelectedValue = i_tunguyen;
                                madoituong.Update();
                            }
                        }
                        if (bDonthuoc_stc)
                        {
                            DataRow r1 = d.getrowbyid(dtdmbd, "ma='" + mabd.Text + "'");
                            if (r1 != null)
                                lblduongdung.Text = r1["duongdung"].ToString().Trim();
                        }
                        else lbldvt.Text = (dang.Tag.ToString()!="")?dang.Tag.ToString():r["dang"].ToString();//.Text;
                        #region diung
                        if (bDiungthuoc)
                        {
                            bool bFound = false;
                            if (diung.Tag.ToString() != "" && mahc.Text != "")
                            {
                                int i = 0;
                                while (i < diung.Tag.ToString().Length)
                                {
                                    if (mahc.Text.IndexOf(diung.Tag.ToString().Substring(i, 7)) != -1)
                                    {
                                        bFound = true;
                                        break;
                                    }
                                    i += 7;
                                }
                            }
                            if (bFound)
                            {
                                if (MessageBox.Show(lan.Change_language_MessageText("Người bệnh dị ứng thuốc")+" "+" \n" + tenhc.Text.Trim() + "\nBạn có đồng ý thêm vào không !", LibMedi.AccessData.Msg, MessageBoxButtons.YesNo, MessageBoxIcon.Exclamation, MessageBoxDefaultButton.Button2) == DialogResult.Yes) soluong.Focus();
                                else
                                {
                                    mabd.Text = ""; tenbd.Text = ""; tenhc.Text = ""; dang.Text = ""; mahc.Text = ""; lbldungluc.Text = "";
                                    mabd.Focus();
                                }
                            }
                        }
                        #endregion
                    }
                    else if (bNgoaitonkho)
                    {
                        if (tenbd.Text == "") tenbd.Focus();
                        else tenhc.Focus();
                    }
				}
                catch 
                {
                    if (bNgoaitonkho)
                    {
                        if (tenbd.Text == "") tenbd.Focus();
                        else tenhc.Focus(); 
                    }
                }
			}
		}

		private void cachdung_Validated(object sender, System.EventArgs e)
		{
			if(!listCachdung.Focused) listCachdung.Hide();
		}

		private void cmbMabn_KeyDown(object sender, System.Windows.Forms.KeyEventArgs e)
		{
			if (e.KeyCode==Keys.Enter) SendKeys.Send("{Tab}");
		}

		private void cmbMabn_SelectedIndexChanged(object sender, System.EventArgs e)
		{
			if (this.ActiveControl==cmbMabn) 
			{
				try
				{
					l_id=long.Parse(cmbMabn.SelectedValue.ToString());
				}
				catch{l_id=0;}
                if (butDongy.Enabled && butMoi.Enabled)
                {
                    sql = "select distinct f.dongy";
                    sql += " from " + xxx + ".d_thuocbhytct a inner join " + user + ".d_dmbd b on a.mabd=b.id ";
                    sql += " left join " + user + ".d_dmkho f on a.makho=f.id ";
                    sql += " inner join " + user + ".doituong c on a.madoituong=c.madoituong ";
                    sql += " where a.id=" + l_id;
                    DataTable tmp = d.get_data(sql).Tables[0];
                    if (tmp.Rows.Count > 0)
                    {
                        if (tmp.Rows[0]["dongy"].ToString() == "1")
                        {
                            label9.Text = "thang";
                            bTayy = false;
                            chkChitiet.Checked = true;
                        }
                        else
                        {
                            bTayy = true;
                            label9.Text = "ngày";
                            chkChitiet.Checked = false;
                        }
                        load_control();
                    }
                }
				load_head();
			}
		}

		private void load_head()
		{
			try
			{
				r=d.getrowbyid(dtll,"id="+l_id);
				if (r!=null)
				{
					mabn.Text=r["mabn"].ToString();
					hoten.Text=r["hoten"].ToString();
					tenbs.Text=r["tenbs"].ToString();
					tenpk.Text=r["tenkp"].ToString();
					chandoan.Text=r["chandoan"].ToString();
					maicd.Text=r["maicd"].ToString();
					namsinh.Text=r["namsinh"].ToString();
                    namsinh.Tag = r["ngaysinh"].ToString();
					sothe.Text=r["sothe"].ToString();
					ghichu.Text=r["ghichu"].ToString();
                    songay.Value = decimal.Parse(r["songay"].ToString());
                    makp.Text = r["makp"].ToString();
                    mabs.Text = r["mabs"].ToString();
					//l_maql=long.Parse(r["maql"].ToString());
					//if (i_sudungthuoc!=3) load_treeview();
                    if (bDiungthuoc) load_diungthuoc(mabn.Text);
                    if (bChonkhoa)
                    {
                        r = m.getrowbyid(dthoten, "mabn='" + mabn.Text + "'");
                        if (r != null)
                        {
                            nam = r["nam"].ToString();
                            s_ngayvv = r["ngay"].ToString();
                            l_maql = long.Parse(r["maql"].ToString());
                            l_mavaovien = long.Parse(r["mavaovien"].ToString());
                            s_noidkkcb = r["mabv"].ToString();
                            ngay1 = r["ngay1"].ToString();
                            ngay2 = r["ngay2"].ToString();
                            ngay3 = r["ngay3"].ToString();
                            traituyen = int.Parse(r["traituyen"].ToString());
                        }
                    }
				}
			}
			catch{l_id=0;}
			load_grid();
			ref_text();
            if (chkThuoc.Checked) load_treeview();
		}

		private bool KiemtraDetail(string tt)
		{
			i_mabd=0;
			if (mabd.Text=="" && tenbd.Text=="")
			{
				if (mabd.Enabled) mabd.Focus();
				else tenbd.Focus();
				return false;
			}
			if ((mabd.Text=="" && tenbd.Text!="") || (mabd.Text!="" && tenbd.Text==""))
			{
				if (mabd.Text=="" && mabd.Enabled)
				{
					MessageBox.Show(lan.Change_language_MessageText("Nhập mã số !"),s_msg);
					mabd.Focus();
					return false;
				}
				else if (tenbd.Text=="")
				{
					MessageBox.Show(lan.Change_language_MessageText("Nhập tên !"),s_msg);
					tenbd.Focus();
					return false;
				}
			}
			r=d.getrowbyid(dtton,"ma='"+mabd.Text+"'");
			if (r==null)
			{
                if (!bNgoaitonkho)
                {
                    MessageBox.Show(lan.Change_language_MessageText("Mã số không hợp lệ !"), s_msg);
                    if (mabd.Enabled) mabd.Focus();
                    else tenbd.Focus();
                    return false;
                }
                else
                {
                    i_mabd = Convert.ToInt32(d.get_id_dmbd);
                    mabd.Text=d.getMabd("d_dmbd",tenbd.Text,i_nhom);
                    d.upd_dmbd(i_mabd, mabd.Text, tenbd.Text, dang.Text, "", -1, -1, -1, -1, 0, 0, 0, 0, tenhc.Text, "", 0, i_nhom, "", 0, 0, 0, 0, 0, 0, "", 0, 0, "", "", 0, "", 0,dang.Text);
                    d.execute_data("update " + user + ".d_dmbd set hide=-1 where id=" + i_mabd);
                    updrec(dtton.Rows.Count + 1, i_mabd,mabd.Text,tenbd.Text, dang.Text, tenhc.Text, mahc.Text);
                    makho.SelectedValue=manguon.SelectedValue = "-1";
                }
			}
			else i_mabd=int.Parse(r["id"].ToString());
            if (bDonthuoc_stc)
            {
                if (soluong1.Text == "" || soluong1.Text == "0.00" || soluong1.Text == "0")
                {
                    MessageBox.Show(lan.Change_language_MessageText("Nhập số lượng !"), s_msg);
                    soluong1.Focus();
                    return false;
                }
            }
            else
            {
                if (soluong.Text == "" || soluong.Text == "0.00" || soluong.Text == "0")
                {
                    MessageBox.Show(lan.Change_language_MessageText("Nhập số lượng !"), s_msg);
                    soluong.Focus();
                    return false;
                }
            }
            if (!bDutru_n_thuoc)
            {
                if (d_soluongcu != 0) return true;
                else if (dtct.Select("mabd=" + i_mabd).Length > 0 && tt == "-")
                {
                    MessageBox.Show(tenbd.Text.Trim() + " " + dang.Text.Trim() + " đã nhập !", LibMedi.AccessData.Msg);
                    mabd.Focus();
                    return false;
                }
            }
			return true;
		}

		private void butThem_Click(object sender, System.EventArgs e)
		{
			if (d.bNhapmaso) mabd.Enabled=true;
			tenbd.Enabled=true;			
			if (!upd_table(dtct,"-")) return;
            if (i_madoituong == 1 && bTongtien_donduyet && iSotien_cancanhbao_khicaptoa > 0) 
            {
                tong();
                if(decimal.Parse(sum.Text) > decimal.Parse(iSotien_cancanhbao_khicaptoa.ToString()))
                {
                    MessageBox.Show(lan.Change_language_MessageText("Tổng số tiền toa thuốc :'" + sum.Text + "' vượt quá số tiền qui định '" + iSotien_cancanhbao_khicaptoa.ToString("###,###,###.0#") + "'"));
                    //ref_text();
                    //soluong.Focus();
                    //return;
                }
            }
			emp_detail();
            if (bDonthuoc_stc)
            {
                soluong1.Enabled = false;
                cachdung.Enabled = false;
            }
            else if (bTayy) soluong.Enabled = true;
            if (madoituong.Enabled) madoituong.Focus();
			else if (mabd.Enabled) mabd.Focus();
			else tenbd.Focus();
		}

		private void butXoa_Click(object sender, System.EventArgs e)
		{
			if (!upd_table(dsxoa.Tables[0],"+")) return;
			d.delrec(dtct,"stt="+int.Parse(stt.Text));
			dtct.AcceptChanges();
			if (dtct.Rows.Count==0) emp_detail();
			else ref_text();
		}

        private decimal get_stct()
        {
            decimal _c1 = (c1.Text != "") ? decimal.Parse(c1.Text) : 0;
            decimal _c2 = (c2.Text != "") ? decimal.Parse(c2.Text) : 0;
            decimal _c3 = (c3.Text != "") ? decimal.Parse(c3.Text) : 0;
            decimal _c4 = (c4.Text != "") ? decimal.Parse(c4.Text) : 0;
            return _c1 + _c2 + _c3 + _c4;
        }

		private bool upd_table(DataTable dt,string tt)
		{
			if (!KiemtraDetail(tt)) return false;
            if (madoituong.SelectedValue.ToString() == "1" && !bLocdichvu)
            {
                if (d.getrowbyid(dtdmbd, "id=" + i_mabd + " and bhyt>0")==null)
                {
                    madoituong.SelectedValue = i_tunguyen;
                    madoituong.Update();
                }
            }
            if (bDonthuoc_stc) d_soluong = (soluong1.Text != "") ? decimal.Parse(soluong1.Text) : 0;
			else d_soluong=(soluong.Text!="")?decimal.Parse(soluong.Text):0;
            string s = cachdung.Text;
            if (bDonthuoc_stc)
            {
                if (get_stct() != 0)
                {
                    s = ((c1.Text != "") ? c1.Text : "0") + "^";
                    s += ((c2.Text != "") ? c2.Text : "0") + "^";
                    s += ((c3.Text != "") ? c3.Text : "0") + "^";
                    s += ((c4.Text != "") ? c4.Text : "0");
                }
            }
            if (s.Trim()!="" && lbldungluc.Text.Trim() != "" && s.IndexOf(lbldungluc.Text.Trim()) < 0) s = s.Trim() + " " + lbldungluc.Text;
            d.updrec_dutruct(tt, dt, int.Parse(stt.Text), madoituong.Text, i_mabd, mabd.Text, tenbd.Text, tenhc.Text, dang.Text, makho.Text, d_soluong, int.Parse(madoituong.SelectedValue.ToString()), int.Parse(makho.SelectedValue.ToString()), s, mahc.Text, int.Parse(manguon.SelectedValue.ToString()), 0, 0, (bDonthuoc_stc) ? ((chk1.Checked) ? 1 : 0) : (bTayy) ? solan.Value : songay.Value, (moilan.Text != "") ? decimal.Parse(moilan.Text) : 1, dtton, i_mabdcu, (txtdongia.Text.Trim() == "") ? 0 : decimal.Parse(txtdongia.Text), (txtgiaban.Text.Trim() == "") ? 0 : decimal.Parse(txtgiaban.Text));//(bTayy)?d_soluong/Math.Max(1,songay.Value):
			return true;
		}

		private void dataGrid1_CurrentCellChanged(object sender, System.EventArgs e)
		{
            i_col = dataGrid1.CurrentCell.ColumnNumber;
            if (butLuu.Enabled && (i_col==7 || i_col==8))
            {
                try
                {                    
                    DataRow r = m.getrowbyid(dtct, "stt=" + int.Parse(stt.Text));
                    d_soluongcu = (r != null) ? decimal.Parse(r["soluong"].ToString()) : 0;
                    stt.Text = dataGrid1[i_row, 0].ToString();
                    if (i_col == 7)
                    {
                        moilan.Text = dataGrid1[i_row, i_col].ToString();
                        solan_Validated(sender, e);
                    }
                    else
                    {
                        soluong.Text = dataGrid1[i_row, i_col].ToString();
                        soluong_Validated(sender, e);
                    }
                }
                catch { }
            }
            i_row = dataGrid1.CurrentRowIndex;
			ref_text();
		}

		private void soluong_Validated(object sender, System.EventArgs e)
		{
			try
			{
				if (!bEdit) return;
				d_soluong=(soluong.Text!="")?decimal.Parse(soluong.Text):0;
				if (d_soluong!=0) soluong.Text=d_soluong.ToString(f_soluong);
                if (mabd.Text != "" && tenbd.Text != "" && bMuangoai_tonkho)
				{
					r=d.getrowbyid(dtton,"ma='"+mabd.Text+"'");
					if (r!=null && r["manguon"].ToString()!="-1")
					{
						i_mabd=int.Parse(r["id"].ToString());
                        if (i_mabdcu != 0 && i_mabdcu != i_mabd)
                        {                            
                            d.updrec_tonkho_tutruc_nguon(dtton, i_makhocu, i_manguoncu, i_mabdcu,0, d_soluongcu, "+");
                            d_soluongcu = 0;
                        }
						d_soluongton=d.get_slton_nguon_tutruc(dtton,int.Parse(makho.SelectedValue.ToString()),i_mabd,int.Parse(manguon.SelectedValue.ToString()),0,d_soluongcu);
						if (d_soluong>d_soluongton)
						{
							MessageBox.Show(lan.Change_language_MessageText("Số lượng xuất lớn hơn số lượng tồn !(")+d_soluongton.ToString()+")",s_msg);
							soluong.Focus();
							return;
						}
					}
				}
				if (d_soluongcu!=0) upd_table(dtct,"-");
			}
			catch{}
		}
		private void butHuy_Click(object sender, System.EventArgs e)
		{
			try
			{
				if (dtll.Rows.Count==0) return;
				l_id=long.Parse(cmbMabn.SelectedValue.ToString());
                if (bKhoaso)
                {
                    MessageBox.Show(lan.Change_language_MessageText("Số liệu tháng")+" " + s_mmyy.Substring(0, 2) + " "+lan.Change_language_MessageText("năm")+" " + s_mmyy.Substring(2, 2) + " "+lan.Change_language_MessageText("đã khóa !")+"\n"+lan.Change_language_MessageText("Nếu cần thay đổi thì vào mục khai báo hệ thống"), d.Msg);
                    return;
                }
                if (bInchitiet && i_loai!=7)
                {
                    string tenkp = m.inchiphipk(s_ngay, l_mavaovien);
                    if (tenkp != "")
                    {
                        MessageBox.Show(lan.Change_language_MessageText("Đã in chi phí tại") + " " + tenkp + " !", s_msg);
                        return;
                    }
                }
                else
                {
                    bDone = d.get_done_thuocbhyt(s_ngay, l_id);
                    if (bDone)
                    {
                        MessageBox.Show(lan.Change_language_MessageText("Đã cập nhật !"), s_msg);
                        return;
                    }
                }
                if (i_loaiba == 2)
                {
                    if (m.get_data("select * from " + user + ".benhanngtr where maql=" + l_maql + " and ngayrv is not null").Tables[0].Rows.Count > 0)
                    {
                        MessageBox.Show(lan.Change_language_MessageText("Người bệnh")+" " + s_Hoten + " "+lan.Change_language_MessageText("đã kết thúc điều trị !"), LibMedi.AccessData.Msg);
                        return;
                    }
                }
                if (bXemlai && s_ngay != m.ngayhienhanh_server && m.bAdminHethong(i_userid) == false)
                {
                    MessageBox.Show(lan.Change_language_MessageText("Bạn chỉ được phép xem lại toa này chứ không được phép hủy."));
                    return;
                }
				if (MessageBox.Show(lan.Change_language_MessageText("Đồng ý hủy số phiếu này ?"),s_msg,MessageBoxButtons.YesNo,MessageBoxIcon.Question)==DialogResult.Yes)
				{
                    if (bDuyet)
                    {
                        itable = d.tableid(s_mmyy, "bhytthuoc");
                        foreach (DataRow r1 in d.get_data("select a.*,t.manguon,t.nhomcc,t.handung,t.losx,a.soluong*t.giamua as sotien from "+zzz+".bhytthuoc a,"+zzz+".d_theodoi t where a.sttt=t.id and a.id="+l_id).Tables[0].Rows)
                        {
                            d.upd_eve_tables(s_mmyy, itable, i_userid, "del");
                            d.upd_eve_upd_del(s_mmyy, itable, i_userid, "del", d.fields(zzz + ".bhytthuoc", "id=" + l_id + " and stt=" + int.Parse(r1["stt"].ToString())));
                            d.upd_tonkhoct_xuat(d.delete, s_mmyy, long.Parse(r1["sttt"].ToString()), int.Parse(r1["makho"].ToString()), int.Parse(r1["manguon"].ToString()), int.Parse(r1["nhomcc"].ToString()), int.Parse(r1["mabd"].ToString()), r1["handung"].ToString(), r1["losx"].ToString(), decimal.Parse(r1["soluong"].ToString()), decimal.Parse(r1["sotien"].ToString()), 0, 0);
                        }
                        itable = d.tableid(s_mmyy, "bhytkb");
                        d.upd_eve_tables(s_mmyy, itable, i_userid, "del");
                        d.upd_eve_upd_del(s_mmyy, itable, i_userid, "del", d.fields(zzz + ".bhytkb", "id=" + l_id));
                        d.execute_data("delete from " + zzz + ".d_chandoan where loai=1 and id=" + l_id);
                        d.execute_data("delete from " + zzz+ ".bhytthuoc where id=" + l_id);
                        d.execute_data("delete from " + zzz + ".bhytkb where sobienlai=0 and id=" + l_id);
                    }

                    itable = m.tableid(m.mmyy(s_ngay), "d_thuocbhytll");
                    m.upd_eve_tables(s_ngay, itable, i_userid, "del");
                    m.upd_eve_upd_del(s_ngay, itable, i_userid, "del", m.fields(xxx + ".d_thuocbhytll", "id=" + l_id));
                    itable = m.tableid(m.mmyy(s_ngay), "d_thuocbhytct");
                    foreach (DataRow r1 in dtct.Rows)
                    {
                        m.upd_eve_tables(s_ngay, itable, i_userid, "del");
                        m.upd_eve_upd_del(s_ngay, itable, i_userid, "del", m.fields(xxx + ".d_thuocbhytct", "id=" + l_id + " and stt=" + long.Parse(r1["stt"].ToString())));
                        d.upd_tonkhoth_dutru(d.delete, i_nhom, s_mmyy, int.Parse(r1["makho"].ToString()), int.Parse(r1["manguon"].ToString()), int.Parse(r1["mabd"].ToString()), decimal.Parse(r1["soluong"].ToString()));
                    }
                    d.execute_data("delete from " + xxx + ".d_thuocbhytct where id=" + l_id);
                    d.execute_data("delete from " + xxx + ".d_thuocbhytll where id=" + l_id);
					d.delrec(dtll,"id="+l_id);
					dtll.AcceptChanges();
					cmbMabn.Refresh();
					if (cmbMabn.Items.Count>0) l_id=long.Parse(cmbMabn.SelectedValue.ToString());
					else l_id=0;
					load_head();
				}
			}
			catch{}
		}

		private void load_treeview()
		{
			if (l_maql==0 || nam=="") return;
			sql="select to_char(a.ngay,'yyyymmdd')||a.makp as ngay,e.tenkp,a.id,b.mabd,b.makho,sum(b.slyeucau) as soluong ";
			sql+=" from xxx.d_thuocbhytll a inner join xxx.d_thuocbhytct b on a.id=b.id left join "+user+".btdkp_bv e on a.makp=e.makp";
			sql+=" where a.mabn='"+((bChonkhoa)?mabn.Text:s_mabn)+"'";
			if (i_sudungthuoc==2) sql+=" and a.maql="+l_maql;
			sql+=" group by to_char(a.ngay,'yyyymmdd')||a.makp,e.tenkp,a.id,b.mabd,b.makho";
			treeView1.Nodes.Clear();
			TreeNode node;
			dtngay=(bChonkhoa)?m.get_data_mmyy(sql,s_ngayvv,s_ngay,false).Tables[0]:m.get_data_nam(nam,sql).Tables[0];
			string ngay="";
			DataRow [] dr;
			foreach(DataRow r1 in dtngay.Select("true","ngay desc"))
			{
				if (ngay!=r1["ngay"].ToString()+"["+r1["tenkp"].ToString().Trim()+"]")
				{
					ngay=r1["ngay"].ToString()+"["+r1["tenkp"].ToString().Trim()+"]";
					node=treeView1.Nodes.Add(ngay.Substring(6,2)+"/"+ngay.Substring(4,2)+"/"+ngay.Substring(0,4)+ngay.Substring(10));
					dr=dtngay.Select("ngay='"+ngay.Substring(0,10)+"'");
					for(int i=0;i<dr.Length;i++)
					{
						r=d.getrowbyid(dtdmbd,"id="+int.Parse(dr[i]["mabd"].ToString()));
						if (r!=null) node.Nodes.Add(r["ten"].ToString().Trim()+" "+r["hamluong"].ToString().Trim()+"/"+r["tenhc"].ToString().Trim()+" "+r["dang"].ToString().Trim()+" ("+dr[i]["soluong"].ToString().Trim()+")");
					}
				}
			}
		}

		private void butCholai_Click(object sender, System.EventArgs e)
		{
			if (mabn.Text.Trim().Length!=8)
			{
				mabn.Focus();
				return;
			}
            if (nam == "") return;
			long idcholai=d.get_cholai_bhyt(nam,mabn.Text,s_makho);
			if (idcholai==0) return;
            get_cholai(idcholai);
		}

        private void get_cholai(long idcholai)
        {
            dtct.Clear(); 
            sql = "select a.songay,b.madoituong,b.makho,b.mabd,b.slyeucau as soluong,b.cachdung, ";
            sql += " c.doituong,e.ten as tenkho,f.ma,f.ten,f.tenhc,f.dang,f.mahc,b.manguon,0 as tutruc,b.solan,b.lan ";
            sql += " from xxx.d_thuocbhytll a,xxx.d_thuocbhytct b," + user + ".d_dmkho e," + user + ".d_dmbd f,"+user+".doituong c ";
            sql += " where a.id=b.id and b.makho=e.id and b.mabd=f.id and b.madoituong=c.madoituong and a.id=" + idcholai;
            sql += " order by b.stt";
            string s = ""; i_mabdcu=i_mabd = 0;
            decimal sl;
            foreach (DataRow r in d.get_data_nam(nam, sql).Tables[0].Rows)
            {
                songay.Value = decimal.Parse(r["songay"].ToString());
                i_mabd = int.Parse(r["mabd"].ToString());
                sl=d_soluong = decimal.Parse(r["soluong"].ToString());
                if (chkChitiet.Checked && songay.Value > 1) d_soluong *= Math.Max(1, songay.Value);
                d_soluongton = d.get_slton_nguon_tutruc(dtton, int.Parse(r["makho"].ToString()), i_mabd, int.Parse(r["manguon"].ToString()), int.Parse(r["tutruc"].ToString()), 0);
                if (d_soluong > d_soluongton)
                {
                    s += r["ten"].ToString() + " " + r["dang"].ToString() + " (" + d_soluongton.ToString("###,###,###0.00") + ")\n";
                    if (chkChitiet.Checked && songay.Value > 1) sl = 0;
                    else sl = (d_soluong > d_soluongton) ? d_soluongton : d_soluong;
                }
                if (sl>0) d.updrec_dutruct("-", dtct, d.get_stt(dtct), r["doituong"].ToString(), i_mabd, r["ma"].ToString(), r["ten"].ToString(), r["tenhc"].ToString(), r["dang"].ToString(), r["tenkho"].ToString(),sl, int.Parse(r["madoituong"].ToString()), int.Parse(r["makho"].ToString()), r["cachdung"].ToString(), r["mahc"].ToString(), int.Parse(r["manguon"].ToString()), int.Parse(r["tutruc"].ToString()), 0, decimal.Parse(r["solan"].ToString()), decimal.Parse(r["lan"].ToString()), dtton,i_mabdcu);
            }
            if (i_mabd != 0 && s != "")
                MessageBox.Show(lan.Change_language_MessageText("Những mặt hàng sau không đủ trong tồn \n") + s, s_msg);
            ref_text();
        }

		private void frmBaohiem_KeyDown(object sender, System.Windows.Forms.KeyEventArgs e)
		{
			if (e.KeyCode==Keys.F8) diung_Click(sender,e);	
			else if (e.KeyCode==Keys.F5) butCholai_Click(sender,e);
			else if (e.KeyCode==Keys.F9) butIn_Click(sender,e);
            else if (e.KeyCode == Keys.F3) butMoi_Click(sender, e);
            else if (e.KeyCode == Keys.F6) butDongy_Click(sender, e);
		}

		private void diung_Click(object sender, System.EventArgs e)
		{
			if (cmbMabn.Items.Count==0) return;
			frmDiungthuoc f=new frmDiungthuoc(m,cmbMabn.Text,hoten.Text,"","");
			f.ShowDialog(this);
			load_diungthuoc(cmbMabn.Text);
		}

		private void load_diungthuoc(string mabn)
		{
			DataTable dt=m.get_data("select * from "+user+".diungthuoc where mabn='"+mabn+"'").Tables[0];
			string s="";
			foreach(DataRow r in dt.Rows) s+=r["mahc"].ToString().Trim()+"+";
			diung.ForeColor=(dt.Rows.Count!=0)?Color.FromArgb(255,0,0):Color.FromArgb(0,0,255);
			diung.Tag=s;
            
		}

		private void get_items(int stt)
		{
			try
			{
				r=d.getrowbyid(dtton,"stt="+stt);
				if (r!=null)
				{
					mabd.Text=r["ma"].ToString();
					tenbd.Text=r["ten"].ToString();
					tenhc.Text=r["tenhc"].ToString();
                    dang.Text = r["dang"].ToString();
                    dang.Tag = r["donvidung"].ToString();
					makho.SelectedValue=r["makho"].ToString();
					mahc.Text=r["mahc"].ToString().Trim();
					manguon.SelectedValue=r["manguon"].ToString();
                    txtdongia.Text = r["dongia"].ToString().Trim();
                    txtgiaban.Text = r["giaban"].ToString().Trim();
                    if (!bTayy) solan.Value = Math.Max(1, songay.Value);
                    if (bDonthuoc_stc)
                    {
                        DataRow r1 = d.getrowbyid(dtdmbd, "ma='" + mabd.Text + "'");
                        if (r1 != null)
                            lblduongdung.Text = r1["duongdung"].ToString().Trim();
                    }
                    else lbldvt.Text = (dang.Tag.ToString() != "") ? dang.Tag.ToString() : r["dang"].ToString();//.Text;
					#region diung
					if (bDiungthuoc)
					{
						bool bFound=false;
						if (diung.Tag.ToString()!="" && mahc.Text!="")
						{
							int i=0;
							while (i<diung.Tag.ToString().Length)
							{
								if (mahc.Text.IndexOf(diung.Tag.ToString().Substring(i,7))!=-1)
								{
									bFound=true;
									break;
								}
								i+=7;
							}
						}
						if (bFound)
						{
							if (MessageBox.Show(lan.Change_language_MessageText("Người bệnh dị ứng thuốc")+" \n"+tenhc.Text.Trim()+"\n"+lan.Change_language_MessageText("Bạn có đồng ý thêm vào không !"),LibMedi.AccessData.Msg,MessageBoxButtons.YesNo,MessageBoxIcon.Question,MessageBoxDefaultButton.Button2)==DialogResult.Yes) soluong.Focus();
							else
							{
								mabd.Text="";tenbd.Text="";tenhc.Text="";dang.Text="";mahc.Text="";
								mabd.Focus();
							}
						}
					}
					#endregion
					listDmbd.Hide();
                    if (bDonthuoc_stc) c1.Focus();
                    else if (solan.Enabled) solan.Focus();
                    else soluong.Focus();
				}
			}
			catch{}		
		}

		private void listDmbd_DoubleClick(object sender, System.EventArgs e)
		{
			try
			{
				get_items(int.Parse(listDmbd.Text));
			}
			catch{}
		}

		private void mabd_KeyDown(object sender, System.Windows.Forms.KeyEventArgs e)
		{
			if(e.KeyCode==Keys.Down || e.KeyCode==Keys.Up) listDmbd.Focus();
			else if (e.KeyCode==Keys.Enter)
			{
				sql="ma like '"+mabd.Text.Trim()+"%'";
				DataRow [] dr=dtton.Select(sql);
				if (dr.Length==1)
				{
					mabd.Text=dr[0]["stt"].ToString();
					get_items(int.Parse(mabd.Text));
					if(!listDmbd.Focused) listDmbd.Hide();
                    if (solan.Enabled) solan.Focus();
                    else if (moilan.Enabled) moilan.Focus();
                    else soluong.Focus();
				}
				else
				{
					if (listDmbd.Visible) 
					{
						listDmbd.Focus();
						SendKeys.Send("{Up}");
					}
					else SendKeys.Send("{Tab}");
				}
			}
		}

		private void butIn_Click(object sender, System.EventArgs e)
		{
            if (bAdminInlaidonthuoc)
            {
                if (!bAdmin && s_ngay.Substring(0, 10) != m.ngayhienhanh_server.Substring(0, 10))
                {
                    MessageBox.Show(lan.Change_language_MessageText("Bạn không có quyền in lại đơn của ngày trước !"), LibMedi.AccessData.Msg);
                    return;
                }
            }
			string lydo="",stuoi="",smaicd=maicd.Text,schandoan=chandoan.Text.Trim()+";",ngayhen = "", ghichuhen = "",tungay="",denngay="",noidkkcb="";
            if ((i_loaiba == 2 && bDieutringtr == false) || i_loaiba == 1) lydo = m.get_lydokham(l_maql).Trim();
            else lydo = m.get_lydokham(s_ngayvao, l_maql).Trim();
            int lanin = 0, isophieu = 0, i_max_lanin = m.iSolanin_toathuoc; ;
            if (bDuyet)
            {
                lanin = d.get_laninkb(s_mmyy, mabn.Text, l_maql, s_ngay.Substring(0,10), i_madoituong);
                isophieu = d.get_sophieu_bhyt_userid(s_mmyy,mabn.Text,l_mavaovien,s_ngay.Substring(0,10),i_madoituong,-1,ngay_reset_phieu38 );
            }
            if (sothe.Text != "")
            {
                sql = "select to_char(a.tungay,'dd/mm/yyyy') as tungay,to_char(a.denngay,'dd/mm/yyyy') as denngay,b.tenbv ";
                sql+=" from " + xxx + ".bhyt a left join "+user+".dmnoicapbhyt b on a.mabv=b.mabv where a.maql=" + l_maql;
                foreach (DataRow r in m.get_data(sql).Tables[0].Rows)
                {
                    tungay = r["tungay"].ToString();
                    denngay = r["denngay"].ToString();
                    noidkkcb = r["tenbv"].ToString();
                    break;
                }
            }
            foreach (DataRow r in m.get_data("select chandoan, maicd from " + xxx + ".cdkemtheo where maql=" + l_maql + " order by stt").Tables[0].Rows)
            {
                smaicd += r["maicd"].ToString() + ";";
                schandoan += r["chandoan"].ToString() + ";";
            }
            foreach (DataRow r in m.get_data("select * from " + user + d.mmyy(s_ngay) + ".hen where maql=" + l_maql).Tables[0].Rows)
            {
                DateTime dt = m.StringToDate(s_ngay);
                switch (int.Parse(r["loai"].ToString()))
                {
                    case 1: ngayhen = m.DateToString("dd/MM/yyyy", dt.AddDays(int.Parse(r["songay"].ToString())));
                        break;
                    case 2: ngayhen = m.DateToString("dd/MM/yyyy", dt.AddDays(7 * int.Parse(r["songay"].ToString())));
                        break;
                    case 3: ngayhen = m.DateToString("dd/MM/yyyy", dt.AddMonths(int.Parse(r["songay"].ToString())));
                        break;
                    default: ngayhen = m.DateToString("dd/MM/yyyy", dt.AddYears(int.Parse(r["songay"].ToString())));
                        break;
                }
                ghichuhen = r["ghichu"].ToString();
            }
            stuoi = m.f_get_tuoivao(namsinh.Tag.ToString(),namsinh.Text,s_ngay);
            if (stuoi == "")
            {
                stuoi = m.f_get_tuoivao( s_ngay,s_ngay, l_maql);
            }
            if (namsinh.Text != "" && stuoi == "") 
			{
				int tuoi=DateTime.Now.Year-int.Parse(namsinh.Text);
				stuoi=tuoi.ToString();
			}
            
            string gioitinh = "",tennn="";
            foreach (DataRow r in m.get_data("select a.phai,b.tennn from " + user + ".btdbn a," + user + ".btdnn_bv b where a.mann=b.mann and a.mabn='" + mabn.Text + "'").Tables[0].Rows)
            {
                gioitinh = (r["phai"].ToString() == "0") ? "Nam" : "Nữ";
                tennn = r["tennn"].ToString();
            }
            stuoi = stuoi + "^" + gioitinh;
            try
            {
                stuoi += "^" + namsinh.Tag.ToString();
            }
            catch { stuoi += "^" + namsinh.Text; }
			DataTable tmp=dtct.Copy();
            if (chkVP.Checked || i_bhyt_inrieng != 0)
            {
                DataSet dstmp, dstmp1;
                if (bDuyet)
                {
                    sql = "select 1 as loai,a.stt,' ' as doituong,b.ma,trim(b.ten)||' '||b.hamluong as ten,nullif(b.tenhc,' ') as tenhc,b.dang,f.ten as tenkho,a.soluong,1 as madoituong,a.makho,nullif(a.cachdung,' ') as cachdung,b.mahc,' ' as diung,t.giamua as manguon,0 as tutruc,0 as idvpkhoa ";
                    if (i_bhyt_inrieng == 0) sql += ",0 as mabd";
                    else sql += ",case when c.nhomvp=" + i_bhyt_inrieng + " then 1 else 0 end as mabd";
                    if (bGiaban_theodot) sql += ",t.giaban";
                    else sql += ",b.giaban";
                    sql += ",0 as solan,g.stt as sttin,g.ten as nhomin,'' as tu,'' as den";
                    sql += ", a.id ";
                    sql += ","+i_loaiba+" as loaiba ";
                    sql += ", h.ten as hangsx, i.ten as nuocsx, trim(b.ten) as tenthuoc, trim(b.hamluong) as hamluong, 0 as lanin ";
                    sql += " from " + user + s_mmyy + ".bhytthuoc a," + user + ".d_dmbd b," + user + ".d_dmnhom c," + user + ".d_dmkho f," + user + s_mmyy + ".d_theodoi t ";
                    sql += "," + user + ".d_nhomin g, " + user + ".d_dmhang h, " + user + ".d_dmnuoc i ";
                    sql += " where a.sttt=t.id and a.mabd=b.id and b.manhom=c.id and a.makho=f.id and c.nhomin=g.id and b.mahang=h.id(+) and b.manuoc=i.id(+) and a.id=" + l_id;
                }
                else
                {
                    sql = "select 1 as loai,a.stt,' ' as doituong,b.ma,trim(b.ten)||' '||b.hamluong as ten,nullif(b.tenhc,' ') as tenhc,b.dang,f.ten as tenkho,a.slyeucau as soluong,1 as madoituong,a.makho,nullif(a.cachdung,' ') as cachdung,b.mahc,' ' as diung,a.manguon,0 as tutruc,0 as idvpkhoa ";
                    if (i_bhyt_inrieng == 0) sql += ",0 as mabd";
                    else sql += ",case when c.nhomvp=" + i_bhyt_inrieng + " then 1 else 0 end as mabd";
                    sql += ",b.giaban";
                    sql += ",a.solan,g.stt as sttin,g.ten as nhomin,";
                    sql += "to_char(h.ngay,'dd/mm/yyyy') as tu,to_char(h.ngay+case when h.songay=0 then 1 else "+songay.Value+" end-1,'dd/mm/yyyy') as den";
                    sql += ", a.id ";
                    sql += ",h.loaiba ";
                    sql += ", i.ten as hangsx, j.ten as nuocsx ,trim(b.ten) as tenthuoc, trim(b.hamluong) as hamluong, h.lanin ";
                    sql += " from " + xxx + ".d_thuocbhytct a," + user + ".d_dmbd b," + user + ".d_dmnhom c," + user + ".d_dmkho f ";
                    sql += "," + user + ".d_nhomin g," + xxx + ".d_thuocbhytll h, " + user + ".d_dmhang i, " + user + ".d_dmnuoc j ";
                    sql += " where a.id=h.id and a.mabd=b.id and b.manhom=c.id and a.makho=f.id and c.nhomin=g.id and b.mahang=i.id(+) and b.manuoc=j.id(+) and a.id=" + l_id;
                }
                if (chkVP.Checked)
                {
                    int stt = dtct.Rows.Count;
                    sql += " union all ";
                    sql += " select 2 as loai,to_number(a.oid,'999999999999')+" + stt + " as stt,' ' as doituong,b.ma,trim(b.ten) as ten,' ' as tenhc,b.dvt as dang,' ' as tenkho,a.soluong,a.madoituong,0 as makho,' ' as cachdung,' ' as mahc,' ' as diung,";
                    if (chkDongia.Checked) sql += "a.dongia+a.vattu as manguon,";
                    else sql += "0 as manguon,";
                    sql += "0 as tutruc,0 as idvpkhoa ";
                    if (i_bhyt_inrieng == 0) sql += ",0 as mabd";
                    else sql += ",case when d.ma=" + i_bhyt_inrieng + " then 1 else 0 end as mabd";
                    sql += ",a.dongia as giaban";
                    sql += ",0 as solan,0 as sttin,'' as nhomin,'' as tu,'' as den";
                    sql += ", a.id ";
                    sql += ", a.loaiba, null as hangsx, null as nuocsx,trim(b.ten) as tenthuoc, ' ' as hamluong, 0 as lanin ";
                    sql += " from " + xxx + ".v_chidinh a," + user + ".v_giavp b," + user + ".v_loaivp c," + user + ".v_nhomvp d ";
                    sql += " where a.mavp=b.id and b.id_loai=c.id and c.id_nhom=d.ma and a.maql=" + l_maql;
                }
                dstmp = d.get_data(sql);
                dstmp1 = dstmp.Copy();
                dstmp.Clear();
                dstmp.Merge(dstmp1.Tables[0].Select("true", "loai,stt"));
                tmp = dstmp.Tables[0];
            }
            else
            {
                sql = "select a.stt,c.doituong,0 as mabd,b.ma,trim(b.ten)||' '||b.hamluong as ten,nullif(b.tenhc,' ') as tenhc,b.dang,f.ten as tenkho,";
                sql += " a.slyeucau as soluong,a.madoituong,a.makho,nullif(a.cachdung,' ') as cachdung,b.mahc,' ' as diung,a.manguon,";
                sql += " 0 as tutruc,0 as idvpkhoa,a.solan,a.lan,b.dongia,a.slyeucau*b.dongia as sotien,b.giaban,";
                sql += " a.slyeucau*b.giaban as sotienban,g.stt as sttin,g.ten as nhomin,";
                sql += " to_char(h.ngay,'dd/mm/yyyy') as tu,to_char(h.ngay+case when h.songay=0 then 1 else "+songay.Value+" end-1,'dd/mm/yyyy') as den";
                sql += ", a.id, h.loaiba ";
                sql += ", i.ten as hangsx, j.ten as nuocsx,trim(b.ten) as tenthuoc, trim(b.hamluong) as hamluong, h.lanin ";
                sql += " from " + xxx + ".d_thuocbhytct a inner join " + user + ".d_dmbd b on a.mabd=b.id ";
                sql += " left join " + user + ".d_dmkho f on a.makho=f.id ";
                sql += " inner join " + user + ".doituong c on a.madoituong=c.madoituong ";
                sql += " left join " + user + ".d_dmnhom d on b.manhom=d.id ";
                sql += " left join " + user + ".d_nhomin g on d.nhomin=g.id ";
                sql += " inner join " + xxx + ".d_thuocbhytll h on a.id=h.id ";
                sql += " left join " + user + ".d_dmhang i on b.mahang=i.id ";
                sql += " left join " + user + ".d_dmnuoc j on b.manuoc=j.id ";
                sql += " where a.id=" + l_id + " order by a.stt";
                tmp = m.get_data(sql).Tables[0];
            }
            tmp.Columns.Add("Image", typeof(byte[]));
            tmp.Columns.Add("ngayhen", typeof(String));
            tmp.Columns.Add("ghichuhen", typeof(String));
            tmp.Columns.Add("tungay", typeof(String));
            tmp.Columns.Add("denngay", typeof(String));
            tmp.Columns.Add("noidkkcb", typeof(String));
            tmp.Columns.Add("tenuser", typeof(String));
            //tmp.Columns.Add("lanin", typeof(decimal));
            tmp.Columns.Add("sophieu", typeof(decimal));
            tmp.Columns.Add("nguoinha", typeof(String));
            tmp.Columns.Add("giuong", typeof(String));
            tmp.Columns.Add("maicd", typeof(String));
            tmp.Columns.Add("mach", typeof(decimal));
            tmp.Columns.Add("nhietdo", typeof(decimal));
            tmp.Columns.Add("huyetap", typeof(string));
            tmp.Columns.Add("cannang", typeof(decimal));
            tmp.Columns.Add("chieucao", typeof(decimal));
            tmp.Columns.Add("tennn", typeof(String));            
            if (File.Exists("..//..//..//chuky//" + mabs.Text + ".bmp"))
            {
                fstr = new FileStream("..//..//..//chuky//" + mabs.Text + ".bmp", FileMode.Open, FileAccess.Read);
                image = new byte[fstr.Length];
                fstr.Read(image, 0, System.Convert.ToInt32(fstr.Length));
                fstr.Close();
                foreach (DataRow r1 in tmp.Rows) r1["Image"] = image;
            }
            string nguoinha = "",zzz=user;
            if (i_loaiba == 3 || i_loaiba == 4) zzz = user + m.mmyy(s_ngay);
            foreach (DataRow r in m.get_data("select * from " + zzz + ".quanhe where maql=" + l_maql).Tables[0].Rows)
            {
                nguoinha = r["quanhe"].ToString().Trim()+" "+ r["hoten"].ToString();
                break;
            }
            decimal mach=0, nhietdo=0, cannang=0, chieucao=0;
            string huyetap = "";
            bool bFound = false;
            foreach (DataRow r in m.get_data("select * from " + zzz + ".dausinhton where maql=" + l_maql).Tables[0].Rows)
            {
                mach = decimal.Parse(r["mach"].ToString());
                nhietdo=decimal.Parse(r["nhietdo"].ToString());
                cannang=decimal.Parse(r["cannang"].ToString());
                chieucao = decimal.Parse(r["chieucao"].ToString());
                huyetap = r["huyetap"].ToString();
                bFound = true;
                break;
            }
            if (!bFound)
            {
                foreach (DataRow r in m.get_data("select * from " + user + ".dausinhton where maql=" + l_maql).Tables[0].Rows)
                {
                    mach = decimal.Parse(r["mach"].ToString());
                    nhietdo = decimal.Parse(r["nhietdo"].ToString());
                    cannang = decimal.Parse(r["cannang"].ToString());
                    chieucao = decimal.Parse(r["chieucao"].ToString());
                    huyetap = r["huyetap"].ToString();
                    bFound = true;
                    break;
                }
            }
            string _giuong = "";
            if (bChonkhoa)
            {
                DataRow r2 = m.getrowbyid(dthoten, "mabn='" + mabn.Text + "'");
                if (r2 != null) _giuong = r2["giuong"].ToString();
            }
            if (bDuyet == false && tmp.Rows.Count > 0) lanin = int.Parse(tmp.Rows[0]["lanin"].ToString())+1;
            if (m.bAdminHethong(i_userid) == false && i_max_lanin > 0 && lanin > i_max_lanin)
            {
                MessageBox.Show(lan.Change_language_MessageText("Số lần in vượt quá số lần in đã qui định."));
                return;
            }
            else
            {
                m.execute_data("update " + user + s_mmyy + ".d_thuocbhytll set lanin=" + lanin + " where id=" + l_id);
            }
            foreach (DataRow r1 in tmp.Rows)
            {
                r1["ngayhen"] = ngayhen;
                r1["ghichuhen"] = ghichuhen;
                r1["tungay"] = tungay;
                r1["denngay"] = denngay;
                r1["noidkkcb"] = noidkkcb;
                r1["tenuser"] = s_user;
                r1["lanin"] = lanin;
                r1["sophieu"] = isophieu;
                r1["nguoinha"] = nguoinha;
                r1["giuong"] = _giuong;
                r1["maicd"] = smaicd;
                r1["mach"] = mach;
                r1["nhietdo"] = nhietdo;
                r1["cannang"] = cannang;
                r1["chieucao"] = chieucao;
                r1["huyetap"] = huyetap;
                r1["tennn"] = tennn;
            }
            
            string tenfile=(System.IO.File.Exists("..//..//..//report//d_donthuocb.rpt"))?"d_donthuocb.rpt":"d_donthuoc.rpt";
            if (!bTayy) tenfile = (System.IO.File.Exists("..//..//..//report//d_donthuoc_thang.rpt")) ? "d_donthuoc_thang.rpt" : tenfile ;
            if (!bTayy)
            {
                //sap xep in toa thuoc theo hang ngang dua vao field stt_in
                int i = 1, i_stt = 0, j = 0, i_count = tmp.Rows.Count;
                tmp.Columns.Add("stt_in", typeof(decimal)).DefaultValue = 0;
                tmp.Columns.Add("ten1");
                tmp.Columns.Add("sl1", typeof(decimal)).DefaultValue = 0;
                tmp.Columns.Add("ten2");
                tmp.Columns.Add("sl2", typeof(decimal)).DefaultValue = 0;
                string sl="",ten="";
                foreach (DataRow r in tmp.Rows)
                {                    
                    //i = int.Parse(r["stt"].ToString());
                    if (i <= i_count / 2 + 1) i_stt = i + i - 1;
                    else { i_stt = i - (i_count / 2) + j; j++; }
                    r["stt_in"] = i_stt;
                    sl = (i_stt % 2 == 0) ? "sl2" : "sl1";
                    ten = (i_stt % 2 == 0) ? "ten2" : "ten1";
                    r[sl] = r["soluong"].ToString();
                    r[ten]=r["ten"].ToString();
                    i += 1;
                }
                DataRow r1;
                foreach (DataRow r in tmp.Select("ten1<>''"))
                {
                    i = int.Parse(r["stt_in"].ToString());
                    r1 = m.getrowbyid(tmp, "ten2<>'' and stt_in=" + (i + 1));
                    if (r1 != null)
                    {
                        r["ten2"] = r1["ten2"].ToString();
                        r["sl2"] = r1["sl2"].ToString();
                    }
                }
                foreach (DataRow r in tmp.Rows)
                    if (r["ten1"].ToString() == "") r.Delete();
                tmp.AcceptChanges();                
            }
            
            if (chkXML.Checked)
            {
                if (!System.IO.Directory.Exists("..//xml")) System.IO.Directory.CreateDirectory("..//xml");
                tmp.WriteXml("..//xml//bhyt.xml", XmlWriteMode.WriteSchema);
            }
			if (chkXem.Checked)
			{
                dllReportM.frmReport f = new dllReportM.frmReport(m, tmp, tenfile, hoten.Text, stuoi, sothe.Text, schandoan, s_diachi.Replace(",,", ",").Trim().Trim(',') + "^" + s_cholam.Trim(), tenbs.Text, dtct.Rows.Count.ToString() + "^" + songay.Value.ToString(), mabn.Text + "^" + s_ngay + "^" + s_ngay_kham, lydo.Replace("\r\n", " ") + "^" + ghichu.Text.Replace("\r\n", " "), s_doituong + "^" + s_Tenkp.Replace("\r\n", " ") + "^" + s_trieuchung.Replace("\r\n", " ") + "^" + lydo.Replace("\r\n", " ") + "^" + ghichu.Text.Replace("\r\n", " "), banin.Value);
				f.ShowDialog(this);
			}
            else print.Printer(m, tmp, tenfile, hoten.Text, stuoi, sothe.Text, schandoan, s_diachi.Replace(",,", ",").Trim().Trim(',') + "^" + s_cholam.Trim(), tenbs.Text, dtct.Rows.Count.ToString() + "^" + songay.Value.ToString(), mabn.Text + "^" + s_ngay + "^" + s_ngay_kham, lydo.Replace("\r\n", " ") + "^" + ghichu.Text.Replace("/r/n", " "), s_doituong + "^" + s_Tenkp + "^" + s_trieuchung.Replace("\r\n", " ") + "^" + lydo.Replace("\r\n", " ") + "^" + ghichu.Text.Replace("\r\n", " "), 1, Convert.ToInt16(banin.Value));
		}

		private void butHen_Click(object sender, System.EventArgs e)
		{
		}

		private void ghichu_KeyDown(object sender, System.Windows.Forms.KeyEventArgs e)
		{
			if (e.KeyCode==Keys.Enter) SendKeys.Send("{Tab}");		
		}

        private void solan_Validated(object sender, EventArgs e)
        {
            gc_cachdung();
        }

        private void gc_cachdung()
        {
            if (moilan.Text != "")
            {
                if (bTayy)// && dang.Text.Trim()==lbldvt.Text.Trim())
                {
                    r = d.getrowbyid(dtton, "ma='" + mabd.Text + "'");
                    if (r != null)
                    {
                        DataRow r1 = d.getrowbyid(dtdmbd, "id=" + int.Parse(r["id"].ToString()));
                        if (r1 != null)
                            cachdung.Text = r1["duongdung"].ToString().Trim() + " " + lan.Change_language_MessageText("ngày") + " " + solan.Value.ToString() + " " + lan.Change_language_MessageText("lần , lần") + " " + moilan.Text.ToString().Trim() + " " + ((r1["donvidung"].ToString() != "") ? r1["donvidung"].ToString().Trim() : r1["dang"].ToString());
                    }
                }
                decimal sl = Math.Max((!bTayy)?1:songay.Value,1) * solan.Value * decimal.Parse(moilan.Text);
                if (dang.Text.Trim() == lbldvt.Text.Trim() || dang.Text.Trim().ToLower() == lbldvt.Text.Trim().ToLower()) soluong.Text = sl.ToString(f_soluong);
                else soluong.Text = "";
                soluong.Refresh();
                soluong_Validated(null, null);
            }
        }

        private void chkChon_CheckedChanged(object sender, EventArgs e)
        {
            if (this.ActiveControl == chkChon && donthuoc.SelectedIndex != -1) get_don();
        }

        private void donthuoc_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (this.ActiveControl == donthuoc && donthuoc.SelectedIndex != -1)
            {
                dtct.Clear();
                get_don();
            }
        }

        private void get_don()
        {
            if (chkChon.Checked)
            {
                long id_donthuoc = long.Parse(donthuoc.SelectedValue.ToString());
                if (id_donthuoc != 0)
                {
                    songay.Value = decimal.Parse(dtdon.Rows[donthuoc.SelectedIndex]["songay"].ToString());
                    string s_ten = "";
                    long i_mabd = 0;
                    bool bFound = false;
                    decimal _soluong = 0;
                    sql = "select a.mabd,b.ma,trim(b.ten)||' '||b.hamluong as ten,b.hamluong,b.dang,b.mahc,b.tenhc,a.soluong,a.cachdung from "+user+".d_theodonct a,"+user+".d_dmbd b";
                    sql += " where a.mabd=b.id and a.id=" + id_donthuoc;
                    DataRow r1, r2;
                    foreach (DataRow r in d.get_data(sql).Tables[0].Rows)
                    {
                        bFound = false;
                        i_mabd = long.Parse(r["mabd"].ToString());
                        _soluong = decimal.Parse(r["soluong"].ToString());
                        sql = "soluong>=" + _soluong + " and id=" + i_mabd;
                        r1 = d.getrowbyid(dtton, sql);
                        if (r1 == null)
                        {
                            sql = "soluong>=" + _soluong + " and ten='" + r["ten"].ToString() + "' and dang='" + r["dang"].ToString() + "'";
                            r2 = d.getrowbyid(dtton, sql);
                            if (r2 != null)
                            {
                                bFound = true;
                                r["mabd"] = r2["id"].ToString();
                                r["ten"] = r2["ten"].ToString();
                                r["dang"] = r2["dang"].ToString();
                                r["ma"] = r2["ma"].ToString();
                                r["mahc"] = r2["mahc"].ToString();
                                r["tenhc"] = r2["tenhc"].ToString();
                                i_mabd = long.Parse(r2["id"].ToString());
                            }
                            else //tuong duong
                            {
                                foreach (DataRow r3 in d.get_data("select mabd,soluong from "+user+".d_dmbdtd where id=" + i_mabd).Tables[0].Rows)
                                {
                                    _soluong = decimal.Parse(r["soluong"].ToString()) * decimal.Parse(r3["soluong"].ToString());
                                    sql = "id=" + int.Parse(r3["mabd"].ToString()) + " and soluong>=" + d_soluong;
                                    r2 = d.getrowbyid(dtton, sql);
                                    if (r2 != null)
                                    {
                                        r["mabd"] = r2["id"].ToString();
                                        r["ten"] = r2["ten"].ToString();
                                        r["dang"] = r2["dang"].ToString();
                                        r["ma"] = r2["ma"].ToString();
                                        r["mahc"] = r2["mahc"].ToString();
                                        r["tenhc"] = r2["tenhc"].ToString();
                                        r["soluong"] = _soluong;
                                        i_mabd = long.Parse(r2["id"].ToString());
                                        bFound = true;
                                        break;
                                    }
                                }
                                //hoatchat - hamluong - dvt 
                                if (!bFound && r["tenhc"].ToString() != "")
                                {
                                    sql = "soluong>=" + _soluong + " and tenhc='" + r["tenhc"].ToString() + "' and dang='" + r["dang"].ToString() + "' and hamluong='" + r["hamluong"].ToString() + "'";
                                    r2 = d.getrowbyid(dtton, sql);
                                    if (r2 != null)
                                    {
                                        r["mabd"] = r2["id"].ToString();
                                        r["ten"] = r2["ten"].ToString();
                                        r["dang"] = r2["dang"].ToString();
                                        r["ma"] = r2["ma"].ToString();
                                        r["mahc"] = r2["mahc"].ToString();
                                        r["tenhc"] = r2["tenhc"].ToString();
                                        i_mabd = long.Parse(r2["id"].ToString());
                                    }
                                }
                            }
                        }
                        else bFound = true;
                        if (!bFound) s_ten += r["ten"].ToString().Trim() + "\n";
                        else d.updrec_dutruct("-", dtct, m.get_stt(dtct), "", int.Parse(r["mabd"].ToString()), r["ma"].ToString(), r["ten"].ToString(), r["tenhc"].ToString(), r["dang"].ToString(), (makho.SelectedIndex != -1) ? makho.Text : "", decimal.Parse(r["soluong"].ToString()), i_madoituong, int.Parse(r1["makho"].ToString()), r["cachdung"].ToString(), r["mahc"].ToString(), int.Parse(r1["manguon"].ToString()), 0, 0, solan.Value, (moilan.Text != "") ? decimal.Parse(moilan.Text) : 1, dtton,0);
                    }
                    if (s_ten.Length > 0) MessageBox.Show(lan.Change_language_MessageText("Những mặt hàng sau không đủ tồn")+"\n" + s_ten, LibMedi.AccessData.Msg);
                    ref_text();
                }
                else MessageBox.Show(lan.Change_language_MessageText("Không có trong danh mục !"), LibMedi.AccessData.Msg);
            }
            else dtct.Clear();
        }

        private void treeView1_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.F7 && butLuu.Enabled)
            {
                try
                {
                    int p = s_ngaymakp.LastIndexOf("]");
                    if (p > 0) s_ngaymakp = s_ngaymakp.Substring(0, p+1);
                    DataRow [] r1 = dtngay.Select("substring(ngay,1,8)='" + s_ngaymakp.Substring(6, 4) + s_ngaymakp.Substring(3, 2) + s_ngaymakp.Substring(0, 2) + "' and tenkp='" + s_ngaymakp.Substring(11, s_ngaymakp.Length - 12) + "'");
                    for (int i = 0; i < r1.Length; i++)
                    {
                        if (s_makho != "")
                        {
                            if (s_makho.IndexOf(r1[i]["makho"].ToString().PadLeft(3, '0')) != -1)
                            {
                                get_cholai(long.Parse(r1[i]["id"].ToString()));
                                break;
                            }
                        }
                        else
                        {
                            get_cholai(long.Parse(r1[i]["id"].ToString()));
                            break;
                        }
                    }
                }
                catch { }
            }
        }

        private void treeView1_AfterSelect(object sender, TreeViewEventArgs e)
        {
            if (e.Action == TreeViewAction.ByMouse || e.Action == TreeViewAction.ByKeyboard)
            {
                try
                {
                    s_ngaymakp = e.Node.FullPath.Trim();
                }
                catch { s_ngaymakp = "";}
            }
        }

        private void kiemtraton(MaskedTextBox.MaskedTextBox  txt)
        {
            try
            {
                if (!bEdit) return;
                d_soluong = (soluong1.Text != "") ? decimal.Parse(soluong1.Text) : 0;
                soluong1.Text = d_soluong.ToString("#,###,##0.00");
                if (mabd.Text != "" && tenbd.Text != "" && bMuangoai_tonkho)
                {
                    r = d.getrowbyid(dtton, "ma='" + mabd.Text + "'");
                    if (r != null && r["manguon"].ToString()!="-1")
                    {
                        i_mabd = int.Parse(r["id"].ToString());
                        if (i_mabdcu != 0 && i_mabdcu != i_mabd)
                        {
                            d.updrec_tonkho_tutruc_nguon(dtton, i_makhocu, i_manguoncu, i_mabdcu, 0, d_soluongcu, "+");
                            d_soluongcu = 0;
                        }
                        d_soluongton = d.get_slton_nguon_tutruc(dtton, int.Parse(makho.SelectedValue.ToString()), i_mabd, int.Parse(manguon.SelectedValue.ToString()), 0, d_soluongcu);
                        if (d_soluong > d_soluongton)
                        {
                            MessageBox.Show(lan.Change_language_MessageText("Số lượng xuất lớn hơn số lượng tồn !(") + d_soluongton.ToString() + ")", s_msg);
                            txt.Focus();
                            return;
                        }
                    }
                }
                if (d_soluongcu != 0) upd_table(dtct, "-");
            }
            catch { }
        }

        private void c1_Validated(object sender, EventArgs e)
        {
            get_soluong(c1);
        }

        private void c2_Validated(object sender, EventArgs e)
        {
            get_soluong(c1);
        }

        private void c3_Validated(object sender, EventArgs e)
        {
            get_soluong(c1);
        }

        private void c4_Validated(object sender, EventArgs e)
        {
            get_soluong(c1);
        }
        private void get_soluong(MaskedTextBox.MaskedTextBox txt)
        {
            decimal sl = ((c1.Text != "") ? decimal.Parse(c1.Text) : 0) + ((c2.Text != "") ? decimal.Parse(c2.Text) : 0) + ((c3.Text != "") ? decimal.Parse(c3.Text) : 0) + ((c4.Text != "") ? decimal.Parse(c4.Text) : 0);
            soluong1.Enabled = sl == 0;
            cachdung.Enabled = sl == 0;
            chk1.Enabled = sl != 0;
            chk2.Enabled = sl != 0;
            sl *= Math.Max((chkChitiet.Checked)?1:songay.Value, 1);
            soluong1.Text = sl.ToString();
            soluong1.Refresh();
            kiemtraton(txt);            
        }

        private void chk1_CheckedChanged(object sender, EventArgs e)
        {
            if (this.ActiveControl == chk1 && chk1.Checked) chk2.Checked = false;
        }

        private void chk2_CheckedChanged(object sender, EventArgs e)
        {
            if (this.ActiveControl == chk2 && chk2.Checked) chk1.Checked = false;
        }

        private void soluong1_Validated(object sender, EventArgs e)
        {
            try
            {
                if (!bEdit) return;
                d_soluong = (soluong1.Text != "") ? decimal.Parse(soluong1.Text) : 0;
                soluong1.Text = d_soluong.ToString("#,###,##0.00");
                if (mabd.Text != "" && tenbd.Text != "" && bMuangoai_tonkho)
                {
                    r = d.getrowbyid(dtton, "ma='" + mabd.Text + "'");
                    if (r != null && r["manguon"].ToString()!="-1")
                    {
                        i_mabd = int.Parse(r["id"].ToString());
                        if (i_mabdcu != 0 && i_mabdcu != i_mabd)
                        {
                            d.updrec_tonkho_tutruc_nguon(dtton, i_makhocu, i_manguoncu, i_mabdcu, 0, d_soluongcu, "+");
                            d_soluongcu = 0;
                        }
                        d_soluongton = d.get_slton_nguon_tutruc(dtton, int.Parse(makho.SelectedValue.ToString()), i_mabd, int.Parse(manguon.SelectedValue.ToString()), 0, d_soluongcu);
                        if (d_soluong > d_soluongton)
                        {
                            MessageBox.Show(lan.Change_language_MessageText("Số lượng xuất lớn hơn số lượng tồn !(") + d_soluongton.ToString() + ")", s_msg);
                            soluong1.Focus();
                            return;
                        }
                    }
                }
                if (d_soluongcu != 0) upd_table(dtct, "-");
            }
            catch { }
        }

        private void mabn_Validated(object sender, System.EventArgs e)
        {
            if (mabn.Text == "" || mabn.Text.Trim().Length < 3) return;
            if (mabn.Text.Trim().Length != 8) mabn.Text = mabn.Text.Substring(0, 2) + mabn.Text.Substring(2).PadLeft(6, '0');
            r = m.getrowbyid(dthoten, "mabn='" + mabn.Text + "'");
            if (r != null)
            {
                hoten.Text = r["hoten"].ToString();
                hoten.Tag = r["phai"].ToString();
                namsinh.Text = r["namsinh"].ToString();
                namsinh.Tag = r["ngaysinh"].ToString();
                i_madoituong = int.Parse(r["madoituong"].ToString());
                madoituong.SelectedValue = i_madoituong.ToString();
                sothe.Text = r["sothe"].ToString();
                l_maql = long.Parse(r["maql"].ToString());
                l_mavaovien = long.Parse(r["mavaovien"].ToString());
                mabs.Text = r["mabs"].ToString();
                s_Maicd = maicd.Text = r["maicd"].ToString();
                tenpk.Text = s_Tenkp;
                tenbs.Text = r["tenbs"].ToString();
                s_Chandoan = chandoan.Text = r["chandoan"].ToString();
                nam = r["nam"].ToString();
                s_ngayvv = r["ngay"].ToString();
                i_madoituong = int.Parse(r["madoituong"].ToString());
                s_noidkkcb = r["mabv"].ToString();
                ngay1 = r["ngay1"].ToString();
                ngay2 = r["ngay2"].ToString();
                ngay3 = r["ngay3"].ToString();
                traituyen = (r["traituyen"].ToString() == "") ? 0 : int.Parse(r["traituyen"].ToString());
                load_don();
            }
            else { hoten.Text = ""; hoten.Tag = ""; l_maql = 0; namsinh.Text = ""; sothe.Text = ""; }
        }

        private void hoten_KeyDown(object sender, System.Windows.Forms.KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Down || e.KeyCode == Keys.Up) listHoten.Focus();
            else if (e.KeyCode == Keys.Enter)
            {
                if (listHoten.Visible) listHoten.Focus();
                else SendKeys.Send("{Tab}");
            }
        }

        private void hoten_TextChanged(object sender, System.EventArgs e)
        {
            if (this.ActiveControl == hoten)
            {
                Filt_hoten(hoten.Text);
                if (tenbs.Enabled)
                    listHoten.BrowseToDanhmuc(hoten, mabn, tenbs);
                else
                    listHoten.BrowseToDanhmuc(hoten, mabn, songay);
            }
        }

        private void Filt_hoten(string ten)
        {
            try
            {
                CurrencyManager cm = (CurrencyManager)BindingContext[listHoten.DataSource];
                DataView dv = (DataView)cm.List;
                dv.RowFilter = "hoten like '%" + ten.Trim() + "%'";
            }
            catch { }
        }

        private void listHoten_KeyDown(object sender, System.Windows.Forms.KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Enter) mabn_Validated(null, null);
        }

        private void tenbs_KeyDown(object sender, System.Windows.Forms.KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Down || e.KeyCode == Keys.Up) listBS.Focus();
            else if (e.KeyCode == Keys.Enter)
            {
                if (listBS.Visible) listBS.Focus();
                else SendKeys.Send("{Tab}{Home}");
            }
        }

        private void tenbs_TextChanged(object sender, System.EventArgs e)
        {
            if (this.ActiveControl == tenbs)
            {
                Filt_tenbs(tenbs.Text);
                if (songay.Enabled)
                    listBS.BrowseToICD10(tenbs, mabs, songay, tenpk.Location.X, tenbs.Location.Y + tenbs.Height, tenbs.Width + tenpk.Width + lblbacsy.Width - 10, tenbs.Height);
                else
                    listBS.BrowseToICD10(tenbs, mabs, ghichu, tenpk.Location.X, tenbs.Location.Y + tenbs.Height, tenbs.Width + tenpk.Width + lblbacsy.Width - 10, tenbs.Height);
            }
        }

        private void Filt_tenbs(string ten)
        {
            try
            {
                CurrencyManager cm = (CurrencyManager)BindingContext[listBS.DataSource];
                DataView dv = (DataView)cm.List;
                dv.RowFilter = "hoten like '%" + ten.Trim() + "%'";
            }
            catch { }
        }

        private void madoituong_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Enter || e.KeyCode == Keys.Tab)
            {
                if (madoituong.Items.Count > 0 && madoituong.SelectedIndex == -1) madoituong.SelectedIndex = 0;
                SendKeys.Send("{Tab}");
            }
        }

        private void chkThuoc_CheckedChanged(object sender, EventArgs e)
        {
            if (this.ActiveControl == chkThuoc)
            {
                m.writeXml("thongso", "xemthuoc", (chkThuoc.Checked)?"1":"0");
                if (chkThuoc.Checked) load_treeview();
                else treeView1.Nodes.Clear();
            }
        }

        private void tenhc_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Enter) SendKeys.Send("{Tab}");
        }

        private void butTuongtac_Click(object sender, EventArgs e)
        {
            testc.clsTuongtac t = new testc.clsTuongtac();
            bool b_tuongtac=t.kiemtra_tuongtac(dtct, i_nhom);
        }

        private void butGoi_Click(object sender, EventArgs e)
        {
            if (mabn.Text.Trim().Length != 8)
            {
                mabn.Focus();
                return;
            }
            frmChongoi f = new frmChongoi(m, -1, i_nhom);
            f.ShowDialog();
            if (f.dt.Rows.Count > 0)
            {
                if (!bTayy && songay.Value == 0) songay.Value = 1;
                string s = ""; i_mabd = 0; 
                DataRow r1;
                decimal sl;
                string s_hanghet = "";
                foreach (DataRow r in f.dt.Rows)
                {
                    i_mabd = int.Parse(r["mabd"].ToString());
                    sl = Math.Max(songay.Value, 1) * decimal.Parse(r["soluong"].ToString());
                    d_soluong = Math.Max(songay.Value, 1) * decimal.Parse(r["soluong"].ToString());
                    r1 = m.getrowbyid(dtton, "id=" + i_mabd);
                    if (r1 != null)
                    {
                        d_soluongton = d.get_slton_nguon(dtton, int.Parse(r1["makho"].ToString()), i_mabd, int.Parse(r1["manguon"].ToString()), 0);
                        if (d_soluong > d_soluongton)
                        {
                            s += r["ten"].ToString() + " " + r["dang"].ToString() + " (" + d_soluongton.ToString("###,###,###0.000") + ")\n";
                            if (chkChitiet.Checked && songay.Value > 1) sl = 0;
                            else sl = (d_soluong > d_soluongton) ? d_soluongton : d_soluong;
                        }
                        if (bMabd_doituong && r1["madoituong"].ToString() != "0") madoituong.SelectedValue = r1["madoituong"].ToString();
                        else madoituong.SelectedValue = (i_madoituong == 5) ? "2" : i_madoituong.ToString();
                        d.updrec_dutruct("-", dtct, d.get_stt(dtct), madoituong.Text, i_mabd, r["ma"].ToString(), r["ten"].ToString(), r["tenhc"].ToString(), r["dang"].ToString(), r1["tenkho"].ToString(), sl, int.Parse(madoituong.SelectedValue.ToString()), int.Parse(r1["makho"].ToString()), r["cachdung"].ToString(), r["mahc"].ToString(), int.Parse(r1["manguon"].ToString()), 1, 0, (bTayy) ? 1 : songay.Value, (bTayy) ? 1 : decimal.Parse(r["soluong"].ToString()), dtton, 0);
                    }
                    else
                    {
                        s_hanghet += r["ma"].ToString() + "-" + r["ten"].ToString() + "[" + r["mabd"].ToString() + "]; ";
                    }
                }
                if (i_mabd != 0 && s != "")
                    MessageBox.Show(lan.Change_language_MessageText("Những mặt hàng sau không đủ trong tồn \n") + s, s_msg);
                else if (s_hanghet!="")
                    MessageBox.Show(lan.Change_language_MessageText("Những mặt hàng sau không có trong kho \n") + s_hanghet, s_msg);
                ref_text();
            }
        }

        private void chkChitiet_CheckedChanged(object sender, EventArgs e)
        {
            if (this.ActiveControl == chkChitiet) m.writeXml("thongso", "ctcapdon", (chkChitiet.Checked) ? "1" : "0");
        }

        private void ghichu_TextChanged(object sender, EventArgs e)
        {
            if (ghichu.Text == "\r\n") SendKeys.Send("{Tab}");
        }

        private void huyet_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (this.ActiveControl == huyet && huyet.SelectedIndex != -1)
                ghichu.Text = dthuyet.Rows[huyet.SelectedIndex]["noidung"].ToString();
        }

        private void chkHuyet_CheckedChanged(object sender, EventArgs e)
        {
            if (this.ActiveControl == chkHuyet && huyet.SelectedIndex != -1) huyet.Text = dthuyet.Rows[huyet.SelectedIndex]["noidung"].ToString();
        }

        private void tim_TextChanged(object sender, EventArgs e)
        {
            if (this.ActiveControl == tim)
            {
                CurrencyManager cm = (CurrencyManager)BindingContext[donthuoc.DataSource];
                DataView dv = (DataView)cm.List;
                if (tim.Text != "")
                    dv.RowFilter = "hoten like '%" + tim.Text.Trim() + "%' or ghichu like '%" + tim.Text.Trim() + "%'";
                else
                    dv.RowFilter = "";
            }
        }

        private void tim_Enter(object sender, EventArgs e)
        {
            tim.Text = "";
        }

        private bool bDongy(string makho,int dongy)
        {
            sql = "select * from " + user + ".d_dmkho where dongy="+dongy;
            if (makho != "") sql += " and id in (" + makho.Substring(0, makho.Length - 1) + ")";
            return m.get_data(sql).Tables[0].Rows.Count > 0;
        }

        private void songay_ValueChanged(object sender, EventArgs e)
        {
            if (this.ActiveControl == songay && !bTayy)
            {
                foreach (DataRow r in dtct.Rows)
                {
                    r["solan"] = Math.Max(1,songay.Value);
                    r["soluong"] = decimal.Parse(r["solan"].ToString()) * decimal.Parse(r["lan"].ToString());
                }
                ref_text();
            }
        }

        private void chkLuuin_CheckedChanged(object sender, EventArgs e)
        {
            if (this.ActiveControl == chkLuuin) m.writeXml("thongso", "bhluuin", (chkLuuin.Checked) ? "1" : "0");
        }

        private void chkDoituong_Click(object sender, EventArgs e)
        {
            if (!(!this.butLuu.Enabled || this.bChonkhoa))
            {
                this.madoituong.Enabled = this.chkDoituong.Checked;
            }
        }

        private void f_load_option()
        {
            iSotien_cancanhbao_khicaptoa = m.iSotien_cancanhbao_khicaptoa;
        }
        private void f_capnhat_db()
        {
            string tmp_mmyy = m.mmyy(s_ngay);
            sql = "select lanin from " + user + tmp_mmyy + ".d_thuocbhytll where 1=2";
            DataSet lds = m.get_data(sql);
            if (lds == null || lds.Tables.Count <= 0)
            {
                sql = "alter table " + user + tmp_mmyy + ".d_thuocbhytll add lanin numeric (3) default 0";
                m.execute_data(sql);
            }
        }
	}
}

